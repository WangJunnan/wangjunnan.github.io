<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ç‹ä¿Šç”·çš„æŠ€æœ¯æ‚è°ˆ</title>
  
  <subtitle>å–‹å–‹ä¸ä¼‘</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://wangjunnan.github.io/"/>
  <updated>2019-10-25T09:12:38.938Z</updated>
  <id>http://wangjunnan.github.io/</id>
  
  <author>
    <name>ç‹ä¿Šç”·</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Sentinelæºç è§£æä¸‰ï¼ˆæ»‘åŠ¨çª—å£æµé‡ç»Ÿè®¡ï¼‰</title>
    <link href="http://wangjunnan.github.io/2019/10/25/Sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89%EF%BC%88%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%B5%81%E9%87%8F%E7%BB%9F%E8%AE%A1%EF%BC%89/"/>
    <id>http://wangjunnan.github.io/2019/10/25/Sentinelæºç è§£æä¸‰ï¼ˆæ»‘åŠ¨çª—å£æµé‡ç»Ÿè®¡ï¼‰/</id>
    <published>2019-10-25T08:55:44.000Z</published>
    <updated>2019-10-25T09:12:38.938Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>Sentinel</code>çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€æ˜¯æµé‡ç»Ÿè®¡ï¼Œä¾‹å¦‚æˆ‘ä»¬å¸¸ç”¨çš„æŒ‡æ ‡QPSï¼Œå½“å‰çº¿ç¨‹æ•°ç­‰ã€‚ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»å¤§è‡´æåˆ°äº†æä¾›æ•°æ®ç»Ÿè®¡åŠŸèƒ½çš„<code>Slotï¼ˆStatisticSlotï¼‰</code>ï¼Œ<code>StatisticSlot</code>åœ¨<code>Sentinel</code>çš„æ•´ä¸ªä½“ç³»ä¸­æ‰®æ¼”äº†ä¸€ä¸ªéå¸¸é‡è¦çš„è§’è‰²ï¼Œåç»­çš„ä¸€ç³»åˆ—æ“ä½œï¼ˆé™æµï¼Œç†”æ–­ï¼‰ç­‰éƒ½ä¾èµ–äº<code>StatisticSlot</code>æ‰€ç»Ÿè®¡å‡ºçš„æ•°æ®ã€‚</p><p>æœ¬æ–‡æ‰€è¦è®¨è®ºçš„é‡ç‚¹å°±æ˜¯<code>StatisticSlot</code>æ˜¯å¦‚ä½•åšçš„æµé‡ç»Ÿè®¡ï¼Ÿ</p><p>å…¶å®åœ¨ä¹‹å‰ä»‹ç»å¸¸ç”¨é™æµç®—æ³•<a href="http://wangjunnan.club/2019/10/09/%E6%B5%85%E8%B0%88%E5%B8%B8%E7%94%A8%E7%9A%84%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95/" target="_blank" rel="noopener">å¸¸ç”¨é™æµç®—æ³•</a>çš„æ—¶å€™å·²ç»æœ‰æåˆ°è¿‡ä¸€ä¸ªç®—æ³•<code>æ»‘åŠ¨çª—å£é™æµ</code>ï¼Œè¯¥ç®—æ³•çš„æ»‘åŠ¨çª—å£åŸç†å…¶å®è·Ÿ<code>Sentinel</code>æ‰€æä¾›çš„æµé‡ç»Ÿè®¡åŸç†æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯åŸºäºæ—¶é—´çª—å£çš„æ»‘åŠ¨ç»Ÿè®¡</p><h2 id="å›åˆ°StatisticSlot"><a href="#å›åˆ°StatisticSlot" class="headerlink" title="å›åˆ°StatisticSlot"></a>å›åˆ°StatisticSlot</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">entry</span><span class="params">(Context context, ResourceWrapper resourceWrapper, DefaultNode node, <span class="keyword">int</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">boolean</span> prioritized, Object... args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">// å½“å‰è¯·æ±‚çº¿ç¨‹æ•°åŠ ä¸€</span></span><br><span class="line">node.increaseThreadNum();</span><br><span class="line"><span class="comment">// æ–°å¢è¯·æ±‚æ•°</span></span><br><span class="line">node.addPassRequest(count);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>StatisticSlot</code>ä¸»è¦ç»Ÿè®¡äº†ä¸¤ç§ç±»å‹çš„æ•°æ®</p><ol><li>çº¿ç¨‹æ•°</li><li>è¯·æ±‚æ•°ï¼ˆQPSï¼‰</li></ol><p>å¯¹äºçº¿ç¨‹æ•°çš„ç»Ÿè®¡æ¯”è¾ƒç®€å•ï¼Œé€šè¿‡å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª<code>LongAdder</code>æ¥è¿›è¡Œå½“å‰çº¿ç¨‹æ•°çš„ç»Ÿè®¡ï¼Œæ¯è¿›å…¥ä¸€ä¸ªè¯·æ±‚åŠ 1ï¼Œæ¯é‡Šæ”¾ä¸€ä¸ªè¯·æ±‚å‡1ï¼Œä»è€Œå¾—åˆ°å½“å‰çš„çº¿ç¨‹æ•°</p><p>å¯¹äºè¯·æ±‚æ•°QPSçš„ç»Ÿè®¡åˆ™ç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œå…¶ä¸­æœ‰ç”¨åˆ°æ»‘åŠ¨çª—å£åŸç†ï¼ˆä¹Ÿæ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼‰ï¼Œä¸‹é¢æ ¹æ®æºç æ¥æ·±å…¥çš„åˆ†æ</p><h2 id="DefaultNode-å’Œ-StatisticNode"><a href="#DefaultNode-å’Œ-StatisticNode" class="headerlink" title="DefaultNode å’Œ StatisticNode"></a>DefaultNode å’Œ StatisticNode</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPassRequest</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è°ƒç”¨çˆ¶ç±»ï¼ˆStatisticNodeï¼‰æ¥è¿›è¡Œç»Ÿè®¡</span></span><br><span class="line">    <span class="keyword">super</span>.addPassRequest(count);</span><br><span class="line">    <span class="comment">// æ ¹æ®clusterNode æ±‡æ€»ç»Ÿè®¡ï¼ˆèƒŒåä¹Ÿæ˜¯è°ƒç”¨çˆ¶ç±»StatisticNodeï¼‰</span></span><br><span class="line">    <span class="keyword">this</span>.clusterNode.addPassRequest(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨äº†çˆ¶ç±»<code>StatisticNode</code>çš„<code>addPassRequest</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æŒ‰ç§’ç»Ÿè®¡ï¼Œåˆ†æˆä¸¤ä¸ªçª—å£ï¼Œæ¯ä¸ªçª—å£500msï¼Œç”¨æ¥ç»Ÿè®¡QPS</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Metric rollingCounterInSecond = <span class="keyword">new</span> ArrayMetric(SampleCountProperty.SAMPLE_COUNT,</span><br><span class="line">    IntervalProperty.INTERVAL);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æŒ‰åˆ†é’Ÿç»Ÿè®¡ï¼Œåˆ†æˆ60ä¸ªçª—å£ï¼Œæ¯ä¸ªçª—å£ 1000ms</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Metric rollingCounterInMinute = <span class="keyword">new</span> ArrayMetric(<span class="number">60</span>, <span class="number">60</span> * <span class="number">1000</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPassRequest</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">    rollingCounterInSecond.addPass(count);</span><br><span class="line">    rollingCounterInMinute.addPass(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥çŸ¥é“å†…éƒ¨æ˜¯è°ƒç”¨äº†<code>ArrayMetric</code>çš„<code>addPass</code>æ–¹æ³•æ¥ç»Ÿè®¡çš„ï¼Œå¹¶ä¸”ç»Ÿè®¡äº†ä¸¤ç§ä¸åŒæ—¶é—´ç»´åº¦çš„æ•°æ®(ç§’çº§å’Œåˆ†é’Ÿçº§)</p><h2 id="ArrayMetric"><a href="#ArrayMetric" class="headerlink" title="ArrayMetric"></a>ArrayMetric</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LeapArray&lt;MetricBucket&gt; data;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayMetric</span><span class="params">(<span class="keyword">int</span> sampleCount, <span class="keyword">int</span> intervalInMs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.data = <span class="keyword">new</span> OccupiableBucketLeapArray(sampleCount, intervalInMs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayMetric</span><span class="params">(<span class="keyword">int</span> sampleCount, <span class="keyword">int</span> intervalInMs, <span class="keyword">boolean</span> enableOccupy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (enableOccupy) &#123;</span><br><span class="line">        <span class="keyword">this</span>.data = <span class="keyword">new</span> OccupiableBucketLeapArray(sampleCount, intervalInMs);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.data = <span class="keyword">new</span> BucketLeapArray(sampleCount, intervalInMs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPass</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. è·å–å½“å‰çª—å£</span></span><br><span class="line">    WindowWrap&lt;MetricBucket&gt; wrap = data.currentWindow();</span><br><span class="line">    <span class="comment">// 2. å½“å‰çª—å£åŠ 1</span></span><br><span class="line">    wrap.value().addPass(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ArrayMetric</code>å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªåŒ…è£…ç±»ï¼Œå†…éƒ¨é€šè¿‡å®ä¾‹åŒ–<code>LeapArray</code>çš„å¯¹åº”å®ç°ç±»ï¼Œæ¥å®ç°å…·ä½“çš„ç»Ÿè®¡é€»è¾‘ï¼Œ<code>LeapArray</code>æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œ<code>OccupiableBucketLeapArray</code>å’Œ<code>BucketLeapArray</code>éƒ½æ˜¯å…¶å…·ä½“çš„å®ç°ç±»<br><code>OccupiableBucketLeapArray</code>åœ¨1.5ç‰ˆæœ¬ä¹‹åæ‰è¢«å¼•å…¥ï¼Œ<strong>ä¸»è¦æ˜¯ä¸ºäº†è§£å†³ä¸€äº›é«˜ä¼˜å…ˆçº§çš„è¯·æ±‚åœ¨é™æµè§¦å‘çš„æ—¶å€™ä¹Ÿèƒ½é€šè¿‡(é€šè¿‡å ç”¨æœªæ¥æ—¶é—´çª—å£çš„åé¢æ¥å®ç°)</strong> ä¹Ÿæ˜¯é»˜è®¤ä½¿ç”¨çš„LeapArrayå®ç°ç±»</p><p>è€Œç»Ÿè®¡çš„é€»è¾‘ä¹Ÿæ¯”è¾ƒæ¸…æ¥šï¼Œåˆ†æˆäº†ä¸¤æ­¥ï¼š</p><ol><li>å®šä½åˆ°å½“å‰çª—å£</li><li>è·å–åˆ°å½“å‰çª—å£<code>WindowWrap</code>çš„<code>MetricBucket</code>å¹¶æ‰§è¡Œ<code>addPass</code>é€»è¾‘</li></ol><p>è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹ä¸‹ç¬¬äºŒæ­¥ä¸­çš„<code>MetricBucket</code>ç±»ï¼Œçœ‹çœ‹å®ƒåšäº†å“ªäº›äº‹æƒ…</p><h3 id="MetricBucket"><a href="#MetricBucket" class="headerlink" title="MetricBucket"></a>MetricBucket</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å­˜æ”¾å½“å‰çª—å£å„ç§ç±»å‹çš„ç»Ÿè®¡å€¼(ç±»å‹åŒ…æ‹¬ PASS BLOCK EXCEPTION ç­‰)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LongAdder[] counters;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MetricBucket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MetricEvent[] events = MetricEvent.values();</span><br><span class="line">    <span class="keyword">this</span>.counters = <span class="keyword">new</span> LongAdder[events.length];</span><br><span class="line">    <span class="keyword">for</span> (MetricEvent event : events) &#123;</span><br><span class="line">        counters[event.ordinal()] = <span class="keyword">new</span> LongAdder();</span><br><span class="line">    &#125;</span><br><span class="line">    initMinRt();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç»Ÿè®¡passæ•°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPass</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    add(MetricEvent.PASS, n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç»Ÿè®¡å¯å ç”¨çš„passæ•°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addOccupiedPass</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    add(MetricEvent.OCCUPIED_PASS, n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç»Ÿè®¡å¼‚å¸¸æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addException</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    add(MetricEvent.EXCEPTION, n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç»Ÿè®¡blockæ•°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBlock</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    add(MetricEvent.BLOCK, n);</span><br><span class="line">&#125;</span><br><span class="line">....</span><br></pre></td></tr></table></figure><p>MetricBucketé€šè¿‡å®šä¹‰äº†ä¸€ä¸ª<code>LongAdder</code>æ•°ç»„æ¥å­˜å‚¨ä¸åŒç±»å‹çš„æµé‡ç»Ÿè®¡å€¼ï¼Œå…·ä½“çš„ç±»å‹åˆ™éƒ½å®šä¹‰åœ¨<code>MetricEvent</code>æšä¸¾ä¸­ã€‚<br>æ‰§è¡Œ<code>addPass</code>æ–¹æ³•å¯¹åº”<code>LongAdder</code>æ•°ç»„ç´¢å¼•ä¸‹è¡¨ä¸º0çš„å€¼é€’å¢</p><p>ä¸‹é¢å†æ¥çœ‹ä¸‹<code>data.currentWindow()</code>çš„å†…éƒ¨é€»è¾‘</p><h3 id="OccupiableBucketLeapArray"><a href="#OccupiableBucketLeapArray" class="headerlink" title="OccupiableBucketLeapArray"></a>OccupiableBucketLeapArray</h3><p><code>OccupiableBucketLeapArray</code>ç»§æ‰¿äº†æŠ½è±¡ç±»<code>LeapArray</code>ï¼Œæ ¸å¿ƒé€»è¾‘ä¹Ÿæ˜¯åœ¨<code>LeapArray</code>ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ—¶é—´çª—å£å¤§å° å•ä½ms</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> windowLengthInMs;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ‡åˆ†çš„çª—å£æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> sampleCount;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç»Ÿè®¡çš„æ—¶é—´é—´éš” intervalInMs = windowLengthInMs * sampleCount</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> intervalInMs;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çª—å£æ•°ç»„ æ•°ç»„å¤§å° = sampleCount</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> AtomicReferenceArray&lt;WindowWrap&lt;T&gt;&gt; array;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * update lock æ›´æ–°çª—å£æ—¶éœ€è¦ä¸Šé”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock updateLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sampleCount  éœ€è¦åˆ’åˆ†çš„çª—å£æ•°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> intervalInMs é—´éš”çš„ç»Ÿè®¡æ—¶é—´</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LeapArray</span><span class="params">(<span class="keyword">int</span> sampleCount, <span class="keyword">int</span> intervalInMs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.windowLengthInMs = intervalInMs / sampleCount;</span><br><span class="line">    <span class="keyword">this</span>.intervalInMs = intervalInMs;</span><br><span class="line">    <span class="keyword">this</span>.sampleCount = sampleCount;</span><br><span class="line">    <span class="keyword">this</span>.array = <span class="keyword">new</span> AtomicReferenceArray&lt;&gt;(sampleCount);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–å½“å‰çª—å£</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> WindowWrap&lt;T&gt; <span class="title">currentWindow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> currentWindow(TimeUtil.currentTimeMillis());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šéœ€è¦ç€é‡ç†è§£çš„æ˜¯å‡ ä¸ªå‚æ•°çš„å«ä¹‰ï¼š</p><ol><li>sampleCount å®šä¹‰çš„çª—å£çš„æ•°</li><li>intervalInMs ç»Ÿè®¡çš„æ—¶é—´é—´éš”</li><li>windowLengthInMs æ¯ä¸ªçª—å£çš„æ—¶é—´å¤§å° = intervalInMs / sampleCount</li></ol><p><code>sampleCount</code> æ¯”è¾ƒå¥½ç†è§£ï¼Œå°±æ˜¯éœ€è¦å®šä¹‰å‡ ä¸ªçª—å£ï¼ˆé»˜è®¤ç§’çº§ç»Ÿè®¡ç»´åº¦çš„è¯æ˜¯ä¸¤ä¸ªçª—å£ï¼‰ï¼Œ<code>intervalInMs</code> æŒ‡çš„å°±æ˜¯æˆ‘ä»¬éœ€è¦ç»Ÿè®¡çš„æ—¶é—´é—´éš”ï¼Œä¾‹å¦‚æˆ‘ä»¬ç»Ÿè®¡QPSçš„è¯é‚£å°±æ˜¯1000msï¼Œ<code>windowLengthInMs</code> æŒ‡çš„æ¯ä¸ªçª—å£çš„å¤§å°ï¼Œæ˜¯ç”±<code>intervalInMs</code>é™¤ä»¥<code>sampleCount</code>å¾—æ¥</p><p>ç±»ä¼¼ä¸‹å›¾<br><img src="http://img.souche.com/f2e/35184370429c595e41100e9e70018761.jpg" alt>ï¿¼</p><p>ç†è§£äº†ä¸Šè¯‰å‡ ä¸ªå‚æ•°çš„å«ä¹‰åï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥åˆ°<code>LeapArray</code>çš„<code>currentWindow(long time)</code>æ–¹æ³•ä¸­å»çœ‹çœ‹å…·ä½“çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> WindowWrap&lt;T&gt; <span class="title">currentWindow</span><span class="params">(<span class="keyword">long</span> timeMillis)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (timeMillis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ ¹æ®å½“å‰æ—¶é—´æˆ³è®¡ç®—å½“å‰æ‰€å±çš„çª—å£æ•°ç»„ç´¢å¼•ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">int</span> idx = calculateTimeIdx(timeMillis);</span><br><span class="line">    <span class="comment">// è®¡ç®—å½“å‰çª—å£çš„å¼€å§‹æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">long</span> windowStart = calculateWindowStart(timeMillis);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ä»çª—å£æ•°ç»„ä¸­è·å–å½“å‰çª—å£é¡¹ï¼Œåˆ†ä¸ºä¸‰ç§æƒ…å†µ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * (1) å½“å‰çª—å£ä¸ºç©ºè¿˜æœªåˆ›å»ºï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ª</span></span><br><span class="line"><span class="comment">     * (2) å½“å‰çª—å£çš„å¼€å§‹æ—¶é—´å’Œä¸Šé¢è®¡ç®—å‡ºçš„çª—å£å¼€å§‹æ—¶é—´ä¸€è‡´ï¼Œè¡¨æ˜å½“å‰çª—å£è¿˜æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›å½“å‰çª—å£</span></span><br><span class="line"><span class="comment">     * (3) å½“å‰çª—å£çš„å¼€å§‹æ—¶é—´ å°äº ä¸Šé¢è®¡ç®—å‡ºçš„çª—å£å¼€å§‹æ—¶é—´ï¼Œè¡¨æ˜å½“å‰çª—å£å·²è¿‡æœŸï¼Œéœ€è¦æ›¿æ¢å½“å‰çª—å£</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        WindowWrap&lt;T&gt; old = array.get(idx);</span><br><span class="line">        <span class="keyword">if</span> (old == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * ç¬¬ä¸€ç§æƒ…å†µï¼Œæ–°å»ºä¸€ä¸ªçª—å£é¡¹</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            WindowWrap&lt;T&gt; window = <span class="keyword">new</span> WindowWrap&lt;T&gt;(windowLengthInMs, windowStart, newEmptyBucket(timeMillis));</span><br><span class="line">            <span class="keyword">if</span> (array.compareAndSet(idx, <span class="keyword">null</span>, window)) &#123;</span><br><span class="line">                <span class="comment">// Successfully updated, return the created bucket.</span></span><br><span class="line">                <span class="keyword">return</span> window;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Contention failed, the thread will yield its time slice to wait for bucket available.</span></span><br><span class="line">                Thread.yield();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (windowStart == old.windowStart()) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * ç¬¬äºŒç§æƒ…å†µ ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">return</span> old;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (windowStart &gt; old.windowStart()) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * ç¬¬ä¸‰ç§æƒ…å†µ æ›¿æ¢çª—å£</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (updateLock.tryLock()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// Successfully get the update lock, now we reset the bucket.</span></span><br><span class="line">                    <span class="keyword">return</span> resetWindowTo(old, windowStart);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    updateLock.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Contention failed, the thread will yield its time slice to wait for bucket available.</span></span><br><span class="line">                Thread.yield();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (windowStart &lt; old.windowStart()) &#123;</span><br><span class="line">            <span class="comment">// ç¬¬å››ç§æƒ…å†µï¼Œè®²é“ç†ä¸ä¼šèµ°åˆ°è¿™é‡Œ</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> WindowWrap&lt;T&gt;(windowLengthInMs, windowStart, newEmptyBucket(timeMillis));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®å½“å‰æ—¶é—´æˆ³è®¡ç®—å½“å‰æ‰€å±çš„çª—å£æ•°ç»„ç´¢å¼•ä¸‹æ ‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">calculateTimeIdx</span><span class="params">(<span class="comment">/*@Valid*/</span> <span class="keyword">long</span> timeMillis)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> timeId = timeMillis / windowLengthInMs;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>)(timeId % array.length());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è®¡ç®—å½“å‰çª—å£çš„å¼€å§‹æ—¶é—´æˆ³</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">long</span> <span class="title">calculateWindowStart</span><span class="params">(<span class="comment">/*@Valid*/</span> <span class="keyword">long</span> timeMillis)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> timeMillis - timeMillis % windowLengthInMs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„æ–¹æ³•å°±æ˜¯æ•´ä¸ªæ»‘åŠ¨çª—å£é€»è¾‘çš„æ ¸å¿ƒä»£ç ï¼Œæ³¨é‡Šå…¶å®ä¹Ÿå†™çš„æ¯”è¾ƒæ¸…æ™°äº†ï¼Œç®€å•æ¦‚æ‹¬ä¸‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p><ol><li>æ ¹æ®å½“å‰æ—¶é—´æˆ³ å’Œ çª—å£æ•°ç»„å¤§å° è·å–åˆ°å½“å‰çš„çª—å£æ•°ç»„ç´¢å¼•ä¸‹æ ‡<code>idx</code>ï¼Œå¦‚æœçª—å£æ•°æ˜¯2ï¼Œé‚£å…¶å®<code>idx</code>åªæœ‰ä¸¤ç§å€¼(0 æˆ– 1)</li><li>æ ¹æ®å½“å‰æ—¶é—´æˆ³ï¼ˆ<code>windowStart</code>ï¼‰ è®¡ç®—å¾—åˆ°å½“å‰çª—å£çš„å¼€å§‹æ—¶é—´æˆ³å€¼ã€‚é€šè¿‡<code>calculateWindowStart</code>è®¡ç®—æ¥å¾—åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•è¿˜è›®æœ‰æ„æ€çš„ï¼Œé€šè¿‡å½“å‰æ—¶é—´æˆ³å’Œçª—å£æ—¶é—´å¤§å°å–ä½™æ¥å¾—åˆ° ä¸å½“å‰çª—å£å¼€å§‹æ—¶é—´çš„ åç§»é‡ã€‚æ¯”æˆ‘ç”¨å®šæ—¶ä»»åŠ¡å®ç°é«˜çº§å¤šäº† â€¦ ğŸ˜† å¯ä»¥å»å¯¹æ¯”ä¸€ä¸‹æˆ‘ä¹‹å‰æ–‡ç« ä¸­çš„è ¢å®ç° <a href="https://github.com/WangJunnan/learn/blob/master/algorithm/src/main/java/com/walm/learn/algorithm/ratelimit/SlidingWindowRateLimit.java" target="_blank" rel="noopener">æ»‘åŠ¨çª—å£ç®—æ³•å®šæ—¶ä»»åŠ¡å®ç°</a></li><li>ç„¶åå°±æ˜¯æ ¹æ®ä¸Šé¢å¾—åˆ°çš„ä¸¤ä¸ªå€¼ æ¥è·å–å½“å‰æ—¶é—´çª—å£ï¼Œè¿™é‡Œå…¶å®åˆåˆ†ä¸ºä¸‰ç§æƒ…å†µ<ul><li>å½“å‰çª—å£ä¸ºç©ºè¿˜æœªåˆ›å»ºï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ª</li><li>å½“å‰çª—å£çš„å¼€å§‹æ—¶é—´å’Œä¸Šé¢è®¡ç®—å‡ºçš„çª—å£å¼€å§‹æ—¶é—´(<code>windowStart</code>)ä¸€è‡´ï¼Œè¡¨æ˜å½“å‰çª—å£è¿˜æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›å½“å‰çª—å£</li><li>å½“å‰çª—å£çš„å¼€å§‹æ—¶é—´ å°äº ä¸Šé¢è®¡ç®—å‡ºçš„çª—å£(<code>windowStart</code>)å¼€å§‹æ—¶é—´ï¼Œè¡¨æ˜å½“å‰çª—å£å·²è¿‡æœŸï¼Œéœ€è¦æ›¿æ¢å½“å‰çª—å£</li></ul></li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ€»çš„æ¥è¯´ï¼Œ<code>currentWindow</code>æ–¹æ³•çš„å®ç°è¿˜æ˜¯éå¸¸å·§å¦™çš„ï¼Œå› ä¸ºæˆ‘åœ¨çœ‹<code>Sentinel</code>çš„æºç å‰ä¹Ÿå†™è¿‡ä¸€ç¯‡é™æµç®—æ³•çš„æ–‡ç« ï¼Œæ°å¥½å…¶ä¸­ä¹Ÿå®ç°è¿‡ä¸€ä¸ªæ»‘åŠ¨çª—å£é™æµç®—æ³•ï¼Œä¸è¿‡ç›¸æ¯”äº<code>Sentinel</code>çš„å®ç°ï¼Œæˆ‘ç”¨äº†å®šæ—¶ä»»åŠ¡å»åšçª—å£çš„åˆ‡æ¢æ›´æ–°ï¼Œæ˜¾ç„¶æ€§èƒ½ä¸Šæ›´å·®ï¼Œå®ç°çš„ä¹Ÿä¸ä¼˜é›…ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥å»å¯¹æ¯”ä¸€ä¸‹ã€‚<a href="http://wangjunnan.club/2019/10/09/%E6%B5%85%E8%B0%88%E5%B8%B8%E7%94%A8%E7%9A%84%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95/" target="_blank" rel="noopener">å¸¸ç”¨é™æµç®—æ³•</a></p><p>Sentinelç³»åˆ—</p><ul><li><p><a href="http://wangjunnan.club/2019/10/11/Sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%80/" target="_blank" rel="noopener">Sentinelæºç è§£æä¸€</a></p></li><li><p><a href="http://wangjunnan.club/2019/10/16/Sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C%EF%BC%88slot%E6%80%BB%E8%A7%88%EF%BC%89/" target="_blank" rel="noopener">Sentinelæºç è§£æäºŒï¼ˆslotæ€»è§ˆï¼‰</a></p></li><li><p><a href="http://wangjunnan.club/2019/10/25/Sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89%EF%BC%88%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%B5%81%E9%87%8F%E7%BB%9F%E8%AE%A1%EF%BC%89/" target="_blank" rel="noopener">Sentinelæºç è§£æäºŒï¼ˆæ»‘åŠ¨çª—å£æµé‡ç»Ÿè®¡ï¼‰</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Sentinel&lt;/code&gt;çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€æ˜¯æµé‡ç»Ÿè®¡ï¼Œä¾‹å¦‚æˆ‘ä»¬å¸¸ç”¨çš„æŒ‡æ ‡QPSï¼Œå½“å‰çº¿ç¨‹æ•°ç­‰ã€‚ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»å¤§è‡´æåˆ°äº†æ
      
    
    </summary>
    
      <category term="javaæ¡†æ¶" scheme="http://wangjunnan.github.io/categories/java%E6%A1%86%E6%9E%B6/"/>
    
      <category term="Sentinel" scheme="http://wangjunnan.github.io/categories/java%E6%A1%86%E6%9E%B6/Sentinel/"/>
    
    
      <category term="å¹¶å‘" scheme="http://wangjunnan.github.io/tags/%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Sentinelæºç è§£æäºŒï¼ˆslotæ€»è§ˆï¼‰</title>
    <link href="http://wangjunnan.github.io/2019/10/16/Sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C%EF%BC%88slot%E6%80%BB%E8%A7%88%EF%BC%89/"/>
    <id>http://wangjunnan.github.io/2019/10/16/Sentinelæºç è§£æäºŒï¼ˆslotæ€»è§ˆï¼‰/</id>
    <published>2019-10-16T01:57:32.000Z</published>
    <updated>2019-10-25T09:12:25.290Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>æœ¬æ–‡ç»§ç»­æ¥åˆ†æSentinelçš„æºç ï¼Œä¸Šç¯‡æ–‡ç« å¯¹Sentinelçš„è°ƒç”¨è¿‡ç¨‹åšäº†æ·±å…¥åˆ†æï¼Œä¸»è¦æ¶‰åŠåˆ°äº†ä¸¤ä¸ªæ¦‚å¿µï¼šæ’æ§½é“¾å’ŒNodeèŠ‚ç‚¹ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ ¹æ®æ’æ§½é“¾çš„è°ƒç”¨å…³ç³»æ¥ä¾æ¬¡åˆ†ææ¯ä¸ªæ’æ§½ï¼ˆslotï¼‰çš„æºç ã€‚</p><p>é»˜è®¤æ’æ§½é“¾çš„è°ƒç”¨é¡ºåºï¼Œä»¥åŠæ¯ç§ç±»å‹NodeèŠ‚ç‚¹çš„å…³ç³»éƒ½åœ¨ä¸Šé¢æ–‡ç« å¼€å¤´åˆ†æè¿‡ <a href></a></p><h2 id="NodeSelectorSlot"><a href="#NodeSelectorSlot" class="headerlink" title="NodeSelectorSlot"></a>NodeSelectorSlot</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç›¸åŒçš„èµ„æºä½†æ˜¯Contextä¸åŒï¼Œåˆ†åˆ«æ–°å»º DefaultNodeï¼Œå¹¶ä»¥ContextNameä¸ºkey</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Map&lt;String, DefaultNode&gt; map = <span class="keyword">new</span> HashMap&lt;String, DefaultNode&gt;(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">entry</span><span class="params">(Context context, ResourceWrapper resourceWrapper, Object obj, <span class="keyword">int</span> count, <span class="keyword">boolean</span> prioritized, Object... args)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¹æ®ContextNameå°è¯•è·å–DefaultNode</span></span><br><span class="line">    DefaultNode node = map.get(context.getName());</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            node = map.get(context.getName());</span><br><span class="line">            <span class="keyword">if</span> (node == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–DefaultNodeï¼Œæ¯ä¸ªContextå¯¹åº”ä¸€ä¸ª</span></span><br><span class="line">                node = <span class="keyword">new</span> DefaultNode(resourceWrapper, <span class="keyword">null</span>);</span><br><span class="line">                HashMap&lt;String, DefaultNode&gt; cacheMap = <span class="keyword">new</span> HashMap&lt;String, DefaultNode&gt;(map.size());</span><br><span class="line">                cacheMap.putAll(map);</span><br><span class="line">                cacheMap.put(context.getName(), node);</span><br><span class="line">                map = cacheMap;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ„å»º Node tree</span></span><br><span class="line">            ((DefaultNode)context.getLastNode()).addChild(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    context.setCurNode(node);</span><br><span class="line">    <span class="comment">// å”¤é†’æ‰§è¡Œä¸‹ä¸€ä¸ªæ’æ§½</span></span><br><span class="line">    fireEntry(context, resourceWrapper, node, count, prioritized, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>NodeSelectorSlot</code>é¡¾åæ€ä¹‰æ˜¯ç”¨æ¥æ„å»º<code>Node</code>çš„ã€‚<br>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>NodeSelectorSlot</code>å¯¹äºä¸åŒçš„ä¸Šä¸‹æ–‡éƒ½ä¼šç”Ÿæˆä¸€ä¸ª<code>DefaultNode</code>ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªè¦æ³¨æ„çš„ç‚¹ï¼š<strong>ç›¸åŒçš„èµ„æº({@link ResourceWrapper#equals(Object)})å°†å…¨å±€å…±äº«ç›¸åŒçš„{@link ProcessorSlotChain}ï¼Œæ— è®ºåœ¨å“ªä¸ªä¸Šä¸‹æ–‡ä¸­</strong>ï¼Œå› æ­¤ä¸åŒçš„ä¸Šä¸‹æ–‡å¯ä»¥è¿›å…¥åˆ°åŒä¸€ä¸ªå¯¹è±¡çš„<code>NodeSelectorSlot.entry</code>æ–¹æ³•ä¸­ï¼Œé‚£ä¹ˆè¿™é‡Œè¦æ€ä¹ˆåŒºåˆ†ä¸åŒçš„ä¸Šä¸‹æ–‡æ‰€åˆ›å»ºçš„èµ„æºNodeå‘¢ï¼Ÿæ˜¾ç„¶å¯ä»¥ä½¿ç”¨ä¸Šä¸‹æ–‡åç§°ä½œä¸ºæ˜ å°„é”®ä»¥åŒºåˆ†ç›¸åŒçš„èµ„æºNodeã€‚</p><p>ç„¶åè¿™é‡Œè¦è€ƒè™‘å¦ä¸€ä¸ªé—®é¢˜ã€‚ä¸€ä¸ªèµ„æºæœ‰å¯èƒ½åˆ›å»ºå¤šä¸ª<code>DefaultNode</code>ï¼ˆæœ‰å¤šä¸ªä¸Šä¸‹æ–‡æ—¶ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•å¿«é€Ÿçš„è·å–æ€»çš„ç»Ÿè®¡æ•°æ®å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆå°±åœ¨ä¸‹ä¸€ä¸ªSlot(<code>ClusterBuilderSlot</code>)ä¸­è¢«è§£å†³äº†ã€‚</p><h2 id="ClusterBuilderSlot"><a href="#ClusterBuilderSlot" class="headerlink" title="ClusterBuilderSlot"></a>ClusterBuilderSlot</h2><p>ä¸Šé¢æœ‰æåˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¦å¦‚ä½•ç»Ÿè®¡ä¸åŒä¸Šä¸‹æ–‡ç›¸åŒèµ„æºçš„æ€»é‡æ•°æ®ã€‚<code>ClusterBuilderSlot</code>ç»™äº†å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼šå…·æœ‰ç›¸åŒèµ„æºåç§°çš„å…±äº«ä¸€ä¸ª<code>ClusterNode</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç›¸åŒçš„èµ„æºå…±äº«ä¸€ä¸ª ClusterNode</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Map&lt;ResourceWrapper, ClusterNode&gt; clusterNodeMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ClusterNode clusterNode = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">entry</span><span class="params">(Context context, ResourceWrapper resourceWrapper, DefaultNode node, <span class="keyword">int</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">boolean</span> prioritized, Object... args)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æœ¬èµ„æºæ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡clusterNode</span></span><br><span class="line">    <span class="keyword">if</span> (clusterNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clusterNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// æ²¡æœ‰åˆå§‹åŒ–åˆ™åˆå§‹åŒ–clusterNode</span></span><br><span class="line">                clusterNode = <span class="keyword">new</span> ClusterNode(resourceWrapper.getName(), resourceWrapper.getResourceType());</span><br><span class="line">                HashMap&lt;ResourceWrapper, ClusterNode&gt; newMap = <span class="keyword">new</span> HashMap&lt;&gt;(Math.max(clusterNodeMap.size(), <span class="number">16</span>));</span><br><span class="line">                newMap.putAll(clusterNodeMap);</span><br><span class="line">                newMap.put(node.getId(), clusterNode);</span><br><span class="line"></span><br><span class="line">                clusterNodeMap = newMap;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç»™ç›¸åŒèµ„æºçš„DefaultNodeè®¾ç½®ä¸€æ ·çš„ClusterNode</span></span><br><span class="line">    node.setClusterNode(clusterNode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * å¦‚æœæœ‰æ¥æºåˆ™æ–°å»ºä¸€ä¸ªæ¥æºNode</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">""</span>.equals(context.getOrigin())) &#123;</span><br><span class="line">        Node originNode = node.getClusterNode().getOrCreateOriginNode(context.getOrigin());</span><br><span class="line">        context.getCurEntry().setOriginNode(originNode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fireEntry(context, resourceWrapper, node, count, prioritized, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç å…¶å®å°±æ˜¯åšäº†ä¸€ä»¶äº‹æƒ…ï¼Œä¸ºèµ„æºåˆ›å»º<code>CluserNode</code>ã€‚è¿™é‡Œæˆ‘åˆè¦æä¸€å˜´ <strong>ç›¸åŒçš„èµ„æº({@link ResourceWrapper#equals(Object)})å°†å…¨å±€å…±äº«ç›¸åŒçš„{@link ProcessorSlotChain}ï¼Œæ— è®ºåœ¨å“ªä¸ªä¸Šä¸‹æ–‡ä¸­</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œèƒ½è¿›å…¥åˆ°åŒä¸€ä¸ª<code>ClusterBuilderSlot</code>å¯¹è±¡çš„<code>entry</code>æ–¹æ³•çš„è¯·æ±‚éƒ½æ˜¯æ¥è‡ªåŒä¸€ä¸ªèµ„æºçš„ï¼Œæ‰€ä»¥è¿™äº›ç›¸åŒèµ„æºéœ€è¦åˆå§‹åŒ–ä¸€ä¸ªç»Ÿä¸€çš„<code>CluserNode</code>ç”¨æ¥åšæµé‡çš„æ±‡æ€»ç»Ÿè®¡ã€‚</p><h2 id="LogSlot"><a href="#LogSlot" class="headerlink" title="LogSlot"></a>LogSlot</h2><p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œé€»è¾‘å°±æ˜¯æ‰“å°å¼‚å¸¸æ—¥å¿—ï¼Œå°±ä¸åˆ†æäº†</p><h2 id="StatisticSlot"><a href="#StatisticSlot" class="headerlink" title="StatisticSlot"></a>StatisticSlot</h2><p><code>StatisticSlot</code> æ˜¯ <code>Sentinel</code> çš„æ ¸å¿ƒåŠŸèƒ½æ’æ§½ä¹‹ä¸€ï¼Œç”¨äºç»Ÿè®¡å®æ—¶çš„è°ƒç”¨æ•°æ®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">entry</span><span class="params">(Context context, ResourceWrapper resourceWrapper, DefaultNode node, <span class="keyword">int</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">boolean</span> prioritized, Object... args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å…ˆè¿›è¡Œåç»­çš„checkï¼ŒåŒ…æ‹¬è§„åˆ™çš„checkï¼Œé»‘ç™½åå•check</span></span><br><span class="line">        fireEntry(context, resourceWrapper, node, count, prioritized, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç»Ÿè®¡é»˜è®¤qps çº¿ç¨‹æ•°</span></span><br><span class="line">        node.increaseThreadNum();</span><br><span class="line">        node.addPassRequest(count);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (context.getCurEntry().getOriginNode() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ ¹æ®æ¥æºç»Ÿè®¡qps çº¿ç¨‹æ•°</span></span><br><span class="line">            context.getCurEntry().getOriginNode().increaseThreadNum();</span><br><span class="line">            context.getCurEntry().getOriginNode().addPassRequest(count);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (resourceWrapper.getEntryType() == EntryType.IN) &#123;</span><br><span class="line">            <span class="comment">// ç»Ÿè®¡å…¥å£ qps çº¿ç¨‹æ•°</span></span><br><span class="line">            Constants.ENTRY_NODE.increaseThreadNum();</span><br><span class="line">            Constants.ENTRY_NODE.addPassRequest(count);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        .... çœç•¥å…¶ä»–ä»£ç </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="StatisticSlotä¸»è¦åšäº†4ç§ä¸åŒç»´åº¦çš„æµé‡ç»Ÿè®¡"><a href="#StatisticSlotä¸»è¦åšäº†4ç§ä¸åŒç»´åº¦çš„æµé‡ç»Ÿè®¡" class="headerlink" title="StatisticSlotä¸»è¦åšäº†4ç§ä¸åŒç»´åº¦çš„æµé‡ç»Ÿè®¡"></a>StatisticSlotä¸»è¦åšäº†4ç§ä¸åŒç»´åº¦çš„æµé‡ç»Ÿè®¡</h2><ol><li>èµ„æºåœ¨ä¸Šä¸‹æ–‡ç»´åº¦ï¼ˆDefaultNodeï¼‰çš„ç»Ÿè®¡</li><li>clusterNode ç»´åº¦çš„ç»Ÿè®¡</li><li>Origin æ¥æºç»´åº¦çš„ç»Ÿè®¡</li><li>å…¥å£å…¨å±€æµé‡çš„ç»Ÿè®¡</li></ol><p>å…³äºæµé‡çš„ç»Ÿè®¡åŸç†çš„æœ¬æ–‡å°±ä¸æ·±å…¥åˆ†æäº†ï¼Œæ¥ä¸‹æ¥çš„æ–‡ç« ä¸­ä¼šå•ç‹¬åˆ†æ</p><h2 id="SystemSlot"><a href="#SystemSlot" class="headerlink" title="SystemSlot"></a>SystemSlot</h2><p><code>SystemSlot</code>æ¯”è¾ƒç®€å•ï¼Œå…¶å®å°±æ˜¯æ ¹æ®<code>StatisticSlot</code>æ‰€ç»Ÿè®¡çš„å…¨å±€å…¥å£æµé‡è¿›è¡Œé™æµã€‚</p><h2 id="AuthoritySlot"><a href="#AuthoritySlot" class="headerlink" title="AuthoritySlot"></a>AuthoritySlot</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">entry</span><span class="params">(Context context, ResourceWrapper resourceWrapper, DefaultNode node, <span class="keyword">int</span> count, <span class="keyword">boolean</span> prioritized, Object... args)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    checkBlackWhiteAuthority(resourceWrapper, context);</span><br><span class="line">    fireEntry(context, resourceWrapper, node, count, prioritized, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkBlackWhiteAuthority</span><span class="params">(ResourceWrapper resource, Context context)</span> <span class="keyword">throws</span> AuthorityException </span>&#123;</span><br><span class="line">    Map&lt;String, Set&lt;AuthorityRule&gt;&gt; authorityRules = AuthorityRuleManager.getAuthorityRules();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (authorityRules == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// æ ¹æ®èµ„æºè·å–é»‘ç™½åå•è§„åˆ™</span></span><br><span class="line">    Set&lt;AuthorityRule&gt; rules = authorityRules.get(resource.getName());</span><br><span class="line">    <span class="keyword">if</span> (rules == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯¹è§„åˆ™è¿›è¡Œæ ¡éªŒï¼Œåªè¦æœ‰ä¸€æ¡ä¸é€šè¿‡ å°±æŠ›å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">for</span> (AuthorityRule rule : rules) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!AuthorityRuleChecker.passCheck(rule, context)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthorityException(context.getOrigin(), rule);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AuthoritySlot</code>ä¼šå¯¹èµ„æºçš„é»‘ç™½åå•åšæ£€æŸ¥ï¼Œå¹¶ä¸”åªè¦æœ‰ä¸€æ¡ä¸é€šè¿‡å°±æŠ›å¼‚å¸¸ã€‚</p><h2 id="FlowSlot"><a href="#FlowSlot" class="headerlink" title="FlowSlot"></a>FlowSlot</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">entry</span><span class="params">(Context context, ResourceWrapper resourceWrapper, DefaultNode node, <span class="keyword">int</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">boolean</span> prioritized, Object... args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    checkFlow(resourceWrapper, context, node, count, prioritized);</span><br><span class="line"></span><br><span class="line">    fireEntry(context, resourceWrapper, node, count, prioritized, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkFlow</span><span class="params">(ResourceWrapper resource, Context context, DefaultNode node, <span class="keyword">int</span> count, <span class="keyword">boolean</span> prioritized)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> BlockException </span>&#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥é™æµè§„åˆ™</span></span><br><span class="line">    checker.checkFlow(ruleProvider, resource, context, node, count, prioritized);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª<code>slot</code>ä¸»è¦æ ¹æ®é¢„è®¾çš„èµ„æºçš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒæŒ‰ç…§å›ºå®šçš„æ¬¡åºï¼Œä¾æ¬¡ç”Ÿæ•ˆã€‚å¦‚æœä¸€ä¸ªèµ„æºå¯¹åº”ä¸¤æ¡æˆ–è€…å¤šæ¡æµæ§è§„åˆ™ï¼Œåˆ™ä¼šæ ¹æ®å¦‚ä¸‹æ¬¡åºä¾æ¬¡æ£€éªŒï¼Œç›´åˆ°å…¨éƒ¨é€šè¿‡æˆ–è€…æœ‰ä¸€ä¸ªè§„åˆ™ç”Ÿæ•ˆä¸ºæ­¢:<br>å¹¶ä¸”åŒæ ·ä¹Ÿä¼šæ ¹æ®ä¸‰ç§ä¸åŒçš„ç»´åº¦æ¥è¿›è¡Œé™æµï¼š</p><ol><li>èµ„æºåœ¨ä¸Šä¸‹æ–‡ç»´åº¦ï¼ˆDefaultNodeï¼‰çš„ç»Ÿè®¡</li><li>clusterNode ç»´åº¦çš„ç»Ÿè®¡</li><li>Origin æ¥æºç»´åº¦çš„ç»Ÿè®¡</li></ol><p>å…³äºæµæ§è§„åˆ™æºç çš„æ·±å…¥åˆ†æå°±ä¸åœ¨æœ¬ç¯‡æ–‡ç« èµ˜è¿°äº†</p><h2 id="DegradeSlot"><a href="#DegradeSlot" class="headerlink" title="DegradeSlot"></a>DegradeSlot</h2><p>è¿™ä¸ª<code>slot</code>ä¸»è¦é’ˆå¯¹èµ„æºçš„å¹³å‡å“åº”æ—¶é—´ï¼ˆRTï¼‰ä»¥åŠå¼‚å¸¸æ¯”ç‡ï¼Œæ¥å†³å®šèµ„æºæ˜¯å¦åœ¨æ¥ä¸‹æ¥çš„æ—¶é—´è¢«è‡ªåŠ¨ç†”æ–­æ‰ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li>ç›¸åŒçš„èµ„æº({@link ResourceWrapper#equals(Object)})å°†å…¨å±€å…±äº«ç›¸åŒçš„{@link ProcessorSlotChain}ï¼Œæ— è®ºåœ¨å“ªä¸ªä¸Šä¸‹æ–‡ä¸­</li><li>æµæ§æœ‰å¤šä¸ªç»´åº¦ï¼Œåˆ†åˆ«åŒ…æ‹¬ï¼š1.ä¸åŒä¸Šä¸‹æ–‡ä¸­çš„èµ„æº 2.ç›¸åŒèµ„æº 3.å…¥å£æµé‡ 3.ç›¸åŒçš„æ¥æº</li></ol><p>Sentinelç³»åˆ—</p><ul><li><p><a href="http://wangjunnan.club/2019/10/11/Sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%80/" target="_blank" rel="noopener">Sentinelæºç è§£æä¸€</a></p></li><li><p><a href="http://wangjunnan.club/2019/10/16/Sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C%EF%BC%88slot%E6%80%BB%E8%A7%88%EF%BC%89/" target="_blank" rel="noopener">Sentinelæºç è§£æäºŒï¼ˆslotæ€»è§ˆï¼‰</a></p></li><li><p><a href="http://wangjunnan.club/2019/10/25/Sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89%EF%BC%88%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%B5%81%E9%87%8F%E7%BB%9F%E8%AE%A1%EF%BC%89/" target="_blank" rel="noopener">Sentinelæºç è§£æäºŒï¼ˆæ»‘åŠ¨çª—å£æµé‡ç»Ÿè®¡ï¼‰</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å†™åœ¨å‰é¢&quot;&gt;&lt;a href=&quot;#å†™åœ¨å‰é¢&quot; class=&quot;headerlink&quot; title=&quot;å†™åœ¨å‰é¢&quot;&gt;&lt;/a&gt;å†™åœ¨å‰é¢&lt;/h2&gt;&lt;p&gt;æœ¬æ–‡ç»§ç»­æ¥åˆ†æSentinelçš„æºç ï¼Œä¸Šç¯‡æ–‡ç« å¯¹Sentinelçš„è°ƒç”¨è¿‡ç¨‹åšäº†æ·±å…¥åˆ†æï¼Œä¸»è¦æ¶‰åŠåˆ°äº†ä¸¤ä¸ªæ¦‚å¿µï¼šæ’æ§½é“¾å’ŒNod
      
    
    </summary>
    
      <category term="javaæ¡†æ¶" scheme="http://wangjunnan.github.io/categories/java%E6%A1%86%E6%9E%B6/"/>
    
      <category term="Sentinel" scheme="http://wangjunnan.github.io/categories/java%E6%A1%86%E6%9E%B6/Sentinel/"/>
    
    
      <category term="å¹¶å‘" scheme="http://wangjunnan.github.io/tags/%E5%B9%B6%E5%8F%91/"/>
    
      <category term="Sentinel" scheme="http://wangjunnan.github.io/tags/Sentinel/"/>
    
  </entry>
  
  <entry>
    <title>Sentinelæºç è§£æä¸€</title>
    <link href="http://wangjunnan.github.io/2019/10/11/Sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%80/"/>
    <id>http://wangjunnan.github.io/2019/10/11/Sentinelæºç è§£æä¸€/</id>
    <published>2019-10-11T11:42:31.000Z</published>
    <updated>2019-10-25T09:12:11.083Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p><code>Sentinel</code>ä½œä¸ºaliå¼€æºçš„ä¸€æ¬¾è½»é‡çº§æµæ§æ¡†æ¶ï¼Œ<strong>ä¸»è¦ä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦æ¥å¸®åŠ©ç”¨æˆ·ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§</strong>ã€‚ç›¸æ¯”äº<code>Hystrix</code>ï¼Œ<code>Sentinel</code>çš„è®¾è®¡æ›´åŠ ç®€å•ï¼Œåœ¨ <code>Sentinel</code>ä¸­èµ„æºå®šä¹‰å’Œè§„åˆ™é…ç½®æ˜¯åˆ†ç¦»çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·å¯ä»¥å…ˆé€šè¿‡<code>Sentinel API</code>ç»™å¯¹åº”çš„ä¸šåŠ¡é€»è¾‘å®šä¹‰èµ„æºï¼ˆåŸ‹ç‚¹ï¼‰ï¼Œç„¶ååœ¨éœ€è¦çš„æ—¶å€™å†é…ç½®è§„åˆ™ï¼Œé€šè¿‡è¿™ç§ç»„åˆæ–¹å¼ï¼Œæå¤§çš„å¢åŠ äº†<code>Sentinel</code>æµæ§çš„çµæ´»æ€§ã€‚</p><p>å¼•å…¥<code>Sentinel</code>å¸¦æ¥çš„æ€§èƒ½æŸè€—éå¸¸å°ã€‚åªæœ‰åœ¨ä¸šåŠ¡å•æœºé‡çº§è¶…è¿‡25W QPSçš„æ—¶å€™æ‰ä¼šæœ‰ä¸€äº›æ˜¾è‘—çš„å½±å“ï¼ˆ5% - 10% å·¦å³ï¼‰ï¼Œå•æœºQPSä¸å¤ªå¤§çš„æ—¶å€™æŸè€—å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</p><p><code>Sentinel</code>æä¾›ä¸¤ç§åŸ‹ç‚¹æ–¹å¼:</p><ul><li><code>try-catch</code> æ–¹å¼ï¼ˆé€šè¿‡ <code>SphU.entry(...)</code>ï¼‰ï¼Œç”¨æˆ·åœ¨ catch å—ä¸­æ‰§è¡Œå¼‚å¸¸å¤„ç† / fallback</li><li><code>if-else</code> æ–¹å¼ï¼ˆé€šè¿‡ <code>SphO.entry(...)</code>ï¼‰ï¼Œå½“è¿”å› false æ—¶æ‰§è¡Œå¼‚å¸¸å¤„ç† / fallback</li></ul><h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>åœ¨æ­¤ä¹‹å‰ï¼Œéœ€è¦å…ˆäº†è§£ä¸€ä¸‹<code>Sentinel</code>çš„å·¥ä½œæµç¨‹<br>åœ¨ <code>Sentinel</code> é‡Œé¢ï¼Œæ‰€æœ‰çš„èµ„æºéƒ½å¯¹åº”ä¸€ä¸ªèµ„æºåç§°ï¼ˆ<code>resourceName</code>ï¼‰ï¼Œæ¯æ¬¡èµ„æºè°ƒç”¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ª <code>Entry</code> å¯¹è±¡ã€‚<code>Entry</code> å¯ä»¥é€šè¿‡å¯¹ä¸»æµæ¡†æ¶çš„é€‚é…è‡ªåŠ¨åˆ›å»ºï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ³¨è§£çš„æ–¹å¼æˆ–è°ƒç”¨ <code>SphU API</code> æ˜¾å¼åˆ›å»ºã€‚<code>Entry</code> åˆ›å»ºçš„æ—¶å€™ï¼ŒåŒæ—¶ä¹Ÿä¼šåˆ›å»ºä¸€ç³»åˆ—åŠŸèƒ½æ’æ§½ï¼ˆ<code>slot chain</code>ï¼‰ï¼Œè¿™äº›æ’æ§½æœ‰ä¸åŒçš„èŒè´£ï¼Œä¾‹å¦‚é»˜è®¤æƒ…å†µä¸‹ä¼šåˆ›å»ºä¸€ä¸‹7ä¸ªæ’æ§½ï¼š</p><ul><li><code>NodeSelectorSlot</code> è´Ÿè´£æ”¶é›†èµ„æºçš„è·¯å¾„ï¼Œå¹¶å°†è¿™äº›èµ„æºçš„è°ƒç”¨è·¯å¾„ï¼Œä»¥æ ‘çŠ¶ç»“æ„å­˜å‚¨èµ·æ¥ï¼Œç”¨äºæ ¹æ®è°ƒç”¨è·¯å¾„æ¥é™æµé™çº§ï¼›</li><li><code>ClusterBuilderSlot</code> åˆ™ç”¨äºå­˜å‚¨èµ„æºçš„ç»Ÿè®¡ä¿¡æ¯ä»¥åŠè°ƒç”¨è€…ä¿¡æ¯ï¼Œä¾‹å¦‚è¯¥èµ„æºçš„ <code>RT, QPS, thread count</code> ç­‰ç­‰ï¼Œè¿™äº›ä¿¡æ¯å°†ç”¨ä½œä¸ºå¤šç»´åº¦é™æµï¼Œé™çº§çš„ä¾æ®ï¼›</li><li><code>StatisticSlot</code> åˆ™ç”¨äºè®°å½•ã€ç»Ÿè®¡ä¸åŒçº¬åº¦çš„ <code>runtime</code> æŒ‡æ ‡ç›‘æ§ä¿¡æ¯ï¼›</li><li><code>FlowSlot</code> åˆ™ç”¨äºæ ¹æ®é¢„è®¾çš„é™æµè§„åˆ™ä»¥åŠå‰é¢ <code>slot</code> ç»Ÿè®¡çš„çŠ¶æ€ï¼Œæ¥è¿›è¡Œæµé‡æ§åˆ¶ï¼›</li><li><code>AuthoritySlot</code> åˆ™æ ¹æ®é…ç½®çš„é»‘ç™½åå•å’Œè°ƒç”¨æ¥æºä¿¡æ¯ï¼Œæ¥åšé»‘ç™½åå•æ§åˆ¶ï¼›</li><li><code>DegradeSlot</code> åˆ™é€šè¿‡ç»Ÿè®¡ä¿¡æ¯ä»¥åŠé¢„è®¾çš„è§„åˆ™ï¼Œæ¥åšç†”æ–­é™çº§ï¼›</li><li><code>SystemSlot</code> åˆ™é€šè¿‡ç³»ç»Ÿçš„çŠ¶æ€ï¼Œä¾‹å¦‚ <code>load1</code> ç­‰ï¼Œæ¥æ§åˆ¶æ€»çš„å…¥å£æµé‡</li></ul><p>æ³¨æ„ï¼šè¿™é‡Œçš„æ’æ§½é“¾éƒ½æ˜¯ä¸€ä¸€å¯¹åº”èµ„æºåç§°çš„</p><p>ä¸Šé¢çš„æ‰€ä»‹ç»çš„æ’æ§½ï¼ˆ<code>slot chain</code>ï¼‰æ˜¯<code>Sentinel</code>éå¸¸é‡è¦çš„æ¦‚å¿µã€‚åŒæ—¶è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µé‚£å°±æ˜¯<code>Node</code>ï¼Œä¸ºäº†å¸®åŠ©ç†è§£ï¼Œå°½æˆ‘æ‰€èƒ½ç”»äº†ä¸‹é¢è¿™å¼ å›¾ï¼Œå¯ä»¥çœ‹åˆ°æ•´ä¸ªç»“æ„éå¸¸çš„åƒä¸€æ£µæ ‘ï¼š</p><p><img src="http://img.souche.com/f2e/f88669970def3f8da53f6488b3a31366.jpg" alt></p><p>ç®€å•è§£é‡Šä¸‹ä¸Šå›¾ï¼š</p><ul><li>é¡¶éƒ¨è“è‰²çš„<code>node</code>èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹ï¼Œå…¨å±€å”¯ä¸€</li><li>ä¸‹é¢é»„è‰²çš„èŠ‚ç‚¹ä¸ºå…¥å£èŠ‚ç‚¹ï¼Œæ¯ä¸ª<code>CentextName</code>(ä¸Šä¸‹æ–‡åç§°)ä¸€ä¸€å¯¹åº”ä¸€ä¸ª<ul><li>å¯ä»¥æœ‰å¤šä¸ªå­èŠ‚ç‚¹ï¼ˆå¯¹åº”å¤šç§èµ„æºï¼‰</li></ul></li><li>ä¸­é—´ç»¿è‰²æ¡†æ¡†ä¸­çš„èŠ‚ç‚¹éƒ½æ˜¯å±äºåŒä¸€ä¸ªèµ„æºçš„(ç›¸åŒçš„<code>ResourceName</code>)</li><li>æœ€åº•ä¸‹ç´«è‰²çš„èŠ‚ç‚¹æ˜¯é›†ç¾¤èŠ‚ç‚¹ï¼Œå¯ä»¥ç†è§£æˆç»¿è‰²æ¡†æ¡†ä¸­Nodeèµ„æºçš„æ•´åˆ</li></ul><p>ä»¥ä¸Š2ä¸ªæ¦‚å¿µåŠ¡å¿…è¦ç†æ¸…æ¥šï¼Œä¹‹åå†ä¸€æ­¥ä¸€æ­¥çœ‹æºç ä¼šæ¯”è¾ƒæ¸…æ™°</p><p>ä¸‹é¢æˆ‘ä»¬å°†ä»å…¥å£æºç å¼€å§‹ä¸€æ­¥ä¸€æ­¥åˆ†ææ•´ä¸ªè°ƒç”¨è¿‡ç¨‹ï¼š</p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>ä¸‹é¢çš„æ˜¯ä¸€ä¸ª<code>Sentinel</code>ä½¿ç”¨çš„ç¤ºä¾‹ä»£ç ï¼Œæˆ‘ä»¬å°±ä»è¿™é‡Œåˆ‡å…¥å¼€å§‹åˆ†æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªåç§°ä¸ºentrance1ï¼Œæ¥æºä¸ºappA çš„ä¸Šä¸‹æ–‡Context</span></span><br><span class="line">ContextUtil.enter(<span class="string">"entrance1"</span>, <span class="string">"appA"</span>);</span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªèµ„æºåç§°nodeAçš„Entry</span></span><br><span class="line"> Entry nodeA = SphU.entry(<span class="string">"nodeA"</span>);</span><br><span class="line"> <span class="keyword">if</span> (nodeA != <span class="keyword">null</span>) &#123;</span><br><span class="line">    nodeA.exit();</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// æ¸…é™¤ä¸Šä¸‹æ–‡</span></span><br><span class="line"> ContextUtil.exit();</span><br></pre></td></tr></table></figure><h3 id="ContextUtil-enter-â€œentrance1â€-â€œappAâ€"><a href="#ContextUtil-enter-â€œentrance1â€-â€œappAâ€" class="headerlink" title="ContextUtil.enter(â€œentrance1â€, â€œappAâ€)"></a>ContextUtil.enter(â€œentrance1â€, â€œappAâ€)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Context <span class="title">enter</span><span class="params">(String name, String origin)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­ä¸Šä¸‹æ–‡åç§°æ˜¯å¦ä¸ºé»˜è®¤çš„åç§°ï¼ˆsentinel_default_contextï¼‰ æ˜¯çš„è¯ç›´æ¥æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (Constants.CONTEXT_DEFAULT_NAME.equals(name)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ContextNameDefineException(</span><br><span class="line">            <span class="string">"The "</span> + Constants.CONTEXT_DEFAULT_NAME + <span class="string">" can't be permit to defined!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> trueEnter(name, origin);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> Context <span class="title">trueEnter</span><span class="params">(String name, String origin)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å…ˆä»ThreadLocalä¸­å°è¯•è·å–ï¼Œè·å–åˆ°åˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">    Context context = contextHolder.get();</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Map&lt;String, DefaultNode&gt; localCacheNameMap = contextNameNodeMap;</span><br><span class="line">        <span class="comment">// å°è¯•ä»ç¼“å­˜ä¸­è·å–è¯¥ä¸Šä¸‹æ–‡åç§°å¯¹åº”çš„ å…¥å£èŠ‚ç‚¹</span></span><br><span class="line">        DefaultNode node = localCacheNameMap.get(name);</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="comment">// åˆ¤æ–­ç¼“å­˜ä¸­å…¥å£èŠ‚ç‚¹æ•°é‡æ˜¯å¦å¤§äº2000</span></span><br><span class="line">            <span class="keyword">if</span> (localCacheNameMap.size() &gt; Constants.MAX_CONTEXT_NAME_SIZE) &#123;</span><br><span class="line">                setNullContext();</span><br><span class="line">                <span class="keyword">return</span> NULL_CONTEXT;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// åŠ é”</span></span><br><span class="line">                    LOCK.lock();</span><br><span class="line">                    <span class="comment">// åŒé‡æ£€æŸ¥é”</span></span><br><span class="line">                    node = contextNameNodeMap.get(name);</span><br><span class="line">                    <span class="keyword">if</span> (node == <span class="keyword">null</span>) &#123;</span><br><span class="line">                     <span class="comment">// åˆ¤æ–­ç¼“å­˜ä¸­å…¥å£èŠ‚ç‚¹æ•°é‡æ˜¯å¦å¤§äº2000</span></span><br><span class="line">                        <span class="keyword">if</span> (contextNameNodeMap.size() &gt; Constants.MAX_CONTEXT_NAME_SIZE) &#123;</span><br><span class="line">                            setNullContext();</span><br><span class="line">                            <span class="keyword">return</span> NULL_CONTEXT;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// æ ¹æ®ä¸Šä¸‹æ–‡åç§°ç”Ÿæˆå…¥å£èŠ‚ç‚¹ï¼ˆentranceNodeï¼‰</span></span><br><span class="line">                            node = <span class="keyword">new</span> EntranceNode(<span class="keyword">new</span> StringResourceWrapper(name, EntryType.IN), <span class="keyword">null</span>);</span><br><span class="line">                            <span class="comment">// åŠ å…¥è‡³å…¨å±€æ ¹èŠ‚ç‚¹ä¸‹</span></span><br><span class="line">                            Constants.ROOT.addChild(node);</span><br><span class="line">                            <span class="comment">// åŠ å…¥ç¼“å­˜ä¸­</span></span><br><span class="line">                            Map&lt;String, DefaultNode&gt; newMap = <span class="keyword">new</span> HashMap&lt;&gt;(contextNameNodeMap.size() + <span class="number">1</span>);</span><br><span class="line">                            newMap.putAll(contextNameNodeMap);</span><br><span class="line">                            newMap.put(name, node);</span><br><span class="line">                            contextNameNodeMap = newMap;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    LOCK.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ä¸Šä¸‹æ–‡å¯¹è±¡</span></span><br><span class="line">        context = <span class="keyword">new</span> Context(node, name);</span><br><span class="line">        context.setOrigin(origin);</span><br><span class="line">        <span class="comment">// è®¾ç½®åˆ°å½“å‰çº¿ç¨‹ä¸­</span></span><br><span class="line">        contextHolder.set(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦åšäº†2ä»¶äº‹æƒ…</p><ol><li>æ ¹æ®<code>ContextName</code>ç”Ÿæˆ<code>entranceNode</code>ï¼Œå¹¶åŠ å…¥ç¼“å­˜ï¼Œæ¯ä¸ª<code>ContextName</code>å¯¹åº”ä¸€ä¸ªå…¥å£èŠ‚ç‚¹<code>entranceNode</code></li><li>æ ¹æ®<code>ContextName</code>å’Œ<code>entranceNode</code>åˆå§‹åŒ–ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå¹¶å°†ä¸Šä¸‹æ–‡å¯¹è±¡è®¾ç½®åˆ°å½“å‰çº¿ç¨‹ä¸­</li></ol><p>è¿™é‡Œæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š</p><ol><li>å…¥å£èŠ‚ç‚¹æ•°é‡ä¸èƒ½å¤§äº2000ï¼Œå¤§äºä¼šç›´æ¥æŠ›å¼‚å¸¸</li><li>æ¯ä¸ª<code>ContextName</code>å¯¹åº”ä¸€ä¸ªå…¥å£èŠ‚ç‚¹<code>entranceNode</code></li><li>æ¯ä¸ª<code>entranceNode</code>éƒ½æœ‰å…±åŒçš„çˆ¶èŠ‚ç‚¹ã€‚ä¹Ÿå°±æ˜¯æ ¹èŠ‚ç‚¹</li></ol><h3 id="Entry-nodeA-SphU-entry-â€œnodeAâ€"><a href="#Entry-nodeA-SphU-entry-â€œnodeAâ€" class="headerlink" title="Entry nodeA = SphU.entry(â€œnodeAâ€)"></a>Entry nodeA = SphU.entry(â€œnodeAâ€)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SphU.class</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Entry <span class="title">entry</span><span class="params">(String name)</span> <span class="keyword">throws</span> BlockException </span>&#123;</span><br><span class="line">    <span class="comment">// é»˜è®¤ä¸º å‡ºå£æµé‡ç±»å‹ï¼Œå•ä½ç»Ÿè®¡æ•°ä¸º1</span></span><br><span class="line">    <span class="keyword">return</span> Env.sph.entry(name, EntryType.OUT, <span class="number">1</span>, OBJECTS0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CtSph.class</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Entry <span class="title">entry</span><span class="params">(String name, EntryType type, <span class="keyword">int</span> count, Object... args)</span> <span class="keyword">throws</span> BlockException </span>&#123;</span><br><span class="line">    <span class="comment">// ç”Ÿæˆèµ„æºå¯¹è±¡</span></span><br><span class="line">    StringResourceWrapper resource = <span class="keyword">new</span> StringResourceWrapper(name, type);</span><br><span class="line">    <span class="keyword">return</span> entry(resource, count, args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Entry <span class="title">entry</span><span class="params">(ResourceWrapper resourceWrapper, <span class="keyword">int</span> count, Object... args)</span> <span class="keyword">throws</span> BlockException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> entryWithPriority(resourceWrapper, count, <span class="keyword">false</span>, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œä¸æŒ‡å®š<code>EntryType</code>çš„è¯ï¼Œåˆ™é»˜è®¤ä¸ºå‡ºå£æµé‡ç±»å‹ï¼Œæœ€ç»ˆä¼šè°ƒç”¨<code>entryWithPriority</code>æ–¹æ³•ï¼Œä¸»è¦ä¸šåŠ¡é€»è¾‘ä¹Ÿéƒ½åœ¨è¿™ä¸ªæ–¹æ³•ä¸­</p><ul><li>entryWithPriorityæ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Entry <span class="title">entryWithPriority</span><span class="params">(ResourceWrapper resourceWrapper, <span class="keyword">int</span> count, <span class="keyword">boolean</span> prioritized, Object... args)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> BlockException </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡å¯¹è±¡</span></span><br><span class="line">    Context context = ContextUtil.getContext();</span><br><span class="line">    <span class="comment">// ä¸Šä¸‹æ–‡åç§°å¯¹åº”çš„å…¥å£èŠ‚ç‚¹æ˜¯å¦å·²ç»è¶…è¿‡é˜ˆå€¼2000ï¼Œè¶…è¿‡åˆ™ä¼šè¿”å›ç©º CtEntry</span></span><br><span class="line">    <span class="keyword">if</span> (context <span class="keyword">instanceof</span> NullContext) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CtEntry(resourceWrapper, <span class="keyword">null</span>, context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰æŒ‡å®šä¸Šä¸‹æ–‡åç§°ï¼Œåˆ™ä½¿ç”¨é»˜è®¤åç§°ï¼Œä¹Ÿå°±æ˜¯é»˜è®¤å…¥å£èŠ‚ç‚¹</span></span><br><span class="line">        context = InternalContextUtil.internalEnter(Constants.CONTEXT_DEFAULT_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¨å±€å¼€å…³</span></span><br><span class="line">    <span class="keyword">if</span> (!Constants.ON) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CtEntry(resourceWrapper, <span class="keyword">null</span>, context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç”Ÿæˆæ’æ§½é“¾</span></span><br><span class="line">    ProcessorSlot&lt;Object&gt; chain = lookProcessChain(resourceWrapper);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * è¡¨ç¤ºèµ„æº(æ’æ§½é“¾)è¶…è¿‡6000ï¼Œå› æ­¤ä¸ä¼šè¿›è¡Œè§„åˆ™æ£€æŸ¥ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (chain == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CtEntry(resourceWrapper, <span class="keyword">null</span>, context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç”Ÿæˆ Entry å¯¹è±¡</span></span><br><span class="line">    Entry e = <span class="keyword">new</span> CtEntry(resourceWrapper, chain, context);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å¼€å§‹æ‰§è¡Œæ’æ§½é“¾ è°ƒç”¨é€»è¾‘</span></span><br><span class="line">        chain.entry(context, resourceWrapper, <span class="keyword">null</span>, count, prioritized, args);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BlockException e1) &#123;</span><br><span class="line">        <span class="comment">// æ¸…é™¤ä¸Šä¸‹æ–‡</span></span><br><span class="line">        e.exit(count, args);</span><br><span class="line">        <span class="keyword">throw</span> e1;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e1) &#123;</span><br><span class="line">        <span class="comment">// é™¤éSentinelå†…éƒ¨å­˜åœ¨é”™è¯¯ï¼Œå¦åˆ™ä¸åº”å‘ç”Ÿè¿™ç§æƒ…å†µã€‚</span></span><br><span class="line">        RecordLog.info(<span class="string">"Sentinel unexpected exception"</span>, e1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•å¯ä»¥è¯´æ˜¯æ¶µç›–äº†æ•´ä¸ªSentinelçš„æ ¸å¿ƒé€»è¾‘</p><ol><li>è·å–ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå¦‚æœä¸Šä¸‹æ–‡å¯¹è±¡è¿˜æœªåˆå§‹åŒ–ï¼Œåˆ™ä½¿ç”¨é»˜è®¤åç§°åˆå§‹åŒ–ã€‚åˆå§‹åŒ–é€»è¾‘åœ¨ä¸Šæ–‡å·²ç»åˆ†æè¿‡</li><li>åˆ¤æ–­å…¨å±€å¼€å…³</li><li>æ ¹æ®ç»™å®šçš„èµ„æºç”Ÿæˆæ’æ§½é“¾ï¼Œæ’æ§½é“¾æ˜¯è·Ÿèµ„æºç›¸å…³çš„ï¼ŒSentinelæœ€å…³é”®çš„é€»è¾‘ä¹Ÿéƒ½åœ¨å„ä¸ªæ’æ§½ä¸­ã€‚åˆå§‹åŒ–çš„é€»è¾‘åœ¨<code>lookProcessChain(resourceWrapper);</code>ä¸­ï¼Œä¸‹æ–‡ä¼šåˆ†æ</li><li>ä¾é¡ºåºæ‰§è¡Œæ¯ä¸ªæ’æ§½é€»è¾‘</li></ol><h3 id="lookProcessChain-resourceWrapper-æ–¹æ³•"><a href="#lookProcessChain-resourceWrapper-æ–¹æ³•" class="headerlink" title="lookProcessChain(resourceWrapper)æ–¹æ³•"></a>lookProcessChain(resourceWrapper)æ–¹æ³•</h3><p><code>lookProcessChain</code>æ–¹æ³•ä¸ºæŒ‡å®šèµ„æºç”Ÿæˆæ’æ§½é“¾ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„åˆå§‹åŒ–é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ProcessorSlot&lt;Object&gt; <span class="title">lookProcessChain</span><span class="params">(ResourceWrapper resourceWrapper)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®èµ„æºå°è¯•ä»å…¨å±€ç¼“å­˜ä¸­è·å–</span></span><br><span class="line">    ProcessorSlotChain chain = chainMap.get(resourceWrapper);</span><br><span class="line">    <span class="keyword">if</span> (chain == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// éå¸¸å¸¸è§çš„åŒé‡æ£€æŸ¥é”</span></span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) &#123;</span><br><span class="line">            chain = chainMap.get(resourceWrapper);</span><br><span class="line">            <span class="keyword">if</span> (chain == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­èµ„æºæ•°æ˜¯å¦å¤§äº6000</span></span><br><span class="line">                <span class="keyword">if</span> (chainMap.size() &gt;= Constants.MAX_SLOT_CHAIN_SIZE) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// åˆå§‹åŒ–æ’æ§½é“¾</span></span><br><span class="line">                chain = SlotChainProvider.newSlotChain();</span><br><span class="line">                Map&lt;ResourceWrapper, ProcessorSlotChain&gt; newMap = <span class="keyword">new</span> HashMap&lt;ResourceWrapper, ProcessorSlotChain&gt;(</span><br><span class="line">                    chainMap.size() + <span class="number">1</span>);</span><br><span class="line">                newMap.putAll(chainMap);</span><br><span class="line">                newMap.put(resourceWrapper, chain);</span><br><span class="line">                chainMap = newMap;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> chain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>æ ¹æ®èµ„æºå°è¯•ä»å…¨å±€ç¼“å­˜ä¸­è·å–æ’æ§½é“¾ã€‚æ¯ä¸ªèµ„æºå¯¹åº”ä¸€ä¸ªæ’æ§½é“¾ï¼ˆèµ„æºå˜´å¤šåªèƒ½å®šä¹‰6000ä¸ªï¼‰</li><li>åˆå§‹åŒ–æ’æ§½é“¾ä¸Šçš„æ’æ§½ï¼ˆ<code>SlotChainProvider.newSlotChain()</code>æ–¹æ³•ä¸­ï¼‰</li></ol><p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹åˆå§‹åŒ–æ’æ§½é“¾ä¸Šçš„æ’æ§½çš„é€»è¾‘</p><h3 id="SlotChainProvider-newSlotChain"><a href="#SlotChainProvider-newSlotChain" class="headerlink" title="SlotChainProvider.newSlotChain()"></a>SlotChainProvider.newSlotChain()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProcessorSlotChain <span class="title">newSlotChain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡</span></span><br><span class="line">    <span class="keyword">if</span> (builder != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// åŠ è½½ SlotChain </span></span><br><span class="line">    resolveSlotChainBuilder();</span><br><span class="line">    <span class="comment">// åŠ è½½å¤±è´¥åˆ™ä½¿ç”¨é»˜è®¤ æ’æ§½é“¾ </span></span><br><span class="line">    <span class="keyword">if</span> (builder == <span class="keyword">null</span>) &#123;</span><br><span class="line">        RecordLog.warn(<span class="string">"[SlotChainProvider] Wrong state when resolving slot chain builder, using default"</span>);</span><br><span class="line">        builder = <span class="keyword">new</span> DefaultSlotChainBuilder();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ„å»ºå®Œæˆ</span></span><br><span class="line">    <span class="keyword">return</span> builder.build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * javaè‡ªå¸¦ SPIæœºåˆ¶ åŠ è½½ slotChain</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">resolveSlotChainBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;SlotChainBuilder&gt; list = <span class="keyword">new</span> ArrayList&lt;SlotChainBuilder&gt;();</span><br><span class="line">    <span class="keyword">boolean</span> hasOther = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// å°è¯•è·å–è‡ªå®šä¹‰SlotChainBuilderï¼Œé€šè¿‡JAVA SPIæœºåˆ¶æ‰©å±•</span></span><br><span class="line">    <span class="keyword">for</span> (SlotChainBuilder builder : LOADER) &#123;</span><br><span class="line">        <span class="keyword">if</span> (builder.getClass() != DefaultSlotChainBuilder.class) &#123;</span><br><span class="line">            hasOther = <span class="keyword">true</span>;</span><br><span class="line">            list.add(builder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hasOther) &#123;</span><br><span class="line">        builder = list.get(<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æœªè·å–åˆ°è‡ªå®šä¹‰ SlotChainBuilder åˆ™ä½¿ç”¨é»˜è®¤çš„</span></span><br><span class="line">        builder = <span class="keyword">new</span> DefaultSlotChainBuilder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RecordLog.info(<span class="string">"[SlotChainProvider] Global slot chain builder resolved: "</span></span><br><span class="line">        + builder.getClass().getCanonicalName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>é¦–å…ˆä¼šå°è¯•è·å–è‡ªå®šä¹‰çš„<code>SlotChainBuilder</code>æ¥æ„å»ºæ’æ§½é“¾ï¼Œè‡ªå®šä¹‰çš„<code>SlotChainBuilder</code>å¯ä»¥é€šè¿‡JAVA SPIæœºåˆ¶æ¥æ‰©å±•</li><li>å¦‚æœæœªé…ç½®è‡ªå®šä¹‰çš„<code>SlotChainBuilder</code>ï¼Œåˆ™ä¼šä½¿ç”¨é»˜è®¤çš„<code>DefaultSlotChainBuilder</code>æ¥æ„å»ºæ’æ§½é“¾ï¼Œ<code>DefaultSlotChainBuilder</code>æ‰€æ„å»ºçš„æ’æ§½å°±æ˜¯æ–‡ç« å¼€å¤´æˆ‘ä»¬æåˆ°çš„7ç§<code>Slot</code>ã€‚æ¯ä¸ªæ’æ§½éƒ½æœ‰å…¶å¯¹åº”çš„èŒè´£ï¼Œå„å¸å…¶èŒï¼Œåé¢æˆ‘ä»¬ä¼šè¯¦ç»†åˆ†æè¿™å‡ ä¸ªæ’æ§½çš„æºç ï¼ŒåŠæ‰€æ‰¿æ‹…çš„èŒè´£ã€‚</li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ–‡ç« å¼€å¤´çš„æåˆ°çš„ä¸¤ä¸ªç‚¹(æ’æ§½é“¾å’ŒNode)ï¼Œè¿™æ˜¯Sentinelçš„é‡ç‚¹ï¼Œç†è§£è¿™ä¸¤ç‚¹å¯¹äºé˜…è¯»æºç æ¥è¯´äº‹åŠåŠŸå€</p><p>Sentinelç³»åˆ—</p><ul><li><p><a href="http://wangjunnan.club/2019/10/11/Sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%80/" target="_blank" rel="noopener">Sentinelæºç è§£æä¸€</a></p></li><li><p><a href="http://wangjunnan.club/2019/10/16/Sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C%EF%BC%88slot%E6%80%BB%E8%A7%88%EF%BC%89/" target="_blank" rel="noopener">Sentinelæºç è§£æäºŒï¼ˆslotæ€»è§ˆï¼‰</a></p></li><li><p><a href="http://wangjunnan.club/2019/10/25/Sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89%EF%BC%88%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%B5%81%E9%87%8F%E7%BB%9F%E8%AE%A1%EF%BC%89/" target="_blank" rel="noopener">Sentinelæºç è§£æäºŒï¼ˆæ»‘åŠ¨çª—å£æµé‡ç»Ÿè®¡ï¼‰</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Sentinel&lt;/code&gt;ä½œä¸ºaliå¼€æºçš„ä¸€æ¬¾è½»é‡çº§æµæ§æ¡†æ¶ï¼Œ&lt;strong&gt;ä¸»è¦ä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿ
      
    
    </summary>
    
      <category term="javaæ¡†æ¶" scheme="http://wangjunnan.github.io/categories/java%E6%A1%86%E6%9E%B6/"/>
    
      <category term="Sentinel" scheme="http://wangjunnan.github.io/categories/java%E6%A1%86%E6%9E%B6/Sentinel/"/>
    
    
      <category term="å¹¶å‘" scheme="http://wangjunnan.github.io/tags/%E5%B9%B6%E5%8F%91/"/>
    
      <category term="Sentinel" scheme="http://wangjunnan.github.io/tags/Sentinel/"/>
    
  </entry>
  
  <entry>
    <title>æµ…è°ˆå¸¸ç”¨çš„é™æµç®—æ³•</title>
    <link href="http://wangjunnan.github.io/2019/10/09/%E6%B5%85%E8%B0%88%E5%B8%B8%E7%94%A8%E7%9A%84%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95/"/>
    <id>http://wangjunnan.github.io/2019/10/09/æµ…è°ˆå¸¸ç”¨çš„é™æµç®—æ³•/</id>
    <published>2019-10-09T02:15:47.000Z</published>
    <updated>2019-10-09T02:18:05.016Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>åœ¨å¼€å‘é«˜å¹¶å‘ç³»ç»Ÿæ—¶æœ‰ä¸‰æŠŠåˆ©å™¨ç”¨æ¥ä¿æŠ¤ç³»ç»Ÿï¼šç¼“å­˜ã€é™çº§å’Œé™æµã€‚ä»Šå¤©æˆ‘ä»¬è¦èŠçš„å°±æ˜¯é™æµï¼ˆRate Limitï¼‰ï¼Œé™æµçš„ç›®çš„å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸ºäº†ä¿æŠ¤ç³»ç»Ÿä¸è¢«ç¬æ—¶å¤§æµé‡å†²å®ï¼Œ<br>é™æµè¿™ä¸ªæ¦‚å¿µæˆ‘å…¶å®å¾ˆæ—©ä¹‹å‰å°±æœ‰å»äº†è§£è¿‡ï¼Œä¸è¿‡æ— å¥ˆä¹‹å‰å·¥ä½œæ‰€æ¥è§¦ä¸šåŠ¡çš„å¹¶å‘é‡å®åœ¨æ˜¯è°ˆä¸ä¸Šé™æµã€‚ç›®å‰å…¬å¸å¤§ä¿ƒå³°å€¼QPSåœ¨2wå¾€ä¸Šï¼Œè‡ªç„¶è€Œç„¶éœ€è¦ç”¨åˆ°é™æµï¼Œç‰¹åˆ«æ˜¯ç±»ä¼¼ç§’æ€è¿™ç§ç¬æ—¶æµé‡éå¸¸å¤§ä½†å®é™…æˆå•ç‡ä½çš„ä¸šåŠ¡åœºæ™¯ã€‚</p><p>ç›®å‰æ¯”è¾ƒå¸¸ç”¨çš„é™æµç®—æ³•æœ‰ä¸‰ç§</p><ul><li>è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•</li><li>è®¡æ•°å™¨æ»‘åŠ¨çª—å£ç®—æ³•</li><li>æ¼æ¡¶ç®—æ³•</li><li>ä»¤ç‰Œæ¡¶ç®—æ³•</li></ul><h2 id="è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•"><a href="#è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•" class="headerlink" title="è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•"></a>è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•</h2><p>è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•æ˜¯æœ€ç®€å•çš„é™æµç®—æ³•ï¼Œå®ç°æ–¹å¼ä¹Ÿæ¯”è¾ƒç®€å•ã€‚å°±æ˜¯é€šè¿‡ç»´æŠ¤ä¸€ä¸ªå•ä½æ—¶é—´å†…çš„è®¡æ•°å€¼ï¼Œæ¯å½“ä¸€ä¸ªè¯·æ±‚é€šè¿‡æ—¶ï¼Œå°±å°†è®¡æ•°å€¼åŠ 1ï¼Œå½“è®¡æ•°å€¼è¶…è¿‡é¢„å…ˆè®¾å®šçš„é˜ˆå€¼æ—¶ï¼Œå°±æ‹’ç»å•ä½æ—¶é—´å†…çš„å…¶ä»–è¯·æ±‚ã€‚å¦‚æœå•ä½æ—¶é—´å·²ç»ç»“æŸï¼Œåˆ™å°†è®¡æ•°å™¨æ¸…é›¶ï¼Œå¼€å¯ä¸‹ä¸€è½®çš„è®¡æ•°ã€‚</p><p>ä½†æ˜¯è¿™ç§å®ç°ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸¾ä¸ªä¾‹å­: </p><p>å‡è®¾æˆ‘ä»¬è®¾å®š1ç§’å†…å…è®¸é€šè¿‡çš„è¯·æ±‚é˜ˆå€¼æ˜¯200ï¼Œå¦‚æœæœ‰ç”¨æˆ·åœ¨æ—¶é—´çª—å£çš„æœ€åå‡ æ¯«ç§’å‘é€äº†200ä¸ªè¯·æ±‚ï¼Œç´§æ¥ç€åˆåœ¨ä¸‹ä¸€ä¸ªæ—¶é—´çª—å£å¼€å§‹æ—¶å‘é€äº†200ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆè¿™ä¸ªç”¨æˆ·å…¶å®åœ¨ä¸€ç§’å†…æˆåŠŸè¯·æ±‚äº†400æ¬¡ï¼Œæ˜¾ç„¶è¶…è¿‡äº†é˜ˆå€¼ä½†å¹¶ä¸ä¼šè¢«é™æµã€‚å…¶å®è¿™å°±æ˜¯ä¸´ç•Œå€¼é—®é¢˜ï¼Œé‚£ä¹ˆä¸´ç•Œå€¼é—®é¢˜è¦æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p><ul><li>ä»£ç å®ç° â€“ <a href="https://github.com/WangJunnan/learn/blob/master/algorithm/src/main/java/com/walm/learn/algorithm/ratelimit/CounterRateLimit.java" target="_blank" rel="noopener">CounterRateLimit.java</a></li></ul><h2 id="è®¡æ•°å™¨æ»‘åŠ¨çª—å£ç®—æ³•"><a href="#è®¡æ•°å™¨æ»‘åŠ¨çª—å£ç®—æ³•" class="headerlink" title="è®¡æ•°å™¨æ»‘åŠ¨çª—å£ç®—æ³•"></a>è®¡æ•°å™¨æ»‘åŠ¨çª—å£ç®—æ³•</h2><p>è®¡æ•°å™¨æ»‘åŠ¨çª—å£æ³•å°±æ˜¯ä¸ºäº†è§£å†³ä¸Šè¿°å›ºå®šçª—å£è®¡æ•°å­˜åœ¨çš„é—®é¢˜è€Œè¯ç”Ÿï¼Œå­¦è¿‡TCPåè®®çš„åŒå­¦åº”è¯¥å¯¹æ»‘åŠ¨çª—å£ä¸é™Œç”Ÿï¼Œå…¶å®è¿˜æ˜¯ä¸å¤ªä¸€æ ·çš„ï¼Œä¸‹æ–‡æˆ‘ä»¬è¦è¯´çš„æ»‘åŠ¨çª—å£æ˜¯åŸºäºæ—¶é—´æ¥åˆ’åˆ†çª—å£çš„ã€‚è€ŒTCPçš„æ»‘åŠ¨çª—å£æŒ‡çš„æ˜¯èƒ½å¤Ÿæ¥å—çš„å­—èŠ‚æ•°ï¼Œå¹¶ä¸”å¤§å°æ˜¯å¯å˜çš„ï¼ˆæ‹¥å¡æ§åˆ¶ï¼‰</p><p>æ»‘åŠ¨çª—å£æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ</p><p>å‰é¢è¯´äº†å›ºå®šçª—å£å­˜åœ¨ä¸´ç•Œå€¼é—®é¢˜ï¼Œè¦è§£å†³è¿™ç§ä¸´ç•Œå€¼é—®é¢˜ï¼Œæ˜¾ç„¶åªç”¨ä¸€ä¸ªçª—å£æ˜¯è§£å†³ä¸äº†é—®é¢˜çš„ã€‚å‡è®¾æˆ‘ä»¬ä»ç„¶è®¾å®š1ç§’å†…å…è®¸é€šè¿‡çš„è¯·æ±‚æ˜¯200ä¸ªï¼Œä½†æ˜¯åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦æŠŠ1ç§’çš„æ—¶é—´åˆ†æˆå¤šæ ¼ï¼Œå‡è®¾åˆ†æˆ5æ ¼ï¼ˆæ ¼æ•°è¶Šå¤šï¼Œæµé‡è¿‡æ¸¡è¶Šå¹³æ»‘ï¼‰ï¼Œæ¯æ ¼çª—å£çš„æ—¶é—´å¤§å°æ˜¯200æ¯«ç§’ï¼Œæ¯è¿‡200æ¯«ç§’ï¼Œå°±å°†çª—å£å‘å‰ç§»åŠ¨ä¸€æ ¼ã€‚ä¸ºäº†ä¾¿äºç†è§£ï¼Œå¯ä»¥çœ‹ä¸‹å›¾<br><img src="http://img.souche.com/f2e/c9acdd415f157334407d233927474513.jpg" alt></p><p>å›¾ä¸­å°†çª—å£åˆ’ä¸º5ä»½ï¼Œæ¯ä¸ªå°çª—å£ä¸­çš„æ•°å­—è¡¨ç¤ºåœ¨è¿™ä¸ªçª—å£ä¸­è¯·æ±‚æ•°ï¼Œæ‰€ä»¥é€šè¿‡è§‚å¯Ÿä¸Šå›¾ï¼Œå¯çŸ¥åœ¨å½“å‰æ—¶é—´å¿«ï¼ˆ200æ¯«ç§’ï¼‰å…è®¸é€šè¿‡çš„è¯·æ±‚æ•°åº”è¯¥æ˜¯20è€Œä¸æ˜¯200ï¼ˆåªè¦è¶…è¿‡20å°±ä¼šè¢«é™æµï¼‰ï¼Œå› ä¸ºæˆ‘ä»¬æœ€ç»ˆç»Ÿè®¡è¯·æ±‚æ•°æ—¶æ˜¯éœ€è¦æŠŠå½“å‰çª—å£çš„å€¼è¿›è¡Œç´¯åŠ ï¼Œè¿›è€Œå¾—åˆ°å½“å‰è¯·æ±‚æ•°æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯éœ€è¦è¿›è¡Œé™æµã€‚</p><p>é‚£ä¹ˆæ»‘åŠ¨çª—å£é™æµæ³•æ˜¯å®Œç¾çš„å—ï¼Ÿ<br>ç»†å¿ƒè§‚å¯Ÿçš„æˆ‘ä»¬åº”è¯¥èƒ½é©¬ä¸Šå‘ç°é—®é¢˜ï¼Œ<strong>æ»‘åŠ¨çª—å£é™æµæ³•å…¶å®å°±æ˜¯è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•çš„ä¸€ä¸ªå˜ç§</strong>ã€‚æµé‡çš„è¿‡æ¸¡æ˜¯å¦å¹³æ»‘ä¾èµ–äºæˆ‘ä»¬è®¾ç½®çš„<strong>çª—å£æ ¼æ•°ä¹Ÿå°±æ˜¯ç»Ÿè®¡æ—¶é—´é—´éš”</strong>ï¼Œæ ¼æ•°è¶Šå¤šï¼Œç»Ÿè®¡è¶Šç²¾ç¡®ï¼Œä½†æ˜¯å…·ä½“è¦åˆ†å¤šå°‘æ ¼æˆ‘ä»¬ä¹Ÿè¯´ä¸ä¸Šæ¥å‘€â€¦ </p><ul><li>ä»£ç å®ç° â€“ <a href="https://github.com/WangJunnan/learn/blob/master/algorithm/src/main/java/com/walm/learn/algorithm/ratelimit/SlidingWindowRateLimit.java" target="_blank" rel="noopener">SlidingWindowRateLimit.java</a></li></ul><h2 id="æ¼æ¡¶ç®—æ³•"><a href="#æ¼æ¡¶ç®—æ³•" class="headerlink" title="æ¼æ¡¶ç®—æ³•"></a>æ¼æ¡¶ç®—æ³•</h2><p>ä¸Šé¢æ‰€ä»‹ç»çš„ä¸¤ç§ç®—æ³•éƒ½ä¸èƒ½éå¸¸å¹³æ»‘çš„è¿‡æ¸¡ï¼Œä¸‹é¢å°±æ˜¯æ¼æ¡¶ç®—æ³•ç™»åœºäº†<br>ä»€ä¹ˆæ˜¯æ¼æ¡¶ç®—æ³•ï¼Ÿ<br>æ¼æ¡¶ç®—æ³•ä»¥ä¸€ä¸ªå¸¸é‡é™åˆ¶äº†å‡ºå£æµé‡é€Ÿç‡ï¼Œå› æ­¤æ¼æ¡¶ç®—æ³•å¯ä»¥å¹³æ»‘çªå‘çš„æµé‡ã€‚å…¶ä¸­æ¼æ¡¶ä½œä¸ºæµé‡å®¹å™¨æˆ‘ä»¬å¯ä»¥çœ‹åšä¸€ä¸ªFIFOçš„é˜Ÿåˆ—ï¼Œå½“å…¥å£æµé‡é€Ÿç‡å¤§äºå‡ºå£æµé‡é€Ÿç‡æ—¶ï¼Œå› ä¸ºæµé‡å®¹å™¨æ˜¯æœ‰é™çš„ï¼Œå½“è¶…å‡ºæµé‡å®¹å™¨å¤§å°æ—¶ï¼Œè¶…å‡ºçš„æµé‡ä¼šè¢«ä¸¢å¼ƒã€‚<br>ä¸‹å›¾æ¯”è¾ƒå½¢è±¡çš„è¯´æ˜äº†æ¼æ¡¶ç®—æ³•çš„åŸç†ï¼Œå…¶ä¸­æ°´é¾™å¤´æ˜¯å…¥å£æµé‡ï¼Œæ¼æ¡¶æ˜¯æµé‡å®¹å™¨ï¼ŒåŒ€é€Ÿæµå‡ºçš„æ°´æ˜¯å‡ºå£æµé‡ã€‚<br><img src="http://img.souche.com/f2e/0186f84da43e3286f3d79e3a2f2d538e.jpg" alt></p><p>æ¼æ¡¶ç®—æ³•çš„ç‰¹ç‚¹</p><ul><li>æ¼æ¡¶å…·æœ‰å›ºå®šå®¹é‡ï¼Œå‡ºå£æµé‡é€Ÿç‡æ˜¯å›ºå®šå¸¸é‡ï¼ˆæµå‡ºè¯·æ±‚ï¼‰</li><li>å…¥å£æµé‡å¯ä»¥ä»¥ä»»æ„é€Ÿç‡æµå…¥åˆ°æ¼æ¡¶ä¸­ï¼ˆæµå…¥è¯·æ±‚ï¼‰</li><li><p>å¦‚æœå…¥å£æµé‡è¶…å‡ºäº†æ¡¶çš„å®¹é‡ï¼Œåˆ™æµå…¥æµé‡ä¼šæº¢å‡ºï¼ˆæ–°è¯·æ±‚è¢«æ‹’ç»ï¼‰</p></li><li><p>ä»£ç å®ç° â€“ <a href="https://github.com/WangJunnan/learn/blob/master/algorithm/src/main/java/com/walm/learn/algorithm/ratelimit/LeakyBucketRateLimit.java" target="_blank" rel="noopener">LeakyBucketRateLimit.java</a></p></li></ul><p><strong>ä¸è¿‡å› ä¸ºæ¼æ¡¶ç®—æ³•é™åˆ¶äº†æµå‡ºé€Ÿç‡æ˜¯ä¸€ä¸ªå›ºå®šå¸¸é‡å€¼ï¼Œæ‰€ä»¥æ¼æ¡¶ç®—æ³•ä¸æ”¯æŒå‡ºç°çªå‘æµå‡ºæµé‡ã€‚ä½†æ˜¯åœ¨å®é™…æƒ…å†µä¸‹ï¼Œæµé‡å¾€å¾€æ˜¯çªå‘çš„ã€‚</strong></p><h2 id="ä»¤ç‰Œæ¡¶ç®—æ³•"><a href="#ä»¤ç‰Œæ¡¶ç®—æ³•" class="headerlink" title="ä»¤ç‰Œæ¡¶ç®—æ³•"></a>ä»¤ç‰Œæ¡¶ç®—æ³•</h2><p>ä»¤ç‰Œæ¡¶ç®—æ³•æ˜¯æ¼æ¡¶ç®—æ³•çš„æ”¹è¿›ç‰ˆï¼Œå¯ä»¥æ”¯æŒçªå‘æµé‡ã€‚ä¸è¿‡ä¸æ¼æ¡¶ç®—æ³•ä¸åŒçš„æ˜¯ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•çš„æ¼æ¡¶ä¸­å­˜æ”¾çš„æ˜¯ä»¤ç‰Œè€Œä¸æ˜¯æµé‡ã€‚<br>é‚£ä¹ˆä»¤ç‰Œæ¡¶ç®—æ³•æ˜¯æ€ä¹ˆçªå‘æµé‡çš„å‘¢ï¼Ÿ<br>æœ€å¼€å§‹ï¼Œä»¤ç‰Œæ¡¶æ˜¯ç©ºçš„ï¼Œæˆ‘ä»¬ä»¥æ’å®šé€Ÿç‡å¾€ä»¤ç‰Œæ¡¶é‡ŒåŠ å…¥ä»¤ç‰Œï¼Œä»¤ç‰Œæ¡¶è¢«è£…æ»¡æ—¶ï¼Œå¤šä½™çš„ä»¤ç‰Œä¼šè¢«ä¸¢å¼ƒã€‚å½“è¯·æ±‚åˆ°æ¥æ—¶ï¼Œä¼šå…ˆå°è¯•ä»ä»¤ç‰Œæ¡¶è·å–ä»¤ç‰Œï¼ˆç›¸å½“äºä»ä»¤ç‰Œæ¡¶ç§»é™¤ä¸€ä¸ªä»¤ç‰Œï¼‰ï¼Œè·å–æˆåŠŸåˆ™è¯·æ±‚è¢«æ”¾è¡Œï¼Œè·å–å¤±è´¥åˆ™é˜»å¡æ´»æ‹’ç»è¯·æ±‚ã€‚</p><p><img src="http://img.souche.com/f2e/d6decf371f1085a63bcf925bfcedeeae.jpg" alt></p><p>ä»¤ç‰Œæ¡¶ç®—æ³•çš„ç‰¹ç‚¹</p><ul><li>æœ€å¤šå¯ä»¥å­˜å‘bä¸ªä»¤ç‰Œã€‚å¦‚æœä»¤ç‰Œåˆ°è¾¾æ—¶ä»¤ç‰Œæ¡¶å·²ç»æ»¡äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªä»¤ç‰Œä¼šè¢«ä¸¢å¼ƒ</li><li>è¯·æ±‚åˆ°æ¥æ—¶ï¼Œå¦‚æœä»¤ç‰Œæ¡¶ä¸­å°‘äºnä¸ªä»¤ç‰Œï¼Œé‚£ä¹ˆä¸ä¼šåˆ é™¤ä»¤ç‰Œã€‚è¯¥è¯·æ±‚ä¼šè¢«é™æµï¼ˆé˜»å¡æ´»æ‹’ç»ï¼‰</li><li>ç®—æ³•å…è®¸æœ€å¤§b(ä»¤ç‰Œæ¡¶å¤§å°)ä¸ªè¯·æ±‚çš„çªå‘</li></ul><p><strong>ä»¤ç‰Œæ¡¶ç®—æ³•é™åˆ¶çš„æ˜¯å¹³å‡æµé‡ï¼Œå› æ­¤å…¶å…è®¸çªå‘æµé‡ï¼ˆåªè¦ä»¤ç‰Œæ¡¶ä¸­æœ‰ä»¤ç‰Œï¼Œå°±ä¸ä¼šè¢«é™æµï¼‰</strong></p><ul><li>ä»£ç å®ç° â€“ <a href="https://github.com/WangJunnan/learn/blob/master/algorithm/src/main/java/com/walm/learn/algorithm/ratelimit/TokenBucketRateLimit.java" target="_blank" rel="noopener">TokenBucketRateLimit.java</a></li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è‡³æ­¤ï¼ŒåŸºæœ¬æŠŠä»¥ä¸Š4ç§é™æµç®—æ³•çš„åŸç†éƒ½è§£é‡Šæ¸…æ¥šäº†ã€‚æ¯ç§é™æµç®—æ³•éƒ½æœ‰å…¶å›ºå®šç‰¹ç‚¹ï¼ŒåŠå„è‡ªé€‚ç”¨çš„åœºæ™¯ï¼Œå…¶ä¸­è®¡æ•°å™¨ç®—æ³•æ˜¯å…¶ä¸­æœ€ç®€å•çš„ï¼Œç›¸å½“äºæ»‘åŠ¨çª—å£ç®—æ³•çš„ç®€åŒ–ç‰ˆï¼Œä»¤ç‰Œæ¡¶ç®—æ³•ç›¸æ¯”æ¼æ¡¶ç®—æ³•å¯¹èµ„æºçš„åˆ©ç”¨ç‡æ›´é«˜ï¼ˆå…è®¸çªå‘æµé‡ï¼‰</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;åœ¨å¼€å‘é«˜å¹¶å‘ç³»ç»Ÿæ—¶æœ‰ä¸‰æŠŠåˆ©å™¨ç”¨æ¥ä¿æŠ¤ç³»ç»Ÿï¼šç¼“å­˜ã€é™çº§å’Œé™æµã€‚ä»Šå¤©æˆ‘ä»¬è¦èŠçš„å°±æ˜¯é™æµï¼ˆRate Limitï¼‰ï¼Œé™æµçš„ç›®çš„å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸ºäº†ä¿æŠ¤ç³»
      
    
    </summary>
    
      <category term="ç®—æ³•" scheme="http://wangjunnan.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://wangjunnan.github.io/categories/%E7%AE%97%E6%B3%95/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="å¹¶å‘" scheme="http://wangjunnan.github.io/tags/%E5%B9%B6%E5%8F%91/"/>
    
      <category term="ç®—æ³•" scheme="http://wangjunnan.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>JAVAä¸­æ—¶é—´çš„è¡¨ç°å½¢å¼</title>
    <link href="http://wangjunnan.github.io/2019/09/26/JAVA%E4%B8%AD%E6%97%B6%E9%97%B4%E7%9A%84%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F/"/>
    <id>http://wangjunnan.github.io/2019/09/26/JAVAä¸­æ—¶é—´çš„è¡¨ç°å½¢å¼/</id>
    <published>2019-09-26T08:02:02.000Z</published>
    <updated>2019-09-29T02:54:01.225Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>å¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬åœ¨è¡¨ç¤ºæ—¶é—´çš„æ¦‚å¿µæ—¶ï¼Œå¯èƒ½å¹¶ä¸ä¼šå»ç‰¹æ„å…³æ³¨æ—¶åŒºè¿™ä¸ªæ¦‚å¿µï¼Œæ¯•ç«Ÿåœ¨å›½å†…æ—¶åŒºéƒ½æ˜¯ç»Ÿä¸€çš„ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨é»˜è®¤æ—¶åŒº åŒ—äº¬æ—¶é—´ å°±å¯ä»¥äº†ã€‚æ˜¯çš„ï¼Œåœ¨å†™è¿™ç¯‡æ–‡ç« ä¹‹å‰ï¼Œæˆ‘ä¹Ÿæ²¡æœ‰è¿‡å¤šçš„å»å…³æ³¨æ—¶åŒºçš„æ¦‚å¿µï¼Œä»¥åŠåœ¨JAVAä¸­çš„è¡¨ç°å½¢å¼ã€‚ä½†æ˜¯å› ä¸ºç›®å‰æ‰€åœ¨çš„å…¬å¸æ˜¯è·¨å¢ƒå…¬å¸ï¼Œå…¬å¸ä¸»è¦ä¸šåŠ¡åœ¨å°åº¦ï¼Œå°åº¦æ—¶é—´è·ŸåŒ—äº¬æ—¶é—´æ˜¾ç„¶æ˜¯ä¸åŒçš„ã€‚</p><h2 id="æ—¶åŒºçš„æ¦‚å¿µ"><a href="#æ—¶åŒºçš„æ¦‚å¿µ" class="headerlink" title="æ—¶åŒºçš„æ¦‚å¿µ"></a>æ—¶åŒºçš„æ¦‚å¿µ</h2><p>åœ¨è¿™ä¹‹å‰å…ˆè¯´ä¸€ä¸‹æ—¶åŒºçš„æ¦‚å¿µï¼Œä»¥åŠè§£é‡Šå‡ ä¸ªä¸“æœ‰åè¯ã€‚<br>æ—¶åŒºæ˜¯åœ°çƒä¸Šçš„åŒºåŸŸä½¿ç”¨åŒä¸€ä¸ªæ—¶é—´å®šä¹‰ï¼Œæ•´ä¸ªå…¨çƒè¢«åˆ†æˆ24ä¸ªæ—¶åŒºã€‚æ‰€ä»¥æ¯å·®ä¸€ä¸ªæ—¶åŒºï¼ŒåŒºæ—¶ç›¸å·®ä¸€ä¸ªå°æ—¶ï¼Œç›¸å·®å¤šå°‘ä¸ªæ—¶åŒºï¼Œå°±ç›¸å·®å¤šå°‘ä¸ªå°æ—¶ã€‚ä¸œè¾¹çš„æ—¶åŒºæ—¶é—´æ¯”è¥¿è¾¹çš„æ—¶åŒºæ—¶é—´æ—©ã€‚åŒ—äº¬æ—¶é—´æŒ‡çš„å°±æ˜¯ä¸œå…«åŒºçš„æ—¶é—´ã€‚</p><h3 id="UTCæ—¶é—´å’Œæœ¬åœ°æ—¶é—´"><a href="#UTCæ—¶é—´å’Œæœ¬åœ°æ—¶é—´" class="headerlink" title="UTCæ—¶é—´å’Œæœ¬åœ°æ—¶é—´"></a>UTCæ—¶é—´å’Œæœ¬åœ°æ—¶é—´</h3><p>UTCæ—¶é—´åˆç§°åè°ƒä¸–ç•Œæ—¶ï¼Œæ˜¯æœ€ä¸»è¦çš„ä¸–ç•Œæ—¶é—´æ ‡å‡†ï¼Œå…¶ä»¥åŸå­æ—¶ç§’é•¿ä¸ºåŸºç¡€ï¼Œåœ¨æ—¶åˆ»ä¸Šå°½é‡æ¥è¿‘äºæ ¼æ—å°¼æ²»æ ‡å‡†æ—¶é—´(GMT)ã€‚å¯¹äºå¤§å¤šæ•°ç”¨é€”æ¥è¯´ï¼ŒUTCæ—¶é—´è¢«è®¤ä¸ºèƒ½ä¸GMTæ—¶é—´äº’æ¢ï¼Œä½†GMTæ—¶é—´å·²ä¸å†è¢«ç§‘å­¦ç•Œæ‰€ç¡®å®šã€‚<br><strong>å¦‚æœæ—¶é—´æ˜¯ä»¥åè°ƒä¸–ç•Œæ—¶ï¼ˆUTCï¼‰è¡¨ç¤ºï¼Œåˆ™åœ¨æ—¶é—´åé¢ç›´æ¥åŠ ä¸Šä¸€ä¸ªâ€œZâ€ï¼ˆä¸åŠ ç©ºæ ¼ï¼‰ã€‚â€œZâ€æ˜¯åè°ƒä¸–ç•Œæ—¶ä¸­0æ—¶åŒºçš„æ ‡å¿—ã€‚</strong></p><ul><li>UTCåç§»é‡å’Œæœ¬åœ°æ—¶é—´<br>ä¾‹å¦‚åŒ—äº¬æ—¶é—´çš„UTCåç§»é‡æ˜¯ +8ï¼Œåˆ™å½“UTCæ—¶é—´æ˜¯ 2:00 æ—¶ï¼ŒåŒ—äº¬æ—¶é—´çš„ 10:00ã€‚æ‰€ä»¥å€ŸåŠ©äºUTCæ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå…¨çƒçš„æ—¶é—´éƒ½ç»Ÿä¸€èµ·æ¥ã€‚</li></ul><h3 id="æ—¶é—´æˆ³"><a href="#æ—¶é—´æˆ³" class="headerlink" title="æ—¶é—´æˆ³"></a>æ—¶é—´æˆ³</h3><p>æ—¶åŒºå¯ä»¥å¾ˆå¥½çš„è¡¨ç¤ºå„åœ°çš„æ—¶é—´ï¼Œä½†å„ä¸ªæ—¶åŒºçš„å­—é¢æ—¶é—´æ˜¾ç¤ºä»ç„¶è¿˜æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹å¼åœ¨æ¥è®©ä¸–ç•Œå„ä¸ªè§’è½çš„æ—¶é—´éƒ½æœ‰ä¸€æ ·çš„è¡¨ç°å½¢å¼ã€‚è¿™å¼•ç”³å‡ºäº†æ—¶é—´æˆ³ï¼Œä¹Ÿè¢«ç§°ä¸ºUnixæ—¶é—´(Unix time)ï¼Œå®šä¹‰ä¸ºä»æ ¼æ—å¨æ²»æ—¶é—´1970å¹´01æœˆ01æ—¥00æ—¶00åˆ†00ç§’èµ·è‡³ç°åœ¨çš„æ€»ç§’æ•°ã€‚</p><h2 id="Java8ä¸­çš„æ—¶é—´ç±»å‹"><a href="#Java8ä¸­çš„æ—¶é—´ç±»å‹" class="headerlink" title="Java8ä¸­çš„æ—¶é—´ç±»å‹"></a>Java8ä¸­çš„æ—¶é—´ç±»å‹</h2><p>åœ¨JAVA8ä¸­ï¼Œæä¾›äº†æ–°çš„æ—¶é—´æ—¥æœŸæ“ä½œç±»ï¼Œç›¸å¯¹äºä¹‹å‰çš„ Date ç±»ï¼Œå¯ä»¥è¯´ä½¿ç”¨èµ·æ¥æ–¹ä¾¿äº†è®¸å¤šï¼Œä¸‹é¢ä¾æ¬¡æ¥ä»‹ç»å‡ ä¸ªå…³é”®ç±»ã€‚</p><ul><li>Instant ç”¨æ¥è¡¨ç¤ºæ—¶é—´æˆ³</li><li>LocalDateTime å•çº¯è¡¨ç¤ºå­—é¢æ—¶é—´ï¼Œä¸å¸¦æ—¶åŒºä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ <code>LocalDateTime = 2019-09-25 00:00:00</code>ï¼Œè¿™ä¸ªæ—¶é—´æˆ‘ä»¬å¹¶ä¸çŸ¥é“æ˜¯åŒ—äº¬æ—¶é—´è¿˜æ˜¯ä¸œäº¬æ—¶é—´ï¼Œä»…ä»…ç”¨ä½œå­—é¢æ—¶é—´</li><li>ZonedDateTime å«æœ‰æ—¶åŒºä¿¡æ¯çš„æ—¶é—´ï¼Œç±»ä¼¼äºåŒ—äº¬æ—¶é—´ï¼ŒUTC+8</li></ul><h3 id="å®ƒä»¬å¦‚ä½•è¡¨ç¤ºæ—¶é—´"><a href="#å®ƒä»¬å¦‚ä½•è¡¨ç¤ºæ—¶é—´" class="headerlink" title="å®ƒä»¬å¦‚ä½•è¡¨ç¤ºæ—¶é—´"></a>å®ƒä»¬å¦‚ä½•è¡¨ç¤ºæ—¶é—´</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(LocalDateTime.now());</span><br><span class="line">System.out.println(Instant.now());</span><br><span class="line">System.out.println(ZonedDateTime.now());</span><br><span class="line"></span><br><span class="line">è¾“å‡º</span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">26</span>T14:<span class="number">50</span>:<span class="number">43.741</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">26</span>T06:<span class="number">50</span>:<span class="number">43.742</span>Z</span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">26</span>T14:<span class="number">50</span>:<span class="number">43.803</span>+<span class="number">08</span>:<span class="number">00</span>[Asia/Shanghai]</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<br><code>LocalDateTime</code> ä¼šæ ¹æ®UTCæ—¶é—´è·å–åˆ°æœ¬åœ°æ—¶é—´æ˜¾ç¤ºï¼Œä½†æ˜¯ä¼šæŠŠæ—¶åŒºä¿¡æ¯ä¸¢å¼ƒ<br><code>Instant</code> åˆ™ç›´æ¥è¡¨ç¤ºçš„UTCä¸–ç•Œæ ‡å‡†æ—¶é—´<br><code>ZonedDateTime</code> ä¼šæ ¹æ®UTCæ—¶é—´è·å–åˆ°æœ¬åœ°æ—¶é—´æ˜¾ç¤ºï¼ŒåŒæ—¶ä¹Ÿä¼šæ˜¾ç¤ºå½“å‰çš„æ—¶åŒºä¿¡æ¯</p><p>å…¶å®ZonedDateTime æ˜¯ç”± Instant åŠ ä¸Šæ—¶åŒºä¿¡æ¯ç»“åˆè€Œæ¥ï¼Œé€šè¿‡ZonedDateTimeå¯ä»¥ç›´æ¥è·å–åˆ°Instantæ—¶é—´æˆ³ä¿¡æ¯</p><h3 id="å¦‚ä½•è½¬æ¢"><a href="#å¦‚ä½•è½¬æ¢" class="headerlink" title="å¦‚ä½•è½¬æ¢"></a>å¦‚ä½•è½¬æ¢</h3><p>è½¬æ¢çš„æ ¸å¿ƒå…¶å®éƒ½æ˜¯å¾€æ—¶é—´æˆ³ï¼ˆä¸–ç•Œæ ‡å‡†æ—¶é—´ï¼‰é æ‹¢ï¼Œè¯•æƒ³æ˜¯ä¸æ˜¯è¿™æ ·ï¼Ÿåªæœ‰è½¬æˆäº†æ ‡å‡†æ—¶é—´æ‰èƒ½è½¬æˆå…¶ä»–æ—¶åŒºçš„æ—¶é—´</p><ul><li><code>ZonedDateTime</code> <-> <code>Instant</code></-></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// zonedDateTime -&gt; instant</span></span><br><span class="line">ZonedDateTime zonedDateTime = ZonedDateTime.now();</span><br><span class="line">Instant instant = zonedDateTime.toInstant();</span><br><span class="line"></span><br><span class="line"><span class="comment">// instant -&gt; zonedDateTime è¦æŒ‡å®šæ—¶åŒºä¿¡æ¯</span></span><br><span class="line">ZoneId DEFAULT_ZONE_ID = ZoneId.of(<span class="string">"Asia/Shanghai"</span>);</span><br><span class="line">zonedDateTime = instant.atZone(DEFAULT_ZONE_ID);</span><br></pre></td></tr></table></figure><ul><li><code>LocalDateTime</code> <-> <code>Instant</code></-></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LocalDateTime -&gt; Instant</span></span><br><span class="line">LocalDateTime localDateTime = LocalDateTime.now();</span><br><span class="line">Instant instant = localDateTime.toInstant(ZoneOffset.of(<span class="string">"+08:00"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Instant -&gt; ZonedDateTime -&gt; LocalDateTime</span></span><br><span class="line"><span class="comment">// Instant éœ€è¦å…ˆè½¬æ¢æˆ ZonedDateTime å†è½¬æ¢æˆæœ¬åœ°æ—¶é—´</span></span><br><span class="line">ZonedDateTime zonedDateTime = instant.atZone(ZoneId.of(<span class="string">"Asia/Shanghai"</span>));</span><br><span class="line">localDateTime = zonedDateTime.toLocalDateTime();</span><br></pre></td></tr></table></figure><ul><li><code>LocalDateTime</code> <-> <code>ZonedDateTime</code></-></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LocalDateTime -&gt; ZonedDateTime éœ€è¦æŒ‡å®šæœ¬åœ°æ‰€åœ¨æ—¶åŒº</span></span><br><span class="line">LocalDateTime localDateTime = LocalDateTime.now();</span><br><span class="line">ZonedDateTime zonedDateTime = localDateTime.atZone(ZoneId.of(<span class="string">"Asia/Shanghai"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›´æ¥è½¬æ¢æˆæœ¬åœ°æ—¶é—´</span></span><br><span class="line">localDateTime = zonedDateTime.toLocalDateTime();</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è½¬æ¢è¿‡ç¨‹ä¸­ï¼Œä¼šé¢‘ç¹çš„æ‰‹åŠ¨æŒ‡å®šæ—¶åŒºï¼Œä¸»è¦åŸå› æ˜¯<code>LocalDateTime</code>å¹¶ä¸å¸¦æœ‰æ—¶åŒºä¿¡æ¯ï¼Œå¦‚æœæˆ‘ä»¬è¦è½¬æ¢æˆæ ‡å‡†æ—¶é—´ï¼Œå°±éœ€è¦æ‰‹åŠ¨æŒ‡å®šæ—¶åŒºã€‚<strong>æ‰€ä»¥ä¸ºäº†é¿å…è½¬æ¢è¿‡ç¨‹ä¸­çš„é”™è¯¯ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨æ—¶é—´æˆ³æ¥æ¥ä¼ è¾“æ—¶é—´ã€‚</strong></p><h4 id="ä¸å…¶ä»–apiçš„è½¬æ¢"><a href="#ä¸å…¶ä»–apiçš„è½¬æ¢" class="headerlink" title="ä¸å…¶ä»–apiçš„è½¬æ¢"></a>ä¸å…¶ä»–apiçš„è½¬æ¢</h4><ul><li>Timestamp <-> LocalDateTime</-></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// Timestamp -&gt; LocalDateTime</span><br><span class="line">Timestamp timestamp = Timestamp.from(Instant.now());</span><br><span class="line">LocalDateTime localDateTime = timestamp.toLocalDateTime();</span><br><span class="line"></span><br><span class="line">// LocalDateTime -&gt; Timestamp æœ‰ä¸¤ç§æ–¹å¼</span><br><span class="line">// 1. ç›´æ¥æŒ‰æœ¬åœ°é»˜è®¤æ—¶åŒºè½¬æ—¶åŒº</span><br><span class="line">timestamp = Timestamp.valueOf(localDateTime);</span><br><span class="line">// 2. æŒ‡å®šæ—¶åŒºè½¬</span><br><span class="line">timestamp = Timestamp.from(localDateTime.toInstant(ZoneOffset.of(&quot;+08:00&quot;)));</span><br></pre></td></tr></table></figure><ul><li>Date <-> LocalDateTime</-></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Date -&gt; LocalDateTime</span></span><br><span class="line">Date date = <span class="keyword">new</span> Date();</span><br><span class="line">LocalDateTime localDateTime = date.toInstant().atZone(ZoneId.of(<span class="string">"Asia/Shanghai"</span>)).toLocalDateTime();</span><br><span class="line"></span><br><span class="line"><span class="comment">// LocalDateTime -&gt; Date</span></span><br><span class="line">date = Date.from(localDateTime.toInstant(ZoneOffset.of(<span class="string">"+08:00"</span>)));</span><br></pre></td></tr></table></figure><p>æ›´å¤šä¾‹å­<a href="https://github.com/WangJunnan/walm-common/blob/master/src/main/java/com/walm/common/util/DateTimeUtils.java" target="_blank" rel="noopener">DateTimeUtils.java</a></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ€åè¿˜æ˜¯å»ºè®®æ“ä½œæ—¶é—´æ—¶ä½¿ç”¨æ—¶é—´æˆ³ï¼Œè¿™æ ·å­æ²¡æœ‰æ—¶åŒºçš„æ¦‚å¿µï¼Œä¹Ÿå°±ä¸ä¼šäº§ç”Ÿæ­§ä¹‰ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;å¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬åœ¨è¡¨ç¤ºæ—¶é—´çš„æ¦‚å¿µæ—¶ï¼Œå¯èƒ½å¹¶ä¸ä¼šå»ç‰¹æ„å…³æ³¨æ—¶åŒºè¿™ä¸ªæ¦‚å¿µï¼Œæ¯•ç«Ÿåœ¨å›½å†…æ—¶åŒºéƒ½æ˜¯ç»Ÿä¸€çš„ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨é»˜è®¤æ—¶åŒº åŒ—äº¬æ—¶é—´ å°±å¯ä»¥äº†ã€‚æ˜¯
      
    
    </summary>
    
      <category term="javaåŸºç¡€" scheme="http://wangjunnan.github.io/categories/java%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="javaåŸºç¡€" scheme="http://wangjunnan.github.io/tags/java%E5%9F%BA%E7%A1%80/"/>
    
  </entry>
  
  <entry>
    <title>Springçš„@Configuration @Beanæ³¨è§£</title>
    <link href="http://wangjunnan.github.io/2019/09/03/Spring%E7%9A%84-Configuration-Bean%E6%B3%A8%E8%A7%A3/"/>
    <id>http://wangjunnan.github.io/2019/09/03/Springçš„-Configuration-Beanæ³¨è§£/</id>
    <published>2019-09-03T08:47:31.000Z</published>
    <updated>2019-09-27T05:52:47.717Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>ä¹‹å‰Spring ä¸€ç›´ç”¨çš„xmlé…ç½®æ–‡ä»¶æ¯”è¾ƒå¤šï¼Œç°åœ¨å‘ç°æ–°å…¬å¸ç”¨çš„æ³¨è§£æ¯”è¾ƒå¤šã€‚ä¹Ÿå°±æ˜¯é€šè¿‡å®šä¹‰ä¸€ä¸ªé…ç½®ç±»(ä»¥@Configurationæ³¨è§£çš„ç±»)å†…éƒ¨åœ¨æ–¹æ³•ä¸Šæ³¨è§£ <a href="#"><a href="#">@Bean</a></a> æ³¨è§£æ¥å®ŒæˆBeançš„ä¾èµ–æ³¨å…¥Springå®¹å™¨ã€‚ç”¨æ³¨è§£æ¥é…ç½®çš„è¯ï¼Œå…¶å®å°±æ˜¯å‡å°‘äº†é…ç½®æ–‡ä»¶çš„å·¥ä½œï¼Œä½†æ€»ä½“æ¥è¯´ä»£ç å¯è¯»æ€§å…¶å®æ˜¯ä¼šä¸‹é™çš„ã€‚ä¸è¿‡ä¹Ÿçœå»äº†ä¸€å¤§å †çš„xmlé…ç½®æ–‡ä»¶</p><h2 id="ç›´æ¥çœ‹æºç "><a href="#ç›´æ¥çœ‹æºç " class="headerlink" title="ç›´æ¥çœ‹æºç "></a>ç›´æ¥çœ‹æºç </h2><p>ä¸‹é¢å°±ä»æºç å±‚é¢æ¥çœ‹çœ‹  é€šè¿‡æ³¨è§£é…ç½®æœ‰ä»€ä¹ˆä¸åŒ</p><p>ä¹‹å‰æœ‰åˆ†æè¿‡Springå¯¹Beançš„è§£æï¼Œ<strong>æ˜¯é€šè¿‡æŠŠæˆ‘ä»¬é…ç½®çš„Beanä¿¡æ¯æŠ½è±¡æˆäº†ä¸€ä¸ªBeanDefiniionå¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡æŒæœ‰äº†æˆ‘ä»¬é…ç½®çš„Beançš„å…ƒæ•°æ®</strong></p><p>é‚£ä¹ˆå…¶å® <a href="#"><a href="#">@Bean</a></a> çš„æ³¨è§£çš„åŸç†ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œä¹Ÿæ˜¯é€šè¿‡å°†æˆ‘ä»¬é…ç½®çš„Beanä¿¡æ¯æŠ½è±¡æˆä¸€ä¸ªBeanDefiniionå¯¹è±¡</p><p>è¿™é‡Œæˆ‘ä»¬åˆ†ä¸¤ç§æƒ…å†µè®¨è®ºï¼Œä¸€ç§æ˜¯ Spring é€šè¿‡ xmlæ–‡ä»¶é…ç½®å®ç°æ³¨è§£é…ç½®ï¼Œä¸€ç§å°±æ˜¯æˆ‘ä»¬ç°åœ¨éå¸¸æµè¡Œçš„ SpringBootå®ç°çš„æ³¨è§£é…ç½®ã€‚å…¶å®ä¸¤è€…å®ç°åŸç†ä¸€è‡´ï¼Œåªæ˜¯é…ç½®å…¥å£ç•¥æœ‰ä¸åŒã€‚</p><p>å…ˆçœ‹ æ™®é€š Spring åº”ç”¨çš„é…ç½®:</p><p>å¦‚æœæˆ‘ä»¬è¦åœ¨  æ™®é€š Spring åº”ç”¨ä¸­å®ç°æ³¨è§£é…ç½®ã€‚é‚£ä¹ˆæˆ‘ä»¬éœ€è¦åœ¨Springçš„é…ç½®æ–‡ä»¶ä¸­é…ç½®ä»¥ä¸‹å‡ ä¸ªé…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;context:annotation-config&gt;</span><br><span class="line"></span><br><span class="line">&lt;context:component-scan&gt;</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªé…ç½®çš„æ„æ€æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬ç›´æ¥çœ‹Springæ˜¯å¦‚ä½•è§£æè¿™ä¸¤ä¸ªæ ‡ç­¾çš„å§ï¼Œé€šè¿‡åœ¨<code>META-INF/spring.handlers</code>ç›®å½•ä¸‹æ ¹æ®<code>spring.handlers</code>æ–‡ä»¶å¯ä»¥æ‰¾åˆ° Context æ ‡ç­¾  è§£æå…¥å£ç±» <code>ContextNamespaceHandler</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">registerBeanDefinitionParser(<span class="string">"property-placeholder"</span>, <span class="keyword">new</span> PropertyPlaceholderBeanDefinitionParser());</span><br><span class="line"></span><br><span class="line">registerBeanDefinitionParser(<span class="string">"property-override"</span>, <span class="keyword">new</span> PropertyOverrideBeanDefinitionParser());</span><br><span class="line"></span><br><span class="line">registerBeanDefinitionParser(<span class="string">"annotation-config"</span>, <span class="keyword">new</span> AnnotationConfigBeanDefinitionParser());</span><br><span class="line"></span><br><span class="line">registerBeanDefinitionParser(<span class="string">"component-scan"</span>, <span class="keyword">new</span> ComponentScanBeanDefinitionParser());</span><br><span class="line"></span><br><span class="line">registerBeanDefinitionParser(<span class="string">"load-time-weaver"</span>, <span class="keyword">new</span> LoadTimeWeaverBeanDefinitionParser());</span><br><span class="line"></span><br><span class="line">registerBeanDefinitionParser(<span class="string">"spring-configured"</span>, <span class="keyword">new</span> SpringConfiguredBeanDefinitionParser());</span><br><span class="line"></span><br><span class="line">registerBeanDefinitionParser(<span class="string">"mbean-export"</span>, <span class="keyword">new</span> MBeanExportBeanDefinitionParser());</span><br><span class="line"></span><br><span class="line">registerBeanDefinitionParser(<span class="string">"mbean-server"</span>, <span class="keyword">new</span> MBeanServerBeanDefinitionParser());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸Šé¢çš„è§£ææºç ï¼Œå¯ä»¥çŸ¥é“annotation-configç”±AnnotationConfigBeanDefinitionParserè§£æã€‚component-scanç”±ComponentScanBeanDefinitionParserè§£æã€‚è¿™é‡Œå°±æ˜¯Spring XML æ³¨è§£é…ç½®çš„å…¥å£ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ä¾æ¬¡åˆ†æè¿™ä¸¤ä¸ªè§£æç±»å¹²äº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ</p><ul><li>ComponentScanBeanDefinitionParser</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">String basePackage = element.getAttribute(BASE_PACKAGE_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">basePackage = parserContext.getReaderContext().getEnvironment().resolvePlaceholders(basePackage);</span><br><span class="line"></span><br><span class="line">String[] basePackages = StringUtils.tokenizeToStringArray(basePackage,</span><br><span class="line"></span><br><span class="line">ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Actually scan for bean definitions and register them.</span></span><br><span class="line"></span><br><span class="line">ClassPathBeanDefinitionScanner scanner = configureScanner(parserContext, element);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿™é‡Œæ‰«æäº†æˆ‘ä»¬é…ç½®çš„ base-package åŒ…ä¸‹å…¨éƒ¨ beanDefinitionsï¼Œå¹¶æŠ½è±¡æˆäº† BeanDefinitionHolderç±»</span></span><br><span class="line"></span><br><span class="line">Set&lt;BeanDefinitionHolder&gt; beanDefinitions = scanner.doScan(basePackages);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°†æŠ½è±¡çš„ beanDefinitions å…¨éƒ¨æ³¨å†Œè¿› Springå®¹å™¨ä¸­ï¼Œæ³¨ è¿™é‡ŒåŒ…å«äº†è¢«@Configurationæ³¨è§£çš„ç±»</span></span><br><span class="line"></span><br><span class="line">registerComponents(parserContext.getReaderContext(), beanDefinitions, element);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>  <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>AnnotationConfigBeanDefinitionParser</li></ul><p>ä¸»è¦é€»è¾‘åœ¨ AnnotationConfigUtils å·¥å…·ç±»çš„ registerAnnotationConfigProcessorsæ–¹æ³•ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">Object source = parserContext.extractSource(element);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ä¸€äº› BeanFactoryPostProcessor è¿›Springå®¹å™¨ï¼Œä¼šåœ¨getBeanä¹‹å‰å…¨éƒ¨æ‰§è¡Œã€‚</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸€èˆ¬ç”¨æ¥åœ¨å®¹å™¨å®ä¾‹åŒ–Beanå‰ï¼Œå¯¹BeanDefinitionåšä¿®æ”¹ï¼Œæˆ–æ·»åŠ æ–°çš„BeanDefinitionç­‰å‰ç½®ä¿®æ”¹</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸»è¦é€»è¾‘å°±åœ¨è¿™é‡Œ</span></span><br><span class="line"></span><br><span class="line">Set&lt;BeanDefinitionHolder&gt; processorDefinitions =</span><br><span class="line"></span><br><span class="line">AnnotationConfigUtils.registerAnnotationConfigProcessors(parserContext.getRegistry(), source);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Register component for the surrounding &lt;context:annotation-config&gt; element.</span></span><br><span class="line"></span><br><span class="line">CompositeComponentDefinition compDefinition = <span class="keyword">new</span> CompositeComponentDefinition(element.getTagName(), source);</span><br><span class="line"></span><br><span class="line">parserContext.pushContainingComponent(compDefinition);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Nest the concrete beans in the surrounding component.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (BeanDefinitionHolder processorDefinition : processorDefinitions) &#123;</span><br><span class="line"></span><br><span class="line">parserContext.registerComponent(<span class="keyword">new</span> BeanComponentDefinition(processorDefinition));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Finally register the composite component.</span></span><br><span class="line"></span><br><span class="line">parserContext.popAndRegisterContainingComponent();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>  <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AnnotationConfigUtils.class</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ æ”¯æŒ annotation-config é…ç½®çš„ä¸€äº›BeanFactoryPostProcessor å®ç°ç±»</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;BeanDefinitionHolder&gt; <span class="title">registerAnnotationConfigProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">BeanDefinitionRegistry registry, @Nullable Object source)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">DefaultListableBeanFactory beanFactory = unwrapDefaultListableBeanFactory(registry);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (beanFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(beanFactory.getDependencyComparator() <span class="keyword">instanceof</span> AnnotationAwareOrderComparator)) &#123;</span><br><span class="line"></span><br><span class="line">beanFactory.setDependencyComparator(AnnotationAwareOrderComparator.INSTANCE);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(beanFactory.getAutowireCandidateResolver() <span class="keyword">instanceof</span> ContextAnnotationAutowireCandidateResolver)) &#123;</span><br><span class="line"></span><br><span class="line">beanFactory.setAutowireCandidateResolver(<span class="keyword">new</span> ContextAnnotationAutowireCandidateResolver());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Set&lt;BeanDefinitionHolder&gt; beanDefs = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// @Configuration æ³¨è§£è§£æ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line"></span><br><span class="line">RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(ConfigurationClassPostProcessor.class);</span><br><span class="line"></span><br><span class="line">def.setSource(source);</span><br><span class="line"></span><br><span class="line">beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// @Autowired æ³¨è§£è§£æ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!registry.containsBeanDefinition(AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line"></span><br><span class="line">RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(AutowiredAnnotationBeanPostProcessor.class);</span><br><span class="line"></span><br><span class="line">def.setSource(source);</span><br><span class="line"></span><br><span class="line">beanDefs.add(registerPostProcessor(registry, def, AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @Required æ³¨è§£è§£æ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!registry.containsBeanDefinition(REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line"></span><br><span class="line">RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(RequiredAnnotationBeanPostProcessor.class);</span><br><span class="line"></span><br><span class="line">def.setSource(source);</span><br><span class="line"></span><br><span class="line">beanDefs.add(registerPostProcessor(registry, def, REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check for JSR-250 support, and if present add the CommonAnnotationBeanPostProcessor.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯¹ JSR-250åšæ”¯æŒ è§£ææ³¨è§£ @Resource @PostConstruct @PreDestroyÂ </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (jsr250Present &amp;&amp; !registry.containsBeanDefinition(COMMON_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line"></span><br><span class="line">RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(CommonAnnotationBeanPostProcessor.class);</span><br><span class="line"></span><br><span class="line">def.setSource(source);</span><br><span class="line"></span><br><span class="line">beanDefs.add(registerPostProcessor(registry, def, COMMON_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check for JPA support, and if present add the PersistenceAnnotationBeanPostProcessor.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (jpaPresent &amp;&amp; !registry.containsBeanDefinition(PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line"></span><br><span class="line">RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition();</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">def.setBeanClass(ClassUtils.forName(PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME,</span><br><span class="line"></span><br><span class="line">AnnotationConfigUtils.class.getClassLoader()));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line"></span><br><span class="line"><span class="string">"Cannot load optional framework class: "</span> + PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME, ex);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def.setSource(source);</span><br><span class="line"></span><br><span class="line">beanDefs.add(registerPostProcessor(registry, def, PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!registry.containsBeanDefinition(EVENT_LISTENER_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line"></span><br><span class="line">RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(EventListenerMethodProcessor.class);</span><br><span class="line"></span><br><span class="line">def.setSource(source);</span><br><span class="line"></span><br><span class="line">beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_PROCESSOR_BEAN_NAME));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!registry.containsBeanDefinition(EVENT_LISTENER_FACTORY_BEAN_NAME)) &#123;</span><br><span class="line"></span><br><span class="line">RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(DefaultEventListenerFactory.class);</span><br><span class="line"></span><br><span class="line">def.setSource(source);</span><br><span class="line"></span><br><span class="line">beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_FACTORY_BEAN_NAME));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> beanDefs;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° annotation-config é…ç½®å…¶å®å°±æ˜¯æ·»åŠ äº†å‡ ä¸ª BeanFactoryPostProcessor å®ç°ç±»ï¼Œä»¥æ­¤æ¥å®ç° Autowired Configuration @Resource @PostConstruct @PreDestroy ç­‰æ³¨è§£çš„å®ç°ã€‚å…¶ä»–çš„æ³¨è§£æš‚ä¸”ä¸çœ‹ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä»Šå¤©çš„é‡ç‚¹  Configuration æ³¨è§£æ˜¯å¦‚ä½•è§£æï¼Œ@Configurationæ˜¯é€šè¿‡ BeanFactoryPostProcessor çš„å®ç°ç±» ConfigurationClassPostProcessor ç±»åœ¨Springå¯åŠ¨çš„æ—¶å€™æ‰§è¡Œçš„ï¼ˆå…·ä½“BeanFactoryPostProcessorçš„æ‰§è¡Œæ—¶æœºå¯ä»¥çœ‹æˆ‘å¦ä¸€ç¯‡åšæ–‡[<a href> <a href="https://www.yuque.com/wangjunnan/pnhnfo/bx15ai" target="_blank" rel="noopener">é“¾æ¥](https://www.yuque.com/wangjunnan/pnhnfo/bx15ai)</a></a>ï¼‰</p><ul><li>ConfigurationClassPostProcessor</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> registryId = System.identityHashCode(registry);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯å¦å·²ç»æ‰§è¡Œè¿‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.registriesPostProcessed.contains(registryId)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line"></span><br><span class="line"><span class="string">"postProcessBeanDefinitionRegistry already called on this post-processor against "</span> + registry);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.factoriesPostProcessed.contains(registryId)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line"></span><br><span class="line"><span class="string">"postProcessBeanFactory already called on this post-processor against "</span> + registry);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.registriesPostProcessed.add(registryId);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­£å¼æ‰§è¡Œé€»è¾‘</span></span><br><span class="line"></span><br><span class="line">processConfigBeanDefinitions(registry);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processConfigBeanDefinitions</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">List&lt;BeanDefinitionHolder&gt; configCandidates = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">String[] candidateNames = registry.getBeanDefinitionNames();</span><br><span class="line"></span><br><span class="line"><span class="comment">// éå†æ‰€æœ‰ BeanDefinition name</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (String beanName : candidateNames) &#123;</span><br><span class="line"></span><br><span class="line">BeanDefinition beanDef = registry.getBeanDefinition(beanName);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯å¦å·²ç»å¤„ç†è¿‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ConfigurationClassUtils.isFullConfigurationClass(beanDef) ||</span><br><span class="line"></span><br><span class="line">ConfigurationClassUtils.isLiteConfigurationClass(beanDef)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line"></span><br><span class="line">logger.debug(<span class="string">"Bean definition has already been processed as a configuration class: "</span> + beanDef);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// æ¡ä»¶ç­›é€‰</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, <span class="keyword">this</span>.metadataReaderFactory)) &#123;</span><br><span class="line"></span><br><span class="line">configCandidates.add(<span class="keyword">new</span> BeanDefinitionHolder(beanDef, beanName));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ “é€‰å®Œä¸ºç©º  ç›´æ¥è¿”å›</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (configCandidates.isEmpty()) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ® @Order æ³¨è§£æ’åº</span></span><br><span class="line"></span><br><span class="line">configCandidates.sort((bd1, bd2) -&gt; &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> i1 = ConfigurationClassUtils.getOrder(bd1.getBeanDefinition());</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> i2 = ConfigurationClassUtils.getOrder(bd2.getBeanDefinition());</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> Integer.compare(i1, i2);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Detect any custom bean name generation strategy supplied through the enclosing application context</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å– BeanName ç”Ÿæˆç­–ç•¥</span></span><br><span class="line"></span><br><span class="line">SingletonBeanRegistry sbr = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (registry <span class="keyword">instanceof</span> SingletonBeanRegistry) &#123;</span><br><span class="line"></span><br><span class="line">sbr = (SingletonBeanRegistry) registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">this</span>.localBeanNameGeneratorSet) &#123;</span><br><span class="line"></span><br><span class="line">BeanNameGenerator generator = (BeanNameGenerator) sbr.getSingleton(CONFIGURATION_BEAN_NAME_GENERATOR);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (generator != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.componentScanBeanNameGenerator = generator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.importBeanNameGenerator = generator;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.environment == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.environment = <span class="keyword">new</span> StandardEnvironment();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parse each @Configuration class</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ @Configuration æ³¨è§£</span></span><br><span class="line"></span><br><span class="line">ConfigurationClassParser parser = <span class="keyword">new</span> ConfigurationClassParser(</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.metadataReaderFactory, <span class="keyword">this</span>.problemReporter, <span class="keyword">this</span>.environment,</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.resourceLoader, <span class="keyword">this</span>.componentScanBeanNameGenerator, registry);</span><br><span class="line"></span><br><span class="line">Set&lt;BeanDefinitionHolder&gt; candidates = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(configCandidates);</span><br><span class="line"></span><br><span class="line">Set&lt;ConfigurationClass&gt; alreadyParsed = <span class="keyword">new</span> HashSet&lt;&gt;(configCandidates.size());</span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line"></span><br><span class="line">parser.parse(candidates);</span><br><span class="line"></span><br><span class="line">parser.validate();</span><br><span class="line"></span><br><span class="line">Set&lt;ConfigurationClass&gt; configClasses = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(parser.getConfigurationClasses());</span><br><span class="line"></span><br><span class="line">configClasses.removeAll(alreadyParsed);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Read the model and create bean definitions based on its content</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¯»å–å¹¶è§£ææ³¨å†Œ BeanDefinition</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.reader == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.reader = <span class="keyword">new</span> ConfigurationClassBeanDefinitionReader(</span><br><span class="line"></span><br><span class="line">registry, <span class="keyword">this</span>.sourceExtractor, <span class="keyword">this</span>.resourceLoader, <span class="keyword">this</span>.environment,</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.importBeanNameGenerator, parser.getImportRegistry());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.reader.loadBeanDefinitions(configClasses);</span><br><span class="line"></span><br><span class="line">alreadyParsed.addAll(configClasses);</span><br><span class="line"></span><br><span class="line">candidates.clear();</span><br><span class="line"></span><br><span class="line"> <span class="comment">// å¤„ç†æ–°åŠ å…¥çš„</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (registry.getBeanDefinitionCount() &gt; candidateNames.length) &#123;</span><br><span class="line"></span><br><span class="line">String[] newCandidateNames = registry.getBeanDefinitionNames();</span><br><span class="line"></span><br><span class="line">Set&lt;String&gt; oldCandidateNames = <span class="keyword">new</span> HashSet&lt;&gt;(Arrays.asList(candidateNames));</span><br><span class="line"></span><br><span class="line">Set&lt;String&gt; alreadyParsedClasses = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (ConfigurationClass configurationClass : alreadyParsed) &#123;</span><br><span class="line"></span><br><span class="line">alreadyParsedClasses.add(configurationClass.getMetadata().getClassName());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (String candidateName : newCandidateNames) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!oldCandidateNames.contains(candidateName)) &#123;</span><br><span class="line"></span><br><span class="line">BeanDefinition bd = registry.getBeanDefinition(candidateName);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, <span class="keyword">this</span>.metadataReaderFactory) &amp;&amp;</span><br><span class="line"></span><br><span class="line">!alreadyParsedClasses.contains(bd.getBeanClassName())) &#123;</span><br><span class="line"></span><br><span class="line">candidates.add(<span class="keyword">new</span> BeanDefinitionHolder(bd, candidateName));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">candidateNames = newCandidateNames;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (!candidates.isEmpty());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sbr != <span class="keyword">null</span> &amp;&amp; !sbr.containsSingleton(IMPORT_REGISTRY_BEAN_NAME)) &#123;</span><br><span class="line"></span><br><span class="line">sbr.registerSingleton(IMPORT_REGISTRY_BEAN_NAME, parser.getImportRegistry());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.metadataReaderFactory <span class="keyword">instanceof</span> CachingMetadataReaderFactory) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Clear cache in externally provided MetadataReaderFactory; this is a no-op</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// for a shared cache since it'll be cleared by the ApplicationContext.</span></span><br><span class="line"></span><br><span class="line">((CachingMetadataReaderFactory) <span class="keyword">this</span>.metadataReaderFactory).clearCache();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“çš„æ‰§è¡Œé€»è¾‘åœ¨ConfigurationClassParser ç±»çš„ parse æ–¹æ³•ä¸­</p><ul><li>ConfigurationClassParser</li></ul><p>æ ¸å¿ƒè§£ææ–¹æ³•æ˜¯ doProcessConfigurationClassæ–¹æ³•ï¼Œä¸‹é¢ç›´æ¥çœ‹è¿™ä¸ªæ–¹æ³•çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> SourceClass <span class="title">doProcessConfigurationClass</span><span class="params">(ConfigurationClass configClass, SourceClass sourceClass)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Recursively process any member (nested) classes first</span></span><br><span class="line"></span><br><span class="line">processMemberClasses(configClass, sourceClass);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Process any @PropertySource annotations</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ @PropertySourceÂ </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line"></span><br><span class="line">sourceClass.getMetadata(), PropertySources.class,</span><br><span class="line"></span><br><span class="line">org.springframework.context.annotation.PropertySource.class)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.environment <span class="keyword">instanceof</span> ConfigurableEnvironment) &#123;</span><br><span class="line"></span><br><span class="line">processPropertySource(propertySource);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">logger.warn(<span class="string">"Ignoring @PropertySource annotation on ["</span> + sourceClass.getMetadata().getClassName() +</span><br><span class="line"></span><br><span class="line"><span class="string">"]. Reason: Environment must implement ConfigurableEnvironment"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Process any @ComponentScan annotations</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ @ComponentScanÂ </span></span><br><span class="line"></span><br><span class="line">Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line"></span><br><span class="line">sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!componentScans.isEmpty() &amp;&amp;</span><br><span class="line"></span><br><span class="line">!<span class="keyword">this</span>.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (AnnotationAttributes componentScan : componentScans) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span></span><br><span class="line"></span><br><span class="line">Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (BeanDefinitionHolder holder : scannedBeanDefinitions) &#123;</span><br><span class="line"></span><br><span class="line">BeanDefinition bdCand = holder.getBeanDefinition().getOriginatingBeanDefinition();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (bdCand == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">bdCand = holder.getBeanDefinition();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, <span class="keyword">this</span>.metadataReaderFactory)) &#123;</span><br><span class="line"></span><br><span class="line">parse(bdCand.getBeanClassName(), holder.getBeanName());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Process any @Import annotations</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ @Import</span></span><br><span class="line"></span><br><span class="line">processImports(configClass, sourceClass, getImports(sourceClass), <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Process any @ImportResource annotations</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ @ImportResource</span></span><br><span class="line"></span><br><span class="line">AnnotationAttributes importResource =</span><br><span class="line"></span><br><span class="line">AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (importResource != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">String[] resources = importResource.getStringArray(<span class="string">"locations"</span>);</span><br><span class="line"></span><br><span class="line">Class&lt;? extends BeanDefinitionReader&gt; readerClass = importResource.getClass(<span class="string">"reader"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (String resource : resources) &#123;</span><br><span class="line"></span><br><span class="line">String resolvedResource = <span class="keyword">this</span>.environment.resolveRequiredPlaceholders(resource);</span><br><span class="line"></span><br><span class="line">configClass.addImportedResource(resolvedResource, readerClass);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Process individual @Bean methods</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ @Bean</span></span><br><span class="line"></span><br><span class="line">Set&lt;MethodMetadata&gt; beanMethods = retrieveBeanMethodMetadata(sourceClass);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (MethodMetadata methodMetadata : beanMethods) &#123;</span><br><span class="line"></span><br><span class="line">configClass.addBeanMethod(<span class="keyword">new</span> BeanMethod(methodMetadata, configClass));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Process default methods on interfaces</span></span><br><span class="line"></span><br><span class="line">processInterfaces(configClass, sourceClass);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Process superclass, if any</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sourceClass.getMetadata().hasSuperClass()) &#123;</span><br><span class="line"></span><br><span class="line">String superclass = sourceClass.getMetadata().getSuperClassName();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (superclass != <span class="keyword">null</span> &amp;&amp; !superclass.startsWith(<span class="string">"java"</span>) &amp;&amp;</span><br><span class="line"></span><br><span class="line">!<span class="keyword">this</span>.knownSuperclasses.containsKey(superclass)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.knownSuperclasses.put(superclass, configClass);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Superclass found, return its annotation metadata and recurse</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> sourceClass.getSuperClass();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// No superclass -&gt; processing is complete</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>  <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ä»£ç ä¾æ¬¡è§£æäº† @PropertySourceï¼Œ@ComponentScan <a href="#"><a href="#">@Bean</a></a> <a href="#"><a href="#">@Import</a></a> ç­‰æ³¨è§£ã€‚è¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ <a href="#"><a href="#">@Bean</a></a> çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// è·å– @bean æ³¨è§£ä¿®é¥°çš„  æ–¹æ³•å…ƒæ•°æ®ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">Set&lt;MethodMetadata&gt; beanMethods = retrieveBeanMethodMetadata(sourceClass);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (MethodMetadata methodMetadata : beanMethods) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°è£…æˆ BeanMethodÂ </span></span><br><span class="line"></span><br><span class="line">configClass.addBeanMethod(<span class="keyword">new</span> BeanMethod(methodMetadata, configClass));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬å›åˆ° ConfigurationClassPostProcessor ï¼Œè§£æå®Œ å…ƒæ•°æ®ä¹‹åï¼Œå°±æ˜¯åŠ è½½æ³¨å†Œ BeanDefinitionäº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">this</span>.reader.loadBeanDefinitions(configClasses);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(Set&lt;ConfigurationClass&gt; configurationModel)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">TrackedConditionEvaluator trackedConditionEvaluator = <span class="keyword">new</span> TrackedConditionEvaluator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (ConfigurationClass configClass : configurationModel) &#123;</span><br><span class="line"></span><br><span class="line">loadBeanDefinitionsForConfigurationClass(configClass, trackedConditionEvaluator);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitionsForConfigurationClass</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">ConfigurationClass configClass, TrackedConditionEvaluator trackedConditionEvaluator)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (trackedConditionEvaluator.shouldSkip(configClass)) &#123;</span><br><span class="line"></span><br><span class="line">String beanName = configClass.getBeanName();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; <span class="keyword">this</span>.registry.containsBeanDefinition(beanName)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.registry.removeBeanDefinition(beanName);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.importRegistry.removeImportingClass(configClass.getMetadata().getClassName());</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (configClass.isImported()) &#123;</span><br><span class="line"></span><br><span class="line">registerBeanDefinitionForImportedConfigurationClass(configClass);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (BeanMethod beanMethod : configClass.getBeanMethods()) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æä¹‹å‰ è§£æ @bean åŠ å…¥çš„ beanMethodä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">loadBeanDefinitionsForBeanMethod(beanMethod);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">loadBeanDefinitionsFromImportedResources(configClass.getImportedResources());</span><br><span class="line"></span><br><span class="line">loadBeanDefinitionsFromRegistrars(configClass.getImportBeanDefinitionRegistrars());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹çœ‹ loadBeanDefinitionsForBeanMethod æ–¹æ³•çš„å®ç°ï¼Œå…¶å®å°±æ˜¯ä»BeanMethodä¸­æå–ä¿¡æ¯ç»„è£…æˆ BeanDefinition</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitionsForBeanMethod</span><span class="params">(BeanMethod beanMethod)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">ConfigurationClass configClass = beanMethod.getConfigurationClass();</span><br><span class="line"></span><br><span class="line">MethodMetadata metadata = beanMethod.getMetadata();</span><br><span class="line"></span><br><span class="line">String methodName = metadata.getMethodName();</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦è·³è¿‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.conditionEvaluator.shouldSkip(metadata, ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line"></span><br><span class="line">configClass.skippedBeanMethods.add(methodName);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (configClass.skippedBeanMethods.contains(methodName)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">AnnotationAttributes bean = AnnotationConfigUtils.attributesFor(metadata, Bean.class);</span><br><span class="line"></span><br><span class="line">Assert.state(bean != <span class="keyword">null</span>, <span class="string">"No @Bean annotation attributes"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è€ƒè™‘åˆ«å åç§°</span></span><br><span class="line"></span><br><span class="line">List&lt;String&gt; names = <span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(bean.getStringArray(<span class="string">"name"</span>)));</span><br><span class="line"></span><br><span class="line">String beanName = (!names.isEmpty() ? names.remove(<span class="number">0</span>) : methodName);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†Œåˆ«åÂ </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (String alias : names) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.registry.registerAlias(beanName, alias);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Has this effectively been overridden before (e.g. via XML)?</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯å¦åœ¨ xmlé…ç½®æ–‡ä»¶ä¸­  å·²ç»é…ç½®è¿‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isOverriddenByExistingDefinition(beanMethod, beanName)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (beanName.equals(beanMethod.getConfigurationClass().getBeanName())) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(beanMethod.getConfigurationClass().getResource().getDescription(),</span><br><span class="line"></span><br><span class="line">beanName, <span class="string">"Bean name derived from @Bean method '"</span> + beanMethod.getMetadata().getMethodName() +</span><br><span class="line"></span><br><span class="line"><span class="string">"' clashes with bean name for containing configuration class; please make those names unique!"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ConfigurationClassBeanDefinition beanDef = <span class="keyword">new</span> ConfigurationClassBeanDefinition(configClass, metadata);</span><br><span class="line"></span><br><span class="line">beanDef.setResource(configClass.getResource());</span><br><span class="line"></span><br><span class="line">beanDef.setSource(<span class="keyword">this</span>.sourceExtractor.extractSource(metadata, configClass.getResource()));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿™é‡Œå¯ä»¥çŸ¥é“ @bean é…ç½®æ˜¯ é€šè¿‡ FactoryMethod æ¥åˆå§‹åŒ–çš„</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (metadata.isStatic()) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// static @Bean method</span></span><br><span class="line"></span><br><span class="line">beanDef.setBeanClassName(configClass.getMetadata().getClassName());</span><br><span class="line"></span><br><span class="line">beanDef.setFactoryMethodName(methodName);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// instance @Bean method</span></span><br><span class="line"></span><br><span class="line">beanDef.setFactoryBeanName(configClass.getBeanName());</span><br><span class="line"></span><br><span class="line">beanDef.setUniqueFactoryMethodName(methodName);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">beanDef.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_CONSTRUCTOR);</span><br><span class="line"></span><br><span class="line">beanDef.setAttribute(RequiredAnnotationBeanPostProcessor.SKIP_REQUIRED_CHECK_ATTRIBUTE, Boolean.TRUE);</span><br><span class="line"></span><br><span class="line">AnnotationConfigUtils.processCommonDefinitionAnnotations(beanDef, metadata);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®autowireå±æ€§</span></span><br><span class="line"></span><br><span class="line">Autowire autowire = bean.getEnum(<span class="string">"autowire"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (autowire.isAutowire()) &#123;</span><br><span class="line"></span><br><span class="line">beanDef.setAutowireMode(autowire.value());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®initMethod åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">String initMethodName = bean.getString(<span class="string">"initMethod"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (StringUtils.hasText(initMethodName)) &#123;</span><br><span class="line"></span><br><span class="line">beanDef.setInitMethodName(initMethodName);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®destroyMethod é”€æ¯æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">String destroyMethodName = bean.getString(<span class="string">"destroyMethod"</span>);</span><br><span class="line"></span><br><span class="line">beanDef.setDestroyMethodName(destroyMethodName);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å– scope</span></span><br><span class="line"></span><br><span class="line">ScopedProxyMode proxyMode = ScopedProxyMode.NO;</span><br><span class="line"></span><br><span class="line">AnnotationAttributes attributes = AnnotationConfigUtils.attributesFor(metadata, Scope.class);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (attributes != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">beanDef.setScope(attributes.getString(<span class="string">"value"</span>));</span><br><span class="line"></span><br><span class="line">proxyMode = attributes.getEnum(<span class="string">"proxyMode"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (proxyMode == ScopedProxyMode.DEFAULT) &#123;</span><br><span class="line"></span><br><span class="line">proxyMode = ScopedProxyMode.NO;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Replace the original bean definition with the target one, if necessary</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœ‰å¿…è¦ï¼Œå°†åŸå§‹Beanå®šä¹‰æ›¿æ¢ä¸ºç›®æ ‡Beanå®šä¹‰</span></span><br><span class="line"></span><br><span class="line">BeanDefinition beanDefToRegister = beanDef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (proxyMode != ScopedProxyMode.NO) &#123;</span><br><span class="line"></span><br><span class="line">BeanDefinitionHolder proxyDef = ScopedProxyCreator.createScopedProxy(</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> BeanDefinitionHolder(beanDef, beanName), <span class="keyword">this</span>.registry,</span><br><span class="line"></span><br><span class="line">proxyMode == ScopedProxyMode.TARGET_CLASS);</span><br><span class="line"></span><br><span class="line">beanDefToRegister = <span class="keyword">new</span> ConfigurationClassBeanDefinition(</span><br><span class="line"></span><br><span class="line">(RootBeanDefinition) proxyDef.getBeanDefinition(), configClass, metadata);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line"></span><br><span class="line">logger.debug(String.format(<span class="string">"Registering bean definition for @Bean method %s.%s()"</span>,</span><br><span class="line"></span><br><span class="line">configClass.getMetadata().getClassName(), beanName));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.registry.registerBeanDefinition(beanName, beanDefToRegister);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç è§£æåˆ°è¿™é‡Œä¸ºæ­¢ï¼Œ@Beané…ç½®çš„Beanä¿¡æ¯å°±è¢«å…¨éƒ¨æŠ½è±¡æˆäº†ä¸€ä¸ª BeanDefinitionå¯¹è±¡ï¼Œæ¥ä¸‹æ¥çš„BeanåŠ è½½ç­‰ç­‰ä¸€å¤§å †é€»è¾‘èµ°çš„å°±æ˜¯Springçš„åŒä¸€å¥—é€»è¾‘äº†ã€‚</p><p>ä»¥ä¸Šæ˜¯é€šè¿‡åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½® <code>&lt;context:annotation-config&gt; &lt;context:component-scan&gt;</code>ã€‚</p><h2 id="Springbootæ€ä¹ˆåšçš„"><a href="#Springbootæ€ä¹ˆåšçš„" class="headerlink" title="Springbootæ€ä¹ˆåšçš„"></a>Springbootæ€ä¹ˆåšçš„</h2><p>é‚£ä¹ˆSpring Bootå¹¶ä¸éœ€è¦é…ç½®æ–‡ä»¶ï¼Œå®ƒåˆæ˜¯åœ¨å“ªé‡Œé…ç½®äº†å…¥å£å‘¢ï¼Ÿ</p><p>å…¶å®åœ¨ä¹‹å‰çš„åˆ†æSpring bootçš„å¯åŠ¨è¿‡ç¨‹æ—¶ å·²ç»æœ‰æåˆ°äº† <a href="https://www.yuque.com/wangjunnan/pnhnfo/qtapgd" target="_blank" rel="noopener"><a href="https://www.yuque.com/wangjunnan/pnhnfo/qtapgd" target="_blank" rel="noopener">é“¾æ¥</a></a> ï¼Œå…¶å®æ˜¯åœ¨åˆå§‹åŒ– Springå®¹å™¨çš„æ„é€ æ–¹æ³•ä¸­è¿›è¡Œäº†é…ç½®çš„åŠ è½½ï¼Œå¹¶ä¸”æœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨äº† AnnotationConfigUtils å·¥å…·ç±»çš„ registerAnnotationConfigProcessorsæ–¹æ³•</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç»ˆäºå†™å®Œäº†ï¼Œå…¶å®åˆ†ææ¥åˆ†æå»ï¼Œä¸è®ºæ˜¯Spring Boot Spring mvc å…¶å®æœ€æ ¸å¿ƒä¸å˜çš„è¿˜æ˜¯ Spring Frameworkï¼Œåªè¦æŠŠæ ¸å¿ƒææ¸…æ¥šäº†ï¼Œä¸‹æ¬¡Spring åˆæ¨å‡ºä»€ä¹ˆ Spring xxx ä¹Ÿèƒ½åº”ä»˜è‡ªå¦‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;ä¹‹å‰Spring ä¸€ç›´ç”¨çš„xmlé…ç½®æ–‡ä»¶æ¯”è¾ƒå¤šï¼Œç°åœ¨å‘ç°æ–°å…¬å¸ç”¨çš„æ³¨è§£æ¯”è¾ƒå¤šã€‚ä¹Ÿå°±æ˜¯é€šè¿‡å®šä¹‰ä¸€ä¸ªé…ç½®ç±»(ä»¥@Configurationæ³¨è§£çš„
      
    
    </summary>
    
      <category term="Spring" scheme="http://wangjunnan.github.io/categories/Spring/"/>
    
    
      <category term="Spring" scheme="http://wangjunnan.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>MVC-HttpRequestHandleræ¥å£é™æ€èµ„æºçš„å…³ç³»</title>
    <link href="http://wangjunnan.github.io/2019/08/30/MVC-HttpRequestHandler%E6%8E%A5%E5%8F%A3%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E7%9A%84%E5%85%B3%E7%B3%BB/"/>
    <id>http://wangjunnan.github.io/2019/08/30/MVC-HttpRequestHandleræ¥å£é™æ€èµ„æºçš„å…³ç³»/</id>
    <published>2019-08-30T08:10:15.000Z</published>
    <updated>2019-09-27T05:52:47.704Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨Spring Mvcï¼Œä¸€èˆ¬æˆ‘ä»¬éƒ½ä¼šé…ç½®å¯¹é™æ€èµ„æºçš„æ‹¦æˆªï¼Œå› ä¸ºé™æ€èµ„æºå¤„ç†æœ‰åˆ«ä¸æ™®é€šè¯·æ±‚ï¼Œéœ€è¦è¿›è¡Œç‰¹æ®Šé…ç½®ã€‚</p><p>æ¯”è¾ƒå¸¸ç”¨çš„é…ç½®æœ‰è¿™å‡ ç§</p><ol><li>Tomcat defaultServelt æ¿€æ´»tomcatè‡ªå¸¦çš„defaultServelt ç”¨æ¥å¤„ç†é™æ€èµ„æº</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.jpg<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.js<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.css<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>ä½¿ç”¨ <code>&lt;mvc:resources/&gt;</code> Spring mvcè‡ªå·±æä¾›çš„é™æ€èµ„æºå¤„ç†å™¨</li></ol><p>ä¾‹å¦‚åšå¦‚ä¸‹é…ç½®ï¼Œå°±å¯ä»¥å°†<code>static</code>å¼€å¤´çš„è·¯å¾„å…¨éƒ¨è®¿é—®è‡³<code>static</code>ç›®å½•</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">mapping</span>=<span class="string">"/static/**"</span> <span class="attr">location</span>=<span class="string">"/static/"</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™ä¸ªé…ç½®çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>é€šè¿‡é˜…è¯»æºç å…¶å®å¯ä»¥çŸ¥é“å®é™…ä¸Šæ˜¯ Spring mvc è‡ªåŠ¨å¸®æˆ‘ä»¬æ³¨å†Œäº†ä¸€ä¸ª<code>SimpleUrlHandlerMapping</code>ï¼Œåœ¨ä¹‹å‰åˆ†æ<code>SimpleUrlHandlerMapping</code>æ—¶ä¹Ÿæœ‰æåˆ°å®ƒå…¶å®å¯ä»¥å½“æˆæ‹¦æˆªå™¨ç”¨ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯ä¸€ä¸ªå®ä¾‹ã€‚æ³¨å†Œäº†<code>HandlerMapping</code>å¿…ç„¶è¦ç¡®å®š<code>handler</code>å¤„ç†å™¨ï¼Œè¿™é‡Œçš„<code>handler</code>å¤„ç†å™¨å…¶å®å°±æ˜¯<code>HttpRequestHandler</code>æ¥å£çš„å®ç°ç±»ï¼ˆResourceHttpRequestHandlerï¼‰</p><ol start="3"><li>ä½¿ç”¨ <code>&lt;mvc:default-servlet-handler/&gt;</code> æ¿€æ´»Spring mvcæä¾›çš„é»˜è®¤é™æ€èµ„æºå¤„ç†å™¨</li></ol><p>ä½¿ç”¨è¿™ä¸ªé…ç½®å…¶å®åŸç†ä¸ç¬¬äºŒä¸ªé…ç½®éå¸¸ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯åˆ©ç”¨äº†<code>SimpleUrlHandlerMapping</code>ï¼Œå¹¶ä¸”<code>handler</code>å¤„ç†å™¨ä¹Ÿæ˜¯<code>HttpRequestHandler</code>æ¥å£çš„å®ç°ç±»ï¼Œåªæ˜¯æŠŠå…·ä½“çš„å®ç°ç±»æ¢æˆäº†<code>DefaultServletHttpRequestHandler</code>ï¼Œç›¸æ¯”ç¬¬äºŒç§é…ç½®ï¼Œæ­¤ç§é…ç½®æ— æ³•è‡ªå®šä¹‰ã€‚</p><ul><li>å†™åœ¨åé¢</li></ul><p>ä¸è¿‡æˆ‘ä»¬è¦æ˜¯ä½¿ç”¨Spring bootå¼€å‘ï¼Œä¹Ÿå°±çœå»äº†è¿™ä¸€å †ç¹ççš„é…ç½®ï¼ŒåŒ…æ‹¬é™æ€èµ„æºçš„é…ç½®ä¹Ÿéƒ½æ˜¯è‡ªåŠ¨å®Œæˆé…ç½®ã€‚åªè¦æŒ‰ç…§çº¦å®šå°†é™æ€èµ„æºæ”¾ç½®åœ¨classpathä¸‹çš„è¿™å‡ ä¸ªç›®å½•ä¸‹ï¼ˆ<code>public</code>,<code>resource</code>,<code>static</code>ï¼‰ï¼Œå°±ä¸éœ€è¦ä»»ä½•é…ç½®ï¼Œä¸å¾—ä¸è¯´ï¼Œçº¦å®šä¼˜äºé…ç½®è¿˜æ˜¯å¯ä»¥æå¤§çš„æå‡å¼€å‘æ•ˆç‡çš„ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨Spring Mvcï¼Œä¸€èˆ¬æˆ‘ä»¬éƒ½ä¼šé…ç½®å¯¹é™æ€èµ„æºçš„æ‹¦æˆªï¼Œå› ä¸ºé™æ€èµ„æºå¤„ç†æœ‰åˆ«ä¸æ™®é€šè¯·æ±‚ï¼Œéœ€è¦è¿›è¡Œç‰¹æ®Šé…ç½®ã€‚&lt;/p&gt;
&lt;p&gt;æ¯”è¾ƒå¸¸ç”¨çš„é…ç½®æœ‰è¿™å‡ ç§&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Tomcat defaultServelt æ¿€æ´»tomcatè‡ªå¸¦çš„defaultServelt ç”¨æ¥
      
    
    </summary>
    
      <category term="Spring" scheme="http://wangjunnan.github.io/categories/Spring/"/>
    
    
      <category term="Spring" scheme="http://wangjunnan.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>æ‰‹å†™ä¸€ä¸ªstarter</title>
    <link href="http://wangjunnan.github.io/2019/08/28/%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AAstarter/"/>
    <id>http://wangjunnan.github.io/2019/08/28/æ‰‹å†™ä¸€ä¸ªstarter/</id>
    <published>2019-08-28T08:47:15.000Z</published>
    <updated>2019-09-29T09:27:51.237Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>å‰æ–‡è¯´è¿‡ï¼Œ<code>Spring Boot</code>æœ€å¤§çš„ä¼˜åŠ¿åœ¨äºè‡ªåŠ¨é…ç½®ï¼Œæˆ‘ä¹ˆåªéœ€è¦å¼•å…¥ä¸€ä¸ªä¸ªç¬¬ä¸‰æ–¹æä¾›çš„<code>starter</code>å°±å¯ä»¥å¿«é€Ÿé›†æˆç¬¬ä¸‰æ–¹åŠŸèƒ½ï¼Œæ—¢ç„¶<code>starter</code>è¿™ä¹ˆæ–¹ä¾¿ï¼Œæˆ‘ä»¬è‡ªå·±åº”è¯¥ä¹Ÿå¯ä»¥å†™ä¸€ä¸ªã€‚</p><h2 id="å¿«é€Ÿå†™ä¸€ä¸ªstarter"><a href="#å¿«é€Ÿå†™ä¸€ä¸ªstarter" class="headerlink" title="å¿«é€Ÿå†™ä¸€ä¸ªstarter"></a>å¿«é€Ÿå†™ä¸€ä¸ªstarter</h2><ul><li>æ–°å»ºä¸€ä¸ªmavené¡¹ç›®</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;groupId&gt;com.walm&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;boot-test-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-autoconfigure&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.0.6.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br></pre></td></tr></table></figure><ul><li>æ–°å»ºä¸€ä¸ªconfigç±»</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HelloWorld <span class="title">HelloWord</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HelloWorld();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ–°å»ºä¸€ä¸ªæä¾›æœåŠ¡çš„serviceç±»</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello world !!!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æœ€é‡è¦çš„æ˜¯ä¸€æ­¥ï¼Œéœ€è¦è®©springèƒ½å¤Ÿæ‰«æåˆ°æˆ‘ä»¬çš„ config HelloWorldConfig ç±»<ul><li>åœ¨resource æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ª META-INF æ–‡ä»¶å¤¹</li><li>æ–°å»ºä¸€ä¸ª spring.factories æ–‡ä»¶</li></ul></li></ul><p>åœ¨spring.factoriesæ–‡ä»¶ä¸­é…ç½®æˆ‘ä»¬çš„å†™çš„HelloWorldConfigç±»</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=com.walm.boottest.HelloWorldConfig</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¸€ä¸ªç®€å•çš„ springboot  starter å°±å®Œæˆäº†ï¼Œæœ€åæœ¬åœ°å®‰è£… installæˆ‘ä»¬çš„starter jaråŒ…å°±å¯ä»¥åœ¨å…¶ä»–é¡¹ç›®ä¸­å¼•ç”¨äº†</p><ul><li>å¼•ç”¨starterï¼Œåªéœ€è¦åœ¨é¡¹ç›®å¼•ç”¨ è¯¥jaråŒ…å³å¯</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.walm&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;boot-test-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬ç®€å•åˆ†æä¸€ä¸‹ staterçš„åŸç†</p><h2 id="starter-è‡ªåŠ¨é…ç½®åŸç†"><a href="#starter-è‡ªåŠ¨é…ç½®åŸç†" class="headerlink" title="starter è‡ªåŠ¨é…ç½®åŸç†"></a>starter è‡ªåŠ¨é…ç½®åŸç†</h2><p>é¦–å…ˆè‡ªåŠ¨é…ç½®çš„åŸç†å…³é”®ä¸€å®šæ˜¯åœ¨ spring.factories æ–‡ä»¶æ˜¯å¦‚ä½•è¢«åŠ è½½åˆ°çš„è¿™ä¸ªç‚¹ä¸Šå»æ¢ç©¶</p><p>éœ€è¦ä»spring bootçš„å¯åŠ¨è¿‡ç¨‹ä¸€æ­¥ä¸€æ­¥çš„å»çœ‹äº†</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªspring-booté¡¹ç›®ï¼Œè‚¯å®šä¼šæœ‰ä¸€ä¸ªé…ç½®æ³¨è§£ <code>SpringBootApplication</code> é‚£ä¹ˆè¿™ä¸ªæ³¨è§£åˆ°åº•èµ·ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ</p><ul><li>SpringBootApplication.class</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(excludeFilters = &#123;</span><br><span class="line"><span class="meta">@Filter</span>(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span><br><span class="line"><span class="meta">@Filter</span>(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Exclude specific auto-configuration classes such that they will never be applied.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the classes to exclude</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@AliasFor</span>(annotation = EnableAutoConfiguration.class)</span><br><span class="line">Class&lt;?&gt;[] exclude() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Exclude specific auto-configuration class names such that they will never be</span></span><br><span class="line"><span class="comment"> * applied.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the class names to exclude</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.3.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@AliasFor</span>(annotation = EnableAutoConfiguration.class)</span><br><span class="line">String[] excludeName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Base packages to scan for annotated components. Use &#123;<span class="doctag">@link</span> #scanBasePackageClasses&#125;</span></span><br><span class="line"><span class="comment"> * for a type-safe alternative to String-based package names.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> base packages to scan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.3.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@AliasFor</span>(annotation = ComponentScan.class, attribute = <span class="string">"basePackages"</span>)</span><br><span class="line">String[] scanBasePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Type-safe alternative to &#123;<span class="doctag">@link</span> #scanBasePackages&#125; for specifying the packages to</span></span><br><span class="line"><span class="comment"> * scan for annotated components. The package of each class specified will be scanned.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Consider creating a special no-op marker class or interface in each package that</span></span><br><span class="line"><span class="comment"> * serves no purpose other than being referenced by this attribute.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> base packages to scan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.3.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@AliasFor</span>(annotation = ComponentScan.class, attribute = <span class="string">"basePackageClasses"</span>)</span><br><span class="line">Class&lt;?&gt;[] scanBasePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç€é‡çœ‹ EnableAutoConfiguration è¿™ä¸ªæ³¨è§£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="meta">@Import</span>(AutoConfigurationImportSelector.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">String ENABLED_OVERRIDE_PROPERTY = <span class="string">"spring.boot.enableautoconfiguration"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Exclude specific auto-configuration classes such that they will never be applied.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the classes to exclude</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Class&lt;?&gt;[] exclude() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Exclude specific auto-configuration class names such that they will never be</span></span><br><span class="line"><span class="comment"> * applied.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the class names to exclude</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.3.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String[] excludeName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° @Import(AutoConfigurationImportSelector.class)è¿™ä¸ªæ³¨è§£ï¼Œè¿™é‡Œå°±æ˜¯æˆ‘ä»¬è‡ªåŠ¨é…ç½®çš„å…¥å£<br>æ³¨æ„ï¼Œè§£æImportæ³¨è§£å…¶å®æ˜¯é€šè¿‡ BeanFactoryPostProcessor æ¥å£æ¥æ‰©å±•çš„</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹AutoConfigurationImportSelector.class ç±»çš„å®ç°ï¼ŒAutoConfigurationImportSelector å®ç°äº†ImportSelectoræ¥å£</p><ul><li>ImportSelector</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Select and return the names of which class(es) should be imported based on</span></span><br><span class="line"><span class="comment"> * the &#123;<span class="doctag">@link</span> AnnotationMetadata&#125; of the importing @&#123;<span class="doctag">@link</span> Configuration&#125; class.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String[] selectImports(AnnotationMetadata importingClassMetadata);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è§£æimportæ³¨è§£çš„æ—¶å€™ä¼šè°ƒç”¨æŒ‡å®šImportSelector æ¥å£å®ç° çš„ selectImportsæ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹AutoConfigurationImportSelectorçš„ selectImportsæ–¹æ³•å®ç°</p><ul><li>selectImports</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line"><span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line"><span class="keyword">return</span> NO_IMPORTS;</span><br><span class="line">&#125;</span><br><span class="line">AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader</span><br><span class="line">.loadMetadata(<span class="keyword">this</span>.beanClassLoader);</span><br><span class="line">AnnotationAttributes attributes = getAttributes(annotationMetadata);</span><br><span class="line">    <span class="comment">// è·å–  META-INF/spring.factories  æ–‡ä»¶ä¸­çš„é…ç½®ä¿¡æ¯</span></span><br><span class="line">List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata,</span><br><span class="line">attributes);</span><br><span class="line">configurations = removeDuplicates(configurations);</span><br><span class="line">Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);</span><br><span class="line">checkExcludedClasses(configurations, exclusions);</span><br><span class="line">configurations.removeAll(exclusions);</span><br><span class="line">configurations = filter(configurations, autoConfigurationMetadata);</span><br><span class="line">    <span class="comment">// è§¦å‘äº‹ä»¶</span></span><br><span class="line">fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line"><span class="keyword">return</span> StringUtils.toStringArray(configurations);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å†™ä¸€ä¸ªstarterè¿˜æ˜¯éå¸¸ç®€å•çš„ï¼Œæ ¸å¿ƒå°±æ˜¯è¦è®©springbootè‡ªåŠ¨æ‰«æåˆ°æˆ‘ä»¬çš„ é…ç½®ç±»ï¼Œæ ¸å¿ƒé€»è¾‘å…¶å®å°±æ˜¯é€šè¿‡æ‰«ææˆ‘ä»¬çš„è‡ªå®šä¹‰çš„META-INF/spring.factoriesæ–‡ä»¶æ¥è¿›è¡Œè‡ªåŠ¨é…ç½®</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;å‰æ–‡è¯´è¿‡ï¼Œ&lt;code&gt;Spring Boot&lt;/code&gt;æœ€å¤§çš„ä¼˜åŠ¿åœ¨äºè‡ªåŠ¨é…ç½®ï¼Œæˆ‘ä¹ˆåªéœ€è¦å¼•å…¥ä¸€ä¸ªä¸ªç¬¬ä¸‰æ–¹æä¾›çš„&lt;code&gt;starter
      
    
    </summary>
    
      <category term="Spring" scheme="http://wangjunnan.github.io/categories/Spring/"/>
    
      <category term="SpringBoot" scheme="http://wangjunnan.github.io/categories/Spring/SpringBoot/"/>
    
    
      <category term="Spring" scheme="http://wangjunnan.github.io/tags/Spring/"/>
    
      <category term="SpringBoot" scheme="http://wangjunnan.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>SpringBootçš„å¯åŠ¨è¿‡ç¨‹</title>
    <link href="http://wangjunnan.github.io/2019/08/27/SpringBoot%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/"/>
    <id>http://wangjunnan.github.io/2019/08/27/SpringBootçš„å¯åŠ¨è¿‡ç¨‹/</id>
    <published>2019-08-27T08:44:29.000Z</published>
    <updated>2019-09-29T09:32:00.546Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>åœ¨æˆ‘ä¹‹å‰å†™çš„æ–‡ç« ä¸­æœ‰è¯¦ç»†åˆ†æè¿‡<code>Spring</code>çš„å¯åŠ¨è¿‡ç¨‹ï¼Œå¦‚ä½•å¤§å®¶æœ‰æ·±å…¥é˜…è¯»è¿‡<code>Spring Framework</code>çš„æ ¸å¿ƒæºç ï¼Œé‚£ä¹ˆé˜…è¯»<code>Spring Boot</code>çš„æºç ä¼šæ¯”è¾ƒè½»æ¾ã€‚ä¸ªäººè§‰å¾—<code>Spring Boot</code>æ ¸å¿ƒçš„ä¸œè¥¿æ¯”è¾ƒå°‘ï¼Œå…¶æ ¸å¿ƒè¿˜æ˜¯<code>Spring Framework</code>ã€‚</p><h2 id="å¯åŠ¨å…¥å£"><a href="#å¯åŠ¨å…¥å£" class="headerlink" title="å¯åŠ¨å…¥å£"></a>å¯åŠ¨å…¥å£</h2><p>è¿˜æ˜¯ä¸€æ­¥åˆ°ä½ï¼Œç›´æ¥çœ‹æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç»Ÿè®¡å¯åŠ¨æ—¶é—´</span></span><br><span class="line">StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">stopWatch.start();</span><br><span class="line">ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// è®¾ç½® java.awt.headless å‚æ•°</span></span><br><span class="line">configureHeadlessProperty();</span><br><span class="line">    <span class="comment">// è·å–ç›‘å¬å™¨</span></span><br><span class="line">SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">listeners.starting();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(</span><br><span class="line">args);</span><br><span class="line">ConfigurableEnvironment environment = prepareEnvironment(listeners,</span><br><span class="line">applicationArguments);</span><br><span class="line">configureIgnoreBeanInfo(environment);</span><br><span class="line">Banner printedBanner = printBanner(environment);</span><br><span class="line">            <span class="comment">// åˆ›å»º contextå®¹å™¨</span></span><br><span class="line">context = createApplicationContext();</span><br><span class="line">exceptionReporters = getSpringFactoriesInstances(</span><br><span class="line">SpringBootExceptionReporter.class,</span><br><span class="line"><span class="keyword">new</span> Class[] &#123; ConfigurableApplicationContext.class &#125;, context);</span><br><span class="line">            <span class="comment">// å‡†å¤‡å®¹å™¨</span></span><br><span class="line">prepareContext(context, environment, listeners, applicationArguments,</span><br><span class="line">printedBanner);</span><br><span class="line">            <span class="comment">// åˆ·æ–°å®¹å™¨</span></span><br><span class="line">refreshContext(context);</span><br><span class="line">afterRefresh(context, applicationArguments);</span><br><span class="line">stopWatch.stop();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line"><span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass)</span><br><span class="line">.logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">&#125;</span><br><span class="line">listeners.started(context);</span><br><span class="line">callRunners(context, applicationArguments);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">handleRunFailure(context, ex, exceptionReporters, listeners);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">listeners.running(context);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">handleRunFailure(context, ex, exceptionReporters, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>createApplicationContext<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ConfigurableApplicationContext <span class="title">createApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">Class&lt;?&gt; contextClass = <span class="keyword">this</span>.applicationContextClass;</span><br><span class="line"><span class="keyword">if</span> (contextClass == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">switch</span> (<span class="keyword">this</span>.webApplicationType) &#123;</span><br><span class="line"><span class="keyword">case</span> SERVLET:</span><br><span class="line">contextClass = Class.forName(DEFAULT_SERVLET_WEB_CONTEXT_CLASS);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> REACTIVE:</span><br><span class="line">contextClass = Class.forName(DEFAULT_REACTIVE_WEB_CONTEXT_CLASS);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">contextClass = Class.forName(DEFAULT_CONTEXT_CLASS);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line"><span class="string">"Unable create a default ApplicationContext, "</span></span><br><span class="line">+ <span class="string">"please specify an ApplicationContextClass"</span>,</span><br><span class="line">ex);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// è¿™é‡Œä¼šå¼•å…¥ä¸€äº›BeanFactoryProcessï¼Œæ¯”å¦‚ ConfigurationClassPostProcessor è§£æConfigurationæ³¨è§£çš„</span></span><br><span class="line"><span class="keyword">return</span> (ConfigurableApplicationContext) BeanUtils.instantiateClass(contextClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>æ³¨: å¼•å…¥çš„BeanFactoryProcess çš„é€»è¾‘åœ¨DEFAULT_SERVLET_WEB_CONTEXT_CLASSçš„æ„é€ æ–¹æ³•ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// çœ‹ä¸‹ AnnotationConfigServletWebServerApplicationContext çš„æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AnnotationConfigServletWebServerApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç›¸å½“äºxmlä¸­é…ç½®äº† &lt;context:annotation-config&gt;</span></span><br><span class="line"><span class="keyword">this</span>.reader = <span class="keyword">new</span> AnnotatedBeanDefinitionReader(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// ç›¸å½“äºxmlä¸­é…ç½®äº† &lt;context:component-scan&gt;</span></span><br><span class="line"><span class="keyword">this</span>.scanner = <span class="keyword">new</span> ClassPathBeanDefinitionScanner(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨çœ‹ä¸‹ AnnotatedBeanDefinitionReader çš„æ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AnnotatedBeanDefinitionReader</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>(registry, getOrCreateEnvironment(registry));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new &#123;<span class="doctag">@code</span> AnnotatedBeanDefinitionReader&#125; for the given registry and using</span></span><br><span class="line"><span class="comment"> * the given &#123;<span class="doctag">@link</span> Environment&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> registry the &#123;<span class="doctag">@code</span> BeanFactory&#125; to load bean definitions into,</span></span><br><span class="line"><span class="comment"> * in the form of a &#123;<span class="doctag">@code</span> BeanDefinitionRegistry&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> environment the &#123;<span class="doctag">@code</span> Environment&#125; to use when evaluating bean definition</span></span><br><span class="line"><span class="comment"> * profiles.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AnnotatedBeanDefinitionReader</span><span class="params">(BeanDefinitionRegistry registry, Environment environment)</span> </span>&#123;</span><br><span class="line">Assert.notNull(registry, <span class="string">"BeanDefinitionRegistry must not be null"</span>);</span><br><span class="line">Assert.notNull(environment, <span class="string">"Environment must not be null"</span>);</span><br><span class="line"><span class="keyword">this</span>.registry = registry;</span><br><span class="line"><span class="keyword">this</span>.conditionEvaluator = <span class="keyword">new</span> ConditionEvaluator(registry, environment, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// åœ¨è¿™é‡Œ æ³¨å†Œäº†ä¸€å †çš„ BeanFactoryProcess </span></span><br><span class="line">AnnotationConfigUtils.registerAnnotationConfigProcessors(<span class="keyword">this</span>.registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ä¸»è¦prepareContextå’ŒrefreshContextæ–¹æ³•</p><ul><li>prepareContext</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareContext</span><span class="params">(ConfigurableApplicationContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">ConfigurableEnvironment environment, SpringApplicationRunListeners listeners,</span></span></span><br><span class="line"><span class="function"><span class="params">ApplicationArguments applicationArguments, Banner printedBanner)</span> </span>&#123;</span><br><span class="line">context.setEnvironment(environment);</span><br><span class="line">postProcessApplicationContext(context);</span><br><span class="line">applyInitializers(context);</span><br><span class="line">listeners.contextPrepared(context);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">logStartupInfo(context.getParent() == <span class="keyword">null</span>);</span><br><span class="line">logStartupProfileInfo(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add boot specific singleton beans</span></span><br><span class="line">context.getBeanFactory().registerSingleton(<span class="string">"springApplicationArguments"</span>,</span><br><span class="line">applicationArguments);</span><br><span class="line"><span class="keyword">if</span> (printedBanner != <span class="keyword">null</span>) &#123;</span><br><span class="line">context.getBeanFactory().registerSingleton(<span class="string">"springBootBanner"</span>, printedBanner);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Load the sources</span></span><br><span class="line">Set&lt;Object&gt; sources = getAllSources();</span><br><span class="line">Assert.notEmpty(sources, <span class="string">"Sources must not be empty"</span>);</span><br><span class="line">        <span class="comment">// è¿™é‡Œå¼•å…¥äº† å¯åŠ¨ç±»</span></span><br><span class="line">load(context, sources.toArray(<span class="keyword">new</span> Object[<span class="number">0</span>]));</span><br><span class="line">listeners.contextLoaded(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ³¨ï¼š è¿™é‡Œçš„ä¸»è¦ä½œç”¨å°±æ˜¯å¼•å…¥äº†å¯åŠ¨ç±»ï¼ŒåŠ å…¥åˆ° BeanFactoryä¸­</strong></p><ul><li>refreshContext<ul><li>åé¢å…¶å® å°±æ˜¯ Spring ç»Ÿä¸€çš„ä¸€å¥—äº†</li><li>å¯ä»¥çœ‹æˆ‘çš„ä¹‹å‰å†™çš„ Spring æºç è§£æç³»åˆ—</li></ul></li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Springbootçš„æ ¸å¿ƒåœ¨äºè‡ªåŠ¨é…ç½® å¿«é€Ÿé›†æˆ ã€‚ä¸€äº›åŸæœ¬éœ€è¦åœ¨Spring xmlæ–‡ä»¶é…ç½®çš„ä¸œè¥¿ï¼ŒSpring åªéœ€è¦ä¸€ä¸ªæ³¨è§£å°±å¸®æˆ‘ä»¬éƒ½åšäº†ã€‚ä¸è¿‡å‰æ–‡ä¹Ÿéƒ½è¯´äº†ï¼Œæ ¸å¿ƒè¿˜æ˜¯ Spring Frameworkã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;åœ¨æˆ‘ä¹‹å‰å†™çš„æ–‡ç« ä¸­æœ‰è¯¦ç»†åˆ†æè¿‡&lt;code&gt;Spring&lt;/code&gt;çš„å¯åŠ¨è¿‡ç¨‹ï¼Œå¦‚ä½•å¤§å®¶æœ‰æ·±å…¥é˜…è¯»è¿‡&lt;code&gt;Spring Framewo
      
    
    </summary>
    
      <category term="Spring" scheme="http://wangjunnan.github.io/categories/Spring/"/>
    
      <category term="SpringBoot" scheme="http://wangjunnan.github.io/categories/Spring/SpringBoot/"/>
    
    
      <category term="Spring" scheme="http://wangjunnan.github.io/tags/Spring/"/>
    
      <category term="SpringBoot" scheme="http://wangjunnan.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>MVCæºç è§£æ-HandlerAdapter</title>
    <link href="http://wangjunnan.github.io/2019/08/25/MVC%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-HandlerAdapter/"/>
    <id>http://wangjunnan.github.io/2019/08/25/MVCæºç è§£æ-HandlerAdapter/</id>
    <published>2019-08-25T08:08:54.000Z</published>
    <updated>2019-09-27T05:52:47.704Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>ä¸Šç¯‡æ–‡ç« åˆ†æäº†<code>handerMapping</code>çš„å®ç°ã€‚æœ¬ç¯‡æ–‡ç« ä¼šç»§ç»­åˆ†æå’Œ<code>handerMapping</code>ç›¸è¾…ç›¸æˆçš„<code>handerAdapter</code>ã€‚</p><p><strong>ä»€ä¹ˆæ˜¯<code>handerAdapter</code>ï¼Ÿ</strong><br>åœ¨ç†è§£äº†<code>handerMapping</code>çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬åº”è¯¥å‘ç°äº†ä¸€ä¸ªé—®é¢˜ã€‚å°±æ˜¯æ¯ä¸ª<code>handerMapping</code>æ‰€åŒ¹é…çš„åˆ°çš„handerå®ç°æ˜¯ä¸ä¸€æ ·çš„ã€‚æ¯”å¦‚<code>RequestMappingHandlerMapping</code>çš„handerçš„å®ç°æ˜¯ä¸€ä¸ª<code>HandlerMethod</code>å®ç°ï¼Œè€Œ<code>BeanNameUrlHandlerMapping</code>çš„handeråˆ™æ˜¯ä¸€ä¸ª<code>Controller</code>æ¥å£å®ç°ç±»ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬è¦æ˜¯ä¸å¼•å…¥<code>handerAdapter</code>çš„è¯ï¼Œå°±æ— æ³•ç»Ÿä¸€çš„å»æ‰§è¡Œå„è‡ªçš„hander</p><p>ä¸Šæ–‡æ‰€è¯´<code>handerAdapter</code>å’Œ<code>handerMapping</code>æ˜¯ç›¸è¾…ç›¸æˆçš„ã€‚ä»¥ä¸‹åˆ—å‡ºäº†å‡ ä¸ªçš„å¯¹åº”å…³ç³»</p><ul><li><code>RequestMappingHandlerMapping</code> -&gt; <code>RequestMappingHandlerAdapter</code></li><li><code>BeanNameUrlHandlerMapping</code> -&gt; <code>SimpleControllerHandlerAdapter</code></li><li><code>SimpleUrlHandlerMapping</code> -&gt; <code>SimpleControllerHandlerAdapter</code></li><li><code>SimpleUrlHandlerMapping</code> -&gt; <code>HttpRequestHandlerAdapter</code></li></ul><p>å…¶ä¸­<code>SimpleUrlHandlerMapping</code>æ¯”è¾ƒç‰¹æ®Šï¼Œå¯ä»¥å¯¹åº”å¤šä¸ª<code>Adapter</code>ï¼Œä¸»è¦åŸå› æ˜¯<code>SimpleUrlHandlerMapping</code>ä¸­çš„<code>handler</code>ç±»å‹ä¹Ÿå¯ä»¥æœ‰å¤šç§ï¼Œæ¯”è¾ƒå¸¸è§çš„æœ‰<code>Controller</code>æ¥å£å®ç°ç±»ï¼Œ<code>HttpRequestHandler</code>æ¥å£å®ç°ç±»ã€‚</p><h2 id="HandlerAdapteræ¥å£"><a href="#HandlerAdapteræ¥å£" class="headerlink" title="HandlerAdapteræ¥å£"></a>HandlerAdapteræ¥å£</h2><p>å…ˆçœ‹ä¸‹HandlerAdapteræ¥å£çš„å‡ ä¸ªæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * åˆ¤æ–­æŒ‡å®šhanderæ˜¯å¦å¯ä»¥è¢«å½“å‰Adapteræ”¯æŒ</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> handler handler object to check</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> whether or not this object can use the given handler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Object handler)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰§è¡Œhanderæ–¹æ³•</span></span><br><span class="line"><span class="comment"> * returned &#123;<span class="doctag">@code</span> true&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception in case of errors</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ModelAndView object with the name of the view and the required</span></span><br><span class="line"><span class="comment"> * model data, or &#123;<span class="doctag">@code</span> null&#125; if the request has been handled directly</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">ModelAndView <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸HttpServletçš„&#123;<span class="doctag">@code</span> getLastModified&#125;æ–¹æ³•çš„çº¦å®šç›¸åŒ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request current HTTP request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> handler handler to use</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the lastModified value for the given handler</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> javax.servlet.http.HttpServlet#getLastModified</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.springframework.web.servlet.mvc.LastModified#getLastModified</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">getLastModified</span><span class="params">(HttpServletRequest request, Object handler)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒæ˜¯<code>supports</code>å’Œ<code>hander</code>æ–¹æ³•</p><ol><li><code>supports</code>ç”¨äºåˆ¤æ–­æŒ‡å®šhanderæ˜¯å¦å¯ä»¥è¢«å½“å‰Adapteræ”¯æŒ</li><li><code>hander</code>æ–¹æ³•ç”¨äºæ‰§è¡ŒæŒ‡å®šçš„handerçš„æ ¸å¿ƒé€»è¾‘</li></ol><p>ä¸‹é¢ç®€å•æ¥çœ‹ä¸‹å„ä¸ªHandlerAdapteræ¥å£çš„å®ç°ç±»ï¼Œçœ‹ä¸€ä¸‹å¯¹è¿™ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•çš„å®ç°</p><h2 id="RequestMappingHandlerAdapter"><a href="#RequestMappingHandlerAdapter" class="headerlink" title="RequestMappingHandlerAdapter"></a>RequestMappingHandlerAdapter</h2><ul><li>supports</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Object handler)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> (handler <span class="keyword">instanceof</span> HandlerMethod &amp;&amp; supportsInternal((HandlerMethod) handler));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œåˆ¤æ–­<code>handler</code>çš„ç±»å‹æ˜¯ä¸æ˜¯<code>HandlerMethod</code>ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™è¯´æ˜è¯¥handlerå¯ä»¥è¢«è¯¥adapteræ‰€é€‚é…ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥è¿”å›è¯¥Adapterã€‚</p><ul><li>hander</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">protected ModelAndView handleInternal(HttpServletRequest request,</span><br><span class="line">HttpServletResponse response, HandlerMethod handlerMethod) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">// å®šä¹‰ ModelAndView</span><br><span class="line">ModelAndView mav;</span><br><span class="line">checkRequest(request);</span><br><span class="line"></span><br><span class="line">// å¤„äºä¸€ä¸ªsessionæ—¶åˆ¤æ–­æ˜¯å¦éœ€è¦åŒæ­¥</span><br><span class="line">if (this.synchronizeOnSession) &#123;</span><br><span class="line">// è·å–å½“å‰session</span><br><span class="line">HttpSession session = request.getSession(false);</span><br><span class="line">if (session != null) &#123;</span><br><span class="line">Object mutex = WebUtils.getSessionMutex(session);</span><br><span class="line">synchronized (mutex) &#123;</span><br><span class="line">   // æ‰§è¡Œ handerMethod å®é™…é€»è¾‘</span><br><span class="line">mav = invokeHandlerMethod(request, response, handlerMethod);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">// No HttpSession available -&gt; no mutex necessary</span><br><span class="line">mav = invokeHandlerMethod(request, response, handlerMethod);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">// </span><br><span class="line">mav = invokeHandlerMethod(request, response, handlerMethod);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!response.containsHeader(HEADER_CACHE_CONTROL)) &#123;</span><br><span class="line">if (getSessionAttributesHandler(handlerMethod).hasSessionAttributes()) &#123;</span><br><span class="line">applyCacheSeconds(response, this.cacheSecondsForSessionAttributeHandlers);</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">prepareResponse(response);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return mav;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SimpleControllerHandlerAdapter"><a href="#SimpleControllerHandlerAdapter" class="headerlink" title="SimpleControllerHandlerAdapter"></a>SimpleControllerHandlerAdapter</h2><ul><li>supports</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Object handler)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> (handler <span class="keyword">instanceof</span> Controller);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­æ˜¯å¦æ˜¯handlerçš„ç±»å‹æ˜¯å¦æ˜¯Controller</p><ul><li>handler</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ((Controller) handler).handleRequest(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯çš„è¯ï¼Œåˆ™ç›´æ¥æ‰§è¡ŒControllerçš„handleRequestæ–¹æ³•</p><h2 id="HttpRequestHandlerAdapter"><a href="#HttpRequestHandlerAdapter" class="headerlink" title="HttpRequestHandlerAdapter"></a>HttpRequestHandlerAdapter</h2><ul><li>supports</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Object handler)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> (handler <span class="keyword">instanceof</span> HttpRequestHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>handler</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">((HttpRequestHandler) handler).handleRequest(request, response);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°é€»è¾‘ä¸<code>SimpleControllerHandlerAdapter</code>ç±»ä¼¼</p><p>å¯¹äºä»¥ä¸Šå‡ ä¸ªAdapterçš„åŒ¹é…é¡ºåºï¼ŒSpringä¼šæ ¹æ®å„ä¸ªAdapterçš„Orderå€¼æ¥è¿›è¡Œæ’åºï¼Œä¾æ¬¡åŒ¹é…ç›´åˆ°æ‰¾åˆ°åˆé€‚çš„ä¸ºæ­¢ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><code>HandlerAdapter</code>çš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯æ‰¿æ¥ä¸åŒçš„<code>HandlerMapping</code>åšé€‚é…ã€‚æœ¬èº«çš„é€»è¾‘å¹¶ä¸å¤æ‚ï¼Œå…¶å¼•å…¥çš„é€‚é…ä¸­é—´å±‚è®¾è®¡æ¨¡å¼æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ¡ˆä¾‹ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;ä¸Šç¯‡æ–‡ç« åˆ†æäº†&lt;code&gt;handerMapping&lt;/code&gt;çš„å®ç°ã€‚æœ¬ç¯‡æ–‡ç« ä¼šç»§ç»­åˆ†æå’Œ&lt;code&gt;handerMapping&lt;/co
      
    
    </summary>
    
      <category term="Spring" scheme="http://wangjunnan.github.io/categories/Spring/"/>
    
    
      <category term="Spring" scheme="http://wangjunnan.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>MVCæºç è§£æ-HandlerMapping</title>
    <link href="http://wangjunnan.github.io/2019/08/20/MVC%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-HandlerMapping/"/>
    <id>http://wangjunnan.github.io/2019/08/20/MVCæºç è§£æ-HandlerMapping/</id>
    <published>2019-08-20T08:07:09.000Z</published>
    <updated>2019-09-27T05:52:47.705Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p><strong>ä»€ä¹ˆæ˜¯Spring mvc çš„ HanderMapping? </strong><br>**<br>æˆ‘ä»¬çŸ¥é“å½“ä¸€ä¸ªhttpè¯·æ±‚åˆ°æœåŠ¡å™¨æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®è¯·æ±‚çš„ä¸Šä¸‹æ–‡urlæ¥åŒ¹é…åˆ°å¯¹åº”çš„å¤„ç†ç±»ï¼Œè€ŒHanderMappingåšçš„å°±æ˜¯è¿™ä¸ªäº‹æƒ…ï¼Œå®ƒå®šä¹‰äº†æˆ‘ä»¬çš„è¯·æ±‚å’Œå¯¹åº”çš„å¤„ç†ç±»çš„æ˜ å°„å…³ç³»ã€‚</p><p>Spring mvcæä¾›äº†å¤šç§HanderMappingç±»å‹ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„æœ‰ <code>RequestMappingHandlerMapping</code>,<code>BeanNameUrlHandlerMapping</code>,<code>SimpleUrlHandlerMapping</code></p><p>ä»¥ä¸‹æ˜¯è¿™ä¸‰ä¸ªHanderMappingçš„ç»§æ‰¿ç»“æ„ï¼š<br><img src="https://cdn.nlark.com/yuque/0/2019/jpeg/149106/1568030225719-c9a755b8-c582-4c6d-8373-b7b078b6ad0b.jpeg#align=left&amp;display=inline&amp;height=528&amp;name=15680101158745.jpg&amp;originHeight=528&amp;originWidth=689&amp;size=67913&amp;status=done&amp;width=689" alt="15680101158745.jpg"></p><p><img src="https://cdn.nlark.com/yuque/0/2019/jpeg/149106/1568030238662-c338cb95-bf09-4657-bbeb-8dd96897e59f.jpeg#align=left&amp;display=inline&amp;height=624&amp;name=15680196478301.jpg&amp;originHeight=624&amp;originWidth=672&amp;size=70420&amp;status=done&amp;width=672" alt="15680196478301.jpg"></p><p><img src="https://cdn.nlark.com/yuque/0/2019/jpeg/149106/1568030249196-ed212f57-bff0-47ba-8dd6-f8fc907b3d33.jpeg#align=left&amp;display=inline&amp;height=571&amp;name=15680196756855.jpg&amp;originHeight=571&amp;originWidth=634&amp;size=59515&amp;status=done&amp;width=634" alt="15680196756855.jpg"></p><p>å…ˆæ¥çœ‹ä¸€ä¸‹è¿™å‡ ä¸ªHandlerMappingçš„é…ç½®å…¥å£ï¼Œå¦‚æœæ˜¯æ™®é€šSpring Mvcåº”ç”¨çš„è¯ï¼Œå½“æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†<code>annotation-driven</code>åï¼Œä¾¿ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æ³¨å…¥è¿™å‡ ä¸ªç±»ã€‚å…·ä½“çš„æºç å…¥å£åœ¨<code>AnnotationDrivenBeanDefinitionParser</code>ä¸­ï¼Œè¿™é‡Œçš„é€»è¾‘éå¸¸ç®€å•ï¼Œå°±æ˜¯å¸®æˆ‘ä»¬è‡ªåŠ¨æ³¨å…¥è¿™å‡ ä¸ªå¸¸ç”¨ç±»çš„<code>BeanDefinition</code>å…ƒæ•°æ®ï¼ˆåŒ…æ‹¬HandlerMappingï¼ŒhandlerAdapterï¼ŒExceptionResolverç­‰ç­‰ï¼‰</p><p>ä¸‹é¢é€šè¿‡é˜…è¯»æºç ä¾æ¬¡åˆ†åˆ«çœ‹ä¸€ä¸‹è¿™å‡ ä¸ªHanderMappingçš„ä½œç”¨åŠå®ç°åŸç†</p><h2 id="RequestMappingHandlerMapping"><a href="#RequestMappingHandlerMapping" class="headerlink" title="RequestMappingHandlerMapping"></a>RequestMappingHandlerMapping</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ RequestMappingHandlerMapping çš„ç”¨æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Controller</span><br><span class="line">public class TestAPI &#123;</span><br><span class="line">    @RequestMapping(value = &quot;/api/sayHello&quot;)</span><br><span class="line">    public String hello() &#123;</span><br><span class="line">        return &quot;OK&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @RequestMapping(value = &quot;/api/sayHello2&quot;)</span><br><span class="line">    public String hello2() &#123;</span><br><span class="line">        return &quot;OK&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šé¢çš„ä»£ç ï¼Œè¿™æ˜¯ä¸€ä¸ªæˆ‘ä»¬éå¸¸å¸¸ç”¨çš„ç”¨æ³•ï¼Œä¸€ä¸ª<code>Controller</code>å®šä¹‰å¤šä¸ªå¤„ç†æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨æ–¹æ³•ä¸Šæ³¨è§£RequestMappingï¼Œå¦‚æ­¤åšä¹‹åå°±å¯ä»¥å®ç°ä¸€ä¸ª<code>Controller</code>æ ¹æ®ä¸åŒçš„è·¯å¾„åˆ†åˆ«å¯ä»¥å¤„ç†å¤šä¸ªè¯·æ±‚ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹å…¶å®ç°åŸç†ã€‚<br>æˆ‘æ¯”è¾ƒå¥½å¥‡çš„æ˜¯ï¼Œ<code>RequestMappingHandlerMapping</code>æ˜¯å¦‚ä½•å°†è¯·æ±‚è·¯å¾„ä¸å¤„ç†æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–æ˜ å°„çš„ï¼Ÿ</p><p>é€šè¿‡è§‚å¯Ÿ<code>RequestMappingHandlerMapping</code>çš„ç»§æ‰¿ä½“ç³»ï¼Œå¯ä»¥çŸ¥é“å…¶å®ç°äº†<code>InitializingBean</code>æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">initHandlerMethods();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆå§‹åŒ– HandlerMethods</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initHandlerMethods</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(<span class="string">"Looking for request mappings in application context: "</span> + getApplicationContext());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è·å–å®¹å™¨ä¸­æ‰€æœ‰çš„Bean</span></span><br><span class="line">String[] beanNames = (<span class="keyword">this</span>.detectHandlerMethodsInAncestorContexts ?</span><br><span class="line">BeanFactoryUtils.beanNamesForTypeIncludingAncestors(obtainApplicationContext(), Object.class) :</span><br><span class="line">obtainApplicationContext().getBeanNamesForType(Object.class));</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line"><span class="keyword">if</span> (!beanName.startsWith(SCOPED_TARGET_NAME_PREFIX)) &#123;</span><br><span class="line">Class&lt;?&gt; beanType = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">beanType = obtainApplicationContext().getType(beanName);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line"><span class="comment">// An unresolvable bean type, probably from a lazy bean - let's ignore it.</span></span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(<span class="string">"Could not resolve target class for bean with name '"</span> + beanName + <span class="string">"'"</span>, ex);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åˆ¤æ–­è¯¥Beanæ˜¯å¦è¢« @Controller æˆ–åˆ™ @RequestMapping æ‰€æ³¨è§£</span></span><br><span class="line"><span class="keyword">if</span> (beanType != <span class="keyword">null</span> &amp;&amp; isHandler(beanType)) &#123;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ– HandlerMethods</span></span><br><span class="line">detectHandlerMethods(beanName);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">handlerMethodsInitialized(getHandlerMethods());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç ä¸»è¦åšäº†3ä»¶äº‹æƒ…</p><ol><li>è·å–å®¹å™¨ä¸­æ‰€æœ‰çš„Bean</li><li>ç­›é€‰å‡ºè¢«<a href>@Controller </a> æˆ–åˆ™ <a href>@RequestMapping </a> æ‰€æ³¨è§£çš„Bean</li><li>æ ¹æ®ç­›é€‰å‡ºçš„Beanåˆå§‹åŒ–HandlerMethod</li></ol><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ç±»å«åšHandlerMethodï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªç±»çš„ç»“æ„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** ç›®æ ‡Bean **/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object bean;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; beanType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** å¯¹åº”çš„ç›®æ ‡æ–¹æ³• **/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Method method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Method bridgedMethod;</span><br><span class="line"><span class="comment">/** æ–¹æ³•å‚æ•°ç±»å‹ **/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MethodParameter[] parameters;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> HttpStatus responseStatus;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> String responseStatusReason;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> HandlerMethod resolvedFromHandlerMethod;</span><br><span class="line"></span><br><span class="line">... è¿˜æä¾›äº†å¾ˆå¤šæ–¹æ³•ï¼Œåƒè·å–æ–¹æ³•è¿”å›å€¼ç­‰ç­‰</span><br></pre></td></tr></table></figure><p>å¯¹äºè¿™ä¸ªç±»æˆ‘ä»¬ç°åœ¨å¯ä»¥ä¸ç”¨æ·±å…¥å»ç†è§£ï¼Œåªéœ€çŸ¥é“å®ƒå°è£…äº†å¤„ç†ç±»çš„ç›®æ ‡æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">detectHandlerMethods</span><span class="params">(Object handler)</span> </span>&#123;</span><br><span class="line">Class&lt;?&gt; handlerType = (handler <span class="keyword">instanceof</span> String ?</span><br><span class="line">obtainApplicationContext().getType((String) handler) : handler.getClass());</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (handlerType != <span class="keyword">null</span>) &#123;</span><br><span class="line">Class&lt;?&gt; userType = ClassUtils.getUserClass(handlerType);</span><br><span class="line"><span class="comment">// è·å–ç›®æ ‡Beanä¸­è¢«RequestMappingæ³¨è§£çš„æ–¹æ³•</span></span><br><span class="line">Map&lt;Method, T&gt; methods = MethodIntrospector.selectMethods(userType,</span><br><span class="line">(MethodIntrospector.MetadataLookup&lt;T&gt;) method -&gt; &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">return</span> getMappingForMethod(method, userType);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Invalid mapping on handler class ["</span> +</span><br><span class="line">userType.getName() + <span class="string">"]: "</span> + method, ex);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(methods.size() + <span class="string">" request handler methods found on "</span> + userType + <span class="string">": "</span> + methods);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ³¨å†Œ HandlerMethod</span></span><br><span class="line">methods.forEach((method, mapping) -&gt; &#123;</span><br><span class="line">Method invocableMethod = AopUtils.selectInvocableMethod(method, userType);</span><br><span class="line">registerHandlerMethod(handler, invocableMethod, mapping);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç ä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ…</p><ol><li>è·å–ç›®å‰Beanä¸­è¢«RequestMappingæ³¨è§£çš„æ–¹æ³•</li><li>æŠŠè·å–åˆ°çš„Method å°è£…æˆHandlerMethodå¹¶å®Œæˆæ³¨å†Œ</li></ol><p>åˆ°è¿™é‡Œä¸ºæ­¢<code>RequestMappingHandlerMapping</code>å°±å®Œæˆåˆå§‹åŒ–äº†ï¼Œä¸‹é¢å†æ¥çœ‹ä¸‹å½“ä¸€ä¸ªè¯·æ±‚æ¥æ—¶å…¶å®å¦‚ä½•å¤„ç†çš„ï¼Œå¹¶é€‰æ‹©æ­£ç¡®çš„ HandlerMethod å¤„ç†çš„.</p><p><strong>å½“ä¸€ä¸ªè¯·æ±‚è¿›æ¥æ—¶ï¼ŒDispatcherServletä¼šåˆ†åˆ«è°ƒç”¨æ¯ä¸ªHandlerMappingçš„getHandlerçš„æ–¹æ³•ï¼Œç›´åˆ°æœ‰ä¸ªHandlerMappingè¿”å›äº†ä¸€ä¸ªhander</strong></p><p><code>getHandleræ–¹æ³•</code>åœ¨æŠ½è±¡çˆ¶ç±»<code>AbstractHandlerMapping.class</code>ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> HandlerExecutionChain <span class="title">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">// å…·ä½“è°ƒç”¨é€»è¾‘ï¼Œç”±å­ç±»å®ç°</span></span><br><span class="line">Object handler = getHandlerInternal(request);</span><br><span class="line"><span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">handler = getDefaultHandler();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (handler <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">String handlerName = (String) handler;</span><br><span class="line">handler = obtainApplicationContext().getBean(handlerName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HandlerExecutionChain executionChain = getHandlerExecutionChain(handler, request);</span><br><span class="line"><span class="keyword">if</span> (CorsUtils.isCorsRequest(request)) &#123;</span><br><span class="line">CorsConfiguration globalConfig = <span class="keyword">this</span>.globalCorsConfigSource.getCorsConfiguration(request);</span><br><span class="line">CorsConfiguration handlerConfig = getCorsConfiguration(handler, request);</span><br><span class="line">CorsConfiguration config = (globalConfig != <span class="keyword">null</span> ? globalConfig.combine(handlerConfig) : handlerConfig);</span><br><span class="line">executionChain = getCorsHandlerExecutionChain(request, executionChain, config);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> executionChain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹<code>RequestMappingHandlerMapping</code>çš„<code>getHandlerInternal</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> HandlerMethod <span class="title">getHandlerInternal</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">// æ ¹æ® requestè·å–åˆ° path</span></span><br><span class="line"><span class="comment">// å¦‚è¯·æ±‚æ˜¯ localhost:8080/api/sayHello</span></span><br><span class="line"><span class="comment">// åˆ™è¿™é‡Œè¿”å›  /api/sayHello</span></span><br><span class="line">String lookupPath = getUrlPathHelper().getLookupPathForRequest(request);</span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(<span class="string">"Looking up handler method for path "</span> + lookupPath);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>.mappingRegistry.acquireReadLock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// è·å–åˆ°è¯·æ±‚å¯¹åº”çš„ handlerMethod </span></span><br><span class="line">HandlerMethod handlerMethod = lookupHandlerMethod(lookupPath, request);</span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line"><span class="keyword">if</span> (handlerMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">logger.debug(<span class="string">"Returning handler method ["</span> + handlerMethod + <span class="string">"]"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">logger.debug(<span class="string">"Did not find handler method for ["</span> + lookupPath + <span class="string">"]"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> (handlerMethod != <span class="keyword">null</span> ? handlerMethod.createWithResolvedBean() : <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="keyword">this</span>.mappingRegistry.releaseReadLock();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå°±æ˜¯<code>RequestMappingHandlerMapping</code>åœ¨æ•´ä¸ªMVCæµç¨‹ä¸­æ‰€èµ·çš„ä½œç”¨</p><h2 id="BeanNameUrlHandlerMapping"><a href="#BeanNameUrlHandlerMapping" class="headerlink" title="BeanNameUrlHandlerMapping"></a>BeanNameUrlHandlerMapping</h2><p>ä¸‹é¢æˆ‘ä»¬å†ç®€å•çœ‹ä¸‹<code>BeanNameUrlHandlerMapping</code>çš„ä½¿ç”¨å’ŒåŸç†<br>é¡¾åæ€ä¹‰ï¼Œ<code>BeanNameUrlHandlerMapping</code>å°±æ˜¯æŒ‡é€šè¿‡BeanNameå’ŒUrlè¿›è¡Œå…³è”åŒ¹é…ï¼Œè·Ÿ<code>RequestMappingHandlerMapping</code>ä¸ä¸€æ ·ï¼Œ<code>BeanNameUrlHandlerMapping</code>ä¸€ä¸ªBeanå°±å¯¹åº”å¤„ç†ä¸€ä¸ªè¯·æ±‚.<br>å…ˆæ¥çœ‹ä¸ªä½¿ç”¨çš„ä¾‹å­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Component(&quot;/test2API&quot;)</span><br><span class="line">public class Test2API implements Controller &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ModelAndView handleRequest(HttpServletRequest request, HttpServletResponse response) throws Exception &#123;</span><br><span class="line">        System.out.println(&quot;test2API&quot;);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æ­¤å®šä¹‰ä¸€ä¸ªç±»ï¼Œæˆ‘ä»¬ä¾¿èƒ½é€šè¿‡<code>/test2API</code>è¿™ä¸ªè·¯å¾„æ¥è®¿é—®è¿™ä¸ªç±»ã€‚<br>å¦‚ä½•å®ç°çš„ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯æ‰“å¼€<code>BeanNameUrlHandlerMapping</code>çœ‹çœ‹å…¶å®ç°ï¼Œä¸<code>RequestMappingHandlerMapping</code>ä¸åŒçš„æ˜¯ï¼Œå®ƒæ²¡æœ‰å®ç°<code>InitializingBean</code>æ¥å£ï¼Œä¸è¿‡å®ƒå®ç°äº†<code>ApplicationContextAware</code>æ¥å£ï¼Œåœ¨Springå®¹å™¨å®Œæˆåˆå§‹åŒ–çš„æ—¶å€™å›è°ƒç”¨è¿™ä¸ªå”¤é†’æ¥å£ï¼Œä¹Ÿå°±æ˜¯åœ¨è¿™é‡Œè¿›è¡Œäº†<code>BeanNameUrlHandlerMapping</code>çš„åˆå§‹åŒ–ã€‚</p><p>åˆå§‹åŒ–é€»è¾‘åœ¨ AbstractDetectingUrlHandlerMapping.detectHandlers() æ–¹æ³•ä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">protected void detectHandlers() throws BeansException &#123;</span><br><span class="line">ApplicationContext applicationContext = obtainApplicationContext();</span><br><span class="line">if (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(&quot;Looking for URL mappings in application context: &quot; + applicationContext);</span><br><span class="line">&#125;</span><br><span class="line">String[] beanNames = (this.detectHandlersInAncestorContexts ?</span><br><span class="line">BeanFactoryUtils.beanNamesForTypeIncludingAncestors(applicationContext, Object.class) :</span><br><span class="line">applicationContext.getBeanNamesForType(Object.class));</span><br><span class="line"></span><br><span class="line">// Take any bean name that we can determine URLs for.</span><br><span class="line">for (String beanName : beanNames) &#123;</span><br><span class="line">// è·å–BeanNameæˆ–åˆ«åæ˜¯ &quot;/&quot; å¼€å¤´çš„ Beanåç§°</span><br><span class="line">String[] urls = determineUrlsForHandler(beanName);</span><br><span class="line">if (!ObjectUtils.isEmpty(urls)) &#123;</span><br><span class="line">// URL paths found: Let&apos;s consider it a handler.</span><br><span class="line">// æŠŠè·å–åˆ°çš„ urls æ³¨å†Œåˆ° handler</span><br><span class="line">registerHandler(urls, beanName);</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">if (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(&quot;Rejected bean name &apos;&quot; + beanName + &quot;&apos;: no URL paths identified&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>determineUrlsForHandler</code>æ˜¯<code>BeanNameUrlHandlerMapping</code>ç±»ä»…æœ‰å®ç°çš„ä¸€ä¸ªæ–¹æ³•ï¼Œä¸»è¦é€»è¾‘å°±æ˜¯è·å–BeanNameæˆ–åˆ«åæ˜¯ â€œ/â€œ å¼€å¤´çš„ Beanåç§°ã€‚æ‰€ä»¥è¿™é‡Œä¹Ÿå¯ä»¥çŸ¥é“åœ¨ä¸Šæ–‡çš„ä½¿ç”¨ä¾‹å­ä¸­ï¼ŒBeanNameæˆ‘ä¸ºä½•è¦ä»¥æ–œæ å¼€å¤´ã€‚</p><p>å½“ä¸€ä¸ªè¯·æ±‚æ¥æ—¶<code>BeanNameUrlHandlerMapping</code>çš„å¤„ç†é€»è¾‘ç±»ä¼¼ï¼Œåªä¸è¿‡åŒ¹é…çš„å®¹å™¨æ¢æˆäº†<code>handlerMap = new LinkedHashMap&lt;&gt;();</code>ï¼ŒåŒ¹é…é€»è¾‘æ›´åŠ çš„ç®€å•ç›´æ¥ã€‚</p><h2 id="SimpleUrlHandlerMapping"><a href="#SimpleUrlHandlerMapping" class="headerlink" title="SimpleUrlHandlerMapping"></a>SimpleUrlHandlerMapping</h2><p>æœ€åå†çœ‹ä¸‹ SimpleUrlHandlerMappingçš„ç”¨æ³•åŠå®ç°</p><p>å®šä¹‰ä¸€ä¸ª<code>SimpleUrlHandlerMapping</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleUrlHandlerMapping <span class="title">simpleUrlHandlerMapping</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SimpleUrlHandlerMapping simpleUrlHandlerMapping = <span class="keyword">new</span> SimpleUrlHandlerMapping();</span><br><span class="line">        Map&lt;String, Object&gt; urlMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        urlMap.put(<span class="string">"/**"</span>, <span class="keyword">new</span> Test2API());</span><br><span class="line">        <span class="comment">// ... å¯é…ç½®å¤šä¸ªæ˜ å°„å…³ç³»</span></span><br><span class="line">        simpleUrlHandlerMapping.setUrlMap(urlMap);</span><br><span class="line">        simpleUrlHandlerMapping.setOrder(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> simpleUrlHandlerMapping;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šé…ç½®ä¼šæ‹¦æˆªæ‰€æœ‰çš„è¯·æ±‚ï¼Œç„¶åè½¬äº¤ç»™ Test2APIå¤„ç†ï¼ˆTest2APIå¯ä»¥æ˜¯Controlleræ¥å£å®ç°ç±»ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª HttpRequestHandleræ¥å£å®ç°ç±»ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œ<code>SimpleUrlHandlerMapping</code>èµ·çš„ä½œç”¨éå¸¸åƒä¸€ä¸ªæ‹¦æˆªå™¨èµ·çš„ä½œç”¨ï¼Œå…¶å®ä¹Ÿç¡®å®æ˜¯è¿™æ ·ï¼Œåƒå¯¹é™æ€èµ„æºçš„æ‹¦æˆªå°±å¯ä»¥é‡‡ç”¨<code>SimpleUrlHandlerMapping</code>æ¥å®ç°ã€‚</p><p>å…·ä½“å®ç°å…¶å®è·Ÿä¸Šæ–‡çš„ä¸¤ç§mappingå®ç°ç±»ä¼¼ï¼Œç®€å•çœ‹ä¸‹æºç </p><p>åˆå§‹æ³¨å†Œé€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initApplicationContext</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"><span class="keyword">super</span>.initApplicationContext();</span><br><span class="line">registerHandlers(<span class="keyword">this</span>.urlMap);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerHandlers</span><span class="params">(Map&lt;String, Object&gt; urlMap)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (urlMap.isEmpty()) &#123;</span><br><span class="line">logger.warn(<span class="string">"Neither 'urlMap' nor 'mappings' set on SimpleUrlHandlerMapping"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">urlMap.forEach((url, handler) -&gt; &#123;</span><br><span class="line"><span class="comment">// ç¡®ä¿è·¯å¾„æ˜¯ä»¥æ–œæ å¼€å¤´çš„</span></span><br><span class="line"><span class="keyword">if</span> (!url.startsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">url = <span class="string">"/"</span> + url;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å»é™¤ç©ºæ ¼</span></span><br><span class="line"><span class="keyword">if</span> (handler <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">handler = ((String) handler).trim();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ³¨å†Œ</span></span><br><span class="line">registerHandler(url, handler);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå°±æ˜¯å°†æˆ‘ä»¬æ‰‹åŠ¨é…ç½®çš„å¤šä¸ªæ˜ å°„å…³ç³»è¿›è¡Œåˆå§‹æ³¨å†Œï¼Œä»¥å¤‡åé¢é€»è¾‘ä½¿ç”¨ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ€»çš„æ¥è¯´HanderMappingçš„èŒè´£æ˜¯éå¸¸æ¸…æ™°çš„ï¼Œå°±æ˜¯å­˜å‚¨å¹¶åŒ¹é…è¯·æ±‚urlå’Œå¤„ç†ç±»çš„æ˜ å°„å…³ç³»ã€‚æ•´ä¸ªå¤„ç†æµç¨‹çš„æºç ç›¸å¯¹æ¥è¯´ä¹Ÿæ¯”è¾ƒç›´è§‚ï¼Œæ˜“é˜…è¯»ã€‚è¯»å®Œå…¶æºç å¯¹MVCçš„urlåŒ¹é…æµç¨‹ä¼šæœ‰æ›´åŠ æ·±åˆ»çš„è®¤è¯†</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;ä»€ä¹ˆæ˜¯Spring mvc çš„ HanderMapping? &lt;/strong&gt;&lt;br&gt;**&lt;br&gt;æˆ‘ä»¬çŸ¥é“å½“ä¸€ä¸ªhttpè¯·
      
    
    </summary>
    
      <category term="Spring" scheme="http://wangjunnan.github.io/categories/Spring/"/>
    
    
      <category term="Spring" scheme="http://wangjunnan.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼äº‹åŠ¡åœ¨ç§¯åˆ†å•†åŸé‡Œçš„åº”ç”¨</title>
    <link href="http://wangjunnan.github.io/2019/07/10/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%9C%A8%E7%A7%AF%E5%88%86%E5%95%86%E5%9F%8E%E9%87%8C%E7%9A%84%E5%BA%94%E7%94%A8/"/>
    <id>http://wangjunnan.github.io/2019/07/10/åˆ†å¸ƒå¼äº‹åŠ¡åœ¨ç§¯åˆ†å•†åŸé‡Œçš„åº”ç”¨/</id>
    <published>2019-07-10T08:56:22.000Z</published>
    <updated>2019-09-27T05:52:47.720Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>æœ€è¿‘åœ¨åšä¼šå‘˜ä½“ç³»çš„æ—¶å€™ï¼Œæ¶‰åŠåˆ°äº†ç§¯åˆ†å•†åŸè®¢å•ä½“ç³»ï¼Œæ—¢ç„¶è®¾è®¡åˆ°è®¢å•ä½“ç³»ï¼Œå› ä¸ºç°åœ¨çš„é¡¹ç›®æ¶æ„ä½“ç³»åŸºæœ¬éƒ½æ˜¯å¾®æœåŠ¡åˆ†å¸ƒå¼çš„ï¼Œæ‰€ä»¥å¿…ç„¶ä¼šæ¶‰åŠåˆ°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚äº‹åŠ¡é—®é¢˜åœ¨æ—©äº›æ—¶å€™éƒ½æ˜¯å•æœºéƒ¨ç½²çš„æ—¶ä»£ä¾é æ•°æ®åº“æœ¬èº«æä¾›çš„äº‹åŠ¡æœºåˆ¶éå¸¸å®¹æ˜“è§£å†³ï¼Œä½†æ˜¯ä¸€æ—¦è®¾è®¡åˆ°åˆ†å¸ƒå¼ï¼Œå„ä¸ªç‹¬ç«‹çš„æœåŠ¡æ˜¯æ— æ³•æ„ŸçŸ¥å…¶ä»–äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å€ŸåŠ©ä¸€äº›å…¶ä»–æ‰‹æ®µæ¥ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡</p><h2 id="åˆ†å¸ƒå¼ç†è®º"><a href="#åˆ†å¸ƒå¼ç†è®º" class="headerlink" title="åˆ†å¸ƒå¼ç†è®º"></a>åˆ†å¸ƒå¼ç†è®º</h2><ul><li><p>CAP</p><ul><li>Cï¼ˆä¸€è‡´æ€§ï¼‰ä¸€è‡´æ€§æ˜¯æŒ‡æ•°æ®çš„åŸå­æ€§ï¼Œåœ¨ç»å…¸çš„æ•°æ®åº“ä¸­é€šè¿‡äº‹åŠ¡æ¥ä¿éšœï¼Œäº‹åŠ¡å®Œæˆæ—¶ï¼Œæ— è®ºæˆåŠŸæˆ–å›æ»šï¼Œæ•°æ®éƒ½ä¼šå¤„äºä¸€è‡´çš„çŠ¶æ€ï¼Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œä¸€è‡´æ€§æ˜¯æŒ‡å¤šä¸ªèŠ‚ç‚¹æ•°æ®æ˜¯å¦ä¸€è‡´ï¼›</li><li>Aï¼ˆå¯ç”¨æ€§ï¼‰æœåŠ¡ä¸€ç›´ä¿æŒå¯ç”¨çš„çŠ¶æ€ï¼Œå½“ç”¨æˆ·å‘å‡ºä¸€ä¸ªè¯·æ±‚ï¼ŒæœåŠ¡èƒ½åœ¨ä¸€å®šçš„æ—¶é—´å†…è¿”å›ç»“æœï¼›</li><li>Pï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰æœºå™¨æ•…éšœã€ç½‘ç»œæ•…éšœã€æœºæˆ¿åœç”µç­‰å¼‚å¸¸æƒ…å†µä¸‹ä»ç„¶èƒ½å¤Ÿæ»¡è¶³ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ï¼Œåˆ†å¸ƒå¼åº”ç”¨ä¸€èˆ¬éƒ½æ»¡è¶³åˆ†åŒºå®¹é”™æ€§<br>åˆ†å¸ƒå¼äº‹åŠ¡æˆ‘ä»¬è¦è§£å†³çš„å°±æ˜¯æ•°æ®çš„ä¸€è‡´æ€§é—®é¢˜</li></ul></li><li><p>ä¸€è‡´æ€§æ¨¡å‹</p><ul><li>åŸºæœ¬å¯ç”¨ï¼ˆBasically Availableï¼‰</li><li>è½¯çŠ¶æ€ï¼ˆSoft Stateï¼‰</li><li><p>æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventually Consistentï¼‰</p><p>å…¶ä¸­æœ€ç»ˆä¸€è‡´æ€§åˆå¯åˆ†ä¸ºï¼šä¼šè¯ä¸€è‡´æ€§ å•è°ƒä¸€è‡´æ€§ç­‰ç­‰</p></li></ul></li></ul><h2 id="2PC-Two-Three-Phase-Commit"><a href="#2PC-Two-Three-Phase-Commit" class="headerlink" title="2PC (Two/Three Phase Commit)"></a>2PC (Two/Three Phase Commit)</h2><p>2PC æˆ‘ä»¬åˆæŠŠå®ƒå«åšä¸¤é˜¶æ®µæäº¤ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹è™½ç„¶å¯ä»¥çŸ¥æ™“è‡ªå·±çš„æ“ä½œæ—¶æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œå´æ— æ³•çŸ¥é“å…¶ä»–èŠ‚ç‚¹çš„æ“ä½œçš„æˆåŠŸæˆ–å¤±è´¥ã€‚å½“ä¸€ä¸ªäº‹åŠ¡è·¨è¶Šå¤šä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¸ºäº†ä¿æŒäº‹åŠ¡çš„ACIDç‰¹æ€§ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªä½œä¸ºåè°ƒè€…çš„ç»„ä»¶æ¥ç»Ÿä¸€æŒæ§æ‰€æœ‰èŠ‚ç‚¹ï¼ˆç§°ä½œå‚ä¸è€…ï¼‰çš„æ“ä½œç»“æœå¹¶æœ€ç»ˆæŒ‡ç¤ºè¿™äº›èŠ‚ç‚¹æ˜¯å¦è¦æŠŠæ“ä½œç»“æœè¿›è¡ŒçœŸæ­£çš„æäº¤ï¼ˆæ¯”å¦‚å°†æ›´æ–°åçš„æ•°æ®å†™å…¥ç£ç›˜ç­‰ç­‰ï¼‰ã€‚å› æ­¤ï¼ŒäºŒé˜¶æ®µæäº¤çš„ç®—æ³•æ€è·¯å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š å‚ä¸è€…å°†æ“ä½œæˆè´¥é€šçŸ¥åè°ƒè€…ï¼Œå†ç”±åè°ƒè€…æ ¹æ®æ‰€æœ‰å‚ä¸è€…çš„åé¦ˆæƒ…æŠ¥å†³å®šå„å‚ä¸è€…æ˜¯å¦è¦æäº¤æ“ä½œè¿˜æ˜¯ä¸­æ­¢æ“ä½œã€‚</p><h3 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h3><p>äºŒé˜¶æ®µæäº¤ç®—æ³•çš„æˆç«‹åŸºäºä»¥ä¸‹å‡è®¾ï¼š</p><ol><li>è¯¥åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºåè°ƒè€…(Coordinator)ï¼Œå…¶ä»–èŠ‚ç‚¹ä½œä¸ºå‚ä¸è€…(Participants)ã€‚ä¸”èŠ‚ç‚¹ä¹‹é—´å¯ä»¥è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚</li><li>æ‰€æœ‰èŠ‚ç‚¹éƒ½é‡‡ç”¨é¢„å†™å¼æ—¥å¿—ï¼Œä¸”æ—¥å¿—è¢«å†™å…¥åå³è¢«ä¿æŒåœ¨å¯é çš„å­˜å‚¨è®¾å¤‡ä¸Šï¼Œå³ä½¿èŠ‚ç‚¹æŸåä¸ä¼šå¯¼è‡´æ—¥å¿—æ•°æ®çš„æ¶ˆå¤±ã€‚</li><li>æ‰€æœ‰èŠ‚ç‚¹ä¸ä¼šæ°¸ä¹…æ€§æŸåï¼Œå³ä½¿æŸååä»ç„¶å¯ä»¥æ¢å¤ã€‚</li></ol><h3 id="ç¬¬ä¸€é˜¶æ®µ-æäº¤è¯·æ±‚é˜¶æ®µ"><a href="#ç¬¬ä¸€é˜¶æ®µ-æäº¤è¯·æ±‚é˜¶æ®µ" class="headerlink" title="ç¬¬ä¸€é˜¶æ®µ(æäº¤è¯·æ±‚é˜¶æ®µ)"></a>ç¬¬ä¸€é˜¶æ®µ(æäº¤è¯·æ±‚é˜¶æ®µ)</h3><ol><li>åè°ƒè€…èŠ‚ç‚¹å‘æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹è¯¢é—®æ˜¯å¦å¯ä»¥æ‰§è¡Œæäº¤æ“ä½œï¼Œå¹¶å¼€å§‹ç­‰å¾…å„å‚ä¸è€…èŠ‚ç‚¹çš„å“åº”ã€‚</li><li>å‚ä¸è€…èŠ‚ç‚¹æ‰§è¡Œè¯¢é—®å‘èµ·ä¸ºæ­¢çš„æ‰€æœ‰äº‹åŠ¡æ“ä½œï¼Œå¹¶å°†<code>Undo</code>ä¿¡æ¯å’Œ<code>Redo</code>ä¿¡æ¯å†™å…¥æ—¥å¿—ã€‚</li><li>å„å‚ä¸è€…èŠ‚ç‚¹å“åº”åè°ƒè€…èŠ‚ç‚¹å‘èµ·çš„è¯¢é—®ã€‚å¦‚æœå‚ä¸è€…èŠ‚ç‚¹çš„äº‹åŠ¡æ“ä½œå®é™…æ‰§è¡ŒæˆåŠŸï¼Œåˆ™å®ƒè¿”å›ä¸€ä¸ªâ€åŒæ„â€æ¶ˆæ¯ï¼›å¦‚æœå‚ä¸è€…èŠ‚ç‚¹çš„äº‹åŠ¡æ“ä½œå®é™…æ‰§è¡Œå¤±è´¥ï¼Œåˆ™å®ƒè¿”å›ä¸€ä¸ªâ€ä¸­æ­¢â€æ¶ˆæ¯ã€‚</li></ol><p>æœ‰æ—¶å€™ï¼Œç¬¬ä¸€é˜¶æ®µä¹Ÿè¢«ç§°ä½œæŠ•ç¥¨é˜¶æ®µï¼Œå³å„å‚ä¸è€…æŠ•ç¥¨æ˜¯å¦è¦ç»§ç»­æ¥ä¸‹æ¥çš„æäº¤æ“ä½œã€‚</p><h3 id="ç¬¬äºŒé˜¶æ®µ-æäº¤æ‰§è¡Œé˜¶æ®µ"><a href="#ç¬¬äºŒé˜¶æ®µ-æäº¤æ‰§è¡Œé˜¶æ®µ" class="headerlink" title="ç¬¬äºŒé˜¶æ®µ(æäº¤æ‰§è¡Œé˜¶æ®µ)"></a>ç¬¬äºŒé˜¶æ®µ(æäº¤æ‰§è¡Œé˜¶æ®µ)</h3><ul><li>æˆåŠŸ<br>  å½“åè°ƒè€…èŠ‚ç‚¹ä»æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹è·å¾—çš„ç›¸åº”æ¶ˆæ¯éƒ½ä¸ºâ€åŒæ„â€æ—¶ï¼š<ol><li>åè°ƒè€…èŠ‚ç‚¹å‘æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹å‘å‡ºâ€æ­£å¼æäº¤â€çš„è¯·æ±‚ã€‚</li><li>å‚ä¸è€…èŠ‚ç‚¹æ­£å¼å®Œæˆæ“ä½œï¼Œå¹¶é‡Šæ”¾åœ¨æ•´ä¸ªäº‹åŠ¡æœŸé—´å†…å ç”¨çš„èµ„æºã€‚</li><li>å‚ä¸è€…èŠ‚ç‚¹å‘åè°ƒè€…èŠ‚ç‚¹å‘é€â€å®Œæˆâ€æ¶ˆæ¯ã€‚</li><li>åè°ƒè€…èŠ‚ç‚¹æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹åé¦ˆçš„â€å®Œæˆâ€æ¶ˆæ¯åï¼Œå®Œæˆäº‹åŠ¡ã€‚</li></ol></li><li>å¤±è´¥<br>  å¦‚æœä»»ä¸€å‚ä¸è€…èŠ‚ç‚¹åœ¨ç¬¬ä¸€é˜¶æ®µè¿”å›çš„å“åº”æ¶ˆæ¯ä¸ºâ€ç»ˆæ­¢â€ï¼Œæˆ–è€… åè°ƒè€…èŠ‚ç‚¹åœ¨ç¬¬ä¸€é˜¶æ®µçš„è¯¢é—®è¶…    æ—¶ä¹‹å‰æ— æ³•è·å–æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹çš„å“åº”æ¶ˆæ¯æ—¶ï¼š<ol><li>åè°ƒè€…èŠ‚ç‚¹å‘æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹å‘å‡ºâ€å›æ»šæ“ä½œâ€çš„è¯·æ±‚ã€‚</li><li>å‚ä¸è€…èŠ‚ç‚¹åˆ©ç”¨ä¹‹å‰å†™å…¥çš„Undoä¿¡æ¯æ‰§è¡Œå›æ»šï¼Œå¹¶é‡Šæ”¾åœ¨æ•´ä¸ªäº‹åŠ¡æœŸé—´å†…å ç”¨çš„èµ„æºã€‚</li><li>å‚ä¸è€…èŠ‚ç‚¹å‘åè°ƒè€…èŠ‚ç‚¹å‘é€â€å›æ»šå®Œæˆâ€æ¶ˆæ¯ã€‚</li><li>åè°ƒè€…èŠ‚ç‚¹æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹åé¦ˆçš„â€å›æ»šå®Œæˆâ€æ¶ˆæ¯åï¼Œå–æ¶ˆäº‹åŠ¡ã€‚</li></ol></li></ul><p>æœ‰æ—¶å€™ï¼Œç¬¬äºŒé˜¶æ®µä¹Ÿè¢«ç§°ä½œå®Œæˆé˜¶æ®µï¼Œå› ä¸ºæ— è®ºç»“æœæ€æ ·ï¼Œåè°ƒè€…éƒ½å¿…é¡»åœ¨æ­¤é˜¶æ®µç»“æŸå½“å‰äº‹åŠ¡</p><h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><p>äºŒé˜¶æ®µæäº¤ç®—æ³•çš„æœ€å¤§ç¼ºç‚¹å°±åœ¨äº: <strong>å®ƒçš„æ‰§è¡Œè¿‡ç¨‹ä¸­é—´ï¼ŒèŠ‚ç‚¹éƒ½å¤„äºé˜»å¡çŠ¶æ€</strong>ã€‚å³èŠ‚ç‚¹ä¹‹é—´åœ¨ç­‰å¾…å¯¹æ–¹çš„å“åº”æ¶ˆæ¯æ—¶ï¼Œå®ƒå°†ä»€ä¹ˆä¹Ÿåšä¸äº†ã€‚ç‰¹åˆ«æ˜¯ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹åœ¨å·²ç»å æœ‰äº†æŸé¡¹èµ„æºçš„æƒ…å†µä¸‹ï¼Œä¸ºäº†ç­‰å¾…å…¶ä»–èŠ‚ç‚¹çš„å“åº”æ¶ˆæ¯è€Œé™·å…¥é˜»å¡çŠ¶æ€æ—¶ï¼Œå½“ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹å°è¯•è®¿é—®è¯¥èŠ‚ç‚¹å æœ‰çš„èµ„æºæ—¶ï¼Œè¿™ä¸ªèŠ‚ç‚¹ä¹Ÿå°†è¿å¸¦é™·å…¥é˜»å¡çŠ¶æ€ã€‚</p><h2 id="TCC-è¡¥å¿å‹"><a href="#TCC-è¡¥å¿å‹" class="headerlink" title="TCC è¡¥å¿å‹"></a>TCC è¡¥å¿å‹</h2><p>ä¸Šé¢å¤§ç¯‡å¹…çš„ä»‹ç»äº†2PCæäº¤ï¼Œä½†å®é™…çš„åº”ç”¨ä¸­æˆ‘ä»¬åŸºæœ¬éƒ½ä¸ä¼šä½¿ç”¨è¿™ç§æ–¹æ¡ˆï¼ŒåŸå› åœ¨ä¸Šé¢çš„ç¼ºç‚¹ä¸­å·²ç»è¯´æ˜äº†ï¼Œ2PCè¿™ç§ä¼ ç»Ÿçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆæ€§èƒ½å®åœ¨æ˜¯å¤ªå·®äº†ï¼Œåœ¨äº’è”ç½‘å¤§å¹¶å‘çš„èƒŒæ™¯ä¸‹æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ï¼Œè¿™å°±å¼•ç”³å‡ºäº†TCCè¡¥å¿æ€§åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ</p><p>TCCæ˜¯(<code>Try-Confirm-Cancel</code>)çš„ç®€ç§°ï¼Œä»åå­—æˆ‘ä»¬çŸ¥é“TCCæœ‰ä¸‰ä¸ªé˜¶æ®µ</p><ol><li>Try<br>Tryé˜¶æ®µä¸»è¦åšèµ„æºçš„é¢„ç•™ï¼Œé”å®šæ“ä½œ</li><li>Confirm<br>å¦‚æœTryé¢„ç•™èµ„æºæˆåŠŸï¼Œåˆ™æ‰§è¡ŒConfirmæ“ä½œï¼Œå¯¹èµ„æºåšæœ€ç»ˆçš„æäº¤</li><li>Cancel<br>å¦‚æœTryé¢„ç•™èµ„æºå¤±è´¥ï¼Œåˆ™æ‰§è¡ŒCancelå–æ¶ˆå¯¹èµ„æºçš„é”å®š</li></ol><p>é€šè¿‡ä¸Šæ–‡çš„æè¿°ï¼Œå¯ä»¥å‘ç°TCCä¸2PCéå¸¸ç›¸ä¼¼ï¼Œä½†å®é™…ä¸Šä¸¤è€…åœ¨è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„å±‚é¢ä¸Šä¸ä¸€æ ·çš„ï¼Œ2PCä¸»è¦è¿˜æ˜¯å€ŸåŠ©æ•°æ®åº“å±‚é¢çš„äº‹åŠ¡æ¥åè°ƒè§£å†³ï¼Œç›¸å¯¹äºæ•°æ®åº“äº‹åŠ¡çš„<code>rollback</code>ï¼ŒTCCåœ¨é€»è¾‘å±‚é¢çš„Cancelæ“ä½œï¼Œä»£ä»·è¦å°çš„å¤šã€‚å¹¶ä¸”TCCäº‹åŠ¡å¼•å…¥äº†ä¸­é—´çŠ¶æ€ï¼ˆä¹Ÿå°±æ˜¯èµ„æºçš„é”å®šï¼‰ï¼Œåªè¦å…¨éƒ¨èµ„æºéƒ½é”å®šæˆåŠŸï¼Œæˆ‘ä»¬å°±è®¤ä¸ºæœ€ç»ˆæ˜¯æ‰§è¡ŒæˆåŠŸçš„ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰</p><p>ä¸‹å›¾æ˜¯ç§¯åˆ†ä¸‹å•ç”¨TCCäº‹åŠ¡è§£å†³çš„å…¸å‹åœºæ™¯<br><img src="http://img.souche.com/f2e/d6344431308a0bf0524dee25a67a7ed4.jpg" alt></p><h3 id="TCCæ˜¯å¦‚ä½•è§£å†³æœ€ç»ˆä¸€è‡´æ€§çš„ï¼Ÿ"><a href="#TCCæ˜¯å¦‚ä½•è§£å†³æœ€ç»ˆä¸€è‡´æ€§çš„ï¼Ÿ" class="headerlink" title="TCCæ˜¯å¦‚ä½•è§£å†³æœ€ç»ˆä¸€è‡´æ€§çš„ï¼Ÿ"></a>TCCæ˜¯å¦‚ä½•è§£å†³æœ€ç»ˆä¸€è‡´æ€§çš„ï¼Ÿ</h3><p>å½“æˆ‘ä»¬åœ¨<code>Try</code>é˜¶æ®µé¢„ç•™èµ„æºæˆåŠŸçš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è®¤ä¸ºæœ€ç»ˆè¿™ä¸ªäº‹åŠ¡æ˜¯è‚¯å®šå¯ä»¥å®Œæˆçš„ï¼Œå³ä½¿å› ä¸ºæŸäº›åŸå› (æ•°æ®åº“downäº†ç­‰çš„)<code>Confirm</code>æ‰§è¡Œå¤±è´¥ï¼ŒTCCäº‹åŠ¡æ¡†æ¶ä¼šä¸åœçš„é‡è¯•è°ƒç”¨å®ƒçš„<code>Confirm</code>é€»è¾‘ï¼ŒåŠ¡å¿…ä¼šä¿è¯å…¶æœ€ç»ˆä¸€è‡´æ€§</p><h3 id="å…¸å‹åº”ç”¨åœºæ™¯"><a href="#å…¸å‹åº”ç”¨åœºæ™¯" class="headerlink" title="å…¸å‹åº”ç”¨åœºæ™¯"></a>å…¸å‹åº”ç”¨åœºæ™¯</h3><p>è®¢å•ç³»ç»Ÿ</p><h2 id="äº‹åŠ¡æ¶ˆæ¯"><a href="#äº‹åŠ¡æ¶ˆæ¯" class="headerlink" title="äº‹åŠ¡æ¶ˆæ¯"></a>äº‹åŠ¡æ¶ˆæ¯</h2><p>äº‹åŠ¡æ¶ˆæ¯çš„åº”ç”¨åœºæ™¯æ˜¯ï¼Œäº‹åŠ¡å‚ä¸æ–¹çš„èµ„æºå·²ç»é”å®šï¼Œåªéœ€è¦ä¿æŒæœ€ç»ˆä¸€è‡´æ€§çš„åœºæ™¯ã€‚æ¯”è¾ƒå…¸å‹çš„å®ä¾‹æ˜¯é“¶è¡Œè½¬è´¦ï¼Œå½“Aè´¦æˆ·å®Œæˆè´¦æˆ·æ‰£å‡åï¼ŒBè´¦æˆ·ä¸éœ€è¦é”å®šè´¦æˆ·ï¼Œåªéœ€è¦ä¿è¯æœ€ç»ˆBè´¦æˆ·å¯ä»¥å¢åŠ æŒ‡å®šé‡‘é¢</p><p><img src="http://img.souche.com/f2e/43a4b89a08f32771eb7815782d749a8a.jpg" alt></p><h3 id="ä¸ºä½•éœ€è¦å…ˆå‘é€-Prepareæ¶ˆæ¯ï¼Ÿ"><a href="#ä¸ºä½•éœ€è¦å…ˆå‘é€-Prepareæ¶ˆæ¯ï¼Ÿ" class="headerlink" title="ä¸ºä½•éœ€è¦å…ˆå‘é€ Prepareæ¶ˆæ¯ï¼Ÿ"></a>ä¸ºä½•éœ€è¦å…ˆå‘é€ Prepareæ¶ˆæ¯ï¼Ÿ</h3><p>è¯•æƒ³ä¸€ç§åœºæ™¯ï¼Œæœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œå‡†å¤‡å‘é€æ¶ˆæ¯çš„æ—¶å€™æ–­ç½‘äº†ï¼Œè¿™æ—¶å€™å°±ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µ</p><h3 id="commit-or-rollback-æ¶ˆæ¯å‘é€å¤±è´¥ï¼Ÿ"><a href="#commit-or-rollback-æ¶ˆæ¯å‘é€å¤±è´¥ï¼Ÿ" class="headerlink" title="commit or rollback æ¶ˆæ¯å‘é€å¤±è´¥ï¼Ÿ"></a>commit or rollback æ¶ˆæ¯å‘é€å¤±è´¥ï¼Ÿ</h3><p>è¿™æ—¶å€™éœ€è¦æ¶ˆæ¯ä¸­é—´ä»¶æä¾›æ¶ˆæ¯å›æŸ¥åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å½“é—´éš”ä¸€æ®µæ—¶é—´ä¹‹åï¼ŒPrepareæ¶ˆæ¯æ²¡æœ‰æ”¶åˆ° commit or rollbackæ¶ˆæ¯ï¼Œéœ€è¦å‘èµ·æ¶ˆæ¯å›æŸ¥ï¼Œå¹¶ä¸”ç”±ä¸šåŠ¡æ–¹åˆ¤æ–­æœ€ç»ˆæ¶ˆæ¯æ˜¯å¦éœ€è¦æŠ•é€’</p><p>å¯¹äºäº‹åŠ¡æ¶ˆæ¯çš„è§£å†³æ–¹æ¡ˆï¼Œé˜¿é‡Œçš„<code>RocketMq</code>ä¹Ÿæä¾›äº†è§£å†³æ–¹æ¡ˆ<br><img src="http://img.souche.com/f2e/1ec3ad72a09958fad49b6cbfb08949db.jpg" alt></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ€»ä½“æ¥è¯´ï¼Œæ¯ç§åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆéƒ½æœ‰å…¶åº”ç”¨åœºæ™¯ï¼Œä½†ç›®å‰ä¸šç•Œæ¯”è¾ƒä¸»æµçš„è¿˜æ˜¯TCCå’Œäº‹åŠ¡æ¶ˆæ¯ï¼ŒTCCäº‹åŠ¡éœ€è¦ä¸šåŠ¡å®ç°<code>Try-Confirm-Cancel</code>é€»è¾‘ï¼Œéœ€è¦åœ¨Tryé˜¶æ®µæå‰é”å®šèµ„æºï¼Œç›¸å¯¹äºäº‹åŠ¡æ¶ˆæ¯æ¥è¯´æˆæœ¬è¾ƒé«˜ï¼Œä½†æ˜¯äº‹åŠ¡æ¶ˆæ¯çš„é€‚ç”¨åœºæ™¯ä¹Ÿæ˜¯æœ‰é™çš„ï¼Œå¦‚ä¸‹å•æ‰£å‡åº“å­˜è¿™ä¸ªåœºæ™¯å› ä¸ºéœ€è¦æå‰é”å®šåº“å­˜ï¼Œäº‹åŠ¡æ¶ˆæ¯å°±ä¸é€‚ç”¨äº†ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;æœ€è¿‘åœ¨åšä¼šå‘˜ä½“ç³»çš„æ—¶å€™ï¼Œæ¶‰åŠåˆ°äº†ç§¯åˆ†å•†åŸè®¢å•ä½“ç³»ï¼Œæ—¢ç„¶è®¾è®¡åˆ°è®¢å•ä½“ç³»ï¼Œå› ä¸ºç°åœ¨çš„é¡¹ç›®æ¶æ„ä½“ç³»åŸºæœ¬éƒ½æ˜¯å¾®æœåŠ¡åˆ†å¸ƒå¼çš„ï¼Œæ‰€ä»¥å¿…ç„¶ä¼šæ¶‰åŠåˆ°åˆ†å¸ƒå¼äº‹
      
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://wangjunnan.github.io/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="åˆ†å¸ƒå¼" scheme="http://wangjunnan.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
      <category term="äº‹åŠ¡" scheme="http://wangjunnan.github.io/tags/%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>git ä½ çœŸçš„ä¼šç”¨å—</title>
    <link href="http://wangjunnan.github.io/2019/06/21/git-%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BC%9A%E7%94%A8%E5%90%97/"/>
    <id>http://wangjunnan.github.io/2019/06/21/git-ä½ çœŸçš„ä¼šç”¨å—/</id>
    <published>2019-06-21T02:26:10.000Z</published>
    <updated>2019-09-27T05:52:47.718Z</updated>
    
    <content type="html"><![CDATA[<h2 id="è®°å½•åŸç”±"><a href="#è®°å½•åŸç”±" class="headerlink" title="è®°å½•åŸç”±"></a>è®°å½•åŸç”±</h2><p>æœ€è¿‘å› ä¸ºå…¬å¸æ–°æ¥çš„åŒäº‹ï¼Œåœ¨ä½¿ç”¨<code>Git</code>æ—¶çŠ¯äº†ä¸€äº›éå¸¸ä½çº§çš„é”™è¯¯ï¼Œå¯¼è‡´å›¢é˜Ÿä¸ºäº†è§£å†³è¿™äº›é—®é¢˜æµªè´¹äº†å¾ˆå¤šæ—¶é—´ã€‚ç©¶å…¶åŸå› å…¶å®è¿˜æ˜¯å¯¹äº<code>Git</code>å†…éƒ¨å®ç°ä¸æ¸…æ™°ï¼Œä»…ä»…çŸ¥é“æ•²å‡ ä¸ªgitå‘½ä»¤ï¼Œä½†æ˜¯å´ä¸çŸ¥é“æ•²äº†è¿™ä¸ªå‘½ä»¤<code>Git</code>ä¼šå‘ç”Ÿä»€ä¹ˆï¼è¿™é‡Œæ ¹æ®<a href="https://git-scm.com/book/en/v2" target="_blank" rel="noopener">gitå®˜æ–¹æ–‡æ¡£</a>èŠ‚é€‰äº†ä¸€äº›é‡è¦æ¦‚å¿µåˆ†äº«å‡ºæ¥ã€‚</p><h2 id="å‡ ä¸ªé‡è¦æ¦‚å¿µ"><a href="#å‡ ä¸ªé‡è¦æ¦‚å¿µ" class="headerlink" title="å‡ ä¸ªé‡è¦æ¦‚å¿µ"></a>å‡ ä¸ªé‡è¦æ¦‚å¿µ</h2><h3 id="ä¸‰ç§çŠ¶æ€"><a href="#ä¸‰ç§çŠ¶æ€" class="headerlink" title="ä¸‰ç§çŠ¶æ€"></a>ä¸‰ç§çŠ¶æ€</h3><ol><li>å·¥ä½œåŒºçŠ¶æ€<ul><li>å°±æ˜¯ä¿®æ”¹äº†æ–‡ä»¶è¿˜æ²¡æœ‰åš <code>git add</code>çš„æ–‡ä»¶çŠ¶æ€</li></ul></li><li>æš‚å­˜åŒºçŠ¶æ€<ul><li>å·²ç»<code>git add</code>ä½†è¿˜æœª<code>git commit</code>çš„æ–‡ä»¶çŠ¶æ€</li></ul></li><li>å·²æäº¤çŠ¶æ€<ul><li>å·²ç»<code>git commit</code>çš„æ–‡ä»¶çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯çœŸæ­£å­˜å‚¨åˆ°<code>git</code>ä»“åº“</li></ul></li></ol><h3 id="BranchæŒ‡é’ˆå’ŒHEADæŒ‡é’ˆ"><a href="#BranchæŒ‡é’ˆå’ŒHEADæŒ‡é’ˆ" class="headerlink" title="BranchæŒ‡é’ˆå’ŒHEADæŒ‡é’ˆ"></a>BranchæŒ‡é’ˆå’ŒHEADæŒ‡é’ˆ</h3><p><code>Git</code>çš„åˆ†æ”¯ç‰¹æ€§æ˜¯å…¶æœ€å¼ºå¤§æœ€ç‹¬ç‰¹çš„åŠŸèƒ½ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ä¸ªç‰¹æ€§è®©<code>git</code>å¾—ä»¥åœ¨ä¼—å¤šçš„ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸­è„±é¢–è€Œå‡ºï¼Œåœ¨ç†è§£<code>branch</code>ä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆå¯¹<code>git commit</code>å‘½ä»¤åšä¸€ä¸ªç®€å•çš„ä»‹ç»</p><ul><li>å½“ä½¿ç”¨<code>git commit</code>è¿›è¡Œæäº¤æ“ä½œæ—¶ï¼Œ<code>Git</code>ä¾¿ä¼šåˆ›å»ºä¸€ä¸ªæäº¤å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šåŒ…å«ä¸€ä¸ªæŒ‡å‘æœ¬æ¬¡æäº¤çš„æŒ‡é’ˆï¼ŒæŒ‡é’ˆæŒ‡å‘æœ¬æ¬¡<code>commit</code>çš„å¿«ç…§ã€‚æŒ‡é’ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„<code>commit id(é•¿åº¦ä¸º 40 çš„ SHA-1 å€¼å­—ç¬¦ä¸²)</code>ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œ<code>Git</code>å°±å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™æ ¹æ®<code>commit id</code>æ¥å›é€€ç‰ˆæœ¬</li></ul><p><code>Branch</code>çš„æœ¬è´¨å…¶å®ä»…ä»…æ˜¯æŒ‡å‘æäº¤å¯¹è±¡çš„<strong>æŸä¸€ä¸ªå¯å˜æŒ‡é’ˆ</strong>ã€‚æ‰€ä»¥æ ¹æ®è¿™ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“<code>master</code>å¹¶ä¸æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åˆ†æ”¯ï¼Œä»–è·Ÿæˆ‘ä»¬ä¼—å¤šè‡ªå®šä¹‰çš„åˆ†æ”¯æ²¡æœ‰ä»»ä½•ä¸åŒï¼Œå”¯ä¸€åŒºåˆ«æ˜¯å®ƒæ˜¯<code>Git</code>çš„é»˜è®¤åˆ†æ”¯(åˆå§‹åŒ–çš„æ—¶å€™æ€»å¾—æœ‰ä¸€ä¸ªé»˜è®¤åˆ†æ”¯)</p><p>ä¸‹é¢çš„å›¾æ˜¯å•ä¸ª<code>master</code>åˆ†æ”¯æ—¶çš„ç»“æ„ï¼Œè¿™é‡Œ<code>master</code>ä»…ä»…æ˜¯ä¸€ä¸ªæŒ‡å‘<code>f30ab</code>æäº¤å¯¹è±¡çš„æŒ‡é’ˆ</p><p><img src="http://img.souche.com/f2e/037ab2a225f8b9457af9a40324313f84.jpg" alt></p><p>æ‰§è¡Œ <code>$ git branch testing</code>åˆ›å»ºä¸€ä¸ª <code>testing</code>åˆ†æ”¯ï¼Œä¼šåœ¨å½“å‰æ‰€åœ¨çš„æäº¤å¯¹è±¡ä¸Šåˆ›å»ºä¸€ä¸ªåä¸º<code>testing</code>çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯<code>testing</code>åˆ†æ”¯<br><img src="http://img.souche.com/f2e/0efbc0ed98b12c7aadfe4a97d82d2315.jpg" alt></p><p>æ³¨æ„ï¼šæ­¤æ—¶ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘äº†ç›¸åŒçš„æäº¤<br>é‚£ä¹ˆ<code>Git</code>æ˜¯å¦‚ä½•æ¥çŸ¥é“å½“å‰å¤„äºå“ªä¸ªåˆ†æ”¯çš„å‘¢ï¼Ÿ<br>è¿™å°±å¼•å‡ºäº†<code>Git</code>ä¸­çš„å¦ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡é’ˆ<code>HEAD</code>ï¼Œ<code>HEAD</code>ç”¨æ¥æŒ‡å‘å½“å‰æ‰€åœ¨çš„åˆ†æ”¯ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªç”¨æ¥æŒ‡å‘åˆ†æ”¯æŒ‡é’ˆçš„æŒ‡é’ˆï¼ˆæœ‰ç‚¹æ‹—å£ï¼‰ï¼Œå°±åƒä¸‹å›¾è¿™æ ·ï¼Œå½“å‰æ˜¯åœ¨<code>master</code>åˆ†æ”¯ï¼Œå› ä¸º<code>git branch</code>å¹¶ä¸ä¼šç§»åŠ¨<code>HEAD</code>æŒ‡é’ˆåˆ‡æ¢åˆ†æ”¯</p><p><img src="http://img.souche.com/f2e/bc84a1c0611edbcf64756ad321f0d84c.jpg" alt></p><p>æ‰§è¡Œ <code>$ git checkout testing</code>å‘½ä»¤æ‰ä¼šå°†<code>HEAD</code>æŒ‡é’ˆæŒ‡å‘<code>testing</code>åˆ†æ”¯<br><img src="http://img.souche.com/f2e/d09338fd78877491ec49f7fcb191a491.jpg" alt></p><p>å½“æˆ‘ä»¬åœ¨<code>testing</code>åˆ†æ”¯ä¸Šç»§ç»­æäº¤å‡ ä¸ªcommitä¹‹åï¼Œ<code>testing</code>æŒ‡é’ˆå’Œ<code>HEAD</code>æŒ‡é’ˆéƒ½ä¼šè·Ÿç€å‘å‰ç§»åŠ¨ï¼Œä½†æ˜¯<code>master</code>æŒ‡é’ˆå¹¶ä¸ä¼šç§»åŠ¨ï¼Œä¾æ—§æŒ‡å‘<code>f30ab</code>è¿™ä¸ªæäº¤<br><img src="http://img.souche.com/f2e/8b8a8539aa7dc810a9a9f371f8751bc3.jpg" alt></p><p>ç°åœ¨æ‰§è¡Œ<code>git checkout master</code>åˆ‡å›<code>master</code>åˆ†æ”¯ï¼Œ<code>HEAD</code>æŒ‡é’ˆä¼šé‡æ–°æŒ‡å‘<code>master</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ç°åœ¨åˆå›åˆ°äº†ä¸€ä¸ªæ—§çš„ç‰ˆæœ¬ï¼Œè¿™ä¹Ÿæ˜¯<code>Git</code>çš„ç¥å¥‡ä¹‹å¤„<br><img src="http://img.souche.com/f2e/a172111db3abe0d8c6f82c7b3a99607f.jpg" alt></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨<code>master</code>åˆ†æ”¯ä¸Šåšä¸€äº›ä¿®æ”¹ï¼Œæäº¤ä¸€ä¸ªcommitï¼Œ<code>HEAD</code>å’Œ<code>master</code>æŒ‡é’ˆä¼šç»§ç»­å‘å‰ç§»åŠ¨ï¼Œå¹¶ä¸”è¿™ä¸ªé¡¹ç›®çš„æäº¤ï¼ˆå¿«ç…§ç‰ˆæœ¬ï¼‰å·²ç»äº§ç”Ÿäº†åˆ†å‰<br><img src="http://img.souche.com/f2e/237c20e005bac4135577ffd143eeb033.jpg" alt></p><blockquote><p>ä¿å­˜åˆ†æ”¯ä¿¡æ¯çš„ç›®å½•åœ¨<code>.git/refs/heads</code>ä¸‹ï¼Œä¹Ÿå¯ä»¥åœ¨è¿™ä¸ªç›®å½•ä¸‹æŸ¥çœ‹æˆ–ä¿®æ”¹åˆ†æ”¯æŒ‡é’ˆ</p></blockquote><h2 id="merge-å‘½ä»¤"><a href="#merge-å‘½ä»¤" class="headerlink" title="merge å‘½ä»¤"></a>merge å‘½ä»¤</h2><p>åœ¨ä¸Šæ–‡çš„ä¾‹å­ä¸­ï¼Œé¡¹ç›®æœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼Œä¸”å·²ç»äº§ç”Ÿäº†åˆ†å‰ï¼Œè¿™æ—¶å€™éœ€è¦æŠŠ<code>testing</code>åˆ†æ”¯ä¸Šçš„å†…å®¹åˆå¹¶è‡³<code>master</code>æ—¶éœ€è¦ç”¨åˆ°<code>merge</code>å‘½ä»¤<br>åœ¨<code>master</code>æ‰§è¡Œ<code>git merge testing</code>ï¼Œä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æäº¤<code>9c67a</code>ï¼Œå¹¶ä¸”<code>HEAD</code>å’Œ<code>master</code>æŒ‡é’ˆç»§ç»­å‘å‰ç§»åŠ¨</p><p><img src="http://img.souche.com/f2e/0c40f40917743bcc75b4871ad7a76bf8.jpg" alt></p><h2 id="reset-å‘½ä»¤"><a href="#reset-å‘½ä»¤" class="headerlink" title="reset å‘½ä»¤"></a>reset å‘½ä»¤</h2><p>å‡å¦‚ä¸Šé¢çš„<code>merge</code>æ“ä½œæœ‰é—®é¢˜ï¼Œéœ€è¦æ’¤é”€ï¼Œå¯ä»¥ä½¿ç”¨<code>reset</code>å‘½ä»¤ï¼Œä½†é¦–å…ˆéœ€è¦æ˜ç¡®å›é€€çš„ç‰ˆæœ¬æ˜¯å“ªä¸€ä¸ªï¼Œä¾‹å¦‚è¦å›é€€çš„ç‰ˆæœ¬æ˜¯<code>c2b9e</code>ï¼Œæ‰§è¡Œ<code>git reset --hard c2b9e</code>åï¼Œ<code>HEAD</code>å’Œ<code>master</code>æŒ‡é’ˆä¼šå›é€€åˆ°ç‰ˆæœ¬<code>c2b9e</code></p><p><img src="http://img.souche.com/f2e/cfd70efa478ee439cc8db564681b22c2.jpg" alt></p><h2 id="â€¦"><a href="#â€¦" class="headerlink" title="â€¦"></a>â€¦</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;è®°å½•åŸç”±&quot;&gt;&lt;a href=&quot;#è®°å½•åŸç”±&quot; class=&quot;headerlink&quot; title=&quot;è®°å½•åŸç”±&quot;&gt;&lt;/a&gt;è®°å½•åŸç”±&lt;/h2&gt;&lt;p&gt;æœ€è¿‘å› ä¸ºå…¬å¸æ–°æ¥çš„åŒäº‹ï¼Œåœ¨ä½¿ç”¨&lt;code&gt;Git&lt;/code&gt;æ—¶çŠ¯äº†ä¸€äº›éå¸¸ä½çº§çš„é”™è¯¯ï¼Œå¯¼è‡´å›¢é˜Ÿä¸ºäº†è§£å†³è¿™äº›é—®é¢˜æµªè´¹äº†å¾ˆå¤šæ—¶
      
    
    </summary>
    
      <category term="git" scheme="http://wangjunnan.github.io/categories/git/"/>
    
    
      <category term="git" scheme="http://wangjunnan.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>JAVA æ³›å‹ ä½ çœŸçš„ç†è§£äº†å—ï¼Ÿ</title>
    <link href="http://wangjunnan.github.io/2019/06/19/JAVA-%E6%B3%9B%E5%9E%8B-%E4%BD%A0%E7%9C%9F%E7%9A%84%E7%90%86%E8%A7%A3%E4%BA%86%E5%90%97%EF%BC%9F/"/>
    <id>http://wangjunnan.github.io/2019/06/19/JAVA-æ³›å‹-ä½ çœŸçš„ç†è§£äº†å—ï¼Ÿ/</id>
    <published>2019-06-19T08:16:53.000Z</published>
    <updated>2019-09-27T05:52:47.699Z</updated>
    
    <content type="html"><![CDATA[<h2 id="è®°å½•åŸç”±"><a href="#è®°å½•åŸç”±" class="headerlink" title="è®°å½•åŸç”±"></a>è®°å½•åŸç”±</h2><p>ä¹‹å‰è™½ç„¶æ³›å‹ä¸€ç›´åœ¨ä½¿ç”¨ï¼Œä½†ä½¿ç”¨çš„è¿‡ç¨‹ä¸­æ€»æ˜¯æ²¡æœ‰é‚£ä¹ˆå¾—å¿ƒåº”æ‰‹ï¼Œæœ‰äº›ç»†èŠ‚è¿˜æ˜¯è¿‡äºæ¨¡ç³Šã€‚ç©¶å…¶åŸå› å…¶å®æ˜¯ä¸€ç›´éƒ½æ²¡æœ‰ç³»ç»Ÿæ·±å…¥çš„å»ç†è§£è¿‡ï¼Œæœ€è¿‘èŠ±äº†ä¸€ç‚¹æ—¶é—´å»æ·±å…¥çš„ç†è§£äº†ä¸€ä¸‹javaçš„æ³›å‹æœºåˆ¶ï¼Œä¹Ÿå¸Œæœ›å€Ÿè¿™æ¬¡è®°å½•èƒ½å¤Ÿå½»åº•çš„ç†è§£javaçš„æ³›å‹</p><h2 id="ä¸ºä»€ä¹ˆè¦æœ‰æ³›å‹"><a href="#ä¸ºä»€ä¹ˆè¦æœ‰æ³›å‹" class="headerlink" title="ä¸ºä»€ä¹ˆè¦æœ‰æ³›å‹"></a>ä¸ºä»€ä¹ˆè¦æœ‰æ³›å‹</h2><p><strong>æ³›å‹çš„æœ¬è´¨æ˜¯æŠŠ ç±»å‹å‚æ•°åŒ–</strong>ï¼Œä»€ä¹ˆæ˜¯ç±»å‹å‚æ•°åŒ–ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„é›†åˆç±»ï¼Œè¦æ˜¯æ²¡æœ‰ç±»å‹å‚æ•°åŒ–çš„è¯ï¼Œæˆ‘ä»¬å°±å¾—å®ç°è£…ä¸åŒç±»å‹çš„é›†åˆç±»ï¼Œä¼šå¤§å¤§é™ä½ä»£ç çš„å¯é‡ç”¨æ€§ï¼</p><p>ä¾‹å¦‚æˆ‘ä»¬è¦è®¾è®¡ä¸€ä¸ªè£…è‹¹æœçš„ç›˜å­å’Œä¸€ä¸ªè£…é¦™è•‰çš„ç›˜å­ï¼Œè¦æ€ä¹ˆè®¾è®¡å‘¢ï¼Ÿéå¸¸ç®€å•ï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯è®¾è®¡ä¸¤ä¸ªç›˜å­ç±»ï¼Œä¸€ä¸ªæ˜¯è‹¹æœç›˜å­ï¼Œä¸€ä¸ªé¦™è•‰ç›˜å­ï¼Œå°±åƒä¸‹é¢çš„ä»£ç ä¸€æ ·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplePlant</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Apple apple;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Apple <span class="title">getApple</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> apple;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApple</span><span class="params">(Apple apple)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.apple = apple;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BananaPlant</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Banana banana;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Banana <span class="title">getBanana</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> banana;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBanana</span><span class="params">(Banana banana)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.banana = banana;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç çš„ç¡®èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä½†å°±åƒä¸Šæ–‡æ‰€è¯´çš„ï¼Œè¿™æ ·çš„ä»£ç é™ä½äº†ä»£ç çš„å¯é‡ç”¨æ€§ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦æ€ä¹ˆä¼˜åŒ–å‘¢ï¼Œèªæ˜çš„ç¨‹åºå‘˜ä»¬é©¬ä¸Šæƒ³åˆ°äº†ï¼Œå¯ä»¥ç”¨<code>Object</code>æ¥ä»£æ›¿ç›˜å­é‡Œæ‰€æŒ‡ä»£çš„å…·ä½“ç±»å‹ï¼Œå°±åƒä¸‹é¢è¿™æ ·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectPlant</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Object object;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setObject</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.object = object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç çœ‹ä¼¼å®Œç¾è§£å†³äº†ä»£ç ä¸å¯é‡ç”¨çš„é—®é¢˜ï¼Œä½†åŒæ—¶ä¹Ÿéšå«äº†å¾ˆå¤šå…¶ä»–é—®é¢˜ï¼Œä¾‹å¦‚åœ¨æˆ‘ä»¬å–æ•°æ®çš„æ—¶å€™ï¼Œå–å‡ºæ¥çš„åªèƒ½æ˜¯<code>Object</code>ç±»å‹ï¼Œéœ€è¦æˆ‘ä»¬å¼ºè½¬ç±»å‹ï¼Œè€Œå¾€ç›˜å­ä¸­åŠ å…¥æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•éªŒè¯ï¼Œæœ‰å¯èƒ½å¾€æ”¾è‹¹æœçš„ç›˜å­ä¸­åŠ å…¥äº†é¦™è•‰ä¹Ÿè¯´ä¸å®šï¼Œå› ä¸ºç¼–è¯‘å™¨å¹¶æ²¡æœ‰åšä»»ä½•é™åˆ¶ï¼Œåªè¦æ˜¯<code>Object</code>ç±»å‹ï¼Œéƒ½å¯ä»¥éªŒè¯é€šè¿‡ã€‚</p><p>ä¸Šé¢çš„é—®é¢˜åœ¨Java 1.5å¼•å…¥äº†æ³›å‹ä¹‹åå¾—åˆ°äº†å®Œç¾çš„è§£å†³ï¼Œä¸‹é¢è®©æˆ‘ä»¬æ¥çœ‹çœ‹ç”¨æ³›å‹å¦‚ä½•ä¼˜é›…çš„è§£å†³ä¸Šè¿°é—®é¢˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Plant</span> &lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T t;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getT</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setT</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.t = t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæ³›å‹ç±»ï¼Œå®ƒè¡¨ç¤ºäº†ä¸€ä¸ªå¯ä»¥<code>T</code>ç±»å‹çš„ç¯®å­ï¼Œè€Œè¿™ä¸ª<code>T</code>ç±»å‹éœ€è¦åˆ°æˆ‘ä»¬çœŸæ­£ä½¿ç”¨çš„æ—¶å€™æ‰ä¼šå»æŒ‡å®š</p><p>ä¾‹å¦‚ç°åœ¨æˆ‘ä»¬è¦å®šä¹‰ä¸¤ç§ç›˜å­ï¼Œå¯ä»¥è¿™æ ·å£°æ˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Plant&lt;Apple&gt; applePlant = <span class="keyword">new</span> Plant&lt;&gt;();</span><br><span class="line">Plant&lt;Banana&gt; bananaPlant = <span class="keyword">new</span> Plant&lt;&gt;();</span><br><span class="line">Apple apple = <span class="keyword">new</span> Apple();</span><br><span class="line">Banana banana = <span class="keyword">new</span> Banana();</span><br><span class="line">applePlant.set(banana); <span class="comment">// ç¼–è¯‘æŠ¥é”™</span></span><br><span class="line">bananaPlant.set(apple); <span class="comment">// ç¼–è¯‘æŠ¥é”™</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç ä¹‹æ‰€ä»¥å®é™…ç±»å‹<code>new Plant&lt;&gt;()</code>çš„<code>&lt;&gt;</code>ä¸­æ²¡æœ‰æŒ‡æ˜å…·ä½“ç±»å‹ï¼Œæ˜¯å› ä¸ºJava7ä¹‹ååŠ äº†ç±»å‹è‡ªåŠ¨æ¨æ–­ï¼Œä¹Ÿå°±ä¸éœ€è¦ä¸¤ä¾§éƒ½åŠ ä¸Šæ³›å‹ç±»å‹</p><p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨äº†æ³›å‹ä¹‹åï¼Œæ—¢æé«˜äº†ä»£ç çš„å¯é‡ç”¨æ€§ï¼Œåœ¨å®é™…ä½¿ç”¨æ—¶ä¹Ÿå¯¹ç±»å‹è¿›è¡Œäº†çº¦æŸï¼Œè£…è‹¹æœçš„ç›˜å­æ˜¯è£…ä¸äº†é¦™è•‰çš„ï¼</p><p>ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ï¼Œjavaçš„æ³›å‹çº¦æŸæ˜¯åœ¨ç¼–è¯‘æ—¶ç”Ÿæ•ˆçš„ï¼Œä¸€æ—¦ç¼–è¯‘æˆäº†classå­—èŠ‚ç æ–‡ä»¶åï¼Œä¸€åˆ‡éƒ½æ‰“å›åŸå½¢äº†ï¼Œæ³›å‹ä¿¡æ¯ä¼šè¢«æ“¦é™¤ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠ<code>JAVA</code>çš„æ³›å‹ç§°ä¸ºä¼ªæ³›å‹ï¼Œè·Ÿ<code>C#</code>ç­‰è¯­è¨€çš„çœŸæ³›å‹æœ‰ç€æœ¬è´¨åŒºåˆ«ï¼Œåœ¨<code>C#</code>ä¸­ï¼Œ<code>List&lt;Integer&gt;</code>å’Œ<code>List&lt;String&gt;</code> å°±æ˜¯ä¸¤ç§ä¸åŒçš„ç±»å‹</p><p>å¦‚ä¸‹é¢å­—èŠ‚ç æ–‡ä»¶çš„æœ€åä¸€è¡Œ<code>invokevirtual</code>å‘½ä»¤çš„æ–¹æ³•æè¿°ç¬¦<code>Method setT:(Ljava/lang/Object;)V</code>ï¼Œå¯çŸ¥æ³›å‹ç±»å‹å·²ç»è¢«æ“¦é™¤æˆäº†<code>Object</code>ç±»å‹ï¼Œä¹Ÿå°±æ˜¯åœ¨å­—èŠ‚ç å±‚é¢å®é™…ä¸Šä¸æˆ‘ä»¬ç›´æ¥ç”¨<code>Object</code>æ¥å®ç°æ˜¯ä¸€æ ·çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0: new           #3                  // class com/sunshine/common/test/Plant</span><br><span class="line">         3: dup</span><br><span class="line">         4: invokespecial #4                  // Method &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         7: astore_1</span><br><span class="line">         8: aload_1</span><br><span class="line">         9: new           #5                  // class com/sunshine/common/test/Apple</span><br><span class="line">        12: dup</span><br><span class="line">        13: invokespecial #6                  // Method com/sunshine/common/test/Apple.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">        16: invokevirtual #7                  // Method setT:(Ljava/lang/Object;)V</span><br></pre></td></tr></table></figure><h2 id="æ³›å‹è¿›é˜¶"><a href="#æ³›å‹è¿›é˜¶" class="headerlink" title="æ³›å‹è¿›é˜¶"></a>æ³›å‹è¿›é˜¶</h2><h3 id="ä½¿ç”¨-lt-T-extends-gt-å®šä¹‰æ³›å‹ç±»"><a href="#ä½¿ç”¨-lt-T-extends-gt-å®šä¹‰æ³›å‹ç±»" class="headerlink" title="ä½¿ç”¨ &lt;T extends ?&gt; å®šä¹‰æ³›å‹ç±»"></a>ä½¿ç”¨ <code>&lt;T extends ?&gt;</code> å®šä¹‰æ³›å‹ç±»</h3><p>å¤´ä¸€æ¬¡çœ‹åˆ°ä¸Šé¢ä¸¤ä¸ªç¬¦å·ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹æ‡µé€¼ï¼Ÿå®ƒä»¬åœ¨ä»£ç é‡Œä¹Ÿéå¸¸å¸¸è§ï¼Œé‚£ä¹ˆå®ƒä»¬ç©¶ç«Ÿæ˜¯è¡¨ç¤ºä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ<br>è¿˜æ˜¯é€šè¿‡ä¸Šæ–‡çš„<code>plant</code>ç›˜å­æ¥ä¸¾ä¾‹å§ï¼Œä¸¾ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬åªå¸Œæœ›è¿™ä¸ªç›˜å­ç”¨æ¥è£…ä¸€äº›æ°´æœï¼Œè€Œä¸å¸Œæœ›å®ƒè¢«ç”¨æ¥è£…è‚‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ<br>ç°åœ¨çš„æƒ…å†µæ˜¯ï¼Œå®ƒæ—¢å¯ä»¥å®ä¾‹åŒ–æˆä¸€ä¸ªè£…é¦™è•‰çš„ç›˜å­ï¼Œä¹Ÿå¯ä»¥è¢«å®ä¾‹åŒ–æˆä¸€ä¸ªè£…è‚‰çš„ç›˜å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Plant&lt;Apple&gt; applePlant = <span class="keyword">new</span> Plant&lt;&gt;(); <span class="comment">// </span></span><br><span class="line">Plant&lt;Meat&gt; meatPlant = <span class="keyword">new</span> Plant&lt;&gt;(); <span class="comment">// éƒ½æ˜¯Okçš„</span></span><br></pre></td></tr></table></figure><p>ç°åœ¨è®©æˆ‘ä»¬æ¥é‡æ–°è®¾è®¡ä¸€ä¸ªç›˜å­ç±»ï¼Œé€šè¿‡<code>&lt;T extends Firut&gt;</code>æ¥é™åˆ¶æ³›å‹ï¼Œå…¶å®å¦‚æœæˆ‘ä»¬ç›´æ¥ç”¨<code>&lt;T&gt;</code>çš„ç¼–è¯‘æˆå­—èŠ‚ç åä¹Ÿä¼šè‡ªåŠ¨ç¼–è¯‘æˆ<code>&lt;T extends Object&gt;</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirutPlant</span> &lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Firut</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T t;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getT</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setT</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.t = t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FirutPlant&lt;Apple&gt; appleFirutPlant = <span class="keyword">new</span> FirutPlant&lt;&gt;(); <span class="comment">// OK</span></span><br><span class="line">FirutPlant&lt;Firut&gt; firutPlant = <span class="keyword">new</span> FirutPlant&lt;&gt;(); <span class="comment">// OK</span></span><br><span class="line">FirutPlant&lt;Meat&gt; meatFirutPlant = <span class="keyword">new</span> FirutPlant&lt;&gt;(); <span class="comment">// ç¼–è¯‘æ— æ³•é€šè¿‡</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„ä»£ç å¯çŸ¥æˆ‘ä»¬æˆåŠŸçš„é™åˆ¶äº†æ³›å‹ï¼Œæ°´æœç›˜å­å°±åªèƒ½è£…æ°´æœï¼Œç›˜å­ä¸­çš„ç±»å‹åªèƒ½æ˜¯æ°´æœæˆ–åˆ™å®ƒçš„å­ç±»å‹ã€‚</p><h3 id="lt-extends-T-gt-lt-super-T-gt"><a href="#lt-extends-T-gt-lt-super-T-gt" class="headerlink" title="&lt;? extends T&gt; &lt;? super T&gt;"></a><code>&lt;? extends T&gt; &lt;? super T&gt;</code></h3><p>æ³¨æ„è¿™é‡Œçš„Tæ˜¯æ³›å‹å‚æ•°ï¼Œè·Ÿä¸Šé¢çš„<t extends ?> Tä¸ä¸€æ ·</t></p><p>çœ‹å®Œä¸Šé¢çš„ <code>&lt;T extends ?&gt;</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥çœ‹<code>&lt;? extends T&gt; &lt;? super T&gt;</code>ï¼Œå¯èƒ½è¿™é‡Œä½ ä¼šéå¸¸ç–‘æƒ‘ï¼Œå“‡ è¿™ä¸¤ä¸ªæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå…¶å®ç®€å•ç†è§£çš„è¯ï¼Œ<code>&lt;T extends ?&gt;</code>æ˜¯åœ¨ç±»æ–‡ä»¶å±‚é¢å°±é™åˆ¶äº†æ³›å‹çš„èŒƒå›´ï¼Œè€Œ<code>&lt;? extends T&gt; &lt;? super T&gt;</code>æ˜¯åœ¨ä½¿ç”¨æ³›å‹çš„æ—¶å€™å†å»åšé™åˆ¶ã€‚æ˜ç™½äº†è¿™ä¸ªä¹‹åæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹ä¸‹<code>&lt;? extends T&gt; &lt;? super T&gt;</code>çš„ä½¿ç”¨ã€‚</p><p>è®©æˆ‘ä»¬å›åˆ°<code>Firut.class</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Plant</span> &lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T t;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getT</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setT</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.t = t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç°åœ¨ä¸åœ¨å®šä¹‰æ³›å‹ç±»çš„æ—¶å€™åšé™åˆ¶ï¼Œ(ä½¿ç”¨<code>&lt;T&gt;</code>ï¼Œå…¶å®è¿™é‡Œè¿˜æ˜¯ç›¸å½“äº<code>&lt;T extends Object&gt;</code>)ï¼Œè€Œæ˜¯åœ¨ä½¿ç”¨çš„æ˜¯å»åšé™åˆ¶</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹<code>&lt;? extends T&gt;</code>çš„ä½¿ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Plant&lt;Apple&gt; applePlant = new Plant&lt;Apple&gt;();</span><br><span class="line">applePlant.setT(new Apple());</span><br><span class="line">// ä½¿ç”¨ &lt;? extends T&gt;</span><br><span class="line">Plant&lt;? extends Firut&gt; plant = applePlant;</span><br><span class="line"></span><br><span class="line">plant.setT(new Apple()); // æ— æ³•å­˜ ç¼–è¯‘æŠ¥é”™</span><br><span class="line">plant.setT(new Firut()); // æ— æ³•å­˜ ç¼–è¯‘æŠ¥é”™</span><br><span class="line">Firut apple = plant.getT(); // å¯ä»¥è·å–</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å½“<code>&lt;? extends T&gt;</code>åšä¸ºæ¥æ”¶å‚æ•°æ—¶ï¼Œå› ä¸ºå…¶å¿…ç„¶æ˜¯<code>Firut</code>çš„å­ç±»ï¼Œè¿™é‡Œå®ä¾‹ç±»å‹æ˜¯<code>Apple</code>ï¼Œæ‰€ä»¥<code>getT()</code>æ–¹æ³•ä»ç„¶å¯ä»¥ä½¿ç”¨ï¼Œå› ä¸ºä¼šè¿›è¡Œä¸€æ¬¡éšå¼çš„ç±»å‹è½¬æ¢ï¼ˆå‘ä¸Šè½¬å‹æ˜¯å®‰å…¨çš„ï¼‰ï¼Œä½†æ˜¯<code>setT()</code>æ–¹æ³•æ˜¯å¤±æ•ˆçš„ï¼Œè¿™æ˜¯å› ä¸ºç¼–è¯‘å™¨ä¸èƒ½ç¡®å®šä½ ä¸€å®šä¼šå¾€é‡Œé¢æ·»åŠ <code>Apple</code>ç±»å‹ï¼Œå› ä¸ºä½ è¿˜å¯ä»¥å¾€é‡Œé¢æ·»åŠ <code>Banana</code>ç±»å‹ï¼Œæ˜¾ç„¶<code>Banana</code>ç±»å‹æ— æ³•å¼ºè½¬<code>Apple</code>ç±»å‹ï¼Œæ‰€ä»¥è¿™é‡Œçš„<code>setT()</code>æ–¹æ³•æ˜¯å¤±æ•ˆçš„</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹<code>&lt;? super T&gt;</code>çš„ä½¿ç”¨<br>æœ‰äº†ä¸Šé¢<code>&lt;? extends T&gt;</code>çš„ä½¿ç”¨ç»éªŒï¼Œé¡¾æ˜æ€è®®ï¼Œ<code>&lt;? super T&gt;</code>å¿…ç„¶è¡¨ç¤º<code>T</code>çš„å…¨éƒ¨çˆ¶ç±»å‹ï¼Œè¿˜æ˜¯å†æ¥çœ‹ä¸‹<code>&lt;? super T&gt;</code>çš„ä½¿ç”¨å§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Plant&lt;Firut&gt; firutPlant = <span class="keyword">new</span> Plant&lt;&gt;();</span><br><span class="line">Plant&lt;? <span class="keyword">super</span> Apple&gt; plant = firutPlant;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plant.setT(<span class="keyword">new</span> Apple()); <span class="comment">// å¯ä»¥å­˜æˆåŠŸï¼Œä¸è¿‡è¿™é‡Œåªèƒ½å­˜ Appleç±»å‹</span></span><br><span class="line">Apple apple = plant.getT(); <span class="comment">// ç¼–è¯‘æŠ¥é”™</span></span><br><span class="line"></span><br><span class="line">Firut firut = firutPlant.getT();</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å¯ä»¥å­˜æˆåŠŸçš„åŸå› å’Œä¸Šé¢<code>&lt;? extends T&gt;</code>å¯ä»¥å–æˆåŠŸçš„åŸå› ä¸€æ ·ï¼Œä¹Ÿæ˜¯å› ä¸ºå­˜åœ¨ä¸€ä¸ªéšå¼çš„å‘ä¸Šè½¬å‹ï¼Œè€Œè·å–å¤±è´¥çš„åŸå›  ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼Œå› ä¸ºå®é™…ç±»å‹è‚¯å®šæ˜¯<code>Apple</code>çš„çˆ¶ç±»ï¼ˆè¿™é‡Œæ˜¯Firutï¼‰ï¼Œæ‰€ä»¥è¦å°†<code>Firut</code>è½¬æˆ<code>Apple</code>æ˜¾ç„¶æ˜¯ä¸å¯è¡Œçš„ï¼</p><h3 id="lt-gt"><a href="#lt-gt" class="headerlink" title="&lt;?&gt;"></a>&lt;?&gt;</h3><p><code>&lt;?&gt;</code>å…¶å®ç­‰ä»·ä¸<code>&lt;? extends Object&gt;</code>ï¼Œè¿™æ ·å­æˆ‘ç›¸ä¿¡å°±æ¯”è¾ƒå¥½ç†è§£äº†ï¼Œè·Ÿ<code>&lt;? extends T&gt;</code>ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å–å¯ä»¥ï¼Œå­˜è¢«é™åˆ¶</p><p><code>&lt;T&gt;</code>ä¸€èˆ¬éƒ½æ˜¯åœ¨å®šä¹‰æ³›å‹ç±»æˆ–åˆ™æ³›å‹æ–¹æ³•æ—¶å‡ºç°ï¼Œå®é™…ä½¿ç”¨æ—¶éƒ½ä»¥<code>?</code>æˆ–å…·ä½“ç±»å‹æ›¿ä»£<code>T</code></p><h3 id="Type-ä¸-Class-çš„åŒºåˆ«å’Œè”ç³»"><a href="#Type-ä¸-Class-çš„åŒºåˆ«å’Œè”ç³»" class="headerlink" title="Type ä¸ Class çš„åŒºåˆ«å’Œè”ç³»"></a>Type ä¸ Class çš„åŒºåˆ«å’Œè”ç³»</h3><p>è¯´èµ·æ³›å‹ï¼Œä¸å¾—ä¸æJDKåœ¨1.5ä¹‹åå¼•å…¥çš„<code>Type</code>ç±»å‹ï¼Œæ˜¾ç„¶<code>Type</code>æ˜¯<code>Java</code>ä¸ºäº†å®ç°æ³›å‹è€Œå¼•å…¥çš„ã€‚é‚£ä¹ˆ<code>Type</code>åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Œå®ƒè¡¨ç¤ºçš„èŒƒå›´æœ‰å¤šå¤§ï¼Ÿ<br>å…¶å®æˆ‘ä»¬å¯ä»¥ç›´æ¥ç†è§£æŠŠ<code>Class</code>å½“æˆæ˜¯<code>Type</code>çš„å­é›†ï¼Œ<code>Class</code>å¯¹åº”ç€jdk1.5ä¹‹å‰ä¸æ˜¯æ³›å‹çš„åŸå§‹ç±»å‹</p><p><code>Type</code>ä¸‹åŒ…å«äº†å‡ ç§ä¸åŒçš„ç±»å‹</p><ul><li><code>Class</code> åŸå§‹ç±»å‹ï¼Œæˆ‘è¿™é‡Œç›´æ¥ç†è§£æˆæˆ‘ä»¬å¸¸ç”¨çš„<code>Class</code>ç±»å‹ï¼Œ<code>Class</code>æ˜¯<code>Type</code>çš„ç›´æ¥å­ç±»</li><li><code>ParameterizedType</code> å‚æ•°åŒ–ç±»å‹ç±»ä¼¼ <code>List&lt;String&gt; list</code> è·å–listçš„ç±»å‹</li><li><code>TypeVariable</code> ç±»ä¼¼ <code>T t</code></li><li><code>GenericArrayType</code> ç±»ä¼¼ <code>List&lt;String&gt;[]</code> æˆ–åˆ™ <code>List&lt;T&gt; []</code><ul><li><code>GenericArrayType</code> æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•<code>getGenericComponentType</code>ï¼Œç”¨æˆ·è¿”å›<code>ParameterizedType</code>æˆ–åˆ™<code>TypeVariable</code>ç±»å‹</li></ul></li><li><code>WildcardType</code> ç±»ä¼¼ <code>&lt;? super T&gt;</code> è¦å¾—åˆ°è¿™ä¸ªç±»å‹ï¼Œé¦–å…ˆéœ€è¦å¾—åˆ°<code>ParameterizedType</code>ç±»å‹ï¼Œç„¶åé€šè¿‡<code>getActualTypeArguments</code>æ–¹æ³•è·å–<code>WildcardType</code>ç±»å‹</li></ul><p>è¯´äº†è¿™ä¹ˆå¤šï¼Œè¿˜æ˜¯é€šè¿‡å®é™…çš„ä»£ç æ¥è¯¦ç»†è§£é‡Šå§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeTest</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOne</span><span class="params">(Plant&lt;Apple&gt; plant, </span></span></span><br><span class="line"><span class="function"><span class="params">                        Plant&lt;Apple&gt; [] plants, </span></span></span><br><span class="line"><span class="function"><span class="params">                        Plant&lt;? extends Apple&gt; applePlant)</span> </span>&#123;   </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">testOne</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†™æ®µæµ‹è¯•ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Method [] methods = TypeTest.class.getMethods();</span><br><span class="line"><span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">    <span class="keyword">if</span> (method.getName().equals(<span class="string">"testOne"</span>)) &#123;</span><br><span class="line">        Type [] parameterTypes = method.getGenericParameterTypes();</span><br><span class="line">        System.out.println(<span class="string">"methodOne start --------&gt; "</span>);</span><br><span class="line">        <span class="keyword">for</span> (Type type : parameterTypes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">                System.out.println(<span class="string">"Class ---- "</span> + type.getTypeName());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">                System.out.println(<span class="string">"ParameterizedType ---- "</span> + type.getTypeName());</span><br><span class="line">                Type ytpe3[] = ((ParameterizedType) type).getActualTypeArguments();</span><br><span class="line">                <span class="keyword">for</span> (Type type2 : ytpe3) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (type2 <span class="keyword">instanceof</span> WildcardType) &#123;</span><br><span class="line">                        System.out.println(<span class="string">"ParameterizedType-WildcardType  ---- "</span> + type2.getTypeName());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (type <span class="keyword">instanceof</span> GenericArrayType) &#123;</span><br><span class="line">                System.out.println(<span class="string">"GenericArrayType ---- "</span> + type.getTypeName());</span><br><span class="line">                Type type2 = ((GenericArrayType) type).getGenericComponentType();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (type <span class="keyword">instanceof</span> TypeVariable) &#123;</span><br><span class="line">                System.out.println(<span class="string">"TypeVariable ---- "</span> + type.getTypeName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.getName().equals(<span class="string">"testTwo"</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        Type [] parameterTypes = method.getGenericParameterTypes();</span><br><span class="line">        System.out.println(<span class="string">"methodTwo start --------&gt; "</span>);</span><br><span class="line">        <span class="keyword">for</span> (Type type : parameterTypes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type <span class="keyword">instanceof</span> TypeVariable) &#123;</span><br><span class="line">                System.out.println(<span class="string">"TypeVariable ---- "</span> + type.getTypeName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">methodTwo start --------&gt; </span><br><span class="line">TypeVariable ---- T</span><br><span class="line">methodOne start --------&gt; </span><br><span class="line">ParameterizedType ---- com.sunshine.common.test.Plant&lt;com.sunshine.common.test.Apple&gt;</span><br><span class="line">GenericArrayType ---- com.sunshine.common.test.Plant&lt;com.sunshine.common.test.Apple&gt;[]</span><br><span class="line">ParameterizedType ---- com.sunshine.common.test.Plant&lt;? extends com.sunshine.common.test.Apple&gt;</span><br><span class="line">ParameterizedType-WildcardType  ---- ? extends com.sunshine.common.test.Apple</span><br></pre></td></tr></table></figure><h2 id="ä»€ä¹ˆæƒ…å†µå¯ä»¥æ‹¿åˆ°æ³›å‹ç±»å‹"><a href="#ä»€ä¹ˆæƒ…å†µå¯ä»¥æ‹¿åˆ°æ³›å‹ç±»å‹" class="headerlink" title="ä»€ä¹ˆæƒ…å†µå¯ä»¥æ‹¿åˆ°æ³›å‹ç±»å‹"></a>ä»€ä¹ˆæƒ…å†µå¯ä»¥æ‹¿åˆ°æ³›å‹ç±»å‹</h2><p>å…ˆçœ‹å¯ä»¥æ‹¿åˆ°æ³›å‹çš„æƒ…å½¢ï¼Œä¸ä¸Šé¢çš„ä¾‹å­ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥è·å–æ–¹æ³•å…¥å‚ï¼Œè¶…ç±»çš„å‚æ•°åŒ–ç±»å‹ï¼Œä¸¾ä¸ªä¾‹å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SuperPlant</span> <span class="title">extend</span> <span class="title">Plant</span>&lt;<span class="title">Apple</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAll</span><span class="params">(List&lt;Apple&gt; apples)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–çˆ¶ç±»å‚æ•°åŒ–ç±»å‹</span></span><br><span class="line">    Type type = SuperPlant.class.getGenericSuperclass();</span><br><span class="line">    Method[] methods = SuperPlant.class.getMethods();</span><br><span class="line">        <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">            <span class="comment">// è·å–æ–¹æ³•å‚æ•°åŒ–ç±»å‹</span></span><br><span class="line">            Type[] types = method.getGenericParameterTypes();</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ä»¥ä¸Šä»£ç æ˜¯å¯ä»¥è·å–åˆ°æ³›å‹ç±»å‹ã€‚é€šè¿‡<code>getGenericSuperclass</code>è·å–åˆ°çˆ¶ç±»çš„å‚æ•°åŒ–ç±»å‹ï¼Œmethodçš„<code>getGenericParameterTypes</code>è·å–åˆ°å…¥å‚çš„å‚æ•°åŒ–ç±»å‹æ•°ç»„ã€‚</p><p>å†çœ‹ä¸€ç§æƒ…å†µ<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Plant&lt;Firut&gt; firutPlant = <span class="keyword">new</span> Plant&lt;&gt;();</span><br><span class="line">  <span class="comment">// è¿™é‡Œå¯ä»¥æ‹¿åˆ° firutPlant å¯¹è±¡çš„æ³›å‹å—?</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ˜¯æ‹¿ä¸åˆ° firutPlant çš„æ³›å‹çš„ï¼Œå› ä¸ºJAVA åœ¨å°†å…¶ç¼–è¯‘æˆå­—èŠ‚ç çš„æ—¶å€™ï¼Œå®é™…ä¸Šä¼šå˜æˆ <code>Plant&lt;Object&gt;</code>ç±»å‹ï¼Œæ³›å‹ä¼šè¢«æ“¦é™¤ã€‚</p><p><strong>æ‰€ä»¥æˆ‘ä»¬å…¶å®æ˜¯æ— æ³•åœ¨è¿è¡Œæ—¶é€šè¿‡æ³›å‹å¯¹è±¡æœ¬èº«æ‹¿åˆ°æ³›å‹ç±»å‹çš„ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰é»‘ç§‘æŠ€å¯ä»¥æ‹¿åˆ°è¿è¡Œæ—¶æ³›å‹æœ¬èº«çš„æ³›å‹ä¿¡æ¯ï¼Ÿä¸Šé¢æœ‰æåˆ°ï¼Œæˆ‘ä»¬æ‹¿æ³›å‹å¯ä»¥é€šè¿‡å­ç±»æ¥è·å–çˆ¶ç±»çš„æ³›å‹</strong><br>æˆ‘ä»¬ä¾æ®è¿™ä¸ªæ€è·¯å°†ä¸Šé¢ä¾‹å­ä¿®æ”¹ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Type type = <span class="keyword">new</span> Plant&lt;Firut&gt;() &#123;&#125;.getClass().getGenericSuperclass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯å°†Plantæ”¹æˆäº†åŒ¿åç±»æ–¹å¼å®ç°ï¼Œè¿™ç§æ–¹å¼å¯ä»¥æ‹¿åˆ°Plantçš„æ³›å‹ä¿¡æ¯å—ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„<br>è¿™é‡Œé€šè¿‡<code>getGenericSuperclass</code>æ‹¿åˆ°çš„å°±æ˜¯Plant<firut> çš„æ³›å‹ç±»å‹ä¿¡æ¯ã€‚å…¶å®è¿™ç§æ–¹å¼åœ¨å¾ˆå¤šæ¡†æ¶æºç é‡Œå¾ˆå¸¸è§ï¼Œé€šè¿‡åŒ¿åç±»æ–¹å¼è·å–å‚æ•°ç±»å‹ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸‹<code>Gson</code>çš„<code>TypeToken</code>çš„å®ç°ï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„åŸç†ã€‚</firut></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;è®°å½•åŸç”±&quot;&gt;&lt;a href=&quot;#è®°å½•åŸç”±&quot; class=&quot;headerlink&quot; title=&quot;è®°å½•åŸç”±&quot;&gt;&lt;/a&gt;è®°å½•åŸç”±&lt;/h2&gt;&lt;p&gt;ä¹‹å‰è™½ç„¶æ³›å‹ä¸€ç›´åœ¨ä½¿ç”¨ï¼Œä½†ä½¿ç”¨çš„è¿‡ç¨‹ä¸­æ€»æ˜¯æ²¡æœ‰é‚£ä¹ˆå¾—å¿ƒåº”æ‰‹ï¼Œæœ‰äº›ç»†èŠ‚è¿˜æ˜¯è¿‡äºæ¨¡ç³Šã€‚ç©¶å…¶åŸå› å…¶å®æ˜¯ä¸€ç›´éƒ½æ²¡æœ‰ç³»ç»Ÿæ·±å…¥çš„å»ç†è§£è¿‡
      
    
    </summary>
    
      <category term="javaåŸºç¡€" scheme="http://wangjunnan.github.io/categories/java%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="javaåŸºç¡€" scheme="http://wangjunnan.github.io/tags/java%E5%9F%BA%E7%A1%80/"/>
    
  </entry>
  
  <entry>
    <title>Javaå­—èŠ‚ç æ–¹æ³•è¡¨</title>
    <link href="http://wangjunnan.github.io/2019/04/25/Java%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%B9%E6%B3%95%E8%A1%A8/"/>
    <id>http://wangjunnan.github.io/2019/04/25/Javaå­—èŠ‚ç æ–¹æ³•è¡¨/</id>
    <published>2019-04-25T07:50:02.000Z</published>
    <updated>2019-09-27T05:52:47.703Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>å› ä¸ºå­—æ®µè¡¨å’Œæ–¹æ³•è¡¨çš„ç»“æ„ç±»ä¼¼ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥åˆ†æJavaå­—èŠ‚ç çš„æ–¹æ³•è¡¨å†…å®¹ï¼Œç†è§£äº†æ–¹æ³•è¡¨ï¼Œè‡ªç„¶å°±ç†è§£äº†å­—æ®µè¡¨</p><h2 id="æ–¹æ³•è¡¨"><a href="#æ–¹æ³•è¡¨" class="headerlink" title="æ–¹æ³•è¡¨"></a>æ–¹æ³•è¡¨</h2><p>æ–¹æ³•è¡¨åœ¨<code>Class</code>æ–‡ä»¶ä¸­çš„ä½ç½®æ˜¯åœ¨å­—æ®µè¡¨ä¹‹åçš„ï¼Œå…·ä½“çš„ç»“æ„æˆ‘ä»¬æ ¹æ®ä¸‹è¡¨å†æ¥å›é¡¾ä¸€ä¸‹</p><table><thead><tr><th>ç±»å‹</th><th>åç§°</th><th>æ•°é‡ </th></tr></thead><tbody><tr><td>u2</td><td>access_flas</td><td>1 </td></tr><tr><td>u2</td><td>name_index</td><td>1</td></tr><tr><td>u2</td><td>descriptor_index</td><td>1</td></tr><tr><td>u2</td><td>attributes_count</td><td>1</td></tr><tr><td>attribute_info</td><td>å±æ€§è¡¨</td><td>attributes_count</td></tr></tbody></table><p>è¿˜æ˜¯è·Ÿä¸Šç¯‡æ–‡ç« ä¸€æ ·ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªç®€å•çš„Javaç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> String sayStr = <span class="string">"hello world"</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> sayStr;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> Test test = <span class="keyword">new</span> Test();</span><br><span class="line"></span><br><span class="line"> System.out.println(test.sayHello());</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>javap</code>ç¿»è¯‘å­—èŠ‚ç æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class com.ymm.agent.Test</span><br><span class="line"></span><br><span class="line"> minor version: 0</span><br><span class="line"></span><br><span class="line"> major version: 52</span><br><span class="line"></span><br><span class="line"> flags: (0x0021) ACC_PUBLIC, ACC_SUPER</span><br><span class="line"></span><br><span class="line"> this_class: #3 // com/ymm/agent/Test</span><br><span class="line"></span><br><span class="line"> super_class: #8  // java/lang/Object</span><br><span class="line"></span><br><span class="line"> interfaces: 0, fields: 0, methods: 3, attributes: 1</span><br><span class="line"></span><br><span class="line">Constant pool:</span><br><span class="line"></span><br><span class="line"> #1 = Methodref #8.#27  // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line"></span><br><span class="line"> #2 = String  #28 // hello world</span><br><span class="line"></span><br><span class="line"> #3 = Class #29 // com/ymm/agent/Test</span><br><span class="line"></span><br><span class="line"> #4 = Methodref #3.#27  // com/ymm/agent/Test.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line"></span><br><span class="line"> #5 = Fieldref  #30.#31 // java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line"></span><br><span class="line"> #6 = Methodref #3.#32  // com/ymm/agent/Test.sayHello:()Ljava/lang/String;</span><br><span class="line"></span><br><span class="line"> #7 = Methodref #33.#34 // java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line"> #8 = Class #35 // java/lang/Object</span><br><span class="line"></span><br><span class="line"> #9 = Utf8  &lt;init&gt;</span><br><span class="line"></span><br><span class="line"> #10 = Utf8  ()V</span><br><span class="line"></span><br><span class="line"> #11 = Utf8  Code</span><br><span class="line"></span><br><span class="line"> #12 = Utf8  LineNumberTable</span><br><span class="line"></span><br><span class="line"> #13 = Utf8  LocalVariableTable</span><br><span class="line"></span><br><span class="line"> #14 = Utf8  this</span><br><span class="line"></span><br><span class="line"> #15 = Utf8  Lcom/ymm/agent/Test;</span><br><span class="line"></span><br><span class="line"> #16 = Utf8  sayHello</span><br><span class="line"></span><br><span class="line"> #17 = Utf8  ()Ljava/lang/String;</span><br><span class="line"></span><br><span class="line"> #18 = Utf8  sayStr</span><br><span class="line"></span><br><span class="line"> #19 = Utf8  Ljava/lang/String;</span><br><span class="line"></span><br><span class="line"> #20 = Utf8  main</span><br><span class="line"></span><br><span class="line"> #21 = Utf8  ([Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line"> #22 = Utf8  args</span><br><span class="line"></span><br><span class="line"> #23 = Utf8  [Ljava/lang/String;</span><br><span class="line"></span><br><span class="line"> #24 = Utf8  test</span><br><span class="line"></span><br><span class="line"> #25 = Utf8  SourceFile</span><br><span class="line"></span><br><span class="line"> #26 = Utf8  Test.java</span><br><span class="line"></span><br><span class="line"> #27 = NameAndType #9:#10  // &quot;&lt;init&gt;&quot;:()V</span><br><span class="line"></span><br><span class="line"> #28 = Utf8  hello world</span><br><span class="line"></span><br><span class="line"> #29 = Utf8  com/ymm/agent/Test</span><br><span class="line"></span><br><span class="line"> #30 = Class #36 // java/lang/System</span><br><span class="line"></span><br><span class="line"> #31 = NameAndType #37:#38 // out:Ljava/io/PrintStream;</span><br><span class="line"></span><br><span class="line"> #32 = NameAndType #16:#17 // sayHello:()Ljava/lang/String;</span><br><span class="line"></span><br><span class="line"> #33 = Class #39 // java/io/PrintStream</span><br><span class="line"></span><br><span class="line"> #34 = NameAndType #40:#41 // println:(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line"> #35 = Utf8  java/lang/Object</span><br><span class="line"></span><br><span class="line"> #36 = Utf8  java/lang/System</span><br><span class="line"></span><br><span class="line"> #37 = Utf8  out</span><br><span class="line"></span><br><span class="line"> #38 = Utf8  Ljava/io/PrintStream;</span><br><span class="line"></span><br><span class="line"> #39 = Utf8  java/io/PrintStream</span><br><span class="line"></span><br><span class="line"> #40 = Utf8  println</span><br><span class="line"></span><br><span class="line"> #41 = Utf8  (Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"> public com.ymm.agent.Test();</span><br><span class="line"></span><br><span class="line"> descriptor: ()V</span><br><span class="line"></span><br><span class="line"> flags: (0x0001) ACC_PUBLIC</span><br><span class="line"></span><br><span class="line"> Code:</span><br><span class="line"></span><br><span class="line"> stack=1, locals=1, args_size=1</span><br><span class="line"></span><br><span class="line"> 0: aload_0</span><br><span class="line"></span><br><span class="line"> 1: invokespecial #1 // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line"></span><br><span class="line"> 4: return</span><br><span class="line"></span><br><span class="line"> LineNumberTable:</span><br><span class="line"></span><br><span class="line"> line 9: 0</span><br><span class="line"></span><br><span class="line"> LocalVariableTable:</span><br><span class="line"></span><br><span class="line"> Start Length Slot Name  Signature</span><br><span class="line"></span><br><span class="line"> 0  5  0 this  Lcom/ymm/agent/Test;</span><br><span class="line"></span><br><span class="line"> public java.lang.String sayHello();</span><br><span class="line"></span><br><span class="line"> descriptor: ()Ljava/lang/String;</span><br><span class="line"></span><br><span class="line"> flags: (0x0001) ACC_PUBLIC</span><br><span class="line"></span><br><span class="line"> Code:</span><br><span class="line"></span><br><span class="line"> stack=1, locals=2, args_size=1</span><br><span class="line"></span><br><span class="line"> 0: ldc  #2 // String hello world</span><br><span class="line"></span><br><span class="line"> 2: astore_1</span><br><span class="line"></span><br><span class="line"> 3: aload_1</span><br><span class="line"></span><br><span class="line"> 4: areturn</span><br><span class="line"></span><br><span class="line"> LineNumberTable:</span><br><span class="line"></span><br><span class="line"> line 12: 0</span><br><span class="line"></span><br><span class="line"> line 13: 3</span><br><span class="line"></span><br><span class="line"> LocalVariableTable:</span><br><span class="line"></span><br><span class="line"> Start Length Slot Name  Signature</span><br><span class="line"></span><br><span class="line"> 0  5  0 this  Lcom/ymm/agent/Test;</span><br><span class="line"></span><br><span class="line"> 3  2  1 sayStr  Ljava/lang/String;</span><br><span class="line"></span><br><span class="line"> public static void main(java.lang.String[]);</span><br><span class="line"></span><br><span class="line"> descriptor: ([Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line"> flags: (0x0009) ACC_PUBLIC, ACC_STATIC</span><br><span class="line"></span><br><span class="line"> Code:</span><br><span class="line"></span><br><span class="line"> stack=2, locals=2, args_size=1</span><br><span class="line"></span><br><span class="line"> 0: new  #3 // class com/ymm/agent/Test</span><br><span class="line"></span><br><span class="line"> 3: dup</span><br><span class="line"></span><br><span class="line"> 4: invokespecial #4 // Method &quot;&lt;init&gt;&quot;:()V</span><br><span class="line"></span><br><span class="line"> 7: astore_1</span><br><span class="line"></span><br><span class="line"> 8: getstatic  #5 // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line"></span><br><span class="line"> 11: aload_1</span><br><span class="line"></span><br><span class="line"> 12: invokevirtual #6 // Method sayHello:()Ljava/lang/String;</span><br><span class="line"></span><br><span class="line"> 15: invokevirtual #7 // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line"> 18: return</span><br><span class="line"></span><br><span class="line"> LineNumberTable:</span><br><span class="line"></span><br><span class="line"> line 17: 0</span><br><span class="line"></span><br><span class="line"> line 18: 8</span><br><span class="line"></span><br><span class="line"> line 19: 18</span><br><span class="line"></span><br><span class="line"> LocalVariableTable:</span><br><span class="line"></span><br><span class="line"> Start Length Slot Name  Signature</span><br><span class="line"></span><br><span class="line"> 0 19  0 args  [Ljava/lang/String;</span><br><span class="line"></span><br><span class="line"> 8 11  1 test  Lcom/ymm/agent/Test;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SourceFile: &quot;Test.java&quot;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šæ–‡çš„<code>interfaces: 0, fields: 0, methods: 3, attributes: 1</code>ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“è¯¥æ–‡ä»¶ä¸€å…±åŒ…å«<code>3</code>ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«å¯¹åº”ç€<code>æ— å‚æ„é€ </code>,<code>sayHello</code>,<code>main</code>ä¸‰ä¸ªæ–¹æ³•</p><p>å¥½äº†ï¼Œç°åœ¨è®©æˆ‘ä»¬ç›´æ¥ç•¥è¿‡å‰é¢çš„ä¸€å¤§æ¨å¸¸é‡æ± é¡¹ï¼Œ</p><p>ç›´æ¥é˜…è¯»æˆ‘ä»¬è‡ªå·±å†™çš„<code>sayHello</code>æ–¹æ³•çš„å­—èŠ‚ç å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public java.lang.String sayHello();</span><br><span class="line"></span><br><span class="line"> descriptor: ()Ljava/lang/String; /* æ–¹æ³•æè¿°ç¬¦ */</span><br><span class="line"></span><br><span class="line"> flags: (0x0001) ACC_PUBLIC /* è®¿é—®æ ‡è¯† */</span><br><span class="line"></span><br><span class="line"> Code: /* codeå±æ€§  ä¹Ÿå°±æ˜¯æˆ‘ä»¬å†™çš„å…·ä½“ä»£ç ç¿»è¯‘æˆçš„å­—èŠ‚ç æŒ‡ä»¤å†…å®¹ */</span><br><span class="line"></span><br><span class="line"> stack=1, locals=2, args_size=1 /* åˆ†åˆ«æŒ‡æ“ä½œæ•°æ ˆæ·±åº¦ï¼›æœ¬åœ°å˜é‡æ‰€éœ€çš„å­˜å‚¨ç©ºé—´ï¼ˆslotä¸ºå•ä½ï¼‰ï¼›å‚æ•°ä¸ªæ•° */</span><br><span class="line"></span><br><span class="line"> 0: ldc  #2 // String hello world /*å°†ä¸€ä¸ªå¸¸é‡åŠ è½½åˆ°æ“ä½œæ•°æ ˆ*/</span><br><span class="line"></span><br><span class="line"> 2: astore_1 /* å°†ä¸€ä¸ªæ•°å€¼ä»æ“ä½œæ•°æ ˆå­˜å‚¨åˆ°å±€éƒ¨å˜é‡è¡¨ */</span><br><span class="line"></span><br><span class="line"> 3: aload_1 /* å°†ä¸€ä¸ªæ•°å€¼ä»å±€éƒ¨å˜é‡è¡¨åŠ è½½åˆ°æ“ä½œæ•°æ ˆ */</span><br><span class="line"></span><br><span class="line"> 4: areturn /* å°†æ ˆé¡¶ç¬¬ä¸€ä¸ªå…ƒç´ è¿”å› */</span><br><span class="line"></span><br><span class="line"> LineNumberTable: /* å­—èŠ‚ç ä¸javaä»£ç è¡Œæ•°å¯¹åº”å…³ç³» ä¸€èˆ¬ç”¨äºè°ƒè¯• */</span><br><span class="line"></span><br><span class="line"> line 12: 0</span><br><span class="line"></span><br><span class="line"> line 13: 3</span><br><span class="line"></span><br><span class="line"> LocalVariableTable: /* å±€éƒ¨å˜é‡è¡¨ */</span><br><span class="line"></span><br><span class="line"> Start Length Slot Name  Signature</span><br><span class="line"></span><br><span class="line"> 0  5  0 this  Lcom/ymm/agent/Test;</span><br><span class="line"></span><br><span class="line"> 3  2  1 sayStr  Ljava/lang/String;</span><br></pre></td></tr></table></figure><p>æ ¹æ®ä¸Šè¡¨æˆ‘ä»¬çŸ¥é“æ–¹æ³•è¡¨çš„ç¬¬ä¸€ä¸ªå†…å®¹çš„æ˜¯<code>access_flas</code>ï¼Œå ä¸€ä¸ªå­—èŠ‚ã€‚è¡¨ä¸­çš„<code>access_flas</code>å…¶å®å°±å¯¹åº”ç€ä¸Šæ–‡ä¸­çš„  <code>flags: (0x0001) ACC_PUBLIC</code>ï¼Œæ ‡è¯†è¿™ä¸ªæ–¹æ³•æ˜¯<code>public</code>çš„ï¼Œæ¥ä¸‹åœ¨çš„<code>name_index</code>å’Œ<code>descriptor_index</code>ï¼Œåœ¨ä¸Šæ–‡ä¸­çš„ä½“ç°åˆ†åˆ«å¯¹åº”ç€<code>sayHello</code>å’Œ<code>()Ljava/lang/String;</code>ã€‚</p><p>è¿™é‡Œè§£é‡Šä¸€ä¸‹æè¿°ç¬¦çš„æ¦‚å¿µï¼Œåœ¨ä»‹ç»<code>Classæ–‡ä»¶ç»“æ„</code>çš„æ–‡ç« ä¸­æœ‰æåˆ°ï¼Œè¿™é‡Œå†æä¸€é:</p><p><strong>æè¿°ç¬¦çš„ä½œç”¨æ˜¯ç”¨æ¥æè¿°å­—æ®µçš„æ•°æ®ç±»å‹ï¼Œæ–¹æ³•çš„å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼</strong>ï¼Œæ ¹æ®æè¿°ç¬¦è§„åˆ™ï¼ŒåŸºæœ¬æ•°æ®ç±»å‹ï¼ˆbyte,char,int,long,float,double,short,booleanï¼‰ä»¥åŠä»£è¡¨æ— è¿”å›å€¼çš„<code>void</code>ç±»å‹éƒ½ç”¨ä¸€ä¸ªå¤§å†™å­—ç¬¦æ¥è¡¨ç¤ºï¼Œè€Œå¯¹è±¡ç±»å‹åˆ™ç”¨<code>L</code>åŠ å¯¹è±¡çš„å…¨é™å®šåæ¥è¡¨ç¤º</p><p>æœ€é‡è¦çš„å†…å®¹å…¶å®è¿˜æ˜¯åœ¨<code>attribute_info</code>å±æ€§è¡¨ä¸­çš„<code>code</code>å†…å®¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å†™çš„å…·ä½“ä»£ç ç¿»è¯‘æˆçš„å­—èŠ‚ç æŒ‡ä»¤å†…å®¹ï¼Œè¿™å—å†…å®¹æ˜¯æˆ‘ä»¬é˜…è¯»å­—èŠ‚ç æ–‡ä»¶çš„é‡ä¸­ä¹‹é‡ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥é˜…è¯»ä¸€ä¸‹ä¸Šæ–‡çš„å­—èŠ‚ç å†…å®¹</p><ol><li><p>ldc #2 å°†å¸¸é‡æ± ä¸­ç´¢å¼•ä¸º2çš„å­—ç¬¦ä¸²åŠ è½½åˆ°æ“ä½œæ•°æ ˆé¡¶</p></li><li><p>astore_1 å°†ä¸€ä¸ªæ•°å€¼ä»æ“ä½œæ•°æ ˆå­˜å‚¨åˆ°å±€éƒ¨å˜é‡è¡¨</p></li><li><p>aload_1 å°†ä¸€ä¸ªæ•°å€¼ä»å±€éƒ¨å˜é‡è¡¨åŠ è½½åˆ°æ“ä½œæ•°æ ˆ</p></li><li><p>areturn å°†æ ˆé¡¶ç¬¬ä¸€ä¸ªå…ƒç´ è¿”å›</p></li></ol><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„å››ä¸ªæ­¥éª¤çš„æ“ä½œå…¶å®éƒ½æ˜¯åŸºäºæ ˆçš„æ“ä½œï¼Œè¿™é‡Œæä¸€ä¸‹javaè™šæ‹Ÿæœºæ ˆçš„æ ˆå¸§ç»“æ„</p><p><img src="http://upload-images.jianshu.io/upload_images/2717496-0b89369329932afb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>å…³äºå­—èŠ‚ç å­ä»¤é›†å¯ä»¥å‚è€ƒ<a href="https://blog.csdn.net/zqz_zqz/article/details/79484757" target="_blank" rel="noopener"><a href="https://blog.csdn.net/zqz_zqz/article/details/79484757" target="_blank" rel="noopener">javaå­—èŠ‚ç å­ä»¤é›†</a></a></p><h2 id="æœ‰è¶£çš„ä¾‹å­-â€”"><a href="#æœ‰è¶£çš„ä¾‹å­-â€”" class="headerlink" title="æœ‰è¶£çš„ä¾‹å­ â€”"></a>æœ‰è¶£çš„ä¾‹å­ â€”</h2><p>ä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªæœ‰è¶£çš„ä¾‹å­ï¼Œå¤§å®¶æ€è€ƒä¸€ä¸‹è¿™ä¸ªæ‰§è¡Œè¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼ä¼šæ˜¯å¤šå°‘ï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class Test &#123;</span><br><span class="line"></span><br><span class="line"> public int inc() &#123;</span><br><span class="line"></span><br><span class="line"> int x;</span><br><span class="line"></span><br><span class="line"> try &#123;</span><br><span class="line"></span><br><span class="line"> x = 1;</span><br><span class="line"></span><br><span class="line"> return x;</span><br><span class="line"></span><br><span class="line"> &#125; catch (Exception e) &#123;</span><br><span class="line"></span><br><span class="line"> x = 2;</span><br><span class="line"></span><br><span class="line"> return x;</span><br><span class="line"></span><br><span class="line"> &#125; finally &#123;</span><br><span class="line"></span><br><span class="line"> x = 3;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç éå¸¸ç®€å•ï¼Œæˆ‘æƒ³å¤§å®¶åº”è¯¥ä¹Ÿéƒ½çŸ¥é“æ­£ç¡®ç­”æ¡ˆï¼Œå½“æ²¡æœ‰å‡ºç°å¼‚å¸¸çš„æ—¶å€™ï¼Œè¿”å›å€¼ä¸º1ï¼Œå‡ºç°å¼‚å¸¸çš„è¯åˆ™ä¸º2ï¼ˆå½“ç„¶è¿™é‡Œä¸ä¼šæŠ›å¼‚å¸¸ï¼‰ã€‚å¯æ˜¯å¦‚æœæˆ‘ä»¬åœ¨finallyå¿«é‡ŒåŠ å¥ä»£ç <code>System.out.prinln(&quot;do it&quot;)</code>ï¼Œç„¶åå†æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œå…¶å®æ˜¯å¯ä»¥çœ‹åˆ°<code>do it</code>è¢«æ‰“å°äº†ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ‰§è¡Œ<code>return</code>ä¹‹å‰ï¼Œfinallyå¿«ä¸­çš„ä»£ç æ˜¯è¢«æ‰§è¡Œäº†çš„ï¼Œé‚£ä¹ˆè¿™é‡Œå°±æœ‰ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜äº†ï¼Œä¸ºä½•è¿”å›ä»ç„¶æ˜¯2è€Œä¸æ˜¯3å‘¢ï¼Ÿ</p><p>ä¸‹é¢æˆ‘ä»¬å°±ä»å­—èŠ‚ç æ–‡ä»¶ä¸­æ¥æ‰¾å‡ºç­”æ¡ˆ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public int inc();</span><br><span class="line"></span><br><span class="line"> descriptor: ()I</span><br><span class="line"></span><br><span class="line"> flags: (0x0001) ACC_PUBLIC</span><br><span class="line"></span><br><span class="line"> Code:</span><br><span class="line"></span><br><span class="line"> stack=1, locals=5, args_size=1</span><br><span class="line"></span><br><span class="line"> 0: iconst_1 // å°†int = 1çš„å€¼å‹å…¥æ ˆé¡¶</span><br><span class="line"></span><br><span class="line"> 1: istore_1 // å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå­˜å…¥ä½ç½®ä¸º1çš„å±€éƒ¨å˜é‡è¡¨</span><br><span class="line"></span><br><span class="line"> 2: iload_1 // ä»ä½ç½®ä¸º1çš„å±€éƒ¨å˜é‡ä¸­å–å‡ºå…ƒç´ å‹å…¥æ ˆé¡¶</span><br><span class="line"></span><br><span class="line"> 3: istore_2 // å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå­˜å…¥ä½ç½®2çš„å±€éƒ¨å˜é‡ä¸­</span><br><span class="line"></span><br><span class="line"> 4: iconst_3 // å°†int = 3çš„å€¼å‹å…¥æ ˆé¡¶ ï¼ˆè¿™é‡Œæ‰§è¡Œfinallyå—ä¸­çš„ä»£ç äº†ï¼‰</span><br><span class="line"></span><br><span class="line"> 5: istore_1 // å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå­˜å…¥ä½ç½®1çš„å±€éƒ¨å˜é‡ä¸­</span><br><span class="line"></span><br><span class="line"> 6: iload_2 // ä»ä½ç½®ä¸º2çš„å±€éƒ¨å˜é‡ä¸­å–å‡ºå…ƒç´ å‹å…¥æ ˆé¡¶</span><br><span class="line"></span><br><span class="line"> 7: ireturn // è¿”å›æ ˆé¡¶å…ƒç´ 2 (å“ˆå“ˆå“ˆ  çœ‹åˆ°æ²¡æœ‰ï¼Œè¿™é‡Œè¿”å›çš„æ˜¯2ï¼Œæ²¡æœ‰å¼‚å¸¸çš„è¯ï¼Œè¿™é‡Œæ–¹æ³•å°±è¿”å›äº†)</span><br><span class="line"></span><br><span class="line"> 8: astore_2 // å°†æ ˆé¡¶çš„å¼‚å¸¸å¼•ç”¨ï¼Œå­˜å…¥ä½ç½®2çš„å±€éƒ¨å˜é‡ä¸­  ï¼ˆè¿™é‡Œå°±æ˜¯å¼‚å¸¸æ•è·çš„ä»£ç äº†ï¼‰</span><br><span class="line"></span><br><span class="line"> 9: iconst_2 // å°†int = 2çš„å€¼å‹å…¥æ ˆé¡¶</span><br><span class="line"></span><br><span class="line"> 10: istore_1 // å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå­˜å…¥ä½ç½®1çš„å±€éƒ¨å˜é‡ä¸­</span><br><span class="line"></span><br><span class="line"> 11: iload_1 // ä»ä½ç½®ä¸º1çš„å±€éƒ¨å˜é‡ä¸­å–å‡ºå…ƒç´ å‹å…¥æ ˆé¡¶</span><br><span class="line"></span><br><span class="line"> 12: istore_3 // å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå­˜å…¥ä½ç½®3çš„å±€éƒ¨å˜é‡ä¸­</span><br><span class="line"></span><br><span class="line"> 13: iconst_3 // å°†int = 3çš„å€¼å‹å…¥æ ˆé¡¶</span><br><span class="line"></span><br><span class="line"> 14: istore_1 // å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå­˜å…¥ä½ç½®1çš„å±€éƒ¨å˜é‡ä¸­</span><br><span class="line"></span><br><span class="line"> 15: iload_3 // ä»ä½ç½®ä¸º3çš„å±€éƒ¨å˜é‡ä¸­å–å‡ºå…ƒç´ å‹å…¥æ ˆé¡¶</span><br><span class="line"></span><br><span class="line"> 16: ireturn // è¿”å›æ ˆé¡¶å…ƒç´  2</span><br><span class="line"></span><br><span class="line"> 17: astore 4 // å°†æ ˆé¡¶å¼‚å¸¸å¼•ç”¨å­˜å…¥ä½ç½®ä¸º4çš„å±€éƒ¨å˜é‡è¡¨ä¸­</span><br><span class="line"></span><br><span class="line"> 19: iconst_3 // å°†int = 3çš„å€¼å‹å…¥æ ˆé¡¶</span><br><span class="line"></span><br><span class="line"> 20: istore_1 // å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå­˜å…¥ä½ç½®1çš„å±€éƒ¨å˜é‡ä¸­</span><br><span class="line"></span><br><span class="line"> 21: aload  4 å°†ä½ç½®ä¸º4çš„å±€éƒ¨å˜é‡å¼•ç”¨å‹å…¥æ ˆé¡¶</span><br><span class="line"></span><br><span class="line"> 23: athrow // å°†æ ˆé¡¶çš„å¼‚å¸¸æŠ›å‡º</span><br><span class="line"></span><br><span class="line"> Exception table: // å¼‚å¸¸è¡¨</span><br><span class="line"></span><br><span class="line"> from to target type</span><br><span class="line"></span><br><span class="line"> 0  4  8  Class java/lang/Exception</span><br><span class="line"></span><br><span class="line"> 0  4 17  any</span><br><span class="line"></span><br><span class="line"> 8 13 17  any</span><br><span class="line"></span><br><span class="line"> 17 19 17  any</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ å·²ç»çœ‹æ‡‚äº†ä¸Šé¢çš„å­—èŠ‚ç ï¼Œä½ åº”è¯¥ä¼šè±æœ—å¼€æœ—ã€‚åŸå› å…¶å®å°±æ˜¯åœ¨äºè¿™é‡Œå¼€è¾Ÿäº†ä¸¤ä¸ªå±€éƒ¨å˜é‡ï¼Œ<code>finally</code>å—ä¸­çš„ä»£ç ä¹Ÿç¡®å®æ‰§è¡Œäº†ï¼Œåªæ˜¯å°†å˜é‡å­˜å…¥äº†å±€éƒ¨å˜é‡è¡¨ä¸­çš„å¦ä¸€ä¸ªä½ç½®ï¼Œå¹¶ä¸”é€šè¿‡è¿™ä¸ªä¾‹å­ï¼Œä¹Ÿå¯ä»¥å‘ç°ï¼Œæ— è®ºä»€ä¹ˆæƒ…å†µ<code>finally</code>å—ä¸­çš„ä»£ç éƒ½ä¼šæ‰§è¡Œã€‚</p><h2 id="å°¾è¨€"><a href="#å°¾è¨€" class="headerlink" title="å°¾è¨€"></a>å°¾è¨€</h2><p>å¥½äº†ï¼Œæœ¬æ–‡åˆ°è¿™é‡Œå°±å·®ä¸å¤šç»“æŸäº†ã€‚å¯¹äºå­—èŠ‚ç çš„æ¢ç´¢ä¸ªäººè§‰çš„è¿˜æ˜¯éå¸¸æœ‰æ„æ€çš„ï¼Œä¹‹ååº”è¯¥ä¹Ÿä¼šæ¢ç´¢æ›´å¤šæœ‰æ„æ€çš„ä¸œè¥¿</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;å› ä¸ºå­—æ®µè¡¨å’Œæ–¹æ³•è¡¨çš„ç»“æ„ç±»ä¼¼ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥åˆ†æJavaå­—èŠ‚ç çš„æ–¹æ³•è¡¨å†…å®¹ï¼Œç†è§£äº†æ–¹æ³•è¡¨ï¼Œè‡ªç„¶å°±ç†è§£äº†å­—æ®µè¡¨&lt;/p&gt;
&lt;h2 id=&quot;æ–¹æ³•è¡¨&quot;
      
    
    </summary>
    
      <category term="javaåŸºç¡€" scheme="http://wangjunnan.github.io/categories/java%E5%9F%BA%E7%A1%80/"/>
    
      <category term="JVM" scheme="http://wangjunnan.github.io/categories/java%E5%9F%BA%E7%A1%80/JVM/"/>
    
      <category term="javaå­—èŠ‚ç " scheme="http://wangjunnan.github.io/categories/java%E5%9F%BA%E7%A1%80/JVM/java%E5%AD%97%E8%8A%82%E7%A0%81/"/>
    
    
      <category term="JVM" scheme="http://wangjunnan.github.io/tags/JVM/"/>
    
      <category term="javaå­—èŠ‚ç " scheme="http://wangjunnan.github.io/tags/java%E5%AD%97%E8%8A%82%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨Java NIOå®ç°ä¸€ä¸ªHTTPæœåŠ¡å™¨</title>
    <link href="http://wangjunnan.github.io/2019/04/19/%E4%BD%BF%E7%94%A8Java-NIO%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAHTTP%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    <id>http://wangjunnan.github.io/2019/04/19/ä½¿ç”¨Java-NIOå®ç°ä¸€ä¸ªHTTPæœåŠ¡å™¨/</id>
    <published>2019-04-19T03:04:30.000Z</published>
    <updated>2019-09-27T05:52:47.719Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>ä¸€ç›´ä»¥æ¥éƒ½æƒ³å†™ä¸€ä¸ªè‡ªå·±çš„httpæœåŠ¡å™¨ï¼Œè¿™æ¬¡è¶ç€ç¨å¾®ç©ºé—²äº†ä¸€äº›ï¼Œèµ¶ç´§ç äº†ä¸€ä¸ª<code>mini</code>ç‰ˆçš„ã€‚åœ¨è¿™é‡Œè·Ÿå¤§å®¶åˆ†äº«ä¸€ä¸‹ç¼–å†™çš„æ•´ä¸ªæ€è·¯ï¼Œæ€»ä½“æ¥è¯´ï¼Œæ•´ä¸ªåº”ç”¨éå¸¸ç®€å•ï¼Œç›®å‰ä¹Ÿåªæ˜¯å®ç°äº†æœ€åŸºæœ¬çš„é™æ€èµ„æºè®¿é—®ï¼Œä½†å¯¹äºæƒ³å­¦ä¹ <code>Http</code>åè®®çš„åŒå­¦æ¥è¯´ï¼Œåº”è¯¥è¿˜æ˜¯æœ‰æ‰€å¸®åŠ©</p><h2 id="HTTPåè®®"><a href="#HTTPåè®®" class="headerlink" title="HTTPåè®®"></a>HTTPåè®®</h2><p>å…ˆç®€å•ä»‹ç»ä¸€ä¸‹<code>HTTP</code>åè®®ï¼Œ<code>HTTP</code>åè®®æ˜¯æ„å»ºäº<code>TCP/IP</code>åè®®ä¹‹ä¸Šçš„ä¸€ä¸ªåº”ç”¨å±‚åè®®ï¼Œå¹¶ä¸”æ˜¯æ— è¿æ¥æ— çŠ¶æ€çš„ã€‚</p><h3 id="httpè¯·æ±‚æŠ¥æ–‡"><a href="#httpè¯·æ±‚æŠ¥æ–‡" class="headerlink" title="httpè¯·æ±‚æŠ¥æ–‡"></a>httpè¯·æ±‚æŠ¥æ–‡</h3><p>httpçš„è¯·æ±‚æŠ¥æ–‡ç”±ä¸‰éƒ¨åˆ†ç»„æˆ</p><ul><li><p>çŠ¶æ€è¡Œ  <code>&lt;method&gt; &lt;request-URL&gt; &lt;version&gt;</code> methodåŒ…å«<code>GET</code>ï¼Œ<code>POST</code>ï¼Œ<code>PUT</code>ï¼Œ<code>DELETE</code>ç­‰</p></li><li><p>è¯·æ±‚å¤´</p></li><li><p>æ¶ˆæ¯ä¸»ä½“</p></li></ul><p>ä¸‹é¢æ˜¯å…¸å‹çš„httpè¯·æ±‚æŠ¥æ–‡ç¤ºä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">GET /static/home.html HTTP/1.1</span><br><span class="line"></span><br><span class="line">Host: localhost:8080</span><br><span class="line"></span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line"></span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.103 Safari/537.36</span><br><span class="line"></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line"></span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line"></span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br></pre></td></tr></table></figure><h3 id="httpå“åº”æŠ¥æ–‡"><a href="#httpå“åº”æŠ¥æ–‡" class="headerlink" title="httpå“åº”æŠ¥æ–‡"></a>httpå“åº”æŠ¥æ–‡</h3><p>å“åº”æŠ¥æ–‡è·Ÿè¯·æ±‚æŠ¥æ–‡ç±»ä¼¼ï¼Œä¹Ÿç”±ä¸‰éƒ¨åˆ†ç»„æˆ</p><ul><li><p>çŠ¶æ€è¡Œ  è¿™é‡Œéœ€è¦å…³æ³¨ä¸‹å“åº”çš„å„ä¸ªçŠ¶æ€æ‰€ä»£è¡¨çš„å«ä¹‰ï¼Œä»¥åŠæµè§ˆå™¨è¯†åˆ«è¿™äº›çŠ¶æ€ç ä¼šç›¸åº”çš„åšå“ªäº›äº‹æƒ…</p></li><li><p>å“åº”å¤´</p></li><li><p>å“åº”æ­£æ–‡</p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line"></span><br><span class="line">Server: cloud http v1.0</span><br><span class="line"></span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line"></span><br><span class="line">&lt;html&gt;...</span><br></pre></td></tr></table></figure><p><strong>##</strong> <strong>åŠ¨æ‰‹</strong></p><p>å‰é¢ç®€å•ä»‹ç»äº†ä¸€ä¸‹httpåè®®çš„åŸºæœ¬ä¿¡æ¯ï¼Œä¸‹é¢å°±æ˜¯æºç å®ç°äº†ï¼Œæˆ‘è¿™é‡Œç›´æ¥ä½¿ç”¨äº†Java NIOä½œä¸ºåº•å±‚é€šä¿¡æ”¯æ’‘ï¼Œåœ¨å®é™…çš„ç”Ÿäº§ä»£ç ä¸­ï¼Œå¤§å¤šä¼šé€‰æ‹©å°è£…è‰¯å¥½çš„<code>netty</code>æ¥ä½œä¸ºç¨³å®šçš„åº•å±‚é€šä¿¡</p><p>è¿™é‡Œå…ˆæ”¾ä¸Šé¡¹ç›®æºç  <a href="https://github.com/WangJunnan/cloudhttp" target="_blank" rel="noopener"><a href="https://github.com/WangJunnan/cloudhttp" target="_blank" rel="noopener">CloudHttp</a></a></p><h3 id="å®šä¹‰Requestå’ŒResponse"><a href="#å®šä¹‰Requestå’ŒResponse" class="headerlink" title="å®šä¹‰Requestå’ŒResponse"></a>å®šä¹‰Requestå’ŒResponse</h3><ul><li>Request</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * method</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> String method;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * httpåè®®ç‰ˆæœ¬</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> String httpVersion;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * è¯·æ±‚uri</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> String uri;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * è¯·æ±‚ç›¸å¯¹è·¯å¾„</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> String path;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * è¯·æ±‚å¤´ä¿¡æ¯</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> Map&lt;String, String&gt; headers;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * è¯·æ±‚å‚æ•°</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> Map&lt;String, String&gt; attribute;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Response</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> Integer code;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> String protocol = <span class="string">"HTTP/1.1"</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> Map&lt;String, String&gt; headers;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> ByteArrayOutputStream outPutStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Response</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">this</span>.code = HttpCode.STATUS_200.getCode();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">this</span>.msg = HttpCode.STATUS_200.getMsg();</span><br><span class="line"></span><br><span class="line"> headers = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"> headers.put(<span class="string">"Content-Type"</span>, <span class="string">"text/html;charset=UTF-8"</span>);</span><br><span class="line"></span><br><span class="line"> headers.put(<span class="string">"Server"</span>, <span class="string">"cloud http v1.0"</span>);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å®šä¹‰è¯·æ±‚å“åº”è§£æç±»  <code>HttpParser</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpParser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(HttpParser.class);</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * &lt;p&gt;è§£æhttpè¯·æ±‚ä½“&lt;/p&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> buffers</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Request <span class="title">decodeReq</span><span class="params">(<span class="keyword">byte</span> [] buffers)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> Request request = <span class="keyword">new</span> Request();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (buffers != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line"> String resString = <span class="keyword">new</span> String(buffers);</span><br><span class="line"></span><br><span class="line"> logger.info(resString);</span><br><span class="line"></span><br><span class="line"> String[] headers = resString.trim().split(<span class="string">"\r\n"</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (headers.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line"> String firstline = headers[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"> <span class="comment">// æŒ‰ç©ºæ ¼åˆ†å‰²å­—ç¬¦ä¸²</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ method uri åè®®ç‰ˆæœ¬</span></span><br><span class="line"></span><br><span class="line"> String mainInfo [] = firstline.split(<span class="string">"\\s+"</span>);</span><br><span class="line"></span><br><span class="line"> request.setMethod(mainInfo[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"> request.setUri(URLDecoder.decode(mainInfo[<span class="number">1</span>], <span class="string">"UTF-8"</span>));</span><br><span class="line"></span><br><span class="line"> &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line"></span><br><span class="line"> logger.error(<span class="string">"error_HttpParser_URLDecode, uri = &#123;&#125;"</span>, mainInfo[<span class="number">1</span>], e);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> request.setHttpVersion(mainInfo[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line"> <span class="comment">// è§£æheader</span></span><br><span class="line"></span><br><span class="line"> Map&lt;String, String&gt; headersMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; headers.length; i++) &#123;</span><br><span class="line"></span><br><span class="line"> String entryStr = headers[i];</span><br><span class="line"></span><br><span class="line"> String entry [] = entryStr.trim().split(<span class="string">":"</span>);</span><br><span class="line"></span><br><span class="line"> headersMap.put(entry[<span class="number">0</span>].trim(), entry[<span class="number">1</span>].trim());</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> request.setHeaders(headersMap);</span><br><span class="line"></span><br><span class="line"> <span class="comment">// è§£æå‚æ•°</span></span><br><span class="line"></span><br><span class="line"> String uri = request.getUri();</span><br><span class="line"></span><br><span class="line"> Map&lt;String, String&gt; attribute = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"> request.setPath(uri);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (StringUtils.isNotEmpty(uri)) &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">int</span> indexOfParam = uri.indexOf(<span class="string">"?"</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (indexOfParam &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// è®¾ç½®path</span></span><br><span class="line"></span><br><span class="line"> request.setPath(uri.substring(<span class="number">0</span>, indexOfParam));</span><br><span class="line"></span><br><span class="line"> String queryString = uri.substring(indexOfParam + <span class="number">1</span>, uri.length());</span><br><span class="line"></span><br><span class="line"> String paramEntrys [] = queryString.split(<span class="string">"&amp;"</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">for</span> (String paramEntry : paramEntrys) &#123;</span><br><span class="line"></span><br><span class="line"> String [] entry = paramEntry.split(<span class="string">"="</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (entry.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line"> String key = entry[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"> String value = entry.length &gt; <span class="number">1</span> ? entry[<span class="number">1</span>] : <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"> attribute.put(key, value);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> request.setAttribute(attribute);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> request;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * &lt;p&gt;è¿”å›httpå“åº”å­—èŠ‚æµ&lt;/p&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encodeResHeader(Response response) &#123;</span><br><span class="line"></span><br><span class="line"> StringBuilder resBuild = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line"> resBuild.append(response.getProtocol() + <span class="string">" "</span> + response.getCode() + <span class="string">" "</span> + response.getMsg());</span><br><span class="line"></span><br><span class="line"> resBuild.append(<span class="string">"\r\n"</span>);</span><br><span class="line"></span><br><span class="line"> Map&lt;String, String&gt; headers = response.getHeaders();</span><br><span class="line"></span><br><span class="line"> headers.entrySet().forEach(entry -&gt; &#123;</span><br><span class="line"></span><br><span class="line"> resBuild.append(entry.getKey());</span><br><span class="line"></span><br><span class="line"> resBuild.append(<span class="string">": "</span>);</span><br><span class="line"></span><br><span class="line"> resBuild.append(entry.getValue());</span><br><span class="line"></span><br><span class="line"> resBuild.append(<span class="string">"\r\n"</span>);</span><br><span class="line"></span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line"> resBuild.append(<span class="string">"\r\n"</span>);</span><br><span class="line"></span><br><span class="line"> String resString = resBuild.toString();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">byte</span> [] bytes = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"> bytes = resString.getBytes(<span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line"> &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line"></span><br><span class="line"> logger.error(<span class="string">"error_encodeResHeader"</span>, e);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> bytes;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨Java-nio-å¯åŠ¨æœåŠ¡å™¨"><a href="#ä½¿ç”¨Java-nio-å¯åŠ¨æœåŠ¡å™¨" class="headerlink" title="ä½¿ç”¨Java nio å¯åŠ¨æœåŠ¡å™¨"></a>ä½¿ç”¨Java nio å¯åŠ¨æœåŠ¡å™¨</h3><ul><li>NioServer</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NioServer</span> <span class="keyword">implements</span> <span class="title">Server</span>, <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(NioServer.class);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> Thread serverThread;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> Integer port;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>  <span class="keyword">boolean</span> running = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> NioServer server;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> CloudService cloudService;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> ServerSocketChannel serverSocketChannel;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> ByteBuffer readBuffer = ByteBuffer.allocate(<span class="number">8192</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ExecutorService requestWork = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NioServer <span class="title">getServerInstance</span> <span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (server == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">synchronized</span> (NioServer.class) &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (server == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line"> server = <span class="keyword">new</span> NioServer();</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> server;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">NioServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">this</span>.cloudService = <span class="keyword">new</span> CloudService();</span><br><span class="line"></span><br><span class="line"> port = Integer.valueOf(CloudHttpConfig.getValue(<span class="string">"port"</span>, <span class="string">"8080"</span>));</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span>  <span class="keyword">synchronized</span>  <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (running) &#123;</span><br><span class="line"></span><br><span class="line"> logger.info(<span class="string">"æœåŠ¡å™¨å·²ç»å¯åŠ¨"</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> serverThread = <span class="keyword">new</span> Thread(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"> serverThread.start();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">this</span>.running = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"> serverSocketChannel.close();</span><br><span class="line"></span><br><span class="line"> serverThread.stop();</span><br><span class="line"></span><br><span class="line"> &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"></span><br><span class="line"> logger.error(<span class="string">"error_NioServer_stop"</span>, e);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//æ‰“å¼€ServerSocketChannelé€šé“</span></span><br><span class="line"></span><br><span class="line"> serverSocketChannel = ServerSocketChannel.open();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//å¾—åˆ°ServerSocketå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"> serverSocketChannel.socket().bind(<span class="keyword">new</span> InetSocketAddress(port));</span><br><span class="line"></span><br><span class="line"> Selector selector = Selector.open();</span><br><span class="line"></span><br><span class="line"> serverSocketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"> serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line"> selector.select();</span><br><span class="line"></span><br><span class="line"> Iterator&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys().iterator();</span><br><span class="line"></span><br><span class="line"> SelectionKey key = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">while</span> (selectedKeys.hasNext()) &#123;</span><br><span class="line"></span><br><span class="line"> key = selectedKeys.next();</span><br><span class="line"></span><br><span class="line"> selectedKeys.remove();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (!key.isValid()) &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line"></span><br><span class="line"> accept(key);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line"></span><br><span class="line"> read(key);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (key.isWritable()) &#123;</span><br><span class="line"></span><br><span class="line"> write(key);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"></span><br><span class="line"> logger.error(<span class="string">"error_NioServer_run"</span>, e);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(SelectionKey key)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"> ServerSocketChannel serverSocketChannel = (ServerSocketChannel)key.channel();</span><br><span class="line"></span><br><span class="line"> SocketChannel socketChannel = serverSocketChannel.accept();</span><br><span class="line"></span><br><span class="line"> socketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"> socketChannel.register(key.selector(), SelectionKey.OP_READ);</span><br><span class="line"></span><br><span class="line"> &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"></span><br><span class="line"> logger.error(<span class="string">"error_NioServer_accept"</span>, e);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> Request <span class="title">read</span><span class="params">(SelectionKey key)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> Request request = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"> SocketChannel socketChannel = (SocketChannel) key.channel();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">int</span> readNum = socketChannel.read(readBuffer);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (readNum == -<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line"> socketChannel.close();</span><br><span class="line"></span><br><span class="line"> key.cancel();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> readBuffer.flip();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">byte</span> [] buffers = <span class="keyword">new</span> <span class="keyword">byte</span>[readBuffer.limit()];</span><br><span class="line"></span><br><span class="line"> readBuffer.get(buffers);</span><br><span class="line"></span><br><span class="line"> readBuffer.clear();</span><br><span class="line"></span><br><span class="line"> request = HttpParser.decodeReq(buffers);</span><br><span class="line"></span><br><span class="line"> requestWork.execute(<span class="keyword">new</span> RequestWorker(request, key, cloudService));</span><br><span class="line"></span><br><span class="line"> &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"></span><br><span class="line"> logger.error(<span class="string">"error_NioServer_read"</span>, e);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> request;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line"> ByteBuffer buffer = (ByteBuffer) key.attachment();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>(buffer == <span class="keyword">null</span> || !buffer.hasRemaining()) &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> SocketChannel socketChannel = (SocketChannel) key.channel();</span><br><span class="line"></span><br><span class="line"> socketChannel.write(buffer);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>(!buffer.hasRemaining())&#123;</span><br><span class="line"></span><br><span class="line"> key.interestOps(SelectionKey.OP_READ);</span><br><span class="line"></span><br><span class="line"> buffer.clear();</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> socketChannel.close();</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¤„ç†è¯·æ±‚çš„-RequestWorkç±»"><a href="#å¤„ç†è¯·æ±‚çš„-RequestWorkç±»" class="headerlink" title="å¤„ç†è¯·æ±‚çš„ RequestWorkç±»"></a>å¤„ç†è¯·æ±‚çš„ RequestWorkç±»</h3><p>å¯¹äºæ¯ä¸€ä¸ªè¿›å…¥çš„è¯·æ±‚ã€‚éƒ½ä¼šå•ç‹¬å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ¥è¿›è¡Œå¤„ç†</p><ul><li>RequestWorker</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestWorker</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(RequestWorker.class);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> Request request;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> SelectionKey key;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> SocketChannel channel;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> CloudService cloudService;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">RequestWorker</span><span class="params">(Request request, SelectionKey key, CloudService cloudService)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">this</span>.request = request;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">this</span>.key = key;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">this</span>.channel = (SocketChannel) key.channel();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">this</span>.cloudService = cloudService;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> Response response = <span class="keyword">new</span> Response();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"> cloudService.doService(request, response);</span><br><span class="line"></span><br><span class="line"> &#125; <span class="keyword">catch</span> (ViewNotFoundException e) &#123;</span><br><span class="line"></span><br><span class="line"> response.setCode(HttpCode.STATUS_404.getCode());</span><br><span class="line"></span><br><span class="line"> response.setMsg(HttpCode.STATUS_404.getMsg());</span><br><span class="line"></span><br><span class="line"> ByteArrayOutputStream outputStream = response.getOutPutStream();</span><br><span class="line"></span><br><span class="line"> InputStream inputStream = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="string">"404.html"</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">byte</span> bytes [] = <span class="keyword">new</span> <span class="keyword">byte</span> [<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line"> <span class="keyword">int</span> len;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">while</span> ((len = inputStream.read(bytes)) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line"> outputStream.write(bytes, <span class="number">0</span>, len);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line"></span><br><span class="line"> logger.error(<span class="string">"error_requestWork_write404"</span>, e);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">byte</span> [] resHeader = HttpParser.encodeResHeader(response);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">byte</span> [] body = response.getOutPutStream().toByteArray();</span><br><span class="line"></span><br><span class="line"> ByteBuffer byteBuffer = ByteBuffer.allocate(resHeader.length + body.length);</span><br><span class="line"></span><br><span class="line"> byteBuffer.put(resHeader);</span><br><span class="line"></span><br><span class="line"> byteBuffer.put(body);</span><br><span class="line"></span><br><span class="line"> byteBuffer.flip();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°†è¾“å‡ºæµç»‘å®šè‡³é™„ä»¶</span></span><br><span class="line"></span><br><span class="line"> key.attach(byteBuffer);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ³¨å†Œå†™äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line"> key.interestOps(SelectionKey.OP_WRITE);</span><br><span class="line"></span><br><span class="line"> key.selector().wakeup();</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®šä¹‰Servletæ¥å£"><a href="#å®šä¹‰Servletæ¥å£" class="headerlink" title="å®šä¹‰Servletæ¥å£"></a>å®šä¹‰Servletæ¥å£</h3><ul><li>CloudServlet</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CloudServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * åˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦åŒ¹é… handler</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">match</span><span class="params">(Request request)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * æ‰§è¡Œåˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(Request request, Response response)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * æ‰§è¡Œè¯·æ±‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">doService</span><span class="params">(Request request, Response response)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>StaticViewServlet å®šä¹‰ä¸€ä¸ªå¤„ç†é™æ€èµ„æºçš„<code>StaticViewServlet</code>å®ç°<code>CloudServlet</code>æ¥å£</li></ul><p>è¯¥é™æ€èµ„æºå¤„ç†å™¨ä¼šè‡ªåŠ¨æ‹¦æˆª<code>static</code>è·¯å¾„ä¸‹çš„è¯·æ±‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticViewServlet</span> <span class="keyword">implements</span> <span class="title">CloudServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(StaticViewServlet.class);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> String staticRootPath;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> Pattern p = Pattern.compile(<span class="string">"^/static/\\S+"</span>);</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">match</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> String path = request.getPath();</span><br><span class="line"></span><br><span class="line"> Matcher matcher = p.matcher(path);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> matcher.matches();</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Request request, Response response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> staticRootPath = CloudHttpConfig.getValue(<span class="string">"static.resource.path"</span>);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doService</span><span class="params">(Request request, Response response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> String path = request.getPath();</span><br><span class="line"></span><br><span class="line"> String fileRelativePath = path.substring(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"> String absolutePath = staticRootPath + <span class="string">"/"</span> + fileRelativePath;</span><br><span class="line"></span><br><span class="line"> RandomAccessFile randomAccessFile = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"> randomAccessFile = <span class="keyword">new</span> RandomAccessFile(absolutePath, <span class="string">"r"</span>);</span><br><span class="line"></span><br><span class="line"> FileChannel fileChannel = randomAccessFile.getChannel();</span><br><span class="line"></span><br><span class="line"> ByteBuffer htmBuffer = ByteBuffer.allocate((<span class="keyword">int</span>)fileChannel.size());</span><br><span class="line"></span><br><span class="line"> fileChannel.read(htmBuffer);</span><br><span class="line"></span><br><span class="line"> htmBuffer.flip();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">byte</span> [] htmByte = <span class="keyword">new</span> <span class="keyword">byte</span>[htmBuffer.limit()];</span><br><span class="line"></span><br><span class="line"> htmBuffer.get(htmByte);</span><br><span class="line"></span><br><span class="line"> response.getOutPutStream().write(htmByte);</span><br><span class="line"></span><br><span class="line"> &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">throw</span> <span class="keyword">new</span> ViewNotFoundException();</span><br><span class="line"></span><br><span class="line"> &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"></span><br><span class="line"> logger.error(<span class="string">"error_StaticViewServlet_doService å¼‚å¸¸"</span>, e);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®šä¹‰-CloudService"><a href="#å®šä¹‰-CloudService" class="headerlink" title="å®šä¹‰ CloudService"></a>å®šä¹‰ CloudService</h3><p><code>CloudService</code>æ˜¯ç”¨äºç››æ”¾<code>Servlet</code>çš„å®¹å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> List&lt;CloudServlet&gt; cloudServlets = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">CloudService</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> cloudServlets.add(<span class="keyword">new</span> StaticViewServlet());</span><br><span class="line"></span><br><span class="line"> cloudServlets.add(<span class="keyword">new</span> MappingUrlServlet());</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doService</span><span class="params">(Request request, Response response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> CloudServlet servlet = doSelect(request);</span><br><span class="line"></span><br><span class="line"> servlet.init(request, response);</span><br><span class="line"></span><br><span class="line"> servlet.doService(request, response);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> CloudServlet <span class="title">doSelect</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">for</span> (CloudServlet cloudServlet : cloudServlets) &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (cloudServlet.match(request)) &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> cloudServlet;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> MappingUrlServlet();</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æœ€å-ç¼–å†™å¯åŠ¨ç±»"><a href="#æœ€å-ç¼–å†™å¯åŠ¨ç±»" class="headerlink" title="æœ€å  ç¼–å†™å¯åŠ¨ç±»"></a>æœ€å  ç¼–å†™å¯åŠ¨ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudHttpServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> NioServer.getServerInstance().start();</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> startServer();</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><ol><li><p>å¯åŠ¨æœåŠ¡å™¨</p></li><li><p>æµè§ˆå™¨è®¿é—®  <code>http://localhost:8080/static/home.html</code></p></li></ol><p>å“åº”é¡µé¢</p><p><img src="http://upload-images.jianshu.io/upload_images/2717496-aa1ea0a3a1d1f266.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><h2 id="å°¾è¨€"><a href="#å°¾è¨€" class="headerlink" title="å°¾è¨€"></a>å°¾è¨€</h2><p>æœ¬æ–‡åªæ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œä»…ä»…å®ç°äº†é™æ€èµ„æºè®¿é—®ã€‚åšä¸ºè‡ªå¨±è‡ªä¹çš„é¡¹ç›® +â€”â€”=</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;ä¸€ç›´ä»¥æ¥éƒ½æƒ³å†™ä¸€ä¸ªè‡ªå·±çš„httpæœåŠ¡å™¨ï¼Œè¿™æ¬¡è¶ç€ç¨å¾®ç©ºé—²äº†ä¸€äº›ï¼Œèµ¶ç´§ç äº†ä¸€ä¸ª&lt;code&gt;mini&lt;/code&gt;ç‰ˆçš„ã€‚åœ¨è¿™é‡Œè·Ÿå¤§å®¶åˆ†äº«ä¸€ä¸‹ç¼–å†™
      
    
    </summary>
    
      <category term="NIO" scheme="http://wangjunnan.github.io/categories/NIO/"/>
    
      <category term="HTTP" scheme="http://wangjunnan.github.io/categories/NIO/HTTP/"/>
    
    
      <category term="NIO" scheme="http://wangjunnan.github.io/tags/NIO/"/>
    
      <category term="HTTP" scheme="http://wangjunnan.github.io/tags/HTTP/"/>
    
  </entry>
  
  <entry>
    <title>Javaå­—èŠ‚ç å¸¸é‡æ± </title>
    <link href="http://wangjunnan.github.io/2019/04/17/Java%E5%AD%97%E8%8A%82%E7%A0%81%E5%B8%B8%E9%87%8F%E6%B1%A0/"/>
    <id>http://wangjunnan.github.io/2019/04/17/Javaå­—èŠ‚ç å¸¸é‡æ± /</id>
    <published>2019-04-17T07:48:48.000Z</published>
    <updated>2019-09-27T05:52:47.703Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>ä¸Šç¯‡æ–‡ç« ç®€å•ä»‹ç»äº†<code>java Class</code> å­—èŠ‚ç æ–‡ä»¶çš„åŸºæœ¬æ ¼å¼ã€‚æœ¬æ–‡æˆ‘ä»¬ç›´æ¥é€šè¿‡é˜…è¯»å­—èŠ‚ç æ–‡ä»¶æ¥è¿›ä¸€æ­¥ç†è§£å­—èŠ‚ç ä¸­çš„å¸¸é‡æ± ç»“æ„</p><p>é¦–å…ˆæˆ‘ä»¬æ–°å»ºä¸€ä¸ªæœ€ç®€å•çš„Javaæ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello world"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ä¹‹åä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ï¼Œå¯ä»¥çœ‹åˆ°<code>Class</code>æ–‡ä»¶æœ€åŸå§‹çš„16è¿›åˆ¶æ ¼å¼ã€‚æœ€æ˜æ˜¾çš„<code>Class</code>æ–‡ä»¶çš„é­”æ•°<code>cafe babe</code>ä¸€çœ¼å°±èƒ½çœ‹åˆ°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cafe babe 0000 0034 0022 0a00 0600 1409</span><br><span class="line">0015 0016 0800 170a 0018 0019 0700 1a07</span><br><span class="line">001b 0100 063c 696e 6974 3e01 0003 2829</span><br><span class="line">5601 0004 436f 6465 0100 0f4c 696e 654e</span><br><span class="line">756d 6265 7254 6162 6c65 0100 124c 6f63</span><br><span class="line">616c 5661 7269 6162 6c65 5461 626c 6501</span><br><span class="line">0004 7468 6973 0100 144c 636f 6d2f 796d</span><br><span class="line">6d2f 6167 656e 742f 5465 7374 3b01 0004</span><br><span class="line">6d61 696e 0100 1628 5b4c 6a61 7661 2f6c</span><br><span class="line">616e 672f 5374 7269 6e67 3b29 5601 0004</span><br><span class="line">6172 6773 0100 135b 4c6a 6176 612f 6c61</span><br><span class="line">6e67 2f53 7472 696e 673b 0100 0a53 6f75</span><br><span class="line">7263 6546 696c 6501 0009 5465 7374 2e6a</span><br><span class="line">6176 610c 0007 0008 0700 1c0c 001d 001e</span><br><span class="line">0100 0b68 656c 6c6f 2077 6f72 6c64 0700</span><br><span class="line">1f0c 0020 0021 0100 1263 6f6d 2f79 6d6d</span><br><span class="line">2f61 6765 6e74 2f54 6573 7401 0010 6a61</span><br><span class="line">7661 2f6c 616e 672f 4f62 6a65 6374 0100</span><br><span class="line">106a 6176 612f 6c61 6e67 2f53 7973 7465</span><br><span class="line">6d01 0003 6f75 7401 0015 4c6a 6176 612f</span><br><span class="line">696f 2f50 7269 6e74 5374 7265 616d 3b01</span><br><span class="line">0013 6a61 7661 2f69 6f2f 5072 696e 7453</span><br><span class="line">7472 6561 6d01 0007 7072 696e 746c 6e01</span><br><span class="line">0015 284c 6a61 7661 2f6c 616e 672f 5374</span><br><span class="line">7269 6e67 3b29 5600 2100 0500 0600 0000</span><br><span class="line">0000 0200 0100 0700 0800 0100 0900 0000</span><br><span class="line">2f00 0100 0100 0000 052a b700 01b1 0000</span><br><span class="line">0002 000a 0000 0006 0001 0000 0009 000b</span><br><span class="line">0000 000c 0001 0000 0005 000c 000d 0000</span><br><span class="line">0009 000e 000f 0001 0009 0000 0037 0002</span><br><span class="line">0001 0000 0009 b200 0212 03b6 0004 b100</span><br><span class="line">0000 0200 0a00 0000 0a00 0200 0000 0b00</span><br><span class="line">0800 0c00 0b00 0000 0c00 0100 0000 0900</span><br><span class="line">1000 1100 0000 0100 1200 0000 0200 13</span><br></pre></td></tr></table></figure><h2 id="å¦‚ä½•ä»ä¸Šé¢çš„æ–‡ä»¶ä¸­æ‰¾åˆ°å¸¸é‡æ± æ‰€åœ¨çš„ä½ç½®å‘¢"><a href="#å¦‚ä½•ä»ä¸Šé¢çš„æ–‡ä»¶ä¸­æ‰¾åˆ°å¸¸é‡æ± æ‰€åœ¨çš„ä½ç½®å‘¢" class="headerlink" title="å¦‚ä½•ä»ä¸Šé¢çš„æ–‡ä»¶ä¸­æ‰¾åˆ°å¸¸é‡æ± æ‰€åœ¨çš„ä½ç½®å‘¢"></a>å¦‚ä½•ä»ä¸Šé¢çš„æ–‡ä»¶ä¸­æ‰¾åˆ°å¸¸é‡æ± æ‰€åœ¨çš„ä½ç½®å‘¢</h2><p>åœ¨ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»åˆ†æè¿‡<code>Class</code>æ–‡ä»¶æ–‡ä»¶æ ¼å¼äº†ï¼Œå¸¸é‡æ± çš„ä½ç½®ç´§éšåœ¨ç‰ˆæœ¬å·ä¹‹åï¼Œä¹Ÿå°±æ˜¯ä»ç¬¬9ä¸ªå­—èŠ‚å¼€å§‹å°±æ˜¯å¸¸é‡æ± çš„å†…å®¹äº†ï¼Œä¸‹é¢å°±è®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹å¸¸é‡æ± çš„å…·ä½“å†…å®¹</p><h3 id="constant-pool-count-u2"><a href="#constant-pool-count-u2" class="headerlink" title="constant_pool_count u2"></a>constant_pool_count u2</h3><p>ä»ç¬¬9ä¸ªå­—èŠ‚å¼€å§‹å¾€åçš„ä¸¤ä¸ªå­—èŠ‚ï¼Œæ˜¯<code>constant_pool_count</code>ï¼Œæˆ‘ä»¬æŠŠå®ƒå«åšå¸¸é‡è®¡æ•°å™¨ï¼Œæ¯”è¾ƒç‰¹æ®Šçš„æ˜¯å®ƒçš„ä¸‹æ ‡æ˜¯ä»1å¼€å§‹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´çœŸæ­£çš„å¸¸é‡æ± æ•°é‡æ˜¯<code>constant_pool_count - 1</code>ä¸ªï¼Œé‚£å¥½ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä¸Šé¢çš„é‚£ä¸ªæ™®é€š<code>Class</code>æ–‡ä»¶åŒ…å«äº†å¤šå°‘ä¸ªå¸¸é‡è¡¨ï¼ˆ<code>cp_info</code>ï¼‰</p><p><img src="http://upload-images.jianshu.io/upload_images/2717496-1e1c7e2eecf80bc1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å¸¸é‡è®¡æ•°"></p><p>å¯ä»¥çœ‹åˆ°<code>constant_pool_count</code>æ ‡è¯†ä½æ˜¯<code>0022</code>ï¼Œè½¬ä¸º10è¿›åˆ¶å°±æ˜¯34ã€‚ä¹Ÿå°±æ˜¯è¯´åŒ…å«<code>34 - 1 = 33</code>ä¸ªå¸¸é‡è¡¨å†…å®¹</p><h3 id="cp-info"><a href="#cp-info" class="headerlink" title="cp_info"></a>cp_info</h3><p>ä¸Šæ–‡ç»è¿‡åˆ†ææˆ‘ä»¬å·²ç»ç¡®å®šäº†å­—èŠ‚ç æ–‡ä»¶åŒ…å«çš„å¸¸é‡è¡¨ä¸ªæ•°ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬è¦å…·ä½“æ€ä¹ˆçœ‹å‘¢ï¼Ÿ</p><p>ä¸‹é¢è®©æˆ‘ä»¬æ¥å…·ä½“åˆ†æä¸‹<code>cp_info</code>çš„ç»“æ„</p><p><img src="http://upload-images.jianshu.io/upload_images/2717496-e45775e88817026d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>å¯ä»¥çœ‹åˆ°æ¯ä¸ª<code>cp_info</code>çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä½éƒ½æ˜¯<code>tag</code>ï¼Œç”¨äºæ ‡è¯†å¸¸é‡è¡¨æ‰€å±çš„å…·ä½“ç±»å‹ï¼Œä¸Šç¯‡æ–‡ç« æˆ‘ä»¬è¯´è¿‡ï¼Œå¸¸é‡è¡¨ä¹‹æ‰€ä»¥éå¸¸å¤æ‚ï¼Œå°±æ˜¯å› ä¸ºå®ƒçš„ç±»å‹ä¼—å¤šï¼Œæœ‰å¤šå¤§14ç§ç±»å‹ã€‚é‚£ä¹ˆè¿™äº›ç±»å‹çš„åŒºåˆ†å°±æ˜¯é€šè¿‡<code>tag</code>æ¥åŒºåˆ†ã€‚æˆ‘ä»¬ä¼šé€ä¸ªåˆ†æè¿™14ç§ç±»å‹</p><p>å…ˆæ¥çœ‹ä¸‹è¿™14å¸¸é‡æ± ç±»å‹</p><p><img src="http://upload-images.jianshu.io/upload_images/2717496-5f84affafe924089.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>è¿˜æ˜¯å›åˆ°ä¸Šè¿°å­—èŠ‚ç çš„16è¿›åˆ¶æ–‡ä»¶ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹</p><p><img src="http://upload-images.jianshu.io/upload_images/2717496-e413777a45543d46.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>å¯ä»¥çœ‹åˆ°<code>tag = 10</code>ï¼Œæ ¹æ®ä¸Šæ–‡æˆ‘ä»¬åˆ—å‡ºçš„ç»†åˆ†ç±»å‹å¯ä»¥ç¡®å®šè¿™ç¬¬ä¸€ä¸ªå‡ºç°çš„å¸¸é‡è¡¨ç±»å‹æ˜¯<code>constant_Methodref_info</code>ã€‚é‚£å¥½ç°åœ¨æˆ‘ä»¬å†å»å…·ä½“çš„çœ‹ä¸‹<code>constant_Methodref_info</code>è¡¨çš„å…·ä½“å†…å®¹</p><p><img src="http://upload-images.jianshu.io/upload_images/2717496-10a980be4439b580.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="constant_Methodref_info.png"></p><p>å¯ä»¥çœ‹åˆ°ç´§è·Ÿåœ¨<code>tag</code>ä¹‹åå…¶å®æ˜¯ä¸¤é¡¹indexç´¢å¼•å€¼ï¼Œåˆ†åˆ«æŒ‡å‘<code>constant_Class_info</code>å’Œ<code>constant_NameAndType_info</code>ã€‚</p><p>ç»§ç»­å¾€ä¸‹é˜…è¯»ï¼Œå¯ä»¥çŸ¥é“å…·ä½“çš„ç´¢å¼•å€¼åˆ†åˆ«ä¸º<code>0006</code>ï¼Œ<code>0014</code>ã€‚ä¹Ÿå°±æ˜¯æŒ‡å‘å¸¸é‡æ± çš„ç¬¬6é¡¹å’Œç¬¬20é¡¹</p><p>ä¸‹é¢ä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨<code>javap -v Test</code>å‘½ä»¤ç”Ÿæˆæ–¹ä¾¿æˆ‘ä»¬é˜…è¯»çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œå½“ç„¶å¦‚æœæœ‰å…´è¶£çš„è¯ï¼Œç›´æ¥é˜…è¯»æºæ–‡ä»¶ä¹Ÿæ˜¯oKçš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">public class com.ymm.agent.Test</span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: 52</span><br><span class="line">  flags: (0x0021) ACC_PUBLIC, ACC_SUPER</span><br><span class="line">  this_class: #5                          // com/ymm/agent/Test</span><br><span class="line">  super_class: #6                         // java/lang/Object</span><br><span class="line">  interfaces: 0, fields: 0, methods: 2, attributes: 1</span><br><span class="line">Constant pool:</span><br><span class="line">   #1 = Methodref          #6.#20         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #2 = Fieldref           #21.#22        // java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">   #3 = String             #23            // hello world</span><br><span class="line">   #4 = Methodref          #24.#25        // java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">   #5 = Class              #26            // com/ymm/agent/Test</span><br><span class="line">   #6 = Class              #27            // java/lang/Object</span><br><span class="line">   #7 = Utf8               &lt;init&gt;</span><br><span class="line">   #8 = Utf8               ()V</span><br><span class="line">   #9 = Utf8               Code</span><br><span class="line">  #10 = Utf8               LineNumberTable</span><br><span class="line">  #11 = Utf8               LocalVariableTable</span><br><span class="line">  #12 = Utf8               this</span><br><span class="line">  #13 = Utf8               Lcom/ymm/agent/Test;</span><br><span class="line">  #14 = Utf8               main</span><br><span class="line">  #15 = Utf8               ([Ljava/lang/String;)V</span><br><span class="line">  #16 = Utf8               args</span><br><span class="line">  #17 = Utf8               [Ljava/lang/String;</span><br><span class="line">  #18 = Utf8               SourceFile</span><br><span class="line">  #19 = Utf8               Test.java</span><br><span class="line">  #20 = NameAndType        #7:#8          // &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">  #21 = Class              #28            // java/lang/System</span><br><span class="line">  #22 = NameAndType        #29:#30        // out:Ljava/io/PrintStream;</span><br><span class="line">  #23 = Utf8               hello world</span><br><span class="line">  #24 = Class              #31            // java/io/PrintStream</span><br><span class="line">  #25 = NameAndType        #32:#33        // println:(Ljava/lang/String;)V</span><br><span class="line">  #26 = Utf8               com/ymm/agent/Test</span><br><span class="line">  #27 = Utf8               java/lang/Object</span><br><span class="line">  #28 = Utf8               java/lang/System</span><br><span class="line">  #29 = Utf8               out</span><br><span class="line">  #30 = Utf8               Ljava/io/PrintStream;</span><br><span class="line">  #31 = Utf8               java/io/PrintStream</span><br><span class="line">  #32 = Utf8               println</span><br><span class="line">  #33 = Utf8               (Ljava/lang/String;)V</span><br><span class="line">&#123;</span><br><span class="line">  public com.ymm.agent.Test();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">.... çœç•¥å…¶ä»–å­—èŠ‚ç </span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>javap</code> ç”Ÿæˆçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œçœ‹èµ·æ¥å°±èˆ’æœå¤šäº†ã€‚ç°åœ¨ç»§ç»­å›åˆ°ç¬¬ä¸€ä¸ªå¸¸é‡æ± é¡¹<code>constant_Methodref_info</code>ï¼Œå¯ä»¥çŸ¥é“å®ƒæ˜¯ç”±<code>constant_Class_info</code>ï¼Œ<code>constant_NameAndType_info</code>ä¸¤é¡¹çš„ç´¢å¼•å€¼ç»„æˆï¼Œæ ¹æ®ç´¢å¼•å€¼<code>6</code>,<code>20</code>æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å…·ä½“å¸¸é‡æ± é¡¹å†…å®¹ã€‚</p><p>å…ˆæ‰¾åˆ°ç´¢å¼•å€¼ä¸º<code>6</code>çš„<code>constant_Class_info</code>çš„å†…å®¹ï¼Œå¯ä»¥å‘ç°å…¶å…·ä½“å†…å®¹ä¹Ÿæ˜¯æŒ‡å‘äº†ä¸€ä¸ªç´¢å¼•å€¼<code>27</code>ï¼Œç»§ç»­æ‰¾ç´¢å¼•å€¼ä¸º<code>27</code>å¸¸é‡é¡¹</p><p><img src="http://upload-images.jianshu.io/upload_images/2717496-5c7eb023de534a0b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>æ‰¾åˆ°ç´¢å¼•å€¼ä¸º<code>27</code>çš„å¸¸é‡é¡¹ï¼Œå¯ä»¥å‘ç°æ˜¯ä¸€ä¸ª<code>constant_utf8_info</code>ç±»å‹çš„å­—ç¬¦ä¸²(java/lang/Object)ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ç±»çš„å…¨é™å®šåç§°</p><p><img src="http://upload-images.jianshu.io/upload_images/2717496-22a9e1eb96234b8d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>åˆ°ç›®å‰ä¸ºæ­¢å¤§å®¶åº”è¯¥å·²ç»æ‰¾åˆ°äº†é˜…è¯»å¸¸é‡æ± çš„æ„Ÿè§‰äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å»æŸ¥çœ‹ç´¢å¼•é¡¹ä¸º<code>20</code>çš„<code>constant_NameAndType_info</code>çš„æ–¹æ³•ä¹Ÿæ˜¯ä¸€æ ·çš„</p><p><img src="http://upload-images.jianshu.io/upload_images/2717496-4332f33c24364301.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><code>constant_NameAndType_info</code>æŒ‡å‘ç´¢å¼•å€¼ä¸º<code>7</code>å’Œ<code>8</code>çš„å†…å®¹</p><p><img src="http://upload-images.jianshu.io/upload_images/2717496-0e0729faf2be3012.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>å¯ä»¥çŸ¥é“æ–¹æ³•åç§°ä¸º<code>init</code>ï¼Œç±»å‹ä¸º<code>void</code>æ–¹æ³•</p><p>åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å¤§æ¦‚å¯ä»¥çŸ¥é“æ­¤å¸¸é‡æ± çš„ç¬¬ä¸€é¡¹è¡¨ç¤ºå…¶å®æ˜¯ä¸€ä¸ªæ— å‚çš„æ„é€ æ–¹æ³•ï¼Œå¹¶ä¸”æ˜¯ç¼–è¯‘å™¨ä¸ºæˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆçš„</p><p>å…¶å®å¤§å¤šæ•°å¤æ‚çš„å¸¸é‡æ± å†…å®¹æœ€ç»ˆéƒ½ä¼šç´¢å¼•åˆ°ä¸€ä¸ª<code>constant_utf8_info</code>å­—ç¬¦ä¸²ç±»å‹ï¼Œç”¨äºæè¿°ç±»å…¨é™å®šåï¼Œæ–¹æ³•æˆ–å­—æ®µåç§°åŠæè¿°ç¬¦ç­‰ç­‰ ..</p><h2 id="å°¾è¨€"><a href="#å°¾è¨€" class="headerlink" title="å°¾è¨€"></a>å°¾è¨€</h2><p>æœ¬ç¯‡æ–‡ç« æˆ‘ä»¬åªæ˜¯é€šè¿‡ä¸€ä¸ªç¤ºä¾‹æ¥é˜…è¯»<code>Class</code>æ–‡ä»¶çš„å¸¸é‡æ± å†…å®¹ï¼Œå…·ä½“çš„å¸¸é‡æ± ç»“æ„åœ¨ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬éƒ½æœ‰åˆ—å‡ºï¼Œå¹¶ä¸”é˜…è¯»çš„æ–¹æ³•ä¹Ÿæ˜¯ä¸æœ¬æ–‡ç±»ä¼¼ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;ä¸Šç¯‡æ–‡ç« ç®€å•ä»‹ç»äº†&lt;code&gt;java Class&lt;/code&gt; å­—èŠ‚ç æ–‡ä»¶çš„åŸºæœ¬æ ¼å¼ã€‚æœ¬æ–‡æˆ‘ä»¬ç›´æ¥é€šè¿‡é˜…è¯»å­—èŠ‚ç æ–‡ä»¶æ¥è¿›ä¸€æ­¥ç†è§£å­—èŠ‚ç ä¸­çš„
      
    
    </summary>
    
      <category term="javaåŸºç¡€" scheme="http://wangjunnan.github.io/categories/java%E5%9F%BA%E7%A1%80/"/>
    
      <category term="JVM" scheme="http://wangjunnan.github.io/categories/java%E5%9F%BA%E7%A1%80/JVM/"/>
    
      <category term="javaå­—èŠ‚ç " scheme="http://wangjunnan.github.io/categories/java%E5%9F%BA%E7%A1%80/JVM/java%E5%AD%97%E8%8A%82%E7%A0%81/"/>
    
    
      <category term="JVM" scheme="http://wangjunnan.github.io/tags/JVM/"/>
    
      <category term="javaå­—èŠ‚ç " scheme="http://wangjunnan.github.io/tags/java%E5%AD%97%E8%8A%82%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>Java Classæ–‡ä»¶ç»“æ„</title>
    <link href="http://wangjunnan.github.io/2019/04/04/Java-Class%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/"/>
    <id>http://wangjunnan.github.io/2019/04/04/Java-Classæ–‡ä»¶ç»“æ„/</id>
    <published>2019-04-04T07:47:26.000Z</published>
    <updated>2019-09-27T05:52:47.702Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“javaæ˜¯è·¨å¹³å°çš„ï¼ŒåŸå› å°±åœ¨äºå„ä¸ªå¹³å°çš„javaè™šæ‹Ÿæœºå¯ä»¥è½½å…¥å’Œæ‰§è¡ŒåŒä¸€ç§å¹³å°æ— å…³çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´javaè™šæ‹Ÿæœºä¸ä¸åŒ…æ‹¬Javaåœ¨å†…çš„ä»»ä½•è¯­è¨€ç»‘å®šï¼Œåªäº<code>Class</code>æ–‡ä»¶è¿™ç§äºŒè¿›åˆ¶æ ¼å¼æ–‡ä»¶æ‰€å…³è”ã€‚</p><p>åŸºäºè¿™æ ·çš„è®¾è®¡ï¼Œåˆ°ç›®å‰ä¸ºæ­¢å·²ç»å‡ºç°äº†å¾ˆå¤šåŸºäºJavaè™šæ‹Ÿæœºçš„è¯­è¨€</p><p>å¦‚<code>groovy</code>æœ€ç»ˆéƒ½ä¼šç¼–è¯‘æˆ<code>class</code>æ–‡ä»¶</p><h2 id="Classæ–‡ä»¶ç»“æ„"><a href="#Classæ–‡ä»¶ç»“æ„" class="headerlink" title="Classæ–‡ä»¶ç»“æ„"></a>Classæ–‡ä»¶ç»“æ„</h2><p>ä¸€ä¸ªClassæ–‡ä»¶å”¯ä¸€å¯¹åº”ä¸€ä¸ªç±»æˆ–æ¥å£</p><p>ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹ä¸‹<code>Class</code>æ–‡ä»¶çš„åŸºæœ¬ç»“æ„</p><p>Classæ–‡ä»¶ä»¥8ä½å­—èŠ‚ä¸ºåŸºæœ¬å•ä½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ<strong>å„ä¸ªæ•°æ®é¡¹ç›®ä¸¥æ ¼çš„æŒ‰ç…§é¡ºåºç´§å‡‘çš„æ’åˆ—åœ¨<code>Class</code>æ–‡ä»¶ä¹‹ä¸­ï¼Œä¸­é—´æ²¡æœ‰ä»»ä½•åˆ†éš”ç¬¦ï¼Œè¿™ä½¿å¾—æ•´ä¸ª<code>Class</code>æ–‡ä»¶ä¸­å­˜å‚¨çš„å†…å®¹å‡ ä¹å…¨éƒ¨æ˜¯è¿è¡Œæ—¶çš„å¿…è¦æ•°æ®</strong></p><p><code>Class</code>æ–‡ä»¶çš„äºŒè¿›åˆ¶æ–‡ä»¶åªæœ‰ä¸¤ç§æ•°æ®ç±»å‹ï¼šæ— ç¬¦å·æ•°å’Œè¡¨ï¼Œåé¢çš„è§£æéƒ½ä¼šä»¥è¿™ä¸¤ç§æ•°æ®ç±»å‹ä¸ºåŸºç¡€</p><ul><li>æ— ç¬¦å·æ•°</li></ul><p>æ— ç¬¦å·æ•°æ˜¯æœ€åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼Œä»¥<code>u1</code>,<code>u2</code>,<code>u4</code>,<code>u8</code>æ¥åˆ†åˆ«ä»£è¡¨1ä¸ªå­—èŠ‚ï¼Œ2ä¸ªå­—èŠ‚ï¼Œ4ä¸ªå­—èŠ‚ï¼Œ8ä¸ªå­—èŠ‚çš„æ— ç¬¦å·æ•°ï¼Œæ— ç¬¦å·æ•°ç”¨æ¥æè¿°æ•°å­—ï¼Œç´¢å¼•å¼•ç”¨ï¼Œæ•°é‡å€¼ï¼Œä»¥åŠä»¥UTF-8ç¼–ç çš„å­—ç¬¦ä¸²</p><ul><li>è¡¨</li></ul><p>è¡¨åˆ™æ˜¯ç”±å¤šä¸ªæ— ç¬¦å·æ•°æˆ–<strong>å…¶ä»–è¡¨ç»„æˆçš„å¤åˆæ•°æ®ç»“æ„</strong>ï¼Œè¡¨çš„åç§°ä¸€èˆ¬ä»¥<code>_info</code>ç»“å°¾ã€‚<strong>æ‰€ä»¥æ•´ä¸ª<code>Class</code>æ–‡ä»¶å…¶å®å°±æ˜¯ä¸€å¼ ç‰¹æ®Šçš„è¡¨</strong></p><p>ä¸‹é¢è¡¨ä¸­æ‰€åˆ—çš„å°±æ˜¯ä¸€ä¸ª<code>Class</code>æŒ‰é¡ºåºæ’åˆ—çš„æ•°æ®ç»“æ„</p><table><thead><tr><th>ç±»å‹</th><th>åç§°</th><th>æ•°é‡</th></tr></thead><tbody><tr><td>u4</td><td>magic é­”æ•° æ ‡è¯†Classæ–‡ä»¶</td><td>1</td></tr><tr><td>u2</td><td>minor_version æ¬¡ç‰ˆæœ¬å·</td><td>1</td></tr><tr><td>u2</td><td>major_version ä¸»ç‰ˆæœ¬å·</td><td>1</td></tr><tr><td>u2</td><td>constant_pool_count å¸¸é‡è¡¨é›†åˆæ•°é‡</td><td>1</td></tr><tr><td>cp_info</td><td>constant_pool å¸¸é‡è¡¨</td><td>constant_pool_count - 1</td></tr><tr><td>u2</td><td>access_flag è®¿é—®æ ‡è¯†</td><td>1</td></tr><tr><td>u2</td><td>this_class ç±»ç´¢å¼•</td><td>1</td></tr><tr><td>u2</td><td>super_class çˆ¶ç±»ç´¢å¼•</td><td>1</td></tr><tr><td>u2</td><td>interfaces_count æ¥å£ç´¢å¼•æ•°é‡</td><td>1</td></tr><tr><td>u2</td><td>interfaces æ¥å£ç´¢å¼•</td><td>interfaces_count</td></tr><tr><td>u2</td><td>fields_count å­—æ®µè¡¨é›†åˆæ•°é‡</td><td>1</td></tr><tr><td>field_info</td><td>fields å­—æ®µè¡¨</td><td>fields_count</td></tr><tr><td>u2</td><td>methods_count æ–¹æ³•è¡¨é›†åˆæ•°é‡</td><td>1</td></tr><tr><td>method_info</td><td>methods æ–¹æ³•è¡¨</td><td>methods_count</td></tr><tr><td>u2</td><td>attributes_count å±æ€§è¡¨é›†åˆæ•°é‡</td><td>1</td></tr><tr><td>attribute_info</td><td>attributes å±æ€§è¡¨</td><td>attributes_count</td></tr></tbody></table><p>ä¸‹é¢ä¾æ¬¡æ¥è§£è¯»è¡¨ä¸­æ¯ä¸ªç±»å‹</p><h3 id="é­”æ•°å’Œç‰ˆæœ¬å·"><a href="#é­”æ•°å’Œç‰ˆæœ¬å·" class="headerlink" title="é­”æ•°å’Œç‰ˆæœ¬å·"></a>é­”æ•°å’Œç‰ˆæœ¬å·</h3><p>å¤´4ä¸ªå­—èŠ‚ç§°ä¸º<code>Class</code>æ–‡ä»¶çš„é­”æ•°ï¼Œé­”æ•°çš„ä½œç”¨æ˜¯æ ‡è¯†æ­¤æ–‡ä»¶èƒ½è¢«Javaè™šæ‹Ÿæœºæ¥å—çš„<code>Class</code>æ–‡ä»¶ï¼Œå…¶å®ä¸æ­¢<code>Class</code>æ–‡ä»¶æœ‰é­”æ•°è¿™ä¸ªæ¦‚å¿µï¼ŒåŒ…æ‹¬å…¶ä»–å¾ˆå¤šæ–‡ä»¶æ ¼å¼å‡ºäºå®‰å…¨çš„è€ƒè™‘ä¹Ÿéƒ½ä¼šæœ‰é­”æ•°è¿™ä¸ªæ¦‚å¿µï¼Œé­”æ•°éƒ½æ˜¯å›ºå®šä¸å˜çš„ï¼Œå¦‚<code>Class</code>æ–‡ä»¶çš„é­”æ•°å°±æ˜¯<code>cafebabe</code></p><p>ç´§æ¥ç€é­”æ•°ä¹‹åçš„æ˜¯ç‰ˆæœ¬å·ï¼Œç¬¬5 6ä¸ªå­—èŠ‚è¡¨ç¤ºçš„æ˜¯æ¬¡ç‰ˆæœ¬å·ï¼Œç¬¬7 8ä¸ªå­—èŠ‚è¡¨ç¤ºçš„æ˜¯ä¸»ç‰ˆæœ¬å·ã€‚ç‰ˆæœ¬å·éƒ½æ˜¯å‘ä¸‹å…¼å®¹çš„</p><h3 id="å¸¸é‡æ± è¡¨"><a href="#å¸¸é‡æ± è¡¨" class="headerlink" title="å¸¸é‡æ± è¡¨"></a>å¸¸é‡æ± è¡¨</h3><p>è¯»æ‡‚å¸¸é‡æ± è¡¨å¯¹äºé˜…è¯»Classå­—èŠ‚ç éå¸¸é‡è¦ï¼Œä¸‹é¢æˆ‘ä»¬å°†ä»¥å¤§ç¯‡å¹…åˆ†æå¸¸é‡æ± è¡¨</p><p>å¸¸é‡æ± æ˜¯<code>Class</code>æ–‡ä»¶ä¸­å‡ºç°çš„ç¬¬ä¸€ä¸ªè¡¨ç»“æ„ç±»å‹ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å ç”¨<code>Class</code>æ–‡ä»¶æœ€å¤§ç©ºé—´çš„ç±»å‹ä¹‹ä¸€ã€‚ç”±äºå¸¸é‡æ± è¡¨çš„æ•°é‡ä¸æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥åœ¨å¸¸é‡æ± çš„å…¥å£æœ‰ä¸€é¡¹<code>u2</code>ç±»å‹çš„æ•°æ®ï¼Œæ¥ä»£è¡¨å¸¸é‡æ± çš„æ•°é‡ã€‚å¹¶ä¸”å¸¸é‡æ± æ¯”è¾ƒç‰¹æ®Šï¼Œå®¹é‡è®¡æ•°æ˜¯ä»1å¼€å§‹è€Œä¸æ˜¯ä»0å¼€å§‹ï¼Œæ‰€ä»¥å®é™…çš„å¸¸é‡æ± æ•°é‡æ˜¯<code>constant_pool_count - 1</code></p><p>å¸¸é‡æ± ä¸­ä¸»è¦å­˜æ”¾ä¸¤å¤§ç±»å˜é‡: å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚å­—é¢é‡ç±»ä¼¼å¸¸é‡çš„æ¦‚å¿µï¼Œè€Œç¬¦å·å¼•ç”¨åˆ™å¼•è‡³ç¼–è¯‘åŸç†çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬ä¸‰ç±»(ç±»å’Œæ¥å£çš„å…¨é™å®šåï¼Œå­—æ®µçš„åç§°å’Œæè¿°ç¬¦ï¼Œæ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦)ï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼ŒJavaåœ¨<code>javac</code>ç¼–è¯‘çš„æ—¶å€™ä¸ä¼šè¿›è¡Œ<code>Class</code>æ–‡ä»¶çš„åŠ¨æ€è¿æ¥ï¼Œ<strong>åªæœ‰åœ¨è¿è¡Œæ—¶æ‰ä¼šè¿›è¡Œå…·ä½“çš„<code>Class</code>æ–‡ä»¶çš„è§£ææ“ä½œ</strong></p><p><img src="http://upload-images.jianshu.io/upload_images/2717496-9a9644b61564b4b6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å¸¸é‡æ± åˆ†ç±»ç±»å‹"></p><h4 id="å¸¸é‡æ± è¡¨ç»“æ„"><a href="#å¸¸é‡æ± è¡¨ç»“æ„" class="headerlink" title="å¸¸é‡æ± è¡¨ç»“æ„"></a>å¸¸é‡æ± è¡¨ç»“æ„</h4><p>ä¸Šæ–‡ä¸¤å¤§ç±»çš„å¸¸é‡æ± ç±»å‹ç»†åˆ†ä¹‹åï¼Œåˆ°JDK1.7ä¹‹åå¢åŠ åˆ°äº†14ç§ã€‚ä¹‹æ‰€ä»¥è¯´å¸¸é‡æ± æ˜¯æœ€å¤æ‚çš„ç»“æ„ï¼Œå°±æ˜¯å› ä¸ºè¿™14ç§ä¸åŒçš„ç±»å‹éƒ½æœ‰ä¸åŒçš„è¡¨ç»“æ„ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ç®€å•çœ‹ä¸‹è¿™14ç§ç»“æ„</p><p>æ¯ç§å¸¸é‡ç±»å‹çš„èµ·å§‹ä½éƒ½æœ‰ä¸€ä¸ª<code>u1</code>ç±»å‹çš„tagæ ‡è¯†ç¬¦ï¼Œç”¨äºæ ‡è¯†å½“å‰çš„å¸¸é‡ç±»å‹</p><p><img src="http://upload-images.jianshu.io/upload_images/2717496-100be34bc99676c0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="æˆªå›¾è‡³æ·±å…¥ç†è§£javaè™šæ‹Ÿæœº"><br><img src="http://upload-images.jianshu.io/upload_images/2717496-16c3df5c9fded87b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="æˆªå›¾è‡³æ·±å…¥ç†è§£javaè™šæ‹Ÿæœº"></p><h3 id="è®¿é—®æ ‡å¿—"><a href="#è®¿é—®æ ‡å¿—" class="headerlink" title="è®¿é—®æ ‡å¿—"></a>è®¿é—®æ ‡å¿—</h3><p>è®¿é—®æ ‡å¿—ç”¨äºè¯†åˆ«ç±»æˆ–æ¥å£å±‚é¢çš„ä¿¡æ¯ï¼Œæ ‡è¯†æ˜¯å¦ä¸º<code>public</code>ï¼Œ<code>abstract</code>ï¼Œ<code>final</code>ï¼Œ<code>æ³¨è§£</code>ï¼Œ<code>æšä¸¾</code>ç­‰</p><h3 id="ç±»ç´¢å¼•-çˆ¶ç±»ç´¢å¼•-æ¥å£ç´¢å¼•"><a href="#ç±»ç´¢å¼•-çˆ¶ç±»ç´¢å¼•-æ¥å£ç´¢å¼•" class="headerlink" title="ç±»ç´¢å¼• çˆ¶ç±»ç´¢å¼• æ¥å£ç´¢å¼•"></a>ç±»ç´¢å¼• çˆ¶ç±»ç´¢å¼• æ¥å£ç´¢å¼•</h3><p>ç±»ç´¢å¼•å’Œçˆ¶ç±»ç´¢å¼•éƒ½æ˜¯ä¸€ä¸ª<code>u2</code>ç±»å‹çš„æ•°æ®ï¼Œè€Œæ¥å£ç´¢å¼•åˆ™æ˜¯ä¸€ç»„<code>u2</code>ç±»å‹çš„é›†åˆï¼Œæ‰€ä»¥æ¥å£ç´¢å¼•å…¥å£çš„ç¬¬ä¸€é¡¹ä¸ºä¸€ä¸ª<code>u2</code>ç±»å‹çš„è®¡æ•°ï¼Œè¡¨ç¤ºæœ‰å‡ ä¸ªæ¥å£ç´¢å¼•</p><p>ç±»ç´¢å¼•å’Œæ¥å£ç´¢å¼•çš„å…·ä½“å€¼æ˜¯ä¸€ä¸ª<code>u2</code>çš„æ•°æ®é¡¹ï¼Œå¹¶ä¸”æŒ‡å‘ä¸€ä¸ª<code>CONSTANT_Class_info</code>å¸¸é‡æ± è¡¨ç±»å‹åœ¨å¸¸é‡æ± ä¸­çš„åç§»é‡</p><h3 id="å­—æ®µè¡¨é›†åˆ"><a href="#å­—æ®µè¡¨é›†åˆ" class="headerlink" title="å­—æ®µè¡¨é›†åˆ"></a>å­—æ®µè¡¨é›†åˆ</h3><p>å­—æ®µè¡¨ç”¨äºæè¿°æ¥å£æˆ–ç±»ä¸­å£°æ˜çš„å˜é‡ï¼ŒåŒ…æ‹¬<strong>ç±»çº§å˜é‡å’Œå®é™…çº§å˜é‡ï¼Œä¸åŒ…æ‹¬åœ¨æ–¹æ³•å†…éƒ¨å£°æ˜çš„å±€éƒ¨å˜é‡</strong></p><p>åŒ…å«çš„ä¿¡æ¯ä¸»è¦æœ‰è¿™å‡ ç§: <code>å­—æ®µä½œç”¨åŸŸ(private,protact,public)</code>ï¼Œ<code>æ˜¯å¦staticä¿®é¥°</code>ï¼Œ<code>å¯å˜æ€§</code>ï¼Œ<code>volatile ä¿®é¥°</code>ï¼Œ<code>å¯å¦è¢«åºåˆ—åŒ–</code>ï¼Œ<code>å­—æ®µç±»å‹(åŸºæœ¬ç±»å‹ï¼Œå¼•ç”¨ï¼Œæ•°ç»„)</code>ï¼Œ<code>å­—æ®µåç§°</code></p><p>å­—æ®µè¡¨ç»“æ„</p><table><thead><tr><th>ç±»å‹</th><th>åç§°</th><th>æ•°é‡ </th></tr></thead><tbody><tr><td>u2</td><td>access_flas</td><td>1 </td></tr><tr><td>u2</td><td>name_index</td><td>1</td></tr><tr><td>u2</td><td>descriptor_index</td><td>1</td></tr><tr><td>u2</td><td>attributes_count</td><td>1</td></tr><tr><td>attribute_info</td><td>å±æ€§è¡¨</td><td>attributes_count</td></tr></tbody></table><h4 id="access-flas"><a href="#access-flas" class="headerlink" title="access_flas"></a>access_flas</h4><p>æˆ‘ä»¬æ¥çœ‹ä¸‹å­—æ®µ<code>access_flas</code>è®¿é—®æ ‡è¯†å¯é€‰çš„ç±»å‹</p><table><thead><tr><th>æ ‡å¿—åç§°</th><th>æ ‡å¿—å€¼</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>ACC_PUBLIC</td><td>0x0001</td><td>å­—æ®µæ˜¯å¦public </td></tr><tr><td>ACC_PRIVARE</td><td>0x0002</td><td>å­—æ®µæ˜¯å¦private</td></tr><tr><td>ACC_PROTECTED</td><td>0x0004</td><td>å­—æ®µæ˜¯å¦protected</td></tr><tr><td>ACC_STATIC</td><td>0x0008</td><td>å­—æ®µæ˜¯å¦static</td></tr><tr><td>ACC_FINAL</td><td>0x0010</td><td>å­—æ®µæ˜¯å¦final</td></tr><tr><td>ACC_VOLATILE</td><td>0x0040</td><td>å­—æ®µæ˜¯å¦volatile</td></tr><tr><td>ACC_TRANSIENT</td><td>0x0080</td><td>æ˜¯å¦ transient</td></tr><tr><td>ACC_SYNTHETIC</td><td>0x1000</td><td>å­—æ®µç”±ç¼–è¯‘å™¨è‡ªåŠ¨äº§ç”Ÿ</td></tr><tr><td>ACC_ENUM</td><td>0x4000</td><td>å­—æ®µæ˜¯å¦ä¸ºæšä¸¾ç±»å‹</td></tr></tbody></table><p>çœ‹ä¸ªä¾‹å­ï¼Œå¦‚æœ<code>access_flas</code>ä¸º<code>0x0019</code>ï¼Œåˆ™æ ‡è¯†äº†<code>ACC_PUBLIC</code>ï¼Œ<code>ACC_STATIC</code>ï¼Œ<code>ACC_FINAL</code>ä¸‰ç§ç±»å‹</p><h4 id="name-indexå’Œdescriptor-index"><a href="#name-indexå’Œdescriptor-index" class="headerlink" title="name_indexå’Œdescriptor_index"></a>name_indexå’Œdescriptor_index</h4><p>è·Ÿåœ¨<code>access_flas</code>ä¹‹åæ˜¯<code>name_index(ç®€å•åç§°)</code>å’Œ<code>descriptor_index(æè¿°ç¬¦)</code>ã€‚åŒ…æ‹¬ä¹‹å‰å‡ºç°çš„<code>å…¨é™å®šå</code>ï¼Œè¿™é‡Œè§£é‡Šä¸€ä¸‹è¿™å‡ ä¸ªåç§°ã€‚å…¨é™å®šåç§°ä¸€èˆ¬æ¥è¯´æ˜¯æŒ‡<code>org/xxx/TestClass</code>è¿™ç§ç±»å‹çš„åç§°ï¼Œå¯ä»¥ç†è§£ä¸ºç±»çš„è·¯å¾„ï¼Œç®€å•åç§°å°±æ›´åŠ å®¹æ˜“ç†è§£äº†ï¼Œä¾‹å¦‚æ–¹æ³•<code>inc()</code>çš„ç®€å•åç§°å€¼çš„å°±æ˜¯<code>inc</code></p><p>æè¿°ç¬¦ç›¸å¯¹äºä¸Šé¢çš„ä¸¤ç§ç¨å¤æ‚ä¸€äº›ï¼Œ<strong>æè¿°ç¬¦çš„ä½œç”¨æ˜¯ç”¨æ¥æè¿°å­—æ®µçš„æ•°æ®ç±»å‹ï¼Œæ–¹æ³•çš„å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼</strong>ï¼Œæ ¹æ®æè¿°ç¬¦è§„åˆ™ï¼ŒåŸºæœ¬æ•°æ®ç±»å‹ï¼ˆbyte,char,int,long,float,double,short,booleanï¼‰ä»¥åŠä»£è¡¨æ— è¿”å›å€¼çš„<code>void</code>ç±»å‹éƒ½ç”¨ä¸€ä¸ªå¤§å†™å­—ç¬¦æ¥è¡¨ç¤ºï¼Œè€Œå¯¹è±¡ç±»å‹åˆ™ç”¨<code>L</code>åŠ å¯¹è±¡çš„å…¨é™å®šåæ¥è¡¨ç¤º</p><p>å…·ä½“çš„åˆ—åœ¨äº†ä¸‹è¡¨ä¸­</p><table><thead><tr><th>æ ‡è¯†å­—ç¬¦</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>B</td><td>byte</td></tr><tr><td>C</td><td>char</td></tr><tr><td>D</td><td>double</td></tr><tr><td>F</td><td>float</td></tr><tr><td>I</td><td>int</td></tr><tr><td>J</td><td>long</td></tr><tr><td>S</td><td>short</td></tr><tr><td>Z</td><td>boolean</td></tr><tr><td>V</td><td>void</td></tr><tr><td>L</td><td>å¯¹è±¡ç±»å‹ å¦‚ Ljava/lang/Object</td></tr></tbody></table><p>å¯¹äºæ•°ç»„ç±»å‹ï¼Œæ¯ä¸€çº¬åº¦ä½¿ç”¨ä¸€ä¸ªå‰ç½®çš„<code>[</code>æ¥è¡¨ç¤ºï¼Œå¦‚å®šä¹‰ä¸€ä¸ª<code>java.lang.String []</code>çš„æ•°ç»„ç±»å‹ï¼Œå°†è¢«è®°å½•ä¸º<code>[[Ljava/lang/String;</code></p><p>ç”¨æè¿°ç¬¦æ¥æè¿°æ–¹æ³•æ—¶ï¼ŒæŒ‰ç…§å…ˆå‚æ•°åˆ—è¡¨åè¿”å›å€¼çš„é¡ºåºæè¿°ï¼Œå‚æ•°åˆ—è¡¨ä¸¥æ ¼æŒ‰ç…§é¡ºåºæ”¾åœ¨<code>()</code>å†…ï¼Œå¦‚æ–¹æ³•<code>void inc()</code>çš„æè¿°ç¬¦ä¸º<code>()V</code>ï¼Œæ–¹æ³•<code>int inc(int i, double)</code>çš„æè¿°ç¬¦ä¸º<code>(ID)I</code></p><p>åœ¨æè¿°ç¬¦ä¹‹åï¼Œç´§è·Ÿç€æ˜¯ä¸€ä¸ªå±æ€§è¡¨é›†åˆï¼Œå±æ€§è¡¨é›†åˆå¯ä»¥ä¸ºç©ºï¼Œ</p><h3 id="æ–¹æ³•è¡¨"><a href="#æ–¹æ³•è¡¨" class="headerlink" title="æ–¹æ³•è¡¨"></a>æ–¹æ³•è¡¨</h3><p><strong>æ–¹æ³•è¡¨çš„ç»„æˆä¸å±æ€§è¡¨çš„ç»„æˆæ˜¯å®Œå…¨ä¸€è‡´çš„</strong>ï¼Œè®¿é—®æ ‡è¯†ç¬¦çš„å–å€¼ç•¥æœ‰ä¸åŒ</p><table><thead><tr><th>æ ‡å¿—åç§°</th><th>æ ‡å¿—å€¼</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>ACC_PUBLIC</td><td>0x0001</td><td>æ–¹æ³•æ˜¯å¦public </td></tr><tr><td>ACC_PRIVARE</td><td>0x0002</td><td>æ–¹æ³•æ˜¯å¦private</td></tr><tr><td>ACC_PROTECTED</td><td>0x0004</td><td>æ–¹æ³•æ˜¯å¦protected</td></tr><tr><td>ACC_STATIC</td><td>0x0008</td><td>æ–¹æ³•æ˜¯å¦static</td></tr><tr><td>ACC_FINAL</td><td>0x0010</td><td>æ–¹æ³•æ˜¯å¦final</td></tr><tr><td>ACC_SYNCHRONIZED</td><td>0x0020</td><td>æ–¹æ³•æ˜¯å¦åŒæ­¥</td></tr><tr><td>ACC_BRIDGE</td><td>0x0040</td><td>æ–¹æ³•æ˜¯å¦ç”±ç¼–è¯‘å™¨äº§ç”Ÿçš„æ¡¥æ¥æ–¹æ³•</td></tr><tr><td>ACC_VARARGS</td><td>0x0080</td><td>æ–¹æ³•æ˜¯å¦æ¥å—ä¸å®šèš•é£Ÿ</td></tr><tr><td>ACC_NATIVE</td><td>0x0100</td><td>æ–¹æ³•æ˜¯å¦ä¸ºnative</td></tr><tr><td>ACC_ABSTRACT</td><td>0x0400</td><td>æ–¹æ³•æ˜¯å¦ä¸ºabstract</td></tr><tr><td>ACC_STRICTFP</td><td>0x0800</td><td>æ–¹æ³•æ˜¯å¦ä¸ºstrictfp</td></tr><tr><td>SYNTHETIC</td><td>0x1000</td><td>æ–¹æ³•ç”±ç¼–è¯‘å™¨è‡ªåŠ¨äº§ç”Ÿ</td></tr></tbody></table><p>é‚£ä¹ˆè¿™é‡Œå¤§å®¶å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œæ–¹æ³•é‡Œçš„javaä»£ç å»å“ªäº†å‘¢ï¼Ÿ ç­”æ¡ˆå°±æ˜¯åœ¨æ–¹æ³•è¡¨çš„å±æ€§è¡¨é›†åˆä¸­ï¼Œæœ‰ä¸€ä¸ª<code>code</code>å±æ€§ï¼Œé‚£é‡Œå­˜æ”¾äº†ç¼–è¯‘æˆå­—èŠ‚ç çš„Javaä»£ç ã€‚å¯¹äºå±æ€§è¡¨ï¼Œåœ¨ä¸‹æ–‡ä¼šæåˆ°</p><h3 id="å±æ€§è¡¨"><a href="#å±æ€§è¡¨" class="headerlink" title="å±æ€§è¡¨"></a>å±æ€§è¡¨</h3><p>å±æ€§è¡¨ï¼Œå‰æ–‡å·²ç»æåˆ°äº†å¤šæ¬¡ã€‚åŒ…æ‹¬<code>Class</code>æ–‡ä»¶æœ¬èº«ï¼Œ<code>æ–¹æ³•è¡¨</code>ï¼Œ<code>å­—æ®µè¡¨</code>éƒ½æœ‰æºå¸¦è‡ªå·±çš„å±æ€§è¡¨é›†åˆï¼Œç”¨äºæè¿°ä¸“æœ‰åœºæ™¯ä¿¡æ¯</p><p>å¹¶ä¸”å±æ€§è¡¨ä¸<code>Class</code>æ–‡ä»¶å…¶ä»–æ•°æ®é¡¹è¦æ±‚ä¸åŒï¼Œå„ä¸ªå±æ€§ä¸è¦æ±‚ä¸¥æ ¼çš„é¡ºåºï¼Œå¹¶ä¸”åªè¦ä¸ä¸å·²æœ‰å±æ€§åé‡å¤ï¼Œä»»ä½•äººå®ç°çš„ç¼–è¯‘å™¨éƒ½å¯ä»¥å‘å±æ€§è¡¨ä¸­å†™å…¥è‡ªå·±å®šä¹‰çš„å±æ€§ä¿¡æ¯</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªå…³é”®å±æ€§</p><h4 id="code-å±æ€§"><a href="#code-å±æ€§" class="headerlink" title="code å±æ€§"></a>code å±æ€§</h4><p>javaç¨‹åºæ–¹æ³•ä½“ä¸­çš„ä»£ç <code>javac</code>ç¼–è¯‘å™¨å¤„ç†åï¼Œæœ€ç»ˆå˜ä¸ºå­—èŠ‚ç å­ä»¤å­˜å‚¨åœ¨<code>Code</code>å±æ€§å†…</p><h4 id="Exceptions-å±æ€§"><a href="#Exceptions-å±æ€§" class="headerlink" title="Exceptions å±æ€§"></a>Exceptions å±æ€§</h4><p>åˆ—ä¸¾æ–¹æ³•å¯èƒ½ä¼šæŠ›å‡ºçš„å¼‚å¸¸</p><h4 id="LineNumberTable-å±æ€§"><a href="#LineNumberTable-å±æ€§" class="headerlink" title="LineNumberTable å±æ€§"></a>LineNumberTable å±æ€§</h4><p>æè¿°javaæºç è¡Œæ•°å’Œå­—èŠ‚ç è¡Œæ•°çš„å¯¹åº”å…³ç³»ï¼Œå‰è€…æ˜¯å­—èŠ‚ç è¡Œï¼Œåè€…æ˜¯æºç è¡Œ</p><h4 id="LocalVariableTable-å±æ€§"><a href="#LocalVariableTable-å±æ€§" class="headerlink" title="LocalVariableTable å±æ€§"></a>LocalVariableTable å±æ€§</h4><p>æè¿°æ ˆå±€éƒ¨å˜é‡å’Œæºç ä¸­å®šä¹‰çš„å˜é‡çš„å…³ç³».è¿™é¡¹æ˜¯å¯é€‰çš„ï¼Œå¯ä½¿ç”¨<code>javac -g:none</code>æˆ–<code>javac -g:vars</code>å‘½ä»¤å…³é—­ç”Ÿæˆè¿™é¡¹ä¿¡æ¯</p><h4 id="SourceFile-å±æ€§"><a href="#SourceFile-å±æ€§" class="headerlink" title="SourceFile å±æ€§"></a>SourceFile å±æ€§</h4><p>ç”¨äºè®°å½•Classæºç æ–‡ä»¶çš„æ–‡ä»¶åç§°ï¼Œè¿™ä¸ªå±æ€§æ˜¯å¯é€‰çš„ã€‚å¯ä½¿ç”¨<code>javac -g:none</code>æˆ–<code>javac -g:source</code>å‘½ä»¤å…³é—­ç”Ÿæˆè¿™é¡¹ä¿¡æ¯</p><h4 id="ConstantValue-å±æ€§"><a href="#ConstantValue-å±æ€§" class="headerlink" title="ConstantValue å±æ€§"></a>ConstantValue å±æ€§</h4><p>é€šçŸ¥è™šæ‹Ÿæœºä¸ºé™æ€å˜é‡èµ‹å€¼</p><h4 id="InnerClasses-å±æ€§"><a href="#InnerClasses-å±æ€§" class="headerlink" title="InnerClasses å±æ€§"></a>InnerClasses å±æ€§</h4><p>ç”¨äºè®°å½•å†…éƒ¨ç±»ä¸å®¿ä¸»ç±»ä¹‹é—´çš„å…³ç³»</p><h4 id="Deprecated-Synthetic-å±æ€§"><a href="#Deprecated-Synthetic-å±æ€§" class="headerlink" title="Deprecated Synthetic å±æ€§"></a>Deprecated Synthetic å±æ€§</h4><p><code>Deprecated</code> æ ‡è¯†æŸä¸ªç±»ï¼Œå­—æ®µæˆ–æ–¹æ³•è¿‡æœŸ<br><code>Synthetic</code> æ ‡è¯†æ­¤å­—æ®µä¸ç”±Javaæºç ç›´æ¥äº§ç”Ÿï¼Œç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ·»åŠ </p><h4 id="StackMapTable-å±æ€§"><a href="#StackMapTable-å±æ€§" class="headerlink" title="StackMapTable å±æ€§"></a>StackMapTable å±æ€§</h4><p>è¿™ä¸ªå±æ€§ä¼šåœ¨è™šæ‹ŸæœºåŠ è½½å®Œå­—èŠ‚ç åçš„éªŒè¯é˜¶æ®µè¢«ä½¿ç”¨</p><h4 id="Signature-å±æ€§"><a href="#Signature-å±æ€§" class="headerlink" title="Signature å±æ€§"></a>Signature å±æ€§</h4><p><code>Signature</code>åœ¨<code>JDK1.5</code>ä¹‹åè¢«æ·»åŠ ï¼Œç”¨äºè®°å½•æ³›å‹ç­¾åä¿¡æ¯ã€‚ä¹‹æ‰€ä»¥è¦ç”¨è¿™ä¹ˆä¸€ä¸ªå±æ€§å»è®°å½•æ³›å‹ä¿¡æ¯ï¼Œæ˜¯å› ä¸ºJavaè¯­è¨€çš„æ³›å‹é‡‡ç”¨çš„æ˜¯æ“¦é™¤æ³•å®ç°çš„ä¼ªæ³›å‹ï¼Œåœ¨<code>Code</code>å±æ€§ä¸­ï¼Œæ³›å‹ä¿¡æ¯åœ¨ç¼–è¯‘ä¹‹åç»Ÿç»Ÿéƒ½è¢«æ“¦é™¤æ‰äº†ã€‚ä½¿ç”¨çš„æ“¦é™¤æ³•çš„åŸå› æ˜¯è¿™æ ·å­å®ç°æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦ä¿®æ”¹<code>javac</code>ç¼–è¯‘å™¨å°±å¯ä»¥å®ç°äº†ï¼Œè¿è¡Œæ—¶ä¹Ÿå¯ä»¥èŠ‚çœä¸€äº›ç©ºé—´ã€‚åå¤„å°±æ˜¯è¿è¡Œæ—¶æ— æ³•æ‹¿åˆ°æ³›å‹ä¿¡æ¯ã€‚<code>Signature</code>å°±æ˜¯ä¸ºäº†å¼¥è¡¥è¿™ä¸ªç¼ºé™·è€Œè®¾ç½®çš„ï¼Œç°åœ¨çš„Java APIåå°„èƒ½å¤Ÿè·å–åˆ°çš„æ³›å‹ä¿¡æ¯ä¹Ÿæ¥è‡ªè¿™ä¸ªå±æ€§</p><h4 id="BootStrapMathods-å±æ€§"><a href="#BootStrapMathods-å±æ€§" class="headerlink" title="BootStrapMathods å±æ€§"></a>BootStrapMathods å±æ€§</h4><p><code>BootStrapMathods</code>æ˜¯JDK 1.7ä¹‹åå¢åŠ åˆ°è§„èŒƒä¸­çš„ï¼Œè¿™ä¸ªå±æ€§ç”¨äºä¿å­˜<code>invokedynamic</code>æŒ‡ä»¤å¼•ç”¨çš„å¼•å¯¼æ–¹æ³•é™å®šç¬¦ã€‚æœ¬ç¯‡æ–‡ç« æš‚ä¸èµ˜è¿°è¿™ä¸ªæŒ‡ä»¤</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;æˆ‘ä»¬éƒ½çŸ¥é“javaæ˜¯è·¨å¹³å°çš„ï¼ŒåŸå› å°±åœ¨äºå„ä¸ªå¹³å°çš„javaè™šæ‹Ÿæœºå¯ä»¥è½½å…¥å’Œæ‰§è¡ŒåŒä¸€ç§å¹³å°æ— å…³çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´javaè™šæ‹Ÿæœºä¸ä¸åŒ…æ‹¬Ja
      
    
    </summary>
    
      <category term="javaåŸºç¡€" scheme="http://wangjunnan.github.io/categories/java%E5%9F%BA%E7%A1%80/"/>
    
      <category term="JVM" scheme="http://wangjunnan.github.io/categories/java%E5%9F%BA%E7%A1%80/JVM/"/>
    
      <category term="javaå­—èŠ‚ç " scheme="http://wangjunnan.github.io/categories/java%E5%9F%BA%E7%A1%80/JVM/java%E5%AD%97%E8%8A%82%E7%A0%81/"/>
    
    
      <category term="JVM" scheme="http://wangjunnan.github.io/tags/JVM/"/>
    
      <category term="javaå­—èŠ‚ç " scheme="http://wangjunnan.github.io/tags/java%E5%AD%97%E8%8A%82%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>Javaç±»åŠ è½½æœºåˆ¶</title>
    <link href="http://wangjunnan.github.io/2019/04/02/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/"/>
    <id>http://wangjunnan.github.io/2019/04/02/Javaç±»åŠ è½½æœºåˆ¶/</id>
    <published>2019-04-02T07:35:40.000Z</published>
    <updated>2019-09-27T05:52:47.703Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>ä»‹ç»ä¸€ä¸‹javaç±»åŠ è½½çš„è¿‡ç¨‹</p><h2 id="ç±»åŠ è½½çš„æ—¶æœº"><a href="#ç±»åŠ è½½çš„æ—¶æœº" class="headerlink" title="ç±»åŠ è½½çš„æ—¶æœº"></a>ç±»åŠ è½½çš„æ—¶æœº</h2><p>ç±»ä»è¢«åŠ è½½åˆ°javaè™šæ‹Ÿæœºå†…å­˜ä¸­å¼€å§‹ï¼Œè¢«åˆ†ä¸º7ä¸ªé˜¶æ®µï¼ŒåŒ…æ‹¬<code>åŠ è½½</code>ï¼Œ<code>éªŒè¯</code>ï¼Œ<code>å‡†å¤‡</code>ï¼Œ<code>è§£æ</code>ï¼Œ<code>åˆå§‹åŒ–</code>ï¼Œ<code>ä½¿ç”¨</code>ï¼Œ<code>å¸è½½</code></p><p><img src="http://upload-images.jianshu.io/upload_images/2717496-793f9be59d3a7ea2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>è¿™é‡Œæˆ‘ä»¬æš‚ä¸”ä¸»è¦çœ‹åŠ è½½é˜¶æ®µå’Œåˆå§‹åŒ–é˜¶æ®µï¼Œjavaè™šæ‹Ÿæœºä¸»è¦æ˜¯åšäº†ä¸‰ä»¶äº‹æƒ…</p><h2 id="åŠ è½½"><a href="#åŠ è½½" class="headerlink" title="åŠ è½½"></a>åŠ è½½</h2><ol><li>é€šè¿‡ç±»çš„å…¨é™å®šåè·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ</li><li>å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„</li><li>åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„<code>Class</code>å¯¹è±¡</li></ol><p>æ³¨æ„è¿™é‡Œè™šæ‹Ÿæœºå¹¶æ²¡æœ‰è§„å®šç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµçš„æ¥æºï¼Œæ‰€ä»¥æˆ‘ä»¬å…¶å®é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥å®ç°ä»å…¶ä»–é€”å¾„ï¼ˆå¦‚ç½‘ç»œä¸­è·å–ï¼‰ä¸­è·å–Classæ–‡ä»¶çš„äºŒè¿›åˆ¶å­—èŠ‚æµ</p><h2 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h2><p>åˆå§‹åŒ–é˜¶æ®µæ˜¯ç±»åŠ è½½çš„æœ€åä¸€ä¸ªé˜¶æ®µï¼Œå¯ä»¥ç†è§£æˆ<code>åˆå§‹é™æ€å—åŠé™æ€å˜é‡</code>ï¼Œåœ¨å‡†å¤‡é˜¶æ®µï¼Œé™æ€å˜é‡å·²ç»èµ‹äº†åˆå§‹å€¼ï¼Œåˆå§‹åŒ–é˜¶æ®µèµ‹çš„å°±æ˜¯å…·ä½“çš„å€¼ã€‚</p><p><strong>åˆå§‹åŒ–çš„å¿…è¦æ¡ä»¶ï¼Œå¹¶ä¸”æœ‰ä¸”åªæœ‰è¿™5ç§æƒ…å†µæ‰ä¼šè§¦å‘ç±»çš„åˆå§‹åŒ–</strong></p><ol><li>é‡åˆ°<code>new</code>,<code>getstatic</code>,<code>putstatic</code>,<code>invokestatic</code>è¿™å››ä¸ªå­—èŠ‚ç æ—¶ï¼Œå¦‚æœè¿˜æœªæ‰§è¡Œç±»çš„åˆå§‹åŒ–åˆ™ä¼šæ‰§è¡Œåˆå§‹åŒ–</li><li>ä½¿ç”¨<code>java.lang.reflect</code>åŒ…è¿›è¡Œåå°„è°ƒç”¨æ—¶ï¼Œå¦‚æœè¿˜æ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆ™ä¼šæ‰§è¡Œåˆå§‹åŒ–</li><li>å½“åˆå§‹åŒ–ä¸€ä¸ªç±»æ—¶ï¼Œå‘ç°å…¶çˆ¶ç±»è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™ä¼šåˆå§‹åŒ–å…¶çˆ¶ç±»</li><li>å½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œç”¨æˆ·éœ€è¦æŒ‡å®šä¸€ä¸ªä¸»ç±»ï¼Œè¿™ä¸ªä¸»ç±»ä¼šè¢«åˆå§‹åŒ–</li><li>ä½¿ç”¨jdk7åŠ¨æ€è¯­è¨€æ”¯æŒæ—¶ï¼Œä¼šæ‰§è¡Œåˆå§‹åŒ–</li></ol><p>ä»¥ä¸Š5ä¸­åœºæ™¯ï¼Œç§°ä¸ºå¯¹ä¸€ä¸ªç±»çš„ä¸»åŠ¨å¼•ç”¨ã€‚é™¤è¿™5ç§æ–¹å¼ä¹‹å¤–ï¼Œä»»ä½•å…¶ä»–å¼•ç”¨éƒ½è¢«ç§°ä¸ºè¢«åŠ¨å¼•ç”¨ï¼Œå¹¶ä¸”éƒ½ä¸ä¼šè§¦å‘ç±»çš„åˆå§‹åŒ–ã€‚</p><p>ä¸‹é¢ä¸¾ä¸‰ç§æƒ…å†µæ¥è¯´æ˜è¢«åŠ¨å¼•ç”¨</p><ul><li>é€šè¿‡å­ç±»å¼•ç”¨çˆ¶ç±»é™æ€å­—æ®µï¼Œä¸ä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public class BoshiCat extends Cat &#123;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        System.out.println(&quot;BoshiCat init&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Cat &#123;</span><br><span class="line">    static &#123;</span><br><span class="line">        System.out.println(&quot;Cat init&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public static int value = 10;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Test &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(BoshiCat.value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// è¾“å‡º 10</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡æ•°ç»„æ¥å¼•ç”¨ç±»ï¼Œä¸ä¼šè§¦å‘å¼•ç”¨ç±»çš„åˆå§‹åŒ–</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class Test &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Cat []  cats = new Cat[10];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è¾“å‡º 10</span><br></pre></td></tr></table></figure><ul><li>å¼•ç”¨<code>static final</code>ä¿®é¥°çš„å¸¸é‡ï¼Œå› ä¸ºå¸¸é‡åœ¨ç¼–è¯‘é˜¶æ®µå°±è¢«å†™è¿›äº†å¸¸é‡æ± </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class Cat &#123;</span><br><span class="line">    static &#123;</span><br><span class="line">        System.out.println(&quot;Cat init&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public static final int value = 10;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Test &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(Cat.value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// è¾“å‡º 10</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;ä»‹ç»ä¸€ä¸‹javaç±»åŠ è½½çš„è¿‡ç¨‹&lt;/p&gt;
&lt;h2 id=&quot;ç±»åŠ è½½çš„æ—¶æœº&quot;&gt;&lt;a href=&quot;#ç±»åŠ è½½çš„æ—¶æœº&quot; class=&quot;headerlink
      
    
    </summary>
    
      <category term="javaåŸºç¡€" scheme="http://wangjunnan.github.io/categories/java%E5%9F%BA%E7%A1%80/"/>
    
      <category term="JVM" scheme="http://wangjunnan.github.io/categories/java%E5%9F%BA%E7%A1%80/JVM/"/>
    
    
      <category term="JVM" scheme="http://wangjunnan.github.io/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>ReentrantLockå¯é‡å…¥é”æºç åˆ†æ</title>
    <link href="http://wangjunnan.github.io/2019/03/25/ReentrantLock%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://wangjunnan.github.io/2019/03/25/ReentrantLockå¯é‡å…¥é”æºç åˆ†æ/</id>
    <published>2019-03-25T08:19:02.000Z</published>
    <updated>2019-09-27T05:52:47.708Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p><code>ReentrantLock</code>å¯é‡å…¥é”ï¼Œä¹Ÿæ˜¯æ—¥å¸¸ä½¿ç”¨é™¤äº†<code>synchronized</code>å…³é”®å­—æœ€å¤šçš„é”ã€‚ä»å­—é¢ä¸Šç†è§£å¯é‡å…¥çš„æ„æ€å°±æ˜¯<strong>åŒä¸€ä¸ªçº¿ç¨‹</strong>å¯ä»¥é‡å¤åŠ é”ï¼Œå½“ç„¶<code>synchronized</code>å…³é”®å­—ä¹Ÿæ˜¯æ”¯æŒå¯é‡å…¥çš„ï¼Œå…¶å®å®ƒä»¬çš„ä¸»è¦åŠŸèƒ½ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œä½†æ˜¯ç›¸æ¯”è¾ƒæ¥è¯´ï¼Œ<code>ReentrantLock</code>åŠŸèƒ½æ›´çµæ´»ä¸°å¯Œï¼Œä¾‹å¦‚<code>ReentrantLock</code>æ”¯æŒè®¾ç½®å…¬å¹³é”æˆ–éå…¬å¹³é”ï¼Œæ”¯æŒåˆ†ç»„å”¤é†’éœ€è¦å”¤é†’çš„çº¿ç¨‹ä»¬ï¼Œè€Œä¸æ˜¯åƒ<code>synchronized</code>è¦ä¹ˆéšæœºå”¤é†’ä¸€ä¸ªçº¿ç¨‹è¦ä¹ˆå”¤é†’å…¨éƒ¨çº¿ç¨‹ã€‚</p><p>æ•´ä¸ª<code>ReentrantLock</code>çš„å®ç°åŸºäº<code>AQS</code>ç‹¬å é”ï¼Œè¿™ä¸ªåœ¨ä¸Šç¯‡æ–‡ç« å·²ç»è¯¦ç»†åˆ†æè¿‡</p><h2 id="ç±»ç»“æ„"><a href="#ç±»ç»“æ„" class="headerlink" title="ç±»ç»“æ„"></a>ç±»ç»“æ„</h2><ul><li>ReentrantLock.class</li></ul><p><img src="http://upload-images.jianshu.io/upload_images/2717496-de0aa2e9894c7a7d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><img src="http://upload-images.jianshu.io/upload_images/2717496-94b5fd02f6a75420.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p><code>ReentrantLock</code>å®ç°äº†<code>Lock</code>æ¥å£ï¼Œä½†æ˜¯é€šè¿‡æŸ¥çœ‹æºç å¯çŸ¥<code>ReentrantLock</code>çš„å…·ä½“å®ç°å…¶å®éƒ½å§”æ‰˜ç»™äº†<code>NonfairSynsï¼ˆéå…¬å¹³é”ï¼‰</code>æˆ–åˆ™<code>FairSyncï¼ˆå…¬å¹³é”ï¼‰</code>ä¸¤ä¸ªç±»å®ç°ï¼Œ<code>NonfairSyns</code>å’Œ<code>FairSync</code>ç»§æ‰¿äº†æŠ½è±¡é™æ€ç±»<code>Sync</code>ï¼Œ<code>Sync</code>åˆ™æ˜¯<code>AQS</code>çš„å­ç±»</p><h2 id="å…¬å¹³é”-éå…¬å¹³é”"><a href="#å…¬å¹³é”-éå…¬å¹³é”" class="headerlink" title="å…¬å¹³é” éå…¬å¹³é”"></a>å…¬å¹³é” éå…¬å¹³é”</h2><p><code>ReentrantLock</code>æ”¯æŒå…¬å¹³é”ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯å…¬å¹³é”å‘¢ï¼Ÿç®€å•çš„ç†è§£å°±æ˜¯å¤šä¸ªçº¿ç¨‹è·å–é”çš„é¡ºåºåº”è¯¥æ˜¯æŒ‰ç…§æ—¶é—´çš„å…ˆåï¼Œå…ˆæ¥çš„å…ˆè·å–ã€‚ä¹Ÿå°±æ˜¯è¯´å…¬å¹³é”ç»å¯¹æ»¡è¶³å…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—å½¢å¼ã€‚</p><p>æˆ‘ä»¬ä»<code>AQS</code>åŒæ­¥é˜Ÿåˆ—æ¥ç†è§£çš„è¯ï¼Œå¯ä»¥è®¤ä¸º<code>å…¬å¹³é”</code>æ¯æ¬¡éƒ½æ˜¯ä»åŒæ­¥é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è·å–åˆ°é”ï¼Œè€Œéå…¬å¹³é”åˆ™ä¸ä¸€å®šï¼Œæœ‰å¯èƒ½å æ®é”çš„çº¿ç¨‹åˆšé‡Šæ”¾é”ï¼ŒåŒæ­¥é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹è¿˜æœªæ¥å¾—åŠè·å–åˆ°é”ï¼Œå°±è¢«æ–°è¯·æ±‚é”çš„çº¿ç¨‹è·å–äº†ã€‚å½“ç„¶è¿™é‡Œè¦æ³¨æ„ï¼Œå¯¹äºå·²ç»åŠ å…¥<code>AQS</code>åŒæ­¥é˜Ÿåˆ—çš„çº¿ç¨‹æ¥è¯´ï¼Œæ— è®º<code>å…¬å¹³é”</code>è¿˜æ˜¯<code>éå…¬å¹³é”</code>éƒ½æ˜¯ä¸€æ ·çš„ï¼ŒæŒ‰ç…§é˜Ÿåˆ—å…ˆåé¡ºåºè·å–ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹<code>ReentrantLock</code>çš„æ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync = <span class="keyword">new</span> NonfairSync();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">    sync = fair ? <span class="keyword">new</span> FairSync() : <span class="keyword">new</span> NonfairSync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>ReentrantLock</code>æ— å‚æ„é€ é»˜è®¤æ˜¯éå…¬å¹³é”</li><li>å¯ä»¥é€šè¿‡è®¾ç½®å‚æ•°å°†<code>ReentrantLock</code>è®¾ç½®ä¸ºå…¬å¹³é”</li></ul><p>ä»ä»£ç å±‚é¢çœ‹å®ç°åŒºåˆ«</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * éå…¬å¹³é”è·å–é”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å…¬å¹³é”è·å–é”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å¾ˆæ˜æ˜¾çš„åŒºåˆ«ï¼Œ<code>éå…¬å¹³é”</code>è·å–é”ï¼Œåªè¦å½“å‰æ²¡æœ‰æŒé”çº¿ç¨‹ï¼Œæ–°åŠ å…¥çš„çº¿ç¨‹éƒ½æœ‰æœºä¼šè·å–åˆ°é”</p><h2 id="å¯é‡å…¥"><a href="#å¯é‡å…¥" class="headerlink" title="å¯é‡å…¥"></a>å¯é‡å…¥</h2><p>ä¸Šæ–‡è¯´è¿‡ï¼Œå¯é‡å…¥çš„æ¦‚å¿µåªé’ˆå¯¹åŒä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆ<code>ReentrantLock</code>æ˜¯å¦‚ä½•å®ç°åŒä¸€ä¸ªçº¿ç¨‹å¯é‡å…¥çš„å‘¢ï¼Ÿ</p><p>è¿™å°±åˆè¦æ¶‰åŠåˆ°<code>AQS state</code>çš„æ¦‚å¿µï¼Œåœ¨<code>AQS</code>å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªçŠ¶æ€å€¼<code>state</code>ï¼Œå½“æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°é”ï¼Œ<code>state</code>å€¼å°±ä¼š<code>+1</code>ï¼Œå¯¹äºç‹¬å é”æ¥è¯´ï¼Œä¸åŒçš„çº¿ç¨‹è¦æƒ³è·å–é”ï¼Œ<code>state</code>å€¼å¿…é¡»ä¸º0ã€‚ä¸‹é¢æˆ‘ä»¬å°±é€šè¿‡æºç æ¥çœ‹çœ‹<code>ReentrantLock</code>æ˜¯å¦‚ä½•å®ç°å¯é‡å…¥æ€§çš„</p><p>ä»¥éå…¬å¹³é”ä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°è¯•è·å–é”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰è·å–é”çš„çº¿ç¨‹ä¸º0ï¼Œåˆ™ç›´æ¥è·å–</span></span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    <span class="comment">// è°ƒç”¨AQSæ¨¡æ¿æ–¹æ³•ï¼Œä¼šè°ƒç”¨å­ç±»çš„tryAcquire</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * éå…¬å¹³æ–¹æ³•å°è¯•è·å–é”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰è·å–é”çš„çº¿ç¨‹ä¸º0ï¼Œåˆ™ç›´æ¥è·å–é”</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰è·å–é”çš„çº¿ç¨‹ä¸ºå½“å‰è¯·æ±‚çº¿ç¨‹ï¼Œåˆ™å°†state + 1</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é¦–å…ˆä¼šåˆ¤æ–­<code>state</code>çŠ¶æ€æ˜¯å¦ä¸º0(ä¹Ÿå°±æ˜¯å½“æ—¶è¿˜æ²¡æœ‰æŒé”çº¿ç¨‹)ï¼Œå¦‚æœä¸º0çš„è¯åˆ™ç›´æ¥è·å–é”</li><li><code>state</code>çŠ¶æ€ä¸ä¸º0.åˆ™åˆ¤æ–­ä¸å½“å‰æŒé”çº¿ç¨‹æ˜¯å¦ä¸ºåŒä¸€ä¸ªçº¿ç¨‹ï¼Œæ˜¯çš„è¯ï¼Œåˆ™<code>state</code>è‡ªå¢1.è·å–é”æˆåŠŸ</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ€»çš„æ¥è¯´ï¼Œ<code>ReentrantLock</code>å’Œ<code>synchronized</code>éå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯ä¹Ÿè¿˜æ˜¯æ¯”è¾ƒå¤§çš„åŒºåˆ«ï¼Œ<code>ReentrantLock</code>çš„åŠŸèƒ½æ›´ä¸°å¯Œçµæ´»ï¼Œ<code>synchronized</code>åªæ”¯æŒéå…¬å¹³é”ï¼Œ<code>ReentrantLock</code>å¯ä»¥æ”¯æŒ<code>å…¬å¹³é”</code>ï¼Œå¹¶ä¸”<code>ReentrantLock</code>æ”¯æŒ<code>Condition</code>ç­‰ï¼Œå¯ä»¥æ‰¹é‡åˆ†ç»„å”¤é†’ç­‰å¾…çº¿ç¨‹ã€‚</p><p>`</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;&lt;code&gt;ReentrantLock&lt;/code&gt;å¯é‡å…¥é”ï¼Œä¹Ÿæ˜¯æ—¥å¸¸ä½¿ç”¨é™¤äº†&lt;code&gt;synchronized&lt;/code&gt;å…³é”®å­—æœ€å¤šçš„
      
    
    </summary>
    
      <category term="javaåŸºç¡€" scheme="http://wangjunnan.github.io/categories/java%E5%9F%BA%E7%A1%80/"/>
    
      <category term="å¹¶å‘ç¼–ç¨‹" scheme="http://wangjunnan.github.io/categories/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    
    
      <category term="å¹¶å‘" scheme="http://wangjunnan.github.io/tags/%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
</feed>
