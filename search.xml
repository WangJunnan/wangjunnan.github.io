<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[Sentinelæºç è§£æä¸‰ï¼ˆæ»‘åŠ¨çª—å£æµé‡ç»Ÿè®¡ï¼‰]]></title>
    <url>%2F2019%2F10%2F25%2FSentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89%EF%BC%88%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%B5%81%E9%87%8F%E7%BB%9F%E8%AE%A1%EF%BC%89%2F</url>
    <content type="text"><![CDATA[å‰è¨€Sentinelçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€æ˜¯æµé‡ç»Ÿè®¡ï¼Œä¾‹å¦‚æˆ‘ä»¬å¸¸ç”¨çš„æŒ‡æ ‡QPSï¼Œå½“å‰çº¿ç¨‹æ•°ç­‰ã€‚ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»å¤§è‡´æåˆ°äº†æä¾›æ•°æ®ç»Ÿè®¡åŠŸèƒ½çš„Slotï¼ˆStatisticSlotï¼‰ï¼ŒStatisticSlotåœ¨Sentinelçš„æ•´ä¸ªä½“ç³»ä¸­æ‰®æ¼”äº†ä¸€ä¸ªéå¸¸é‡è¦çš„è§’è‰²ï¼Œåç»­çš„ä¸€ç³»åˆ—æ“ä½œï¼ˆé™æµï¼Œç†”æ–­ï¼‰ç­‰éƒ½ä¾èµ–äºStatisticSlotæ‰€ç»Ÿè®¡å‡ºçš„æ•°æ®ã€‚ æœ¬æ–‡æ‰€è¦è®¨è®ºçš„é‡ç‚¹å°±æ˜¯StatisticSlotæ˜¯å¦‚ä½•åšçš„æµé‡ç»Ÿè®¡ï¼Ÿ å…¶å®åœ¨ä¹‹å‰ä»‹ç»å¸¸ç”¨é™æµç®—æ³•å¸¸ç”¨é™æµç®—æ³•çš„æ—¶å€™å·²ç»æœ‰æåˆ°è¿‡ä¸€ä¸ªç®—æ³•æ»‘åŠ¨çª—å£é™æµï¼Œè¯¥ç®—æ³•çš„æ»‘åŠ¨çª—å£åŸç†å…¶å®è·ŸSentinelæ‰€æä¾›çš„æµé‡ç»Ÿè®¡åŸç†æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯åŸºäºæ—¶é—´çª—å£çš„æ»‘åŠ¨ç»Ÿè®¡ å›åˆ°StatisticSlot12345678910public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, boolean prioritized, Object... args) throws Throwable &#123; ... // å½“å‰è¯·æ±‚çº¿ç¨‹æ•°åŠ ä¸€ node.increaseThreadNum(); // æ–°å¢è¯·æ±‚æ•° node.addPassRequest(count); ...&#125; å¯ä»¥çœ‹åˆ°StatisticSlotä¸»è¦ç»Ÿè®¡äº†ä¸¤ç§ç±»å‹çš„æ•°æ® çº¿ç¨‹æ•° è¯·æ±‚æ•°ï¼ˆQPSï¼‰ å¯¹äºçº¿ç¨‹æ•°çš„ç»Ÿè®¡æ¯”è¾ƒç®€å•ï¼Œé€šè¿‡å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªLongAdderæ¥è¿›è¡Œå½“å‰çº¿ç¨‹æ•°çš„ç»Ÿè®¡ï¼Œæ¯è¿›å…¥ä¸€ä¸ªè¯·æ±‚åŠ 1ï¼Œæ¯é‡Šæ”¾ä¸€ä¸ªè¯·æ±‚å‡1ï¼Œä»è€Œå¾—åˆ°å½“å‰çš„çº¿ç¨‹æ•° å¯¹äºè¯·æ±‚æ•°QPSçš„ç»Ÿè®¡åˆ™ç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œå…¶ä¸­æœ‰ç”¨åˆ°æ»‘åŠ¨çª—å£åŸç†ï¼ˆä¹Ÿæ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼‰ï¼Œä¸‹é¢æ ¹æ®æºç æ¥æ·±å…¥çš„åˆ†æ DefaultNode å’Œ StatisticNode123456public void addPassRequest(int count) &#123; // è°ƒç”¨çˆ¶ç±»ï¼ˆStatisticNodeï¼‰æ¥è¿›è¡Œç»Ÿè®¡ super.addPassRequest(count); // æ ¹æ®clusterNode æ±‡æ€»ç»Ÿè®¡ï¼ˆèƒŒåä¹Ÿæ˜¯è°ƒç”¨çˆ¶ç±»StatisticNodeï¼‰ this.clusterNode.addPassRequest(count);&#125; æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨äº†çˆ¶ç±»StatisticNodeçš„addPassRequestæ–¹æ³• 123456789101112131415/** * æŒ‰ç§’ç»Ÿè®¡ï¼Œåˆ†æˆä¸¤ä¸ªçª—å£ï¼Œæ¯ä¸ªçª—å£500msï¼Œç”¨æ¥ç»Ÿè®¡QPS */private transient volatile Metric rollingCounterInSecond = new ArrayMetric(SampleCountProperty.SAMPLE_COUNT, IntervalProperty.INTERVAL);/** * æŒ‰åˆ†é’Ÿç»Ÿè®¡ï¼Œåˆ†æˆ60ä¸ªçª—å£ï¼Œæ¯ä¸ªçª—å£ 1000ms */private transient Metric rollingCounterInMinute = new ArrayMetric(60, 60 * 1000, false);public void addPassRequest(int count) &#123; rollingCounterInSecond.addPass(count); rollingCounterInMinute.addPass(count);&#125; ä»£ç æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥çŸ¥é“å†…éƒ¨æ˜¯è°ƒç”¨äº†ArrayMetricçš„addPassæ–¹æ³•æ¥ç»Ÿè®¡çš„ï¼Œå¹¶ä¸”ç»Ÿè®¡äº†ä¸¤ç§ä¸åŒæ—¶é—´ç»´åº¦çš„æ•°æ®(ç§’çº§å’Œåˆ†é’Ÿçº§) ArrayMetric1234567891011121314151617181920private final LeapArray&lt;MetricBucket&gt; data;public ArrayMetric(int sampleCount, int intervalInMs) &#123; this.data = new OccupiableBucketLeapArray(sampleCount, intervalInMs);&#125;public ArrayMetric(int sampleCount, int intervalInMs, boolean enableOccupy) &#123; if (enableOccupy) &#123; this.data = new OccupiableBucketLeapArray(sampleCount, intervalInMs); &#125; else &#123; this.data = new BucketLeapArray(sampleCount, intervalInMs); &#125;&#125;public void addPass(int count) &#123; // 1. è·å–å½“å‰çª—å£ WindowWrap&lt;MetricBucket&gt; wrap = data.currentWindow(); // 2. å½“å‰çª—å£åŠ 1 wrap.value().addPass(count);&#125; ArrayMetricå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªåŒ…è£…ç±»ï¼Œå†…éƒ¨é€šè¿‡å®ä¾‹åŒ–LeapArrayçš„å¯¹åº”å®ç°ç±»ï¼Œæ¥å®ç°å…·ä½“çš„ç»Ÿè®¡é€»è¾‘ï¼ŒLeapArrayæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼ŒOccupiableBucketLeapArrayå’ŒBucketLeapArrayéƒ½æ˜¯å…¶å…·ä½“çš„å®ç°ç±»OccupiableBucketLeapArrayåœ¨1.5ç‰ˆæœ¬ä¹‹åæ‰è¢«å¼•å…¥ï¼Œä¸»è¦æ˜¯ä¸ºäº†è§£å†³ä¸€äº›é«˜ä¼˜å…ˆçº§çš„è¯·æ±‚åœ¨é™æµè§¦å‘çš„æ—¶å€™ä¹Ÿèƒ½é€šè¿‡(é€šè¿‡å ç”¨æœªæ¥æ—¶é—´çª—å£çš„åé¢æ¥å®ç°) ä¹Ÿæ˜¯é»˜è®¤ä½¿ç”¨çš„LeapArrayå®ç°ç±» è€Œç»Ÿè®¡çš„é€»è¾‘ä¹Ÿæ¯”è¾ƒæ¸…æ¥šï¼Œåˆ†æˆäº†ä¸¤æ­¥ï¼š å®šä½åˆ°å½“å‰çª—å£ è·å–åˆ°å½“å‰çª—å£WindowWrapçš„MetricBucketå¹¶æ‰§è¡ŒaddPassé€»è¾‘ è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹ä¸‹ç¬¬äºŒæ­¥ä¸­çš„MetricBucketç±»ï¼Œçœ‹çœ‹å®ƒåšäº†å“ªäº›äº‹æƒ… MetricBucket1234567891011121314151617181920212223242526272829/** * å­˜æ”¾å½“å‰çª—å£å„ç§ç±»å‹çš„ç»Ÿè®¡å€¼(ç±»å‹åŒ…æ‹¬ PASS BLOCK EXCEPTION ç­‰) */private final LongAdder[] counters;public MetricBucket() &#123; MetricEvent[] events = MetricEvent.values(); this.counters = new LongAdder[events.length]; for (MetricEvent event : events) &#123; counters[event.ordinal()] = new LongAdder(); &#125; initMinRt();&#125;// ç»Ÿè®¡passæ•°public void addPass(int n) &#123; add(MetricEvent.PASS, n);&#125;// ç»Ÿè®¡å¯å ç”¨çš„passæ•°public void addOccupiedPass(int n) &#123; add(MetricEvent.OCCUPIED_PASS, n);&#125;// ç»Ÿè®¡å¼‚å¸¸æ•°public void addException(int n) &#123; add(MetricEvent.EXCEPTION, n);&#125;// ç»Ÿè®¡blockæ•°public void addBlock(int n) &#123; add(MetricEvent.BLOCK, n);&#125;.... MetricBucketé€šè¿‡å®šä¹‰äº†ä¸€ä¸ªLongAdderæ•°ç»„æ¥å­˜å‚¨ä¸åŒç±»å‹çš„æµé‡ç»Ÿè®¡å€¼ï¼Œå…·ä½“çš„ç±»å‹åˆ™éƒ½å®šä¹‰åœ¨MetricEventæšä¸¾ä¸­ã€‚æ‰§è¡ŒaddPassæ–¹æ³•å¯¹åº”LongAdderæ•°ç»„ç´¢å¼•ä¸‹è¡¨ä¸º0çš„å€¼é€’å¢ ä¸‹é¢å†æ¥çœ‹ä¸‹data.currentWindow()çš„å†…éƒ¨é€»è¾‘ OccupiableBucketLeapArrayOccupiableBucketLeapArrayç»§æ‰¿äº†æŠ½è±¡ç±»LeapArrayï¼Œæ ¸å¿ƒé€»è¾‘ä¹Ÿæ˜¯åœ¨LeapArrayä¸­ 12345678910111213141516171819202122232425262728293031323334353637383940/** * æ—¶é—´çª—å£å¤§å° å•ä½ms */protected int windowLengthInMs;/** * åˆ‡åˆ†çš„çª—å£æ•° */protected int sampleCount;/** * ç»Ÿè®¡çš„æ—¶é—´é—´éš” intervalInMs = windowLengthInMs * sampleCount */ protected int intervalInMs;/** * çª—å£æ•°ç»„ æ•°ç»„å¤§å° = sampleCount */protected final AtomicReferenceArray&lt;WindowWrap&lt;T&gt;&gt; array;/** * update lock æ›´æ–°çª—å£æ—¶éœ€è¦ä¸Šé” */private final ReentrantLock updateLock = new ReentrantLock();/** * @param sampleCount éœ€è¦åˆ’åˆ†çš„çª—å£æ•° * @param intervalInMs é—´éš”çš„ç»Ÿè®¡æ—¶é—´ */public LeapArray(int sampleCount, int intervalInMs) &#123; this.windowLengthInMs = intervalInMs / sampleCount; this.intervalInMs = intervalInMs; this.sampleCount = sampleCount; this.array = new AtomicReferenceArray&lt;&gt;(sampleCount);&#125;/** * è·å–å½“å‰çª—å£ */public WindowWrap&lt;T&gt; currentWindow() &#123; return currentWindow(TimeUtil.currentTimeMillis());&#125; ä»¥ä¸Šéœ€è¦ç€é‡ç†è§£çš„æ˜¯å‡ ä¸ªå‚æ•°çš„å«ä¹‰ï¼š sampleCount å®šä¹‰çš„çª—å£çš„æ•° intervalInMs ç»Ÿè®¡çš„æ—¶é—´é—´éš” windowLengthInMs æ¯ä¸ªçª—å£çš„æ—¶é—´å¤§å° = intervalInMs / sampleCount sampleCount æ¯”è¾ƒå¥½ç†è§£ï¼Œå°±æ˜¯éœ€è¦å®šä¹‰å‡ ä¸ªçª—å£ï¼ˆé»˜è®¤ç§’çº§ç»Ÿè®¡ç»´åº¦çš„è¯æ˜¯ä¸¤ä¸ªçª—å£ï¼‰ï¼ŒintervalInMs æŒ‡çš„å°±æ˜¯æˆ‘ä»¬éœ€è¦ç»Ÿè®¡çš„æ—¶é—´é—´éš”ï¼Œä¾‹å¦‚æˆ‘ä»¬ç»Ÿè®¡QPSçš„è¯é‚£å°±æ˜¯1000msï¼ŒwindowLengthInMs æŒ‡çš„æ¯ä¸ªçª—å£çš„å¤§å°ï¼Œæ˜¯ç”±intervalInMsé™¤ä»¥sampleCountå¾—æ¥ ç±»ä¼¼ä¸‹å›¾ï¿¼ ç†è§£äº†ä¸Šè¯‰å‡ ä¸ªå‚æ•°çš„å«ä¹‰åï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥åˆ°LeapArrayçš„currentWindow(long time)æ–¹æ³•ä¸­å»çœ‹çœ‹å…·ä½“çš„å®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869public WindowWrap&lt;T&gt; currentWindow(long timeMillis) &#123; if (timeMillis &lt; 0) &#123; return null; &#125; // æ ¹æ®å½“å‰æ—¶é—´æˆ³è®¡ç®—å½“å‰æ‰€å±çš„çª—å£æ•°ç»„ç´¢å¼•ä¸‹æ ‡ int idx = calculateTimeIdx(timeMillis); // è®¡ç®—å½“å‰çª—å£çš„å¼€å§‹æ—¶é—´æˆ³ long windowStart = calculateWindowStart(timeMillis); /* * ä»çª—å£æ•°ç»„ä¸­è·å–å½“å‰çª—å£é¡¹ï¼Œåˆ†ä¸ºä¸‰ç§æƒ…å†µ * * (1) å½“å‰çª—å£ä¸ºç©ºè¿˜æœªåˆ›å»ºï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ª * (2) å½“å‰çª—å£çš„å¼€å§‹æ—¶é—´å’Œä¸Šé¢è®¡ç®—å‡ºçš„çª—å£å¼€å§‹æ—¶é—´ä¸€è‡´ï¼Œè¡¨æ˜å½“å‰çª—å£è¿˜æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›å½“å‰çª—å£ * (3) å½“å‰çª—å£çš„å¼€å§‹æ—¶é—´ å°äº ä¸Šé¢è®¡ç®—å‡ºçš„çª—å£å¼€å§‹æ—¶é—´ï¼Œè¡¨æ˜å½“å‰çª—å£å·²è¿‡æœŸï¼Œéœ€è¦æ›¿æ¢å½“å‰çª—å£ */ while (true) &#123; WindowWrap&lt;T&gt; old = array.get(idx); if (old == null) &#123; /* * ç¬¬ä¸€ç§æƒ…å†µï¼Œæ–°å»ºä¸€ä¸ªçª—å£é¡¹ */ WindowWrap&lt;T&gt; window = new WindowWrap&lt;T&gt;(windowLengthInMs, windowStart, newEmptyBucket(timeMillis)); if (array.compareAndSet(idx, null, window)) &#123; // Successfully updated, return the created bucket. return window; &#125; else &#123; // Contention failed, the thread will yield its time slice to wait for bucket available. Thread.yield(); &#125; &#125; else if (windowStart == old.windowStart()) &#123; /* * ç¬¬äºŒç§æƒ…å†µ ç›´æ¥è¿”å› */ return old; &#125; else if (windowStart &gt; old.windowStart()) &#123; /* * ç¬¬ä¸‰ç§æƒ…å†µ æ›¿æ¢çª—å£ */ if (updateLock.tryLock()) &#123; try &#123; // Successfully get the update lock, now we reset the bucket. return resetWindowTo(old, windowStart); &#125; finally &#123; updateLock.unlock(); &#125; &#125; else &#123; // Contention failed, the thread will yield its time slice to wait for bucket available. Thread.yield(); &#125; &#125; else if (windowStart &lt; old.windowStart()) &#123; // ç¬¬å››ç§æƒ…å†µï¼Œè®²é“ç†ä¸ä¼šèµ°åˆ°è¿™é‡Œ return new WindowWrap&lt;T&gt;(windowLengthInMs, windowStart, newEmptyBucket(timeMillis)); &#125; &#125;&#125;/** * æ ¹æ®å½“å‰æ—¶é—´æˆ³è®¡ç®—å½“å‰æ‰€å±çš„çª—å£æ•°ç»„ç´¢å¼•ä¸‹æ ‡ */private int calculateTimeIdx(/*@Valid*/ long timeMillis) &#123; long timeId = timeMillis / windowLengthInMs; return (int)(timeId % array.length());&#125;/** * è®¡ç®—å½“å‰çª—å£çš„å¼€å§‹æ—¶é—´æˆ³ */protected long calculateWindowStart(/*@Valid*/ long timeMillis) &#123; return timeMillis - timeMillis % windowLengthInMs;&#125; ä¸Šé¢çš„æ–¹æ³•å°±æ˜¯æ•´ä¸ªæ»‘åŠ¨çª—å£é€»è¾‘çš„æ ¸å¿ƒä»£ç ï¼Œæ³¨é‡Šå…¶å®ä¹Ÿå†™çš„æ¯”è¾ƒæ¸…æ™°äº†ï¼Œç®€å•æ¦‚æ‹¬ä¸‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š æ ¹æ®å½“å‰æ—¶é—´æˆ³ å’Œ çª—å£æ•°ç»„å¤§å° è·å–åˆ°å½“å‰çš„çª—å£æ•°ç»„ç´¢å¼•ä¸‹æ ‡idxï¼Œå¦‚æœçª—å£æ•°æ˜¯2ï¼Œé‚£å…¶å®idxåªæœ‰ä¸¤ç§å€¼(0 æˆ– 1) æ ¹æ®å½“å‰æ—¶é—´æˆ³ï¼ˆwindowStartï¼‰ è®¡ç®—å¾—åˆ°å½“å‰çª—å£çš„å¼€å§‹æ—¶é—´æˆ³å€¼ã€‚é€šè¿‡calculateWindowStartè®¡ç®—æ¥å¾—åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•è¿˜è›®æœ‰æ„æ€çš„ï¼Œé€šè¿‡å½“å‰æ—¶é—´æˆ³å’Œçª—å£æ—¶é—´å¤§å°å–ä½™æ¥å¾—åˆ° ä¸å½“å‰çª—å£å¼€å§‹æ—¶é—´çš„ åç§»é‡ã€‚æ¯”æˆ‘ç”¨å®šæ—¶ä»»åŠ¡å®ç°é«˜çº§å¤šäº† â€¦ ğŸ˜† å¯ä»¥å»å¯¹æ¯”ä¸€ä¸‹æˆ‘ä¹‹å‰æ–‡ç« ä¸­çš„è ¢å®ç° æ»‘åŠ¨çª—å£ç®—æ³•å®šæ—¶ä»»åŠ¡å®ç° ç„¶åå°±æ˜¯æ ¹æ®ä¸Šé¢å¾—åˆ°çš„ä¸¤ä¸ªå€¼ æ¥è·å–å½“å‰æ—¶é—´çª—å£ï¼Œè¿™é‡Œå…¶å®åˆåˆ†ä¸ºä¸‰ç§æƒ…å†µ å½“å‰çª—å£ä¸ºç©ºè¿˜æœªåˆ›å»ºï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ª å½“å‰çª—å£çš„å¼€å§‹æ—¶é—´å’Œä¸Šé¢è®¡ç®—å‡ºçš„çª—å£å¼€å§‹æ—¶é—´(windowStart)ä¸€è‡´ï¼Œè¡¨æ˜å½“å‰çª—å£è¿˜æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›å½“å‰çª—å£ å½“å‰çª—å£çš„å¼€å§‹æ—¶é—´ å°äº ä¸Šé¢è®¡ç®—å‡ºçš„çª—å£(windowStart)å¼€å§‹æ—¶é—´ï¼Œè¡¨æ˜å½“å‰çª—å£å·²è¿‡æœŸï¼Œéœ€è¦æ›¿æ¢å½“å‰çª—å£ æ€»ç»“æ€»çš„æ¥è¯´ï¼ŒcurrentWindowæ–¹æ³•çš„å®ç°è¿˜æ˜¯éå¸¸å·§å¦™çš„ï¼Œå› ä¸ºæˆ‘åœ¨çœ‹Sentinelçš„æºç å‰ä¹Ÿå†™è¿‡ä¸€ç¯‡é™æµç®—æ³•çš„æ–‡ç« ï¼Œæ°å¥½å…¶ä¸­ä¹Ÿå®ç°è¿‡ä¸€ä¸ªæ»‘åŠ¨çª—å£é™æµç®—æ³•ï¼Œä¸è¿‡ç›¸æ¯”äºSentinelçš„å®ç°ï¼Œæˆ‘ç”¨äº†å®šæ—¶ä»»åŠ¡å»åšçª—å£çš„åˆ‡æ¢æ›´æ–°ï¼Œæ˜¾ç„¶æ€§èƒ½ä¸Šæ›´å·®ï¼Œå®ç°çš„ä¹Ÿä¸ä¼˜é›…ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥å»å¯¹æ¯”ä¸€ä¸‹ã€‚å¸¸ç”¨é™æµç®—æ³• Sentinelç³»åˆ— Sentinelæºç è§£æä¸€ Sentinelæºç è§£æäºŒï¼ˆslotæ€»è§ˆï¼‰ Sentinelæºç è§£æäºŒï¼ˆæ»‘åŠ¨çª—å£æµé‡ç»Ÿè®¡ï¼‰]]></content>
      <categories>
        <category>javaæ¡†æ¶</category>
        <category>Sentinel</category>
      </categories>
      <tags>
        <tag>å¹¶å‘</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Sentinelæºç è§£æäºŒï¼ˆslotæ€»è§ˆï¼‰]]></title>
    <url>%2F2019%2F10%2F16%2FSentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C%EF%BC%88slot%E6%80%BB%E8%A7%88%EF%BC%89%2F</url>
    <content type="text"><![CDATA[å†™åœ¨å‰é¢æœ¬æ–‡ç»§ç»­æ¥åˆ†æSentinelçš„æºç ï¼Œä¸Šç¯‡æ–‡ç« å¯¹Sentinelçš„è°ƒç”¨è¿‡ç¨‹åšäº†æ·±å…¥åˆ†æï¼Œä¸»è¦æ¶‰åŠåˆ°äº†ä¸¤ä¸ªæ¦‚å¿µï¼šæ’æ§½é“¾å’ŒNodeèŠ‚ç‚¹ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ ¹æ®æ’æ§½é“¾çš„è°ƒç”¨å…³ç³»æ¥ä¾æ¬¡åˆ†ææ¯ä¸ªæ’æ§½ï¼ˆslotï¼‰çš„æºç ã€‚ é»˜è®¤æ’æ§½é“¾çš„è°ƒç”¨é¡ºåºï¼Œä»¥åŠæ¯ç§ç±»å‹NodeèŠ‚ç‚¹çš„å…³ç³»éƒ½åœ¨ä¸Šé¢æ–‡ç« å¼€å¤´åˆ†æè¿‡ NodeSelectorSlot123456789101112131415161718192021222324252627282930/** * ç›¸åŒçš„èµ„æºä½†æ˜¯Contextä¸åŒï¼Œåˆ†åˆ«æ–°å»º DefaultNodeï¼Œå¹¶ä»¥ContextNameä¸ºkey */private volatile Map&lt;String, DefaultNode&gt; map = new HashMap&lt;String, DefaultNode&gt;(10);public void entry(Context context, ResourceWrapper resourceWrapper, Object obj, int count, boolean prioritized, Object... args) throws Throwable &#123; // æ ¹æ®ContextNameå°è¯•è·å–DefaultNode DefaultNode node = map.get(context.getName()); if (node == null) &#123; synchronized (this) &#123; node = map.get(context.getName()); if (node == null) &#123; // åˆå§‹åŒ–DefaultNodeï¼Œæ¯ä¸ªContextå¯¹åº”ä¸€ä¸ª node = new DefaultNode(resourceWrapper, null); HashMap&lt;String, DefaultNode&gt; cacheMap = new HashMap&lt;String, DefaultNode&gt;(map.size()); cacheMap.putAll(map); cacheMap.put(context.getName(), node); map = cacheMap; &#125; // æ„å»º Node tree ((DefaultNode)context.getLastNode()).addChild(node); &#125; &#125; context.setCurNode(node); // å”¤é†’æ‰§è¡Œä¸‹ä¸€ä¸ªæ’æ§½ fireEntry(context, resourceWrapper, node, count, prioritized, args);&#125; NodeSelectorSloté¡¾åæ€ä¹‰æ˜¯ç”¨æ¥æ„å»ºNodeçš„ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°NodeSelectorSlotå¯¹äºä¸åŒçš„ä¸Šä¸‹æ–‡éƒ½ä¼šç”Ÿæˆä¸€ä¸ªDefaultNodeã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªè¦æ³¨æ„çš„ç‚¹ï¼šç›¸åŒçš„èµ„æº({@link ResourceWrapper#equals(Object)})å°†å…¨å±€å…±äº«ç›¸åŒçš„{@link ProcessorSlotChain}ï¼Œæ— è®ºåœ¨å“ªä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œå› æ­¤ä¸åŒçš„ä¸Šä¸‹æ–‡å¯ä»¥è¿›å…¥åˆ°åŒä¸€ä¸ªå¯¹è±¡çš„NodeSelectorSlot.entryæ–¹æ³•ä¸­ï¼Œé‚£ä¹ˆè¿™é‡Œè¦æ€ä¹ˆåŒºåˆ†ä¸åŒçš„ä¸Šä¸‹æ–‡æ‰€åˆ›å»ºçš„èµ„æºNodeå‘¢ï¼Ÿæ˜¾ç„¶å¯ä»¥ä½¿ç”¨ä¸Šä¸‹æ–‡åç§°ä½œä¸ºæ˜ å°„é”®ä»¥åŒºåˆ†ç›¸åŒçš„èµ„æºNodeã€‚ ç„¶åè¿™é‡Œè¦è€ƒè™‘å¦ä¸€ä¸ªé—®é¢˜ã€‚ä¸€ä¸ªèµ„æºæœ‰å¯èƒ½åˆ›å»ºå¤šä¸ªDefaultNodeï¼ˆæœ‰å¤šä¸ªä¸Šä¸‹æ–‡æ—¶ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•å¿«é€Ÿçš„è·å–æ€»çš„ç»Ÿè®¡æ•°æ®å‘¢ï¼Ÿ ç­”æ¡ˆå°±åœ¨ä¸‹ä¸€ä¸ªSlot(ClusterBuilderSlot)ä¸­è¢«è§£å†³äº†ã€‚ ClusterBuilderSlotä¸Šé¢æœ‰æåˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¦å¦‚ä½•ç»Ÿè®¡ä¸åŒä¸Šä¸‹æ–‡ç›¸åŒèµ„æºçš„æ€»é‡æ•°æ®ã€‚ClusterBuilderSlotç»™äº†å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼šå…·æœ‰ç›¸åŒèµ„æºåç§°çš„å…±äº«ä¸€ä¸ªClusterNodeã€‚ 1234567891011121314151617181920212223242526272829303132333435363738// ç›¸åŒçš„èµ„æºå…±äº«ä¸€ä¸ª ClusterNodeprivate static volatile Map&lt;ResourceWrapper, ClusterNode&gt; clusterNodeMap = new HashMap&lt;&gt;();private static final Object lock = new Object();private volatile ClusterNode clusterNode = null;@Overridepublic void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, boolean prioritized, Object... args) throws Throwable &#123; // åˆ¤æ–­æœ¬èµ„æºæ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡clusterNode if (clusterNode == null) &#123; synchronized (lock) &#123; if (clusterNode == null) &#123; // æ²¡æœ‰åˆå§‹åŒ–åˆ™åˆå§‹åŒ–clusterNode clusterNode = new ClusterNode(resourceWrapper.getName(), resourceWrapper.getResourceType()); HashMap&lt;ResourceWrapper, ClusterNode&gt; newMap = new HashMap&lt;&gt;(Math.max(clusterNodeMap.size(), 16)); newMap.putAll(clusterNodeMap); newMap.put(node.getId(), clusterNode); clusterNodeMap = newMap; &#125; &#125; &#125; // ç»™ç›¸åŒèµ„æºçš„DefaultNodeè®¾ç½®ä¸€æ ·çš„ClusterNode node.setClusterNode(clusterNode); /* * å¦‚æœæœ‰æ¥æºåˆ™æ–°å»ºä¸€ä¸ªæ¥æºNode */ if (!"".equals(context.getOrigin())) &#123; Node originNode = node.getClusterNode().getOrCreateOriginNode(context.getOrigin()); context.getCurEntry().setOriginNode(originNode); &#125; fireEntry(context, resourceWrapper, node, count, prioritized, args);&#125; ä¸Šé¢çš„ä»£ç å…¶å®å°±æ˜¯åšäº†ä¸€ä»¶äº‹æƒ…ï¼Œä¸ºèµ„æºåˆ›å»ºCluserNodeã€‚è¿™é‡Œæˆ‘åˆè¦æä¸€å˜´ ç›¸åŒçš„èµ„æº({@link ResourceWrapper#equals(Object)})å°†å…¨å±€å…±äº«ç›¸åŒçš„{@link ProcessorSlotChain}ï¼Œæ— è®ºåœ¨å“ªä¸ªä¸Šä¸‹æ–‡ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œèƒ½è¿›å…¥åˆ°åŒä¸€ä¸ªClusterBuilderSlotå¯¹è±¡çš„entryæ–¹æ³•çš„è¯·æ±‚éƒ½æ˜¯æ¥è‡ªåŒä¸€ä¸ªèµ„æºçš„ï¼Œæ‰€ä»¥è¿™äº›ç›¸åŒèµ„æºéœ€è¦åˆå§‹åŒ–ä¸€ä¸ªç»Ÿä¸€çš„CluserNodeç”¨æ¥åšæµé‡çš„æ±‡æ€»ç»Ÿè®¡ã€‚ LogSlotä»£ç æ¯”è¾ƒç®€å•ï¼Œé€»è¾‘å°±æ˜¯æ‰“å°å¼‚å¸¸æ—¥å¿—ï¼Œå°±ä¸åˆ†æäº† StatisticSlotStatisticSlot æ˜¯ Sentinel çš„æ ¸å¿ƒåŠŸèƒ½æ’æ§½ä¹‹ä¸€ï¼Œç”¨äºç»Ÿè®¡å®æ—¶çš„è°ƒç”¨æ•°æ®ã€‚ 12345678910111213141516171819202122232425public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, boolean prioritized, Object... args) throws Throwable &#123; try &#123; // å…ˆè¿›è¡Œåç»­çš„checkï¼ŒåŒ…æ‹¬è§„åˆ™çš„checkï¼Œé»‘ç™½åå•check fireEntry(context, resourceWrapper, node, count, prioritized, args); // ç»Ÿè®¡é»˜è®¤qps çº¿ç¨‹æ•° node.increaseThreadNum(); node.addPassRequest(count); if (context.getCurEntry().getOriginNode() != null) &#123; // æ ¹æ®æ¥æºç»Ÿè®¡qps çº¿ç¨‹æ•° context.getCurEntry().getOriginNode().increaseThreadNum(); context.getCurEntry().getOriginNode().addPassRequest(count); &#125; if (resourceWrapper.getEntryType() == EntryType.IN) &#123; // ç»Ÿè®¡å…¥å£ qps çº¿ç¨‹æ•° Constants.ENTRY_NODE.increaseThreadNum(); Constants.ENTRY_NODE.addPassRequest(count); &#125; .... çœç•¥å…¶ä»–ä»£ç  &#125;&#125; StatisticSlotä¸»è¦åšäº†4ç§ä¸åŒç»´åº¦çš„æµé‡ç»Ÿè®¡ èµ„æºåœ¨ä¸Šä¸‹æ–‡ç»´åº¦ï¼ˆDefaultNodeï¼‰çš„ç»Ÿè®¡ clusterNode ç»´åº¦çš„ç»Ÿè®¡ Origin æ¥æºç»´åº¦çš„ç»Ÿè®¡ å…¥å£å…¨å±€æµé‡çš„ç»Ÿè®¡ å…³äºæµé‡çš„ç»Ÿè®¡åŸç†çš„æœ¬æ–‡å°±ä¸æ·±å…¥åˆ†æäº†ï¼Œæ¥ä¸‹æ¥çš„æ–‡ç« ä¸­ä¼šå•ç‹¬åˆ†æ SystemSlotSystemSlotæ¯”è¾ƒç®€å•ï¼Œå…¶å®å°±æ˜¯æ ¹æ®StatisticSlotæ‰€ç»Ÿè®¡çš„å…¨å±€å…¥å£æµé‡è¿›è¡Œé™æµã€‚ AuthoritySlot123456789101112131415161718192021222324public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, boolean prioritized, Object... args) throws Throwable &#123; checkBlackWhiteAuthority(resourceWrapper, context); fireEntry(context, resourceWrapper, node, count, prioritized, args);&#125;void checkBlackWhiteAuthority(ResourceWrapper resource, Context context) throws AuthorityException &#123; Map&lt;String, Set&lt;AuthorityRule&gt;&gt; authorityRules = AuthorityRuleManager.getAuthorityRules(); if (authorityRules == null) &#123; return; &#125; // æ ¹æ®èµ„æºè·å–é»‘ç™½åå•è§„åˆ™ Set&lt;AuthorityRule&gt; rules = authorityRules.get(resource.getName()); if (rules == null) &#123; return; &#125; // å¯¹è§„åˆ™è¿›è¡Œæ ¡éªŒï¼Œåªè¦æœ‰ä¸€æ¡ä¸é€šè¿‡ å°±æŠ›å¼‚å¸¸ for (AuthorityRule rule : rules) &#123; if (!AuthorityRuleChecker.passCheck(rule, context)) &#123; throw new AuthorityException(context.getOrigin(), rule); &#125; &#125;&#125; AuthoritySlotä¼šå¯¹èµ„æºçš„é»‘ç™½åå•åšæ£€æŸ¥ï¼Œå¹¶ä¸”åªè¦æœ‰ä¸€æ¡ä¸é€šè¿‡å°±æŠ›å¼‚å¸¸ã€‚ FlowSlot12345678910111213@Overridepublic void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, boolean prioritized, Object... args) throws Throwable &#123; checkFlow(resourceWrapper, context, node, count, prioritized); fireEntry(context, resourceWrapper, node, count, prioritized, args);&#125;void checkFlow(ResourceWrapper resource, Context context, DefaultNode node, int count, boolean prioritized) throws BlockException &#123; // æ£€æŸ¥é™æµè§„åˆ™ checker.checkFlow(ruleProvider, resource, context, node, count, prioritized);&#125; è¿™ä¸ªslotä¸»è¦æ ¹æ®é¢„è®¾çš„èµ„æºçš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒæŒ‰ç…§å›ºå®šçš„æ¬¡åºï¼Œä¾æ¬¡ç”Ÿæ•ˆã€‚å¦‚æœä¸€ä¸ªèµ„æºå¯¹åº”ä¸¤æ¡æˆ–è€…å¤šæ¡æµæ§è§„åˆ™ï¼Œåˆ™ä¼šæ ¹æ®å¦‚ä¸‹æ¬¡åºä¾æ¬¡æ£€éªŒï¼Œç›´åˆ°å…¨éƒ¨é€šè¿‡æˆ–è€…æœ‰ä¸€ä¸ªè§„åˆ™ç”Ÿæ•ˆä¸ºæ­¢:å¹¶ä¸”åŒæ ·ä¹Ÿä¼šæ ¹æ®ä¸‰ç§ä¸åŒçš„ç»´åº¦æ¥è¿›è¡Œé™æµï¼š èµ„æºåœ¨ä¸Šä¸‹æ–‡ç»´åº¦ï¼ˆDefaultNodeï¼‰çš„ç»Ÿè®¡ clusterNode ç»´åº¦çš„ç»Ÿè®¡ Origin æ¥æºç»´åº¦çš„ç»Ÿè®¡ å…³äºæµæ§è§„åˆ™æºç çš„æ·±å…¥åˆ†æå°±ä¸åœ¨æœ¬ç¯‡æ–‡ç« èµ˜è¿°äº† DegradeSlotè¿™ä¸ªslotä¸»è¦é’ˆå¯¹èµ„æºçš„å¹³å‡å“åº”æ—¶é—´ï¼ˆRTï¼‰ä»¥åŠå¼‚å¸¸æ¯”ç‡ï¼Œæ¥å†³å®šèµ„æºæ˜¯å¦åœ¨æ¥ä¸‹æ¥çš„æ—¶é—´è¢«è‡ªåŠ¨ç†”æ–­æ‰ã€‚ æ€»ç»“ ç›¸åŒçš„èµ„æº({@link ResourceWrapper#equals(Object)})å°†å…¨å±€å…±äº«ç›¸åŒçš„{@link ProcessorSlotChain}ï¼Œæ— è®ºåœ¨å“ªä¸ªä¸Šä¸‹æ–‡ä¸­ æµæ§æœ‰å¤šä¸ªç»´åº¦ï¼Œåˆ†åˆ«åŒ…æ‹¬ï¼š1.ä¸åŒä¸Šä¸‹æ–‡ä¸­çš„èµ„æº 2.ç›¸åŒèµ„æº 3.å…¥å£æµé‡ 3.ç›¸åŒçš„æ¥æº Sentinelç³»åˆ— Sentinelæºç è§£æä¸€ Sentinelæºç è§£æäºŒï¼ˆslotæ€»è§ˆï¼‰ Sentinelæºç è§£æäºŒï¼ˆæ»‘åŠ¨çª—å£æµé‡ç»Ÿè®¡ï¼‰]]></content>
      <categories>
        <category>javaæ¡†æ¶</category>
        <category>Sentinel</category>
      </categories>
      <tags>
        <tag>å¹¶å‘</tag>
        <tag>Sentinel</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Sentinelæºç è§£æä¸€]]></title>
    <url>%2F2019%2F10%2F11%2FSentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%80%2F</url>
    <content type="text"><![CDATA[å¼•è¨€Sentinelä½œä¸ºaliå¼€æºçš„ä¸€æ¬¾è½»é‡çº§æµæ§æ¡†æ¶ï¼Œä¸»è¦ä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦æ¥å¸®åŠ©ç”¨æˆ·ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§ã€‚ç›¸æ¯”äºHystrixï¼ŒSentinelçš„è®¾è®¡æ›´åŠ ç®€å•ï¼Œåœ¨ Sentinelä¸­èµ„æºå®šä¹‰å’Œè§„åˆ™é…ç½®æ˜¯åˆ†ç¦»çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·å¯ä»¥å…ˆé€šè¿‡Sentinel APIç»™å¯¹åº”çš„ä¸šåŠ¡é€»è¾‘å®šä¹‰èµ„æºï¼ˆåŸ‹ç‚¹ï¼‰ï¼Œç„¶ååœ¨éœ€è¦çš„æ—¶å€™å†é…ç½®è§„åˆ™ï¼Œé€šè¿‡è¿™ç§ç»„åˆæ–¹å¼ï¼Œæå¤§çš„å¢åŠ äº†Sentinelæµæ§çš„çµæ´»æ€§ã€‚ å¼•å…¥Sentinelå¸¦æ¥çš„æ€§èƒ½æŸè€—éå¸¸å°ã€‚åªæœ‰åœ¨ä¸šåŠ¡å•æœºé‡çº§è¶…è¿‡25W QPSçš„æ—¶å€™æ‰ä¼šæœ‰ä¸€äº›æ˜¾è‘—çš„å½±å“ï¼ˆ5% - 10% å·¦å³ï¼‰ï¼Œå•æœºQPSä¸å¤ªå¤§çš„æ—¶å€™æŸè€—å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ Sentinelæä¾›ä¸¤ç§åŸ‹ç‚¹æ–¹å¼: try-catch æ–¹å¼ï¼ˆé€šè¿‡ SphU.entry(...)ï¼‰ï¼Œç”¨æˆ·åœ¨ catch å—ä¸­æ‰§è¡Œå¼‚å¸¸å¤„ç† / fallback if-else æ–¹å¼ï¼ˆé€šè¿‡ SphO.entry(...)ï¼‰ï¼Œå½“è¿”å› false æ—¶æ‰§è¡Œå¼‚å¸¸å¤„ç† / fallback å†™åœ¨å‰é¢åœ¨æ­¤ä¹‹å‰ï¼Œéœ€è¦å…ˆäº†è§£ä¸€ä¸‹Sentinelçš„å·¥ä½œæµç¨‹åœ¨ Sentinel é‡Œé¢ï¼Œæ‰€æœ‰çš„èµ„æºéƒ½å¯¹åº”ä¸€ä¸ªèµ„æºåç§°ï¼ˆresourceNameï¼‰ï¼Œæ¯æ¬¡èµ„æºè°ƒç”¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ª Entry å¯¹è±¡ã€‚Entry å¯ä»¥é€šè¿‡å¯¹ä¸»æµæ¡†æ¶çš„é€‚é…è‡ªåŠ¨åˆ›å»ºï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ³¨è§£çš„æ–¹å¼æˆ–è°ƒç”¨ SphU API æ˜¾å¼åˆ›å»ºã€‚Entry åˆ›å»ºçš„æ—¶å€™ï¼ŒåŒæ—¶ä¹Ÿä¼šåˆ›å»ºä¸€ç³»åˆ—åŠŸèƒ½æ’æ§½ï¼ˆslot chainï¼‰ï¼Œè¿™äº›æ’æ§½æœ‰ä¸åŒçš„èŒè´£ï¼Œä¾‹å¦‚é»˜è®¤æƒ…å†µä¸‹ä¼šåˆ›å»ºä¸€ä¸‹7ä¸ªæ’æ§½ï¼š NodeSelectorSlot è´Ÿè´£æ”¶é›†èµ„æºçš„è·¯å¾„ï¼Œå¹¶å°†è¿™äº›èµ„æºçš„è°ƒç”¨è·¯å¾„ï¼Œä»¥æ ‘çŠ¶ç»“æ„å­˜å‚¨èµ·æ¥ï¼Œç”¨äºæ ¹æ®è°ƒç”¨è·¯å¾„æ¥é™æµé™çº§ï¼› ClusterBuilderSlot åˆ™ç”¨äºå­˜å‚¨èµ„æºçš„ç»Ÿè®¡ä¿¡æ¯ä»¥åŠè°ƒç”¨è€…ä¿¡æ¯ï¼Œä¾‹å¦‚è¯¥èµ„æºçš„ RT, QPS, thread count ç­‰ç­‰ï¼Œè¿™äº›ä¿¡æ¯å°†ç”¨ä½œä¸ºå¤šç»´åº¦é™æµï¼Œé™çº§çš„ä¾æ®ï¼› StatisticSlot åˆ™ç”¨äºè®°å½•ã€ç»Ÿè®¡ä¸åŒçº¬åº¦çš„ runtime æŒ‡æ ‡ç›‘æ§ä¿¡æ¯ï¼› FlowSlot åˆ™ç”¨äºæ ¹æ®é¢„è®¾çš„é™æµè§„åˆ™ä»¥åŠå‰é¢ slot ç»Ÿè®¡çš„çŠ¶æ€ï¼Œæ¥è¿›è¡Œæµé‡æ§åˆ¶ï¼› AuthoritySlot åˆ™æ ¹æ®é…ç½®çš„é»‘ç™½åå•å’Œè°ƒç”¨æ¥æºä¿¡æ¯ï¼Œæ¥åšé»‘ç™½åå•æ§åˆ¶ï¼› DegradeSlot åˆ™é€šè¿‡ç»Ÿè®¡ä¿¡æ¯ä»¥åŠé¢„è®¾çš„è§„åˆ™ï¼Œæ¥åšç†”æ–­é™çº§ï¼› SystemSlot åˆ™é€šè¿‡ç³»ç»Ÿçš„çŠ¶æ€ï¼Œä¾‹å¦‚ load1 ç­‰ï¼Œæ¥æ§åˆ¶æ€»çš„å…¥å£æµé‡ æ³¨æ„ï¼šè¿™é‡Œçš„æ’æ§½é“¾éƒ½æ˜¯ä¸€ä¸€å¯¹åº”èµ„æºåç§°çš„ ä¸Šé¢çš„æ‰€ä»‹ç»çš„æ’æ§½ï¼ˆslot chainï¼‰æ˜¯Sentineléå¸¸é‡è¦çš„æ¦‚å¿µã€‚åŒæ—¶è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µé‚£å°±æ˜¯Nodeï¼Œä¸ºäº†å¸®åŠ©ç†è§£ï¼Œå°½æˆ‘æ‰€èƒ½ç”»äº†ä¸‹é¢è¿™å¼ å›¾ï¼Œå¯ä»¥çœ‹åˆ°æ•´ä¸ªç»“æ„éå¸¸çš„åƒä¸€æ£µæ ‘ï¼š ç®€å•è§£é‡Šä¸‹ä¸Šå›¾ï¼š é¡¶éƒ¨è“è‰²çš„nodeèŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹ï¼Œå…¨å±€å”¯ä¸€ ä¸‹é¢é»„è‰²çš„èŠ‚ç‚¹ä¸ºå…¥å£èŠ‚ç‚¹ï¼Œæ¯ä¸ªCentextName(ä¸Šä¸‹æ–‡åç§°)ä¸€ä¸€å¯¹åº”ä¸€ä¸ª å¯ä»¥æœ‰å¤šä¸ªå­èŠ‚ç‚¹ï¼ˆå¯¹åº”å¤šç§èµ„æºï¼‰ ä¸­é—´ç»¿è‰²æ¡†æ¡†ä¸­çš„èŠ‚ç‚¹éƒ½æ˜¯å±äºåŒä¸€ä¸ªèµ„æºçš„(ç›¸åŒçš„ResourceName) æœ€åº•ä¸‹ç´«è‰²çš„èŠ‚ç‚¹æ˜¯é›†ç¾¤èŠ‚ç‚¹ï¼Œå¯ä»¥ç†è§£æˆç»¿è‰²æ¡†æ¡†ä¸­Nodeèµ„æºçš„æ•´åˆ ä»¥ä¸Š2ä¸ªæ¦‚å¿µåŠ¡å¿…è¦ç†æ¸…æ¥šï¼Œä¹‹åå†ä¸€æ­¥ä¸€æ­¥çœ‹æºç ä¼šæ¯”è¾ƒæ¸…æ™° ä¸‹é¢æˆ‘ä»¬å°†ä»å…¥å£æºç å¼€å§‹ä¸€æ­¥ä¸€æ­¥åˆ†ææ•´ä¸ªè°ƒç”¨è¿‡ç¨‹ï¼š æºç åˆ†æä¸‹é¢çš„æ˜¯ä¸€ä¸ªSentinelä½¿ç”¨çš„ç¤ºä¾‹ä»£ç ï¼Œæˆ‘ä»¬å°±ä»è¿™é‡Œåˆ‡å…¥å¼€å§‹åˆ†æ 123456789// åˆ›å»ºä¸€ä¸ªåç§°ä¸ºentrance1ï¼Œæ¥æºä¸ºappA çš„ä¸Šä¸‹æ–‡ContextContextUtil.enter("entrance1", "appA");// åˆ›å»ºä¸€ä¸ªèµ„æºåç§°nodeAçš„Entry Entry nodeA = SphU.entry("nodeA"); if (nodeA != null) &#123; nodeA.exit(); &#125; // æ¸…é™¤ä¸Šä¸‹æ–‡ ContextUtil.exit(); ContextUtil.enter(â€œentrance1â€, â€œappAâ€)12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758public static Context enter(String name, String origin) &#123; // åˆ¤æ–­ä¸Šä¸‹æ–‡åç§°æ˜¯å¦ä¸ºé»˜è®¤çš„åç§°ï¼ˆsentinel_default_contextï¼‰ æ˜¯çš„è¯ç›´æ¥æŠ›å‡ºå¼‚å¸¸ if (Constants.CONTEXT_DEFAULT_NAME.equals(name)) &#123; throw new ContextNameDefineException( "The " + Constants.CONTEXT_DEFAULT_NAME + " can't be permit to defined!"); &#125; return trueEnter(name, origin);&#125;protected static Context trueEnter(String name, String origin) &#123; // å…ˆä»ThreadLocalä¸­å°è¯•è·å–ï¼Œè·å–åˆ°åˆ™ç›´æ¥è¿”å› Context context = contextHolder.get(); if (context == null) &#123; Map&lt;String, DefaultNode&gt; localCacheNameMap = contextNameNodeMap; // å°è¯•ä»ç¼“å­˜ä¸­è·å–è¯¥ä¸Šä¸‹æ–‡åç§°å¯¹åº”çš„ å…¥å£èŠ‚ç‚¹ DefaultNode node = localCacheNameMap.get(name); if (node == null) &#123; // åˆ¤æ–­ç¼“å­˜ä¸­å…¥å£èŠ‚ç‚¹æ•°é‡æ˜¯å¦å¤§äº2000 if (localCacheNameMap.size() &gt; Constants.MAX_CONTEXT_NAME_SIZE) &#123; setNullContext(); return NULL_CONTEXT; &#125; else &#123; try &#123; // åŠ é” LOCK.lock(); // åŒé‡æ£€æŸ¥é” node = contextNameNodeMap.get(name); if (node == null) &#123; // åˆ¤æ–­ç¼“å­˜ä¸­å…¥å£èŠ‚ç‚¹æ•°é‡æ˜¯å¦å¤§äº2000 if (contextNameNodeMap.size() &gt; Constants.MAX_CONTEXT_NAME_SIZE) &#123; setNullContext(); return NULL_CONTEXT; &#125; else &#123; // æ ¹æ®ä¸Šä¸‹æ–‡åç§°ç”Ÿæˆå…¥å£èŠ‚ç‚¹ï¼ˆentranceNodeï¼‰ node = new EntranceNode(new StringResourceWrapper(name, EntryType.IN), null); // åŠ å…¥è‡³å…¨å±€æ ¹èŠ‚ç‚¹ä¸‹ Constants.ROOT.addChild(node); // åŠ å…¥ç¼“å­˜ä¸­ Map&lt;String, DefaultNode&gt; newMap = new HashMap&lt;&gt;(contextNameNodeMap.size() + 1); newMap.putAll(contextNameNodeMap); newMap.put(name, node); contextNameNodeMap = newMap; &#125; &#125; &#125; finally &#123; LOCK.unlock(); &#125; &#125; &#125; // åˆå§‹åŒ–ä¸Šä¸‹æ–‡å¯¹è±¡ context = new Context(node, name); context.setOrigin(origin); // è®¾ç½®åˆ°å½“å‰çº¿ç¨‹ä¸­ contextHolder.set(context); &#125; return context;&#125; ä¸»è¦åšäº†2ä»¶äº‹æƒ… æ ¹æ®ContextNameç”ŸæˆentranceNodeï¼Œå¹¶åŠ å…¥ç¼“å­˜ï¼Œæ¯ä¸ªContextNameå¯¹åº”ä¸€ä¸ªå…¥å£èŠ‚ç‚¹entranceNode æ ¹æ®ContextNameå’ŒentranceNodeåˆå§‹åŒ–ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå¹¶å°†ä¸Šä¸‹æ–‡å¯¹è±¡è®¾ç½®åˆ°å½“å‰çº¿ç¨‹ä¸­ è¿™é‡Œæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š å…¥å£èŠ‚ç‚¹æ•°é‡ä¸èƒ½å¤§äº2000ï¼Œå¤§äºä¼šç›´æ¥æŠ›å¼‚å¸¸ æ¯ä¸ªContextNameå¯¹åº”ä¸€ä¸ªå…¥å£èŠ‚ç‚¹entranceNode æ¯ä¸ªentranceNodeéƒ½æœ‰å…±åŒçš„çˆ¶èŠ‚ç‚¹ã€‚ä¹Ÿå°±æ˜¯æ ¹èŠ‚ç‚¹ Entry nodeA = SphU.entry(â€œnodeAâ€)123456789101112131415// SphU.classpublic static Entry entry(String name) throws BlockException &#123; // é»˜è®¤ä¸º å‡ºå£æµé‡ç±»å‹ï¼Œå•ä½ç»Ÿè®¡æ•°ä¸º1 return Env.sph.entry(name, EntryType.OUT, 1, OBJECTS0);&#125;// CtSph.classpublic Entry entry(String name, EntryType type, int count, Object... args) throws BlockException &#123; // ç”Ÿæˆèµ„æºå¯¹è±¡ StringResourceWrapper resource = new StringResourceWrapper(name, type); return entry(resource, count, args);&#125;public Entry entry(ResourceWrapper resourceWrapper, int count, Object... args) throws BlockException &#123; return entryWithPriority(resourceWrapper, count, false, args);&#125; ä¸Šé¢çš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œä¸æŒ‡å®šEntryTypeçš„è¯ï¼Œåˆ™é»˜è®¤ä¸ºå‡ºå£æµé‡ç±»å‹ï¼Œæœ€ç»ˆä¼šè°ƒç”¨entryWithPriorityæ–¹æ³•ï¼Œä¸»è¦ä¸šåŠ¡é€»è¾‘ä¹Ÿéƒ½åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ entryWithPriorityæ–¹æ³• 123456789101112131415161718192021222324252627282930313233343536373839404142private Entry entryWithPriority(ResourceWrapper resourceWrapper, int count, boolean prioritized, Object... args) throws BlockException &#123; // è·å–å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡å¯¹è±¡ Context context = ContextUtil.getContext(); // ä¸Šä¸‹æ–‡åç§°å¯¹åº”çš„å…¥å£èŠ‚ç‚¹æ˜¯å¦å·²ç»è¶…è¿‡é˜ˆå€¼2000ï¼Œè¶…è¿‡åˆ™ä¼šè¿”å›ç©º CtEntry if (context instanceof NullContext) &#123; return new CtEntry(resourceWrapper, null, context); &#125; if (context == null) &#123; // å¦‚æœæ²¡æœ‰æŒ‡å®šä¸Šä¸‹æ–‡åç§°ï¼Œåˆ™ä½¿ç”¨é»˜è®¤åç§°ï¼Œä¹Ÿå°±æ˜¯é»˜è®¤å…¥å£èŠ‚ç‚¹ context = InternalContextUtil.internalEnter(Constants.CONTEXT_DEFAULT_NAME); &#125; // å…¨å±€å¼€å…³ if (!Constants.ON) &#123; return new CtEntry(resourceWrapper, null, context); &#125; // ç”Ÿæˆæ’æ§½é“¾ ProcessorSlot&lt;Object&gt; chain = lookProcessChain(resourceWrapper); /* * è¡¨ç¤ºèµ„æº(æ’æ§½é“¾)è¶…è¿‡6000ï¼Œå› æ­¤ä¸ä¼šè¿›è¡Œè§„åˆ™æ£€æŸ¥ã€‚ */ if (chain == null) &#123; return new CtEntry(resourceWrapper, null, context); &#125; // ç”Ÿæˆ Entry å¯¹è±¡ Entry e = new CtEntry(resourceWrapper, chain, context); try &#123; // å¼€å§‹æ‰§è¡Œæ’æ§½é“¾ è°ƒç”¨é€»è¾‘ chain.entry(context, resourceWrapper, null, count, prioritized, args); &#125; catch (BlockException e1) &#123; // æ¸…é™¤ä¸Šä¸‹æ–‡ e.exit(count, args); throw e1; &#125; catch (Throwable e1) &#123; // é™¤éSentinelå†…éƒ¨å­˜åœ¨é”™è¯¯ï¼Œå¦åˆ™ä¸åº”å‘ç”Ÿè¿™ç§æƒ…å†µã€‚ RecordLog.info("Sentinel unexpected exception", e1); &#125; return e;&#125; è¿™ä¸ªæ–¹æ³•å¯ä»¥è¯´æ˜¯æ¶µç›–äº†æ•´ä¸ªSentinelçš„æ ¸å¿ƒé€»è¾‘ è·å–ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå¦‚æœä¸Šä¸‹æ–‡å¯¹è±¡è¿˜æœªåˆå§‹åŒ–ï¼Œåˆ™ä½¿ç”¨é»˜è®¤åç§°åˆå§‹åŒ–ã€‚åˆå§‹åŒ–é€»è¾‘åœ¨ä¸Šæ–‡å·²ç»åˆ†æè¿‡ åˆ¤æ–­å…¨å±€å¼€å…³ æ ¹æ®ç»™å®šçš„èµ„æºç”Ÿæˆæ’æ§½é“¾ï¼Œæ’æ§½é“¾æ˜¯è·Ÿèµ„æºç›¸å…³çš„ï¼ŒSentinelæœ€å…³é”®çš„é€»è¾‘ä¹Ÿéƒ½åœ¨å„ä¸ªæ’æ§½ä¸­ã€‚åˆå§‹åŒ–çš„é€»è¾‘åœ¨lookProcessChain(resourceWrapper);ä¸­ï¼Œä¸‹æ–‡ä¼šåˆ†æ ä¾é¡ºåºæ‰§è¡Œæ¯ä¸ªæ’æ§½é€»è¾‘ lookProcessChain(resourceWrapper)æ–¹æ³•lookProcessChainæ–¹æ³•ä¸ºæŒ‡å®šèµ„æºç”Ÿæˆæ’æ§½é“¾ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„åˆå§‹åŒ–é€»è¾‘ 123456789101112131415161718192021222324ProcessorSlot&lt;Object&gt; lookProcessChain(ResourceWrapper resourceWrapper) &#123; // æ ¹æ®èµ„æºå°è¯•ä»å…¨å±€ç¼“å­˜ä¸­è·å– ProcessorSlotChain chain = chainMap.get(resourceWrapper); if (chain == null) &#123; // éå¸¸å¸¸è§çš„åŒé‡æ£€æŸ¥é” synchronized (LOCK) &#123; chain = chainMap.get(resourceWrapper); if (chain == null) &#123; // åˆ¤æ–­èµ„æºæ•°æ˜¯å¦å¤§äº6000 if (chainMap.size() &gt;= Constants.MAX_SLOT_CHAIN_SIZE) &#123; return null; &#125; // åˆå§‹åŒ–æ’æ§½é“¾ chain = SlotChainProvider.newSlotChain(); Map&lt;ResourceWrapper, ProcessorSlotChain&gt; newMap = new HashMap&lt;ResourceWrapper, ProcessorSlotChain&gt;( chainMap.size() + 1); newMap.putAll(chainMap); newMap.put(resourceWrapper, chain); chainMap = newMap; &#125; &#125; &#125; return chain;&#125; æ ¹æ®èµ„æºå°è¯•ä»å…¨å±€ç¼“å­˜ä¸­è·å–æ’æ§½é“¾ã€‚æ¯ä¸ªèµ„æºå¯¹åº”ä¸€ä¸ªæ’æ§½é“¾ï¼ˆèµ„æºå˜´å¤šåªèƒ½å®šä¹‰6000ä¸ªï¼‰ åˆå§‹åŒ–æ’æ§½é“¾ä¸Šçš„æ’æ§½ï¼ˆSlotChainProvider.newSlotChain()æ–¹æ³•ä¸­ï¼‰ ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹åˆå§‹åŒ–æ’æ§½é“¾ä¸Šçš„æ’æ§½çš„é€»è¾‘ SlotChainProvider.newSlotChain()123456789101112131415161718192021222324252627282930313233343536373839public static ProcessorSlotChain newSlotChain() &#123; // åˆ¤æ–­æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡ if (builder != null) &#123; return builder.build(); &#125; // åŠ è½½ SlotChain resolveSlotChainBuilder(); // åŠ è½½å¤±è´¥åˆ™ä½¿ç”¨é»˜è®¤ æ’æ§½é“¾ if (builder == null) &#123; RecordLog.warn("[SlotChainProvider] Wrong state when resolving slot chain builder, using default"); builder = new DefaultSlotChainBuilder(); &#125; // æ„å»ºå®Œæˆ return builder.build();&#125;/** * javaè‡ªå¸¦ SPIæœºåˆ¶ åŠ è½½ slotChain */private static void resolveSlotChainBuilder() &#123; List&lt;SlotChainBuilder&gt; list = new ArrayList&lt;SlotChainBuilder&gt;(); boolean hasOther = false; // å°è¯•è·å–è‡ªå®šä¹‰SlotChainBuilderï¼Œé€šè¿‡JAVA SPIæœºåˆ¶æ‰©å±• for (SlotChainBuilder builder : LOADER) &#123; if (builder.getClass() != DefaultSlotChainBuilder.class) &#123; hasOther = true; list.add(builder); &#125; &#125; if (hasOther) &#123; builder = list.get(0); &#125; else &#123; // æœªè·å–åˆ°è‡ªå®šä¹‰ SlotChainBuilder åˆ™ä½¿ç”¨é»˜è®¤çš„ builder = new DefaultSlotChainBuilder(); &#125; RecordLog.info("[SlotChainProvider] Global slot chain builder resolved: " + builder.getClass().getCanonicalName());&#125; é¦–å…ˆä¼šå°è¯•è·å–è‡ªå®šä¹‰çš„SlotChainBuilderæ¥æ„å»ºæ’æ§½é“¾ï¼Œè‡ªå®šä¹‰çš„SlotChainBuilderå¯ä»¥é€šè¿‡JAVA SPIæœºåˆ¶æ¥æ‰©å±• å¦‚æœæœªé…ç½®è‡ªå®šä¹‰çš„SlotChainBuilderï¼Œåˆ™ä¼šä½¿ç”¨é»˜è®¤çš„DefaultSlotChainBuilderæ¥æ„å»ºæ’æ§½é“¾ï¼ŒDefaultSlotChainBuilderæ‰€æ„å»ºçš„æ’æ§½å°±æ˜¯æ–‡ç« å¼€å¤´æˆ‘ä»¬æåˆ°çš„7ç§Slotã€‚æ¯ä¸ªæ’æ§½éƒ½æœ‰å…¶å¯¹åº”çš„èŒè´£ï¼Œå„å¸å…¶èŒï¼Œåé¢æˆ‘ä»¬ä¼šè¯¦ç»†åˆ†æè¿™å‡ ä¸ªæ’æ§½çš„æºç ï¼ŒåŠæ‰€æ‰¿æ‹…çš„èŒè´£ã€‚ æ€»ç»“æ–‡ç« å¼€å¤´çš„æåˆ°çš„ä¸¤ä¸ªç‚¹(æ’æ§½é“¾å’ŒNode)ï¼Œè¿™æ˜¯Sentinelçš„é‡ç‚¹ï¼Œç†è§£è¿™ä¸¤ç‚¹å¯¹äºé˜…è¯»æºç æ¥è¯´äº‹åŠåŠŸå€ Sentinelç³»åˆ— Sentinelæºç è§£æä¸€ Sentinelæºç è§£æäºŒï¼ˆslotæ€»è§ˆï¼‰ Sentinelæºç è§£æäºŒï¼ˆæ»‘åŠ¨çª—å£æµé‡ç»Ÿè®¡ï¼‰]]></content>
      <categories>
        <category>javaæ¡†æ¶</category>
        <category>Sentinel</category>
      </categories>
      <tags>
        <tag>å¹¶å‘</tag>
        <tag>Sentinel</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æµ…è°ˆå¸¸ç”¨çš„é™æµç®—æ³•]]></title>
    <url>%2F2019%2F10%2F09%2F%E6%B5%85%E8%B0%88%E5%B8%B8%E7%94%A8%E7%9A%84%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95%2F</url>
    <content type="text"><![CDATA[å¼•è¨€åœ¨å¼€å‘é«˜å¹¶å‘ç³»ç»Ÿæ—¶æœ‰ä¸‰æŠŠåˆ©å™¨ç”¨æ¥ä¿æŠ¤ç³»ç»Ÿï¼šç¼“å­˜ã€é™çº§å’Œé™æµã€‚ä»Šå¤©æˆ‘ä»¬è¦èŠçš„å°±æ˜¯é™æµï¼ˆRate Limitï¼‰ï¼Œé™æµçš„ç›®çš„å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸ºäº†ä¿æŠ¤ç³»ç»Ÿä¸è¢«ç¬æ—¶å¤§æµé‡å†²å®ï¼Œé™æµè¿™ä¸ªæ¦‚å¿µæˆ‘å…¶å®å¾ˆæ—©ä¹‹å‰å°±æœ‰å»äº†è§£è¿‡ï¼Œä¸è¿‡æ— å¥ˆä¹‹å‰å·¥ä½œæ‰€æ¥è§¦ä¸šåŠ¡çš„å¹¶å‘é‡å®åœ¨æ˜¯è°ˆä¸ä¸Šé™æµã€‚ç›®å‰å…¬å¸å¤§ä¿ƒå³°å€¼QPSåœ¨2wå¾€ä¸Šï¼Œè‡ªç„¶è€Œç„¶éœ€è¦ç”¨åˆ°é™æµï¼Œç‰¹åˆ«æ˜¯ç±»ä¼¼ç§’æ€è¿™ç§ç¬æ—¶æµé‡éå¸¸å¤§ä½†å®é™…æˆå•ç‡ä½çš„ä¸šåŠ¡åœºæ™¯ã€‚ ç›®å‰æ¯”è¾ƒå¸¸ç”¨çš„é™æµç®—æ³•æœ‰ä¸‰ç§ è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³• è®¡æ•°å™¨æ»‘åŠ¨çª—å£ç®—æ³• æ¼æ¡¶ç®—æ³• ä»¤ç‰Œæ¡¶ç®—æ³• è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•æ˜¯æœ€ç®€å•çš„é™æµç®—æ³•ï¼Œå®ç°æ–¹å¼ä¹Ÿæ¯”è¾ƒç®€å•ã€‚å°±æ˜¯é€šè¿‡ç»´æŠ¤ä¸€ä¸ªå•ä½æ—¶é—´å†…çš„è®¡æ•°å€¼ï¼Œæ¯å½“ä¸€ä¸ªè¯·æ±‚é€šè¿‡æ—¶ï¼Œå°±å°†è®¡æ•°å€¼åŠ 1ï¼Œå½“è®¡æ•°å€¼è¶…è¿‡é¢„å…ˆè®¾å®šçš„é˜ˆå€¼æ—¶ï¼Œå°±æ‹’ç»å•ä½æ—¶é—´å†…çš„å…¶ä»–è¯·æ±‚ã€‚å¦‚æœå•ä½æ—¶é—´å·²ç»ç»“æŸï¼Œåˆ™å°†è®¡æ•°å™¨æ¸…é›¶ï¼Œå¼€å¯ä¸‹ä¸€è½®çš„è®¡æ•°ã€‚ ä½†æ˜¯è¿™ç§å®ç°ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸¾ä¸ªä¾‹å­: å‡è®¾æˆ‘ä»¬è®¾å®š1ç§’å†…å…è®¸é€šè¿‡çš„è¯·æ±‚é˜ˆå€¼æ˜¯200ï¼Œå¦‚æœæœ‰ç”¨æˆ·åœ¨æ—¶é—´çª—å£çš„æœ€åå‡ æ¯«ç§’å‘é€äº†200ä¸ªè¯·æ±‚ï¼Œç´§æ¥ç€åˆåœ¨ä¸‹ä¸€ä¸ªæ—¶é—´çª—å£å¼€å§‹æ—¶å‘é€äº†200ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆè¿™ä¸ªç”¨æˆ·å…¶å®åœ¨ä¸€ç§’å†…æˆåŠŸè¯·æ±‚äº†400æ¬¡ï¼Œæ˜¾ç„¶è¶…è¿‡äº†é˜ˆå€¼ä½†å¹¶ä¸ä¼šè¢«é™æµã€‚å…¶å®è¿™å°±æ˜¯ä¸´ç•Œå€¼é—®é¢˜ï¼Œé‚£ä¹ˆä¸´ç•Œå€¼é—®é¢˜è¦æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ ä»£ç å®ç° â€“ CounterRateLimit.java è®¡æ•°å™¨æ»‘åŠ¨çª—å£ç®—æ³•è®¡æ•°å™¨æ»‘åŠ¨çª—å£æ³•å°±æ˜¯ä¸ºäº†è§£å†³ä¸Šè¿°å›ºå®šçª—å£è®¡æ•°å­˜åœ¨çš„é—®é¢˜è€Œè¯ç”Ÿï¼Œå­¦è¿‡TCPåè®®çš„åŒå­¦åº”è¯¥å¯¹æ»‘åŠ¨çª—å£ä¸é™Œç”Ÿï¼Œå…¶å®è¿˜æ˜¯ä¸å¤ªä¸€æ ·çš„ï¼Œä¸‹æ–‡æˆ‘ä»¬è¦è¯´çš„æ»‘åŠ¨çª—å£æ˜¯åŸºäºæ—¶é—´æ¥åˆ’åˆ†çª—å£çš„ã€‚è€ŒTCPçš„æ»‘åŠ¨çª—å£æŒ‡çš„æ˜¯èƒ½å¤Ÿæ¥å—çš„å­—èŠ‚æ•°ï¼Œå¹¶ä¸”å¤§å°æ˜¯å¯å˜çš„ï¼ˆæ‹¥å¡æ§åˆ¶ï¼‰ æ»‘åŠ¨çª—å£æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ å‰é¢è¯´äº†å›ºå®šçª—å£å­˜åœ¨ä¸´ç•Œå€¼é—®é¢˜ï¼Œè¦è§£å†³è¿™ç§ä¸´ç•Œå€¼é—®é¢˜ï¼Œæ˜¾ç„¶åªç”¨ä¸€ä¸ªçª—å£æ˜¯è§£å†³ä¸äº†é—®é¢˜çš„ã€‚å‡è®¾æˆ‘ä»¬ä»ç„¶è®¾å®š1ç§’å†…å…è®¸é€šè¿‡çš„è¯·æ±‚æ˜¯200ä¸ªï¼Œä½†æ˜¯åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦æŠŠ1ç§’çš„æ—¶é—´åˆ†æˆå¤šæ ¼ï¼Œå‡è®¾åˆ†æˆ5æ ¼ï¼ˆæ ¼æ•°è¶Šå¤šï¼Œæµé‡è¿‡æ¸¡è¶Šå¹³æ»‘ï¼‰ï¼Œæ¯æ ¼çª—å£çš„æ—¶é—´å¤§å°æ˜¯200æ¯«ç§’ï¼Œæ¯è¿‡200æ¯«ç§’ï¼Œå°±å°†çª—å£å‘å‰ç§»åŠ¨ä¸€æ ¼ã€‚ä¸ºäº†ä¾¿äºç†è§£ï¼Œå¯ä»¥çœ‹ä¸‹å›¾ å›¾ä¸­å°†çª—å£åˆ’ä¸º5ä»½ï¼Œæ¯ä¸ªå°çª—å£ä¸­çš„æ•°å­—è¡¨ç¤ºåœ¨è¿™ä¸ªçª—å£ä¸­è¯·æ±‚æ•°ï¼Œæ‰€ä»¥é€šè¿‡è§‚å¯Ÿä¸Šå›¾ï¼Œå¯çŸ¥åœ¨å½“å‰æ—¶é—´å¿«ï¼ˆ200æ¯«ç§’ï¼‰å…è®¸é€šè¿‡çš„è¯·æ±‚æ•°åº”è¯¥æ˜¯20è€Œä¸æ˜¯200ï¼ˆåªè¦è¶…è¿‡20å°±ä¼šè¢«é™æµï¼‰ï¼Œå› ä¸ºæˆ‘ä»¬æœ€ç»ˆç»Ÿè®¡è¯·æ±‚æ•°æ—¶æ˜¯éœ€è¦æŠŠå½“å‰çª—å£çš„å€¼è¿›è¡Œç´¯åŠ ï¼Œè¿›è€Œå¾—åˆ°å½“å‰è¯·æ±‚æ•°æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯éœ€è¦è¿›è¡Œé™æµã€‚ é‚£ä¹ˆæ»‘åŠ¨çª—å£é™æµæ³•æ˜¯å®Œç¾çš„å—ï¼Ÿç»†å¿ƒè§‚å¯Ÿçš„æˆ‘ä»¬åº”è¯¥èƒ½é©¬ä¸Šå‘ç°é—®é¢˜ï¼Œæ»‘åŠ¨çª—å£é™æµæ³•å…¶å®å°±æ˜¯è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•çš„ä¸€ä¸ªå˜ç§ã€‚æµé‡çš„è¿‡æ¸¡æ˜¯å¦å¹³æ»‘ä¾èµ–äºæˆ‘ä»¬è®¾ç½®çš„çª—å£æ ¼æ•°ä¹Ÿå°±æ˜¯ç»Ÿè®¡æ—¶é—´é—´éš”ï¼Œæ ¼æ•°è¶Šå¤šï¼Œç»Ÿè®¡è¶Šç²¾ç¡®ï¼Œä½†æ˜¯å…·ä½“è¦åˆ†å¤šå°‘æ ¼æˆ‘ä»¬ä¹Ÿè¯´ä¸ä¸Šæ¥å‘€â€¦ ä»£ç å®ç° â€“ SlidingWindowRateLimit.java æ¼æ¡¶ç®—æ³•ä¸Šé¢æ‰€ä»‹ç»çš„ä¸¤ç§ç®—æ³•éƒ½ä¸èƒ½éå¸¸å¹³æ»‘çš„è¿‡æ¸¡ï¼Œä¸‹é¢å°±æ˜¯æ¼æ¡¶ç®—æ³•ç™»åœºäº†ä»€ä¹ˆæ˜¯æ¼æ¡¶ç®—æ³•ï¼Ÿæ¼æ¡¶ç®—æ³•ä»¥ä¸€ä¸ªå¸¸é‡é™åˆ¶äº†å‡ºå£æµé‡é€Ÿç‡ï¼Œå› æ­¤æ¼æ¡¶ç®—æ³•å¯ä»¥å¹³æ»‘çªå‘çš„æµé‡ã€‚å…¶ä¸­æ¼æ¡¶ä½œä¸ºæµé‡å®¹å™¨æˆ‘ä»¬å¯ä»¥çœ‹åšä¸€ä¸ªFIFOçš„é˜Ÿåˆ—ï¼Œå½“å…¥å£æµé‡é€Ÿç‡å¤§äºå‡ºå£æµé‡é€Ÿç‡æ—¶ï¼Œå› ä¸ºæµé‡å®¹å™¨æ˜¯æœ‰é™çš„ï¼Œå½“è¶…å‡ºæµé‡å®¹å™¨å¤§å°æ—¶ï¼Œè¶…å‡ºçš„æµé‡ä¼šè¢«ä¸¢å¼ƒã€‚ä¸‹å›¾æ¯”è¾ƒå½¢è±¡çš„è¯´æ˜äº†æ¼æ¡¶ç®—æ³•çš„åŸç†ï¼Œå…¶ä¸­æ°´é¾™å¤´æ˜¯å…¥å£æµé‡ï¼Œæ¼æ¡¶æ˜¯æµé‡å®¹å™¨ï¼ŒåŒ€é€Ÿæµå‡ºçš„æ°´æ˜¯å‡ºå£æµé‡ã€‚ æ¼æ¡¶ç®—æ³•çš„ç‰¹ç‚¹ æ¼æ¡¶å…·æœ‰å›ºå®šå®¹é‡ï¼Œå‡ºå£æµé‡é€Ÿç‡æ˜¯å›ºå®šå¸¸é‡ï¼ˆæµå‡ºè¯·æ±‚ï¼‰ å…¥å£æµé‡å¯ä»¥ä»¥ä»»æ„é€Ÿç‡æµå…¥åˆ°æ¼æ¡¶ä¸­ï¼ˆæµå…¥è¯·æ±‚ï¼‰ å¦‚æœå…¥å£æµé‡è¶…å‡ºäº†æ¡¶çš„å®¹é‡ï¼Œåˆ™æµå…¥æµé‡ä¼šæº¢å‡ºï¼ˆæ–°è¯·æ±‚è¢«æ‹’ç»ï¼‰ ä»£ç å®ç° â€“ LeakyBucketRateLimit.java ä¸è¿‡å› ä¸ºæ¼æ¡¶ç®—æ³•é™åˆ¶äº†æµå‡ºé€Ÿç‡æ˜¯ä¸€ä¸ªå›ºå®šå¸¸é‡å€¼ï¼Œæ‰€ä»¥æ¼æ¡¶ç®—æ³•ä¸æ”¯æŒå‡ºç°çªå‘æµå‡ºæµé‡ã€‚ä½†æ˜¯åœ¨å®é™…æƒ…å†µä¸‹ï¼Œæµé‡å¾€å¾€æ˜¯çªå‘çš„ã€‚ ä»¤ç‰Œæ¡¶ç®—æ³•ä»¤ç‰Œæ¡¶ç®—æ³•æ˜¯æ¼æ¡¶ç®—æ³•çš„æ”¹è¿›ç‰ˆï¼Œå¯ä»¥æ”¯æŒçªå‘æµé‡ã€‚ä¸è¿‡ä¸æ¼æ¡¶ç®—æ³•ä¸åŒçš„æ˜¯ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•çš„æ¼æ¡¶ä¸­å­˜æ”¾çš„æ˜¯ä»¤ç‰Œè€Œä¸æ˜¯æµé‡ã€‚é‚£ä¹ˆä»¤ç‰Œæ¡¶ç®—æ³•æ˜¯æ€ä¹ˆçªå‘æµé‡çš„å‘¢ï¼Ÿæœ€å¼€å§‹ï¼Œä»¤ç‰Œæ¡¶æ˜¯ç©ºçš„ï¼Œæˆ‘ä»¬ä»¥æ’å®šé€Ÿç‡å¾€ä»¤ç‰Œæ¡¶é‡ŒåŠ å…¥ä»¤ç‰Œï¼Œä»¤ç‰Œæ¡¶è¢«è£…æ»¡æ—¶ï¼Œå¤šä½™çš„ä»¤ç‰Œä¼šè¢«ä¸¢å¼ƒã€‚å½“è¯·æ±‚åˆ°æ¥æ—¶ï¼Œä¼šå…ˆå°è¯•ä»ä»¤ç‰Œæ¡¶è·å–ä»¤ç‰Œï¼ˆç›¸å½“äºä»ä»¤ç‰Œæ¡¶ç§»é™¤ä¸€ä¸ªä»¤ç‰Œï¼‰ï¼Œè·å–æˆåŠŸåˆ™è¯·æ±‚è¢«æ”¾è¡Œï¼Œè·å–å¤±è´¥åˆ™é˜»å¡æ´»æ‹’ç»è¯·æ±‚ã€‚ ä»¤ç‰Œæ¡¶ç®—æ³•çš„ç‰¹ç‚¹ æœ€å¤šå¯ä»¥å­˜å‘bä¸ªä»¤ç‰Œã€‚å¦‚æœä»¤ç‰Œåˆ°è¾¾æ—¶ä»¤ç‰Œæ¡¶å·²ç»æ»¡äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªä»¤ç‰Œä¼šè¢«ä¸¢å¼ƒ è¯·æ±‚åˆ°æ¥æ—¶ï¼Œå¦‚æœä»¤ç‰Œæ¡¶ä¸­å°‘äºnä¸ªä»¤ç‰Œï¼Œé‚£ä¹ˆä¸ä¼šåˆ é™¤ä»¤ç‰Œã€‚è¯¥è¯·æ±‚ä¼šè¢«é™æµï¼ˆé˜»å¡æ´»æ‹’ç»ï¼‰ ç®—æ³•å…è®¸æœ€å¤§b(ä»¤ç‰Œæ¡¶å¤§å°)ä¸ªè¯·æ±‚çš„çªå‘ ä»¤ç‰Œæ¡¶ç®—æ³•é™åˆ¶çš„æ˜¯å¹³å‡æµé‡ï¼Œå› æ­¤å…¶å…è®¸çªå‘æµé‡ï¼ˆåªè¦ä»¤ç‰Œæ¡¶ä¸­æœ‰ä»¤ç‰Œï¼Œå°±ä¸ä¼šè¢«é™æµï¼‰ ä»£ç å®ç° â€“ TokenBucketRateLimit.java æ€»ç»“è‡³æ­¤ï¼ŒåŸºæœ¬æŠŠä»¥ä¸Š4ç§é™æµç®—æ³•çš„åŸç†éƒ½è§£é‡Šæ¸…æ¥šäº†ã€‚æ¯ç§é™æµç®—æ³•éƒ½æœ‰å…¶å›ºå®šç‰¹ç‚¹ï¼ŒåŠå„è‡ªé€‚ç”¨çš„åœºæ™¯ï¼Œå…¶ä¸­è®¡æ•°å™¨ç®—æ³•æ˜¯å…¶ä¸­æœ€ç®€å•çš„ï¼Œç›¸å½“äºæ»‘åŠ¨çª—å£ç®—æ³•çš„ç®€åŒ–ç‰ˆï¼Œä»¤ç‰Œæ¡¶ç®—æ³•ç›¸æ¯”æ¼æ¡¶ç®—æ³•å¯¹èµ„æºçš„åˆ©ç”¨ç‡æ›´é«˜ï¼ˆå…è®¸çªå‘æµé‡ï¼‰]]></content>
      <categories>
        <category>ç®—æ³•</category>
        <category>åˆ†å¸ƒå¼</category>
      </categories>
      <tags>
        <tag>å¹¶å‘</tag>
        <tag>ç®—æ³•</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[JAVAä¸­æ—¶é—´çš„è¡¨ç°å½¢å¼]]></title>
    <url>%2F2019%2F09%2F26%2FJAVA%E4%B8%AD%E6%97%B6%E9%97%B4%E7%9A%84%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F%2F</url>
    <content type="text"><![CDATA[å¼•è¨€å¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬åœ¨è¡¨ç¤ºæ—¶é—´çš„æ¦‚å¿µæ—¶ï¼Œå¯èƒ½å¹¶ä¸ä¼šå»ç‰¹æ„å…³æ³¨æ—¶åŒºè¿™ä¸ªæ¦‚å¿µï¼Œæ¯•ç«Ÿåœ¨å›½å†…æ—¶åŒºéƒ½æ˜¯ç»Ÿä¸€çš„ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨é»˜è®¤æ—¶åŒº åŒ—äº¬æ—¶é—´ å°±å¯ä»¥äº†ã€‚æ˜¯çš„ï¼Œåœ¨å†™è¿™ç¯‡æ–‡ç« ä¹‹å‰ï¼Œæˆ‘ä¹Ÿæ²¡æœ‰è¿‡å¤šçš„å»å…³æ³¨æ—¶åŒºçš„æ¦‚å¿µï¼Œä»¥åŠåœ¨JAVAä¸­çš„è¡¨ç°å½¢å¼ã€‚ä½†æ˜¯å› ä¸ºç›®å‰æ‰€åœ¨çš„å…¬å¸æ˜¯è·¨å¢ƒå…¬å¸ï¼Œå…¬å¸ä¸»è¦ä¸šåŠ¡åœ¨å°åº¦ï¼Œå°åº¦æ—¶é—´è·ŸåŒ—äº¬æ—¶é—´æ˜¾ç„¶æ˜¯ä¸åŒçš„ã€‚ æ—¶åŒºçš„æ¦‚å¿µåœ¨è¿™ä¹‹å‰å…ˆè¯´ä¸€ä¸‹æ—¶åŒºçš„æ¦‚å¿µï¼Œä»¥åŠè§£é‡Šå‡ ä¸ªä¸“æœ‰åè¯ã€‚æ—¶åŒºæ˜¯åœ°çƒä¸Šçš„åŒºåŸŸä½¿ç”¨åŒä¸€ä¸ªæ—¶é—´å®šä¹‰ï¼Œæ•´ä¸ªå…¨çƒè¢«åˆ†æˆ24ä¸ªæ—¶åŒºã€‚æ‰€ä»¥æ¯å·®ä¸€ä¸ªæ—¶åŒºï¼ŒåŒºæ—¶ç›¸å·®ä¸€ä¸ªå°æ—¶ï¼Œç›¸å·®å¤šå°‘ä¸ªæ—¶åŒºï¼Œå°±ç›¸å·®å¤šå°‘ä¸ªå°æ—¶ã€‚ä¸œè¾¹çš„æ—¶åŒºæ—¶é—´æ¯”è¥¿è¾¹çš„æ—¶åŒºæ—¶é—´æ—©ã€‚åŒ—äº¬æ—¶é—´æŒ‡çš„å°±æ˜¯ä¸œå…«åŒºçš„æ—¶é—´ã€‚ UTCæ—¶é—´å’Œæœ¬åœ°æ—¶é—´UTCæ—¶é—´åˆç§°åè°ƒä¸–ç•Œæ—¶ï¼Œæ˜¯æœ€ä¸»è¦çš„ä¸–ç•Œæ—¶é—´æ ‡å‡†ï¼Œå…¶ä»¥åŸå­æ—¶ç§’é•¿ä¸ºåŸºç¡€ï¼Œåœ¨æ—¶åˆ»ä¸Šå°½é‡æ¥è¿‘äºæ ¼æ—å°¼æ²»æ ‡å‡†æ—¶é—´(GMT)ã€‚å¯¹äºå¤§å¤šæ•°ç”¨é€”æ¥è¯´ï¼ŒUTCæ—¶é—´è¢«è®¤ä¸ºèƒ½ä¸GMTæ—¶é—´äº’æ¢ï¼Œä½†GMTæ—¶é—´å·²ä¸å†è¢«ç§‘å­¦ç•Œæ‰€ç¡®å®šã€‚å¦‚æœæ—¶é—´æ˜¯ä»¥åè°ƒä¸–ç•Œæ—¶ï¼ˆUTCï¼‰è¡¨ç¤ºï¼Œåˆ™åœ¨æ—¶é—´åé¢ç›´æ¥åŠ ä¸Šä¸€ä¸ªâ€œZâ€ï¼ˆä¸åŠ ç©ºæ ¼ï¼‰ã€‚â€œZâ€æ˜¯åè°ƒä¸–ç•Œæ—¶ä¸­0æ—¶åŒºçš„æ ‡å¿—ã€‚ UTCåç§»é‡å’Œæœ¬åœ°æ—¶é—´ä¾‹å¦‚åŒ—äº¬æ—¶é—´çš„UTCåç§»é‡æ˜¯ +8ï¼Œåˆ™å½“UTCæ—¶é—´æ˜¯ 2:00 æ—¶ï¼ŒåŒ—äº¬æ—¶é—´çš„ 10:00ã€‚æ‰€ä»¥å€ŸåŠ©äºUTCæ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå…¨çƒçš„æ—¶é—´éƒ½ç»Ÿä¸€èµ·æ¥ã€‚ æ—¶é—´æˆ³æ—¶åŒºå¯ä»¥å¾ˆå¥½çš„è¡¨ç¤ºå„åœ°çš„æ—¶é—´ï¼Œä½†å„ä¸ªæ—¶åŒºçš„å­—é¢æ—¶é—´æ˜¾ç¤ºä»ç„¶è¿˜æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹å¼åœ¨æ¥è®©ä¸–ç•Œå„ä¸ªè§’è½çš„æ—¶é—´éƒ½æœ‰ä¸€æ ·çš„è¡¨ç°å½¢å¼ã€‚è¿™å¼•ç”³å‡ºäº†æ—¶é—´æˆ³ï¼Œä¹Ÿè¢«ç§°ä¸ºUnixæ—¶é—´(Unix time)ï¼Œå®šä¹‰ä¸ºä»æ ¼æ—å¨æ²»æ—¶é—´1970å¹´01æœˆ01æ—¥00æ—¶00åˆ†00ç§’èµ·è‡³ç°åœ¨çš„æ€»ç§’æ•°ã€‚ Java8ä¸­çš„æ—¶é—´ç±»å‹åœ¨JAVA8ä¸­ï¼Œæä¾›äº†æ–°çš„æ—¶é—´æ—¥æœŸæ“ä½œç±»ï¼Œç›¸å¯¹äºä¹‹å‰çš„ Date ç±»ï¼Œå¯ä»¥è¯´ä½¿ç”¨èµ·æ¥æ–¹ä¾¿äº†è®¸å¤šï¼Œä¸‹é¢ä¾æ¬¡æ¥ä»‹ç»å‡ ä¸ªå…³é”®ç±»ã€‚ Instant ç”¨æ¥è¡¨ç¤ºæ—¶é—´æˆ³ LocalDateTime å•çº¯è¡¨ç¤ºå­—é¢æ—¶é—´ï¼Œä¸å¸¦æ—¶åŒºä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ LocalDateTime = 2019-09-25 00:00:00ï¼Œè¿™ä¸ªæ—¶é—´æˆ‘ä»¬å¹¶ä¸çŸ¥é“æ˜¯åŒ—äº¬æ—¶é—´è¿˜æ˜¯ä¸œäº¬æ—¶é—´ï¼Œä»…ä»…ç”¨ä½œå­—é¢æ—¶é—´ ZonedDateTime å«æœ‰æ—¶åŒºä¿¡æ¯çš„æ—¶é—´ï¼Œç±»ä¼¼äºåŒ—äº¬æ—¶é—´ï¼ŒUTC+8 å®ƒä»¬å¦‚ä½•è¡¨ç¤ºæ—¶é—´12345678System.out.println(LocalDateTime.now());System.out.println(Instant.now());System.out.println(ZonedDateTime.now());è¾“å‡º2019-09-26T14:50:43.7412019-09-26T06:50:43.742Z2019-09-26T14:50:43.803+08:00[Asia/Shanghai] å¯ä»¥çœ‹åˆ°LocalDateTime ä¼šæ ¹æ®UTCæ—¶é—´è·å–åˆ°æœ¬åœ°æ—¶é—´æ˜¾ç¤ºï¼Œä½†æ˜¯ä¼šæŠŠæ—¶åŒºä¿¡æ¯ä¸¢å¼ƒInstant åˆ™ç›´æ¥è¡¨ç¤ºçš„UTCä¸–ç•Œæ ‡å‡†æ—¶é—´ZonedDateTime ä¼šæ ¹æ®UTCæ—¶é—´è·å–åˆ°æœ¬åœ°æ—¶é—´æ˜¾ç¤ºï¼ŒåŒæ—¶ä¹Ÿä¼šæ˜¾ç¤ºå½“å‰çš„æ—¶åŒºä¿¡æ¯ å…¶å®ZonedDateTime æ˜¯ç”± Instant åŠ ä¸Šæ—¶åŒºä¿¡æ¯ç»“åˆè€Œæ¥ï¼Œé€šè¿‡ZonedDateTimeå¯ä»¥ç›´æ¥è·å–åˆ°Instantæ—¶é—´æˆ³ä¿¡æ¯ å¦‚ä½•è½¬æ¢è½¬æ¢çš„æ ¸å¿ƒå…¶å®éƒ½æ˜¯å¾€æ—¶é—´æˆ³ï¼ˆä¸–ç•Œæ ‡å‡†æ—¶é—´ï¼‰é æ‹¢ï¼Œè¯•æƒ³æ˜¯ä¸æ˜¯è¿™æ ·ï¼Ÿåªæœ‰è½¬æˆäº†æ ‡å‡†æ—¶é—´æ‰èƒ½è½¬æˆå…¶ä»–æ—¶åŒºçš„æ—¶é—´ ZonedDateTime Instant 1234567// zonedDateTime -&gt; instantZonedDateTime zonedDateTime = ZonedDateTime.now();Instant instant = zonedDateTime.toInstant();// instant -&gt; zonedDateTime è¦æŒ‡å®šæ—¶åŒºä¿¡æ¯ZoneId DEFAULT_ZONE_ID = ZoneId.of("Asia/Shanghai");zonedDateTime = instant.atZone(DEFAULT_ZONE_ID); LocalDateTime Instant 12345678// LocalDateTime -&gt; InstantLocalDateTime localDateTime = LocalDateTime.now();Instant instant = localDateTime.toInstant(ZoneOffset.of("+08:00"));// Instant -&gt; ZonedDateTime -&gt; LocalDateTime// Instant éœ€è¦å…ˆè½¬æ¢æˆ ZonedDateTime å†è½¬æ¢æˆæœ¬åœ°æ—¶é—´ZonedDateTime zonedDateTime = instant.atZone(ZoneId.of("Asia/Shanghai"));localDateTime = zonedDateTime.toLocalDateTime(); LocalDateTime ZonedDateTime 123456// LocalDateTime -&gt; ZonedDateTime éœ€è¦æŒ‡å®šæœ¬åœ°æ‰€åœ¨æ—¶åŒºLocalDateTime localDateTime = LocalDateTime.now();ZonedDateTime zonedDateTime = localDateTime.atZone(ZoneId.of("Asia/Shanghai"));// ç›´æ¥è½¬æ¢æˆæœ¬åœ°æ—¶é—´localDateTime = zonedDateTime.toLocalDateTime(); å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è½¬æ¢è¿‡ç¨‹ä¸­ï¼Œä¼šé¢‘ç¹çš„æ‰‹åŠ¨æŒ‡å®šæ—¶åŒºï¼Œä¸»è¦åŸå› æ˜¯LocalDateTimeå¹¶ä¸å¸¦æœ‰æ—¶åŒºä¿¡æ¯ï¼Œå¦‚æœæˆ‘ä»¬è¦è½¬æ¢æˆæ ‡å‡†æ—¶é—´ï¼Œå°±éœ€è¦æ‰‹åŠ¨æŒ‡å®šæ—¶åŒºã€‚æ‰€ä»¥ä¸ºäº†é¿å…è½¬æ¢è¿‡ç¨‹ä¸­çš„é”™è¯¯ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨æ—¶é—´æˆ³æ¥æ¥ä¼ è¾“æ—¶é—´ã€‚ ä¸å…¶ä»–apiçš„è½¬æ¢ Timestamp LocalDateTime 123456789// Timestamp -&gt; LocalDateTimeTimestamp timestamp = Timestamp.from(Instant.now());LocalDateTime localDateTime = timestamp.toLocalDateTime();// LocalDateTime -&gt; Timestamp æœ‰ä¸¤ç§æ–¹å¼// 1. ç›´æ¥æŒ‰æœ¬åœ°é»˜è®¤æ—¶åŒºè½¬æ—¶åŒºtimestamp = Timestamp.valueOf(localDateTime);// 2. æŒ‡å®šæ—¶åŒºè½¬timestamp = Timestamp.from(localDateTime.toInstant(ZoneOffset.of(&quot;+08:00&quot;))); Date LocalDateTime 123456// Date -&gt; LocalDateTimeDate date = new Date();LocalDateTime localDateTime = date.toInstant().atZone(ZoneId.of("Asia/Shanghai")).toLocalDateTime();// LocalDateTime -&gt; Datedate = Date.from(localDateTime.toInstant(ZoneOffset.of("+08:00"))); æ›´å¤šä¾‹å­DateTimeUtils.java æ€»ç»“æœ€åè¿˜æ˜¯å»ºè®®æ“ä½œæ—¶é—´æ—¶ä½¿ç”¨æ—¶é—´æˆ³ï¼Œè¿™æ ·å­æ²¡æœ‰æ—¶åŒºçš„æ¦‚å¿µï¼Œä¹Ÿå°±ä¸ä¼šäº§ç”Ÿæ­§ä¹‰ã€‚]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
      </categories>
      <tags>
        <tag>javaåŸºç¡€</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Springçš„@Configuration @Beanæ³¨è§£]]></title>
    <url>%2F2019%2F09%2F03%2FSpring%E7%9A%84-Configuration-Bean%E6%B3%A8%E8%A7%A3%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ä¹‹å‰Spring ä¸€ç›´ç”¨çš„xmlé…ç½®æ–‡ä»¶æ¯”è¾ƒå¤šï¼Œç°åœ¨å‘ç°æ–°å…¬å¸ç”¨çš„æ³¨è§£æ¯”è¾ƒå¤šã€‚ä¹Ÿå°±æ˜¯é€šè¿‡å®šä¹‰ä¸€ä¸ªé…ç½®ç±»(ä»¥@Configurationæ³¨è§£çš„ç±»)å†…éƒ¨åœ¨æ–¹æ³•ä¸Šæ³¨è§£ @Bean æ³¨è§£æ¥å®ŒæˆBeançš„ä¾èµ–æ³¨å…¥Springå®¹å™¨ã€‚ç”¨æ³¨è§£æ¥é…ç½®çš„è¯ï¼Œå…¶å®å°±æ˜¯å‡å°‘äº†é…ç½®æ–‡ä»¶çš„å·¥ä½œï¼Œä½†æ€»ä½“æ¥è¯´ä»£ç å¯è¯»æ€§å…¶å®æ˜¯ä¼šä¸‹é™çš„ã€‚ä¸è¿‡ä¹Ÿçœå»äº†ä¸€å¤§å †çš„xmlé…ç½®æ–‡ä»¶ ç›´æ¥çœ‹æºç ä¸‹é¢å°±ä»æºç å±‚é¢æ¥çœ‹çœ‹ é€šè¿‡æ³¨è§£é…ç½®æœ‰ä»€ä¹ˆä¸åŒ ä¹‹å‰æœ‰åˆ†æè¿‡Springå¯¹Beançš„è§£æï¼Œæ˜¯é€šè¿‡æŠŠæˆ‘ä»¬é…ç½®çš„Beanä¿¡æ¯æŠ½è±¡æˆäº†ä¸€ä¸ªBeanDefiniionå¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡æŒæœ‰äº†æˆ‘ä»¬é…ç½®çš„Beançš„å…ƒæ•°æ® é‚£ä¹ˆå…¶å® @Bean çš„æ³¨è§£çš„åŸç†ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œä¹Ÿæ˜¯é€šè¿‡å°†æˆ‘ä»¬é…ç½®çš„Beanä¿¡æ¯æŠ½è±¡æˆä¸€ä¸ªBeanDefiniionå¯¹è±¡ è¿™é‡Œæˆ‘ä»¬åˆ†ä¸¤ç§æƒ…å†µè®¨è®ºï¼Œä¸€ç§æ˜¯ Spring é€šè¿‡ xmlæ–‡ä»¶é…ç½®å®ç°æ³¨è§£é…ç½®ï¼Œä¸€ç§å°±æ˜¯æˆ‘ä»¬ç°åœ¨éå¸¸æµè¡Œçš„ SpringBootå®ç°çš„æ³¨è§£é…ç½®ã€‚å…¶å®ä¸¤è€…å®ç°åŸç†ä¸€è‡´ï¼Œåªæ˜¯é…ç½®å…¥å£ç•¥æœ‰ä¸åŒã€‚ å…ˆçœ‹ æ™®é€š Spring åº”ç”¨çš„é…ç½®: å¦‚æœæˆ‘ä»¬è¦åœ¨ æ™®é€š Spring åº”ç”¨ä¸­å®ç°æ³¨è§£é…ç½®ã€‚é‚£ä¹ˆæˆ‘ä»¬éœ€è¦åœ¨Springçš„é…ç½®æ–‡ä»¶ä¸­é…ç½®ä»¥ä¸‹å‡ ä¸ªé…ç½® 1234&lt;context:annotation-config&gt;&lt;context:component-scan&gt; è¿™ä¸¤ä¸ªé…ç½®çš„æ„æ€æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ æˆ‘ä»¬ç›´æ¥çœ‹Springæ˜¯å¦‚ä½•è§£æè¿™ä¸¤ä¸ªæ ‡ç­¾çš„å§ï¼Œé€šè¿‡åœ¨META-INF/spring.handlersç›®å½•ä¸‹æ ¹æ®spring.handlersæ–‡ä»¶å¯ä»¥æ‰¾åˆ° Context æ ‡ç­¾ è§£æå…¥å£ç±» ContextNamespaceHandler 1234567891011121314151617181920212223242526public class ContextNamespaceHandler extends NamespaceHandlerSupport &#123;@Overridepublic void init() &#123;registerBeanDefinitionParser("property-placeholder", new PropertyPlaceholderBeanDefinitionParser());registerBeanDefinitionParser("property-override", new PropertyOverrideBeanDefinitionParser());registerBeanDefinitionParser("annotation-config", new AnnotationConfigBeanDefinitionParser());registerBeanDefinitionParser("component-scan", new ComponentScanBeanDefinitionParser());registerBeanDefinitionParser("load-time-weaver", new LoadTimeWeaverBeanDefinitionParser());registerBeanDefinitionParser("spring-configured", new SpringConfiguredBeanDefinitionParser());registerBeanDefinitionParser("mbean-export", new MBeanExportBeanDefinitionParser());registerBeanDefinitionParser("mbean-server", new MBeanServerBeanDefinitionParser());&#125;&#125; çœ‹äº†ä¸Šé¢çš„è§£ææºç ï¼Œå¯ä»¥çŸ¥é“annotation-configç”±AnnotationConfigBeanDefinitionParserè§£æã€‚component-scanç”±ComponentScanBeanDefinitionParserè§£æã€‚è¿™é‡Œå°±æ˜¯Spring XML æ³¨è§£é…ç½®çš„å…¥å£ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ä¾æ¬¡åˆ†æè¿™ä¸¤ä¸ªè§£æç±»å¹²äº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ ComponentScanBeanDefinitionParser 1234567891011121314151617181920212223242526public BeanDefinition parse(Element element, ParserContext parserContext) &#123;String basePackage = element.getAttribute(BASE_PACKAGE_ATTRIBUTE);basePackage = parserContext.getReaderContext().getEnvironment().resolvePlaceholders(basePackage);String[] basePackages = StringUtils.tokenizeToStringArray(basePackage,ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);// Actually scan for bean definitions and register them.ClassPathBeanDefinitionScanner scanner = configureScanner(parserContext, element); // è¿™é‡Œæ‰«æäº†æˆ‘ä»¬é…ç½®çš„ base-package åŒ…ä¸‹å…¨éƒ¨ beanDefinitionsï¼Œå¹¶æŠ½è±¡æˆäº† BeanDefinitionHolderç±»Set&lt;BeanDefinitionHolder&gt; beanDefinitions = scanner.doScan(basePackages); // å°†æŠ½è±¡çš„ beanDefinitions å…¨éƒ¨æ³¨å†Œè¿› Springå®¹å™¨ä¸­ï¼Œæ³¨ è¿™é‡ŒåŒ…å«äº†è¢«@Configurationæ³¨è§£çš„ç±»registerComponents(parserContext.getReaderContext(), beanDefinitions, element);return null;&#125; AnnotationConfigBeanDefinitionParser ä¸»è¦é€»è¾‘åœ¨ AnnotationConfigUtils å·¥å…·ç±»çš„ registerAnnotationConfigProcessorsæ–¹æ³•ä¸­ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166public BeanDefinition parse(Element element, ParserContext parserContext) &#123;Object source = parserContext.extractSource(element);// åˆå§‹åŒ–ä¸€äº› BeanFactoryPostProcessor è¿›Springå®¹å™¨ï¼Œä¼šåœ¨getBeanä¹‹å‰å…¨éƒ¨æ‰§è¡Œã€‚ // ä¸€èˆ¬ç”¨æ¥åœ¨å®¹å™¨å®ä¾‹åŒ–Beanå‰ï¼Œå¯¹BeanDefinitionåšä¿®æ”¹ï¼Œæˆ–æ·»åŠ æ–°çš„BeanDefinitionç­‰å‰ç½®ä¿®æ”¹ // ä¸»è¦é€»è¾‘å°±åœ¨è¿™é‡ŒSet&lt;BeanDefinitionHolder&gt; processorDefinitions =AnnotationConfigUtils.registerAnnotationConfigProcessors(parserContext.getRegistry(), source);// Register component for the surrounding &lt;context:annotation-config&gt; element.CompositeComponentDefinition compDefinition = new CompositeComponentDefinition(element.getTagName(), source);parserContext.pushContainingComponent(compDefinition);// Nest the concrete beans in the surrounding component.for (BeanDefinitionHolder processorDefinition : processorDefinitions) &#123;parserContext.registerComponent(new BeanComponentDefinition(processorDefinition));&#125;// Finally register the composite component.parserContext.popAndRegisterContainingComponent();return null;&#125;// AnnotationConfigUtils.class// æ·»åŠ æ”¯æŒ annotation-config é…ç½®çš„ä¸€äº›BeanFactoryPostProcessor å®ç°ç±»public static Set&lt;BeanDefinitionHolder&gt; registerAnnotationConfigProcessors(BeanDefinitionRegistry registry, @Nullable Object source) &#123;DefaultListableBeanFactory beanFactory = unwrapDefaultListableBeanFactory(registry);if (beanFactory != null) &#123;if (!(beanFactory.getDependencyComparator() instanceof AnnotationAwareOrderComparator)) &#123;beanFactory.setDependencyComparator(AnnotationAwareOrderComparator.INSTANCE);&#125;if (!(beanFactory.getAutowireCandidateResolver() instanceof ContextAnnotationAutowireCandidateResolver)) &#123;beanFactory.setAutowireCandidateResolver(new ContextAnnotationAutowireCandidateResolver());&#125;&#125;Set&lt;BeanDefinitionHolder&gt; beanDefs = new LinkedHashSet&lt;&gt;(8);// @Configuration æ³¨è§£è§£æif (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;RootBeanDefinition def = new RootBeanDefinition(ConfigurationClassPostProcessor.class);def.setSource(source);beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME));&#125; // @Autowired æ³¨è§£è§£æif (!registry.containsBeanDefinition(AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;RootBeanDefinition def = new RootBeanDefinition(AutowiredAnnotationBeanPostProcessor.class);def.setSource(source);beanDefs.add(registerPostProcessor(registry, def, AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME));&#125;// @Required æ³¨è§£è§£æif (!registry.containsBeanDefinition(REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;RootBeanDefinition def = new RootBeanDefinition(RequiredAnnotationBeanPostProcessor.class);def.setSource(source);beanDefs.add(registerPostProcessor(registry, def, REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME));&#125;// Check for JSR-250 support, and if present add the CommonAnnotationBeanPostProcessor. // å¯¹ JSR-250åšæ”¯æŒ è§£ææ³¨è§£ @Resource @PostConstruct @PreDestroy if (jsr250Present &amp;&amp; !registry.containsBeanDefinition(COMMON_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;RootBeanDefinition def = new RootBeanDefinition(CommonAnnotationBeanPostProcessor.class);def.setSource(source);beanDefs.add(registerPostProcessor(registry, def, COMMON_ANNOTATION_PROCESSOR_BEAN_NAME));&#125;// Check for JPA support, and if present add the PersistenceAnnotationBeanPostProcessor.if (jpaPresent &amp;&amp; !registry.containsBeanDefinition(PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;RootBeanDefinition def = new RootBeanDefinition();try &#123;def.setBeanClass(ClassUtils.forName(PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME,AnnotationConfigUtils.class.getClassLoader()));&#125;catch (ClassNotFoundException ex) &#123;throw new IllegalStateException("Cannot load optional framework class: " + PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME, ex);&#125;def.setSource(source);beanDefs.add(registerPostProcessor(registry, def, PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME));&#125;if (!registry.containsBeanDefinition(EVENT_LISTENER_PROCESSOR_BEAN_NAME)) &#123;RootBeanDefinition def = new RootBeanDefinition(EventListenerMethodProcessor.class);def.setSource(source);beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_PROCESSOR_BEAN_NAME));&#125;if (!registry.containsBeanDefinition(EVENT_LISTENER_FACTORY_BEAN_NAME)) &#123;RootBeanDefinition def = new RootBeanDefinition(DefaultEventListenerFactory.class);def.setSource(source);beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_FACTORY_BEAN_NAME));&#125;return beanDefs;&#125; å¯ä»¥çœ‹åˆ° annotation-config é…ç½®å…¶å®å°±æ˜¯æ·»åŠ äº†å‡ ä¸ª BeanFactoryPostProcessor å®ç°ç±»ï¼Œä»¥æ­¤æ¥å®ç° Autowired Configuration @Resource @PostConstruct @PreDestroy ç­‰æ³¨è§£çš„å®ç°ã€‚å…¶ä»–çš„æ³¨è§£æš‚ä¸”ä¸çœ‹ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä»Šå¤©çš„é‡ç‚¹ Configuration æ³¨è§£æ˜¯å¦‚ä½•è§£æï¼Œ@Configurationæ˜¯é€šè¿‡ BeanFactoryPostProcessor çš„å®ç°ç±» ConfigurationClassPostProcessor ç±»åœ¨Springå¯åŠ¨çš„æ—¶å€™æ‰§è¡Œçš„ï¼ˆå…·ä½“BeanFactoryPostProcessorçš„æ‰§è¡Œæ—¶æœºå¯ä»¥çœ‹æˆ‘å¦ä¸€ç¯‡åšæ–‡[ é“¾æ¥](https://www.yuque.com/wangjunnan/pnhnfo/bx15ai)ï¼‰ ConfigurationClassPostProcessor 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) &#123;int registryId = System.identityHashCode(registry); // åˆ¤æ–­æ˜¯å¦å·²ç»æ‰§è¡Œè¿‡if (this.registriesPostProcessed.contains(registryId)) &#123;throw new IllegalStateException("postProcessBeanDefinitionRegistry already called on this post-processor against " + registry);&#125;if (this.factoriesPostProcessed.contains(registryId)) &#123;throw new IllegalStateException("postProcessBeanFactory already called on this post-processor against " + registry);&#125;this.registriesPostProcessed.add(registryId); // æ­£å¼æ‰§è¡Œé€»è¾‘processConfigBeanDefinitions(registry);&#125;public void processConfigBeanDefinitions(BeanDefinitionRegistry registry) &#123;List&lt;BeanDefinitionHolder&gt; configCandidates = new ArrayList&lt;&gt;();String[] candidateNames = registry.getBeanDefinitionNames();// éå†æ‰€æœ‰ BeanDefinition namefor (String beanName : candidateNames) &#123;BeanDefinition beanDef = registry.getBeanDefinition(beanName); // åˆ¤æ–­æ˜¯å¦å·²ç»å¤„ç†è¿‡if (ConfigurationClassUtils.isFullConfigurationClass(beanDef) ||ConfigurationClassUtils.isLiteConfigurationClass(beanDef)) &#123;if (logger.isDebugEnabled()) &#123;logger.debug("Bean definition has already been processed as a configuration class: " + beanDef);&#125;&#125; // æ¡ä»¶ç­›é€‰else if (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, this.metadataReaderFactory)) &#123;configCandidates.add(new BeanDefinitionHolder(beanDef, beanName));&#125;&#125;// æ “é€‰å®Œä¸ºç©º ç›´æ¥è¿”å›if (configCandidates.isEmpty()) &#123;return;&#125;// æ ¹æ® @Order æ³¨è§£æ’åºconfigCandidates.sort((bd1, bd2) -&gt; &#123;int i1 = ConfigurationClassUtils.getOrder(bd1.getBeanDefinition());int i2 = ConfigurationClassUtils.getOrder(bd2.getBeanDefinition());return Integer.compare(i1, i2);&#125;);// Detect any custom bean name generation strategy supplied through the enclosing application context // è·å– BeanName ç”Ÿæˆç­–ç•¥SingletonBeanRegistry sbr = null;if (registry instanceof SingletonBeanRegistry) &#123;sbr = (SingletonBeanRegistry) registry;if (!this.localBeanNameGeneratorSet) &#123;BeanNameGenerator generator = (BeanNameGenerator) sbr.getSingleton(CONFIGURATION_BEAN_NAME_GENERATOR);if (generator != null) &#123;this.componentScanBeanNameGenerator = generator;this.importBeanNameGenerator = generator;&#125;&#125;&#125;if (this.environment == null) &#123;this.environment = new StandardEnvironment();&#125;// Parse each @Configuration class // è§£æ @Configuration æ³¨è§£ConfigurationClassParser parser = new ConfigurationClassParser(this.metadataReaderFactory, this.problemReporter, this.environment,this.resourceLoader, this.componentScanBeanNameGenerator, registry);Set&lt;BeanDefinitionHolder&gt; candidates = new LinkedHashSet&lt;&gt;(configCandidates);Set&lt;ConfigurationClass&gt; alreadyParsed = new HashSet&lt;&gt;(configCandidates.size());do &#123;parser.parse(candidates);parser.validate();Set&lt;ConfigurationClass&gt; configClasses = new LinkedHashSet&lt;&gt;(parser.getConfigurationClasses());configClasses.removeAll(alreadyParsed);// Read the model and create bean definitions based on its content // è¯»å–å¹¶è§£ææ³¨å†Œ BeanDefinitionif (this.reader == null) &#123;this.reader = new ConfigurationClassBeanDefinitionReader(registry, this.sourceExtractor, this.resourceLoader, this.environment,this.importBeanNameGenerator, parser.getImportRegistry());&#125;this.reader.loadBeanDefinitions(configClasses);alreadyParsed.addAll(configClasses);candidates.clear(); // å¤„ç†æ–°åŠ å…¥çš„if (registry.getBeanDefinitionCount() &gt; candidateNames.length) &#123;String[] newCandidateNames = registry.getBeanDefinitionNames();Set&lt;String&gt; oldCandidateNames = new HashSet&lt;&gt;(Arrays.asList(candidateNames));Set&lt;String&gt; alreadyParsedClasses = new HashSet&lt;&gt;();for (ConfigurationClass configurationClass : alreadyParsed) &#123;alreadyParsedClasses.add(configurationClass.getMetadata().getClassName());&#125;for (String candidateName : newCandidateNames) &#123;if (!oldCandidateNames.contains(candidateName)) &#123;BeanDefinition bd = registry.getBeanDefinition(candidateName);if (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, this.metadataReaderFactory) &amp;&amp;!alreadyParsedClasses.contains(bd.getBeanClassName())) &#123;candidates.add(new BeanDefinitionHolder(bd, candidateName));&#125;&#125;&#125;candidateNames = newCandidateNames;&#125;&#125;while (!candidates.isEmpty());// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classesif (sbr != null &amp;&amp; !sbr.containsSingleton(IMPORT_REGISTRY_BEAN_NAME)) &#123;sbr.registerSingleton(IMPORT_REGISTRY_BEAN_NAME, parser.getImportRegistry());&#125;if (this.metadataReaderFactory instanceof CachingMetadataReaderFactory) &#123;// Clear cache in externally provided MetadataReaderFactory; this is a no-op// for a shared cache since it'll be cleared by the ApplicationContext.((CachingMetadataReaderFactory) this.metadataReaderFactory).clearCache();&#125;&#125; å…·ä½“çš„æ‰§è¡Œé€»è¾‘åœ¨ConfigurationClassParser ç±»çš„ parse æ–¹æ³•ä¸­ ConfigurationClassParser æ ¸å¿ƒè§£ææ–¹æ³•æ˜¯ doProcessConfigurationClassæ–¹æ³•ï¼Œä¸‹é¢ç›´æ¥çœ‹è¿™ä¸ªæ–¹æ³•çš„å®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150protected final SourceClass doProcessConfigurationClass(ConfigurationClass configClass, SourceClass sourceClass)throws IOException &#123;// Recursively process any member (nested) classes firstprocessMemberClasses(configClass, sourceClass);// Process any @PropertySource annotations // è§£æ @PropertySource for (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(sourceClass.getMetadata(), PropertySources.class,org.springframework.context.annotation.PropertySource.class)) &#123;if (this.environment instanceof ConfigurableEnvironment) &#123;processPropertySource(propertySource);&#125;else &#123;logger.warn("Ignoring @PropertySource annotation on [" + sourceClass.getMetadata().getClassName() +"]. Reason: Environment must implement ConfigurableEnvironment");&#125;&#125;// Process any @ComponentScan annotations // è§£æ @ComponentScan Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);if (!componentScans.isEmpty() &amp;&amp;!this.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;for (AnnotationAttributes componentScan : componentScans) &#123;// The config class is annotated with @ComponentScan -&gt; perform the scan immediatelySet&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =this.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());// Check the set of scanned definitions for any further config classes and parse recursively if neededfor (BeanDefinitionHolder holder : scannedBeanDefinitions) &#123;BeanDefinition bdCand = holder.getBeanDefinition().getOriginatingBeanDefinition();if (bdCand == null) &#123;bdCand = holder.getBeanDefinition();&#125;if (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, this.metadataReaderFactory)) &#123;parse(bdCand.getBeanClassName(), holder.getBeanName());&#125;&#125;&#125;&#125;// Process any @Import annotations // è§£æ @ImportprocessImports(configClass, sourceClass, getImports(sourceClass), true);// Process any @ImportResource annotations // è§£æ @ImportResourceAnnotationAttributes importResource =AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);if (importResource != null) &#123;String[] resources = importResource.getStringArray("locations");Class&lt;? extends BeanDefinitionReader&gt; readerClass = importResource.getClass("reader");for (String resource : resources) &#123;String resolvedResource = this.environment.resolveRequiredPlaceholders(resource);configClass.addImportedResource(resolvedResource, readerClass);&#125;&#125;// Process individual @Bean methods // è§£æ @BeanSet&lt;MethodMetadata&gt; beanMethods = retrieveBeanMethodMetadata(sourceClass);for (MethodMetadata methodMetadata : beanMethods) &#123;configClass.addBeanMethod(new BeanMethod(methodMetadata, configClass));&#125;// Process default methods on interfacesprocessInterfaces(configClass, sourceClass);// Process superclass, if anyif (sourceClass.getMetadata().hasSuperClass()) &#123;String superclass = sourceClass.getMetadata().getSuperClassName();if (superclass != null &amp;&amp; !superclass.startsWith("java") &amp;&amp;!this.knownSuperclasses.containsKey(superclass)) &#123;this.knownSuperclasses.put(superclass, configClass);// Superclass found, return its annotation metadata and recursereturn sourceClass.getSuperClass();&#125;&#125;// No superclass -&gt; processing is completereturn null;&#125; å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ä»£ç ä¾æ¬¡è§£æäº† @PropertySourceï¼Œ@ComponentScan @Bean @Import ç­‰æ³¨è§£ã€‚è¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ @Bean çš„å®ç° 123456789101112// è·å– @bean æ³¨è§£ä¿®é¥°çš„ æ–¹æ³•å…ƒæ•°æ®ä¿¡æ¯Set&lt;MethodMetadata&gt; beanMethods = retrieveBeanMethodMetadata(sourceClass);for (MethodMetadata methodMetadata : beanMethods) &#123; // å°è£…æˆ BeanMethod configClass.addBeanMethod(new BeanMethod(methodMetadata, configClass));&#125; ä¸‹é¢æˆ‘ä»¬å›åˆ° ConfigurationClassPostProcessor ï¼Œè§£æå®Œ å…ƒæ•°æ®ä¹‹åï¼Œå°±æ˜¯åŠ è½½æ³¨å†Œ BeanDefinitionäº† 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354this.reader.loadBeanDefinitions(configClasses);public void loadBeanDefinitions(Set&lt;ConfigurationClass&gt; configurationModel) &#123;TrackedConditionEvaluator trackedConditionEvaluator = new TrackedConditionEvaluator();for (ConfigurationClass configClass : configurationModel) &#123;loadBeanDefinitionsForConfigurationClass(configClass, trackedConditionEvaluator);&#125;&#125;private void loadBeanDefinitionsForConfigurationClass(ConfigurationClass configClass, TrackedConditionEvaluator trackedConditionEvaluator) &#123;if (trackedConditionEvaluator.shouldSkip(configClass)) &#123;String beanName = configClass.getBeanName();if (StringUtils.hasLength(beanName) &amp;&amp; this.registry.containsBeanDefinition(beanName)) &#123;this.registry.removeBeanDefinition(beanName);&#125;this.importRegistry.removeImportingClass(configClass.getMetadata().getClassName());return;&#125;if (configClass.isImported()) &#123;registerBeanDefinitionForImportedConfigurationClass(configClass);&#125;for (BeanMethod beanMethod : configClass.getBeanMethods()) &#123; // è§£æä¹‹å‰ è§£æ @bean åŠ å…¥çš„ beanMethodä¿¡æ¯loadBeanDefinitionsForBeanMethod(beanMethod);&#125;loadBeanDefinitionsFromImportedResources(configClass.getImportedResources());loadBeanDefinitionsFromRegistrars(configClass.getImportBeanDefinitionRegistrars());&#125; çœ‹çœ‹ loadBeanDefinitionsForBeanMethod æ–¹æ³•çš„å®ç°ï¼Œå…¶å®å°±æ˜¯ä»BeanMethodä¸­æå–ä¿¡æ¯ç»„è£…æˆ BeanDefinition 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174private void loadBeanDefinitionsForBeanMethod(BeanMethod beanMethod) &#123;ConfigurationClass configClass = beanMethod.getConfigurationClass();MethodMetadata metadata = beanMethod.getMetadata();String methodName = metadata.getMethodName();// åˆ¤æ–­æ˜¯å¦éœ€è¦è·³è¿‡if (this.conditionEvaluator.shouldSkip(metadata, ConfigurationPhase.REGISTER_BEAN)) &#123;configClass.skippedBeanMethods.add(methodName);return;&#125;if (configClass.skippedBeanMethods.contains(methodName)) &#123;return;&#125;AnnotationAttributes bean = AnnotationConfigUtils.attributesFor(metadata, Bean.class);Assert.state(bean != null, "No @Bean annotation attributes");// è€ƒè™‘åˆ«å åç§°List&lt;String&gt; names = new ArrayList&lt;&gt;(Arrays.asList(bean.getStringArray("name")));String beanName = (!names.isEmpty() ? names.remove(0) : methodName);// æ³¨å†Œåˆ«å for (String alias : names) &#123;this.registry.registerAlias(beanName, alias);&#125;// Has this effectively been overridden before (e.g. via XML)? // åˆ¤æ–­æ˜¯å¦åœ¨ xmlé…ç½®æ–‡ä»¶ä¸­ å·²ç»é…ç½®è¿‡if (isOverriddenByExistingDefinition(beanMethod, beanName)) &#123;if (beanName.equals(beanMethod.getConfigurationClass().getBeanName())) &#123;throw new BeanDefinitionStoreException(beanMethod.getConfigurationClass().getResource().getDescription(),beanName, "Bean name derived from @Bean method '" + beanMethod.getMetadata().getMethodName() +"' clashes with bean name for containing configuration class; please make those names unique!");&#125;return;&#125;ConfigurationClassBeanDefinition beanDef = new ConfigurationClassBeanDefinition(configClass, metadata);beanDef.setResource(configClass.getResource());beanDef.setSource(this.sourceExtractor.extractSource(metadata, configClass.getResource())); // è¿™é‡Œå¯ä»¥çŸ¥é“ @bean é…ç½®æ˜¯ é€šè¿‡ FactoryMethod æ¥åˆå§‹åŒ–çš„if (metadata.isStatic()) &#123;// static @Bean methodbeanDef.setBeanClassName(configClass.getMetadata().getClassName());beanDef.setFactoryMethodName(methodName);&#125;else &#123;// instance @Bean methodbeanDef.setFactoryBeanName(configClass.getBeanName());beanDef.setUniqueFactoryMethodName(methodName);&#125;beanDef.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_CONSTRUCTOR);beanDef.setAttribute(RequiredAnnotationBeanPostProcessor.SKIP_REQUIRED_CHECK_ATTRIBUTE, Boolean.TRUE);AnnotationConfigUtils.processCommonDefinitionAnnotations(beanDef, metadata); // è®¾ç½®autowireå±æ€§Autowire autowire = bean.getEnum("autowire");if (autowire.isAutowire()) &#123;beanDef.setAutowireMode(autowire.value());&#125;// è®¾ç½®initMethod åˆå§‹åŒ–æ–¹æ³•String initMethodName = bean.getString("initMethod");if (StringUtils.hasText(initMethodName)) &#123;beanDef.setInitMethodName(initMethodName);&#125;// è®¾ç½®destroyMethod é”€æ¯æ–¹æ³•String destroyMethodName = bean.getString("destroyMethod");beanDef.setDestroyMethodName(destroyMethodName);// è·å– scopeScopedProxyMode proxyMode = ScopedProxyMode.NO;AnnotationAttributes attributes = AnnotationConfigUtils.attributesFor(metadata, Scope.class);if (attributes != null) &#123;beanDef.setScope(attributes.getString("value"));proxyMode = attributes.getEnum("proxyMode");if (proxyMode == ScopedProxyMode.DEFAULT) &#123;proxyMode = ScopedProxyMode.NO;&#125;&#125;// Replace the original bean definition with the target one, if necessary // å¦‚æœ‰å¿…è¦ï¼Œå°†åŸå§‹Beanå®šä¹‰æ›¿æ¢ä¸ºç›®æ ‡Beanå®šä¹‰BeanDefinition beanDefToRegister = beanDef;if (proxyMode != ScopedProxyMode.NO) &#123;BeanDefinitionHolder proxyDef = ScopedProxyCreator.createScopedProxy(new BeanDefinitionHolder(beanDef, beanName), this.registry,proxyMode == ScopedProxyMode.TARGET_CLASS);beanDefToRegister = new ConfigurationClassBeanDefinition((RootBeanDefinition) proxyDef.getBeanDefinition(), configClass, metadata);&#125;if (logger.isDebugEnabled()) &#123;logger.debug(String.format("Registering bean definition for @Bean method %s.%s()",configClass.getMetadata().getClassName(), beanName));&#125;this.registry.registerBeanDefinition(beanName, beanDefToRegister);&#125; ä»£ç è§£æåˆ°è¿™é‡Œä¸ºæ­¢ï¼Œ@Beané…ç½®çš„Beanä¿¡æ¯å°±è¢«å…¨éƒ¨æŠ½è±¡æˆäº†ä¸€ä¸ª BeanDefinitionå¯¹è±¡ï¼Œæ¥ä¸‹æ¥çš„BeanåŠ è½½ç­‰ç­‰ä¸€å¤§å †é€»è¾‘èµ°çš„å°±æ˜¯Springçš„åŒä¸€å¥—é€»è¾‘äº†ã€‚ ä»¥ä¸Šæ˜¯é€šè¿‡åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½® &lt;context:annotation-config&gt; &lt;context:component-scan&gt;ã€‚ Springbootæ€ä¹ˆåšçš„é‚£ä¹ˆSpring Bootå¹¶ä¸éœ€è¦é…ç½®æ–‡ä»¶ï¼Œå®ƒåˆæ˜¯åœ¨å“ªé‡Œé…ç½®äº†å…¥å£å‘¢ï¼Ÿ å…¶å®åœ¨ä¹‹å‰çš„åˆ†æSpring bootçš„å¯åŠ¨è¿‡ç¨‹æ—¶ å·²ç»æœ‰æåˆ°äº† é“¾æ¥ ï¼Œå…¶å®æ˜¯åœ¨åˆå§‹åŒ– Springå®¹å™¨çš„æ„é€ æ–¹æ³•ä¸­è¿›è¡Œäº†é…ç½®çš„åŠ è½½ï¼Œå¹¶ä¸”æœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨äº† AnnotationConfigUtils å·¥å…·ç±»çš„ registerAnnotationConfigProcessorsæ–¹æ³• æ€»ç»“ç»ˆäºå†™å®Œäº†ï¼Œå…¶å®åˆ†ææ¥åˆ†æå»ï¼Œä¸è®ºæ˜¯Spring Boot Spring mvc å…¶å®æœ€æ ¸å¿ƒä¸å˜çš„è¿˜æ˜¯ Spring Frameworkï¼Œåªè¦æŠŠæ ¸å¿ƒææ¸…æ¥šäº†ï¼Œä¸‹æ¬¡Spring åˆæ¨å‡ºä»€ä¹ˆ Spring xxx ä¹Ÿèƒ½åº”ä»˜è‡ªå¦‚]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MVC-HttpRequestHandleræ¥å£é™æ€èµ„æºçš„å…³ç³»]]></title>
    <url>%2F2019%2F08%2F30%2FMVC-HttpRequestHandler%E6%8E%A5%E5%8F%A3%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E7%9A%84%E5%85%B3%E7%B3%BB%2F</url>
    <content type="text"><![CDATA[åœ¨Spring Mvcï¼Œä¸€èˆ¬æˆ‘ä»¬éƒ½ä¼šé…ç½®å¯¹é™æ€èµ„æºçš„æ‹¦æˆªï¼Œå› ä¸ºé™æ€èµ„æºå¤„ç†æœ‰åˆ«ä¸æ™®é€šè¯·æ±‚ï¼Œéœ€è¦è¿›è¡Œç‰¹æ®Šé…ç½®ã€‚ æ¯”è¾ƒå¸¸ç”¨çš„é…ç½®æœ‰è¿™å‡ ç§ Tomcat defaultServelt æ¿€æ´»tomcatè‡ªå¸¦çš„defaultServelt ç”¨æ¥å¤„ç†é™æ€èµ„æº 123456789101112&lt;servlet-mapping&gt; &lt;servlet-name&gt;default&lt;/servlet-name&gt; &lt;url-pattern&gt;*.jpg&lt;/url-pattern&gt;&lt;/servlet-mapping&gt;&lt;servlet-mapping&gt; &lt;servlet-name&gt;default&lt;/servlet-name&gt; &lt;url-pattern&gt;*.js&lt;/url-pattern&gt;&lt;/servlet-mapping&gt;&lt;servlet-mapping&gt; &lt;servlet-name&gt;default&lt;/servlet-name&gt; &lt;url-pattern&gt;*.css&lt;/url-pattern&gt;&lt;/servlet-mapping&gt; ä½¿ç”¨ &lt;mvc:resources/&gt; Spring mvcè‡ªå·±æä¾›çš„é™æ€èµ„æºå¤„ç†å™¨ ä¾‹å¦‚åšå¦‚ä¸‹é…ç½®ï¼Œå°±å¯ä»¥å°†staticå¼€å¤´çš„è·¯å¾„å…¨éƒ¨è®¿é—®è‡³staticç›®å½• 1&lt;mvc:resources mapping="/static/**" location="/static/" /&gt; é‚£ä¹ˆè¿™ä¸ªé…ç½®çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ é€šè¿‡é˜…è¯»æºç å…¶å®å¯ä»¥çŸ¥é“å®é™…ä¸Šæ˜¯ Spring mvc è‡ªåŠ¨å¸®æˆ‘ä»¬æ³¨å†Œäº†ä¸€ä¸ªSimpleUrlHandlerMappingï¼Œåœ¨ä¹‹å‰åˆ†æSimpleUrlHandlerMappingæ—¶ä¹Ÿæœ‰æåˆ°å®ƒå…¶å®å¯ä»¥å½“æˆæ‹¦æˆªå™¨ç”¨ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯ä¸€ä¸ªå®ä¾‹ã€‚æ³¨å†Œäº†HandlerMappingå¿…ç„¶è¦ç¡®å®šhandlerå¤„ç†å™¨ï¼Œè¿™é‡Œçš„handlerå¤„ç†å™¨å…¶å®å°±æ˜¯HttpRequestHandleræ¥å£çš„å®ç°ç±»ï¼ˆResourceHttpRequestHandlerï¼‰ ä½¿ç”¨ &lt;mvc:default-servlet-handler/&gt; æ¿€æ´»Spring mvcæä¾›çš„é»˜è®¤é™æ€èµ„æºå¤„ç†å™¨ ä½¿ç”¨è¿™ä¸ªé…ç½®å…¶å®åŸç†ä¸ç¬¬äºŒä¸ªé…ç½®éå¸¸ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯åˆ©ç”¨äº†SimpleUrlHandlerMappingï¼Œå¹¶ä¸”handlerå¤„ç†å™¨ä¹Ÿæ˜¯HttpRequestHandleræ¥å£çš„å®ç°ç±»ï¼Œåªæ˜¯æŠŠå…·ä½“çš„å®ç°ç±»æ¢æˆäº†DefaultServletHttpRequestHandlerï¼Œç›¸æ¯”ç¬¬äºŒç§é…ç½®ï¼Œæ­¤ç§é…ç½®æ— æ³•è‡ªå®šä¹‰ã€‚ å†™åœ¨åé¢ ä¸è¿‡æˆ‘ä»¬è¦æ˜¯ä½¿ç”¨Spring bootå¼€å‘ï¼Œä¹Ÿå°±çœå»äº†è¿™ä¸€å †ç¹ççš„é…ç½®ï¼ŒåŒ…æ‹¬é™æ€èµ„æºçš„é…ç½®ä¹Ÿéƒ½æ˜¯è‡ªåŠ¨å®Œæˆé…ç½®ã€‚åªè¦æŒ‰ç…§çº¦å®šå°†é™æ€èµ„æºæ”¾ç½®åœ¨classpathä¸‹çš„è¿™å‡ ä¸ªç›®å½•ä¸‹ï¼ˆpublic,resource,staticï¼‰ï¼Œå°±ä¸éœ€è¦ä»»ä½•é…ç½®ï¼Œä¸å¾—ä¸è¯´ï¼Œçº¦å®šä¼˜äºé…ç½®è¿˜æ˜¯å¯ä»¥æå¤§çš„æå‡å¼€å‘æ•ˆç‡çš„ã€‚]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ‰‹å†™ä¸€ä¸ªstarter]]></title>
    <url>%2F2019%2F08%2F28%2F%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AAstarter%2F</url>
    <content type="text"><![CDATA[å¼•è¨€å‰æ–‡è¯´è¿‡ï¼ŒSpring Bootæœ€å¤§çš„ä¼˜åŠ¿åœ¨äºè‡ªåŠ¨é…ç½®ï¼Œæˆ‘ä¹ˆåªéœ€è¦å¼•å…¥ä¸€ä¸ªä¸ªç¬¬ä¸‰æ–¹æä¾›çš„starterå°±å¯ä»¥å¿«é€Ÿé›†æˆç¬¬ä¸‰æ–¹åŠŸèƒ½ï¼Œæ—¢ç„¶starterè¿™ä¹ˆæ–¹ä¾¿ï¼Œæˆ‘ä»¬è‡ªå·±åº”è¯¥ä¹Ÿå¯ä»¥å†™ä¸€ä¸ªã€‚ å¿«é€Ÿå†™ä¸€ä¸ªstarter æ–°å»ºä¸€ä¸ªmavené¡¹ç›® 123456789101112&lt;groupId&gt;com.walm&lt;/groupId&gt; &lt;artifactId&gt;boot-test-starter&lt;/artifactId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-autoconfigure&lt;/artifactId&gt; &lt;version&gt;2.0.6.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; æ–°å»ºä¸€ä¸ªconfigç±» 12345678@Configurationpublic class HelloWorldConfig &#123; @Bean public HelloWorld HelloWord() &#123; return new HelloWorld(); &#125;&#125; æ–°å»ºä¸€ä¸ªæä¾›æœåŠ¡çš„serviceç±» 123456public class HelloWorld &#123; public void sayHello() &#123; System.out.println("hello world !!!!"); &#125;&#125; æœ€é‡è¦çš„æ˜¯ä¸€æ­¥ï¼Œéœ€è¦è®©springèƒ½å¤Ÿæ‰«æåˆ°æˆ‘ä»¬çš„ config HelloWorldConfig ç±» åœ¨resource æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ª META-INF æ–‡ä»¶å¤¹ æ–°å»ºä¸€ä¸ª spring.factories æ–‡ä»¶ åœ¨spring.factoriesæ–‡ä»¶ä¸­é…ç½®æˆ‘ä»¬çš„å†™çš„HelloWorldConfigç±» 1org.springframework.boot.autoconfigure.EnableAutoConfiguration=com.walm.boottest.HelloWorldConfig è¿™æ ·ä¸€ä¸ªç®€å•çš„ springboot starter å°±å®Œæˆäº†ï¼Œæœ€åæœ¬åœ°å®‰è£… installæˆ‘ä»¬çš„starter jaråŒ…å°±å¯ä»¥åœ¨å…¶ä»–é¡¹ç›®ä¸­å¼•ç”¨äº† å¼•ç”¨starterï¼Œåªéœ€è¦åœ¨é¡¹ç›®å¼•ç”¨ è¯¥jaråŒ…å³å¯ 12345&lt;dependency&gt; &lt;groupId&gt;com.walm&lt;/groupId&gt; &lt;artifactId&gt;boot-test-starter&lt;/artifactId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;/dependency&gt; ä¸‹é¢æˆ‘ä»¬ç®€å•åˆ†æä¸€ä¸‹ staterçš„åŸç† starter è‡ªåŠ¨é…ç½®åŸç†é¦–å…ˆè‡ªåŠ¨é…ç½®çš„åŸç†å…³é”®ä¸€å®šæ˜¯åœ¨ spring.factories æ–‡ä»¶æ˜¯å¦‚ä½•è¢«åŠ è½½åˆ°çš„è¿™ä¸ªç‚¹ä¸Šå»æ¢ç©¶ éœ€è¦ä»spring bootçš„å¯åŠ¨è¿‡ç¨‹ä¸€æ­¥ä¸€æ­¥çš„å»çœ‹äº† é¦–å…ˆï¼Œæˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªspring-booté¡¹ç›®ï¼Œè‚¯å®šä¼šæœ‰ä¸€ä¸ªé…ç½®æ³¨è§£ SpringBootApplication é‚£ä¹ˆè¿™ä¸ªæ³¨è§£åˆ°åº•èµ·ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ SpringBootApplication.class 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Documented@Inherited@SpringBootConfiguration@EnableAutoConfiguration@ComponentScan(excludeFilters = &#123; @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class), @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)public @interface SpringBootApplication &#123; /** * Exclude specific auto-configuration classes such that they will never be applied. * @return the classes to exclude */ @AliasFor(annotation = EnableAutoConfiguration.class) Class&lt;?&gt;[] exclude() default &#123;&#125;; /** * Exclude specific auto-configuration class names such that they will never be * applied. * @return the class names to exclude * @since 1.3.0 */ @AliasFor(annotation = EnableAutoConfiguration.class) String[] excludeName() default &#123;&#125;; /** * Base packages to scan for annotated components. Use &#123;@link #scanBasePackageClasses&#125; * for a type-safe alternative to String-based package names. * @return base packages to scan * @since 1.3.0 */ @AliasFor(annotation = ComponentScan.class, attribute = "basePackages") String[] scanBasePackages() default &#123;&#125;; /** * Type-safe alternative to &#123;@link #scanBasePackages&#125; for specifying the packages to * scan for annotated components. The package of each class specified will be scanned. * &lt;p&gt; * Consider creating a special no-op marker class or interface in each package that * serves no purpose other than being referenced by this attribute. * @return base packages to scan * @since 1.3.0 */ @AliasFor(annotation = ComponentScan.class, attribute = "basePackageClasses") Class&lt;?&gt;[] scanBasePackageClasses() default &#123;&#125;;&#125; è¿™é‡Œç€é‡çœ‹ EnableAutoConfiguration è¿™ä¸ªæ³¨è§£ 12345678910111213141516171819202122232425@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Documented@Inherited@AutoConfigurationPackage@Import(AutoConfigurationImportSelector.class)public @interface EnableAutoConfiguration &#123; String ENABLED_OVERRIDE_PROPERTY = "spring.boot.enableautoconfiguration"; /** * Exclude specific auto-configuration classes such that they will never be applied. * @return the classes to exclude */ Class&lt;?&gt;[] exclude() default &#123;&#125;; /** * Exclude specific auto-configuration class names such that they will never be * applied. * @return the class names to exclude * @since 1.3.0 */ String[] excludeName() default &#123;&#125;;&#125; å¯ä»¥çœ‹åˆ° @Import(AutoConfigurationImportSelector.class)è¿™ä¸ªæ³¨è§£ï¼Œè¿™é‡Œå°±æ˜¯æˆ‘ä»¬è‡ªåŠ¨é…ç½®çš„å…¥å£æ³¨æ„ï¼Œè§£æImportæ³¨è§£å…¶å®æ˜¯é€šè¿‡ BeanFactoryPostProcessor æ¥å£æ¥æ‰©å±•çš„ ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹AutoConfigurationImportSelector.class ç±»çš„å®ç°ï¼ŒAutoConfigurationImportSelector å®ç°äº†ImportSelectoræ¥å£ ImportSelector 123456789public interface ImportSelector &#123; /** * Select and return the names of which class(es) should be imported based on * the &#123;@link AnnotationMetadata&#125; of the importing @&#123;@link Configuration&#125; class. */ String[] selectImports(AnnotationMetadata importingClassMetadata);&#125; åœ¨è§£æimportæ³¨è§£çš„æ—¶å€™ä¼šè°ƒç”¨æŒ‡å®šImportSelector æ¥å£å®ç° çš„ selectImportsæ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹AutoConfigurationImportSelectorçš„ selectImportsæ–¹æ³•å®ç° selectImports 12345678910111213141516171819public String[] selectImports(AnnotationMetadata annotationMetadata) &#123; if (!isEnabled(annotationMetadata)) &#123; return NO_IMPORTS; &#125; AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader .loadMetadata(this.beanClassLoader); AnnotationAttributes attributes = getAttributes(annotationMetadata); // è·å– META-INF/spring.factories æ–‡ä»¶ä¸­çš„é…ç½®ä¿¡æ¯ List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes); configurations = removeDuplicates(configurations); Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes); checkExcludedClasses(configurations, exclusions); configurations.removeAll(exclusions); configurations = filter(configurations, autoConfigurationMetadata); // è§¦å‘äº‹ä»¶ fireAutoConfigurationImportEvents(configurations, exclusions); return StringUtils.toStringArray(configurations); &#125; æ€»ç»“å†™ä¸€ä¸ªstarterè¿˜æ˜¯éå¸¸ç®€å•çš„ï¼Œæ ¸å¿ƒå°±æ˜¯è¦è®©springbootè‡ªåŠ¨æ‰«æåˆ°æˆ‘ä»¬çš„ é…ç½®ç±»ï¼Œæ ¸å¿ƒé€»è¾‘å…¶å®å°±æ˜¯é€šè¿‡æ‰«ææˆ‘ä»¬çš„è‡ªå®šä¹‰çš„META-INF/spring.factoriesæ–‡ä»¶æ¥è¿›è¡Œè‡ªåŠ¨é…ç½®]]></content>
      <categories>
        <category>Spring</category>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SpringBootçš„å¯åŠ¨è¿‡ç¨‹]]></title>
    <url>%2F2019%2F08%2F27%2FSpringBoot%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%2F</url>
    <content type="text"><![CDATA[å¼•è¨€åœ¨æˆ‘ä¹‹å‰å†™çš„æ–‡ç« ä¸­æœ‰è¯¦ç»†åˆ†æè¿‡Springçš„å¯åŠ¨è¿‡ç¨‹ï¼Œå¦‚ä½•å¤§å®¶æœ‰æ·±å…¥é˜…è¯»è¿‡Spring Frameworkçš„æ ¸å¿ƒæºç ï¼Œé‚£ä¹ˆé˜…è¯»Spring Bootçš„æºç ä¼šæ¯”è¾ƒè½»æ¾ã€‚ä¸ªäººè§‰å¾—Spring Bootæ ¸å¿ƒçš„ä¸œè¥¿æ¯”è¾ƒå°‘ï¼Œå…¶æ ¸å¿ƒè¿˜æ˜¯Spring Frameworkã€‚ å¯åŠ¨å…¥å£è¿˜æ˜¯ä¸€æ­¥åˆ°ä½ï¼Œç›´æ¥çœ‹æºç  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051public ConfigurableApplicationContext run(String... args) &#123; // ç»Ÿè®¡å¯åŠ¨æ—¶é—´ StopWatch stopWatch = new StopWatch(); stopWatch.start(); ConfigurableApplicationContext context = null; Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = new ArrayList&lt;&gt;(); // è®¾ç½® java.awt.headless å‚æ•° configureHeadlessProperty(); // è·å–ç›‘å¬å™¨ SpringApplicationRunListeners listeners = getRunListeners(args); listeners.starting(); try &#123; ApplicationArguments applicationArguments = new DefaultApplicationArguments( args); ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments); configureIgnoreBeanInfo(environment); Banner printedBanner = printBanner(environment); // åˆ›å»º contextå®¹å™¨ context = createApplicationContext(); exceptionReporters = getSpringFactoriesInstances( SpringBootExceptionReporter.class, new Class[] &#123; ConfigurableApplicationContext.class &#125;, context); // å‡†å¤‡å®¹å™¨ prepareContext(context, environment, listeners, applicationArguments, printedBanner); // åˆ·æ–°å®¹å™¨ refreshContext(context); afterRefresh(context, applicationArguments); stopWatch.stop(); if (this.logStartupInfo) &#123; new StartupInfoLogger(this.mainApplicationClass) .logStarted(getApplicationLog(), stopWatch); &#125; listeners.started(context); callRunners(context, applicationArguments); &#125; catch (Throwable ex) &#123; handleRunFailure(context, ex, exceptionReporters, listeners); throw new IllegalStateException(ex); &#125; try &#123; listeners.running(context); &#125; catch (Throwable ex) &#123; handleRunFailure(context, ex, exceptionReporters, null); throw new IllegalStateException(ex); &#125; return context; &#125; createApplicationContext12345678910111213141516171819202122232425protected ConfigurableApplicationContext createApplicationContext() &#123; Class&lt;?&gt; contextClass = this.applicationContextClass; if (contextClass == null) &#123; try &#123; switch (this.webApplicationType) &#123; case SERVLET: contextClass = Class.forName(DEFAULT_SERVLET_WEB_CONTEXT_CLASS); break; case REACTIVE: contextClass = Class.forName(DEFAULT_REACTIVE_WEB_CONTEXT_CLASS); break; default: contextClass = Class.forName(DEFAULT_CONTEXT_CLASS); &#125; &#125; catch (ClassNotFoundException ex) &#123; throw new IllegalStateException( "Unable create a default ApplicationContext, " + "please specify an ApplicationContextClass", ex); &#125; &#125; // è¿™é‡Œä¼šå¼•å…¥ä¸€äº›BeanFactoryProcessï¼Œæ¯”å¦‚ ConfigurationClassPostProcessor è§£æConfigurationæ³¨è§£çš„ return (ConfigurableApplicationContext) BeanUtils.instantiateClass(contextClass); &#125; æ³¨: å¼•å…¥çš„BeanFactoryProcess çš„é€»è¾‘åœ¨DEFAULT_SERVLET_WEB_CONTEXT_CLASSçš„æ„é€ æ–¹æ³•ä¸­ 1234567// çœ‹ä¸‹ AnnotationConfigServletWebServerApplicationContext çš„æ„é€ æ–¹æ³•public AnnotationConfigServletWebServerApplicationContext() &#123; // ç›¸å½“äºxmlä¸­é…ç½®äº† &lt;context:annotation-config&gt; this.reader = new AnnotatedBeanDefinitionReader(this); // ç›¸å½“äºxmlä¸­é…ç½®äº† &lt;context:component-scan&gt; this.scanner = new ClassPathBeanDefinitionScanner(this); &#125; æˆ‘ä»¬åœ¨çœ‹ä¸‹ AnnotatedBeanDefinitionReader çš„æ„é€ æ–¹æ³• 123456789101112131415161718192021public AnnotatedBeanDefinitionReader(BeanDefinitionRegistry registry) &#123; this(registry, getOrCreateEnvironment(registry)); &#125; /** * Create a new &#123;@code AnnotatedBeanDefinitionReader&#125; for the given registry and using * the given &#123;@link Environment&#125;. * @param registry the &#123;@code BeanFactory&#125; to load bean definitions into, * in the form of a &#123;@code BeanDefinitionRegistry&#125; * @param environment the &#123;@code Environment&#125; to use when evaluating bean definition * profiles. * @since 3.1 */ public AnnotatedBeanDefinitionReader(BeanDefinitionRegistry registry, Environment environment) &#123; Assert.notNull(registry, "BeanDefinitionRegistry must not be null"); Assert.notNull(environment, "Environment must not be null"); this.registry = registry; this.conditionEvaluator = new ConditionEvaluator(registry, environment, null); // åœ¨è¿™é‡Œ æ³¨å†Œäº†ä¸€å †çš„ BeanFactoryProcess AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry); &#125; ä¸‹é¢ä¸»è¦prepareContextå’ŒrefreshContextæ–¹æ³• prepareContext 1234567891011121314151617181920212223242526private void prepareContext(ConfigurableApplicationContext context, ConfigurableEnvironment environment, SpringApplicationRunListeners listeners, ApplicationArguments applicationArguments, Banner printedBanner) &#123; context.setEnvironment(environment); postProcessApplicationContext(context); applyInitializers(context); listeners.contextPrepared(context); if (this.logStartupInfo) &#123; logStartupInfo(context.getParent() == null); logStartupProfileInfo(context); &#125; // Add boot specific singleton beans context.getBeanFactory().registerSingleton("springApplicationArguments", applicationArguments); if (printedBanner != null) &#123; context.getBeanFactory().registerSingleton("springBootBanner", printedBanner); &#125; // Load the sources Set&lt;Object&gt; sources = getAllSources(); Assert.notEmpty(sources, "Sources must not be empty"); // è¿™é‡Œå¼•å…¥äº† å¯åŠ¨ç±» load(context, sources.toArray(new Object[0])); listeners.contextLoaded(context); &#125; æ³¨ï¼š è¿™é‡Œçš„ä¸»è¦ä½œç”¨å°±æ˜¯å¼•å…¥äº†å¯åŠ¨ç±»ï¼ŒåŠ å…¥åˆ° BeanFactoryä¸­ refreshContext åé¢å…¶å® å°±æ˜¯ Spring ç»Ÿä¸€çš„ä¸€å¥—äº† å¯ä»¥çœ‹æˆ‘çš„ä¹‹å‰å†™çš„ Spring æºç è§£æç³»åˆ— æ€»ç»“Springbootçš„æ ¸å¿ƒåœ¨äºè‡ªåŠ¨é…ç½® å¿«é€Ÿé›†æˆ ã€‚ä¸€äº›åŸæœ¬éœ€è¦åœ¨Spring xmlæ–‡ä»¶é…ç½®çš„ä¸œè¥¿ï¼ŒSpring åªéœ€è¦ä¸€ä¸ªæ³¨è§£å°±å¸®æˆ‘ä»¬éƒ½åšäº†ã€‚ä¸è¿‡å‰æ–‡ä¹Ÿéƒ½è¯´äº†ï¼Œæ ¸å¿ƒè¿˜æ˜¯ Spring Frameworkã€‚]]></content>
      <categories>
        <category>Spring</category>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MVCæºç è§£æ-HandlerAdapter]]></title>
    <url>%2F2019%2F08%2F25%2FMVC%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-HandlerAdapter%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ä¸Šç¯‡æ–‡ç« åˆ†æäº†handerMappingçš„å®ç°ã€‚æœ¬ç¯‡æ–‡ç« ä¼šç»§ç»­åˆ†æå’ŒhanderMappingç›¸è¾…ç›¸æˆçš„handerAdapterã€‚ ä»€ä¹ˆæ˜¯handerAdapterï¼Ÿåœ¨ç†è§£äº†handerMappingçš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬åº”è¯¥å‘ç°äº†ä¸€ä¸ªé—®é¢˜ã€‚å°±æ˜¯æ¯ä¸ªhanderMappingæ‰€åŒ¹é…çš„åˆ°çš„handerå®ç°æ˜¯ä¸ä¸€æ ·çš„ã€‚æ¯”å¦‚RequestMappingHandlerMappingçš„handerçš„å®ç°æ˜¯ä¸€ä¸ªHandlerMethodå®ç°ï¼Œè€ŒBeanNameUrlHandlerMappingçš„handeråˆ™æ˜¯ä¸€ä¸ªControlleræ¥å£å®ç°ç±»ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬è¦æ˜¯ä¸å¼•å…¥handerAdapterçš„è¯ï¼Œå°±æ— æ³•ç»Ÿä¸€çš„å»æ‰§è¡Œå„è‡ªçš„hander ä¸Šæ–‡æ‰€è¯´handerAdapterå’ŒhanderMappingæ˜¯ç›¸è¾…ç›¸æˆçš„ã€‚ä»¥ä¸‹åˆ—å‡ºäº†å‡ ä¸ªçš„å¯¹åº”å…³ç³» RequestMappingHandlerMapping -&gt; RequestMappingHandlerAdapter BeanNameUrlHandlerMapping -&gt; SimpleControllerHandlerAdapter SimpleUrlHandlerMapping -&gt; SimpleControllerHandlerAdapter SimpleUrlHandlerMapping -&gt; HttpRequestHandlerAdapter å…¶ä¸­SimpleUrlHandlerMappingæ¯”è¾ƒç‰¹æ®Šï¼Œå¯ä»¥å¯¹åº”å¤šä¸ªAdapterï¼Œä¸»è¦åŸå› æ˜¯SimpleUrlHandlerMappingä¸­çš„handlerç±»å‹ä¹Ÿå¯ä»¥æœ‰å¤šç§ï¼Œæ¯”è¾ƒå¸¸è§çš„æœ‰Controlleræ¥å£å®ç°ç±»ï¼ŒHttpRequestHandleræ¥å£å®ç°ç±»ã€‚ HandlerAdapteræ¥å£å…ˆçœ‹ä¸‹HandlerAdapteræ¥å£çš„å‡ ä¸ªæ–¹æ³• 123456789101112131415161718192021222324252627282930public interface HandlerAdapter &#123; /*** * åˆ¤æ–­æŒ‡å®šhanderæ˜¯å¦å¯ä»¥è¢«å½“å‰Adapteræ”¯æŒ * * @param handler handler object to check * @return whether or not this object can use the given handler */ boolean supports(Object handler); /** * æ‰§è¡Œhanderæ–¹æ³• * returned &#123;@code true&#125;. * @throws Exception in case of errors * @return ModelAndView object with the name of the view and the required * model data, or &#123;@code null&#125; if the request has been handled directly */ @Nullable ModelAndView handle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception; /** * ä¸HttpServletçš„&#123;@code getLastModified&#125;æ–¹æ³•çš„çº¦å®šç›¸åŒ * @param request current HTTP request * @param handler handler to use * @return the lastModified value for the given handler * @see javax.servlet.http.HttpServlet#getLastModified * @see org.springframework.web.servlet.mvc.LastModified#getLastModified */ long getLastModified(HttpServletRequest request, Object handler);&#125; æ ¸å¿ƒæ˜¯supportså’Œhanderæ–¹æ³• supportsç”¨äºåˆ¤æ–­æŒ‡å®šhanderæ˜¯å¦å¯ä»¥è¢«å½“å‰Adapteræ”¯æŒ handeræ–¹æ³•ç”¨äºæ‰§è¡ŒæŒ‡å®šçš„handerçš„æ ¸å¿ƒé€»è¾‘ ä¸‹é¢ç®€å•æ¥çœ‹ä¸‹å„ä¸ªHandlerAdapteræ¥å£çš„å®ç°ç±»ï¼Œçœ‹ä¸€ä¸‹å¯¹è¿™ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•çš„å®ç° RequestMappingHandlerAdapter supports 123public final boolean supports(Object handler) &#123; return (handler instanceof HandlerMethod &amp;&amp; supportsInternal((HandlerMethod) handler));&#125; æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œåˆ¤æ–­handlerçš„ç±»å‹æ˜¯ä¸æ˜¯HandlerMethodï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™è¯´æ˜è¯¥handlerå¯ä»¥è¢«è¯¥adapteræ‰€é€‚é…ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥è¿”å›è¯¥Adapterã€‚ hander 123456789101112131415161718192021222324252627282930313233343536373839protected ModelAndView handleInternal(HttpServletRequest request, HttpServletResponse response, HandlerMethod handlerMethod) throws Exception &#123; // å®šä¹‰ ModelAndView ModelAndView mav; checkRequest(request); // å¤„äºä¸€ä¸ªsessionæ—¶åˆ¤æ–­æ˜¯å¦éœ€è¦åŒæ­¥ if (this.synchronizeOnSession) &#123; // è·å–å½“å‰session HttpSession session = request.getSession(false); if (session != null) &#123; Object mutex = WebUtils.getSessionMutex(session); synchronized (mutex) &#123; // æ‰§è¡Œ handerMethod å®é™…é€»è¾‘ mav = invokeHandlerMethod(request, response, handlerMethod); &#125; &#125; else &#123; // No HttpSession available -&gt; no mutex necessary mav = invokeHandlerMethod(request, response, handlerMethod); &#125; &#125; else &#123; // mav = invokeHandlerMethod(request, response, handlerMethod); &#125; if (!response.containsHeader(HEADER_CACHE_CONTROL)) &#123; if (getSessionAttributesHandler(handlerMethod).hasSessionAttributes()) &#123; applyCacheSeconds(response, this.cacheSecondsForSessionAttributeHandlers); &#125; else &#123; prepareResponse(response); &#125; &#125; return mav;&#125; SimpleControllerHandlerAdapter supports 123public boolean supports(Object handler) &#123; return (handler instanceof Controller);&#125; åˆ¤æ–­æ˜¯å¦æ˜¯handlerçš„ç±»å‹æ˜¯å¦æ˜¯Controller handler 12345public ModelAndView handle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123; return ((Controller) handler).handleRequest(request, response);&#125; æ˜¯çš„è¯ï¼Œåˆ™ç›´æ¥æ‰§è¡ŒControllerçš„handleRequestæ–¹æ³• HttpRequestHandlerAdapter supports 123public boolean supports(Object handler) &#123; return (handler instanceof HttpRequestHandler);&#125; handler 123456public ModelAndView handle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123; ((HttpRequestHandler) handler).handleRequest(request, response); return null;&#125; å®ç°é€»è¾‘ä¸SimpleControllerHandlerAdapterç±»ä¼¼ å¯¹äºä»¥ä¸Šå‡ ä¸ªAdapterçš„åŒ¹é…é¡ºåºï¼ŒSpringä¼šæ ¹æ®å„ä¸ªAdapterçš„Orderå€¼æ¥è¿›è¡Œæ’åºï¼Œä¾æ¬¡åŒ¹é…ç›´åˆ°æ‰¾åˆ°åˆé€‚çš„ä¸ºæ­¢ã€‚ æ€»ç»“HandlerAdapterçš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯æ‰¿æ¥ä¸åŒçš„HandlerMappingåšé€‚é…ã€‚æœ¬èº«çš„é€»è¾‘å¹¶ä¸å¤æ‚ï¼Œå…¶å¼•å…¥çš„é€‚é…ä¸­é—´å±‚è®¾è®¡æ¨¡å¼æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ¡ˆä¾‹ã€‚]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MVCæºç è§£æ-HandlerMapping]]></title>
    <url>%2F2019%2F08%2F20%2FMVC%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-HandlerMapping%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ä»€ä¹ˆæ˜¯Spring mvc çš„ HanderMapping? **æˆ‘ä»¬çŸ¥é“å½“ä¸€ä¸ªhttpè¯·æ±‚åˆ°æœåŠ¡å™¨æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®è¯·æ±‚çš„ä¸Šä¸‹æ–‡urlæ¥åŒ¹é…åˆ°å¯¹åº”çš„å¤„ç†ç±»ï¼Œè€ŒHanderMappingåšçš„å°±æ˜¯è¿™ä¸ªäº‹æƒ…ï¼Œå®ƒå®šä¹‰äº†æˆ‘ä»¬çš„è¯·æ±‚å’Œå¯¹åº”çš„å¤„ç†ç±»çš„æ˜ å°„å…³ç³»ã€‚ Spring mvcæä¾›äº†å¤šç§HanderMappingç±»å‹ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„æœ‰ RequestMappingHandlerMapping,BeanNameUrlHandlerMapping,SimpleUrlHandlerMapping ä»¥ä¸‹æ˜¯è¿™ä¸‰ä¸ªHanderMappingçš„ç»§æ‰¿ç»“æ„ï¼š å…ˆæ¥çœ‹ä¸€ä¸‹è¿™å‡ ä¸ªHandlerMappingçš„é…ç½®å…¥å£ï¼Œå¦‚æœæ˜¯æ™®é€šSpring Mvcåº”ç”¨çš„è¯ï¼Œå½“æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†annotation-drivenåï¼Œä¾¿ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æ³¨å…¥è¿™å‡ ä¸ªç±»ã€‚å…·ä½“çš„æºç å…¥å£åœ¨AnnotationDrivenBeanDefinitionParserä¸­ï¼Œè¿™é‡Œçš„é€»è¾‘éå¸¸ç®€å•ï¼Œå°±æ˜¯å¸®æˆ‘ä»¬è‡ªåŠ¨æ³¨å…¥è¿™å‡ ä¸ªå¸¸ç”¨ç±»çš„BeanDefinitionå…ƒæ•°æ®ï¼ˆåŒ…æ‹¬HandlerMappingï¼ŒhandlerAdapterï¼ŒExceptionResolverç­‰ç­‰ï¼‰ ä¸‹é¢é€šè¿‡é˜…è¯»æºç ä¾æ¬¡åˆ†åˆ«çœ‹ä¸€ä¸‹è¿™å‡ ä¸ªHanderMappingçš„ä½œç”¨åŠå®ç°åŸç† RequestMappingHandlerMappingæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ RequestMappingHandlerMapping çš„ç”¨æ³• 123456789101112@Controllerpublic class TestAPI &#123; @RequestMapping(value = &quot;/api/sayHello&quot;) public String hello() &#123; return &quot;OK&quot;; &#125; @RequestMapping(value = &quot;/api/sayHello2&quot;) public String hello2() &#123; return &quot;OK&quot;; &#125;&#125; å¦‚ä¸Šé¢çš„ä»£ç ï¼Œè¿™æ˜¯ä¸€ä¸ªæˆ‘ä»¬éå¸¸å¸¸ç”¨çš„ç”¨æ³•ï¼Œä¸€ä¸ªControllerå®šä¹‰å¤šä¸ªå¤„ç†æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨æ–¹æ³•ä¸Šæ³¨è§£RequestMappingï¼Œå¦‚æ­¤åšä¹‹åå°±å¯ä»¥å®ç°ä¸€ä¸ªControlleræ ¹æ®ä¸åŒçš„è·¯å¾„åˆ†åˆ«å¯ä»¥å¤„ç†å¤šä¸ªè¯·æ±‚ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹å…¶å®ç°åŸç†ã€‚æˆ‘æ¯”è¾ƒå¥½å¥‡çš„æ˜¯ï¼ŒRequestMappingHandlerMappingæ˜¯å¦‚ä½•å°†è¯·æ±‚è·¯å¾„ä¸å¤„ç†æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–æ˜ å°„çš„ï¼Ÿ é€šè¿‡è§‚å¯ŸRequestMappingHandlerMappingçš„ç»§æ‰¿ä½“ç³»ï¼Œå¯ä»¥çŸ¥é“å…¶å®ç°äº†InitializingBeanæ¥å£ 1234567891011121314151617181920212223242526272829303132333435363738@Overridepublic void afterPropertiesSet() &#123; initHandlerMethods();&#125;/** * åˆå§‹åŒ– HandlerMethods */protected void initHandlerMethods() &#123; if (logger.isDebugEnabled()) &#123; logger.debug("Looking for request mappings in application context: " + getApplicationContext()); &#125; // è·å–å®¹å™¨ä¸­æ‰€æœ‰çš„Bean String[] beanNames = (this.detectHandlerMethodsInAncestorContexts ? BeanFactoryUtils.beanNamesForTypeIncludingAncestors(obtainApplicationContext(), Object.class) : obtainApplicationContext().getBeanNamesForType(Object.class)); for (String beanName : beanNames) &#123; if (!beanName.startsWith(SCOPED_TARGET_NAME_PREFIX)) &#123; Class&lt;?&gt; beanType = null; try &#123; beanType = obtainApplicationContext().getType(beanName); &#125; catch (Throwable ex) &#123; // An unresolvable bean type, probably from a lazy bean - let's ignore it. if (logger.isDebugEnabled()) &#123; logger.debug("Could not resolve target class for bean with name '" + beanName + "'", ex); &#125; &#125; // åˆ¤æ–­è¯¥Beanæ˜¯å¦è¢« @Controller æˆ–åˆ™ @RequestMapping æ‰€æ³¨è§£ if (beanType != null &amp;&amp; isHandler(beanType)) &#123; // åˆå§‹åŒ– HandlerMethods detectHandlerMethods(beanName); &#125; &#125; &#125; handlerMethodsInitialized(getHandlerMethods());&#125; ä¸Šé¢çš„ä»£ç ä¸»è¦åšäº†3ä»¶äº‹æƒ… è·å–å®¹å™¨ä¸­æ‰€æœ‰çš„Bean ç­›é€‰å‡ºè¢«@Controller æˆ–åˆ™ @RequestMapping æ‰€æ³¨è§£çš„Bean æ ¹æ®ç­›é€‰å‡ºçš„Beanåˆå§‹åŒ–HandlerMethod å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ç±»å«åšHandlerMethodï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªç±»çš„ç»“æ„ 12345678910111213141516171819202122232425/** ç›®æ ‡Bean **/private final Object bean;@Nullableprivate final BeanFactory beanFactory;private final Class&lt;?&gt; beanType; /** å¯¹åº”çš„ç›®æ ‡æ–¹æ³• **/private final Method method;private final Method bridgedMethod;/** æ–¹æ³•å‚æ•°ç±»å‹ **/private final MethodParameter[] parameters;@Nullableprivate HttpStatus responseStatus;@Nullableprivate String responseStatusReason;@Nullableprivate HandlerMethod resolvedFromHandlerMethod;... è¿˜æä¾›äº†å¾ˆå¤šæ–¹æ³•ï¼Œåƒè·å–æ–¹æ³•è¿”å›å€¼ç­‰ç­‰ å¯¹äºè¿™ä¸ªç±»æˆ‘ä»¬ç°åœ¨å¯ä»¥ä¸ç”¨æ·±å…¥å»ç†è§£ï¼Œåªéœ€çŸ¥é“å®ƒå°è£…äº†å¤„ç†ç±»çš„ç›®æ ‡æ–¹æ³• 123456789101112131415161718192021222324252627protected void detectHandlerMethods(Object handler) &#123; Class&lt;?&gt; handlerType = (handler instanceof String ? obtainApplicationContext().getType((String) handler) : handler.getClass()); if (handlerType != null) &#123; Class&lt;?&gt; userType = ClassUtils.getUserClass(handlerType); // è·å–ç›®æ ‡Beanä¸­è¢«RequestMappingæ³¨è§£çš„æ–¹æ³• Map&lt;Method, T&gt; methods = MethodIntrospector.selectMethods(userType, (MethodIntrospector.MetadataLookup&lt;T&gt;) method -&gt; &#123; try &#123; return getMappingForMethod(method, userType); &#125; catch (Throwable ex) &#123; throw new IllegalStateException("Invalid mapping on handler class [" + userType.getName() + "]: " + method, ex); &#125; &#125;); if (logger.isDebugEnabled()) &#123; logger.debug(methods.size() + " request handler methods found on " + userType + ": " + methods); &#125; // æ³¨å†Œ HandlerMethod methods.forEach((method, mapping) -&gt; &#123; Method invocableMethod = AopUtils.selectInvocableMethod(method, userType); registerHandlerMethod(handler, invocableMethod, mapping); &#125;); &#125;&#125; ä¸Šé¢çš„ä»£ç ä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ… è·å–ç›®å‰Beanä¸­è¢«RequestMappingæ³¨è§£çš„æ–¹æ³• æŠŠè·å–åˆ°çš„Method å°è£…æˆHandlerMethodå¹¶å®Œæˆæ³¨å†Œ åˆ°è¿™é‡Œä¸ºæ­¢RequestMappingHandlerMappingå°±å®Œæˆåˆå§‹åŒ–äº†ï¼Œä¸‹é¢å†æ¥çœ‹ä¸‹å½“ä¸€ä¸ªè¯·æ±‚æ¥æ—¶å…¶å®å¦‚ä½•å¤„ç†çš„ï¼Œå¹¶é€‰æ‹©æ­£ç¡®çš„ HandlerMethod å¤„ç†çš„. å½“ä¸€ä¸ªè¯·æ±‚è¿›æ¥æ—¶ï¼ŒDispatcherServletä¼šåˆ†åˆ«è°ƒç”¨æ¯ä¸ªHandlerMappingçš„getHandlerçš„æ–¹æ³•ï¼Œç›´åˆ°æœ‰ä¸ªHandlerMappingè¿”å›äº†ä¸€ä¸ªhander getHandleræ–¹æ³•åœ¨æŠ½è±¡çˆ¶ç±»AbstractHandlerMapping.classä¸­ 1234567891011121314151617181920212223public final HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception &#123; // å…·ä½“è°ƒç”¨é€»è¾‘ï¼Œç”±å­ç±»å®ç° Object handler = getHandlerInternal(request); if (handler == null) &#123; handler = getDefaultHandler(); &#125; if (handler == null) &#123; return null; &#125; if (handler instanceof String) &#123; String handlerName = (String) handler; handler = obtainApplicationContext().getBean(handlerName); &#125; HandlerExecutionChain executionChain = getHandlerExecutionChain(handler, request); if (CorsUtils.isCorsRequest(request)) &#123; CorsConfiguration globalConfig = this.globalCorsConfigSource.getCorsConfiguration(request); CorsConfiguration handlerConfig = getCorsConfiguration(handler, request); CorsConfiguration config = (globalConfig != null ? globalConfig.combine(handlerConfig) : handlerConfig); executionChain = getCorsHandlerExecutionChain(request, executionChain, config); &#125; return executionChain;&#125; çœ‹RequestMappingHandlerMappingçš„getHandlerInternalæ–¹æ³• 1234567891011121314151617181920212223242526protected HandlerMethod getHandlerInternal(HttpServletRequest request) throws Exception &#123; // æ ¹æ® requestè·å–åˆ° path // å¦‚è¯·æ±‚æ˜¯ localhost:8080/api/sayHello // åˆ™è¿™é‡Œè¿”å› /api/sayHello String lookupPath = getUrlPathHelper().getLookupPathForRequest(request); if (logger.isDebugEnabled()) &#123; logger.debug("Looking up handler method for path " + lookupPath); &#125; this.mappingRegistry.acquireReadLock(); try &#123; // è·å–åˆ°è¯·æ±‚å¯¹åº”çš„ handlerMethod HandlerMethod handlerMethod = lookupHandlerMethod(lookupPath, request); if (logger.isDebugEnabled()) &#123; if (handlerMethod != null) &#123; logger.debug("Returning handler method [" + handlerMethod + "]"); &#125; else &#123; logger.debug("Did not find handler method for [" + lookupPath + "]"); &#125; &#125; return (handlerMethod != null ? handlerMethod.createWithResolvedBean() : null); &#125; finally &#123; this.mappingRegistry.releaseReadLock(); &#125;&#125; ä»¥ä¸Šå°±æ˜¯RequestMappingHandlerMappingåœ¨æ•´ä¸ªMVCæµç¨‹ä¸­æ‰€èµ·çš„ä½œç”¨ BeanNameUrlHandlerMappingä¸‹é¢æˆ‘ä»¬å†ç®€å•çœ‹ä¸‹BeanNameUrlHandlerMappingçš„ä½¿ç”¨å’ŒåŸç†é¡¾åæ€ä¹‰ï¼ŒBeanNameUrlHandlerMappingå°±æ˜¯æŒ‡é€šè¿‡BeanNameå’ŒUrlè¿›è¡Œå…³è”åŒ¹é…ï¼Œè·ŸRequestMappingHandlerMappingä¸ä¸€æ ·ï¼ŒBeanNameUrlHandlerMappingä¸€ä¸ªBeanå°±å¯¹åº”å¤„ç†ä¸€ä¸ªè¯·æ±‚.å…ˆæ¥çœ‹ä¸ªä½¿ç”¨çš„ä¾‹å­ 123456789@Component(&quot;/test2API&quot;)public class Test2API implements Controller &#123; @Override public ModelAndView handleRequest(HttpServletRequest request, HttpServletResponse response) throws Exception &#123; System.out.println(&quot;test2API&quot;); return null; &#125;&#125; å¦‚æ­¤å®šä¹‰ä¸€ä¸ªç±»ï¼Œæˆ‘ä»¬ä¾¿èƒ½é€šè¿‡/test2APIè¿™ä¸ªè·¯å¾„æ¥è®¿é—®è¿™ä¸ªç±»ã€‚å¦‚ä½•å®ç°çš„ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯æ‰“å¼€BeanNameUrlHandlerMappingçœ‹çœ‹å…¶å®ç°ï¼Œä¸RequestMappingHandlerMappingä¸åŒçš„æ˜¯ï¼Œå®ƒæ²¡æœ‰å®ç°InitializingBeanæ¥å£ï¼Œä¸è¿‡å®ƒå®ç°äº†ApplicationContextAwareæ¥å£ï¼Œåœ¨Springå®¹å™¨å®Œæˆåˆå§‹åŒ–çš„æ—¶å€™å›è°ƒç”¨è¿™ä¸ªå”¤é†’æ¥å£ï¼Œä¹Ÿå°±æ˜¯åœ¨è¿™é‡Œè¿›è¡Œäº†BeanNameUrlHandlerMappingçš„åˆå§‹åŒ–ã€‚ åˆå§‹åŒ–é€»è¾‘åœ¨ AbstractDetectingUrlHandlerMapping.detectHandlers() æ–¹æ³•ä¸­ 12345678910111213141516171819202122232425protected void detectHandlers() throws BeansException &#123; ApplicationContext applicationContext = obtainApplicationContext(); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Looking for URL mappings in application context: &quot; + applicationContext); &#125; String[] beanNames = (this.detectHandlersInAncestorContexts ? BeanFactoryUtils.beanNamesForTypeIncludingAncestors(applicationContext, Object.class) : applicationContext.getBeanNamesForType(Object.class)); // Take any bean name that we can determine URLs for. for (String beanName : beanNames) &#123; // è·å–BeanNameæˆ–åˆ«åæ˜¯ &quot;/&quot; å¼€å¤´çš„ Beanåç§° String[] urls = determineUrlsForHandler(beanName); if (!ObjectUtils.isEmpty(urls)) &#123; // URL paths found: Let&apos;s consider it a handler. // æŠŠè·å–åˆ°çš„ urls æ³¨å†Œåˆ° handler registerHandler(urls, beanName); &#125; else &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Rejected bean name &apos;&quot; + beanName + &quot;&apos;: no URL paths identified&quot;); &#125; &#125; &#125;&#125; determineUrlsForHandleræ˜¯BeanNameUrlHandlerMappingç±»ä»…æœ‰å®ç°çš„ä¸€ä¸ªæ–¹æ³•ï¼Œä¸»è¦é€»è¾‘å°±æ˜¯è·å–BeanNameæˆ–åˆ«åæ˜¯ â€œ/â€œ å¼€å¤´çš„ Beanåç§°ã€‚æ‰€ä»¥è¿™é‡Œä¹Ÿå¯ä»¥çŸ¥é“åœ¨ä¸Šæ–‡çš„ä½¿ç”¨ä¾‹å­ä¸­ï¼ŒBeanNameæˆ‘ä¸ºä½•è¦ä»¥æ–œæ å¼€å¤´ã€‚ å½“ä¸€ä¸ªè¯·æ±‚æ¥æ—¶BeanNameUrlHandlerMappingçš„å¤„ç†é€»è¾‘ç±»ä¼¼ï¼Œåªä¸è¿‡åŒ¹é…çš„å®¹å™¨æ¢æˆäº†handlerMap = new LinkedHashMap&lt;&gt;();ï¼ŒåŒ¹é…é€»è¾‘æ›´åŠ çš„ç®€å•ç›´æ¥ã€‚ SimpleUrlHandlerMappingæœ€åå†çœ‹ä¸‹ SimpleUrlHandlerMappingçš„ç”¨æ³•åŠå®ç° å®šä¹‰ä¸€ä¸ªSimpleUrlHandlerMapping 1234567891011121314@Configurationpublic class SampleConfig &#123; @Bean public SimpleUrlHandlerMapping simpleUrlHandlerMapping() &#123; SimpleUrlHandlerMapping simpleUrlHandlerMapping = new SimpleUrlHandlerMapping(); Map&lt;String, Object&gt; urlMap = new HashMap&lt;&gt;(); urlMap.put("/**", new Test2API()); // ... å¯é…ç½®å¤šä¸ªæ˜ å°„å…³ç³» simpleUrlHandlerMapping.setUrlMap(urlMap); simpleUrlHandlerMapping.setOrder(1); return simpleUrlHandlerMapping; &#125;&#125; ä»¥ä¸Šé…ç½®ä¼šæ‹¦æˆªæ‰€æœ‰çš„è¯·æ±‚ï¼Œç„¶åè½¬äº¤ç»™ Test2APIå¤„ç†ï¼ˆTest2APIå¯ä»¥æ˜¯Controlleræ¥å£å®ç°ç±»ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª HttpRequestHandleræ¥å£å®ç°ç±»ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡ŒSimpleUrlHandlerMappingèµ·çš„ä½œç”¨éå¸¸åƒä¸€ä¸ªæ‹¦æˆªå™¨èµ·çš„ä½œç”¨ï¼Œå…¶å®ä¹Ÿç¡®å®æ˜¯è¿™æ ·ï¼Œåƒå¯¹é™æ€èµ„æºçš„æ‹¦æˆªå°±å¯ä»¥é‡‡ç”¨SimpleUrlHandlerMappingæ¥å®ç°ã€‚ å…·ä½“å®ç°å…¶å®è·Ÿä¸Šæ–‡çš„ä¸¤ç§mappingå®ç°ç±»ä¼¼ï¼Œç®€å•çœ‹ä¸‹æºç  åˆå§‹æ³¨å†Œé€»è¾‘ 123456789101112131415161718192021222324@Overridepublic void initApplicationContext() throws BeansException &#123; super.initApplicationContext(); registerHandlers(this.urlMap);&#125;protected void registerHandlers(Map&lt;String, Object&gt; urlMap) throws BeansException &#123; if (urlMap.isEmpty()) &#123; logger.warn("Neither 'urlMap' nor 'mappings' set on SimpleUrlHandlerMapping"); &#125; else &#123; urlMap.forEach((url, handler) -&gt; &#123; // ç¡®ä¿è·¯å¾„æ˜¯ä»¥æ–œæ å¼€å¤´çš„ if (!url.startsWith("/")) &#123; url = "/" + url; &#125; // å»é™¤ç©ºæ ¼ if (handler instanceof String) &#123; handler = ((String) handler).trim(); &#125; // æ³¨å†Œ registerHandler(url, handler); &#125;); &#125;&#125; é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå°±æ˜¯å°†æˆ‘ä»¬æ‰‹åŠ¨é…ç½®çš„å¤šä¸ªæ˜ å°„å…³ç³»è¿›è¡Œåˆå§‹æ³¨å†Œï¼Œä»¥å¤‡åé¢é€»è¾‘ä½¿ç”¨ã€‚ æ€»ç»“æ€»çš„æ¥è¯´HanderMappingçš„èŒè´£æ˜¯éå¸¸æ¸…æ™°çš„ï¼Œå°±æ˜¯å­˜å‚¨å¹¶åŒ¹é…è¯·æ±‚urlå’Œå¤„ç†ç±»çš„æ˜ å°„å…³ç³»ã€‚æ•´ä¸ªå¤„ç†æµç¨‹çš„æºç ç›¸å¯¹æ¥è¯´ä¹Ÿæ¯”è¾ƒç›´è§‚ï¼Œæ˜“é˜…è¯»ã€‚è¯»å®Œå…¶æºç å¯¹MVCçš„urlåŒ¹é…æµç¨‹ä¼šæœ‰æ›´åŠ æ·±åˆ»çš„è®¤è¯†]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åˆ†å¸ƒå¼äº‹åŠ¡åœ¨ç§¯åˆ†å•†åŸé‡Œçš„åº”ç”¨]]></title>
    <url>%2F2019%2F07%2F10%2F%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%9C%A8%E7%A7%AF%E5%88%86%E5%95%86%E5%9F%8E%E9%87%8C%E7%9A%84%E5%BA%94%E7%94%A8%2F</url>
    <content type="text"><![CDATA[å¼•è¨€æœ€è¿‘åœ¨åšä¼šå‘˜ä½“ç³»çš„æ—¶å€™ï¼Œæ¶‰åŠåˆ°äº†ç§¯åˆ†å•†åŸè®¢å•ä½“ç³»ï¼Œæ—¢ç„¶è®¾è®¡åˆ°è®¢å•ä½“ç³»ï¼Œå› ä¸ºç°åœ¨çš„é¡¹ç›®æ¶æ„ä½“ç³»åŸºæœ¬éƒ½æ˜¯å¾®æœåŠ¡åˆ†å¸ƒå¼çš„ï¼Œæ‰€ä»¥å¿…ç„¶ä¼šæ¶‰åŠåˆ°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚äº‹åŠ¡é—®é¢˜åœ¨æ—©äº›æ—¶å€™éƒ½æ˜¯å•æœºéƒ¨ç½²çš„æ—¶ä»£ä¾é æ•°æ®åº“æœ¬èº«æä¾›çš„äº‹åŠ¡æœºåˆ¶éå¸¸å®¹æ˜“è§£å†³ï¼Œä½†æ˜¯ä¸€æ—¦è®¾è®¡åˆ°åˆ†å¸ƒå¼ï¼Œå„ä¸ªç‹¬ç«‹çš„æœåŠ¡æ˜¯æ— æ³•æ„ŸçŸ¥å…¶ä»–äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å€ŸåŠ©ä¸€äº›å…¶ä»–æ‰‹æ®µæ¥ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡ åˆ†å¸ƒå¼ç†è®º CAP Cï¼ˆä¸€è‡´æ€§ï¼‰ä¸€è‡´æ€§æ˜¯æŒ‡æ•°æ®çš„åŸå­æ€§ï¼Œåœ¨ç»å…¸çš„æ•°æ®åº“ä¸­é€šè¿‡äº‹åŠ¡æ¥ä¿éšœï¼Œäº‹åŠ¡å®Œæˆæ—¶ï¼Œæ— è®ºæˆåŠŸæˆ–å›æ»šï¼Œæ•°æ®éƒ½ä¼šå¤„äºä¸€è‡´çš„çŠ¶æ€ï¼Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œä¸€è‡´æ€§æ˜¯æŒ‡å¤šä¸ªèŠ‚ç‚¹æ•°æ®æ˜¯å¦ä¸€è‡´ï¼› Aï¼ˆå¯ç”¨æ€§ï¼‰æœåŠ¡ä¸€ç›´ä¿æŒå¯ç”¨çš„çŠ¶æ€ï¼Œå½“ç”¨æˆ·å‘å‡ºä¸€ä¸ªè¯·æ±‚ï¼ŒæœåŠ¡èƒ½åœ¨ä¸€å®šçš„æ—¶é—´å†…è¿”å›ç»“æœï¼› Pï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰æœºå™¨æ•…éšœã€ç½‘ç»œæ•…éšœã€æœºæˆ¿åœç”µç­‰å¼‚å¸¸æƒ…å†µä¸‹ä»ç„¶èƒ½å¤Ÿæ»¡è¶³ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ï¼Œåˆ†å¸ƒå¼åº”ç”¨ä¸€èˆ¬éƒ½æ»¡è¶³åˆ†åŒºå®¹é”™æ€§åˆ†å¸ƒå¼äº‹åŠ¡æˆ‘ä»¬è¦è§£å†³çš„å°±æ˜¯æ•°æ®çš„ä¸€è‡´æ€§é—®é¢˜ ä¸€è‡´æ€§æ¨¡å‹ åŸºæœ¬å¯ç”¨ï¼ˆBasically Availableï¼‰ è½¯çŠ¶æ€ï¼ˆSoft Stateï¼‰ æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventually Consistentï¼‰ å…¶ä¸­æœ€ç»ˆä¸€è‡´æ€§åˆå¯åˆ†ä¸ºï¼šä¼šè¯ä¸€è‡´æ€§ å•è°ƒä¸€è‡´æ€§ç­‰ç­‰ 2PC (Two/Three Phase Commit)2PC æˆ‘ä»¬åˆæŠŠå®ƒå«åšä¸¤é˜¶æ®µæäº¤ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹è™½ç„¶å¯ä»¥çŸ¥æ™“è‡ªå·±çš„æ“ä½œæ—¶æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œå´æ— æ³•çŸ¥é“å…¶ä»–èŠ‚ç‚¹çš„æ“ä½œçš„æˆåŠŸæˆ–å¤±è´¥ã€‚å½“ä¸€ä¸ªäº‹åŠ¡è·¨è¶Šå¤šä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¸ºäº†ä¿æŒäº‹åŠ¡çš„ACIDç‰¹æ€§ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªä½œä¸ºåè°ƒè€…çš„ç»„ä»¶æ¥ç»Ÿä¸€æŒæ§æ‰€æœ‰èŠ‚ç‚¹ï¼ˆç§°ä½œå‚ä¸è€…ï¼‰çš„æ“ä½œç»“æœå¹¶æœ€ç»ˆæŒ‡ç¤ºè¿™äº›èŠ‚ç‚¹æ˜¯å¦è¦æŠŠæ“ä½œç»“æœè¿›è¡ŒçœŸæ­£çš„æäº¤ï¼ˆæ¯”å¦‚å°†æ›´æ–°åçš„æ•°æ®å†™å…¥ç£ç›˜ç­‰ç­‰ï¼‰ã€‚å› æ­¤ï¼ŒäºŒé˜¶æ®µæäº¤çš„ç®—æ³•æ€è·¯å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š å‚ä¸è€…å°†æ“ä½œæˆè´¥é€šçŸ¥åè°ƒè€…ï¼Œå†ç”±åè°ƒè€…æ ¹æ®æ‰€æœ‰å‚ä¸è€…çš„åé¦ˆæƒ…æŠ¥å†³å®šå„å‚ä¸è€…æ˜¯å¦è¦æäº¤æ“ä½œè¿˜æ˜¯ä¸­æ­¢æ“ä½œã€‚ å‰æäºŒé˜¶æ®µæäº¤ç®—æ³•çš„æˆç«‹åŸºäºä»¥ä¸‹å‡è®¾ï¼š è¯¥åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºåè°ƒè€…(Coordinator)ï¼Œå…¶ä»–èŠ‚ç‚¹ä½œä¸ºå‚ä¸è€…(Participants)ã€‚ä¸”èŠ‚ç‚¹ä¹‹é—´å¯ä»¥è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚ æ‰€æœ‰èŠ‚ç‚¹éƒ½é‡‡ç”¨é¢„å†™å¼æ—¥å¿—ï¼Œä¸”æ—¥å¿—è¢«å†™å…¥åå³è¢«ä¿æŒåœ¨å¯é çš„å­˜å‚¨è®¾å¤‡ä¸Šï¼Œå³ä½¿èŠ‚ç‚¹æŸåä¸ä¼šå¯¼è‡´æ—¥å¿—æ•°æ®çš„æ¶ˆå¤±ã€‚ æ‰€æœ‰èŠ‚ç‚¹ä¸ä¼šæ°¸ä¹…æ€§æŸåï¼Œå³ä½¿æŸååä»ç„¶å¯ä»¥æ¢å¤ã€‚ ç¬¬ä¸€é˜¶æ®µ(æäº¤è¯·æ±‚é˜¶æ®µ) åè°ƒè€…èŠ‚ç‚¹å‘æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹è¯¢é—®æ˜¯å¦å¯ä»¥æ‰§è¡Œæäº¤æ“ä½œï¼Œå¹¶å¼€å§‹ç­‰å¾…å„å‚ä¸è€…èŠ‚ç‚¹çš„å“åº”ã€‚ å‚ä¸è€…èŠ‚ç‚¹æ‰§è¡Œè¯¢é—®å‘èµ·ä¸ºæ­¢çš„æ‰€æœ‰äº‹åŠ¡æ“ä½œï¼Œå¹¶å°†Undoä¿¡æ¯å’ŒRedoä¿¡æ¯å†™å…¥æ—¥å¿—ã€‚ å„å‚ä¸è€…èŠ‚ç‚¹å“åº”åè°ƒè€…èŠ‚ç‚¹å‘èµ·çš„è¯¢é—®ã€‚å¦‚æœå‚ä¸è€…èŠ‚ç‚¹çš„äº‹åŠ¡æ“ä½œå®é™…æ‰§è¡ŒæˆåŠŸï¼Œåˆ™å®ƒè¿”å›ä¸€ä¸ªâ€åŒæ„â€æ¶ˆæ¯ï¼›å¦‚æœå‚ä¸è€…èŠ‚ç‚¹çš„äº‹åŠ¡æ“ä½œå®é™…æ‰§è¡Œå¤±è´¥ï¼Œåˆ™å®ƒè¿”å›ä¸€ä¸ªâ€ä¸­æ­¢â€æ¶ˆæ¯ã€‚ æœ‰æ—¶å€™ï¼Œç¬¬ä¸€é˜¶æ®µä¹Ÿè¢«ç§°ä½œæŠ•ç¥¨é˜¶æ®µï¼Œå³å„å‚ä¸è€…æŠ•ç¥¨æ˜¯å¦è¦ç»§ç»­æ¥ä¸‹æ¥çš„æäº¤æ“ä½œã€‚ ç¬¬äºŒé˜¶æ®µ(æäº¤æ‰§è¡Œé˜¶æ®µ) æˆåŠŸ å½“åè°ƒè€…èŠ‚ç‚¹ä»æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹è·å¾—çš„ç›¸åº”æ¶ˆæ¯éƒ½ä¸ºâ€åŒæ„â€æ—¶ï¼š åè°ƒè€…èŠ‚ç‚¹å‘æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹å‘å‡ºâ€æ­£å¼æäº¤â€çš„è¯·æ±‚ã€‚ å‚ä¸è€…èŠ‚ç‚¹æ­£å¼å®Œæˆæ“ä½œï¼Œå¹¶é‡Šæ”¾åœ¨æ•´ä¸ªäº‹åŠ¡æœŸé—´å†…å ç”¨çš„èµ„æºã€‚ å‚ä¸è€…èŠ‚ç‚¹å‘åè°ƒè€…èŠ‚ç‚¹å‘é€â€å®Œæˆâ€æ¶ˆæ¯ã€‚ åè°ƒè€…èŠ‚ç‚¹æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹åé¦ˆçš„â€å®Œæˆâ€æ¶ˆæ¯åï¼Œå®Œæˆäº‹åŠ¡ã€‚ å¤±è´¥ å¦‚æœä»»ä¸€å‚ä¸è€…èŠ‚ç‚¹åœ¨ç¬¬ä¸€é˜¶æ®µè¿”å›çš„å“åº”æ¶ˆæ¯ä¸ºâ€ç»ˆæ­¢â€ï¼Œæˆ–è€… åè°ƒè€…èŠ‚ç‚¹åœ¨ç¬¬ä¸€é˜¶æ®µçš„è¯¢é—®è¶… æ—¶ä¹‹å‰æ— æ³•è·å–æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹çš„å“åº”æ¶ˆæ¯æ—¶ï¼š åè°ƒè€…èŠ‚ç‚¹å‘æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹å‘å‡ºâ€å›æ»šæ“ä½œâ€çš„è¯·æ±‚ã€‚ å‚ä¸è€…èŠ‚ç‚¹åˆ©ç”¨ä¹‹å‰å†™å…¥çš„Undoä¿¡æ¯æ‰§è¡Œå›æ»šï¼Œå¹¶é‡Šæ”¾åœ¨æ•´ä¸ªäº‹åŠ¡æœŸé—´å†…å ç”¨çš„èµ„æºã€‚ å‚ä¸è€…èŠ‚ç‚¹å‘åè°ƒè€…èŠ‚ç‚¹å‘é€â€å›æ»šå®Œæˆâ€æ¶ˆæ¯ã€‚ åè°ƒè€…èŠ‚ç‚¹æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹åé¦ˆçš„â€å›æ»šå®Œæˆâ€æ¶ˆæ¯åï¼Œå–æ¶ˆäº‹åŠ¡ã€‚ æœ‰æ—¶å€™ï¼Œç¬¬äºŒé˜¶æ®µä¹Ÿè¢«ç§°ä½œå®Œæˆé˜¶æ®µï¼Œå› ä¸ºæ— è®ºç»“æœæ€æ ·ï¼Œåè°ƒè€…éƒ½å¿…é¡»åœ¨æ­¤é˜¶æ®µç»“æŸå½“å‰äº‹åŠ¡ ç¼ºç‚¹äºŒé˜¶æ®µæäº¤ç®—æ³•çš„æœ€å¤§ç¼ºç‚¹å°±åœ¨äº: å®ƒçš„æ‰§è¡Œè¿‡ç¨‹ä¸­é—´ï¼ŒèŠ‚ç‚¹éƒ½å¤„äºé˜»å¡çŠ¶æ€ã€‚å³èŠ‚ç‚¹ä¹‹é—´åœ¨ç­‰å¾…å¯¹æ–¹çš„å“åº”æ¶ˆæ¯æ—¶ï¼Œå®ƒå°†ä»€ä¹ˆä¹Ÿåšä¸äº†ã€‚ç‰¹åˆ«æ˜¯ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹åœ¨å·²ç»å æœ‰äº†æŸé¡¹èµ„æºçš„æƒ…å†µä¸‹ï¼Œä¸ºäº†ç­‰å¾…å…¶ä»–èŠ‚ç‚¹çš„å“åº”æ¶ˆæ¯è€Œé™·å…¥é˜»å¡çŠ¶æ€æ—¶ï¼Œå½“ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹å°è¯•è®¿é—®è¯¥èŠ‚ç‚¹å æœ‰çš„èµ„æºæ—¶ï¼Œè¿™ä¸ªèŠ‚ç‚¹ä¹Ÿå°†è¿å¸¦é™·å…¥é˜»å¡çŠ¶æ€ã€‚ TCC è¡¥å¿å‹ä¸Šé¢å¤§ç¯‡å¹…çš„ä»‹ç»äº†2PCæäº¤ï¼Œä½†å®é™…çš„åº”ç”¨ä¸­æˆ‘ä»¬åŸºæœ¬éƒ½ä¸ä¼šä½¿ç”¨è¿™ç§æ–¹æ¡ˆï¼ŒåŸå› åœ¨ä¸Šé¢çš„ç¼ºç‚¹ä¸­å·²ç»è¯´æ˜äº†ï¼Œ2PCè¿™ç§ä¼ ç»Ÿçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆæ€§èƒ½å®åœ¨æ˜¯å¤ªå·®äº†ï¼Œåœ¨äº’è”ç½‘å¤§å¹¶å‘çš„èƒŒæ™¯ä¸‹æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ï¼Œè¿™å°±å¼•ç”³å‡ºäº†TCCè¡¥å¿æ€§åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ TCCæ˜¯(Try-Confirm-Cancel)çš„ç®€ç§°ï¼Œä»åå­—æˆ‘ä»¬çŸ¥é“TCCæœ‰ä¸‰ä¸ªé˜¶æ®µ TryTryé˜¶æ®µä¸»è¦åšèµ„æºçš„é¢„ç•™ï¼Œé”å®šæ“ä½œ Confirmå¦‚æœTryé¢„ç•™èµ„æºæˆåŠŸï¼Œåˆ™æ‰§è¡ŒConfirmæ“ä½œï¼Œå¯¹èµ„æºåšæœ€ç»ˆçš„æäº¤ Cancelå¦‚æœTryé¢„ç•™èµ„æºå¤±è´¥ï¼Œåˆ™æ‰§è¡ŒCancelå–æ¶ˆå¯¹èµ„æºçš„é”å®š é€šè¿‡ä¸Šæ–‡çš„æè¿°ï¼Œå¯ä»¥å‘ç°TCCä¸2PCéå¸¸ç›¸ä¼¼ï¼Œä½†å®é™…ä¸Šä¸¤è€…åœ¨è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„å±‚é¢ä¸Šä¸ä¸€æ ·çš„ï¼Œ2PCä¸»è¦è¿˜æ˜¯å€ŸåŠ©æ•°æ®åº“å±‚é¢çš„äº‹åŠ¡æ¥åè°ƒè§£å†³ï¼Œç›¸å¯¹äºæ•°æ®åº“äº‹åŠ¡çš„rollbackï¼ŒTCCåœ¨é€»è¾‘å±‚é¢çš„Cancelæ“ä½œï¼Œä»£ä»·è¦å°çš„å¤šã€‚å¹¶ä¸”TCCäº‹åŠ¡å¼•å…¥äº†ä¸­é—´çŠ¶æ€ï¼ˆä¹Ÿå°±æ˜¯èµ„æºçš„é”å®šï¼‰ï¼Œåªè¦å…¨éƒ¨èµ„æºéƒ½é”å®šæˆåŠŸï¼Œæˆ‘ä»¬å°±è®¤ä¸ºæœ€ç»ˆæ˜¯æ‰§è¡ŒæˆåŠŸçš„ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰ ä¸‹å›¾æ˜¯ç§¯åˆ†ä¸‹å•ç”¨TCCäº‹åŠ¡è§£å†³çš„å…¸å‹åœºæ™¯ TCCæ˜¯å¦‚ä½•è§£å†³æœ€ç»ˆä¸€è‡´æ€§çš„ï¼Ÿå½“æˆ‘ä»¬åœ¨Tryé˜¶æ®µé¢„ç•™èµ„æºæˆåŠŸçš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è®¤ä¸ºæœ€ç»ˆè¿™ä¸ªäº‹åŠ¡æ˜¯è‚¯å®šå¯ä»¥å®Œæˆçš„ï¼Œå³ä½¿å› ä¸ºæŸäº›åŸå› (æ•°æ®åº“downäº†ç­‰çš„)Confirmæ‰§è¡Œå¤±è´¥ï¼ŒTCCäº‹åŠ¡æ¡†æ¶ä¼šä¸åœçš„é‡è¯•è°ƒç”¨å®ƒçš„Confirmé€»è¾‘ï¼ŒåŠ¡å¿…ä¼šä¿è¯å…¶æœ€ç»ˆä¸€è‡´æ€§ å…¸å‹åº”ç”¨åœºæ™¯è®¢å•ç³»ç»Ÿ äº‹åŠ¡æ¶ˆæ¯äº‹åŠ¡æ¶ˆæ¯çš„åº”ç”¨åœºæ™¯æ˜¯ï¼Œäº‹åŠ¡å‚ä¸æ–¹çš„èµ„æºå·²ç»é”å®šï¼Œåªéœ€è¦ä¿æŒæœ€ç»ˆä¸€è‡´æ€§çš„åœºæ™¯ã€‚æ¯”è¾ƒå…¸å‹çš„å®ä¾‹æ˜¯é“¶è¡Œè½¬è´¦ï¼Œå½“Aè´¦æˆ·å®Œæˆè´¦æˆ·æ‰£å‡åï¼ŒBè´¦æˆ·ä¸éœ€è¦é”å®šè´¦æˆ·ï¼Œåªéœ€è¦ä¿è¯æœ€ç»ˆBè´¦æˆ·å¯ä»¥å¢åŠ æŒ‡å®šé‡‘é¢ ä¸ºä½•éœ€è¦å…ˆå‘é€ Prepareæ¶ˆæ¯ï¼Ÿè¯•æƒ³ä¸€ç§åœºæ™¯ï¼Œæœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œå‡†å¤‡å‘é€æ¶ˆæ¯çš„æ—¶å€™æ–­ç½‘äº†ï¼Œè¿™æ—¶å€™å°±ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µ commit or rollback æ¶ˆæ¯å‘é€å¤±è´¥ï¼Ÿè¿™æ—¶å€™éœ€è¦æ¶ˆæ¯ä¸­é—´ä»¶æä¾›æ¶ˆæ¯å›æŸ¥åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å½“é—´éš”ä¸€æ®µæ—¶é—´ä¹‹åï¼ŒPrepareæ¶ˆæ¯æ²¡æœ‰æ”¶åˆ° commit or rollbackæ¶ˆæ¯ï¼Œéœ€è¦å‘èµ·æ¶ˆæ¯å›æŸ¥ï¼Œå¹¶ä¸”ç”±ä¸šåŠ¡æ–¹åˆ¤æ–­æœ€ç»ˆæ¶ˆæ¯æ˜¯å¦éœ€è¦æŠ•é€’ å¯¹äºäº‹åŠ¡æ¶ˆæ¯çš„è§£å†³æ–¹æ¡ˆï¼Œé˜¿é‡Œçš„RocketMqä¹Ÿæä¾›äº†è§£å†³æ–¹æ¡ˆ æ€»ç»“æ€»ä½“æ¥è¯´ï¼Œæ¯ç§åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆéƒ½æœ‰å…¶åº”ç”¨åœºæ™¯ï¼Œä½†ç›®å‰ä¸šç•Œæ¯”è¾ƒä¸»æµçš„è¿˜æ˜¯TCCå’Œäº‹åŠ¡æ¶ˆæ¯ï¼ŒTCCäº‹åŠ¡éœ€è¦ä¸šåŠ¡å®ç°Try-Confirm-Cancelé€»è¾‘ï¼Œéœ€è¦åœ¨Tryé˜¶æ®µæå‰é”å®šèµ„æºï¼Œç›¸å¯¹äºäº‹åŠ¡æ¶ˆæ¯æ¥è¯´æˆæœ¬è¾ƒé«˜ï¼Œä½†æ˜¯äº‹åŠ¡æ¶ˆæ¯çš„é€‚ç”¨åœºæ™¯ä¹Ÿæ˜¯æœ‰é™çš„ï¼Œå¦‚ä¸‹å•æ‰£å‡åº“å­˜è¿™ä¸ªåœºæ™¯å› ä¸ºéœ€è¦æå‰é”å®šåº“å­˜ï¼Œäº‹åŠ¡æ¶ˆæ¯å°±ä¸é€‚ç”¨äº†ã€‚]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼</category>
      </categories>
      <tags>
        <tag>åˆ†å¸ƒå¼</tag>
        <tag>äº‹åŠ¡</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[git ä½ çœŸçš„ä¼šç”¨å—]]></title>
    <url>%2F2019%2F06%2F21%2Fgit-%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BC%9A%E7%94%A8%E5%90%97%2F</url>
    <content type="text"><![CDATA[è®°å½•åŸç”±æœ€è¿‘å› ä¸ºå…¬å¸æ–°æ¥çš„åŒäº‹ï¼Œåœ¨ä½¿ç”¨Gitæ—¶çŠ¯äº†ä¸€äº›éå¸¸ä½çº§çš„é”™è¯¯ï¼Œå¯¼è‡´å›¢é˜Ÿä¸ºäº†è§£å†³è¿™äº›é—®é¢˜æµªè´¹äº†å¾ˆå¤šæ—¶é—´ã€‚ç©¶å…¶åŸå› å…¶å®è¿˜æ˜¯å¯¹äºGitå†…éƒ¨å®ç°ä¸æ¸…æ™°ï¼Œä»…ä»…çŸ¥é“æ•²å‡ ä¸ªgitå‘½ä»¤ï¼Œä½†æ˜¯å´ä¸çŸ¥é“æ•²äº†è¿™ä¸ªå‘½ä»¤Gitä¼šå‘ç”Ÿä»€ä¹ˆï¼è¿™é‡Œæ ¹æ®gitå®˜æ–¹æ–‡æ¡£èŠ‚é€‰äº†ä¸€äº›é‡è¦æ¦‚å¿µåˆ†äº«å‡ºæ¥ã€‚ å‡ ä¸ªé‡è¦æ¦‚å¿µä¸‰ç§çŠ¶æ€ å·¥ä½œåŒºçŠ¶æ€ å°±æ˜¯ä¿®æ”¹äº†æ–‡ä»¶è¿˜æ²¡æœ‰åš git addçš„æ–‡ä»¶çŠ¶æ€ æš‚å­˜åŒºçŠ¶æ€ å·²ç»git addä½†è¿˜æœªgit commitçš„æ–‡ä»¶çŠ¶æ€ å·²æäº¤çŠ¶æ€ å·²ç»git commitçš„æ–‡ä»¶çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯çœŸæ­£å­˜å‚¨åˆ°gitä»“åº“ BranchæŒ‡é’ˆå’ŒHEADæŒ‡é’ˆGitçš„åˆ†æ”¯ç‰¹æ€§æ˜¯å…¶æœ€å¼ºå¤§æœ€ç‹¬ç‰¹çš„åŠŸèƒ½ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ä¸ªç‰¹æ€§è®©gitå¾—ä»¥åœ¨ä¼—å¤šçš„ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸­è„±é¢–è€Œå‡ºï¼Œåœ¨ç†è§£branchä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆå¯¹git commitå‘½ä»¤åšä¸€ä¸ªç®€å•çš„ä»‹ç» å½“ä½¿ç”¨git commitè¿›è¡Œæäº¤æ“ä½œæ—¶ï¼ŒGitä¾¿ä¼šåˆ›å»ºä¸€ä¸ªæäº¤å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šåŒ…å«ä¸€ä¸ªæŒ‡å‘æœ¬æ¬¡æäº¤çš„æŒ‡é’ˆï¼ŒæŒ‡é’ˆæŒ‡å‘æœ¬æ¬¡commitçš„å¿«ç…§ã€‚æŒ‡é’ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„commit id(é•¿åº¦ä¸º 40 çš„ SHA-1 å€¼å­—ç¬¦ä¸²)ã€‚å¦‚æ­¤ä¸€æ¥ï¼ŒGitå°±å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™æ ¹æ®commit idæ¥å›é€€ç‰ˆæœ¬ Branchçš„æœ¬è´¨å…¶å®ä»…ä»…æ˜¯æŒ‡å‘æäº¤å¯¹è±¡çš„æŸä¸€ä¸ªå¯å˜æŒ‡é’ˆã€‚æ‰€ä»¥æ ¹æ®è¿™ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“masterå¹¶ä¸æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åˆ†æ”¯ï¼Œä»–è·Ÿæˆ‘ä»¬ä¼—å¤šè‡ªå®šä¹‰çš„åˆ†æ”¯æ²¡æœ‰ä»»ä½•ä¸åŒï¼Œå”¯ä¸€åŒºåˆ«æ˜¯å®ƒæ˜¯Gitçš„é»˜è®¤åˆ†æ”¯(åˆå§‹åŒ–çš„æ—¶å€™æ€»å¾—æœ‰ä¸€ä¸ªé»˜è®¤åˆ†æ”¯) ä¸‹é¢çš„å›¾æ˜¯å•ä¸ªmasteråˆ†æ”¯æ—¶çš„ç»“æ„ï¼Œè¿™é‡Œmasterä»…ä»…æ˜¯ä¸€ä¸ªæŒ‡å‘f30abæäº¤å¯¹è±¡çš„æŒ‡é’ˆ æ‰§è¡Œ $ git branch testingåˆ›å»ºä¸€ä¸ª testingåˆ†æ”¯ï¼Œä¼šåœ¨å½“å‰æ‰€åœ¨çš„æäº¤å¯¹è±¡ä¸Šåˆ›å»ºä¸€ä¸ªåä¸ºtestingçš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯testingåˆ†æ”¯ æ³¨æ„ï¼šæ­¤æ—¶ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘äº†ç›¸åŒçš„æäº¤é‚£ä¹ˆGitæ˜¯å¦‚ä½•æ¥çŸ¥é“å½“å‰å¤„äºå“ªä¸ªåˆ†æ”¯çš„å‘¢ï¼Ÿè¿™å°±å¼•å‡ºäº†Gitä¸­çš„å¦ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡é’ˆHEADï¼ŒHEADç”¨æ¥æŒ‡å‘å½“å‰æ‰€åœ¨çš„åˆ†æ”¯ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªç”¨æ¥æŒ‡å‘åˆ†æ”¯æŒ‡é’ˆçš„æŒ‡é’ˆï¼ˆæœ‰ç‚¹æ‹—å£ï¼‰ï¼Œå°±åƒä¸‹å›¾è¿™æ ·ï¼Œå½“å‰æ˜¯åœ¨masteråˆ†æ”¯ï¼Œå› ä¸ºgit branchå¹¶ä¸ä¼šç§»åŠ¨HEADæŒ‡é’ˆåˆ‡æ¢åˆ†æ”¯ æ‰§è¡Œ $ git checkout testingå‘½ä»¤æ‰ä¼šå°†HEADæŒ‡é’ˆæŒ‡å‘testingåˆ†æ”¯ å½“æˆ‘ä»¬åœ¨testingåˆ†æ”¯ä¸Šç»§ç»­æäº¤å‡ ä¸ªcommitä¹‹åï¼ŒtestingæŒ‡é’ˆå’ŒHEADæŒ‡é’ˆéƒ½ä¼šè·Ÿç€å‘å‰ç§»åŠ¨ï¼Œä½†æ˜¯masteræŒ‡é’ˆå¹¶ä¸ä¼šç§»åŠ¨ï¼Œä¾æ—§æŒ‡å‘f30abè¿™ä¸ªæäº¤ ç°åœ¨æ‰§è¡Œgit checkout masteråˆ‡å›masteråˆ†æ”¯ï¼ŒHEADæŒ‡é’ˆä¼šé‡æ–°æŒ‡å‘masterï¼Œä¹Ÿå°±æ˜¯è¯´ç°åœ¨åˆå›åˆ°äº†ä¸€ä¸ªæ—§çš„ç‰ˆæœ¬ï¼Œè¿™ä¹Ÿæ˜¯Gitçš„ç¥å¥‡ä¹‹å¤„ æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨masteråˆ†æ”¯ä¸Šåšä¸€äº›ä¿®æ”¹ï¼Œæäº¤ä¸€ä¸ªcommitï¼ŒHEADå’ŒmasteræŒ‡é’ˆä¼šç»§ç»­å‘å‰ç§»åŠ¨ï¼Œå¹¶ä¸”è¿™ä¸ªé¡¹ç›®çš„æäº¤ï¼ˆå¿«ç…§ç‰ˆæœ¬ï¼‰å·²ç»äº§ç”Ÿäº†åˆ†å‰ ä¿å­˜åˆ†æ”¯ä¿¡æ¯çš„ç›®å½•åœ¨.git/refs/headsä¸‹ï¼Œä¹Ÿå¯ä»¥åœ¨è¿™ä¸ªç›®å½•ä¸‹æŸ¥çœ‹æˆ–ä¿®æ”¹åˆ†æ”¯æŒ‡é’ˆ merge å‘½ä»¤åœ¨ä¸Šæ–‡çš„ä¾‹å­ä¸­ï¼Œé¡¹ç›®æœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼Œä¸”å·²ç»äº§ç”Ÿäº†åˆ†å‰ï¼Œè¿™æ—¶å€™éœ€è¦æŠŠtestingåˆ†æ”¯ä¸Šçš„å†…å®¹åˆå¹¶è‡³masteræ—¶éœ€è¦ç”¨åˆ°mergeå‘½ä»¤åœ¨masteræ‰§è¡Œgit merge testingï¼Œä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æäº¤9c67aï¼Œå¹¶ä¸”HEADå’ŒmasteræŒ‡é’ˆç»§ç»­å‘å‰ç§»åŠ¨ reset å‘½ä»¤å‡å¦‚ä¸Šé¢çš„mergeæ“ä½œæœ‰é—®é¢˜ï¼Œéœ€è¦æ’¤é”€ï¼Œå¯ä»¥ä½¿ç”¨resetå‘½ä»¤ï¼Œä½†é¦–å…ˆéœ€è¦æ˜ç¡®å›é€€çš„ç‰ˆæœ¬æ˜¯å“ªä¸€ä¸ªï¼Œä¾‹å¦‚è¦å›é€€çš„ç‰ˆæœ¬æ˜¯c2b9eï¼Œæ‰§è¡Œgit reset --hard c2b9eåï¼ŒHEADå’ŒmasteræŒ‡é’ˆä¼šå›é€€åˆ°ç‰ˆæœ¬c2b9e â€¦]]></content>
      <categories>
        <category>git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[JAVA æ³›å‹ ä½ çœŸçš„ç†è§£äº†å—ï¼Ÿ]]></title>
    <url>%2F2019%2F06%2F19%2FJAVA-%E6%B3%9B%E5%9E%8B-%E4%BD%A0%E7%9C%9F%E7%9A%84%E7%90%86%E8%A7%A3%E4%BA%86%E5%90%97%EF%BC%9F%2F</url>
    <content type="text"><![CDATA[è®°å½•åŸç”±ä¹‹å‰è™½ç„¶æ³›å‹ä¸€ç›´åœ¨ä½¿ç”¨ï¼Œä½†ä½¿ç”¨çš„è¿‡ç¨‹ä¸­æ€»æ˜¯æ²¡æœ‰é‚£ä¹ˆå¾—å¿ƒåº”æ‰‹ï¼Œæœ‰äº›ç»†èŠ‚è¿˜æ˜¯è¿‡äºæ¨¡ç³Šã€‚ç©¶å…¶åŸå› å…¶å®æ˜¯ä¸€ç›´éƒ½æ²¡æœ‰ç³»ç»Ÿæ·±å…¥çš„å»ç†è§£è¿‡ï¼Œæœ€è¿‘èŠ±äº†ä¸€ç‚¹æ—¶é—´å»æ·±å…¥çš„ç†è§£äº†ä¸€ä¸‹javaçš„æ³›å‹æœºåˆ¶ï¼Œä¹Ÿå¸Œæœ›å€Ÿè¿™æ¬¡è®°å½•èƒ½å¤Ÿå½»åº•çš„ç†è§£javaçš„æ³›å‹ ä¸ºä»€ä¹ˆè¦æœ‰æ³›å‹æ³›å‹çš„æœ¬è´¨æ˜¯æŠŠ ç±»å‹å‚æ•°åŒ–ï¼Œä»€ä¹ˆæ˜¯ç±»å‹å‚æ•°åŒ–ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„é›†åˆç±»ï¼Œè¦æ˜¯æ²¡æœ‰ç±»å‹å‚æ•°åŒ–çš„è¯ï¼Œæˆ‘ä»¬å°±å¾—å®ç°è£…ä¸åŒç±»å‹çš„é›†åˆç±»ï¼Œä¼šå¤§å¤§é™ä½ä»£ç çš„å¯é‡ç”¨æ€§ï¼ ä¾‹å¦‚æˆ‘ä»¬è¦è®¾è®¡ä¸€ä¸ªè£…è‹¹æœçš„ç›˜å­å’Œä¸€ä¸ªè£…é¦™è•‰çš„ç›˜å­ï¼Œè¦æ€ä¹ˆè®¾è®¡å‘¢ï¼Ÿéå¸¸ç®€å•ï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯è®¾è®¡ä¸¤ä¸ªç›˜å­ç±»ï¼Œä¸€ä¸ªæ˜¯è‹¹æœç›˜å­ï¼Œä¸€ä¸ªé¦™è•‰ç›˜å­ï¼Œå°±åƒä¸‹é¢çš„ä»£ç ä¸€æ · 12345678910111213141516171819202122232425public class ApplePlant &#123; private Apple apple; public Apple getApple() &#123; return apple; &#125; public void setApple(Apple apple) &#123; this.apple = apple; &#125;&#125;public class BananaPlant &#123; private Banana banana; public Banana getBanana() &#123; return banana; &#125; public void setBanana(Banana banana) &#123; this.banana = banana; &#125;&#125; ä¸Šé¢çš„ä»£ç çš„ç¡®èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä½†å°±åƒä¸Šæ–‡æ‰€è¯´çš„ï¼Œè¿™æ ·çš„ä»£ç é™ä½äº†ä»£ç çš„å¯é‡ç”¨æ€§ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦æ€ä¹ˆä¼˜åŒ–å‘¢ï¼Œèªæ˜çš„ç¨‹åºå‘˜ä»¬é©¬ä¸Šæƒ³åˆ°äº†ï¼Œå¯ä»¥ç”¨Objectæ¥ä»£æ›¿ç›˜å­é‡Œæ‰€æŒ‡ä»£çš„å…·ä½“ç±»å‹ï¼Œå°±åƒä¸‹é¢è¿™æ · 123456789101112public class ObjectPlant &#123; private Object object; public Object getObject() &#123; return object; &#125; public void setObject(Object object) &#123; this.object = object; &#125;&#125; ä¸Šé¢çš„ä»£ç çœ‹ä¼¼å®Œç¾è§£å†³äº†ä»£ç ä¸å¯é‡ç”¨çš„é—®é¢˜ï¼Œä½†åŒæ—¶ä¹Ÿéšå«äº†å¾ˆå¤šå…¶ä»–é—®é¢˜ï¼Œä¾‹å¦‚åœ¨æˆ‘ä»¬å–æ•°æ®çš„æ—¶å€™ï¼Œå–å‡ºæ¥çš„åªèƒ½æ˜¯Objectç±»å‹ï¼Œéœ€è¦æˆ‘ä»¬å¼ºè½¬ç±»å‹ï¼Œè€Œå¾€ç›˜å­ä¸­åŠ å…¥æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•éªŒè¯ï¼Œæœ‰å¯èƒ½å¾€æ”¾è‹¹æœçš„ç›˜å­ä¸­åŠ å…¥äº†é¦™è•‰ä¹Ÿè¯´ä¸å®šï¼Œå› ä¸ºç¼–è¯‘å™¨å¹¶æ²¡æœ‰åšä»»ä½•é™åˆ¶ï¼Œåªè¦æ˜¯Objectç±»å‹ï¼Œéƒ½å¯ä»¥éªŒè¯é€šè¿‡ã€‚ ä¸Šé¢çš„é—®é¢˜åœ¨Java 1.5å¼•å…¥äº†æ³›å‹ä¹‹åå¾—åˆ°äº†å®Œç¾çš„è§£å†³ï¼Œä¸‹é¢è®©æˆ‘ä»¬æ¥çœ‹çœ‹ç”¨æ³›å‹å¦‚ä½•ä¼˜é›…çš„è§£å†³ä¸Šè¿°é—®é¢˜ 123456789101112public class Plant &lt;T&gt;&#123; private T t; public T getT() &#123; return t; &#125; public void setT(T t) &#123; this.t = t; &#125;&#125; åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæ³›å‹ç±»ï¼Œå®ƒè¡¨ç¤ºäº†ä¸€ä¸ªå¯ä»¥Tç±»å‹çš„ç¯®å­ï¼Œè€Œè¿™ä¸ªTç±»å‹éœ€è¦åˆ°æˆ‘ä»¬çœŸæ­£ä½¿ç”¨çš„æ—¶å€™æ‰ä¼šå»æŒ‡å®š ä¾‹å¦‚ç°åœ¨æˆ‘ä»¬è¦å®šä¹‰ä¸¤ç§ç›˜å­ï¼Œå¯ä»¥è¿™æ ·å£°æ˜ 123456Plant&lt;Apple&gt; applePlant = new Plant&lt;&gt;();Plant&lt;Banana&gt; bananaPlant = new Plant&lt;&gt;();Apple apple = new Apple();Banana banana = new Banana();applePlant.set(banana); // ç¼–è¯‘æŠ¥é”™bananaPlant.set(apple); // ç¼–è¯‘æŠ¥é”™ ä¸Šé¢çš„ä»£ç ä¹‹æ‰€ä»¥å®é™…ç±»å‹new Plant&lt;&gt;()çš„&lt;&gt;ä¸­æ²¡æœ‰æŒ‡æ˜å…·ä½“ç±»å‹ï¼Œæ˜¯å› ä¸ºJava7ä¹‹ååŠ äº†ç±»å‹è‡ªåŠ¨æ¨æ–­ï¼Œä¹Ÿå°±ä¸éœ€è¦ä¸¤ä¾§éƒ½åŠ ä¸Šæ³›å‹ç±»å‹ å¯ä»¥çœ‹åˆ°ä½¿ç”¨äº†æ³›å‹ä¹‹åï¼Œæ—¢æé«˜äº†ä»£ç çš„å¯é‡ç”¨æ€§ï¼Œåœ¨å®é™…ä½¿ç”¨æ—¶ä¹Ÿå¯¹ç±»å‹è¿›è¡Œäº†çº¦æŸï¼Œè£…è‹¹æœçš„ç›˜å­æ˜¯è£…ä¸äº†é¦™è•‰çš„ï¼ ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ï¼Œjavaçš„æ³›å‹çº¦æŸæ˜¯åœ¨ç¼–è¯‘æ—¶ç”Ÿæ•ˆçš„ï¼Œä¸€æ—¦ç¼–è¯‘æˆäº†classå­—èŠ‚ç æ–‡ä»¶åï¼Œä¸€åˆ‡éƒ½æ‰“å›åŸå½¢äº†ï¼Œæ³›å‹ä¿¡æ¯ä¼šè¢«æ“¦é™¤ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠJAVAçš„æ³›å‹ç§°ä¸ºä¼ªæ³›å‹ï¼Œè·ŸC#ç­‰è¯­è¨€çš„çœŸæ³›å‹æœ‰ç€æœ¬è´¨åŒºåˆ«ï¼Œåœ¨C#ä¸­ï¼ŒList&lt;Integer&gt;å’ŒList&lt;String&gt; å°±æ˜¯ä¸¤ç§ä¸åŒçš„ç±»å‹ å¦‚ä¸‹é¢å­—èŠ‚ç æ–‡ä»¶çš„æœ€åä¸€è¡Œinvokevirtualå‘½ä»¤çš„æ–¹æ³•æè¿°ç¬¦Method setT:(Ljava/lang/Object;)Vï¼Œå¯çŸ¥æ³›å‹ç±»å‹å·²ç»è¢«æ“¦é™¤æˆäº†Objectç±»å‹ï¼Œä¹Ÿå°±æ˜¯åœ¨å­—èŠ‚ç å±‚é¢å®é™…ä¸Šä¸æˆ‘ä»¬ç›´æ¥ç”¨Objectæ¥å®ç°æ˜¯ä¸€æ ·çš„ 1234567890: new #3 // class com/sunshine/common/test/Plant 3: dup 4: invokespecial #4 // Method &quot;&lt;init&gt;&quot;:()V 7: astore_1 8: aload_1 9: new #5 // class com/sunshine/common/test/Apple 12: dup 13: invokespecial #6 // Method com/sunshine/common/test/Apple.&quot;&lt;init&gt;&quot;:()V 16: invokevirtual #7 // Method setT:(Ljava/lang/Object;)V æ³›å‹è¿›é˜¶ä½¿ç”¨ &lt;T extends ?&gt; å®šä¹‰æ³›å‹ç±»å¤´ä¸€æ¬¡çœ‹åˆ°ä¸Šé¢ä¸¤ä¸ªç¬¦å·ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹æ‡µé€¼ï¼Ÿå®ƒä»¬åœ¨ä»£ç é‡Œä¹Ÿéå¸¸å¸¸è§ï¼Œé‚£ä¹ˆå®ƒä»¬ç©¶ç«Ÿæ˜¯è¡¨ç¤ºä»€ä¹ˆæ„æ€å‘¢ï¼Ÿè¿˜æ˜¯é€šè¿‡ä¸Šæ–‡çš„plantç›˜å­æ¥ä¸¾ä¾‹å§ï¼Œä¸¾ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬åªå¸Œæœ›è¿™ä¸ªç›˜å­ç”¨æ¥è£…ä¸€äº›æ°´æœï¼Œè€Œä¸å¸Œæœ›å®ƒè¢«ç”¨æ¥è£…è‚‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿç°åœ¨çš„æƒ…å†µæ˜¯ï¼Œå®ƒæ—¢å¯ä»¥å®ä¾‹åŒ–æˆä¸€ä¸ªè£…é¦™è•‰çš„ç›˜å­ï¼Œä¹Ÿå¯ä»¥è¢«å®ä¾‹åŒ–æˆä¸€ä¸ªè£…è‚‰çš„ç›˜å­ 12Plant&lt;Apple&gt; applePlant = new Plant&lt;&gt;(); // Plant&lt;Meat&gt; meatPlant = new Plant&lt;&gt;(); // éƒ½æ˜¯Okçš„ ç°åœ¨è®©æˆ‘ä»¬æ¥é‡æ–°è®¾è®¡ä¸€ä¸ªç›˜å­ç±»ï¼Œé€šè¿‡&lt;T extends Firut&gt;æ¥é™åˆ¶æ³›å‹ï¼Œå…¶å®å¦‚æœæˆ‘ä»¬ç›´æ¥ç”¨&lt;T&gt;çš„ç¼–è¯‘æˆå­—èŠ‚ç åä¹Ÿä¼šè‡ªåŠ¨ç¼–è¯‘æˆ&lt;T extends Object&gt; 123456789101112public class FirutPlant &lt;T extends Firut&gt;&#123; private T t; public T getT() &#123; return t; &#125; public void setT(T t) &#123; this.t = t; &#125;&#125; ä½¿ç”¨ 123FirutPlant&lt;Apple&gt; appleFirutPlant = new FirutPlant&lt;&gt;(); // OKFirutPlant&lt;Firut&gt; firutPlant = new FirutPlant&lt;&gt;(); // OKFirutPlant&lt;Meat&gt; meatFirutPlant = new FirutPlant&lt;&gt;(); // ç¼–è¯‘æ— æ³•é€šè¿‡ é€šè¿‡ä¸Šé¢çš„ä»£ç å¯çŸ¥æˆ‘ä»¬æˆåŠŸçš„é™åˆ¶äº†æ³›å‹ï¼Œæ°´æœç›˜å­å°±åªèƒ½è£…æ°´æœï¼Œç›˜å­ä¸­çš„ç±»å‹åªèƒ½æ˜¯æ°´æœæˆ–åˆ™å®ƒçš„å­ç±»å‹ã€‚ &lt;? extends T&gt; &lt;? super T&gt;æ³¨æ„è¿™é‡Œçš„Tæ˜¯æ³›å‹å‚æ•°ï¼Œè·Ÿä¸Šé¢çš„ Tä¸ä¸€æ · çœ‹å®Œä¸Šé¢çš„ &lt;T extends ?&gt;ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥çœ‹&lt;? extends T&gt; &lt;? super T&gt;ï¼Œå¯èƒ½è¿™é‡Œä½ ä¼šéå¸¸ç–‘æƒ‘ï¼Œå“‡ è¿™ä¸¤ä¸ªæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå…¶å®ç®€å•ç†è§£çš„è¯ï¼Œ&lt;T extends ?&gt;æ˜¯åœ¨ç±»æ–‡ä»¶å±‚é¢å°±é™åˆ¶äº†æ³›å‹çš„èŒƒå›´ï¼Œè€Œ&lt;? extends T&gt; &lt;? super T&gt;æ˜¯åœ¨ä½¿ç”¨æ³›å‹çš„æ—¶å€™å†å»åšé™åˆ¶ã€‚æ˜ç™½äº†è¿™ä¸ªä¹‹åæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹ä¸‹&lt;? extends T&gt; &lt;? super T&gt;çš„ä½¿ç”¨ã€‚ è®©æˆ‘ä»¬å›åˆ°Firut.class 123456789101112public class Plant &lt;T&gt;&#123; private T t; public T getT() &#123; return t; &#125; public void setT(T t) &#123; this.t = t; &#125;&#125; æˆ‘ä»¬ç°åœ¨ä¸åœ¨å®šä¹‰æ³›å‹ç±»çš„æ—¶å€™åšé™åˆ¶ï¼Œ(ä½¿ç”¨&lt;T&gt;ï¼Œå…¶å®è¿™é‡Œè¿˜æ˜¯ç›¸å½“äº&lt;T extends Object&gt;)ï¼Œè€Œæ˜¯åœ¨ä½¿ç”¨çš„æ˜¯å»åšé™åˆ¶ ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹&lt;? extends T&gt;çš„ä½¿ç”¨ 12345678Plant&lt;Apple&gt; applePlant = new Plant&lt;Apple&gt;();applePlant.setT(new Apple());// ä½¿ç”¨ &lt;? extends T&gt;Plant&lt;? extends Firut&gt; plant = applePlant;plant.setT(new Apple()); // æ— æ³•å­˜ ç¼–è¯‘æŠ¥é”™plant.setT(new Firut()); // æ— æ³•å­˜ ç¼–è¯‘æŠ¥é”™Firut apple = plant.getT(); // å¯ä»¥è·å– å¯ä»¥çœ‹åˆ°å½“&lt;? extends T&gt;åšä¸ºæ¥æ”¶å‚æ•°æ—¶ï¼Œå› ä¸ºå…¶å¿…ç„¶æ˜¯Firutçš„å­ç±»ï¼Œè¿™é‡Œå®ä¾‹ç±»å‹æ˜¯Appleï¼Œæ‰€ä»¥getT()æ–¹æ³•ä»ç„¶å¯ä»¥ä½¿ç”¨ï¼Œå› ä¸ºä¼šè¿›è¡Œä¸€æ¬¡éšå¼çš„ç±»å‹è½¬æ¢ï¼ˆå‘ä¸Šè½¬å‹æ˜¯å®‰å…¨çš„ï¼‰ï¼Œä½†æ˜¯setT()æ–¹æ³•æ˜¯å¤±æ•ˆçš„ï¼Œè¿™æ˜¯å› ä¸ºç¼–è¯‘å™¨ä¸èƒ½ç¡®å®šä½ ä¸€å®šä¼šå¾€é‡Œé¢æ·»åŠ Appleç±»å‹ï¼Œå› ä¸ºä½ è¿˜å¯ä»¥å¾€é‡Œé¢æ·»åŠ Bananaç±»å‹ï¼Œæ˜¾ç„¶Bananaç±»å‹æ— æ³•å¼ºè½¬Appleç±»å‹ï¼Œæ‰€ä»¥è¿™é‡Œçš„setT()æ–¹æ³•æ˜¯å¤±æ•ˆçš„ ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹&lt;? super T&gt;çš„ä½¿ç”¨æœ‰äº†ä¸Šé¢&lt;? extends T&gt;çš„ä½¿ç”¨ç»éªŒï¼Œé¡¾æ˜æ€è®®ï¼Œ&lt;? super T&gt;å¿…ç„¶è¡¨ç¤ºTçš„å…¨éƒ¨çˆ¶ç±»å‹ï¼Œè¿˜æ˜¯å†æ¥çœ‹ä¸‹&lt;? super T&gt;çš„ä½¿ç”¨å§ 12345678Plant&lt;Firut&gt; firutPlant = new Plant&lt;&gt;();Plant&lt;? super Apple&gt; plant = firutPlant;plant.setT(new Apple()); // å¯ä»¥å­˜æˆåŠŸï¼Œä¸è¿‡è¿™é‡Œåªèƒ½å­˜ Appleç±»å‹Apple apple = plant.getT(); // ç¼–è¯‘æŠ¥é”™Firut firut = firutPlant.getT(); ä¸Šé¢å¯ä»¥å­˜æˆåŠŸçš„åŸå› å’Œä¸Šé¢&lt;? extends T&gt;å¯ä»¥å–æˆåŠŸçš„åŸå› ä¸€æ ·ï¼Œä¹Ÿæ˜¯å› ä¸ºå­˜åœ¨ä¸€ä¸ªéšå¼çš„å‘ä¸Šè½¬å‹ï¼Œè€Œè·å–å¤±è´¥çš„åŸå›  ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼Œå› ä¸ºå®é™…ç±»å‹è‚¯å®šæ˜¯Appleçš„çˆ¶ç±»ï¼ˆè¿™é‡Œæ˜¯Firutï¼‰ï¼Œæ‰€ä»¥è¦å°†Firutè½¬æˆAppleæ˜¾ç„¶æ˜¯ä¸å¯è¡Œçš„ï¼ &lt;?&gt;&lt;?&gt;å…¶å®ç­‰ä»·ä¸&lt;? extends Object&gt;ï¼Œè¿™æ ·å­æˆ‘ç›¸ä¿¡å°±æ¯”è¾ƒå¥½ç†è§£äº†ï¼Œè·Ÿ&lt;? extends T&gt;ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å–å¯ä»¥ï¼Œå­˜è¢«é™åˆ¶ &lt;T&gt;ä¸€èˆ¬éƒ½æ˜¯åœ¨å®šä¹‰æ³›å‹ç±»æˆ–åˆ™æ³›å‹æ–¹æ³•æ—¶å‡ºç°ï¼Œå®é™…ä½¿ç”¨æ—¶éƒ½ä»¥?æˆ–å…·ä½“ç±»å‹æ›¿ä»£T Type ä¸ Class çš„åŒºåˆ«å’Œè”ç³»è¯´èµ·æ³›å‹ï¼Œä¸å¾—ä¸æJDKåœ¨1.5ä¹‹åå¼•å…¥çš„Typeç±»å‹ï¼Œæ˜¾ç„¶Typeæ˜¯Javaä¸ºäº†å®ç°æ³›å‹è€Œå¼•å…¥çš„ã€‚é‚£ä¹ˆTypeåˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Œå®ƒè¡¨ç¤ºçš„èŒƒå›´æœ‰å¤šå¤§ï¼Ÿå…¶å®æˆ‘ä»¬å¯ä»¥ç›´æ¥ç†è§£æŠŠClasså½“æˆæ˜¯Typeçš„å­é›†ï¼ŒClasså¯¹åº”ç€jdk1.5ä¹‹å‰ä¸æ˜¯æ³›å‹çš„åŸå§‹ç±»å‹ Typeä¸‹åŒ…å«äº†å‡ ç§ä¸åŒçš„ç±»å‹ Class åŸå§‹ç±»å‹ï¼Œæˆ‘è¿™é‡Œç›´æ¥ç†è§£æˆæˆ‘ä»¬å¸¸ç”¨çš„Classç±»å‹ï¼ŒClassæ˜¯Typeçš„ç›´æ¥å­ç±» ParameterizedType å‚æ•°åŒ–ç±»å‹ç±»ä¼¼ List&lt;String&gt; list è·å–listçš„ç±»å‹ TypeVariable ç±»ä¼¼ T t GenericArrayType ç±»ä¼¼ List&lt;String&gt;[] æˆ–åˆ™ List&lt;T&gt; [] GenericArrayType æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•getGenericComponentTypeï¼Œç”¨æˆ·è¿”å›ParameterizedTypeæˆ–åˆ™TypeVariableç±»å‹ WildcardType ç±»ä¼¼ &lt;? super T&gt; è¦å¾—åˆ°è¿™ä¸ªç±»å‹ï¼Œé¦–å…ˆéœ€è¦å¾—åˆ°ParameterizedTypeç±»å‹ï¼Œç„¶åé€šè¿‡getActualTypeArgumentsæ–¹æ³•è·å–WildcardTypeç±»å‹ è¯´äº†è¿™ä¹ˆå¤šï¼Œè¿˜æ˜¯é€šè¿‡å®é™…çš„ä»£ç æ¥è¯¦ç»†è§£é‡Šå§ 123456789public class TypeTest &#123; public void testOne(Plant&lt;Apple&gt; plant, Plant&lt;Apple&gt; [] plants, Plant&lt;? extends Apple&gt; applePlant) &#123; &#125; public &lt;T&gt; void testOne(T t) &#123; &#125;&#125; å†™æ®µæµ‹è¯•ä»£ç  12345678910111213141516171819202122232425262728293031323334353637Method [] methods = TypeTest.class.getMethods();for (Method method : methods) &#123; if (method.getName().equals("testOne")) &#123; Type [] parameterTypes = method.getGenericParameterTypes(); System.out.println("methodOne start --------&gt; "); for (Type type : parameterTypes) &#123; if (type instanceof Class) &#123; System.out.println("Class ---- " + type.getTypeName()); &#125; if (type instanceof ParameterizedType) &#123; System.out.println("ParameterizedType ---- " + type.getTypeName()); Type ytpe3[] = ((ParameterizedType) type).getActualTypeArguments(); for (Type type2 : ytpe3) &#123; if (type2 instanceof WildcardType) &#123; System.out.println("ParameterizedType-WildcardType ---- " + type2.getTypeName()); &#125; &#125; &#125; if (type instanceof GenericArrayType) &#123; System.out.println("GenericArrayType ---- " + type.getTypeName()); Type type2 = ((GenericArrayType) type).getGenericComponentType(); &#125; if (type instanceof TypeVariable) &#123; System.out.println("TypeVariable ---- " + type.getTypeName()); &#125; &#125; &#125; else if (method.getName().equals("testTwo")) &#123; Type [] parameterTypes = method.getGenericParameterTypes(); System.out.println("methodTwo start --------&gt; "); for (Type type : parameterTypes) &#123; if (type instanceof TypeVariable) &#123; System.out.println("TypeVariable ---- " + type.getTypeName()); &#125; &#125; &#125;&#125; è¾“å‡º 1234567methodTwo start --------&gt; TypeVariable ---- TmethodOne start --------&gt; ParameterizedType ---- com.sunshine.common.test.Plant&lt;com.sunshine.common.test.Apple&gt;GenericArrayType ---- com.sunshine.common.test.Plant&lt;com.sunshine.common.test.Apple&gt;[]ParameterizedType ---- com.sunshine.common.test.Plant&lt;? extends com.sunshine.common.test.Apple&gt;ParameterizedType-WildcardType ---- ? extends com.sunshine.common.test.Apple ä»€ä¹ˆæƒ…å†µå¯ä»¥æ‹¿åˆ°æ³›å‹ç±»å‹å…ˆçœ‹å¯ä»¥æ‹¿åˆ°æ³›å‹çš„æƒ…å½¢ï¼Œä¸ä¸Šé¢çš„ä¾‹å­ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥è·å–æ–¹æ³•å…¥å‚ï¼Œè¶…ç±»çš„å‚æ•°åŒ–ç±»å‹ï¼Œä¸¾ä¸ªä¾‹å­ 123456789101112131415class SuperPlant extend Plant&lt;Apple&gt; &#123; public void addAll(List&lt;Apple&gt; apples) &#123; // do something &#125; public static void main(String[] args) &#123; // è·å–çˆ¶ç±»å‚æ•°åŒ–ç±»å‹ Type type = SuperPlant.class.getGenericSuperclass(); Method[] methods = SuperPlant.class.getMethods(); for (Method method : methods) &#123; // è·å–æ–¹æ³•å‚æ•°åŒ–ç±»å‹ Type[] types = method.getGenericParameterTypes(); &#125; &#125;&#125; å¯ä»¥å‘ç°ä»¥ä¸Šä»£ç æ˜¯å¯ä»¥è·å–åˆ°æ³›å‹ç±»å‹ã€‚é€šè¿‡getGenericSuperclassè·å–åˆ°çˆ¶ç±»çš„å‚æ•°åŒ–ç±»å‹ï¼Œmethodçš„getGenericParameterTypesè·å–åˆ°å…¥å‚çš„å‚æ•°åŒ–ç±»å‹æ•°ç»„ã€‚ å†çœ‹ä¸€ç§æƒ…å†µ1234public void testMethod() &#123; Plant&lt;Firut&gt; firutPlant = new Plant&lt;&gt;(); // è¿™é‡Œå¯ä»¥æ‹¿åˆ° firutPlant å¯¹è±¡çš„æ³›å‹å—?&#125; ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ˜¯æ‹¿ä¸åˆ° firutPlant çš„æ³›å‹çš„ï¼Œå› ä¸ºJAVA åœ¨å°†å…¶ç¼–è¯‘æˆå­—èŠ‚ç çš„æ—¶å€™ï¼Œå®é™…ä¸Šä¼šå˜æˆ Plant&lt;Object&gt;ç±»å‹ï¼Œæ³›å‹ä¼šè¢«æ“¦é™¤ã€‚ æ‰€ä»¥æˆ‘ä»¬å…¶å®æ˜¯æ— æ³•åœ¨è¿è¡Œæ—¶é€šè¿‡æ³›å‹å¯¹è±¡æœ¬èº«æ‹¿åˆ°æ³›å‹ç±»å‹çš„ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰é»‘ç§‘æŠ€å¯ä»¥æ‹¿åˆ°è¿è¡Œæ—¶æ³›å‹æœ¬èº«çš„æ³›å‹ä¿¡æ¯ï¼Ÿä¸Šé¢æœ‰æåˆ°ï¼Œæˆ‘ä»¬æ‹¿æ³›å‹å¯ä»¥é€šè¿‡å­ç±»æ¥è·å–çˆ¶ç±»çš„æ³›å‹æˆ‘ä»¬ä¾æ®è¿™ä¸ªæ€è·¯å°†ä¸Šé¢ä¾‹å­ä¿®æ”¹ä¸€ä¸‹ 123public void testMethod() &#123; Type type = new Plant&lt;Firut&gt;() &#123;&#125;.getClass().getGenericSuperclass();&#125; å…¶å®å°±æ˜¯å°†Plantæ”¹æˆäº†åŒ¿åç±»æ–¹å¼å®ç°ï¼Œè¿™ç§æ–¹å¼å¯ä»¥æ‹¿åˆ°Plantçš„æ³›å‹ä¿¡æ¯å—ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„è¿™é‡Œé€šè¿‡getGenericSuperclassæ‹¿åˆ°çš„å°±æ˜¯Plant çš„æ³›å‹ç±»å‹ä¿¡æ¯ã€‚å…¶å®è¿™ç§æ–¹å¼åœ¨å¾ˆå¤šæ¡†æ¶æºç é‡Œå¾ˆå¸¸è§ï¼Œé€šè¿‡åŒ¿åç±»æ–¹å¼è·å–å‚æ•°ç±»å‹ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸‹Gsonçš„TypeTokençš„å®ç°ï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„åŸç†ã€‚]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
      </categories>
      <tags>
        <tag>javaåŸºç¡€</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Javaå­—èŠ‚ç æ–¹æ³•è¡¨]]></title>
    <url>%2F2019%2F04%2F25%2FJava%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%B9%E6%B3%95%E8%A1%A8%2F</url>
    <content type="text"><![CDATA[å¼•è¨€å› ä¸ºå­—æ®µè¡¨å’Œæ–¹æ³•è¡¨çš„ç»“æ„ç±»ä¼¼ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥åˆ†æJavaå­—èŠ‚ç çš„æ–¹æ³•è¡¨å†…å®¹ï¼Œç†è§£äº†æ–¹æ³•è¡¨ï¼Œè‡ªç„¶å°±ç†è§£äº†å­—æ®µè¡¨ æ–¹æ³•è¡¨æ–¹æ³•è¡¨åœ¨Classæ–‡ä»¶ä¸­çš„ä½ç½®æ˜¯åœ¨å­—æ®µè¡¨ä¹‹åçš„ï¼Œå…·ä½“çš„ç»“æ„æˆ‘ä»¬æ ¹æ®ä¸‹è¡¨å†æ¥å›é¡¾ä¸€ä¸‹ ç±»å‹ åç§° æ•°é‡ u2 access_flas 1 u2 name_index 1 u2 descriptor_index 1 u2 attributes_count 1 attribute_info å±æ€§è¡¨ attributes_count è¿˜æ˜¯è·Ÿä¸Šç¯‡æ–‡ç« ä¸€æ ·ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªç®€å•çš„Javaç±» 1234567891011121314151617181920public class Test &#123; public String sayHello() &#123; String sayStr = "hello world"; return sayStr; &#125; public static void main(String[] args) &#123; Test test = new Test(); System.out.println(test.sayHello()); &#125;&#125; ä½¿ç”¨javapç¿»è¯‘å­—èŠ‚ç æ–‡ä»¶ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206public class com.ymm.agent.Test minor version: 0 major version: 52 flags: (0x0021) ACC_PUBLIC, ACC_SUPER this_class: #3 // com/ymm/agent/Test super_class: #8 // java/lang/Object interfaces: 0, fields: 0, methods: 3, attributes: 1Constant pool: #1 = Methodref #8.#27 // java/lang/Object.&quot;&lt;init&gt;&quot;:()V #2 = String #28 // hello world #3 = Class #29 // com/ymm/agent/Test #4 = Methodref #3.#27 // com/ymm/agent/Test.&quot;&lt;init&gt;&quot;:()V #5 = Fieldref #30.#31 // java/lang/System.out:Ljava/io/PrintStream; #6 = Methodref #3.#32 // com/ymm/agent/Test.sayHello:()Ljava/lang/String; #7 = Methodref #33.#34 // java/io/PrintStream.println:(Ljava/lang/String;)V #8 = Class #35 // java/lang/Object #9 = Utf8 &lt;init&gt; #10 = Utf8 ()V #11 = Utf8 Code #12 = Utf8 LineNumberTable #13 = Utf8 LocalVariableTable #14 = Utf8 this #15 = Utf8 Lcom/ymm/agent/Test; #16 = Utf8 sayHello #17 = Utf8 ()Ljava/lang/String; #18 = Utf8 sayStr #19 = Utf8 Ljava/lang/String; #20 = Utf8 main #21 = Utf8 ([Ljava/lang/String;)V #22 = Utf8 args #23 = Utf8 [Ljava/lang/String; #24 = Utf8 test #25 = Utf8 SourceFile #26 = Utf8 Test.java #27 = NameAndType #9:#10 // &quot;&lt;init&gt;&quot;:()V #28 = Utf8 hello world #29 = Utf8 com/ymm/agent/Test #30 = Class #36 // java/lang/System #31 = NameAndType #37:#38 // out:Ljava/io/PrintStream; #32 = NameAndType #16:#17 // sayHello:()Ljava/lang/String; #33 = Class #39 // java/io/PrintStream #34 = NameAndType #40:#41 // println:(Ljava/lang/String;)V #35 = Utf8 java/lang/Object #36 = Utf8 java/lang/System #37 = Utf8 out #38 = Utf8 Ljava/io/PrintStream; #39 = Utf8 java/io/PrintStream #40 = Utf8 println #41 = Utf8 (Ljava/lang/String;)V&#123; public com.ymm.agent.Test(); descriptor: ()V flags: (0x0001) ACC_PUBLIC Code: stack=1, locals=1, args_size=1 0: aload_0 1: invokespecial #1 // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V 4: return LineNumberTable: line 9: 0 LocalVariableTable: Start Length Slot Name Signature 0 5 0 this Lcom/ymm/agent/Test; public java.lang.String sayHello(); descriptor: ()Ljava/lang/String; flags: (0x0001) ACC_PUBLIC Code: stack=1, locals=2, args_size=1 0: ldc #2 // String hello world 2: astore_1 3: aload_1 4: areturn LineNumberTable: line 12: 0 line 13: 3 LocalVariableTable: Start Length Slot Name Signature 0 5 0 this Lcom/ymm/agent/Test; 3 2 1 sayStr Ljava/lang/String; public static void main(java.lang.String[]); descriptor: ([Ljava/lang/String;)V flags: (0x0009) ACC_PUBLIC, ACC_STATIC Code: stack=2, locals=2, args_size=1 0: new #3 // class com/ymm/agent/Test 3: dup 4: invokespecial #4 // Method &quot;&lt;init&gt;&quot;:()V 7: astore_1 8: getstatic #5 // Field java/lang/System.out:Ljava/io/PrintStream; 11: aload_1 12: invokevirtual #6 // Method sayHello:()Ljava/lang/String; 15: invokevirtual #7 // Method java/io/PrintStream.println:(Ljava/lang/String;)V 18: return LineNumberTable: line 17: 0 line 18: 8 line 19: 18 LocalVariableTable: Start Length Slot Name Signature 0 19 0 args [Ljava/lang/String; 8 11 1 test Lcom/ymm/agent/Test;&#125;SourceFile: &quot;Test.java&quot; é€šè¿‡ä¸Šæ–‡çš„interfaces: 0, fields: 0, methods: 3, attributes: 1ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“è¯¥æ–‡ä»¶ä¸€å…±åŒ…å«3ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«å¯¹åº”ç€æ— å‚æ„é€ ,sayHello,mainä¸‰ä¸ªæ–¹æ³• å¥½äº†ï¼Œç°åœ¨è®©æˆ‘ä»¬ç›´æ¥ç•¥è¿‡å‰é¢çš„ä¸€å¤§æ¨å¸¸é‡æ± é¡¹ï¼Œ ç›´æ¥é˜…è¯»æˆ‘ä»¬è‡ªå·±å†™çš„sayHelloæ–¹æ³•çš„å­—èŠ‚ç å†…å®¹ 1234567891011121314151617181920212223242526272829303132public java.lang.String sayHello(); descriptor: ()Ljava/lang/String; /* æ–¹æ³•æè¿°ç¬¦ */ flags: (0x0001) ACC_PUBLIC /* è®¿é—®æ ‡è¯† */ Code: /* codeå±æ€§ ä¹Ÿå°±æ˜¯æˆ‘ä»¬å†™çš„å…·ä½“ä»£ç ç¿»è¯‘æˆçš„å­—èŠ‚ç æŒ‡ä»¤å†…å®¹ */ stack=1, locals=2, args_size=1 /* åˆ†åˆ«æŒ‡æ“ä½œæ•°æ ˆæ·±åº¦ï¼›æœ¬åœ°å˜é‡æ‰€éœ€çš„å­˜å‚¨ç©ºé—´ï¼ˆslotä¸ºå•ä½ï¼‰ï¼›å‚æ•°ä¸ªæ•° */ 0: ldc #2 // String hello world /*å°†ä¸€ä¸ªå¸¸é‡åŠ è½½åˆ°æ“ä½œæ•°æ ˆ*/ 2: astore_1 /* å°†ä¸€ä¸ªæ•°å€¼ä»æ“ä½œæ•°æ ˆå­˜å‚¨åˆ°å±€éƒ¨å˜é‡è¡¨ */ 3: aload_1 /* å°†ä¸€ä¸ªæ•°å€¼ä»å±€éƒ¨å˜é‡è¡¨åŠ è½½åˆ°æ“ä½œæ•°æ ˆ */ 4: areturn /* å°†æ ˆé¡¶ç¬¬ä¸€ä¸ªå…ƒç´ è¿”å› */ LineNumberTable: /* å­—èŠ‚ç ä¸javaä»£ç è¡Œæ•°å¯¹åº”å…³ç³» ä¸€èˆ¬ç”¨äºè°ƒè¯• */ line 12: 0 line 13: 3 LocalVariableTable: /* å±€éƒ¨å˜é‡è¡¨ */ Start Length Slot Name Signature 0 5 0 this Lcom/ymm/agent/Test; 3 2 1 sayStr Ljava/lang/String; æ ¹æ®ä¸Šè¡¨æˆ‘ä»¬çŸ¥é“æ–¹æ³•è¡¨çš„ç¬¬ä¸€ä¸ªå†…å®¹çš„æ˜¯access_flasï¼Œå ä¸€ä¸ªå­—èŠ‚ã€‚è¡¨ä¸­çš„access_flaså…¶å®å°±å¯¹åº”ç€ä¸Šæ–‡ä¸­çš„ flags: (0x0001) ACC_PUBLICï¼Œæ ‡è¯†è¿™ä¸ªæ–¹æ³•æ˜¯publicçš„ï¼Œæ¥ä¸‹åœ¨çš„name_indexå’Œdescriptor_indexï¼Œåœ¨ä¸Šæ–‡ä¸­çš„ä½“ç°åˆ†åˆ«å¯¹åº”ç€sayHelloå’Œ()Ljava/lang/String;ã€‚ è¿™é‡Œè§£é‡Šä¸€ä¸‹æè¿°ç¬¦çš„æ¦‚å¿µï¼Œåœ¨ä»‹ç»Classæ–‡ä»¶ç»“æ„çš„æ–‡ç« ä¸­æœ‰æåˆ°ï¼Œè¿™é‡Œå†æä¸€é: æè¿°ç¬¦çš„ä½œç”¨æ˜¯ç”¨æ¥æè¿°å­—æ®µçš„æ•°æ®ç±»å‹ï¼Œæ–¹æ³•çš„å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼ï¼Œæ ¹æ®æè¿°ç¬¦è§„åˆ™ï¼ŒåŸºæœ¬æ•°æ®ç±»å‹ï¼ˆbyte,char,int,long,float,double,short,booleanï¼‰ä»¥åŠä»£è¡¨æ— è¿”å›å€¼çš„voidç±»å‹éƒ½ç”¨ä¸€ä¸ªå¤§å†™å­—ç¬¦æ¥è¡¨ç¤ºï¼Œè€Œå¯¹è±¡ç±»å‹åˆ™ç”¨LåŠ å¯¹è±¡çš„å…¨é™å®šåæ¥è¡¨ç¤º æœ€é‡è¦çš„å†…å®¹å…¶å®è¿˜æ˜¯åœ¨attribute_infoå±æ€§è¡¨ä¸­çš„codeå†…å®¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å†™çš„å…·ä½“ä»£ç ç¿»è¯‘æˆçš„å­—èŠ‚ç æŒ‡ä»¤å†…å®¹ï¼Œè¿™å—å†…å®¹æ˜¯æˆ‘ä»¬é˜…è¯»å­—èŠ‚ç æ–‡ä»¶çš„é‡ä¸­ä¹‹é‡ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥é˜…è¯»ä¸€ä¸‹ä¸Šæ–‡çš„å­—èŠ‚ç å†…å®¹ ldc #2 å°†å¸¸é‡æ± ä¸­ç´¢å¼•ä¸º2çš„å­—ç¬¦ä¸²åŠ è½½åˆ°æ“ä½œæ•°æ ˆé¡¶ astore_1 å°†ä¸€ä¸ªæ•°å€¼ä»æ“ä½œæ•°æ ˆå­˜å‚¨åˆ°å±€éƒ¨å˜é‡è¡¨ aload_1 å°†ä¸€ä¸ªæ•°å€¼ä»å±€éƒ¨å˜é‡è¡¨åŠ è½½åˆ°æ“ä½œæ•°æ ˆ areturn å°†æ ˆé¡¶ç¬¬ä¸€ä¸ªå…ƒç´ è¿”å› å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„å››ä¸ªæ­¥éª¤çš„æ“ä½œå…¶å®éƒ½æ˜¯åŸºäºæ ˆçš„æ“ä½œï¼Œè¿™é‡Œæä¸€ä¸‹javaè™šæ‹Ÿæœºæ ˆçš„æ ˆå¸§ç»“æ„ å…³äºå­—èŠ‚ç å­ä»¤é›†å¯ä»¥å‚è€ƒjavaå­—èŠ‚ç å­ä»¤é›† æœ‰è¶£çš„ä¾‹å­ â€”ä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªæœ‰è¶£çš„ä¾‹å­ï¼Œå¤§å®¶æ€è€ƒä¸€ä¸‹è¿™ä¸ªæ‰§è¡Œè¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼ä¼šæ˜¯å¤šå°‘ï¼Ÿ 12345678910111213141516171819202122232425262728public class Test &#123; public int inc() &#123; int x; try &#123; x = 1; return x; &#125; catch (Exception e) &#123; x = 2; return x; &#125; finally &#123; x = 3; &#125; &#125;&#125; ä»£ç éå¸¸ç®€å•ï¼Œæˆ‘æƒ³å¤§å®¶åº”è¯¥ä¹Ÿéƒ½çŸ¥é“æ­£ç¡®ç­”æ¡ˆï¼Œå½“æ²¡æœ‰å‡ºç°å¼‚å¸¸çš„æ—¶å€™ï¼Œè¿”å›å€¼ä¸º1ï¼Œå‡ºç°å¼‚å¸¸çš„è¯åˆ™ä¸º2ï¼ˆå½“ç„¶è¿™é‡Œä¸ä¼šæŠ›å¼‚å¸¸ï¼‰ã€‚å¯æ˜¯å¦‚æœæˆ‘ä»¬åœ¨finallyå¿«é‡ŒåŠ å¥ä»£ç System.out.prinln(&quot;do it&quot;)ï¼Œç„¶åå†æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œå…¶å®æ˜¯å¯ä»¥çœ‹åˆ°do itè¢«æ‰“å°äº†ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ‰§è¡Œreturnä¹‹å‰ï¼Œfinallyå¿«ä¸­çš„ä»£ç æ˜¯è¢«æ‰§è¡Œäº†çš„ï¼Œé‚£ä¹ˆè¿™é‡Œå°±æœ‰ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜äº†ï¼Œä¸ºä½•è¿”å›ä»ç„¶æ˜¯2è€Œä¸æ˜¯3å‘¢ï¼Ÿ ä¸‹é¢æˆ‘ä»¬å°±ä»å­—èŠ‚ç æ–‡ä»¶ä¸­æ¥æ‰¾å‡ºç­”æ¡ˆ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566public int inc(); descriptor: ()I flags: (0x0001) ACC_PUBLIC Code: stack=1, locals=5, args_size=1 0: iconst_1 // å°†int = 1çš„å€¼å‹å…¥æ ˆé¡¶ 1: istore_1 // å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå­˜å…¥ä½ç½®ä¸º1çš„å±€éƒ¨å˜é‡è¡¨ 2: iload_1 // ä»ä½ç½®ä¸º1çš„å±€éƒ¨å˜é‡ä¸­å–å‡ºå…ƒç´ å‹å…¥æ ˆé¡¶ 3: istore_2 // å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå­˜å…¥ä½ç½®2çš„å±€éƒ¨å˜é‡ä¸­ 4: iconst_3 // å°†int = 3çš„å€¼å‹å…¥æ ˆé¡¶ ï¼ˆè¿™é‡Œæ‰§è¡Œfinallyå—ä¸­çš„ä»£ç äº†ï¼‰ 5: istore_1 // å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå­˜å…¥ä½ç½®1çš„å±€éƒ¨å˜é‡ä¸­ 6: iload_2 // ä»ä½ç½®ä¸º2çš„å±€éƒ¨å˜é‡ä¸­å–å‡ºå…ƒç´ å‹å…¥æ ˆé¡¶ 7: ireturn // è¿”å›æ ˆé¡¶å…ƒç´ 2 (å“ˆå“ˆå“ˆ çœ‹åˆ°æ²¡æœ‰ï¼Œè¿™é‡Œè¿”å›çš„æ˜¯2ï¼Œæ²¡æœ‰å¼‚å¸¸çš„è¯ï¼Œè¿™é‡Œæ–¹æ³•å°±è¿”å›äº†) 8: astore_2 // å°†æ ˆé¡¶çš„å¼‚å¸¸å¼•ç”¨ï¼Œå­˜å…¥ä½ç½®2çš„å±€éƒ¨å˜é‡ä¸­ ï¼ˆè¿™é‡Œå°±æ˜¯å¼‚å¸¸æ•è·çš„ä»£ç äº†ï¼‰ 9: iconst_2 // å°†int = 2çš„å€¼å‹å…¥æ ˆé¡¶ 10: istore_1 // å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå­˜å…¥ä½ç½®1çš„å±€éƒ¨å˜é‡ä¸­ 11: iload_1 // ä»ä½ç½®ä¸º1çš„å±€éƒ¨å˜é‡ä¸­å–å‡ºå…ƒç´ å‹å…¥æ ˆé¡¶ 12: istore_3 // å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå­˜å…¥ä½ç½®3çš„å±€éƒ¨å˜é‡ä¸­ 13: iconst_3 // å°†int = 3çš„å€¼å‹å…¥æ ˆé¡¶ 14: istore_1 // å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå­˜å…¥ä½ç½®1çš„å±€éƒ¨å˜é‡ä¸­ 15: iload_3 // ä»ä½ç½®ä¸º3çš„å±€éƒ¨å˜é‡ä¸­å–å‡ºå…ƒç´ å‹å…¥æ ˆé¡¶ 16: ireturn // è¿”å›æ ˆé¡¶å…ƒç´  2 17: astore 4 // å°†æ ˆé¡¶å¼‚å¸¸å¼•ç”¨å­˜å…¥ä½ç½®ä¸º4çš„å±€éƒ¨å˜é‡è¡¨ä¸­ 19: iconst_3 // å°†int = 3çš„å€¼å‹å…¥æ ˆé¡¶ 20: istore_1 // å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå­˜å…¥ä½ç½®1çš„å±€éƒ¨å˜é‡ä¸­ 21: aload 4 å°†ä½ç½®ä¸º4çš„å±€éƒ¨å˜é‡å¼•ç”¨å‹å…¥æ ˆé¡¶ 23: athrow // å°†æ ˆé¡¶çš„å¼‚å¸¸æŠ›å‡º Exception table: // å¼‚å¸¸è¡¨ from to target type 0 4 8 Class java/lang/Exception 0 4 17 any 8 13 17 any 17 19 17 any å¦‚æœä½ å·²ç»çœ‹æ‡‚äº†ä¸Šé¢çš„å­—èŠ‚ç ï¼Œä½ åº”è¯¥ä¼šè±æœ—å¼€æœ—ã€‚åŸå› å…¶å®å°±æ˜¯åœ¨äºè¿™é‡Œå¼€è¾Ÿäº†ä¸¤ä¸ªå±€éƒ¨å˜é‡ï¼Œfinallyå—ä¸­çš„ä»£ç ä¹Ÿç¡®å®æ‰§è¡Œäº†ï¼Œåªæ˜¯å°†å˜é‡å­˜å…¥äº†å±€éƒ¨å˜é‡è¡¨ä¸­çš„å¦ä¸€ä¸ªä½ç½®ï¼Œå¹¶ä¸”é€šè¿‡è¿™ä¸ªä¾‹å­ï¼Œä¹Ÿå¯ä»¥å‘ç°ï¼Œæ— è®ºä»€ä¹ˆæƒ…å†µfinallyå—ä¸­çš„ä»£ç éƒ½ä¼šæ‰§è¡Œã€‚ å°¾è¨€å¥½äº†ï¼Œæœ¬æ–‡åˆ°è¿™é‡Œå°±å·®ä¸å¤šç»“æŸäº†ã€‚å¯¹äºå­—èŠ‚ç çš„æ¢ç´¢ä¸ªäººè§‰çš„è¿˜æ˜¯éå¸¸æœ‰æ„æ€çš„ï¼Œä¹‹ååº”è¯¥ä¹Ÿä¼šæ¢ç´¢æ›´å¤šæœ‰æ„æ€çš„ä¸œè¥¿]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
        <category>JVM</category>
        <category>javaå­—èŠ‚ç </category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>javaå­—èŠ‚ç </tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½¿ç”¨Java NIOå®ç°ä¸€ä¸ªHTTPæœåŠ¡å™¨]]></title>
    <url>%2F2019%2F04%2F19%2F%E4%BD%BF%E7%94%A8Java-NIO%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAHTTP%E6%9C%8D%E5%8A%A1%E5%99%A8%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ä¸€ç›´ä»¥æ¥éƒ½æƒ³å†™ä¸€ä¸ªè‡ªå·±çš„httpæœåŠ¡å™¨ï¼Œè¿™æ¬¡è¶ç€ç¨å¾®ç©ºé—²äº†ä¸€äº›ï¼Œèµ¶ç´§ç äº†ä¸€ä¸ªminiç‰ˆçš„ã€‚åœ¨è¿™é‡Œè·Ÿå¤§å®¶åˆ†äº«ä¸€ä¸‹ç¼–å†™çš„æ•´ä¸ªæ€è·¯ï¼Œæ€»ä½“æ¥è¯´ï¼Œæ•´ä¸ªåº”ç”¨éå¸¸ç®€å•ï¼Œç›®å‰ä¹Ÿåªæ˜¯å®ç°äº†æœ€åŸºæœ¬çš„é™æ€èµ„æºè®¿é—®ï¼Œä½†å¯¹äºæƒ³å­¦ä¹ Httpåè®®çš„åŒå­¦æ¥è¯´ï¼Œåº”è¯¥è¿˜æ˜¯æœ‰æ‰€å¸®åŠ© HTTPåè®®å…ˆç®€å•ä»‹ç»ä¸€ä¸‹HTTPåè®®ï¼ŒHTTPåè®®æ˜¯æ„å»ºäºTCP/IPåè®®ä¹‹ä¸Šçš„ä¸€ä¸ªåº”ç”¨å±‚åè®®ï¼Œå¹¶ä¸”æ˜¯æ— è¿æ¥æ— çŠ¶æ€çš„ã€‚ httpè¯·æ±‚æŠ¥æ–‡httpçš„è¯·æ±‚æŠ¥æ–‡ç”±ä¸‰éƒ¨åˆ†ç»„æˆ çŠ¶æ€è¡Œ &lt;method&gt; &lt;request-URL&gt; &lt;version&gt; methodåŒ…å«GETï¼ŒPOSTï¼ŒPUTï¼ŒDELETEç­‰ è¯·æ±‚å¤´ æ¶ˆæ¯ä¸»ä½“ ä¸‹é¢æ˜¯å…¸å‹çš„httpè¯·æ±‚æŠ¥æ–‡ç¤ºä¾‹ 123456789101112131415161718GET /static/home.html HTTP/1.1Host: localhost:8080Connection: keep-aliveCache-Control: max-age=0Upgrade-Insecure-Requests: 1User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.103 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3Accept-Encoding: gzip, deflate, brAccept-Language: zh-CN,zh;q=0.9 httpå“åº”æŠ¥æ–‡å“åº”æŠ¥æ–‡è·Ÿè¯·æ±‚æŠ¥æ–‡ç±»ä¼¼ï¼Œä¹Ÿç”±ä¸‰éƒ¨åˆ†ç»„æˆ çŠ¶æ€è¡Œ è¿™é‡Œéœ€è¦å…³æ³¨ä¸‹å“åº”çš„å„ä¸ªçŠ¶æ€æ‰€ä»£è¡¨çš„å«ä¹‰ï¼Œä»¥åŠæµè§ˆå™¨è¯†åˆ«è¿™äº›çŠ¶æ€ç ä¼šç›¸åº”çš„åšå“ªäº›äº‹æƒ… å“åº”å¤´ å“åº”æ­£æ–‡ 12345678HTTP/1.1 200 OKServer: cloud http v1.0Content-Type: text/html;charset=UTF-8&lt;html&gt;... ## åŠ¨æ‰‹ å‰é¢ç®€å•ä»‹ç»äº†ä¸€ä¸‹httpåè®®çš„åŸºæœ¬ä¿¡æ¯ï¼Œä¸‹é¢å°±æ˜¯æºç å®ç°äº†ï¼Œæˆ‘è¿™é‡Œç›´æ¥ä½¿ç”¨äº†Java NIOä½œä¸ºåº•å±‚é€šä¿¡æ”¯æ’‘ï¼Œåœ¨å®é™…çš„ç”Ÿäº§ä»£ç ä¸­ï¼Œå¤§å¤šä¼šé€‰æ‹©å°è£…è‰¯å¥½çš„nettyæ¥ä½œä¸ºç¨³å®šçš„åº•å±‚é€šä¿¡ è¿™é‡Œå…ˆæ”¾ä¸Šé¡¹ç›®æºç  CloudHttp å®šä¹‰Requestå’ŒResponse Request 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public class Request &#123; /** * method */ private String method; /** * httpåè®®ç‰ˆæœ¬ */ private String httpVersion; /** * è¯·æ±‚uri */ private String uri; /** * è¯·æ±‚ç›¸å¯¹è·¯å¾„ */ private String path; /** * è¯·æ±‚å¤´ä¿¡æ¯ */ private Map&lt;String, String&gt; headers; /** * è¯·æ±‚å‚æ•° */ private Map&lt;String, String&gt; attribute;&#125; Response 12345678910111213141516171819202122232425262728public class Response &#123; private Integer code; private String protocol = "HTTP/1.1"; private String msg; private Map&lt;String, String&gt; headers; private ByteArrayOutputStream outPutStream = new ByteArrayOutputStream(); public Response() &#123; this.code = HttpCode.STATUS_200.getCode(); this.msg = HttpCode.STATUS_200.getMsg(); headers = new HashMap&lt;&gt;(); headers.put("Content-Type", "text/html;charset=UTF-8"); headers.put("Server", "cloud http v1.0"); &#125;&#125; å®šä¹‰è¯·æ±‚å“åº”è§£æç±» HttpParser 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176public class HttpParser &#123; private final static Logger logger = LoggerFactory.getLogger(HttpParser.class); /** * &lt;p&gt;è§£æhttpè¯·æ±‚ä½“&lt;/p&gt; * * @param buffers * @return */ public static Request decodeReq(byte [] buffers) &#123; Request request = new Request(); if (buffers != null) &#123; String resString = new String(buffers); logger.info(resString); String[] headers = resString.trim().split("\r\n"); if (headers.length &gt; 0) &#123; String firstline = headers[0]; // æŒ‰ç©ºæ ¼åˆ†å‰²å­—ç¬¦ä¸² // è§£æ method uri åè®®ç‰ˆæœ¬ String mainInfo [] = firstline.split("\\s+"); request.setMethod(mainInfo[0]); try &#123; request.setUri(URLDecoder.decode(mainInfo[1], "UTF-8")); &#125; catch (UnsupportedEncodingException e) &#123; logger.error("error_HttpParser_URLDecode, uri = &#123;&#125;", mainInfo[1], e); &#125; request.setHttpVersion(mainInfo[2]); // è§£æheader Map&lt;String, String&gt; headersMap = new HashMap&lt;&gt;(); for (int i = 1; i &lt; headers.length; i++) &#123; String entryStr = headers[i]; String entry [] = entryStr.trim().split(":"); headersMap.put(entry[0].trim(), entry[1].trim()); &#125; request.setHeaders(headersMap); // è§£æå‚æ•° String uri = request.getUri(); Map&lt;String, String&gt; attribute = new HashMap&lt;&gt;(); request.setPath(uri); if (StringUtils.isNotEmpty(uri)) &#123; int indexOfParam = uri.indexOf("?"); if (indexOfParam &gt; 0) &#123; // è®¾ç½®path request.setPath(uri.substring(0, indexOfParam)); String queryString = uri.substring(indexOfParam + 1, uri.length()); String paramEntrys [] = queryString.split("&amp;"); for (String paramEntry : paramEntrys) &#123; String [] entry = paramEntry.split("="); if (entry.length &gt; 0) &#123; String key = entry[0]; String value = entry.length &gt; 1 ? entry[1] : ""; attribute.put(key, value); &#125; &#125; &#125; &#125; request.setAttribute(attribute); &#125; &#125; return request; &#125; /** * &lt;p&gt;è¿”å›httpå“åº”å­—èŠ‚æµ&lt;/p&gt; * * @param response * @return */ public static byte[] encodeResHeader(Response response) &#123; StringBuilder resBuild = new StringBuilder(); resBuild.append(response.getProtocol() + " " + response.getCode() + " " + response.getMsg()); resBuild.append("\r\n"); Map&lt;String, String&gt; headers = response.getHeaders(); headers.entrySet().forEach(entry -&gt; &#123; resBuild.append(entry.getKey()); resBuild.append(": "); resBuild.append(entry.getValue()); resBuild.append("\r\n"); &#125;); resBuild.append("\r\n"); String resString = resBuild.toString(); byte [] bytes = null; try &#123; bytes = resString.getBytes("UTF-8"); &#125; catch (UnsupportedEncodingException e) &#123; logger.error("error_encodeResHeader", e); &#125; return bytes; &#125;&#125; ä½¿ç”¨Java nio å¯åŠ¨æœåŠ¡å™¨ NioServer 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246public class NioServer implements Server, Runnable &#123; private final static Logger logger = LoggerFactory.getLogger(NioServer.class); private Thread serverThread; private Integer port; private boolean running = false; private static volatile NioServer server; private CloudService cloudService; private ServerSocketChannel serverSocketChannel; private ByteBuffer readBuffer = ByteBuffer.allocate(8192); public static final ExecutorService requestWork = Executors.newCachedThreadPool(); public static NioServer getServerInstance () &#123; if (server == null) &#123; synchronized (NioServer.class) &#123; if (server == null) &#123; server = new NioServer(); &#125; &#125; &#125; return server; &#125; public NioServer() &#123; this.cloudService = new CloudService(); port = Integer.valueOf(CloudHttpConfig.getValue("port", "8080")); &#125; @Override public synchronized void start() &#123; if (running) &#123; logger.info("æœåŠ¡å™¨å·²ç»å¯åŠ¨"); return; &#125; serverThread = new Thread(this); serverThread.start(); this.running = true; &#125; @Override public void stop() &#123; try &#123; serverSocketChannel.close(); serverThread.stop(); &#125; catch (IOException e) &#123; logger.error("error_NioServer_stop", e); &#125; &#125; @Override public void run() &#123; try &#123; //æ‰“å¼€ServerSocketChannelé€šé“ serverSocketChannel = ServerSocketChannel.open(); //å¾—åˆ°ServerSocketå¯¹è±¡ serverSocketChannel.socket().bind(new InetSocketAddress(port)); Selector selector = Selector.open(); serverSocketChannel.configureBlocking(false); serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT); while (true) &#123; selector.select(); Iterator&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys().iterator(); SelectionKey key = null; while (selectedKeys.hasNext()) &#123; key = selectedKeys.next(); selectedKeys.remove(); if (!key.isValid()) &#123; continue; &#125; if (key.isAcceptable()) &#123; accept(key); &#125; if (key.isReadable()) &#123; read(key); &#125; if (key.isWritable()) &#123; write(key); &#125; &#125; &#125; &#125; catch (IOException e) &#123; logger.error("error_NioServer_run", e); &#125; &#125; private void accept(SelectionKey key) &#123; try &#123; ServerSocketChannel serverSocketChannel = (ServerSocketChannel)key.channel(); SocketChannel socketChannel = serverSocketChannel.accept(); socketChannel.configureBlocking(false); socketChannel.register(key.selector(), SelectionKey.OP_READ); &#125; catch (IOException e) &#123; logger.error("error_NioServer_accept", e); &#125; &#125; private Request read(SelectionKey key) &#123; Request request = null; SocketChannel socketChannel = (SocketChannel) key.channel(); try &#123; int readNum = socketChannel.read(readBuffer); if (readNum == -1) &#123; socketChannel.close(); key.cancel(); return null; &#125; readBuffer.flip(); byte [] buffers = new byte[readBuffer.limit()]; readBuffer.get(buffers); readBuffer.clear(); request = HttpParser.decodeReq(buffers); requestWork.execute(new RequestWorker(request, key, cloudService)); &#125; catch (IOException e) &#123; logger.error("error_NioServer_read", e); &#125; return request; &#125; private void write(SelectionKey key) throws IOException &#123; ByteBuffer buffer = (ByteBuffer) key.attachment(); if(buffer == null || !buffer.hasRemaining()) &#123; return; &#125; SocketChannel socketChannel = (SocketChannel) key.channel(); socketChannel.write(buffer); if(!buffer.hasRemaining())&#123; key.interestOps(SelectionKey.OP_READ); buffer.clear(); &#125; socketChannel.close(); &#125;&#125; å¤„ç†è¯·æ±‚çš„ RequestWorkç±»å¯¹äºæ¯ä¸€ä¸ªè¿›å…¥çš„è¯·æ±‚ã€‚éƒ½ä¼šå•ç‹¬å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ¥è¿›è¡Œå¤„ç† RequestWorker 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990public class RequestWorker implements Runnable &#123; private final static Logger logger = LoggerFactory.getLogger(RequestWorker.class); private Request request; private SelectionKey key; private SocketChannel channel; private CloudService cloudService; public RequestWorker(Request request, SelectionKey key, CloudService cloudService) &#123; this.request = request; this.key = key; this.channel = (SocketChannel) key.channel(); this.cloudService = cloudService; &#125; @Override public void run() &#123; Response response = new Response(); try &#123; cloudService.doService(request, response); &#125; catch (ViewNotFoundException e) &#123; response.setCode(HttpCode.STATUS_404.getCode()); response.setMsg(HttpCode.STATUS_404.getMsg()); ByteArrayOutputStream outputStream = response.getOutPutStream(); InputStream inputStream = this.getClass().getClassLoader().getResourceAsStream("404.html"); byte bytes [] = new byte [1024]; int len; try &#123; while ((len = inputStream.read(bytes)) &gt; -1) &#123; outputStream.write(bytes, 0, len); &#125; &#125; catch (IOException e1) &#123; logger.error("error_requestWork_write404", e); &#125; &#125; byte [] resHeader = HttpParser.encodeResHeader(response); byte [] body = response.getOutPutStream().toByteArray(); ByteBuffer byteBuffer = ByteBuffer.allocate(resHeader.length + body.length); byteBuffer.put(resHeader); byteBuffer.put(body); byteBuffer.flip(); // å°†è¾“å‡ºæµç»‘å®šè‡³é™„ä»¶ key.attach(byteBuffer); // æ³¨å†Œå†™äº‹ä»¶ key.interestOps(SelectionKey.OP_WRITE); key.selector().wakeup(); &#125;&#125; å®šä¹‰Servletæ¥å£ CloudServlet 12345678910111213141516171819202122232425262728293031323334353637383940public interface CloudServlet &#123; /** * åˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦åŒ¹é… handler * * @param request * @return */ boolean match(Request request); /** * æ‰§è¡Œåˆå§‹åŒ– */ void init(Request request, Response response); /** * æ‰§è¡Œè¯·æ±‚ * * @param request * @param response */ void doService(Request request, Response response);&#125; StaticViewServlet å®šä¹‰ä¸€ä¸ªå¤„ç†é™æ€èµ„æºçš„StaticViewServletå®ç°CloudServletæ¥å£ è¯¥é™æ€èµ„æºå¤„ç†å™¨ä¼šè‡ªåŠ¨æ‹¦æˆªstaticè·¯å¾„ä¸‹çš„è¯·æ±‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172public class StaticViewServlet implements CloudServlet &#123; private final static Logger logger = LoggerFactory.getLogger(StaticViewServlet.class); private String staticRootPath; public static Pattern p = Pattern.compile("^/static/\\S+"); @Override public boolean match(Request request) &#123; String path = request.getPath(); Matcher matcher = p.matcher(path); return matcher.matches(); &#125; @Override public void init(Request request, Response response) &#123; staticRootPath = CloudHttpConfig.getValue("static.resource.path"); &#125; @Override public void doService(Request request, Response response) &#123; String path = request.getPath(); String fileRelativePath = path.substring(8); String absolutePath = staticRootPath + "/" + fileRelativePath; RandomAccessFile randomAccessFile = null; try &#123; randomAccessFile = new RandomAccessFile(absolutePath, "r"); FileChannel fileChannel = randomAccessFile.getChannel(); ByteBuffer htmBuffer = ByteBuffer.allocate((int)fileChannel.size()); fileChannel.read(htmBuffer); htmBuffer.flip(); byte [] htmByte = new byte[htmBuffer.limit()]; htmBuffer.get(htmByte); response.getOutPutStream().write(htmByte); &#125; catch (FileNotFoundException e) &#123; throw new ViewNotFoundException(); &#125; catch (IOException e) &#123; logger.error("error_StaticViewServlet_doService å¼‚å¸¸", e); &#125; &#125;&#125; å®šä¹‰ CloudServiceCloudServiceæ˜¯ç”¨äºç››æ”¾Servletçš„å®¹å™¨ 12345678910111213141516171819202122232425262728293031323334353637383940public class CloudService &#123; private List&lt;CloudServlet&gt; cloudServlets = new ArrayList&lt;&gt;(); public CloudService() &#123; cloudServlets.add(new StaticViewServlet()); cloudServlets.add(new MappingUrlServlet()); &#125; public void doService(Request request, Response response) &#123; CloudServlet servlet = doSelect(request); servlet.init(request, response); servlet.doService(request, response); &#125; private CloudServlet doSelect(Request request) &#123; for (CloudServlet cloudServlet : cloudServlets) &#123; if (cloudServlet.match(request)) &#123; return cloudServlet; &#125; &#125; return new MappingUrlServlet(); &#125;&#125; æœ€å ç¼–å†™å¯åŠ¨ç±»12345678910111213141516171819202122public class CloudHttpServer &#123; /** * å¯åŠ¨æœåŠ¡å™¨ */ public static void startServer() &#123; NioServer.getServerInstance().start(); &#125; public static void main(String[] args) &#123; startServer(); &#125;&#125; æµ‹è¯• å¯åŠ¨æœåŠ¡å™¨ æµè§ˆå™¨è®¿é—® http://localhost:8080/static/home.html å“åº”é¡µé¢ å°¾è¨€æœ¬æ–‡åªæ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œä»…ä»…å®ç°äº†é™æ€èµ„æºè®¿é—®ã€‚åšä¸ºè‡ªå¨±è‡ªä¹çš„é¡¹ç›® +â€”â€”=]]></content>
      <categories>
        <category>NIO</category>
        <category>HTTP</category>
      </categories>
      <tags>
        <tag>NIO</tag>
        <tag>HTTP</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Javaå­—èŠ‚ç å¸¸é‡æ± ]]></title>
    <url>%2F2019%2F04%2F17%2FJava%E5%AD%97%E8%8A%82%E7%A0%81%E5%B8%B8%E9%87%8F%E6%B1%A0%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ä¸Šç¯‡æ–‡ç« ç®€å•ä»‹ç»äº†java Class å­—èŠ‚ç æ–‡ä»¶çš„åŸºæœ¬æ ¼å¼ã€‚æœ¬æ–‡æˆ‘ä»¬ç›´æ¥é€šè¿‡é˜…è¯»å­—èŠ‚ç æ–‡ä»¶æ¥è¿›ä¸€æ­¥ç†è§£å­—èŠ‚ç ä¸­çš„å¸¸é‡æ± ç»“æ„ é¦–å…ˆæˆ‘ä»¬æ–°å»ºä¸€ä¸ªæœ€ç®€å•çš„Javaæ–‡ä»¶ 12345public class Test &#123; public static void main(String[] args) &#123; System.out.println("hello world"); &#125;&#125; ç¼–è¯‘ä¹‹åä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ï¼Œå¯ä»¥çœ‹åˆ°Classæ–‡ä»¶æœ€åŸå§‹çš„16è¿›åˆ¶æ ¼å¼ã€‚æœ€æ˜æ˜¾çš„Classæ–‡ä»¶çš„é­”æ•°cafe babeä¸€çœ¼å°±èƒ½çœ‹åˆ° 12345678910111213141516171819202122232425262728293031323334cafe babe 0000 0034 0022 0a00 0600 14090015 0016 0800 170a 0018 0019 0700 1a07001b 0100 063c 696e 6974 3e01 0003 28295601 0004 436f 6465 0100 0f4c 696e 654e756d 6265 7254 6162 6c65 0100 124c 6f63616c 5661 7269 6162 6c65 5461 626c 65010004 7468 6973 0100 144c 636f 6d2f 796d6d2f 6167 656e 742f 5465 7374 3b01 00046d61 696e 0100 1628 5b4c 6a61 7661 2f6c616e 672f 5374 7269 6e67 3b29 5601 00046172 6773 0100 135b 4c6a 6176 612f 6c616e67 2f53 7472 696e 673b 0100 0a53 6f757263 6546 696c 6501 0009 5465 7374 2e6a6176 610c 0007 0008 0700 1c0c 001d 001e0100 0b68 656c 6c6f 2077 6f72 6c64 07001f0c 0020 0021 0100 1263 6f6d 2f79 6d6d2f61 6765 6e74 2f54 6573 7401 0010 6a617661 2f6c 616e 672f 4f62 6a65 6374 0100106a 6176 612f 6c61 6e67 2f53 7973 74656d01 0003 6f75 7401 0015 4c6a 6176 612f696f 2f50 7269 6e74 5374 7265 616d 3b010013 6a61 7661 2f69 6f2f 5072 696e 74537472 6561 6d01 0007 7072 696e 746c 6e010015 284c 6a61 7661 2f6c 616e 672f 53747269 6e67 3b29 5600 2100 0500 0600 00000000 0200 0100 0700 0800 0100 0900 00002f00 0100 0100 0000 052a b700 01b1 00000002 000a 0000 0006 0001 0000 0009 000b0000 000c 0001 0000 0005 000c 000d 00000009 000e 000f 0001 0009 0000 0037 00020001 0000 0009 b200 0212 03b6 0004 b1000000 0200 0a00 0000 0a00 0200 0000 0b000800 0c00 0b00 0000 0c00 0100 0000 09001000 1100 0000 0100 1200 0000 0200 13 å¦‚ä½•ä»ä¸Šé¢çš„æ–‡ä»¶ä¸­æ‰¾åˆ°å¸¸é‡æ± æ‰€åœ¨çš„ä½ç½®å‘¢åœ¨ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»åˆ†æè¿‡Classæ–‡ä»¶æ–‡ä»¶æ ¼å¼äº†ï¼Œå¸¸é‡æ± çš„ä½ç½®ç´§éšåœ¨ç‰ˆæœ¬å·ä¹‹åï¼Œä¹Ÿå°±æ˜¯ä»ç¬¬9ä¸ªå­—èŠ‚å¼€å§‹å°±æ˜¯å¸¸é‡æ± çš„å†…å®¹äº†ï¼Œä¸‹é¢å°±è®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹å¸¸é‡æ± çš„å…·ä½“å†…å®¹ constant_pool_count u2ä»ç¬¬9ä¸ªå­—èŠ‚å¼€å§‹å¾€åçš„ä¸¤ä¸ªå­—èŠ‚ï¼Œæ˜¯constant_pool_countï¼Œæˆ‘ä»¬æŠŠå®ƒå«åšå¸¸é‡è®¡æ•°å™¨ï¼Œæ¯”è¾ƒç‰¹æ®Šçš„æ˜¯å®ƒçš„ä¸‹æ ‡æ˜¯ä»1å¼€å§‹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´çœŸæ­£çš„å¸¸é‡æ± æ•°é‡æ˜¯constant_pool_count - 1ä¸ªï¼Œé‚£å¥½ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä¸Šé¢çš„é‚£ä¸ªæ™®é€šClassæ–‡ä»¶åŒ…å«äº†å¤šå°‘ä¸ªå¸¸é‡è¡¨ï¼ˆcp_infoï¼‰ å¯ä»¥çœ‹åˆ°constant_pool_countæ ‡è¯†ä½æ˜¯0022ï¼Œè½¬ä¸º10è¿›åˆ¶å°±æ˜¯34ã€‚ä¹Ÿå°±æ˜¯è¯´åŒ…å«34 - 1 = 33ä¸ªå¸¸é‡è¡¨å†…å®¹ cp_infoä¸Šæ–‡ç»è¿‡åˆ†ææˆ‘ä»¬å·²ç»ç¡®å®šäº†å­—èŠ‚ç æ–‡ä»¶åŒ…å«çš„å¸¸é‡è¡¨ä¸ªæ•°ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬è¦å…·ä½“æ€ä¹ˆçœ‹å‘¢ï¼Ÿ ä¸‹é¢è®©æˆ‘ä»¬æ¥å…·ä½“åˆ†æä¸‹cp_infoçš„ç»“æ„ å¯ä»¥çœ‹åˆ°æ¯ä¸ªcp_infoçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä½éƒ½æ˜¯tagï¼Œç”¨äºæ ‡è¯†å¸¸é‡è¡¨æ‰€å±çš„å…·ä½“ç±»å‹ï¼Œä¸Šç¯‡æ–‡ç« æˆ‘ä»¬è¯´è¿‡ï¼Œå¸¸é‡è¡¨ä¹‹æ‰€ä»¥éå¸¸å¤æ‚ï¼Œå°±æ˜¯å› ä¸ºå®ƒçš„ç±»å‹ä¼—å¤šï¼Œæœ‰å¤šå¤§14ç§ç±»å‹ã€‚é‚£ä¹ˆè¿™äº›ç±»å‹çš„åŒºåˆ†å°±æ˜¯é€šè¿‡tagæ¥åŒºåˆ†ã€‚æˆ‘ä»¬ä¼šé€ä¸ªåˆ†æè¿™14ç§ç±»å‹ å…ˆæ¥çœ‹ä¸‹è¿™14å¸¸é‡æ± ç±»å‹ è¿˜æ˜¯å›åˆ°ä¸Šè¿°å­—èŠ‚ç çš„16è¿›åˆ¶æ–‡ä»¶ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ å¯ä»¥çœ‹åˆ°tag = 10ï¼Œæ ¹æ®ä¸Šæ–‡æˆ‘ä»¬åˆ—å‡ºçš„ç»†åˆ†ç±»å‹å¯ä»¥ç¡®å®šè¿™ç¬¬ä¸€ä¸ªå‡ºç°çš„å¸¸é‡è¡¨ç±»å‹æ˜¯constant_Methodref_infoã€‚é‚£å¥½ç°åœ¨æˆ‘ä»¬å†å»å…·ä½“çš„çœ‹ä¸‹constant_Methodref_infoè¡¨çš„å…·ä½“å†…å®¹ å¯ä»¥çœ‹åˆ°ç´§è·Ÿåœ¨tagä¹‹åå…¶å®æ˜¯ä¸¤é¡¹indexç´¢å¼•å€¼ï¼Œåˆ†åˆ«æŒ‡å‘constant_Class_infoå’Œconstant_NameAndType_infoã€‚ ç»§ç»­å¾€ä¸‹é˜…è¯»ï¼Œå¯ä»¥çŸ¥é“å…·ä½“çš„ç´¢å¼•å€¼åˆ†åˆ«ä¸º0006ï¼Œ0014ã€‚ä¹Ÿå°±æ˜¯æŒ‡å‘å¸¸é‡æ± çš„ç¬¬6é¡¹å’Œç¬¬20é¡¹ ä¸‹é¢ä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨javap -v Testå‘½ä»¤ç”Ÿæˆæ–¹ä¾¿æˆ‘ä»¬é˜…è¯»çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œå½“ç„¶å¦‚æœæœ‰å…´è¶£çš„è¯ï¼Œç›´æ¥é˜…è¯»æºæ–‡ä»¶ä¹Ÿæ˜¯oKçš„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445public class com.ymm.agent.Test minor version: 0 major version: 52 flags: (0x0021) ACC_PUBLIC, ACC_SUPER this_class: #5 // com/ymm/agent/Test super_class: #6 // java/lang/Object interfaces: 0, fields: 0, methods: 2, attributes: 1Constant pool: #1 = Methodref #6.#20 // java/lang/Object.&quot;&lt;init&gt;&quot;:()V #2 = Fieldref #21.#22 // java/lang/System.out:Ljava/io/PrintStream; #3 = String #23 // hello world #4 = Methodref #24.#25 // java/io/PrintStream.println:(Ljava/lang/String;)V #5 = Class #26 // com/ymm/agent/Test #6 = Class #27 // java/lang/Object #7 = Utf8 &lt;init&gt; #8 = Utf8 ()V #9 = Utf8 Code #10 = Utf8 LineNumberTable #11 = Utf8 LocalVariableTable #12 = Utf8 this #13 = Utf8 Lcom/ymm/agent/Test; #14 = Utf8 main #15 = Utf8 ([Ljava/lang/String;)V #16 = Utf8 args #17 = Utf8 [Ljava/lang/String; #18 = Utf8 SourceFile #19 = Utf8 Test.java #20 = NameAndType #7:#8 // &quot;&lt;init&gt;&quot;:()V #21 = Class #28 // java/lang/System #22 = NameAndType #29:#30 // out:Ljava/io/PrintStream; #23 = Utf8 hello world #24 = Class #31 // java/io/PrintStream #25 = NameAndType #32:#33 // println:(Ljava/lang/String;)V #26 = Utf8 com/ymm/agent/Test #27 = Utf8 java/lang/Object #28 = Utf8 java/lang/System #29 = Utf8 out #30 = Utf8 Ljava/io/PrintStream; #31 = Utf8 java/io/PrintStream #32 = Utf8 println #33 = Utf8 (Ljava/lang/String;)V&#123; public com.ymm.agent.Test(); descriptor: ()V.... çœç•¥å…¶ä»–å­—èŠ‚ç  é€šè¿‡javap ç”Ÿæˆçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œçœ‹èµ·æ¥å°±èˆ’æœå¤šäº†ã€‚ç°åœ¨ç»§ç»­å›åˆ°ç¬¬ä¸€ä¸ªå¸¸é‡æ± é¡¹constant_Methodref_infoï¼Œå¯ä»¥çŸ¥é“å®ƒæ˜¯ç”±constant_Class_infoï¼Œconstant_NameAndType_infoä¸¤é¡¹çš„ç´¢å¼•å€¼ç»„æˆï¼Œæ ¹æ®ç´¢å¼•å€¼6,20æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å…·ä½“å¸¸é‡æ± é¡¹å†…å®¹ã€‚ å…ˆæ‰¾åˆ°ç´¢å¼•å€¼ä¸º6çš„constant_Class_infoçš„å†…å®¹ï¼Œå¯ä»¥å‘ç°å…¶å…·ä½“å†…å®¹ä¹Ÿæ˜¯æŒ‡å‘äº†ä¸€ä¸ªç´¢å¼•å€¼27ï¼Œç»§ç»­æ‰¾ç´¢å¼•å€¼ä¸º27å¸¸é‡é¡¹ æ‰¾åˆ°ç´¢å¼•å€¼ä¸º27çš„å¸¸é‡é¡¹ï¼Œå¯ä»¥å‘ç°æ˜¯ä¸€ä¸ªconstant_utf8_infoç±»å‹çš„å­—ç¬¦ä¸²(java/lang/Object)ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ç±»çš„å…¨é™å®šåç§° åˆ°ç›®å‰ä¸ºæ­¢å¤§å®¶åº”è¯¥å·²ç»æ‰¾åˆ°äº†é˜…è¯»å¸¸é‡æ± çš„æ„Ÿè§‰äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å»æŸ¥çœ‹ç´¢å¼•é¡¹ä¸º20çš„constant_NameAndType_infoçš„æ–¹æ³•ä¹Ÿæ˜¯ä¸€æ ·çš„ constant_NameAndType_infoæŒ‡å‘ç´¢å¼•å€¼ä¸º7å’Œ8çš„å†…å®¹ å¯ä»¥çŸ¥é“æ–¹æ³•åç§°ä¸ºinitï¼Œç±»å‹ä¸ºvoidæ–¹æ³• åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å¤§æ¦‚å¯ä»¥çŸ¥é“æ­¤å¸¸é‡æ± çš„ç¬¬ä¸€é¡¹è¡¨ç¤ºå…¶å®æ˜¯ä¸€ä¸ªæ— å‚çš„æ„é€ æ–¹æ³•ï¼Œå¹¶ä¸”æ˜¯ç¼–è¯‘å™¨ä¸ºæˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆçš„ å…¶å®å¤§å¤šæ•°å¤æ‚çš„å¸¸é‡æ± å†…å®¹æœ€ç»ˆéƒ½ä¼šç´¢å¼•åˆ°ä¸€ä¸ªconstant_utf8_infoå­—ç¬¦ä¸²ç±»å‹ï¼Œç”¨äºæè¿°ç±»å…¨é™å®šåï¼Œæ–¹æ³•æˆ–å­—æ®µåç§°åŠæè¿°ç¬¦ç­‰ç­‰ .. å°¾è¨€æœ¬ç¯‡æ–‡ç« æˆ‘ä»¬åªæ˜¯é€šè¿‡ä¸€ä¸ªç¤ºä¾‹æ¥é˜…è¯»Classæ–‡ä»¶çš„å¸¸é‡æ± å†…å®¹ï¼Œå…·ä½“çš„å¸¸é‡æ± ç»“æ„åœ¨ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬éƒ½æœ‰åˆ—å‡ºï¼Œå¹¶ä¸”é˜…è¯»çš„æ–¹æ³•ä¹Ÿæ˜¯ä¸æœ¬æ–‡ç±»ä¼¼ã€‚]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
        <category>JVM</category>
        <category>javaå­—èŠ‚ç </category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>javaå­—èŠ‚ç </tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Java Classæ–‡ä»¶ç»“æ„]]></title>
    <url>%2F2019%2F04%2F04%2FJava-Class%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%2F</url>
    <content type="text"><![CDATA[å¼•è¨€æˆ‘ä»¬éƒ½çŸ¥é“javaæ˜¯è·¨å¹³å°çš„ï¼ŒåŸå› å°±åœ¨äºå„ä¸ªå¹³å°çš„javaè™šæ‹Ÿæœºå¯ä»¥è½½å…¥å’Œæ‰§è¡ŒåŒä¸€ç§å¹³å°æ— å…³çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´javaè™šæ‹Ÿæœºä¸ä¸åŒ…æ‹¬Javaåœ¨å†…çš„ä»»ä½•è¯­è¨€ç»‘å®šï¼ŒåªäºClassæ–‡ä»¶è¿™ç§äºŒè¿›åˆ¶æ ¼å¼æ–‡ä»¶æ‰€å…³è”ã€‚ åŸºäºè¿™æ ·çš„è®¾è®¡ï¼Œåˆ°ç›®å‰ä¸ºæ­¢å·²ç»å‡ºç°äº†å¾ˆå¤šåŸºäºJavaè™šæ‹Ÿæœºçš„è¯­è¨€ å¦‚groovyæœ€ç»ˆéƒ½ä¼šç¼–è¯‘æˆclassæ–‡ä»¶ Classæ–‡ä»¶ç»“æ„ä¸€ä¸ªClassæ–‡ä»¶å”¯ä¸€å¯¹åº”ä¸€ä¸ªç±»æˆ–æ¥å£ ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹ä¸‹Classæ–‡ä»¶çš„åŸºæœ¬ç»“æ„ Classæ–‡ä»¶ä»¥8ä½å­—èŠ‚ä¸ºåŸºæœ¬å•ä½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå„ä¸ªæ•°æ®é¡¹ç›®ä¸¥æ ¼çš„æŒ‰ç…§é¡ºåºç´§å‡‘çš„æ’åˆ—åœ¨Classæ–‡ä»¶ä¹‹ä¸­ï¼Œä¸­é—´æ²¡æœ‰ä»»ä½•åˆ†éš”ç¬¦ï¼Œè¿™ä½¿å¾—æ•´ä¸ªClassæ–‡ä»¶ä¸­å­˜å‚¨çš„å†…å®¹å‡ ä¹å…¨éƒ¨æ˜¯è¿è¡Œæ—¶çš„å¿…è¦æ•°æ® Classæ–‡ä»¶çš„äºŒè¿›åˆ¶æ–‡ä»¶åªæœ‰ä¸¤ç§æ•°æ®ç±»å‹ï¼šæ— ç¬¦å·æ•°å’Œè¡¨ï¼Œåé¢çš„è§£æéƒ½ä¼šä»¥è¿™ä¸¤ç§æ•°æ®ç±»å‹ä¸ºåŸºç¡€ æ— ç¬¦å·æ•° æ— ç¬¦å·æ•°æ˜¯æœ€åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼Œä»¥u1,u2,u4,u8æ¥åˆ†åˆ«ä»£è¡¨1ä¸ªå­—èŠ‚ï¼Œ2ä¸ªå­—èŠ‚ï¼Œ4ä¸ªå­—èŠ‚ï¼Œ8ä¸ªå­—èŠ‚çš„æ— ç¬¦å·æ•°ï¼Œæ— ç¬¦å·æ•°ç”¨æ¥æè¿°æ•°å­—ï¼Œç´¢å¼•å¼•ç”¨ï¼Œæ•°é‡å€¼ï¼Œä»¥åŠä»¥UTF-8ç¼–ç çš„å­—ç¬¦ä¸² è¡¨ è¡¨åˆ™æ˜¯ç”±å¤šä¸ªæ— ç¬¦å·æ•°æˆ–å…¶ä»–è¡¨ç»„æˆçš„å¤åˆæ•°æ®ç»“æ„ï¼Œè¡¨çš„åç§°ä¸€èˆ¬ä»¥_infoç»“å°¾ã€‚æ‰€ä»¥æ•´ä¸ªClassæ–‡ä»¶å…¶å®å°±æ˜¯ä¸€å¼ ç‰¹æ®Šçš„è¡¨ ä¸‹é¢è¡¨ä¸­æ‰€åˆ—çš„å°±æ˜¯ä¸€ä¸ªClassæŒ‰é¡ºåºæ’åˆ—çš„æ•°æ®ç»“æ„ ç±»å‹ åç§° æ•°é‡ u4 magic é­”æ•° æ ‡è¯†Classæ–‡ä»¶ 1 u2 minor_version æ¬¡ç‰ˆæœ¬å· 1 u2 major_version ä¸»ç‰ˆæœ¬å· 1 u2 constant_pool_count å¸¸é‡è¡¨é›†åˆæ•°é‡ 1 cp_info constant_pool å¸¸é‡è¡¨ constant_pool_count - 1 u2 access_flag è®¿é—®æ ‡è¯† 1 u2 this_class ç±»ç´¢å¼• 1 u2 super_class çˆ¶ç±»ç´¢å¼• 1 u2 interfaces_count æ¥å£ç´¢å¼•æ•°é‡ 1 u2 interfaces æ¥å£ç´¢å¼• interfaces_count u2 fields_count å­—æ®µè¡¨é›†åˆæ•°é‡ 1 field_info fields å­—æ®µè¡¨ fields_count u2 methods_count æ–¹æ³•è¡¨é›†åˆæ•°é‡ 1 method_info methods æ–¹æ³•è¡¨ methods_count u2 attributes_count å±æ€§è¡¨é›†åˆæ•°é‡ 1 attribute_info attributes å±æ€§è¡¨ attributes_count ä¸‹é¢ä¾æ¬¡æ¥è§£è¯»è¡¨ä¸­æ¯ä¸ªç±»å‹ é­”æ•°å’Œç‰ˆæœ¬å·å¤´4ä¸ªå­—èŠ‚ç§°ä¸ºClassæ–‡ä»¶çš„é­”æ•°ï¼Œé­”æ•°çš„ä½œç”¨æ˜¯æ ‡è¯†æ­¤æ–‡ä»¶èƒ½è¢«Javaè™šæ‹Ÿæœºæ¥å—çš„Classæ–‡ä»¶ï¼Œå…¶å®ä¸æ­¢Classæ–‡ä»¶æœ‰é­”æ•°è¿™ä¸ªæ¦‚å¿µï¼ŒåŒ…æ‹¬å…¶ä»–å¾ˆå¤šæ–‡ä»¶æ ¼å¼å‡ºäºå®‰å…¨çš„è€ƒè™‘ä¹Ÿéƒ½ä¼šæœ‰é­”æ•°è¿™ä¸ªæ¦‚å¿µï¼Œé­”æ•°éƒ½æ˜¯å›ºå®šä¸å˜çš„ï¼Œå¦‚Classæ–‡ä»¶çš„é­”æ•°å°±æ˜¯cafebabe ç´§æ¥ç€é­”æ•°ä¹‹åçš„æ˜¯ç‰ˆæœ¬å·ï¼Œç¬¬5 6ä¸ªå­—èŠ‚è¡¨ç¤ºçš„æ˜¯æ¬¡ç‰ˆæœ¬å·ï¼Œç¬¬7 8ä¸ªå­—èŠ‚è¡¨ç¤ºçš„æ˜¯ä¸»ç‰ˆæœ¬å·ã€‚ç‰ˆæœ¬å·éƒ½æ˜¯å‘ä¸‹å…¼å®¹çš„ å¸¸é‡æ± è¡¨è¯»æ‡‚å¸¸é‡æ± è¡¨å¯¹äºé˜…è¯»Classå­—èŠ‚ç éå¸¸é‡è¦ï¼Œä¸‹é¢æˆ‘ä»¬å°†ä»¥å¤§ç¯‡å¹…åˆ†æå¸¸é‡æ± è¡¨ å¸¸é‡æ± æ˜¯Classæ–‡ä»¶ä¸­å‡ºç°çš„ç¬¬ä¸€ä¸ªè¡¨ç»“æ„ç±»å‹ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å ç”¨Classæ–‡ä»¶æœ€å¤§ç©ºé—´çš„ç±»å‹ä¹‹ä¸€ã€‚ç”±äºå¸¸é‡æ± è¡¨çš„æ•°é‡ä¸æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥åœ¨å¸¸é‡æ± çš„å…¥å£æœ‰ä¸€é¡¹u2ç±»å‹çš„æ•°æ®ï¼Œæ¥ä»£è¡¨å¸¸é‡æ± çš„æ•°é‡ã€‚å¹¶ä¸”å¸¸é‡æ± æ¯”è¾ƒç‰¹æ®Šï¼Œå®¹é‡è®¡æ•°æ˜¯ä»1å¼€å§‹è€Œä¸æ˜¯ä»0å¼€å§‹ï¼Œæ‰€ä»¥å®é™…çš„å¸¸é‡æ± æ•°é‡æ˜¯constant_pool_count - 1 å¸¸é‡æ± ä¸­ä¸»è¦å­˜æ”¾ä¸¤å¤§ç±»å˜é‡: å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚å­—é¢é‡ç±»ä¼¼å¸¸é‡çš„æ¦‚å¿µï¼Œè€Œç¬¦å·å¼•ç”¨åˆ™å¼•è‡³ç¼–è¯‘åŸç†çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬ä¸‰ç±»(ç±»å’Œæ¥å£çš„å…¨é™å®šåï¼Œå­—æ®µçš„åç§°å’Œæè¿°ç¬¦ï¼Œæ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦)ï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼ŒJavaåœ¨javacç¼–è¯‘çš„æ—¶å€™ä¸ä¼šè¿›è¡ŒClassæ–‡ä»¶çš„åŠ¨æ€è¿æ¥ï¼Œåªæœ‰åœ¨è¿è¡Œæ—¶æ‰ä¼šè¿›è¡Œå…·ä½“çš„Classæ–‡ä»¶çš„è§£ææ“ä½œ å¸¸é‡æ± è¡¨ç»“æ„ä¸Šæ–‡ä¸¤å¤§ç±»çš„å¸¸é‡æ± ç±»å‹ç»†åˆ†ä¹‹åï¼Œåˆ°JDK1.7ä¹‹åå¢åŠ åˆ°äº†14ç§ã€‚ä¹‹æ‰€ä»¥è¯´å¸¸é‡æ± æ˜¯æœ€å¤æ‚çš„ç»“æ„ï¼Œå°±æ˜¯å› ä¸ºè¿™14ç§ä¸åŒçš„ç±»å‹éƒ½æœ‰ä¸åŒçš„è¡¨ç»“æ„ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ç®€å•çœ‹ä¸‹è¿™14ç§ç»“æ„ æ¯ç§å¸¸é‡ç±»å‹çš„èµ·å§‹ä½éƒ½æœ‰ä¸€ä¸ªu1ç±»å‹çš„tagæ ‡è¯†ç¬¦ï¼Œç”¨äºæ ‡è¯†å½“å‰çš„å¸¸é‡ç±»å‹ è®¿é—®æ ‡å¿—è®¿é—®æ ‡å¿—ç”¨äºè¯†åˆ«ç±»æˆ–æ¥å£å±‚é¢çš„ä¿¡æ¯ï¼Œæ ‡è¯†æ˜¯å¦ä¸ºpublicï¼Œabstractï¼Œfinalï¼Œæ³¨è§£ï¼Œæšä¸¾ç­‰ ç±»ç´¢å¼• çˆ¶ç±»ç´¢å¼• æ¥å£ç´¢å¼•ç±»ç´¢å¼•å’Œçˆ¶ç±»ç´¢å¼•éƒ½æ˜¯ä¸€ä¸ªu2ç±»å‹çš„æ•°æ®ï¼Œè€Œæ¥å£ç´¢å¼•åˆ™æ˜¯ä¸€ç»„u2ç±»å‹çš„é›†åˆï¼Œæ‰€ä»¥æ¥å£ç´¢å¼•å…¥å£çš„ç¬¬ä¸€é¡¹ä¸ºä¸€ä¸ªu2ç±»å‹çš„è®¡æ•°ï¼Œè¡¨ç¤ºæœ‰å‡ ä¸ªæ¥å£ç´¢å¼• ç±»ç´¢å¼•å’Œæ¥å£ç´¢å¼•çš„å…·ä½“å€¼æ˜¯ä¸€ä¸ªu2çš„æ•°æ®é¡¹ï¼Œå¹¶ä¸”æŒ‡å‘ä¸€ä¸ªCONSTANT_Class_infoå¸¸é‡æ± è¡¨ç±»å‹åœ¨å¸¸é‡æ± ä¸­çš„åç§»é‡ å­—æ®µè¡¨é›†åˆå­—æ®µè¡¨ç”¨äºæè¿°æ¥å£æˆ–ç±»ä¸­å£°æ˜çš„å˜é‡ï¼ŒåŒ…æ‹¬ç±»çº§å˜é‡å’Œå®é™…çº§å˜é‡ï¼Œä¸åŒ…æ‹¬åœ¨æ–¹æ³•å†…éƒ¨å£°æ˜çš„å±€éƒ¨å˜é‡ åŒ…å«çš„ä¿¡æ¯ä¸»è¦æœ‰è¿™å‡ ç§: å­—æ®µä½œç”¨åŸŸ(private,protact,public)ï¼Œæ˜¯å¦staticä¿®é¥°ï¼Œå¯å˜æ€§ï¼Œvolatile ä¿®é¥°ï¼Œå¯å¦è¢«åºåˆ—åŒ–ï¼Œå­—æ®µç±»å‹(åŸºæœ¬ç±»å‹ï¼Œå¼•ç”¨ï¼Œæ•°ç»„)ï¼Œå­—æ®µåç§° å­—æ®µè¡¨ç»“æ„ ç±»å‹ åç§° æ•°é‡ u2 access_flas 1 u2 name_index 1 u2 descriptor_index 1 u2 attributes_count 1 attribute_info å±æ€§è¡¨ attributes_count access_flasæˆ‘ä»¬æ¥çœ‹ä¸‹å­—æ®µaccess_flasè®¿é—®æ ‡è¯†å¯é€‰çš„ç±»å‹ æ ‡å¿—åç§° æ ‡å¿—å€¼ å«ä¹‰ ACC_PUBLIC 0x0001 å­—æ®µæ˜¯å¦public ACC_PRIVARE 0x0002 å­—æ®µæ˜¯å¦private ACC_PROTECTED 0x0004 å­—æ®µæ˜¯å¦protected ACC_STATIC 0x0008 å­—æ®µæ˜¯å¦static ACC_FINAL 0x0010 å­—æ®µæ˜¯å¦final ACC_VOLATILE 0x0040 å­—æ®µæ˜¯å¦volatile ACC_TRANSIENT 0x0080 æ˜¯å¦ transient ACC_SYNTHETIC 0x1000 å­—æ®µç”±ç¼–è¯‘å™¨è‡ªåŠ¨äº§ç”Ÿ ACC_ENUM 0x4000 å­—æ®µæ˜¯å¦ä¸ºæšä¸¾ç±»å‹ çœ‹ä¸ªä¾‹å­ï¼Œå¦‚æœaccess_flasä¸º0x0019ï¼Œåˆ™æ ‡è¯†äº†ACC_PUBLICï¼ŒACC_STATICï¼ŒACC_FINALä¸‰ç§ç±»å‹ name_indexå’Œdescriptor_indexè·Ÿåœ¨access_flasä¹‹åæ˜¯name_index(ç®€å•åç§°)å’Œdescriptor_index(æè¿°ç¬¦)ã€‚åŒ…æ‹¬ä¹‹å‰å‡ºç°çš„å…¨é™å®šåï¼Œè¿™é‡Œè§£é‡Šä¸€ä¸‹è¿™å‡ ä¸ªåç§°ã€‚å…¨é™å®šåç§°ä¸€èˆ¬æ¥è¯´æ˜¯æŒ‡org/xxx/TestClassè¿™ç§ç±»å‹çš„åç§°ï¼Œå¯ä»¥ç†è§£ä¸ºç±»çš„è·¯å¾„ï¼Œç®€å•åç§°å°±æ›´åŠ å®¹æ˜“ç†è§£äº†ï¼Œä¾‹å¦‚æ–¹æ³•inc()çš„ç®€å•åç§°å€¼çš„å°±æ˜¯inc æè¿°ç¬¦ç›¸å¯¹äºä¸Šé¢çš„ä¸¤ç§ç¨å¤æ‚ä¸€äº›ï¼Œæè¿°ç¬¦çš„ä½œç”¨æ˜¯ç”¨æ¥æè¿°å­—æ®µçš„æ•°æ®ç±»å‹ï¼Œæ–¹æ³•çš„å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼ï¼Œæ ¹æ®æè¿°ç¬¦è§„åˆ™ï¼ŒåŸºæœ¬æ•°æ®ç±»å‹ï¼ˆbyte,char,int,long,float,double,short,booleanï¼‰ä»¥åŠä»£è¡¨æ— è¿”å›å€¼çš„voidç±»å‹éƒ½ç”¨ä¸€ä¸ªå¤§å†™å­—ç¬¦æ¥è¡¨ç¤ºï¼Œè€Œå¯¹è±¡ç±»å‹åˆ™ç”¨LåŠ å¯¹è±¡çš„å…¨é™å®šåæ¥è¡¨ç¤º å…·ä½“çš„åˆ—åœ¨äº†ä¸‹è¡¨ä¸­ æ ‡è¯†å­—ç¬¦ å«ä¹‰ B byte C char D double F float I int J long S short Z boolean V void L å¯¹è±¡ç±»å‹ å¦‚ Ljava/lang/Object å¯¹äºæ•°ç»„ç±»å‹ï¼Œæ¯ä¸€çº¬åº¦ä½¿ç”¨ä¸€ä¸ªå‰ç½®çš„[æ¥è¡¨ç¤ºï¼Œå¦‚å®šä¹‰ä¸€ä¸ªjava.lang.String []çš„æ•°ç»„ç±»å‹ï¼Œå°†è¢«è®°å½•ä¸º[[Ljava/lang/String; ç”¨æè¿°ç¬¦æ¥æè¿°æ–¹æ³•æ—¶ï¼ŒæŒ‰ç…§å…ˆå‚æ•°åˆ—è¡¨åè¿”å›å€¼çš„é¡ºåºæè¿°ï¼Œå‚æ•°åˆ—è¡¨ä¸¥æ ¼æŒ‰ç…§é¡ºåºæ”¾åœ¨()å†…ï¼Œå¦‚æ–¹æ³•void inc()çš„æè¿°ç¬¦ä¸º()Vï¼Œæ–¹æ³•int inc(int i, double)çš„æè¿°ç¬¦ä¸º(ID)I åœ¨æè¿°ç¬¦ä¹‹åï¼Œç´§è·Ÿç€æ˜¯ä¸€ä¸ªå±æ€§è¡¨é›†åˆï¼Œå±æ€§è¡¨é›†åˆå¯ä»¥ä¸ºç©ºï¼Œ æ–¹æ³•è¡¨æ–¹æ³•è¡¨çš„ç»„æˆä¸å±æ€§è¡¨çš„ç»„æˆæ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œè®¿é—®æ ‡è¯†ç¬¦çš„å–å€¼ç•¥æœ‰ä¸åŒ æ ‡å¿—åç§° æ ‡å¿—å€¼ å«ä¹‰ ACC_PUBLIC 0x0001 æ–¹æ³•æ˜¯å¦public ACC_PRIVARE 0x0002 æ–¹æ³•æ˜¯å¦private ACC_PROTECTED 0x0004 æ–¹æ³•æ˜¯å¦protected ACC_STATIC 0x0008 æ–¹æ³•æ˜¯å¦static ACC_FINAL 0x0010 æ–¹æ³•æ˜¯å¦final ACC_SYNCHRONIZED 0x0020 æ–¹æ³•æ˜¯å¦åŒæ­¥ ACC_BRIDGE 0x0040 æ–¹æ³•æ˜¯å¦ç”±ç¼–è¯‘å™¨äº§ç”Ÿçš„æ¡¥æ¥æ–¹æ³• ACC_VARARGS 0x0080 æ–¹æ³•æ˜¯å¦æ¥å—ä¸å®šèš•é£Ÿ ACC_NATIVE 0x0100 æ–¹æ³•æ˜¯å¦ä¸ºnative ACC_ABSTRACT 0x0400 æ–¹æ³•æ˜¯å¦ä¸ºabstract ACC_STRICTFP 0x0800 æ–¹æ³•æ˜¯å¦ä¸ºstrictfp SYNTHETIC 0x1000 æ–¹æ³•ç”±ç¼–è¯‘å™¨è‡ªåŠ¨äº§ç”Ÿ é‚£ä¹ˆè¿™é‡Œå¤§å®¶å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œæ–¹æ³•é‡Œçš„javaä»£ç å»å“ªäº†å‘¢ï¼Ÿ ç­”æ¡ˆå°±æ˜¯åœ¨æ–¹æ³•è¡¨çš„å±æ€§è¡¨é›†åˆä¸­ï¼Œæœ‰ä¸€ä¸ªcodeå±æ€§ï¼Œé‚£é‡Œå­˜æ”¾äº†ç¼–è¯‘æˆå­—èŠ‚ç çš„Javaä»£ç ã€‚å¯¹äºå±æ€§è¡¨ï¼Œåœ¨ä¸‹æ–‡ä¼šæåˆ° å±æ€§è¡¨å±æ€§è¡¨ï¼Œå‰æ–‡å·²ç»æåˆ°äº†å¤šæ¬¡ã€‚åŒ…æ‹¬Classæ–‡ä»¶æœ¬èº«ï¼Œæ–¹æ³•è¡¨ï¼Œå­—æ®µè¡¨éƒ½æœ‰æºå¸¦è‡ªå·±çš„å±æ€§è¡¨é›†åˆï¼Œç”¨äºæè¿°ä¸“æœ‰åœºæ™¯ä¿¡æ¯ å¹¶ä¸”å±æ€§è¡¨ä¸Classæ–‡ä»¶å…¶ä»–æ•°æ®é¡¹è¦æ±‚ä¸åŒï¼Œå„ä¸ªå±æ€§ä¸è¦æ±‚ä¸¥æ ¼çš„é¡ºåºï¼Œå¹¶ä¸”åªè¦ä¸ä¸å·²æœ‰å±æ€§åé‡å¤ï¼Œä»»ä½•äººå®ç°çš„ç¼–è¯‘å™¨éƒ½å¯ä»¥å‘å±æ€§è¡¨ä¸­å†™å…¥è‡ªå·±å®šä¹‰çš„å±æ€§ä¿¡æ¯ ä¸‹é¢æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªå…³é”®å±æ€§ code å±æ€§javaç¨‹åºæ–¹æ³•ä½“ä¸­çš„ä»£ç javacç¼–è¯‘å™¨å¤„ç†åï¼Œæœ€ç»ˆå˜ä¸ºå­—èŠ‚ç å­ä»¤å­˜å‚¨åœ¨Codeå±æ€§å†… Exceptions å±æ€§åˆ—ä¸¾æ–¹æ³•å¯èƒ½ä¼šæŠ›å‡ºçš„å¼‚å¸¸ LineNumberTable å±æ€§æè¿°javaæºç è¡Œæ•°å’Œå­—èŠ‚ç è¡Œæ•°çš„å¯¹åº”å…³ç³»ï¼Œå‰è€…æ˜¯å­—èŠ‚ç è¡Œï¼Œåè€…æ˜¯æºç è¡Œ LocalVariableTable å±æ€§æè¿°æ ˆå±€éƒ¨å˜é‡å’Œæºç ä¸­å®šä¹‰çš„å˜é‡çš„å…³ç³».è¿™é¡¹æ˜¯å¯é€‰çš„ï¼Œå¯ä½¿ç”¨javac -g:noneæˆ–javac -g:varså‘½ä»¤å…³é—­ç”Ÿæˆè¿™é¡¹ä¿¡æ¯ SourceFile å±æ€§ç”¨äºè®°å½•Classæºç æ–‡ä»¶çš„æ–‡ä»¶åç§°ï¼Œè¿™ä¸ªå±æ€§æ˜¯å¯é€‰çš„ã€‚å¯ä½¿ç”¨javac -g:noneæˆ–javac -g:sourceå‘½ä»¤å…³é—­ç”Ÿæˆè¿™é¡¹ä¿¡æ¯ ConstantValue å±æ€§é€šçŸ¥è™šæ‹Ÿæœºä¸ºé™æ€å˜é‡èµ‹å€¼ InnerClasses å±æ€§ç”¨äºè®°å½•å†…éƒ¨ç±»ä¸å®¿ä¸»ç±»ä¹‹é—´çš„å…³ç³» Deprecated Synthetic å±æ€§Deprecated æ ‡è¯†æŸä¸ªç±»ï¼Œå­—æ®µæˆ–æ–¹æ³•è¿‡æœŸSynthetic æ ‡è¯†æ­¤å­—æ®µä¸ç”±Javaæºç ç›´æ¥äº§ç”Ÿï¼Œç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ·»åŠ  StackMapTable å±æ€§è¿™ä¸ªå±æ€§ä¼šåœ¨è™šæ‹ŸæœºåŠ è½½å®Œå­—èŠ‚ç åçš„éªŒè¯é˜¶æ®µè¢«ä½¿ç”¨ Signature å±æ€§Signatureåœ¨JDK1.5ä¹‹åè¢«æ·»åŠ ï¼Œç”¨äºè®°å½•æ³›å‹ç­¾åä¿¡æ¯ã€‚ä¹‹æ‰€ä»¥è¦ç”¨è¿™ä¹ˆä¸€ä¸ªå±æ€§å»è®°å½•æ³›å‹ä¿¡æ¯ï¼Œæ˜¯å› ä¸ºJavaè¯­è¨€çš„æ³›å‹é‡‡ç”¨çš„æ˜¯æ“¦é™¤æ³•å®ç°çš„ä¼ªæ³›å‹ï¼Œåœ¨Codeå±æ€§ä¸­ï¼Œæ³›å‹ä¿¡æ¯åœ¨ç¼–è¯‘ä¹‹åç»Ÿç»Ÿéƒ½è¢«æ“¦é™¤æ‰äº†ã€‚ä½¿ç”¨çš„æ“¦é™¤æ³•çš„åŸå› æ˜¯è¿™æ ·å­å®ç°æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦ä¿®æ”¹javacç¼–è¯‘å™¨å°±å¯ä»¥å®ç°äº†ï¼Œè¿è¡Œæ—¶ä¹Ÿå¯ä»¥èŠ‚çœä¸€äº›ç©ºé—´ã€‚åå¤„å°±æ˜¯è¿è¡Œæ—¶æ— æ³•æ‹¿åˆ°æ³›å‹ä¿¡æ¯ã€‚Signatureå°±æ˜¯ä¸ºäº†å¼¥è¡¥è¿™ä¸ªç¼ºé™·è€Œè®¾ç½®çš„ï¼Œç°åœ¨çš„Java APIåå°„èƒ½å¤Ÿè·å–åˆ°çš„æ³›å‹ä¿¡æ¯ä¹Ÿæ¥è‡ªè¿™ä¸ªå±æ€§ BootStrapMathods å±æ€§BootStrapMathodsæ˜¯JDK 1.7ä¹‹åå¢åŠ åˆ°è§„èŒƒä¸­çš„ï¼Œè¿™ä¸ªå±æ€§ç”¨äºä¿å­˜invokedynamicæŒ‡ä»¤å¼•ç”¨çš„å¼•å¯¼æ–¹æ³•é™å®šç¬¦ã€‚æœ¬ç¯‡æ–‡ç« æš‚ä¸èµ˜è¿°è¿™ä¸ªæŒ‡ä»¤]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
        <category>JVM</category>
        <category>javaå­—èŠ‚ç </category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>javaå­—èŠ‚ç </tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Javaç±»åŠ è½½æœºåˆ¶]]></title>
    <url>%2F2019%2F04%2F02%2FJava%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ä»‹ç»ä¸€ä¸‹javaç±»åŠ è½½çš„è¿‡ç¨‹ ç±»åŠ è½½çš„æ—¶æœºç±»ä»è¢«åŠ è½½åˆ°javaè™šæ‹Ÿæœºå†…å­˜ä¸­å¼€å§‹ï¼Œè¢«åˆ†ä¸º7ä¸ªé˜¶æ®µï¼ŒåŒ…æ‹¬åŠ è½½ï¼ŒéªŒè¯ï¼Œå‡†å¤‡ï¼Œè§£æï¼Œåˆå§‹åŒ–ï¼Œä½¿ç”¨ï¼Œå¸è½½ è¿™é‡Œæˆ‘ä»¬æš‚ä¸”ä¸»è¦çœ‹åŠ è½½é˜¶æ®µå’Œåˆå§‹åŒ–é˜¶æ®µï¼Œjavaè™šæ‹Ÿæœºä¸»è¦æ˜¯åšäº†ä¸‰ä»¶äº‹æƒ… åŠ è½½ é€šè¿‡ç±»çš„å…¨é™å®šåè·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„Classå¯¹è±¡ æ³¨æ„è¿™é‡Œè™šæ‹Ÿæœºå¹¶æ²¡æœ‰è§„å®šç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµçš„æ¥æºï¼Œæ‰€ä»¥æˆ‘ä»¬å…¶å®é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥å®ç°ä»å…¶ä»–é€”å¾„ï¼ˆå¦‚ç½‘ç»œä¸­è·å–ï¼‰ä¸­è·å–Classæ–‡ä»¶çš„äºŒè¿›åˆ¶å­—èŠ‚æµ åˆå§‹åŒ–åˆå§‹åŒ–é˜¶æ®µæ˜¯ç±»åŠ è½½çš„æœ€åä¸€ä¸ªé˜¶æ®µï¼Œå¯ä»¥ç†è§£æˆåˆå§‹é™æ€å—åŠé™æ€å˜é‡ï¼Œåœ¨å‡†å¤‡é˜¶æ®µï¼Œé™æ€å˜é‡å·²ç»èµ‹äº†åˆå§‹å€¼ï¼Œåˆå§‹åŒ–é˜¶æ®µèµ‹çš„å°±æ˜¯å…·ä½“çš„å€¼ã€‚ åˆå§‹åŒ–çš„å¿…è¦æ¡ä»¶ï¼Œå¹¶ä¸”æœ‰ä¸”åªæœ‰è¿™5ç§æƒ…å†µæ‰ä¼šè§¦å‘ç±»çš„åˆå§‹åŒ– é‡åˆ°new,getstatic,putstatic,invokestaticè¿™å››ä¸ªå­—èŠ‚ç æ—¶ï¼Œå¦‚æœè¿˜æœªæ‰§è¡Œç±»çš„åˆå§‹åŒ–åˆ™ä¼šæ‰§è¡Œåˆå§‹åŒ– ä½¿ç”¨java.lang.reflectåŒ…è¿›è¡Œåå°„è°ƒç”¨æ—¶ï¼Œå¦‚æœè¿˜æ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆ™ä¼šæ‰§è¡Œåˆå§‹åŒ– å½“åˆå§‹åŒ–ä¸€ä¸ªç±»æ—¶ï¼Œå‘ç°å…¶çˆ¶ç±»è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™ä¼šåˆå§‹åŒ–å…¶çˆ¶ç±» å½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œç”¨æˆ·éœ€è¦æŒ‡å®šä¸€ä¸ªä¸»ç±»ï¼Œè¿™ä¸ªä¸»ç±»ä¼šè¢«åˆå§‹åŒ– ä½¿ç”¨jdk7åŠ¨æ€è¯­è¨€æ”¯æŒæ—¶ï¼Œä¼šæ‰§è¡Œåˆå§‹åŒ– ä»¥ä¸Š5ä¸­åœºæ™¯ï¼Œç§°ä¸ºå¯¹ä¸€ä¸ªç±»çš„ä¸»åŠ¨å¼•ç”¨ã€‚é™¤è¿™5ç§æ–¹å¼ä¹‹å¤–ï¼Œä»»ä½•å…¶ä»–å¼•ç”¨éƒ½è¢«ç§°ä¸ºè¢«åŠ¨å¼•ç”¨ï¼Œå¹¶ä¸”éƒ½ä¸ä¼šè§¦å‘ç±»çš„åˆå§‹åŒ–ã€‚ ä¸‹é¢ä¸¾ä¸‰ç§æƒ…å†µæ¥è¯´æ˜è¢«åŠ¨å¼•ç”¨ é€šè¿‡å­ç±»å¼•ç”¨çˆ¶ç±»é™æ€å­—æ®µï¼Œä¸ä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ– 1234567891011121314151617181920public class BoshiCat extends Cat &#123; static &#123; System.out.println(&quot;BoshiCat init&quot;); &#125;&#125;public class Cat &#123; static &#123; System.out.println(&quot;Cat init&quot;); &#125; public static int value = 10;&#125;public class Test &#123; public static void main(String[] args) &#123; System.out.println(BoshiCat.value); &#125;&#125;// è¾“å‡º 10 é€šè¿‡æ•°ç»„æ¥å¼•ç”¨ç±»ï¼Œä¸ä¼šè§¦å‘å¼•ç”¨ç±»çš„åˆå§‹åŒ– 1234567public class Test &#123; public static void main(String[] args) &#123; Cat [] cats = new Cat[10]; &#125;&#125;// è¾“å‡º 10 å¼•ç”¨static finalä¿®é¥°çš„å¸¸é‡ï¼Œå› ä¸ºå¸¸é‡åœ¨ç¼–è¯‘é˜¶æ®µå°±è¢«å†™è¿›äº†å¸¸é‡æ±  12345678910111213public class Cat &#123; static &#123; System.out.println(&quot;Cat init&quot;); &#125; public static final int value = 10;&#125;public class Test &#123; public static void main(String[] args) &#123; System.out.println(Cat.value); &#125;&#125;// è¾“å‡º 10]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>JVM</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ReentrantLockå¯é‡å…¥é”æºç åˆ†æ]]></title>
    <url>%2F2019%2F03%2F25%2FReentrantLock%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ReentrantLockå¯é‡å…¥é”ï¼Œä¹Ÿæ˜¯æ—¥å¸¸ä½¿ç”¨é™¤äº†synchronizedå…³é”®å­—æœ€å¤šçš„é”ã€‚ä»å­—é¢ä¸Šç†è§£å¯é‡å…¥çš„æ„æ€å°±æ˜¯åŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥é‡å¤åŠ é”ï¼Œå½“ç„¶synchronizedå…³é”®å­—ä¹Ÿæ˜¯æ”¯æŒå¯é‡å…¥çš„ï¼Œå…¶å®å®ƒä»¬çš„ä¸»è¦åŠŸèƒ½ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œä½†æ˜¯ç›¸æ¯”è¾ƒæ¥è¯´ï¼ŒReentrantLockåŠŸèƒ½æ›´çµæ´»ä¸°å¯Œï¼Œä¾‹å¦‚ReentrantLockæ”¯æŒè®¾ç½®å…¬å¹³é”æˆ–éå…¬å¹³é”ï¼Œæ”¯æŒåˆ†ç»„å”¤é†’éœ€è¦å”¤é†’çš„çº¿ç¨‹ä»¬ï¼Œè€Œä¸æ˜¯åƒsynchronizedè¦ä¹ˆéšæœºå”¤é†’ä¸€ä¸ªçº¿ç¨‹è¦ä¹ˆå”¤é†’å…¨éƒ¨çº¿ç¨‹ã€‚ æ•´ä¸ªReentrantLockçš„å®ç°åŸºäºAQSç‹¬å é”ï¼Œè¿™ä¸ªåœ¨ä¸Šç¯‡æ–‡ç« å·²ç»è¯¦ç»†åˆ†æè¿‡ ç±»ç»“æ„ ReentrantLock.class ReentrantLockå®ç°äº†Lockæ¥å£ï¼Œä½†æ˜¯é€šè¿‡æŸ¥çœ‹æºç å¯çŸ¥ReentrantLockçš„å…·ä½“å®ç°å…¶å®éƒ½å§”æ‰˜ç»™äº†NonfairSynsï¼ˆéå…¬å¹³é”ï¼‰æˆ–åˆ™FairSyncï¼ˆå…¬å¹³é”ï¼‰ä¸¤ä¸ªç±»å®ç°ï¼ŒNonfairSynså’ŒFairSyncç»§æ‰¿äº†æŠ½è±¡é™æ€ç±»Syncï¼ŒSyncåˆ™æ˜¯AQSçš„å­ç±» å…¬å¹³é” éå…¬å¹³é”ReentrantLockæ”¯æŒå…¬å¹³é”ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯å…¬å¹³é”å‘¢ï¼Ÿç®€å•çš„ç†è§£å°±æ˜¯å¤šä¸ªçº¿ç¨‹è·å–é”çš„é¡ºåºåº”è¯¥æ˜¯æŒ‰ç…§æ—¶é—´çš„å…ˆåï¼Œå…ˆæ¥çš„å…ˆè·å–ã€‚ä¹Ÿå°±æ˜¯è¯´å…¬å¹³é”ç»å¯¹æ»¡è¶³å…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—å½¢å¼ã€‚ æˆ‘ä»¬ä»AQSåŒæ­¥é˜Ÿåˆ—æ¥ç†è§£çš„è¯ï¼Œå¯ä»¥è®¤ä¸ºå…¬å¹³é”æ¯æ¬¡éƒ½æ˜¯ä»åŒæ­¥é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è·å–åˆ°é”ï¼Œè€Œéå…¬å¹³é”åˆ™ä¸ä¸€å®šï¼Œæœ‰å¯èƒ½å æ®é”çš„çº¿ç¨‹åˆšé‡Šæ”¾é”ï¼ŒåŒæ­¥é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹è¿˜æœªæ¥å¾—åŠè·å–åˆ°é”ï¼Œå°±è¢«æ–°è¯·æ±‚é”çš„çº¿ç¨‹è·å–äº†ã€‚å½“ç„¶è¿™é‡Œè¦æ³¨æ„ï¼Œå¯¹äºå·²ç»åŠ å…¥AQSåŒæ­¥é˜Ÿåˆ—çš„çº¿ç¨‹æ¥è¯´ï¼Œæ— è®ºå…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”éƒ½æ˜¯ä¸€æ ·çš„ï¼ŒæŒ‰ç…§é˜Ÿåˆ—å…ˆåé¡ºåºè·å–ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹ReentrantLockçš„æ„é€ æ–¹æ³• 1234567public ReentrantLock() &#123; sync = new NonfairSync();&#125;public ReentrantLock(boolean fair) &#123; sync = fair ? new FairSync() : new NonfairSync();&#125; ReentrantLockæ— å‚æ„é€ é»˜è®¤æ˜¯éå…¬å¹³é” å¯ä»¥é€šè¿‡è®¾ç½®å‚æ•°å°†ReentrantLockè®¾ç½®ä¸ºå…¬å¹³é” ä»ä»£ç å±‚é¢çœ‹å®ç°åŒºåˆ« 1234567891011121314151617/** * éå…¬å¹³é”è·å–é” */final void lock() &#123; if (compareAndSetState(0, 1)) setExclusiveOwnerThread(Thread.currentThread()); else acquire(1);&#125;/** * å…¬å¹³é”è·å–é” */final void lock() &#123; acquire(1);&#125; å¯ä»¥çœ‹åˆ°å¾ˆæ˜æ˜¾çš„åŒºåˆ«ï¼Œéå…¬å¹³é”è·å–é”ï¼Œåªè¦å½“å‰æ²¡æœ‰æŒé”çº¿ç¨‹ï¼Œæ–°åŠ å…¥çš„çº¿ç¨‹éƒ½æœ‰æœºä¼šè·å–åˆ°é” å¯é‡å…¥ä¸Šæ–‡è¯´è¿‡ï¼Œå¯é‡å…¥çš„æ¦‚å¿µåªé’ˆå¯¹åŒä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆReentrantLockæ˜¯å¦‚ä½•å®ç°åŒä¸€ä¸ªçº¿ç¨‹å¯é‡å…¥çš„å‘¢ï¼Ÿ è¿™å°±åˆè¦æ¶‰åŠåˆ°AQS stateçš„æ¦‚å¿µï¼Œåœ¨AQSå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªçŠ¶æ€å€¼stateï¼Œå½“æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°é”ï¼Œstateå€¼å°±ä¼š+1ï¼Œå¯¹äºç‹¬å é”æ¥è¯´ï¼Œä¸åŒçš„çº¿ç¨‹è¦æƒ³è·å–é”ï¼Œstateå€¼å¿…é¡»ä¸º0ã€‚ä¸‹é¢æˆ‘ä»¬å°±é€šè¿‡æºç æ¥çœ‹çœ‹ReentrantLockæ˜¯å¦‚ä½•å®ç°å¯é‡å…¥æ€§çš„ ä»¥éå…¬å¹³é”ä¸ºä¾‹ 123456789101112131415161718192021222324252627282930313233343536373839/** * å°è¯•è·å–é” */final void lock() &#123; // å¦‚æœå½“å‰è·å–é”çš„çº¿ç¨‹ä¸º0ï¼Œåˆ™ç›´æ¥è·å– if (compareAndSetState(0, 1)) setExclusiveOwnerThread(Thread.currentThread()); else // è°ƒç”¨AQSæ¨¡æ¿æ–¹æ³•ï¼Œä¼šè°ƒç”¨å­ç±»çš„tryAcquire acquire(1);&#125;protected final boolean tryAcquire(int acquires) &#123; return nonfairTryAcquire(acquires);&#125;/** * éå…¬å¹³æ–¹æ³•å°è¯•è·å–é” */final boolean nonfairTryAcquire(int acquires) &#123; final Thread current = Thread.currentThread(); int c = getState(); if (c == 0) &#123; // å¦‚æœå½“å‰è·å–é”çš„çº¿ç¨‹ä¸º0ï¼Œåˆ™ç›´æ¥è·å–é” if (compareAndSetState(0, acquires)) &#123; setExclusiveOwnerThread(current); return true; &#125; &#125; // å¦‚æœå½“å‰è·å–é”çš„çº¿ç¨‹ä¸ºå½“å‰è¯·æ±‚çº¿ç¨‹ï¼Œåˆ™å°†state + 1 else if (current == getExclusiveOwnerThread()) &#123; int nextc = c + acquires; if (nextc &lt; 0) // overflow throw new Error("Maximum lock count exceeded"); setState(nextc); return true; &#125; return false;&#125; é¦–å…ˆä¼šåˆ¤æ–­stateçŠ¶æ€æ˜¯å¦ä¸º0(ä¹Ÿå°±æ˜¯å½“æ—¶è¿˜æ²¡æœ‰æŒé”çº¿ç¨‹)ï¼Œå¦‚æœä¸º0çš„è¯åˆ™ç›´æ¥è·å–é” stateçŠ¶æ€ä¸ä¸º0.åˆ™åˆ¤æ–­ä¸å½“å‰æŒé”çº¿ç¨‹æ˜¯å¦ä¸ºåŒä¸€ä¸ªçº¿ç¨‹ï¼Œæ˜¯çš„è¯ï¼Œåˆ™stateè‡ªå¢1.è·å–é”æˆåŠŸ æ€»ç»“æ€»çš„æ¥è¯´ï¼ŒReentrantLockå’Œsynchronizedéå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯ä¹Ÿè¿˜æ˜¯æ¯”è¾ƒå¤§çš„åŒºåˆ«ï¼ŒReentrantLockçš„åŠŸèƒ½æ›´ä¸°å¯Œçµæ´»ï¼Œsynchronizedåªæ”¯æŒéå…¬å¹³é”ï¼ŒReentrantLockå¯ä»¥æ”¯æŒå…¬å¹³é”ï¼Œå¹¶ä¸”ReentrantLockæ”¯æŒConditionç­‰ï¼Œå¯ä»¥æ‰¹é‡åˆ†ç»„å”¤é†’ç­‰å¾…çº¿ç¨‹ã€‚ `]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
        <category>å¹¶å‘ç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>å¹¶å‘</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Java AQS æºç è§£æ]]></title>
    <url>%2F2019%2F03%2F12%2FJava-AQS-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%2F</url>
    <content type="text"><![CDATA[å¼•è¨€AQSå…¨ç§°java.util.concurrent.locks.AbstractQueuedSynchronizerï¼Œæ˜¯Java å¹¶å‘åŒ…ä¸­çš„ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæˆ‘ä»¬ä¸€èˆ¬æŠŠå®ƒå«åšæŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ï¼Œå¦‚æˆ‘ä»¬å¸¸ç”¨çš„å¯é‡å…¥é”ReentrantLockçš„å†…éƒ¨å®ç°å°±æ˜¯åŸºäºAQSï¼Œç†è§£AQSçš„å†…éƒ¨æºç å®ç°å¯¹äºæˆ‘ä»¬æ·±å…¥ç†è§£ä½¿ç”¨javaå¹¶å‘åŒ…ä¸­çš„å„ä¸ªåŠŸèƒ½éå¸¸é‡è¦ã€‚ å®ç°åŸç†AQSå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒå‘é“¾è¡¨é˜Ÿåˆ—æ¥ç®¡ç†å¤šä¸ªçº¿ç¨‹ã€‚ç®€å•ä»‹ç»ä¸€ä¸‹å°±æ˜¯ï¼Œå½“æœ‰ä¸€ä¸ªæ–°çš„çº¿ç¨‹å»å°è¯•è·å–é”ï¼Œè¿™æ˜¯å¦‚æœè·å–å¤±è´¥ï¼ŒAQSåˆ™ä¼šå°†æ­¤çº¿ç¨‹å°è£…æˆä¸€ä¸ªNodeèŠ‚ç‚¹ï¼Œå¹¶å°†æ­¤èŠ‚ç‚¹åŠ å…¥åˆ°å†…éƒ¨ç»´æŠ¤çš„é˜Ÿåˆ—ä¸­ã€‚ ä¸Šé¢ç®€å•çš„æè¿°äº†çº¿ç¨‹è·å–é”çš„è¿‡ç¨‹ï¼Œé‚£ä¹ˆAQSæ˜¯ä½¿ç”¨ä»€ä¹ˆæ¥ç¡®è®¤å½“å‰çº¿ç¨‹æ˜¯å¦å¯ä»¥å°è¯•è·å–é”å‘¢ï¼Ÿ å…¶å®AQSå†…éƒ¨ä¸ºäº†ä¸€ä¸ªvolatile int stateå˜é‡æ¥è¡¨ç¤ºå½“å‰èµ„æºæ˜¯å¦å·²ç»è¢«å…¶ä»–çº¿ç¨‹å æœ‰ï¼Œå¯¹äºç‹¬å é”æ¥è¯´ï¼Œåªæœ‰å½“state = 0æ—¶æ‰è¯´æ˜è¯¥èµ„æºå½“å‰æ²¡æœ‰çº¿ç¨‹å æœ‰ï¼Œåç»­çº¿ç¨‹å¯ä»¥å¼€å§‹äº‰æŠ¢æ”¹èµ„æºï¼Œåç»­çº¿ç¨‹éœ€è¦é€šè¿‡CASæ“ä½œæ¥ç¡®ä¿ä¿®æ”¹stateå˜é‡æˆåŠŸæ‰èƒ½æˆåŠŸæŠ¢å è¯¥èµ„æºã€‚ é‡è¦æ–¹æ³•AQSå†…éƒ¨æä¾›äº†ä¸‰ç»„æ ¸å¿ƒæ–¹æ³•ç”¨æ¥å®ç°ä¸€ä¸ªåŒæ­¥ç»„ä»¶ã€‚ä¸‰ç»„æ–¹æ³•ä»å­—é¢æ„æ€ä¸ŠåŒºåˆ†å¯ä»¥åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šç‹¬å é”ç›¸å…³ï¼Œå…±äº«é”ç›¸å…³ è®¿é—®stateæœ‰ä¸‰ç§æ–¹æ³• getState() è·å–åŒæ­¥çŠ¶æ€ setState() è®¾ç½®åŒæ­¥çŠ¶æ€ï¼ˆéCASæ“ä½œï¼‰ compareAndSetState() é€šè¿‡CASæ“ä½œä¿®æ”¹ ä¸€ç»„æŠ½è±¡æ–¹æ³•ï¼Œéœ€è¦å­ç±»å®ç°ï¼Œä¸»è¦æ˜¯è·å–åŒæ­¥é”å¹¶åˆ¤æ–­æ˜¯å¦æˆåŠŸçš„æ“ä½œ æ–¹æ³• æè¿° boolean tryAcquire(int arg) ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ boolean tryRelease(int arg) ç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ int tryAcquireShared(int arg) å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ boolean tryReleaseShared(int arg) å…±äº«å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ boolean isHeldExclusively() æ£€æµ‹å½“å‰çº¿ç¨‹æ˜¯å¦è·å–ç‹¬å é” æ¨¡æ¿æ–¹æ³•ï¼Œç”¨äºå­ç±»ç›´æ¥è°ƒç”¨ æ–¹æ³• æè¿° void acquire(int arg) è·å–ç‹¬å é”ã€‚ä¼šè°ƒç”¨tryAcquireæ–¹æ³•ï¼Œå¦‚æœæœªè·å–æˆåŠŸï¼Œåˆ™ä¼šè¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾… void acquireInterruptibly(int arg) å“åº”ä¸­æ–­ç‰ˆçš„ acquire boolean tryAcquireNanos(int arg,long nanos) è¶…æ—¶+å“åº”ä¸­æ–­ç‰ˆçš„ acquire void acquireShared(int arg) è·å–å…±äº«é”ã€‚å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ï¼ŒåŒä¸€æ—¶åˆ»å¯èƒ½ä¼šæœ‰å¤šä¸ªçº¿ç¨‹è·å¾—åŒæ­¥çŠ¶æ€ã€‚æ¯”å¦‚è¯»å†™é”çš„è¯»é”å°±æ˜¯å°±æ˜¯è°ƒç”¨è¿™ä¸ªæ–¹æ³•è·å–åŒæ­¥çŠ¶æ€çš„ void acquireSharedInterruptibly(int arg) å“åº”ä¸­æ–­ç‰ˆçš„acquireShared boolean tryAcquireSharedNanos(int arg,long nanos) è¶…æ—¶+å“åº”ä¸­æ–­ç‰ˆçš„acquireShared boolean release(int arg) ç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ boolean releaseShared(int arg) é‡Šæ”¾å…±äº«é” Collection getQueuedThreads() è·å–åŒæ­¥é˜Ÿåˆ—ä¸Šçš„çº¿ç¨‹é›†åˆ æºç åˆ†æä¸Šæ–‡æœ‰æåˆ°ï¼Œè¿›å…¥åŒæ­¥é˜Ÿåˆ—çš„çº¿ç¨‹ä¼šè¢«å°è£…æˆä¸€ä¸ªNodeèŠ‚ç‚¹ï¼Œä¸‹é¢æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹Node.class 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158static final class Node &#123; /** * ç”¨äºæ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹åœ¨å…±äº«æ¨¡å¼ä¸‹ç­‰å¾… */ static final Node SHARED = new Node(); /** * ç”¨äºæ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹åœ¨ç‹¬å æ¨¡å¼ä¸‹ç­‰å¾… */ static final Node EXCLUSIVE = null; /** * ç­‰å¾…çŠ¶æ€ï¼šå–æ¶ˆçŠ¶æ€ */ static final int CANCELLED = 1; /** * ç­‰å¾…çŠ¶æ€ï¼šé€šçŸ¥(æŒ‡ç¤ºåç»§çº¿ç¨‹éœ€è¦é˜»å¡) */ static final int SIGNAL = -1; /** * ç­‰å¾…çŠ¶æ€ï¼šæ¡ä»¶ç­‰å¾… */ static final int CONDITION = -2; /** * ç­‰å¾…çŠ¶æ€ï¼šä¼ æ’­ */ static final int PROPAGATE = -3; /** * ç­‰å¾…çŠ¶æ€ */ volatile int waitStatus; /** * å‰é©±èŠ‚ç‚¹ */ volatile Node prev; /** * åç»§èŠ‚ç‚¹ */ volatile Node next; /** * èŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹ */ volatile Thread thread; /** * ç­‰å¾…é˜Ÿåˆ—ä¸­çš„åç»§èŠ‚ç‚¹ */ Node nextWaiter; /** * å½“å‰èŠ‚ç‚¹æ˜¯å¦å¤„äºå…±äº«æ¨¡å¼ç­‰å¾… */ final boolean isShared() &#123; return nextWaiter == SHARED; &#125; /** * è·å–å‰é©±èŠ‚ç‚¹ï¼Œå¦‚æœä¸ºç©ºçš„è¯æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ */ final Node predecessor() throws NullPointerException &#123; Node p = prev; if (p == null) &#123; throw new NullPointerException(); &#125; else &#123; return p; &#125; &#125; Node() &#123; &#125; /** * addWaiterä¼šè°ƒç”¨æ­¤æ„é€ å‡½æ•° */ Node(Thread thread, Node mode) &#123; this.nextWaiter = mode; this.thread = thread; &#125; /** * Conditionä¼šç”¨åˆ°æ­¤æ„é€ å‡½æ•° */ Node(Thread thread, int waitStatus) &#123; this.waitStatus = waitStatus; this.thread = thread; &#125;&#125; è¿™é‡Œè§£é‡Šå‡ ä¸ªé‡è¦çš„å±æ€§ å±æ€§ æ„ä¹‰ prev å‰ç½®èŠ‚ç‚¹ next åç½®èŠ‚ç‚¹ CANCELLED çŠ¶æ€å€¼ è¡¨ç¤ºèŠ‚ç‚¹è¢«å–æ¶ˆ SIGNAL çŠ¶æ€å€¼ è¡¨ç¤ºåç½®èŠ‚ç‚¹éœ€è¦è¢«é˜»å¡ CONDITION çŠ¶æ€å€¼ è¡¨ç¤ºèŠ‚ç‚¹è¿›å…¥ CONDITION PROPAGATE çŠ¶æ€å€¼ å…±äº«é”ä¼ æ’­çŠ¶æ€ ç‹¬å é”çš„è·å–åœ¨AQSä¸­åŒ…å«äº†headå’Œtailä¸¤ä¸ªNodeå¼•ç”¨ï¼Œå…¶ä¸­headåœ¨é€»è¾‘ä¸Šçš„å«ä¹‰æ˜¯å½“å‰æŒæœ‰é”çš„çº¿ç¨‹ï¼ŒtailæŒ‡ç¤ºé˜Ÿå°¾èŠ‚ç‚¹ã€‚headå’Œtailå¯ä»¥ç›¸ç­‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372/*** è·å–ç‹¬å é”ï¼Œè¯¥æ–¹æ³•ä¼šé¦–å…ˆè°ƒç”¨tryAcquireï¼ˆç”±å­ç±»å®ç°ï¼‰æ¥è·å–é”ï¼Œ* å¦‚æœè·å–æˆåŠŸä¼šç›´æ¥è¿”å›ï¼Œå¤±è´¥åˆ™ä¼šå°†å½“å‰æŠ¢é”å¤±è´¥çš„çº¿ç¨‹å°è£…ä¸ºNodeèŠ‚ç‚¹åŠ å…¥é˜Ÿå°¾ */public final void acquire(int arg) &#123; if (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) selfInterrupt();&#125;/*** å¢åŠ ä¸€ä¸ª * */private Node addWaiter(Node mode) &#123; Node node = new Node(Thread.currentThread(), mode); // Try the fast path of enq; backup to full enq on failure // å¿«é€Ÿæ‰§è¡Œä¸€æ¬¡åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨çš„æ“ä½œï¼Œå¦‚æœå¤±è´¥çš„è¯åˆ™æ‰§è¡Œ enq // è·å–é˜Ÿå°¾èŠ‚ç‚¹ Node pred = tail; if (pred != null) &#123; // è·å–é˜Ÿå°¾çš„å‰é©±èŠ‚ç‚¹ node.prev = pred; // CASè®¾ç½®æ–°çš„é˜Ÿå°¾ï¼Œæœ‰å¯èƒ½å¤±è´¥ if (compareAndSetTail(pred, node)) &#123; pred.next = node; return node; &#125; &#125; // å¦‚æœè¿˜æ²¡æœ‰é˜Ÿå°¾ï¼ˆåˆå§‹çŠ¶æ€ï¼‰ï¼Œæˆ–åˆ™å…¥é˜Ÿå¤±è´¥ï¼Œåˆ™æ‰§è¡Œä¸‹é¢çš„æ–¹æ³• enq(node); return node;&#125;private Node enq(final Node node) &#123; // é€šè¿‡CAS è‡ªæ—‹è®¾ç½®æ–°çš„é˜Ÿå°¾ for (;;) &#123; Node t = tail; // é˜Ÿå°¾èŠ‚ç‚¹ä¸ºç©ºï¼Œè¯´æ˜æ˜¯åˆå§‹çŠ¶æ€ï¼Œå¿…é¡»åˆå§‹åŒ–å¤´å°¾èŠ‚ç‚¹ if (t == null) &#123; // Must initialize if (compareAndSetHead(new Node())) tail = head; &#125; else &#123; // è¿™é‡Œæ³¨æ„ä¸€ä¸ªç»†èŠ‚ // node.prev = t æ“ä½œæ˜¯è®¾ç½®å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ä¸ºç°åœ¨çš„é˜Ÿå°¾èŠ‚ç‚¹ // ä½†æ˜¯è¯¥æ“ä½œæ²¡æœ‰æ”¾åˆ°compareAndSetTailæ“ä½œæˆåŠŸä»¥åï¼Œä¹Ÿå°±æ˜¯è¯´ä»£ç ä¸ºä½•ä¸è¿™æ ·å†™ // if (compareAndSetTail(t, node)) &#123; // node.prev = t; // t.next = node; // return t; // &#125;// å¦‚æœè¿™æ ·å­å†™çš„è¯ï¼Œé˜Ÿå°¾èŠ‚ç‚¹åœ¨æŸä¸€ç¬é—´ä¼šæ˜¯ä¸€ä¸ªå­¤ç«‹çš„èŠ‚ç‚¹ï¼Œä½†æ˜¯å¦‚æœå…ˆ// æ‰§è¡Œ node.prev = t å°±æŠŠå½“å‰èŠ‚ç‚¹çš„å‰é©±æŒ‡å‘äº†è¿˜æœªè®¾ç½®å‰çš„é˜Ÿå°¾ï¼Œè¿™æ ·å­å½“æˆ‘ä»¬ä»åå¾€å‰éå†çš„æ—¶å€™ï¼Œå°±ä¸ä¼šå‡ºç°é˜Ÿåˆ—æ–­è£‚çš„æƒ…å†µ node.prev = t; if (compareAndSetTail(t, node)) &#123; t.next = node; return t; &#125; &#125; &#125;&#125;/*** èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—ä¹‹åæ“ä½œï¼Œè¿™é‡Œåˆ†ä¸¤ç§æƒ…å†µ* 1\. å¦‚æœå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ä¸ºhead å¤´èŠ‚ç‚¹ï¼Œåˆ™å°è¯•è·å–é”ï¼Œå¹¶è®¾ç½®æ–°çš„å¤´èŠ‚ç‚¹ * 2\. é˜»å¡è‡ªå·± */final boolean acquireQueued(final Node node, int arg) &#123; boolean failed = true; try &#123; boolean interrupted = false; // å¾ªç¯å°è¯•è·å–é” for (;;) &#123; // è·å–å‰é©±èŠ‚ç‚¹ final Node p = node.predecessor(); // å‰é©±èŠ‚ç‚¹ä¸ºheadèŠ‚ç‚¹ åˆ™å°è¯•è·å–é” if (p == head &amp;&amp; tryAcquire(arg)) &#123; setHead(node); p.next = null; // help GC failed = false; return interrupted; &#125; // åˆ¤æ–­æ˜¯å¦éœ€è¦é˜»å¡è‡ªå·± if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) interrupted = true; &#125; &#125; finally &#123; // å¦‚æœæŠ›å¼‚å¸¸å¤±è´¥ï¼Œåˆ™è°ƒç”¨ cancelAcquire å–æ¶ˆè¯¥èŠ‚ç‚¹ if (failed) cancelAcquire(node); &#125;&#125;private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) &#123; int ws = pred.waitStatus; // å¦‚æœå‰é©±èŠ‚ç‚¹çš„ waitStatus ä¸º -1ï¼Œåˆ™è¯´æ˜å½“å‰çº¿ç¨‹éœ€è¦é˜»å¡ if (ws == Node.SIGNAL) /* * This node has already set status asking a release * to signal it, so it can safely park. */ return true; // waitStatuså¤§äº0ï¼Œè¯´æ˜å‰é©±èŠ‚ç‚¹ä¸ºå–æ¶ˆçŠ¶æ€ï¼Œéœ€è¦é‡æ–°è®¾ç½®å‰é©±èŠ‚ç‚¹ if (ws &gt; 0) &#123; // å‘å‰å¯»æ‰¾waitStatus&lt;=0çš„èŠ‚ç‚¹ï¼Œå¹¶è®¾ç½®ä¸ºæ–°çš„å‰é©±èŠ‚ç‚¹ do &#123; node.prev = pred = pred.prev; &#125; while (pred.waitStatus &gt; 0); pred.next = node; &#125; else &#123; /* * å¦‚æœå‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸º 0 -2 -3ï¼Œåˆ™è®¾ç½®å‰é©±èŠ‚ç‚¹ WaitStatus = -1ï¼Œå¹¶é‡æ–°å¾ªç¯ */ compareAndSetWaitStatus(pred, ws, Node.SIGNAL); &#125; return false;&#125;/** * è°ƒç”¨ LockSupport.park(this) é˜»å¡å½“å‰çº¿ç¨‹ */private final boolean parkAndCheckInterrupt() &#123; LockSupport.park(this); return Thread.interrupted();&#125;/*** å–æ¶ˆèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯å½“å‰çº¿ç¨‹æ”¾å¼ƒè·å–é” */private void cancelAcquire(Node node) &#123; if (node == null) return; node.thread = null; // è·å–å‰é©±èŠ‚ç‚¹ï¼Œä¼šè·³è¿‡çŠ¶æ€ä¸ºå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹ Skip cancelled predecessors Node pred = node.prev; while (pred.waitStatus &gt; 0) node.prev = pred = pred.prev; // è·å–åç»§èŠ‚ç‚¹ Node predNext = pred.next; // è®¾ç½®èŠ‚ç‚¹çŠ¶æ€ä¸ºå–æ¶ˆ node.waitStatus = Node.CANCELLED; // å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯é˜Ÿå°¾èŠ‚ç‚¹ï¼Œåˆ™è®¾ç½®å‰é©±èŠ‚ç‚¹ä¸ºé˜Ÿå°¾ï¼Œå¹¶è®¾ç½®å‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ä¸ºnull if (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123; compareAndSetNext(pred, predNext, null); &#125; else &#123; int ws; // å¦‚æœå‰é©±èŠ‚ç‚¹ä¸æ˜¯å¤´ç»“ç‚¹ï¼Œä¸”å‰é©±èŠ‚ç‚¹çš„ WaitStatus = -1 if (pred != head &amp;&amp; ((ws = pred.waitStatus) == Node.SIGNAL || (ws &lt;= 0 &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp; pred.thread != null) &#123; Node next = node.next; // å°†å‰ç½®èŠ‚ç‚¹å’Œåç»§èŠ‚ç‚¹ç›¸è¿ if (next != null &amp;&amp; next.waitStatus &lt;= 0) compareAndSetNext(pred, predNext, next); &#125; else &#123; // å”¤é†’åç»§èŠ‚ç‚¹ // è¿™é‡Œä¸ºä½•è¦å”¤é†’åç»§èŠ‚ç‚¹ï¼Ÿ // å› ä¸ºå¦‚æœå½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ä¸ºheadèŠ‚ç‚¹ï¼Œä½†æ˜¯æ­¤æ—¶headèŠ‚ç‚¹çš„çŠ¶æ€ä¸º0ï¼ˆå½“å‰èŠ‚ç‚¹è¿˜æœªæ¥å¾—åŠè®¾ç½®å‰ç½®èŠ‚ç‚¹çŠ¶æ€ä¸º -1ï¼‰ï¼Œè¿™æ—¶headèŠ‚ç‚¹é‡Šæ”¾äº†é”å› ä¸ºçŠ¶æ€è¿˜ä¸º0ï¼Œæ‰€ä»¥ä¸ä¼šå»å”¤é†’åç»§çº¿ç¨‹ã€‚è¿™æ—¶é˜Ÿåˆ—å°±å¤±å»æ´»æ€§äº†ï¼æ‰€ä»¥è¿™é‡Œéœ€è¦å”¤é†’åç»§çº¿ç¨‹ unparkSuccessor(node); &#125; node.next = node; // help GC &#125;&#125;/*** å”¤é†’åç»§èŠ‚ç‚¹ */private void unparkSuccessor(Node node) &#123; /* * å¦‚æœèŠ‚ç‚¹ waitStatus &lt; 0ï¼Œåˆ™å°è¯•å°†çŠ¶æ€è®¾ä¸º0 */ int ws = node.waitStatus; if (ws &lt; 0) compareAndSetWaitStatus(node, ws, 0); /* * è·å–å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ * å¦‚æœ s!=null ä¸” sæœªè¢«å–æ¶ˆ åˆ™ç›´æ¥å”¤é†’ */ Node s = node.next; if (s == null || s.waitStatus &gt; 0) &#123; s = null; // ä»å°¾èŠ‚ç‚¹å‘å‰æŸ¥æ‰¾ç¦»nodeæœ€è¿‘çš„éå–æ¶ˆèŠ‚ç‚¹ // æ³¨æ„è¿™é‡Œä¸ºä½•è¦ä»åå‘å‰æŸ¥æ‰¾ // åœ¨ enqæ–¹æ³•ä¸­æœ‰æ®µæ³¨é‡Šï¼Œå¦‚æœä»å‰å¾€åçš„è¯ï¼Œæœ‰å¯èƒ½å‡ºç°é˜Ÿåˆ—æ–­è£‚ for (Node t = tail; t != null &amp;&amp; t != node; t = t.prev) if (t.waitStatus &lt;= 0) s = t; &#125; if (s != null) LockSupport.unpark(s.thread);&#125; ä¸Šæ–‡åŸºæœ¬å®Œæˆäº†å¯¹ç‹¬å é”è·å–é”çš„æµç¨‹çš„åˆ†æï¼Œè¿™é‡Œç®€å•ç”»ä¸ªå›¾æ¥æ›´æ¸…æ™°çš„å±•ç¤ºæ•´ä¸ªè·å–é”çš„è¿‡ç¨‹ï¼š ç‹¬å é”çš„é‡Šæ”¾12345678910111213141516171819202122232425262728293031323334/** * é‡Šæ”¾é” */public final boolean release(int arg) &#123; // å¦‚æœé‡Šæ”¾é”æˆåŠŸ if (tryRelease(arg)) &#123; Node h = head; // ä¸”å½“å‰æŒé”çš„å¤´ç»“ç‚¹çŠ¶æ€ä¸ç­‰äº0ï¼Œå°±å»å”¤é†’åç»§çº¿ç¨‹ // æ€è€ƒè¿™é‡Œç­‰äº0 ä¸ºä½•ä¸è¡Œï¼Ÿ // å› ä¸ºå½“ waitStatus == 0æ—¶ï¼Œè¯´æ˜åç»§çº¿ç¨‹è¿˜åœ¨è¿è¡Œä¸­ï¼Œè¿˜æœªæ¥å¾—åŠå°†waitStatus çŠ¶æ€è®¾ä¸º-1 if (h != null &amp;&amp; h.waitStatus != 0) // ä¸ä¸Šæ–‡unparkSuccessoræ–¹æ³•ä¸€è‡´ unparkSuccessor(h); return true; &#125; return false;&#125; å…±äº«é”å…±äº«é”ä¸ç‹¬å é”æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼Œå…±äº«é”å…è®¸å¤šä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œè€Œç‹¬å é”åœ¨åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–åˆ°é” å…±äº«é”çš„è·å–123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166/*** è·å–å…±äº«é” */public final void acquireShared(int arg) &#123; // å¦‚æœtryAcquireShared(arg) &lt; 0è¡¨ç¤ºè·å–å…±äº«é”å¤±è´¥ // è·å–å¤±è´¥çš„åŸå› ä¸€èˆ¬æ˜¯ç”±äºè¯¥èµ„æºæ­£ç”±ç‹¬å é”å æœ‰ if (tryAcquireShared(arg) &lt; 0) doAcquireShared(arg);&#125;private void doAcquireShared(int arg) &#123; // åŠ å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ final Node node = addWaiter(Node.SHARED); boolean failed = true; try &#123; boolean interrupted = false; for (;;) &#123; final Node p = node.predecessor(); if (p == head) &#123; int r = tryAcquireShared(arg); // ä¸€æ—¦å…±äº«è·å–æˆåŠŸï¼Œè®¾ç½®æ–°çš„å¤´ç»“ç‚¹ï¼Œå¹¶ä¸”å”¤é†’åç»§çº¿ç¨‹ if (r &gt;= 0) &#123; setHeadAndPropagate(node, r); p.next = null; // help GC if (interrupted) selfInterrupt(); failed = false; return; &#125; &#125; // åˆ¤æ–­æ˜¯å¦éœ€è¦é˜»å¡ if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) interrupted = true; &#125; &#125; finally &#123; if (failed) cancelAcquire(node); &#125;&#125;/*** åœ¨è·å–å…±äº«é”æˆåŠŸåï¼Œè®¾ç½®headèŠ‚ç‚¹* è·Ÿæ®è°ƒç”¨tryAcquireSharedè¿”å›çš„çŠ¶æ€ä»¥åŠèŠ‚ç‚¹æœ¬èº«çš„ç­‰å¾…çŠ¶æ€æ¥åˆ¤æ–­æ˜¯å¦è¦éœ€è¦å”¤é†’åç»§çº¿ç¨‹ã€‚ */private void setHeadAndPropagate(Node node, int propagate) &#123; Node h = head; setHead(node); /* * propagateæ˜¯tryAcquireSharedçš„è¿”å›å€¼ï¼Œè¿™æ˜¯å†³å®šæ˜¯å¦ä¼ æ’­å”¤é†’çš„ä¾æ®ä¹‹ä¸€ã€‚ * h.waitStatusä¸ºSIGNALæˆ–è€…PROPAGATEæ—¶ä¹Ÿæ ¹æ®nodeçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å…±äº«æ¥å†³å®šæ˜¯å¦ä¼ æ’­å”¤é†’ï¼Œ * æ€è€ƒï¼Œè¿™é‡Œä¸ºä»€ä¹ˆä¸èƒ½åªç”¨propagate &gt; 0æ¥å†³å®šæ˜¯å¦å¯ä»¥ä¼ æ’­ * å› ä¸ºæ­¤æ—¶æœ‰å¯èƒ½æœ‰å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œä½†propagateè¿˜æœªæ›´æ–°ï¼Œæ‰€ä»¥è¿˜éœ€è¦åˆ¤æ–­h.waitStatus &lt; 0 */ if (propagate &gt; 0 || h == null || h.waitStatus &lt; 0 || (h = head) == null || h.waitStatus &lt; 0) &#123; Node s = node.next; // åç»§èŠ‚ç‚¹ä¸ºå…±äº«é”ç±»å‹ if (s == null || s.isShared()) doReleaseShared(); &#125;&#125;/*** è¿™æ˜¯å…±äº«é”ä¸­çš„æ ¸å¿ƒå”¤é†’å‡½æ•°ï¼Œä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯å”¤é†’ä¸‹ä¸€ä¸ªçº¿ç¨‹æˆ–è€…è®¾ç½®ä¼ æ’­çŠ¶æ€ã€‚ */private void doReleaseShared() &#123; for (;;) &#123; Node h = head; // å¦‚æœé˜Ÿåˆ—ä¸­å­˜åœ¨åç»§çº¿ç¨‹ã€‚ if (h != null &amp;&amp; h != tail) &#123; int ws = h.waitStatus; if (ws == Node.SIGNAL) &#123; if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0)) continue; unparkSuccessor(h); &#125; // å¦‚æœhèŠ‚ç‚¹çš„çŠ¶æ€ä¸º0ï¼Œéœ€è¦è®¾ç½®ä¸ºPROPAGATEç”¨ä»¥ä¿è¯å”¤é†’çš„ä¼ æ’­ã€‚ else if (ws == 0 &amp;&amp; !compareAndSetWaitStatus(h, 0, Node.PROPAGATE)) continue; &#125; if (h == head) break; &#125;&#125; å…±äº«é”çš„é‡Šæ”¾12345678910111213141516public final boolean releaseShared(int arg) &#123; if (tryReleaseShared(arg)) &#123; // ä¸ä¸Šæ–‡doReleaseSharedä¸€æ · doReleaseShared(); return true; &#125; return false;&#125; æ€»ç»“AQSçš„æ•´ä½“ç†å¿µç›¸å¯¹æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œä½†æ˜¯AQSçœŸæ­£éš¾æ‡‚çš„å…¶å®æ˜¯å®ƒçš„ç»†èŠ‚ï¼Œå› ä¸ºä¸€ä¸ªå¾ˆç®€å•çš„é—®é¢˜ä¸€æ—¦è¢«æ”¾åœ¨å¹¶å‘ç¯å¢ƒä¸­å°±ä¼šå˜çš„éå¸¸æŠ½è±¡ï¼Œéš¾ä»¥ç†è§£ã€‚è¦ç†è§£AQSçš„ç»†èŠ‚å®ç°ï¼Œè¿˜æ˜¯éœ€è¦å¤šçœ‹ï¼Œæˆ‘æ˜¯å‰å‰ååçœ‹äº†æœ‰ä¸€å‘¨ï¼Œå¯¹äºæœ‰äº›ç»†èŠ‚è¿˜æ˜¯ç•¥æ¨¡ç³Šã€‚ æœ¬ç¯‡æ–‡ç« å‚è€ƒäº† AbstractQueuedSynchronizeræºç è§£è¯»]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
        <category>å¹¶å‘ç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>å¹¶å‘</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Java CAS]]></title>
    <url>%2F2019%2F03%2F02%2FJava-CAS%2F</url>
    <content type="text"><![CDATA[å¼•è¨€åœ¨ä»‹ç»CASä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆç†è§£çº¿ç¨‹å®‰å…¨çš„ä¸‰å¤§ç‰¹æ€§ åŸå­æ€§: å¯¹äºæ¶‰åŠå…±äº«å˜é‡è®¿é—®çš„æ“ä½œï¼Œè¯¥æ“ä½œä»å…¶æ‰§è¡Œçº¿ç¨‹ä»¥å¤–çš„ä»»æ„çº¿ç¨‹æ¥çœ‹æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œä»è€Œå¯ä»¥è®©å„ä¸ªçº¿ç¨‹ä¾æ¬¡ä¸²è¡Œè®¿é—®ï¼Œä½†æ˜¯åŸå­æ€§å¹¶ä¸ä¿è¯å¯è§æ€§ å¯è§æ€§: ä¿®æ”¹å…±äº«å˜é‡æ—¶ï¼Œç«‹å³å°†å·¥ä½œå†…å­˜ä¸­çš„å€¼åŒæ­¥åˆ°ä¸»å­˜ä¸­ï¼Œå¹¶ä½¿è¯¥ä¿®æ”¹å¯¹å…¶ä»–çº¿ç¨‹å¯è§ æœ‰åºæ€§: ç¦æ­¢è¯»å–å…±äº«å˜é‡åçš„ä»£ç ã€ä¿®æ”¹å…±äº«å˜é‡å‰çš„ä»£ç é‡æ’åº CASå³compare and swapçš„ç¼©å†™ï¼Œä¸­æ–‡ç¿»è¯‘æˆæ¯”è¾ƒå¹¶äº¤æ¢ã€‚æ˜¯ä¸€ç§ç”¨äºåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å®ç°åŒæ­¥åŠŸèƒ½çš„æœºåˆ¶ã€‚è°ƒç”¨Java CASéœ€è¦ä¸‰ä¸ªæ“ä½œæ•° å†…å­˜ä¸­å€¼çš„å†…å­˜ä½ç½® é¢„æœŸå€¼ æ–°å€¼ å…·ä½“å®ç°æ˜¯é€šè¿‡å€¼çš„å†…å­˜ä½ç½®å–åˆ°å†…å­˜ä¸­çš„å€¼å¹¶ä¸é¢„æœŸå€¼æ¯”è¾ƒï¼Œè‹¥ç›¸ç­‰ï¼Œåˆ™å°†å†…å­˜ä½ç½®å¤„çš„å€¼æ›¿æ¢ä¸ºæ–°å€¼ï¼Œè‹¥ä¸ç›¸ç­‰ï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œè¿”å›falseã€‚å¦‚æœå¤§å®¶æœ‰äº†è§£è¿‡æ‚²è§‚é”å’Œä¹è§‚é”ï¼Œå¯ä»¥å‘ç°CASå…¶å®æ˜¯ä¸€ç§ä¹è§‚é”çš„å®ç°ã€‚ ä½¿ç”¨CASçš„ç›®çš„å¯¹äºå®ç°çº¿ç¨‹å®‰å…¨ï¼Œæˆ‘ä»¬ç”¨çš„æ¯”è¾ƒå¤šçš„åº”è¯¥æ˜¯synchronizedå…³é”®å­—ï¼Œsynchronizedå…¶å®æ˜¯ä¸€ç§æ‚²è§‚é”ï¼Œé”è¢«å ç”¨çš„æƒ…å†µä¼šå¯¼è‡´å…¶å®ƒæ‰€æœ‰éœ€è¦é”çš„çº¿ç¨‹æŒ‚èµ·ï¼Œç­‰å¾…æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾é”ã€‚CASæ˜¯ä¸€ç§ä¹è§‚é”ï¼Œæ¯æ¬¡å–æ•°æ®éƒ½ä¸ä¼šåŠ é”ï¼Œæ›´æ–°çš„æ—¶å€™ä¼šè¿›è¡Œæ•°æ®æ¯”å¯¹ï¼Œæœ‰å†²çªçš„è¯åˆ™ä¼šè‡ªæ—‹é‡è¯•ã€‚å¯ä»¥çœ‹åˆ°åœ¨è¯»æ“ä½œé¢‘ç¹ï¼Œæ›´æ–°é¢‘ç‡ä½ï¼Œå†²çªæ¦‚ç‡ä½çš„æƒ…å†µä¸‹ï¼Œç”¨CASçš„è¯ä¼šæ›´åŠ åˆç†ã€‚å½“ç„¶JDK1.6ä¹‹åï¼ŒJavaå¯¹synchronizedå…³é”®å­—æ¥äº†ä¸€å¤§æ³¢ä¼˜åŒ–ï¼ˆè‡ªæ—‹é”ï¼Œé”æ¶ˆé™¤ï¼Œé”ç²—åŒ–ï¼Œåå‘é”ï¼Œè½»é‡çº§é”ï¼‰ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨synchronizedæ˜¯éå¸¸ç¨³å®šçš„ã€‚ CASçš„åº•å±‚å®ç°ç°åœ¨çš„CPUéƒ½æ˜¯å¤šæ ¸å¿ƒçš„ï¼Œå¤šä¸ªæ ¸å¿ƒé€šè¿‡æ€»çº¿æ¥æ“ä½œå†…å­˜ã€‚é‚£ä¹ˆè¿™é‡Œå°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœå¤šä¸ªæ ¸å¿ƒåŒæ—¶æ“ä½œä¸€å—å†…å­˜åŒºåŸŸï¼Œä¼šå‘ç”Ÿä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿæ˜¯çš„ï¼Œè¿™é‡Œæ•°æ®å°±ä¼šå‡ºç°æ··ä¹±ã€‚ä¸è¿‡è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä»intelçš„ä½¿ç”¨æ‰‹å†Œä¸­æ‰¾åˆ°ç­”æ¡ˆï¼Œå¯¹æŒ‡ä»¤åŠ lockå‰ç¼€å¯ä»¥ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œå¯è§æ€§ä»¥åŠæœ‰åºæ€§ã€‚å¥½äº†ï¼Œåº•å±‚çš„å°±ä¸å¤šè¯´äº†ï¼Œæˆ‘ä»¬ç›´æ¥å»çœ‹ä¸€ä¸‹java.util.concurrent.atomicåŒ…ä¸‹çš„åŸå­ç±» AtomicIntegerçš„æºç å®ç° AtomicIntegeræºç 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public class AtomicInteger extends Number implements java.io.Serializable &#123; private static final long serialVersionUID = 6214790243416807050L; // setup to use Unsafe.compareAndSwapInt for updates private static final Unsafe unsafe = Unsafe.getUnsafe(); // valueå€¼çš„å†…å­˜ä½ç½® private static final long valueOffset; static &#123; try &#123; // è·å–valueçš„å†…å­˜ä½ç½® valueOffset = unsafe.objectFieldOffset (AtomicInteger.class.getDeclaredField(&quot;value&quot;)); &#125; catch (Exception ex) &#123; throw new Error(ex); &#125; &#125; // valueå€¼ volatile ä¿®é¥° ä¿è¯å¯è§æ€§ private volatile int value; public AtomicInteger(int initialValue) &#123; value = initialValue; &#125; public AtomicInteger() &#123; &#125; /** * è·å–valueåœ¨å†…å­˜ä¸­å½“å‰çš„å€¼ * * @return the current value */ public final int get() &#123; return value; &#125; /** * æ¯”è¾ƒå¹¶æ›¿æ¢ å®ç°åœ¨unsafe.compareAndSwapIntä¸­ * @param expect æœŸæœ›å€¼ * @param update æ–°å€¼ */ public final boolean compareAndSet(int expect, int update) &#123; return unsafe.compareAndSwapInt(this, valueOffset, expect, update); &#125; /** * è‡ªå¢ å®ç°åœ¨unsafe.getAndAddIntä¸­ */ public final int incrementAndGet() &#123; return unsafe.getAndAddInt(this, valueOffset, 1) + 1; &#125;&#125; Unsafe.class 12345678910111213public final native boolean compareAndSwapInt(Object o, long valueOffset, int expected, int value);/** * è·å–å½“å‰å€¼ å¹¶åŠ 1ï¼Œè¿”å›çš„æ˜¯åŠ 1å‰çš„å€¼ */public final int getAndAddInt(Object o, long valueOffset, int addValue) &#123; int currentValue; do &#123; currentValue = this.getIntVolatile(o, valueOffset); // æ¯”è¾ƒå½“å‰å†…å­˜çš„å€¼å’Œé¢„æœŸå€¼currentValueæ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´çš„è¯åˆ™è®¾ç½®æ–°å€¼ã€‚ä½†æ˜¯å› ä¸ºå½“å‰å†…å­˜ä¸­çš„å€¼æœ‰å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œä¼šæœ‰å’Œé¢„æœŸå€¼ä¸ä¸€è‡´çš„æƒ…å†µï¼Œæ‰€ä»¥è¿™é‡Œä¼šå¾ªç¯ç›´åˆ° compareAndSwapInt è¿”å›æˆåŠŸä¸ºæ­¢ï¼Œè¿™é‡Œçš„æ“ä½œä¹Ÿç§°ä¸ºCASè‡ªæ—‹ &#125; while(!this.compareAndSwapInt(o, valueOffset, currentValue, value + addValue)); return value;&#125; AtomicIntegeræ˜¯Javaå¯¹Integerç±»å‹åŸå­æ€§æ“ä½œçš„å®ç°ï¼Œå¯ä»¥çœ‹åˆ°åº•å±‚éƒ½æ˜¯è°ƒç”¨äº†CAS compareAndSwapIntnativeæ–¹æ³•ã€‚è¿™é‡Œä¸»è¦çœ‹ä¸€ä¸‹compareAndSwapInt(Object o, long valueOffset, int expect, int update)çš„å››ä¸ªå‚æ•° o å½“å‰æ“ä½œçš„å¯¹è±¡ valueOffset æ“ä½œå€¼æ‰€åœ¨çš„å†…å­˜ä½ç½® expect æœŸæœ›å€¼ update æ–°å€¼ å…·ä½“å®ç°æ˜¯å°†å†…å­˜ä½ç½®å¤„çš„æ•°å€¼ä¸é¢„æœŸæ•°å€¼ç›¸æ¯”è¾ƒï¼Œè‹¥ç›¸ç­‰ï¼Œåˆ™å°†å†…å­˜ä½ç½®å¤„çš„å€¼æ›¿æ¢ä¸ºæ–°å€¼ã€‚è‹¥ä¸ç›¸ç­‰ï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œã€‚CASè‡ªæ—‹æŒ‡çš„æ˜¯æ›¿æ¢æ–°å€¼å¤±è´¥æ—¶ä¼šè¿›å…¥å¾ªç¯ï¼Œé‡æ–°è·å–æœŸæœ›å€¼ï¼Œç›´åˆ°æœŸæœ›å€¼å’Œå†…å­˜ä½ç½®å¤„çš„æ•°å€¼ç›¸ç­‰ã€‚ CASçš„é—®é¢˜ABAé—®é¢˜æåˆ°CASå­˜åœ¨çš„é—®é¢˜ï¼Œå°±ä¸å¾—ä¸æABAé—®é¢˜ï¼Œä»€ä¹ˆæ˜¯ABAé—®é¢˜å‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼ŒAæ˜¯ä¸ªå…±äº«å˜é‡ï¼ŒåŸå€¼æ˜¯10ï¼Œçº¿ç¨‹1ä»å†…å­˜ä¸­æ‹¿åˆ°äº†Aï¼Œæ­¤æ—¶å€¼ä¸º10ï¼Œå½“çº¿ç¨‹1è¦å¯¹å˜é‡Aè¿›è¡ŒCASæ“ä½œå‰ï¼Œå› ä¸ºå…¶ä»–çº¿ç¨‹çš„æ“ä½œï¼ŒAä»10å˜ä¸ºäº†11ï¼Œåˆä»11å˜å›äº†10ã€‚æ­¤æ—¶çº¿ç¨‹1å¯¹å˜é‡Aæ‰§è¡ŒCASæ“ä½œç…§é“ç†åº”è¯¥æ˜¯è¦å¤±è´¥çš„ï¼Œä½†å®é™…å´æ˜¯æˆåŠŸçš„ã€‚è¿™æ˜¯å› ä¸ºç»è¿‡äº†ä¸Šé¢çš„æµç¨‹ï¼Œåœ¨çº¿ç¨‹1çœ‹æ¥ï¼Œå˜é‡Aæ²¡æœ‰å‘ç”Ÿä»»ä½•å˜åŒ–ï¼Œæ‰€ä»¥å®ƒæ‰§è¡ŒCASæ“ä½œæ˜¯ä¼šæˆåŠŸçš„ã€‚ è¦è§£å†³ABAé—®é¢˜ï¼Œé€šå¸¸çš„è§£å†³æ–¹æ¡ˆç»™å¯¹è±¡åŠ ä¸Šç‰ˆæœ¬å·ï¼Œæ¯ç»è¿‡ä¸€æ¬¡CASæ“ä½œå°±æ›´æ–°ä¸€æ¬¡ç‰ˆæœ¬å· æ€»ç»“æœ¬æ–‡çš„ç›®çš„ä¸»è¦æ˜¯è®©è‡ªå·±å¯¹javaå¹¶å‘åŒ…çš„åŸºç¡€CASæœ‰ä¸ªç®€å•çš„äº†è§£ï¼Œä»¥ä¾¿è¿›è¡Œåç»­çš„æºç åˆ†æ]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
        <category>å¹¶å‘ç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>å¹¶å‘</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Tomcatæºç è§£æä¸‰ Connectorè¿æ¥å™¨]]></title>
    <url>%2F2019%2F02%2F13%2FTomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89-Connector%E8%BF%9E%E6%8E%A5%E5%99%A8%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ä¸Šæ–‡åˆ†æäº†Tomcatçš„å¯åŠ¨æµç¨‹ï¼Œæˆ‘ä»¬å·²ç»å¤§è‡´ç†æ¸…äº†Tomcatå¯åŠ¨çš„æ•´ä¸ªæµç¨‹ï¼Œæœ¬æ–‡å°†ä¼šå¯¹Connectorè¿æ¥å™¨çš„åˆ›å»ºè¿›è¡Œåˆ†æ æ•´ä½“æ¶æ„ ä¸Šå›¾å®Œæ•´äº†æ¦‚æ‹¬äº†æ•´ä¸ªConnectorçš„æ¶æ„ä½“ç³»ï¼Œå…ˆç®€å•çš„ä»‹ç»ä¸€ä¸‹å„ä¸ªç»„ä»¶çš„åŠŸèƒ½ Endpoint ç”¨æ¥å¤„ç†åº•å±‚Socketçš„ç½‘ç»œè¿æ¥ Processor ç”¨æ¥å®ç°HTTPåè®®çš„ Adapter å°†è¯·æ±‚é€‚é…åˆ°Servletå®¹å™¨è¿›è¡Œå…·ä½“çš„å¤„ç† org.apache.catalina.connector.Connectoræˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹org.apache.catalina.connector.Connectorè¿™ä¸ªä¸»ä½“ç±»çš„æ„é€ æ–¹æ³•ï¼ŒConnectorç±»åˆå§‹åŒ–æ˜¯åœ¨Tomcatè¯»å–é…ç½®æ–‡ä»¶æ—¶å°±å®Œæˆçš„ 1234567891011121314151617181920212223242526272829303132333435public Connector(String protocol) &#123; boolean aprConnector = AprLifecycleListener.isAprAvailable() &amp;&amp; AprLifecycleListener.getUseAprConnector(); // åˆ¤æ–­åè®®ç±»å‹ if (&quot;HTTP/1.1&quot;.equals(protocol) || protocol == null) &#123; if (aprConnector) &#123; protocolHandlerClassName = &quot;org.apache.coyote.http11.Http11AprProtocol&quot;; &#125; else &#123; protocolHandlerClassName = &quot;org.apache.coyote.http11.Http11NioProtocol&quot;; &#125; &#125; else if (&quot;AJP/1.3&quot;.equals(protocol)) &#123; if (aprConnector) &#123; protocolHandlerClassName = &quot;org.apache.coyote.ajp.AjpAprProtocol&quot;; &#125; else &#123; protocolHandlerClassName = &quot;org.apache.coyote.ajp.AjpNioProtocol&quot;; &#125; &#125; else &#123; protocolHandlerClassName = protocol; &#125; // Instantiate protocol handler ProtocolHandler p = null; try &#123; Class&lt;?&gt; clazz = Class.forName(protocolHandlerClassName); p = (ProtocolHandler) clazz.getConstructor().newInstance(); &#125; catch (Exception e) &#123; log.error(ä»€ä¹ˆ.getString( &quot;coyoteConnector.protocolHandlerInstantiationFailed&quot;), e); &#125; finally &#123; this.protocolHandler = p; &#125; // Default for Connector depends on this system property setThrowOnFailure(Boolean.getBoolean(&quot;org.apache.catalina.startup.EXIT_ON_INIT_FAILURE&quot;));&#125; è¿™é‡Œå…¶å®æ˜¯æ‹¿åˆ°server.xmlä¸­Connectorçš„åè®®é…ç½®ï¼Œåˆ©ç”¨åå°„åˆ›å»ºProtocolHandleï¼ŒConnectorå°±æ˜¯ä½¿ç”¨ProtocolHandleræ¥å¤„ç†è¯·æ±‚çš„ï¼Œä¸åŒçš„ProtocolHandlerä»£è¡¨ä¸åŒçš„è¿æ¥ç±»å‹ã€‚ å› ä¸ºæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯tomcat9çš„æºç ç‰ˆæœ¬ï¼Œå¯ä»¥çœ‹åˆ°å…¶å·²ç»æ·˜æ±°äº†BIOã€‚é»˜è®¤çš„http1.1åè®®å¤„ç†ç±»å·²ç»æ˜¯org.apache.coyote.http11NioProtocoläº†ï¼Œä¸‹é¢æˆ‘ä»¬å°±ä»¥http11NioProtocolç»§ç»­å¾€ä¸‹åˆ†æ org.apache.coyote.http11NioProtocolé€šè¿‡æŸ¥çœ‹Http11NioProtocolçš„æ„é€ æ–¹æ³•ï¼Œå¯çŸ¥Endpointçš„å®ç°ç±»æ˜¯NioEndpoint123public Http11NioProtocol() &#123; super(new NioEndpoint());&#125; Endpointä¸Šæ–‡æœ‰è¯´è¿‡æ˜¯ç”¨æ¥å¤„ç†åº•å±‚Socketç½‘ç»œè¿æ¥çš„ï¼Œä¸‹é¢å°±è®©æˆ‘ä»¬æ¥çœ‹ä¸‹NioEndpointçš„å®ç° NioEndpointè¿˜æ˜¯å…ˆçœ‹ä¸‹å¯åŠ¨æ–¹æ³• startInternalä¸­çš„å®ç°123456789101112131415public void startInternal() throws Exception &#123; ..... // åˆå§‹åŒ–Polleræ•°ç»„ï¼Œå¯åŠ¨Pollerçº¿ç¨‹ pollers = new Poller[getPollerThreadCount()]; for (int i=0; i&lt;pollers.length; i++) &#123; pollers[i] = new Poller(); Thread pollerThread = new Thread(pollers[i], getName() + &quot;-ClientPoller-&quot;+i); pollerThread.setPriority(threadPriority); pollerThread.setDaemon(true); pollerThread.start(); &#125; // å¯åŠ¨ Acceptor çº¿ç¨‹ startAcceptorThreads(); &#125;&#125; è¿™é‡Œæˆ‘çœç•¥äº†å…¶ä»–ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°åœ¨è¿™é‡Œåˆå§‹åŒ–äº†å¤šä¸ªPollerç±»ï¼Œå¹¶å•ç‹¬å¯åŠ¨äº†çº¿ç¨‹ï¼Œè¿™é‡Œçš„æ¯ä¸ªPollerå…¶å®éƒ½ç»‘å®šäº†ä¸€ä¸ªSelectoré€‰æ‹©å™¨ï¼ˆï¼‰ã€‚å¹¶ä¸”è°ƒç”¨startAcceptorThreadsæ–¹æ³•å¯åŠ¨äº†Acceptorçº¿ç¨‹ï¼Œç”¨æ¥æ¥æ”¶æ–°çš„è¯·æ±‚ã€‚ä¸‹é¢æˆ‘ä»¬ç»§ç»­çœ‹startAcceptorThreadsæ–¹æ³• 12345678910111213141516protected void startAcceptorThreads() &#123; // è·å–Acceptorçº¿ç¨‹æ•° é»˜è®¤æ˜¯1 int count = getAcceptorThreadCount(); acceptors = new ArrayList&lt;&gt;(count); for (int i = 0; i &lt; count; i++) &#123; Acceptor&lt;U&gt; acceptor = new Acceptor&lt;&gt;(this); String threadName = getName() + &quot;-Acceptor-&quot; + i; acceptor.setThreadName(threadName); acceptors.add(acceptor); Thread t = new Thread(acceptor, threadName); t.setPriority(getAcceptorThreadPriority()); t.setDaemon(getDaemon()); t.start(); &#125;&#125; ä¸Šé¢çš„ä»£ç æ ¹æ®é…ç½®å¯åŠ¨äº†å¤šä¸ªAcceptorçº¿ç¨‹ï¼Œä¸‹é¢å°±å»çœ‹ä¸‹Acceptorç±»çš„runæ–¹æ³• Acceptor1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980public void run() &#123; int errorDelay = 0; // Loop until we receive a shutdown command while (endpoint.isRunning()) &#123; .... try &#123; // æ¥æ”¶æ–°çš„è¯·æ±‚ socket = endpoint.serverSocketAccept(); &#125; catch (Exception ioe) &#123; // We didn&apos;t get a socket endpoint.countDownConnection(); if (endpoint.isRunning()) &#123; // Introduce delay if necessary errorDelay = handleExceptionWithDelay(errorDelay); // re-throw throw ioe; &#125; else &#123; break; &#125; &#125; // Successful accept, reset the error delay errorDelay = 0; // Configure the socket if (endpoint.isRunning() &amp;&amp; !endpoint.isPaused()) &#123; // è®¾ç½®æ–°çš„Socketè¿æ¥ä¸Pollerç»‘å®šï¼Œå¹¶è®¾ç½®ç›¸å…³å‚æ•° if (!endpoint.setSocketOptions(socket)) &#123; endpoint.closeSocket(socket); &#125; &#125; else &#123; endpoint.destroySocket(socket); &#125; &#125; catch (Throwable t) &#123; &#125; state = AcceptorState.ENDED;&#125;// NioEndpoint.class ä¸­protected boolean setSocketOptions(SocketChannel socket) &#123; // Process the connection try &#123; // è®¾ç½®æ­¤Socketè¿æ¥æœªéé˜»å¡ socket.configureBlocking(false); Socket sock = socket.socket(); // è®¾ç½®æ­¤Socketçš„ç›¸å…³å‚æ•°å€¼ socketProperties.setProperties(sock); NioChannel channel = nioChannels.pop(); if (channel == null) &#123; SocketBufferHandler bufhandler = new SocketBufferHandler( socketProperties.getAppReadBufSize(), socketProperties.getAppWriteBufSize(), socketProperties.getDirectBuffer()); // åˆ¤æ–­æ˜¯å¦å¼€å¯ssl if (isSSLEnabled()) &#123; channel = new SecureNioChannel(socket, bufhandler, selectorPool, this); &#125; else &#123; channel = new NioChannel(socket, bufhandler); &#125; &#125; else &#123; channel.setIOChannel(socket); channel.reset(); &#125; // ç»‘å®š Poller å…¶å®å°±æ˜¯ç»‘å®šé€‰æ‹©å™¨ Selector getPoller0().register(channel); &#125; catch (Throwable t) &#123; ExceptionUtils.handleThrowable(t); try &#123; log.error(sm.getString(&quot;endpoint.socketOptionsError&quot;), t); &#125; catch (Throwable e) &#123; ExceptionUtils.handleThrowable(e); &#125; // Tell to close the socket return false; &#125; return true;&#125; ä¸Šé¢ä»£ç é€»è¾‘ä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ… è°ƒç”¨NioEndpointçš„serverSocketAcceptæ–¹æ³•æ¥æ¥æ”¶æ–°çš„è¯·æ±‚ï¼Œæ³¨æ„è¿™é‡Œæ˜¯é˜»å¡çš„ è°ƒç”¨NioEndpointçš„setSocketOptionsæ–¹æ³•å¯¹æ–°æ¥æ”¶çš„Socketè¯·æ±‚ï¼Œé…ç½®ç›¸å…³ä¿¡æ¯ï¼Œå¹¶ç»‘å®šPoller(ç»‘å®šé€‰æ‹©å™¨ Selector) Polleræ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¼šåˆ†æPollerç±»ï¼Œæ˜¯NioEndpointçš„å†…éƒ¨ç±» 123456789101112131415public void register(final NioChannel socket) &#123; socket.setPoller(this); NioSocketWrapper ka = new NioSocketWrapper(socket, NioEndpoint.this); socket.setSocketWrapper(ka); ka.setPoller(this); ka.setReadTimeout(getConnectionTimeout()); ka.setWriteTimeout(getConnectionTimeout()); ka.setKeepAliveLeft(NioEndpoint.this.getMaxKeepAliveRequests()); ka.setSecure(isSSLEnabled()); PollerEvent r = eventCache.pop(); ka.interestOps(SelectionKey.OP_READ);//this is what OP_REGISTER turns into. if ( r==null) r = new PollerEvent(socket,ka,OP_REGISTER); else r.reset(socket,ka,OP_REGISTER); addEvent(r);&#125; registeræ–¹æ³•å°±æ˜¯å°†æ–°çš„Socketè¿æ¥ä¸Selectorè¿›è¡Œç»‘å®šï¼Œå¹¶æ³¨å†Œç›‘å¬è¯»äº‹ä»¶ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859public void run() &#123; // Loop until destroy() is called while (true) &#123; boolean hasEvents = false; try &#123; if (!close) &#123; hasEvents = events(); if (wakeupCounter.getAndSet(-1) &gt; 0) &#123; //if we are here, means we have other stuff to do //do a non blocking select keyCount = selector.selectNow(); &#125; else &#123; keyCount = selector.select(selectorTimeout); &#125; wakeupCounter.set(0); &#125; if (close) &#123; events(); timeout(0, false); try &#123; selector.close(); &#125; catch (IOException ioe) &#123; log.error(ä»€ä¹ˆ.getString(&quot;endpoint.nio.selectorCloseFail&quot;), ioe); &#125; break; &#125; &#125; catch (Throwable x) &#123; ExceptionUtils.handleThrowable(x); log.error(ä»€ä¹ˆ.getString(&quot;endpoint.nio.selectorLoopError&quot;), x); continue; &#125; //either we timed out or we woke up, process events first if ( keyCount == 0 ) hasEvents = (hasEvents | events()); Iterator&lt;SelectionKey&gt; iterator = keyCount &gt; 0 ? selector.selectedKeys().iterator() : null; // Walk through the collection of ready keys and dispatch // any active event. while (iterator != null &amp;&amp; iterator.hasNext()) &#123; SelectionKey sk = iterator.next(); NioSocketWrapper attachment = (NioSocketWrapper)sk.attachment(); // Attachment may be null if another thread has called // cancelledKey() if (attachment == null) &#123; iterator.remove(); &#125; else &#123; iterator.remove(); processKey(sk, attachment); &#125; &#125;//while //process timeouts timeout(keyCount,hasEvents); &#125;//while getStopLatch().countDown();&#125; runæ–¹æ³•ä¸­çš„ä¸€å¤§å †ä»£ç ï¼Œå¤šæ˜¯ä¸NIOç›¸å…³ï¼Œä¸»è¦é€»è¾‘å°±æ˜¯è°ƒç”¨selectorçš„select()å‡½æ•°ï¼Œç›‘å¬å°±ç»ªäº‹ä»¶ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥çœ‹processKeyæ–¹æ³•ï¼Œè¿™é‡Œæ˜¯æ ¹æ®SelectionKeyæ¥åˆ†åˆ«æ‰§è¡Œå…·ä½“é€»è¾‘ 12345678910111213141516171819202122232425262728293031323334353637383940protected void processKey(SelectionKey sk, NioSocketWrapper attachment) &#123; try &#123; if ( close ) &#123; cancelledKey(sk); &#125; else if ( sk.isValid() &amp;&amp; attachment != null ) &#123; if (sk.isReadable() || sk.isWritable() ) &#123; if ( attachment.getSendfileData() != null ) &#123; processSendfile(sk,attachment, false); &#125; else &#123; unreg(sk, attachment, sk.readyOps()); boolean closeSocket = false; // å¦‚æœæ˜¯å¯è¯»äº‹ä»¶å°±ç»ª if (sk.isReadable()) &#123; // æ‰§è¡Œå…·ä½“é€»è¾‘çš„åœ°æ–¹ if (!processSocket(attachment, SocketEvent.OPEN_READ, true)) &#123; closeSocket = true; &#125; &#125; // å¦‚æœæ˜¯å¯å†™äº‹ä»¶å°±ç»ª if (!closeSocket &amp;&amp; sk.isWritable()) &#123; if (!processSocket(attachment, SocketEvent.OPEN_WRITE, true)) &#123; closeSocket = true; &#125; &#125; if (closeSocket) &#123; cancelledKey(sk); &#125; &#125; &#125; &#125; else &#123; //invalid key cancelledKey(sk); &#125; &#125; catch ( CancelledKeyException ckx ) &#123; cancelledKey(sk); &#125; catch (Throwable t) &#123; ExceptionUtils.handleThrowable(t); log.error(sm.getString(&quot;endpoint.nio.keyProcessingError&quot;), t); &#125;&#125; processKeyæ–¹æ³•ä¹Ÿæ˜¯ç›´æ¥è°ƒç”¨äº†AbstractEndpointçš„processSocketæ–¹æ³• 1234567891011121314151617181920212223242526272829303132public boolean processSocket(SocketWrapperBase&lt;S&gt; socketWrapper, SocketEvent event, boolean dispatch) &#123; try &#123; if (socketWrapper == null) &#123; return false; &#125; SocketProcessorBase&lt;S&gt; sc = processorCache.pop(); if (sc == null) &#123; // åˆ›å»ºä¸€ä¸ª SocketProcessor å®ä¾‹ sc = createSocketProcessor(socketWrapper, event); &#125; else &#123; sc.reset(socketWrapper, event); &#125; Executor executor = getExecutor(); if (dispatch &amp;&amp; executor != null) &#123; executor.execute(sc); &#125; else &#123; // æ‰§è¡Œ sc.run(); &#125; &#125; catch (RejectedExecutionException ree) &#123; getLog().warn(ä»€ä¹ˆ.getString(&quot;endpoint.executor.fail&quot;, socketWrapper) , ree); return false; &#125; catch (Throwable t) &#123; ExceptionUtils.handleThrowable(t); // This means we got an OOM or similar creating a thread, or that // the pool and its queue are full getLog().error(ä»€ä¹ˆ.getString(&quot;endpoint.process.fail&quot;), t); return false; &#125; return true;&#125; SocketProcessor123456789101112131415161718192021222324252627protected void doRun() &#123; NioChannel socket = socketWrapper.getSocket(); SelectionKey key = socket.getIOChannel().keyFor(socket.getPoller().getSelector()); .... çœç•¥ if (handshake == 0) &#123; SocketState state = SocketState.OPEN; // Process the request from this socket if (event == null) &#123; // è·å– ConnectionHandlerå¹¶è°ƒç”¨processæ‰§è¡Œå…·ä½“é€»è¾‘ state = getHandler().process(socketWrapper, SocketEvent.OPEN_READ); &#125; else &#123; state = getHandler().process(socketWrapper, event); &#125; if (state == SocketState.CLOSED) &#123; close(socket, key); &#125; &#125; else if (handshake == -1 ) &#123; close(socket, key); &#125; else if (handshake == SelectionKey.OP_READ)&#123; socketWrapper.registerReadInterest(); &#125; else if (handshake == SelectionKey.OP_WRITE)&#123; socketWrapper.registerWriteInterest(); &#125; &#125; &#125;&#125; SocketProcessoré€»è¾‘æ¯”è¾ƒç®€å•ï¼ŒdoRunæ–¹æ³•ç»§ç»­ä¼šå¾€ä¸‹è°ƒç”¨ï¼Œæœ€ç»ˆhttpåè®®çš„è§£ææ˜¯åœ¨Http11Processorçš„serviceä¸­è¿›è¡Œï¼ŒHttp11Processorå°±å¯¹åº”ä¸Šæ–‡æ¶æ„å›¾çš„Processæ¨¡å—ï¼Œåœ¨Processå®ŒæˆHttpåè®®è§£æä¹‹åï¼Œä¼šç”±é€‚é…å™¨è¿›è¡Œé€‚é…åå†äº¤ç»™Servletå®¹å™¨è¿›è¡Œå…·ä½“å¤„ç† æ€»ç»“æœ¬æ–‡åˆ†æTomcatçš„Connectorè¿æ¥å™¨çš„éƒ¨åˆ†æºç ï¼ŒConnectoræ˜¯Tomcatçš„æ ¸å¿ƒç»„ä»¶ï¼ŒConnectorç»„ä»¶ç”¨äºç­‰å¾…ç”¨æˆ·çš„è¯·æ±‚ï¼ŒåŒ…æ‹¬æ”¯æŒhttp1.1ï¼Œhttp2ç­‰åè®®ï¼Œè§£æç”¨æˆ·è¯·æ±‚ï¼Œå°è£…è¯·æ±‚ä¿¡æ¯ï¼Œæœ€åæ‰äº¤ç»™æˆ‘ä»¬ç†Ÿæ‚‰çš„ Servletå¤„ç†ã€‚é˜…è¯»æ­¤æºç å¯¹äºç†è§£httpåè®®ä¹Ÿæœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚]]></content>
      <categories>
        <category>webå®¹å™¨</category>
        <category>Tomcat</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Tomcatæºç è§£æäºŒ å¯åŠ¨è¿‡ç¨‹]]></title>
    <url>%2F2019%2F02%2F12%2FTomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ä¸Šæ–‡ä»‹ç»äº†Tomcatè®¾è®¡çš„æ•´ä½“æ¶æ„ï¼Œå¯¹äºæ¥ä¸‹æ¥çš„æºç åˆ†æéå¸¸é‡è¦ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»Tomcatçš„å…¥å£å¯åŠ¨å¼€å§‹åˆ†æTomcatçš„æºç  Tomcatçš„å¯åŠ¨å…¥å£æˆ‘ä»¬å¯ä»¥ä»å…¶å¯åŠ¨è„šæœ¬catalina.shä¸­å‘ç°ï¼Œæ˜¯ç”±org.apache.catalina.startup.Bootstrap.javaçš„mainæ–¹æ³•å¯åŠ¨çš„ã€‚ç°åœ¨æˆ‘ä»¬å°±ä»Bootstrap.javaå¼€å§‹åˆ†ætomcatçš„æºç  Bootstrapåœ¨çœ‹Mainå‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹é™æ€å—ä¸­çš„ä»£ç  12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061static &#123; String userDir = System.getProperty(&quot;user.dir&quot;); // è·å– catalina.home çš„é…ç½®ç›®å½• String home = System.getProperty(Globals.CATALINA_HOME_PROP); File homeFile = null; if (home != null) &#123; File f = new File(home); try &#123; homeFile = f.getCanonicalFile(); &#125; catch (IOException ioe) &#123; homeFile = f.getAbsoluteFile(); &#125; &#125; // å¦‚æœæœªé…ç½® åˆ™å–bootstrap.jaræ‰€åœ¨ç›®å½•çš„ä¸Šä¸€çº§ if (homeFile == null) &#123; // First fall-back. See if current directory is a bin directory // in a normal Tomcat install File bootstrapJar = new File(userDir, &quot;bootstrap.jar&quot;); if (bootstrapJar.exists()) &#123; File f = new File(userDir, &quot;..&quot;); try &#123; homeFile = f.getCanonicalFile(); &#125; catch (IOException ioe) &#123; homeFile = f.getAbsoluteFile(); &#125; &#125; &#125; if (homeFile == null) &#123; // Second fall-back. Use current directory File f = new File(userDir); try &#123; homeFile = f.getCanonicalFile(); &#125; catch (IOException ioe) &#123; homeFile = f.getAbsoluteFile(); &#125; &#125; catalinaHomeFile = homeFile; System.setProperty( Globals.CATALINA_HOME_PROP, catalinaHomeFile.getPath()); // æœªé…ç½®catalina.baseçš„æƒ…å†µä¸‹ï¼Œcatalina.baseçš„ç›®å½•å’Œcatalina.homeä¸€è‡´ String base = System.getProperty(Globals.CATALINA_BASE_PROP); if (base == null) &#123; catalinaBaseFile = catalinaHomeFile; &#125; else &#123; File baseFile = new File(base); try &#123; baseFile = baseFile.getCanonicalFile(); &#125; catch (IOException ioe) &#123; baseFile = baseFile.getAbsoluteFile(); &#125; catalinaBaseFile = baseFile; &#125; System.setProperty( Globals.CATALINA_BASE_PROP, catalinaBaseFile.getPath());&#125; ä¸Šé¢çš„ä»£ç è®¾ç½®äº†Tomcatçš„å®‰è£…ç›®å½•å’Œå®é™…å·¥ä½œç›®å½• catalina.base tomcatå·¥ä½œç›®å½• æŒ‡confã€logsã€tempã€webappså’Œworkæ–‡ä»¶å¤¹çš„çˆ¶ç›®å½• catalina.home å®‰è£…ç›®å½• å…¶å®æ˜¯æŒ‡binå’Œlibæ–‡ä»¶å¤¹çš„çˆ¶ç›®å½• åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä¸å¿…å¤åˆ¶å¤šä¸ªtomcatæ¥å¯åŠ¨å¤šä¸ªå®ä¾‹ Main å‡½æ•°å…¥å£ç»§ç»­å¾€ä¸‹çœ‹ï¼Œå°±æ˜¯Tomcatå¯åŠ¨çš„æœ€ç»ˆå…¥å£äº† 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061public static void main(String args[]) &#123; // ä¸ºä½•è¿™é‡Œè¦åŠ é”ï¼Ÿï¼Ÿ synchronized (daemonLock) &#123; if (daemon == null) &#123; // Don&apos;t set daemon until init() has completed Bootstrap bootstrap = new Bootstrap(); try &#123; // æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³• bootstrap.init(); &#125; catch (Throwable t) &#123; handleThrowable(t); t.printStackTrace(); return; &#125; daemon = bootstrap; &#125; else &#123; // When running as a service the call to stop will be on a new // thread so make sure the correct class loader is used to // prevent a range of class not found exceptions. Thread.currentThread().setContextClassLoader(daemon.catalinaLoader); &#125; &#125; try &#123; String command = &quot;start&quot;; if (args.length &gt; 0) &#123; // è·å–å‘½ä»¤å‚æ•° command = args[args.length - 1]; &#125; if (command.equals(&quot;startd&quot;)) &#123; args[args.length - 1] = &quot;start&quot;; daemon.load(args); daemon.start(); &#125; else if (command.equals(&quot;stopd&quot;)) &#123; args[args.length - 1] = &quot;stop&quot;; daemon.stop(); &#125; else if (command.equals(&quot;start&quot;)) &#123; // å¯åŠ¨ daemon.setAwait(true); daemon.load(args); daemon.start(); if (null == daemon.getServer()) &#123; System.exit(1); &#125; &#125; else if (command.equals(&quot;stop&quot;)) &#123; daemon.stopServer(args); &#125; else if (command.equals(&quot;configtest&quot;)) &#123; daemon.load(args); if (null == daemon.getServer()) &#123; System.exit(1); &#125; System.exit(0); &#125; else &#123; log.warn(&quot;Bootstrap: command \&quot;&quot; + command + &quot;\&quot; does not exist.&quot;); &#125; &#125; catch (Throwable t) &#123; .... &#125;&#125; ä¸Šé¢çš„ä»£ç æ˜¯æ•´ä¸ªtomcatçš„ç»Ÿä¸€å…¥å£ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨Mainæ–¹æ³•ä¸­ï¼Œæ‰§è¡Œäº†initæ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨initæ–¹æ³•ä¸­è‚¯å®šåšäº†å¾ˆå¤šäº‹æƒ… 1234567891011121314151617181920212223242526272829public void init() throws Exception &#123; // åˆå§‹åŒ–ç±»åŠ è½½å™¨ initClassLoaders(); Thread.currentThread().setContextClassLoader(catalinaLoader); SecurityClassLoad.securityClassLoad(catalinaLoader); // Load our startup class and call its process() method if (log.isDebugEnabled()) log.debug(&quot;Loading startup class&quot;); // è·å–å®¹å™¨ç±» org.apache.catalina.startup.Catalina Class&lt;?&gt; startupClass = catalinaLoader.loadClass(&quot;org.apache.catalina.startup.Catalina&quot;); // å®ä¾‹åŒ–ä¸€ä¸ªServletå®¹å™¨ Object startupInstance = startupClass.getConstructor().newInstance(); if (log.isDebugEnabled()) log.debug(&quot;Setting startup class properties&quot;); String methodName = &quot;setParentClassLoader&quot;; Class&lt;?&gt; paramTypes[] = new Class[1]; paramTypes[0] = Class.forName(&quot;java.lang.ClassLoader&quot;); Object paramValues[] = new Object[1]; paramValues[0] = sharedLoader; Method method = startupInstance.getClass().getMethod(methodName, paramTypes); method.invoke(startupInstance, paramValues); catalinaDaemon = startupInstance;&#125; åœ¨initæ–¹æ³•ä¸­åˆå§‹åŒ–äº†ç±»åŠ è½½å™¨ï¼Œå¹¶ä¸”åˆå§‹åŒ–äº†ä¸€ä¸ªorg.apache.catalina.startup.Catalinaå®ä¾‹ï¼Œmainæ–¹æ³•ä¸­è°ƒç”¨Catalinaçš„startæ–¹æ³•æ¥å¯åŠ¨å®¹å™¨ã€‚ start12345678910111213141516171819202122232425262728293031323334public void start() &#123; // å¦‚æœ Serverä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ª if (getServer() == null) &#123; load(); &#125; if (getServer() == null) &#123; log.fatal(ä»€ä¹ˆ.getString(&quot;catalina.noServer&quot;)); return; &#125; long t1 = System.nanoTime(); // Start the new server try &#123; // å¯åŠ¨Server getServer().start(); &#125; catch (LifecycleException e) &#123; try &#123; getServer().destroy(); &#125; catch (LifecycleException e1) &#123; log.debug(&quot;destroy() failed for failed Server &quot;, e1); &#125; return; &#125; long t2 = System.nanoTime(); if(log.isInfoEnabled()) &#123; &#125; if (await) &#123; await(); stop(); &#125;&#125; å¯ä»¥çœ‹åˆ°Startæ–¹æ³•ä¸­ä¾èµ–è°ƒç”¨äº†Serverçš„startæ–¹æ³•ï¼Œçœ‹åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸ºä½•Tomcatå®¹å™¨è¿™ä¹ˆå¤šçš„ç»„ä»¶ä¸ºä½•å¯ä»¥ç»Ÿä¸€å¯åŠ¨ï¼Œç»Ÿä¸€é”€æ¯ï¼Œå…¶å®è¿™äº›ç»„ä»¶éƒ½æ˜¯org.apache.catalina .Lifecycleçš„å®ç°ç±»ï¼ŒLifecycleæ¥å£åŒ…å«äº†startå¯åŠ¨ï¼Œinitåˆå§‹åŒ–ï¼Œdestoryé”€æ¯ï¼Œstopåœæ­¢ç­‰æ–¹æ³•ï¼Œå¹¶ä¸”éƒ½ç»§æ‰¿äº†æŠ½è±¡ç±»LifecycleBaseï¼Œå…¶ä¸­å…·ä½“çš„initInternal()ã€startInternal() å’ŒstopInternal() æ–¹æ³•ï¼Œäº¤ç”±å­ç±»è‡ªå·±å®ç°é€šè¿‡å®ç°è¯¥æ¥å£ï¼Œè¾¾åˆ°ç»Ÿä¸€å¯åŠ¨å…³é—­çš„æ•ˆæœï¼Œè¿™é‡Œå…¶å®ä½“ç°äº†æ¨¡æ¿æ–¹æ³•çš„è®¾è®¡æ¨¡å¼ã€‚ å†å›åˆ°ä¸Šé¢çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ç€é‡çœ‹ä¸€ä¸‹loadæ–¹æ³•ï¼Œè¯¥æ–¹æ³•åˆå§‹åŒ–äº†ä¸€ä¸ªæ–°çš„Server 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162public void load() &#123; if (loaded) &#123; return; &#125; loaded = true; long t1 = System.nanoTime(); initDirs(); // Before digester - it may be needed initNaming(); // Set configuration source ConfigFileLoader.setSource(new CatalinaBaseConfigurationSource(Bootstrap.getCatalinaBaseFile(), getConfigFile())); File file = configFile(); // è§£æé…ç½®æ–‡ä»¶ server.xml ï¼Œåˆ›å»ºä¸€ä¸ªè§£æå™¨ Digester digester = createStartDigester(); try (ConfigurationSource.Resource resource = ConfigFileLoader.getSource().getServerXml()) &#123; InputStream inputStream = resource.getInputStream(); InputSource inputSource = new InputSource(resource.getURI().toURL().toString()); inputSource.setByteStream(inputStream); digester.push(this); digester.parse(inputSource); &#125; catch (Exception e) &#123; if (file == null) &#123; log.warn(ä»€ä¹ˆ.getString(&quot;catalina.configFail&quot;, getConfigFile() + &quot;] or [server-embed.xml&quot;), e); &#125; else &#123; log.warn(ä»€ä¹ˆ.getString(&quot;catalina.configFail&quot;, file.getAbsolutePath()), e); if (file.exists() &amp;&amp; !file.canRead()) &#123; log.warn(ä»€ä¹ˆ.getString(&quot;catalina.incorrectPermissions&quot;)); &#125; &#125; return; &#125; getServer().setCatalina(this); getServer().setCatalinaHome(Bootstrap.getCatalinaHomeFile()); getServer().setCatalinaBase(Bootstrap.getCatalinaBaseFile()); // Stream redirection initStreams(); // Start the new server try &#123; getServer().init(); &#125; catch (LifecycleException e) &#123; if (Boolean.getBoolean(&quot;org.apache.catalina.startup.EXIT_ON_INIT_FAILURE&quot;)) &#123; throw new java.lang.Error(e); &#125; else &#123; log.error(ä»€ä¹ˆ.getString(&quot;catalina.initError&quot;), e); &#125; &#125; long t2 = System.nanoTime(); if(log.isInfoEnabled()) &#123; log.info(ä»€ä¹ˆ.getString(&quot;catalina.init&quot;, Long.valueOf((t2 - t1) / 1000000))); &#125;&#125; loadæ–¹æ³•å…¶å®åšçš„ä¸»è¦äº‹æƒ…å°±æ˜¯è§£æserver.xmlæ–‡ä»¶ï¼Œserver.xmlæ˜¯tomcatå…³é”®é…ç½®æ–‡ä»¶ï¼Œä¸Šç¯‡æ–‡ç« æˆ‘ä»¬èŠè¿‡Tomcatçš„æ•´ä½“æ¶æ„ï¼Œæ•´ä¸ªæ¶æ„ä½“ç³»å…¶å®éå¸¸å®Œæ•´çš„ä½“ç°åœ¨äº†server.xmlæ–‡ä»¶ä¸Šã€‚è¿™é‡Œè§£æserver.xmlæ–‡ä»¶ç”¨çš„xmlè§£æå·¥å…·æ˜¯SAXï¼Œæ˜¯ä¸€ç§ä»¥äº‹ä»¶é©±åŠ¨çš„XMl APIï¼Œå…·ä½“è§£æçš„æœºåˆ¶è¿™é‡Œå°±ä¸è¯´äº†è¿™é‡Œå…¶å®ä¾æ¬¡é€šè¿‡è§£æé…ç½®æ–‡ä»¶åˆ›å»ºäº† StandardServerã€StandardServiceã€StandardEngineã€StandardHostã€‚ç„¶åè°ƒç”¨StandardServerçš„init()æ–¹æ³•åˆå§‹åŒ–Tomcatå®¹å™¨çš„ä¸€ç³»åˆ—ç»„ä»¶ï¼Œå®¹å™¨åˆå§‹åŒ–çš„çš„æ—¶å€™ï¼Œéƒ½ä¼šè°ƒç”¨å…¶å­å®¹å™¨çš„init()æ–¹æ³•ï¼Œåˆå§‹åŒ–å®ƒçš„å­å®¹å™¨ã€‚ä¸Šé¢æåˆ°çš„æ˜¯initçš„è°ƒç”¨è¿‡ç¨‹ï¼Œstartæ–¹æ³•çš„å¯åŠ¨è¿‡ç¨‹å…¶å®ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œç”±çˆ¶å®¹å™¨å¯åŠ¨å­å®¹å™¨å±‚å±‚è°ƒç”¨ã€‚ æ€»ç»“æœ¬æ–‡åˆ†æäº†Tomcatå¯åŠ¨éƒ¨åˆ†çš„æºç ï¼Œè¿™æ˜¯é˜…è¯»å…¶æºç çš„å…¥å£]]></content>
      <categories>
        <category>webå®¹å™¨</category>
        <category>Tomcat</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Tomcatæºç è§£æä¸€ æ¶æ„åˆçª¥]]></title>
    <url>%2F2019%2F01%2F20%2FTomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%80-%E6%9E%B6%E6%9E%84%E5%88%9D%E7%AA%A5%2F</url>
    <content type="text"><![CDATA[å¼•è¨€Tomcatæ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„Servletå®¹å™¨ï¼Œä¹Ÿæ˜¯åœ¨æ—¥å¸¸å·¥ä½œä¸­ä¸æˆ‘ä»¬æ¥è§¦éå¸¸å¤šçš„HttpæœåŠ¡å™¨ï¼Œä½œä¸ºä¸€ä¸ªæˆç†Ÿçš„è½¯ä»¶ï¼Œå®ƒçš„æ•´ä½“è®¾è®¡ï¼Œä»£ç ç»“æ„éƒ½ååˆ†çš„ä¼˜ç§€ï¼Œä½œä¸ºå¼€å‘è€…ï¼Œéå¸¸æœ‰å¿…è¦ç ”è¯»Tomcatæºç ã€‚é˜…è¯»æºç æ€»æ˜¯å¼€å¤´éš¾ï¼Œä½†æ˜¯ä¸€æ—¦å¯¹æ•´ä½“è®¾è®¡ç†å¿µæœ‰ä¸€å®šäº†è§£åï¼Œå†è¿›è¡Œæ·±å…¥åˆ†æï¼Œå°±ä¼šæœ‰ä¸ä¸€æ ·çš„æ”¶è·ã€‚ æ•´ä½“æ¶æ„å…ˆä¸Šä¸€å¼ æ€»ä½“æ¶æ„å›¾ è¿™å¼ å›¾å¯ä»¥è¯´æ¯ç¯‡ä»‹ç»Tomcatçš„åšå®¢éƒ½æ˜¯å¿…æ”¾ï¼Œæ—¢ç„¶æ¯ä¸ªäººéƒ½è®¤å¯è¿™å¼ å›¾ï¼Œè¯´æ˜æ­¤å›¾éå¸¸é‡è¦ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±å›´ç»•è¿™å¼ å›¾å¯¹Tomcatçš„æ•´ä½“æ¶æ„è¿›è¡Œåˆ†æã€‚ ServeræœåŠ¡å™¨ï¼šå¯ä»¥çœ‹æˆä»£è¡¨TomcatæœåŠ¡å™¨æœ¬èº«ï¼Œä¸€ä¸ªTomcatå®ä¾‹åªä¼šæœ‰ä¸€ä¸ªServer ServiceæŸ¥çœ‹ä¸Šå›¾ï¼Œå¯çŸ¥ä¸€ä¸ªServerå¯ä»¥åŒ…å«å¤šä¸ªServiceï¼Œåœ¨è¿™é‡Œå¯ä»¥æŠŠServiceçœ‹æˆæ˜¯Connectorå’ŒContainerç»„åˆå±‚ï¼ŒConnectorå’ŒContaineræ˜¯Tomcatä¸¤ä¸ªä¸»è¦çš„æ¨¡å— Connector è¿æ¥å™¨ï¼Œä¸€ä¸ªServiceå¯ä»¥æœ‰å¤šä¸ªConnectorï¼ˆhttp AJP ç­‰ï¼‰ï¼Œç›‘å¬ç”¨æˆ·è¯·æ±‚ç«¯å£ Container æŒ‰ç…§å±‚çº§æœ‰Engineï¼ŒHostï¼ŒContextï¼ŒWrapperå››ç§ï¼Œä¸€ä¸ªServiceåªæœ‰ä¸€ä¸ªEngineï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯æ‰§è¡Œä¸šåŠ¡é€»è¾‘ è¿™é‡Œæˆ‘å†è´´ä¸€ä¸ªTomcatçš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥æ ¹æ®æ­¤é…ç½®æ–‡ä»¶å†å›è¿‡å¤´å»çœ‹ä¸Šå›¾ 12345678910111213141516171819202122232425&lt;Server port=&quot;8005&quot; shutdown=&quot;SHUTDOWN&quot;&gt; &lt;Service name=&quot;Catalina&quot;&gt; &lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot; connectionTimeout=&quot;20000&quot; redirectPort=&quot;8443&quot; /&gt; &lt;Connector port=&quot;8009&quot; protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; /&gt; &lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot;&gt; &lt;Realm className=&quot;org.apache.catalina.realm.LockOutRealm&quot;&gt; &lt;Realm className=&quot;org.apache.catalina.realm.UserDatabaseRealm&quot; resourceName=&quot;UserDatabase&quot;/&gt; &lt;/Realm&gt; &lt;Host name=&quot;localhost&quot; appBase=&quot;webapps&quot; unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt; &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot; prefix=&quot;localhost_access_log&quot; suffix=&quot;.txt&quot; pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt; &lt;/Host&gt; &lt;/Engine&gt; &lt;/Service&gt; é…ç½®æ–‡ä»¶çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯Serverï¼Œå¹¶ä¸”é…ç½®äº†shutdownç«¯å£ä¸º8005ï¼Œç„¶åå°±é…ç½®äº†ä¸€ä¸ªåä¸ºCatalinaçš„Serviceï¼Œè¿™é‡Œå…¶å®å¯ä»¥é…ç½®å¤šä¸ªServiceã€‚å†çœ‹ServiceèŠ‚ç‚¹ä¸­ï¼Œé…ç½®äº†å¤šä¸ªConnectorè¿æ¥å™¨ï¼Œå¹¶ä¸”é…ç½®äº†ä¸€ä¸ªEngineï¼ŒEngineå¯¹åº”Containerçš„æœ€é¡¶å±‚ï¼Œä¸€ä¸ªServiceåªæœ‰ä¸€ä¸ªEngineã€‚ ä¸‹é¢æˆ‘ä»¬å†è¿›è¡Œé€ä¸ªåˆ†æ ServerServeræ˜¯Tomcatæœ€é¡¶å±‚çš„å®¹å™¨ï¼Œä¸€ä¸ªTomcatå®ä¾‹åªä¼šæœ‰ä¸€ä¸ªServerã€‚ä¸€ä¸ªServerè‡³å°‘éœ€è¦åŒ…å«ä¸€ä¸ªServiceï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­çš„ä½“ç°å°±æ˜¯è‡³å°‘éœ€è¦åŒ…å«ä¸€ä¸ªServiceèŠ‚ç‚¹ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹Tomcatå¯¹äºServerçš„æ ‡å‡†å®ç°ç±»org.apache.catalina.core.StandardServerï¼Œå…¶ä¸­Lifecycleè¿™ä¸ªæ¥å£æ˜¯Tomcatå¯¹äºç”Ÿå‘½å‘¨æœŸç»´æŠ¤çš„é‡è¦æ¥å£ï¼Œæ¯ä¸ªç»„ä»¶éƒ½å¿…é¡»å®ç°ï¼Œä»è€Œä¿è¯äº†ç»Ÿä¸€å¯åŠ¨/ç»Ÿä¸€å…³é—­çš„æ•ˆæœ Serviceå‰æ–‡è¯´è¿‡ï¼ŒServiceå°±æ˜¯ç”¨äºç»„è£…Connectorå’ŒContainerçš„å¯¹åº”å…³ç³»çš„ã€‚é€šè¿‡æŸ¥çœ‹é…ç½®æ–‡ä»¶ï¼Œå¯çŸ¥ServiceèŠ‚ç‚¹åŒ…å«äº†Connectorå’ŒContainerï¼Œå…¶ä¸­Connectorç›‘å¬ç”¨æˆ·è¯·æ±‚ï¼Œå¹¶è§£æè¯·æ±‚å‚æ•°ï¼ŒContaineræ‰§è¡Œå…·ä½“ä¸šåŠ¡é€»è¾‘ ConnectorConnectoræ˜¯è¿æ¥å™¨ï¼Œç”¨äºæ¥å—è¯·æ±‚å¹¶å°†è¯·æ±‚å°è£…æˆRequestå’ŒResponseï¼Œç„¶åäº¤ç»™Containerè¿›è¡Œå¤„ç†ï¼ŒContainerå¤„ç†å®Œä¹‹åå†äº¤ç»™Connectorè¿”å›ç»™å®¢æˆ·ç«¯ ContainerTomcatä¸­çš„Servletå®¹å™¨å¿…é¡»å®ç°Containeræ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´Servletå®¹å™¨éƒ½æ˜¯Containeræ¥å£çš„å®ä¾‹ï¼Œæ¥ä¸‹æ¥å°†ä¼šä»‹ç»å››ç§ç±»å‹çš„å®¹å™¨ Engine: è¡¨ç¤ºæ•´ä¸ªServletå¼•æ“ Host: è¡¨ç¤ºåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªContextå®¹å™¨çš„è™šæ‹Ÿä¸»æœº Contetx: è¡¨ç¤ºä¸€ä¸ªWebåº”ç”¨ç¨‹åºã€‚ä¸€ä»½Contextå¯ä»¥æœ‰å¤šä¸ªWrapper Wrapper: è¡¨ç¤ºä¸€ä¸ªç‹¬ç«‹çš„servlet ä¸Šè¿°çš„æ¯ä¸€ä¸ªæ¦‚å¿µéƒ½æ˜¯å®ç°äº†org.apache.catalina.Containeræ¥å£çš„ï¼Œè¿™å››ä¸ªå®ç°çš„æ ‡å‡†ç±»åˆ†åˆ«å¯¹åº”StandardEngine,StandardHost,StandardContetx,StandardWrapperã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹å›¾ç†æ¸…å®ƒä»¬çš„å±‚æ¬¡å…³ç³»ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå®¹å™¨å¯ä»¥æœ‰0ä¸ªæˆ–å¤šä¸ªä½å±‚æ¬¡çš„å­å®¹å™¨ EngineEngineå®¹å™¨è¡¨ç¤ºTomcatçš„æ•´ä¸ªservletå¼•æ“ã€‚å¦‚æœä½¿ç”¨äº†Engineå®¹å™¨ï¼Œé‚£ä¹ˆå®ƒæ€»æ˜¯å¤„äºå®¹å™¨å±‚çº§çš„æœ€é¡¶å±‚ã€‚æ·»åŠ åˆ°Engineå®¹å™¨ä¸­çš„å­å®¹å™¨é€šå¸¸æ˜¯Hostæˆ–Contextçš„å®ç°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œtomcatä¼šä½¿ç”¨Engineå®¹å™¨ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªHostå®¹å™¨ä½œä¸ºå…¶å­å®¹å™¨ã€‚ HostHostè¡¨ç¤ºè™šæ‹Ÿä¸»æœºï¼Œå¦‚æœä½ æƒ³åœ¨åŒä¸€ä¸ªTomcatéƒ¨ç½²ä¸Šè¿è¡Œå¤šä¸ªContextå®¹å™¨çš„è¯ï¼Œä½ å°±éœ€è¦ä½¿ç”¨Hostå®¹å™¨ã€‚ç†è®ºä¸Šï¼Œå½“ä½ åªæœ‰ä¸€ä¸ªContextå®ä¾‹æ—¶ï¼Œä¸éœ€è¦ä½¿ç”¨Hostå®ä¾‹ã€‚ä½†æ˜¯åœ¨Tomcatçš„å®é™…éƒ¨ç½²ä¸­ï¼Œæ€»æ˜¯ä¼šä½¿ç”¨ä¸€ä¸ªHostå®¹å™¨ Contextå¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„Webåº”ç”¨ç¨‹åºï¼Œä¹Ÿå°±æ˜¯å¯¹åº”æˆ‘ä»¬æ—¥å¸¸ç¼–å†™çš„å•ç‹¬Webåº”ç”¨ Contextå®¹å™¨çš„çˆ¶å®¹å™¨é€šå¸¸æ˜¯Hostå®¹å™¨ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å…¶ä»–å®ç°ï¼Œæˆ–åˆ™å¦‚æœä¸å¿…è¦ï¼Œå°±å¯ä»¥ä¸ä½¿ç”¨çˆ¶å®¹å™¨ WrapperWrapperå°è£…äº†ä¸€ä¸ªå…·ä½“çš„Servlet å°¾è¨€æœ¬æ–‡ä¸»è¦åˆ†æè§£è¯»äº†tomcatçš„æ€»ä½“è®¾è®¡æ¶æ„ï¼Œtomcatçš„æºç éå¸¸éå¸¸çš„å¤šï¼Œå¦‚æœæˆ‘ä»¬ä¸å¯¹å…¶æ•´ä½“æ¶æ„å±‚æ¬¡è¿›è¡Œåˆ†æï¼Œç›´æ¥è¿›è¡Œæºç é˜…è¯»ï¼Œä¼šæ„Ÿè§‰ä»¿è‹¥ç½®èº«å¤§æµ·ï¼Œéå¸¸çš„æµªè´¹æ—¶é—´ã€‚æ‰€ä»¥è‹¥å¤§å®¶æœ‰æƒ³æ³•é˜…è¯»tomcatæºç ï¼Œè¿˜æ˜¯æœ‰å¿…è¦å…ˆç†æ¸…å…¶æ¶æ„ä½“ç³»]]></content>
      <categories>
        <category>webå®¹å™¨</category>
        <category>Tomcat</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Java NIO Selector å¤šè·¯å¤ç”¨é€‰æ‹©å™¨]]></title>
    <url>%2F2019%2F01%2F20%2FJava-NIO-Selector-%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E9%80%89%E6%8B%A9%E5%99%A8%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ä¸Šç¯‡æ–‡ç« æˆ‘ä»¬ç®€å•çš„ä½¿ç”¨äº†NIOçš„Channelé€šé“ï¼Œæœ¬æœŸæˆ‘ä»¬ä¸»è¦æ¥ä»‹ç»ä¸€ä¸‹é€‰æ‹©å™¨ï¼ˆSelectorï¼‰çš„ä½¿ç”¨ï¼ŒSelectoræ˜¯Java NIOæ ¸å¿ƒç»„ä»¶ä¸­çš„ä¸€ä¸ªã€‚åœ¨ä¹‹å‰ä»‹ç»5ç§I/Oæ¨¡å‹çš„æ—¶å€™ï¼Œæœ‰ä»‹ç»è¿‡å¤šè·¯å¤ç”¨æ¨¡å‹ã€‚å¤šè·¯å¤ç”¨æ¨¡å‹ä½¿å¾—æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥ç®¡ç†æˆåƒä¸Šä¸‡çš„è¿æ¥ï¼Œé¿å…äº†çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¸¦æ¥çš„å¼€é”€ï¼Œä½¿å¾—æ€§èƒ½å¾—åˆ°æå¤§çš„æå‡ åŸºæœ¬æ¨¡å‹é€‰æ‹©å™¨Selectorä½¿ç”¨çš„åŸºæœ¬æ¨¡å¼ï¼Œè·Ÿä¼ ç»ŸBIOå¤„ç†æ¨¡å‹ä¸ä¸€æ ·ã€‚ä¼ ç»ŸBIOå¾€å¾€æˆ‘ä»¬ä¼šä½¿ç”¨å¤šçº¿ç¨‹æ¥æå‡å¤„ç†æ€§èƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¥å…¥ä¸€ä¸ªClientï¼ŒServerç«¯å°±ä¼šä¸ºå…¶æ–°å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œä»¥æ­¤æ¥æå‡å¹¶å‘ååé‡ï¼Œä½¿ç”¨è¿™ç§æ¨¡å¼çš„å¼Šç«¯å¾ˆæ˜æ˜¾ï¼Œå› ä¸ºçº¿ç¨‹æ˜¯ç³»ç»Ÿéå¸¸é‡è¦çš„èµ„æºï¼Œå½“å¹¶å‘é‡å°‘çš„æ—¶å€™ï¼Œæ„Ÿè§‰ä¸åˆ°ï¼Œä¸€æ—¦å¹¶å‘é‡ä¸Šæ¥ï¼Œå°±ä¼šå‡ºç°ç“¶é¢ˆã€‚ å†æ¥çœ‹Selectoræ˜¯å¦‚ä½•å¤„ç†çš„ï¼Œé¦–å…ˆæ¯æ¥å…¥ä¸€ä¸ªClientï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Selectoré€‰æ‹©å™¨æ³¨å†Œæ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªçº¿ç¨‹å»ä¸åœçš„è½®è¯¢æ£€æµ‹å„ä¸ªClientæ˜¯å¦æœ‰æ„Ÿå…´è¶£çš„äº‹ä»¶å‘ç”Ÿï¼Œæœ‰åˆ™é¡ºåºå¤„ç†è¯¥Clientå°±ç»ªçš„å„ä¸ªäº‹ä»¶ã€‚ Selector ä½¿ç”¨å®ä¾‹æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªSelectoréå¸¸å¸¸è§çš„ä½¿ç”¨ä¾‹å­ 1234567891011121314151617181920212223242526272829303132333435363738394041424344try &#123; // æ‰“å¼€ä¸€ä¸ªé€šé“ ServerSocketChannel serverSocketChannel = ServerSocketChannel.open(); serverSocketChannel.socket().bind(new InetSocketAddress(8890)); // æ‰“å¼€ é€‰æ‹©å™¨ selector Selector selector = Selector.open(); // è®¾ç½®éé˜»å¡ serverSocketChannel.configureBlocking(false); // ä¸ºServerSocketChannelæ³¨å†Œ OP_ACCEPT äº‹ä»¶ï¼Œè¿”å›ä¸€ä¸ªSelectionKey å¯¹è±¡ serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT); while (true) &#123; // è¿”å›è‡³å°‘æœ‰ä¸€ä¸ªäº‹ä»¶å°±ç»ªçš„é€šé“æ•°ï¼Œè¯¥æ–¹æ³•æ˜¯é˜»å¡çš„ int readyNum = selector.select(); if (readyNum == 0) &#123; continue; &#125; // è¿”å›å°±ç»ªçš„ SelectionKeyé›†åˆ Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys(); Iterator&lt;SelectionKey&gt; iteratorKeys = selectionKeys.iterator(); // éå†æ‰€æœ‰å°±ç»ªçš„SelectionKeyé›†åˆ while (iteratorKeys.hasNext()) &#123; SelectionKey key = iteratorKeys.next(); iteratorKeys.remove(); // åˆ¤æ–­å°±ç»ªçš„å…·ä½“äº‹ä»¶ if (key.isValid()) &#123; if (key.isAcceptable()) &#123; ServerSocketChannel serverChannel = (ServerSocketChannel) key.channel(); // æ¥å—ä¸€ä¸ªæ–°è¿æ¥ SocketChannel channel = serverChannel.accept(); channel.configureBlocking(false); // ä¸ºè¯¥Channelæ³¨å†Œå¯è¯»äº‹ä»¶ channel.register(selector, SelectionKey.OP_READ); &#125; else if (key.isReadable()) &#123; ... &#125; &#125; &#125; &#125;&#125; catch (IOException e) &#123; e.printStackTrace();&#125; é€šè¿‡æŸ¥çœ‹ä¸Šé¢çš„ä»£ç ï¼Œå¯çŸ¥æˆ‘ä»¬é€šè¿‡Selector.open()åˆ›å»ºäº†ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œå¹¶ä¸”é€šè¿‡SocketChannelçš„registeræ–¹æ³•æ³¨å†Œäº†é€‰æ‹©å™¨å’Œäº‹ä»¶ï¼Œå…¶ä¸­registeræ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªSelectionKeyå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å…¶å®å°±æ˜¯ç»´æŠ¤äº†Channelå’ŒSelectorçš„å¯¹åº”å…³ç³» SelectionKeyä¸Šæ–‡æˆ‘ä»¬æåˆ°SelectionKeyå¯¹è±¡ç»´æŠ¤äº†Channelå’ŒSelectorçš„å¯¹åº”å…³ç³»ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸‹SelectionKeyå¯¹è±¡å†…éƒ¨å‡ ä¸ªéå¸¸é‡è¦çš„å±æ€§å’Œæ–¹æ³• å±æ€§ OP_READ OP_WRITE OP_CONNECT OP_ACCEPT å¯æ³¨å†Œçš„å››ä¸ªæ„Ÿå…´è¶£çš„é¡¹ç›® interestOps æ‰€æœ‰æ„Ÿå…´è¶£çš„é›†åˆ readyOps æ‰€æœ‰å°±ç»ªçš„å…´è¶£é›†åˆ æ–¹æ³• boolean isValid() åˆ¤æ–­è¯¥SelectionKeyæ˜¯å¦æœ‰æ•ˆ void cancel() å–æ¶ˆè¯¥SelectionKeyä¸­ é€šé“ä¸å…¶é€‰æ‹©å™¨ çš„æ³¨å†Œ int interestOps() è¿”å›è¯¥SelectionKeyæ‰€åŒ…å«çš„æ‰€æœ‰å…´è¶£ï¼ˆå¯è¯»å¯å†™ï¼‰é›†åˆ SelectionKey interestOps(int ops) è®¾ç½®ä¸€ä¸ªæ„Ÿå…´è¶£çš„é¡¹ç›® int readyOps() è¿”å›å·²ç»å°±ç»ªçš„å…´è¶£é›†åˆ boolean isWritable() åˆ¤æ–­æ˜¯å¦å¯å†™ boolean isReadable() åˆ¤æ–­æ˜¯å¦å¯è¯» boolean isConnectable() åˆ¤æ–­æ˜¯å¦å¯è¿æ¥ boolean isAcceptable() åˆ¤æ–­æ˜¯å¦å¯æ¥å— Object attach(Object ob) åœ¨è¯¥SelectionKeyä¸­é™„åŠ ä¸€ä¸ªå¯¹è±¡ä¿¡æ¯ Object attachment() è·å–é™„åŠ å¯¹è±¡ä¿¡æ¯ Selectorè®²å®ŒSelectionKeyå’ŒSelectorçš„å…³ç³»ä¹‹åï¼Œæˆ‘ä»¬å†æ¬¡å›åˆ°Selectorç±»ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦çŸ¥é“Selectorä¸­3ä¸ªé‡è¦çš„SelectionKeyé›†åˆ keysï¼šæ‰€æœ‰æ³¨å†Œåˆ°Selectorçš„Channelæ‰€è¡¨ç¤ºçš„SelectionKeyéƒ½ä¼šå­˜åœ¨äºè¯¥é›†åˆä¸­ã€‚keyså…ƒç´ çš„æ·»åŠ ä¼šåœ¨Channelæ³¨å†Œåˆ°Selectoræ—¶å‘ç”Ÿã€‚ selectedKeysï¼šè¯¥é›†åˆä¸­çš„æ¯ä¸ªSelectionKeyéƒ½æ˜¯å…¶å¯¹åº”çš„Channelåœ¨ä¸Šä¸€æ¬¡æ“ä½œselectionæœŸé—´è¢«æ£€æŸ¥åˆ°è‡³å°‘æœ‰ä¸€ç§SelectionKeyä¸­æ‰€æ„Ÿå…´è¶£çš„æ“ä½œå·²ç»å‡†å¤‡å¥½è¢«å¤„ç†ã€‚è¯¥é›†åˆæ˜¯keysçš„ä¸€ä¸ªå­é›†ã€‚ cancelledKeysï¼šæ‰§è¡Œäº†å–æ¶ˆæ“ä½œçš„SelectionKeyä¼šè¢«æ”¾å…¥åˆ°è¯¥é›†åˆä¸­ã€‚è¯¥é›†åˆæ˜¯keysçš„ä¸€ä¸ªå­é›†ã€‚ æ¥ä¸‹æ¥å°†ä¼šä»‹ç»ä¸Šæ–‡ä¾‹å­ä¸­æ‰€ç”¨åˆ°çš„å‡ ä¸ªæ–¹æ³• Selector.open()è¿™ä¸ªé™æ€æ–¹æ³•å¯ä»¥æ‰“å¼€ä¸€ä¸ªSelectoré€‰æ‹©å™¨ 123public static Selector open() throws IOException &#123; return SelectorProvider.provider().openSelector();&#125; é€šè¿‡æŸ¥çœ‹æºç å¯çŸ¥åœ¨Linuxç³»ç»Ÿä¸‹é»˜è®¤ä¼šä½¿ç”¨EpollSelectorImplæ¥ä½œä¸ºSelectorå®ç°ç±»ï¼Œæ³¨æ„å„ä¸ªç³»ç»Ÿä¸‹é»˜è®¤çš„å®ç°ç±»æ˜¯ä¸åŒçš„ã€‚ selector.select()Selectorçš„select()æ–¹æ³•ä¼šè¿”å›äº‹ä»¶å°±ç»ªçš„SelectionKeyæ•°ç›®ï¼ˆä¹Ÿå°±æ˜¯å°±ç»ªçš„Channelæ•°ï¼‰ å¹¶ä¸”è¯¥æ–¹æ³•ä¼šä¸€ç›´é˜»å¡ç›´åˆ°è‡³å°‘ä¸€ä¸ªchannelè¢«é€‰æ‹©(å³ï¼Œè¯¥channelæ³¨å†Œçš„äº‹ä»¶å‘ç”Ÿäº†)ä¸ºæ­¢ï¼Œé™¤éå½“å‰çº¿ç¨‹å‘ç”Ÿä¸­æ–­æˆ–è€…selectorçš„wakeupæ–¹æ³•è¢«è°ƒç”¨ è¯¥æ–¹æ³•è¿˜æœ‰ä¸€ä¸ªé‡è½½select(long timeout)ï¼Œå¯ä»¥è‡ªå®šä¹‰è¶…æ—¶æ—¶é—´ selector.selectNow()è¯¥æ–¹æ³•ä¸ä¸Šé¢æ–¹æ³•ç±»ä¼¼ï¼Œä½†è¯¥æ–¹æ³•ä¸ä¼šå‘ç”Ÿé˜»å¡ï¼Œå³ä½¿æ²¡æœ‰ä¸€ä¸ªchannelè¢«é€‰æ‹©ä¹Ÿä¼šç«‹å³è¿”å› selector.selectedKeys()è¿”å›å·²å°±ç»ªçš„SelectionKeyé›†åˆï¼Œè¯¥æ–¹æ³•åœ¨æ‰§è¡Œäº†selector.select()åè°ƒç”¨ï¼Œå› ä¸ºåœ¨æ‰§è¡Œselector.select()åå°±è¡¨ç¤ºè‡³å°‘æœ‰ä¸€ä¸ªSelectionKeyå·²ç»å°±ç»ª å°¾è¨€å¥½äº†ï¼Œæœ¬ç¯‡æ–‡ç« å°±ä»‹ç»åˆ°è¿™é‡Œäº†ï¼Œç¯‡å¹…æœ‰é™åŠ ä¸Šæœ¬äººå¯¹NIOçš„ç†è§£ä¹Ÿæœ‰å¾…åŠ æ·±ï¼Œå¸Œæœ›å¯ä»¥åœ¨ä¹‹åæ›´æ·±å…¥çš„å¯¹Java NIOçš„å®ç°è¿›è¡Œåˆ†æã€‚]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
        <category>NIO</category>
      </categories>
      <tags>
        <tag>NIO</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ— å‚readè¿”å›intç±»å‹ä¸ºä½•è¦ä¸ä¸Š0xff]]></title>
    <url>%2F2019%2F01%2F13%2F%E6%97%A0%E5%8F%82read%E8%BF%94%E5%9B%9Eint%E7%B1%BB%E5%9E%8B%E4%B8%BA%E4%BD%95%E8%A6%81%E4%B8%8E%E4%B8%8A0xff%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ä½¿ç”¨java io åŒ…æ—¶ï¼ŒInputStream ç±»ä¸­çš„æœ‰å¥½å‡ ä¸ªread()æ–¹æ³•ï¼Œå¹¶ä¸”è¿”å›å€¼ä¹Ÿéƒ½æ˜¯intç±»å‹ï¼Œè¿™æ ·å°±ä½¿å¾—åˆå­¦è€…å¾ˆå®¹æ˜“ææ··ï¼Œå…¶å®è™½ç„¶è¿”å›å€¼éƒ½æ˜¯intç±»å‹ï¼Œä½†æ‰€è¡¨ç¤ºçš„æ„ä¹‰ç¡®æ˜¯ä¸ä¸€æ ·çš„ æœ‰å‚ read(byte b[], int off, int len)å…ˆçœ‹æœ‰å‚çš„readæ–¹æ³•ã€‚æœ‰å‚çš„readæ¯”è¾ƒå¥½ç†è§£ï¼Œå°†è¯»å–åˆ°çš„æ•°æ®å†™å…¥å­—èŠ‚æ•°ç»„(ä»å­—èŠ‚æ•°ç»„çš„æŒ‡å®šä½ç½®å¼€å§‹å†™å…¥) ä¸‰ä¸ªå…¥å‚ b[] å­˜å‚¨è¯»å–åˆ°çš„æ•°æ®çš„å­—èŠ‚æ•°ç»„ off ä»ç›®æ ‡æ•°ç»„b[]çš„offä½å¼€å§‹å†™å…¥ï¼Œä¸€èˆ¬éƒ½æ˜¯ä»0å¼€å§‹ len è¦è¯»å–çš„å­—èŠ‚ç é•¿åº¦ï¼Œä¸€èˆ¬ä¼šæ˜¯å­˜å‚¨æ•°ç»„b[]çš„é•¿åº¦ è¿™é‡Œçš„intç±»å‹çš„è¿”å›å€¼æ˜¯å®é™…è¯»å–çš„å­—èŠ‚æ•°ï¼Œå¦‚æœæ£€æµ‹åˆ°æ— æ•°æ®å¯è¯»æ—¶ä¼šè¿”å› -1 æ— å‚ read()123456/** * ä»è¾“å…¥æµè¯»å–ä¸‹ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚è¿”å›å€¼ä¸º`intç±»å‹`ï¼Œå€¼èŒƒå›´åœ¨`0-255`ä¹‹é—´ã€‚å¦‚æœç”±äºåˆ°è¾¾æµ * çš„æœ«å°¾è€Œæ²¡æœ‰å¯ç”¨çš„å­—èŠ‚ï¼Œåˆ™è¿”å›`-1`ã€‚æ­¤æ–¹æ³•å°†ä¸€ç›´é˜»å¡ï¼Œç›´åˆ°è¾“å…¥æ•°æ®å¯ç”¨ã€æ£€æµ‹åˆ°æµçš„ç»“ * å°¾æˆ–å¼•å‘å¼‚å¸¸ä¸ºæ­¢ */public abstract int read() throws IOException; ä»è¾“å…¥æµè¯»å–ä¸‹ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚è¿”å›å€¼ä¸ºintç±»å‹ï¼Œå€¼èŒƒå›´åœ¨0-255ä¹‹é—´ã€‚å¦‚æœç”±äºåˆ°è¾¾æµçš„æœ«å°¾è€Œæ²¡æœ‰å¯ç”¨çš„å­—èŠ‚ï¼Œåˆ™è¿”å›-1ã€‚æ­¤æ–¹æ³•å°†ä¸€ç›´é˜»å¡ï¼Œç›´åˆ°è¾“å…¥æ•°æ®å¯ç”¨ã€æ£€æµ‹åˆ°æµçš„ç»“å°¾æˆ–å¼•å‘å¼‚å¸¸ä¸ºæ­¢ æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç° 1234567891011public int read() throws IOException &#123; if (eof) &#123; return -1; &#125; temp = new byte[1]; int n = read(temp, 0, 1); if (n &lt;= 0) &#123; return -1; &#125; return temp[0] &amp; 0xff;&#125; åˆ°è¿™é‡Œå°±å¾ˆå¥‡æ€ªäº†ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯è¿”å›ä¸‹ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå¯æ˜¯ä¸ºä»€ä¹ˆè¦è¿”å›ä¸€ä¸ªintç±»å‹ï¼Œè€Œä¸ç›´æ¥è¿”å› byte ç±»å‹ï¼Ÿå¹¶ä¸”è¿”å›intç±»å‹æ—¶è¿˜æœ‰ä¸€ä¸ª&amp; 0xffæ“ä½œï¼Œä¸ºä»€ä¹ˆè¿˜è¦æ‰§è¡Œè¿™ä¸ªä¸æ“ä½œå‘¢ï¼Ÿä¸‹é¢å°±è®©æˆ‘ä»¬å¥½å¥½åˆ†æä¸€ä¸‹ï¼Œä¸ºä½•è¦è¿”å›intç±»å‹ï¼Œè€Œä¸ç›´æ¥è¿”å›byteç±»å‹ï¼Œä»¥åŠä¸ºä½•ä¼šå…ˆæ‰§è¡Œä¸€ä¸ª&amp; 0xffæ“ä½œ ä¸ºä½•è¦è¿”å›intç±»å‹åœ¨è¯»å–å­—èŠ‚æ—¶ï¼Œæˆ‘ä»¬è‚¯å®šéœ€è¦ä¸€ä¸ªæ ‡è¯†æ¥è¡¨ç¤ºå·²ç»è¯»åˆ°äº†å­—èŠ‚æµæœ«å°¾ï¼Œä¸€èˆ¬ä¼šè¿”å›-1æ¥æ ‡è¯†ï¼Œä½†æ˜¯å¦‚æœæ˜¯è¿”å›byteç±»å‹ï¼Œå°±æ— æ³•æ ‡è¯†æ˜¯å¦åˆ°äº†æ–‡ä»¶æœ«å°¾ã€‚æ‰€ä»¥å•å‡­è¿™ç‚¹ï¼Œè¿™é‡Œå°±ä¸èƒ½è¿”å›byteç±»å‹ ä¸ºä½•è¦æ‰§è¡Œä¸æ“ä½œ&amp; 0xffå†è¿”å›intç±»å‹ä¸Šé¢è§£é‡Šäº†ä¸ºä½•è¦è¿”å›intç±»å‹ï¼Œå¯æ˜¯è²Œä¼¼è¿”å›intç±»å‹ä¹Ÿå¹¶æ²¡æœ‰è§£å†³é—®é¢˜.. çœ‹è¿™ä¹ˆä¸€ä¸ªæƒ…å†µï¼Œä¸‡ä¸€è¿”å›çš„å•ä¸ªå­—èŠ‚ä»¥äºŒè¿›åˆ¶è¡¨ç¤ºæ˜¯1111 1111ï¼Œè½¬æ¢æˆintç±»å‹ä¼šé«˜ä½è¡¥ç¬¦å·ä½1ï¼Œä¹Ÿå°±æ˜¯1111 1111 1111 1111 1111 1111 1111 1111ï¼Œåˆšå¥½æ˜¯-1(Javaä¸­æ•°å­—æ˜¯ä»¥è¡¥ç å½¢å¼å­˜å‚¨çš„)ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¼šäº§ç”Ÿæ··ä¹±ï¼Œæˆ‘ä»¬æ— æ³•åŒºåˆ†è¿”å›-1æ˜¯ä¸æ˜¯åˆ°äº†å­—èŠ‚æµçš„æœ«å°¾ é‚£ä¹ˆè¿™ä¸ªé—®é¢˜è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿè¿™é‡Œè¦è§£å†³çš„é—®é¢˜å…¶å®å°±æ˜¯å½“è¿˜æ²¡æœ‰è¯»åˆ°å­—èŠ‚æµæœ«å°¾æ—¶ä¸èƒ½è¿”å›-1ï¼Œå¹¶ä¸”äºŒè¿›åˆ¶å­—èŠ‚æµä¹Ÿä¸èƒ½æ”¹å˜æ‰€ä»¥è¿™é‡Œå°±åŠ å…¥äº†&amp; 0xffæ“ä½œï¼Œæˆ‘ä»¬å†æ¥çœ‹å‰é¢è¿”å›-1çš„ä¾‹å­1111 1111é«˜ä½è‡ªåŠ¨è¡¥1åä¸ä¸Š0xff(0000 0000 0000 0000 0000 0000 1111 1111) 11111 1111 1111 1111 1111 1111 1111 1111 &amp; 0000 0000 0000 0000 0000 0000 1111 1111 = 0000 0000 0000 0000 0000 0000 1111 1111 å¯çŸ¥æ‰§è¡Œäº†&amp; 0xffæ“ä½œåï¼Œç›¸å½“äºæ°¸è¿œä¸ä¼šè¿”å›è´Ÿæ•°äº†ï¼Œä¹Ÿå°±ä¸ä¼šå­˜åœ¨è¿”å›-1å’Œåˆ°å­—èŠ‚æµæœ«å°¾è¿”å›-1å†²çªçš„æƒ…å†µï¼Œå¹¶ä¸”å®é™…çš„äºŒè¿›åˆ¶ç»“æ„ä¹Ÿæ²¡æœ‰æ”¹å˜ï¼Œå¯ä»¥è¯´æ˜¯å®Œç¾çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚ ä¸Šé¢çš„1111 1111ä¼šè‡ªåŠ¨é«˜ä½è¡¥ç¬¦å·ä½çš„åŸå› æ˜¯ï¼Œå½“Javaæ£€æµ‹åˆ°byteè¦è½¬åŒ–æˆ–å°†è¦è½¬æ¢æˆé«˜ä½ç±»å‹æ—¶ï¼Œä¼šè‡ªåŠ¨è¡¥é«˜ä½ç¬¦å·ä½ è¡¥ç¬¦å·ä½è¿™é‡Œå†è§£é‡Šä¸€ä¸‹è¡¥ç¬¦å·ä½æˆ‘ä»¬çŸ¥é“byteå ä¸€ä¸ªå­—èŠ‚8ä½ï¼Œè€Œintç±»å‹å 4ä¸ªå­—èŠ‚32ä½ï¼Œæ‰€ä»¥byteç±»å‹å‘ä¸Šè½¬æ¢æˆintç±»å‹æ—¶éœ€è¦è¡¥ç¬¦å·ä½ï¼Œæ­£æ•°è¡¥0ï¼Œè´Ÿæ•°è¡¥1ã€‚æˆ‘ä»¬è¡¥ç¬¦å·ä½çš„ç›®çš„æ˜¯ä¸ºäº†ç±»å‹è½¬æ¢åå¤§å°å’Œç¬¦å·ä½éƒ½ä¿æŒä¸å˜ã€‚ æ€»ç»“æœ¬ç¯‡æ–‡ç« è™½ç„¶æ˜¯ä»IOçš„readæ–¹æ³•æ¥å…¥ï¼Œå…¶å®è¿˜æ˜¯è·ŸJavaå†…éƒ¨çš„ç¼–ç æ ¼å¼æœ‰å…³ï¼Œå¦‚æ•°å­—åœ¨Javaå†…å­˜ä¸­æ˜¯ä»¥è¡¥ç å­˜å‚¨çš„ï¼Œæ•°å­—ç±»å‹è½¬æ¢ä¼šé«˜ä½è¡¥ç¬¦å·ä½ç­‰ç­‰ï¼Œè¦å½»åº•ææ‡‚è¿˜æ˜¯è¦èŠ±äº›æ—¶é—´çš„ã€‚]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
        <category>JDKæºç </category>
      </categories>
      <tags>
        <tag>IO</tag>
        <tag>JDKæºç </tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Java NIO Channel é€šé“]]></title>
    <url>%2F2019%2F01%2F10%2FJava-NIO-Channel-%E9%80%9A%E9%81%93%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ä¸Šä¸€ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†Java NIO Bufferçš„ä½¿ç”¨åŠå†…éƒ¨å®ç°åŸç†ï¼Œæœ¬æœŸæˆ‘ä»¬å°†ä¼šè®¤è¯†åˆ°Java NIO å¦ä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§Channelï¼ˆé€šé“ï¼‰ å¯¹æ¯”ä¼ ç»ŸIOæµåœ¨è®¤è¯†Java NIO Channelé€šé“ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å¯¹æ¯”ä¸€ä¸‹NIO Channelä¸ä¼ ç»ŸI/Oæµçš„åŒºåˆ«ï¼Œä»¥åŠå®ƒçš„ä¼˜åŠ¿åœ¨å“ªé‡Œ: æ—¢å¯ä»¥ä»é€šé“ä¸­è¯»å–æ•°æ®ï¼Œåˆå¯ä»¥å†™æ•°æ®åˆ°é€šé“ã€‚ä½†æµçš„è¯»å†™é€šå¸¸æ˜¯å•å‘çš„ã€‚ é€šé“å¯ä»¥å¼‚æ­¥åœ°è¯»å†™ã€‚ï¼ˆä¸ä¼šé˜»å¡è¿›ç¨‹ï¼‰ é€šé“ä¸­çš„æ•°æ®æ€»æ˜¯è¦å…ˆè¯»åˆ°ä¸€ä¸ªBufferï¼Œæˆ–è€…æ€»æ˜¯è¦ä»ä¸€ä¸ªBufferä¸­å†™å…¥(é¢å‘ç¼“å†²åŒº)ã€‚ Channel åˆ†ç±»ä¸‹é¢åˆ—ä¸¾çš„æ˜¯JAVA NIO Channelçš„ä¸€äº›ä¸»è¦å®ç°ï¼š FileChannel æ–‡ä»¶é€šé“ SocketChannel é€šè¿‡TCPè¯»å†™ç½‘ç»œä¸­çš„æ•°æ®ã€‚ ServerSocketChannel TCPæœåŠ¡ç«¯ï¼Œå¯ä»¥è¯»å†™ç½‘ç»œä¸­çš„æ•°æ®ï¼Œå¯ä»¥ç›‘å¬æ–°è¿›æ¥çš„TCPè¿æ¥ DatagramChannel é€šè¿‡UDPè¯»å†™ç½‘ç»œä¸­çš„æ•°æ® æ¥ä¸‹æ¥æˆ‘å°†ä¸»è¦å¯¹æ–‡ä»¶é€šé“å’ŒSocketé€šé“çš„ä½¿ç”¨åšåˆ†æ æ–‡ä»¶é€šé“ FileChannelæˆ‘ä»¬æ— æ³•ç›´æ¥æ‰“å¼€ä¸€ä¸ªFileChannelï¼Œéœ€è¦é€šè¿‡ä½¿ç”¨ä¸€ä¸ªInputStreamã€OutputStreamæˆ–RandomAccessFileæ¥è·å–ä¸€ä¸ªFileChannelå®ä¾‹ã€‚å¹¶ä¸”FileChannelæ— æ³•è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œå®ƒæ€»æ˜¯è¿è¡Œåœ¨é˜»å¡æ¨¡å¼ä¸‹,ä¹Ÿå°±æ˜¯è¯´FileChannelçš„read writeæ–¹æ³•éƒ½æ˜¯é˜»å¡çš„ã€‚ è¯»å†™æ•°æ®ä¸‹é¢æ˜¯é€šè¿‡RandomAccessFileæ‰“å¼€FileChannelè¿›è¡Œæ•°æ®è¯»å†™çš„ç¤ºä¾‹ï¼š å†™æ•°æ®è‡³æŒ‡å®šæ–‡ä»¶12345678910111213RandomAccessFile file = new RandomAccessFile(&quot;hello.txt&quot;, &quot;rw&quot;);FileChannel fileChannel = file.getChannel();ByteBuffer buffer = ByteBuffer.allocate(512);// å°†è¦å†™çš„æ•°æ®å†™å…¥ç¼“å†²åŒºbuffer.put(&quot;è§åˆ°ä½ çœŸå¥½&quot;.getBytes(&quot;utf-8&quot;));// åˆ‡æ¢ç¼“å†²åŒºè‡³å¯è¯»æ¨¡å¼buffer.flip();// å¼€å§‹å†™å…¥æ–‡ä»¶fileChannel.write(buffer); // è¿”å›å½“å‰å†™å…¥çš„å­—èŠ‚æ•°file.close();fileChannel.close(); ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®12345678910111213RandomAccessFile file = new RandomAccessFile(&quot;hello.txt&quot;, &quot;rw&quot;);FileChannel fileChannel = file.getChannel();ByteBuffer buffer = ByteBuffer.allocate(512);fileChannel.read(buffer);// åˆ‡æ¢ç¼“å†²åŒºè‡³å¯å†™æ¨¡å¼buffer.flip();byte data [] = new byte[buffer.limit()];// å°†æ•°æ®å†™è‡³ byteæ•°ç»„buffer.get(data);System.out.println(new String(data));file.close();fileChannel.close(); Socket é€šé“åŒæ ·ï¼Œç›¸å¯¹äºä¼ ç»ŸBIOçš„Socketï¼ŒServerSocketã€‚NIOä¹Ÿæä¾›äº†å¯¹TCP/IPåè®®å°è£…çš„å¥—æ¥å­—é€šé“ï¼š SocketChannel ServerSocketChannal ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒä»¬çš„åŸºæœ¬ä½¿ç”¨ SocketChannel æ‰“å¼€é€šé“12345// æ‰“å¼€ä¸€ä¸ªé€šé“SocketChannel channel = SocketChannel.open();// ä¸Serverå»ºç«‹è¿æ¥channel.connect(new InetSocketAddress(&quot;127.0.0.1&quot;, 8890)); ServerSocketChannel æ‰“å¼€é€šé“æ¥å—è¿æ¥123456// æ‰“å¼€é€šé“ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();// ç»‘å®šç«¯å£serverSocketChannel.socket().bind(new InetSocketAddress(8890));// æ¥å—ä¸€ä¸ªSocketè¿æ¥ é»˜è®¤æ˜¯é˜»å¡æ¨¡å¼SocketChannel channel = serverSocketChannel.accept(); è¦ç‚¹SocketChannel,ServerSocketChannel ä¹Ÿå¯ä»¥è®¾ç½®æˆéé˜»å¡æ¨¡å¼ï¼Œè®¾ç½®æˆéé˜»å¡æ¨¡å¼çš„è¯ï¼Œacceptï¼Œreadï¼Œwrite æ–¹æ³•ä¼šç«‹å³è¿”å›ï¼Œ å› æ­¤éœ€è¦æˆ‘ä»¬åœ¨ä»£ç ä¸æ–­çš„è½®è¯¢å»åˆ¤æ–­è¿æ¥å’Œæ•°æ®æ˜¯å¦å°±ç»ª å°¾è¨€æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†Java NIOä¸­Channel(é€šé“)çš„ä½¿ç”¨ï¼Œå…¶ä½¿ç”¨ä¸ä¼ ç»ŸI/Oæµç›¸æ¯”å…¶å®æ›´åŠ çš„æ˜“ç”¨ã€‚ä¸‹æœŸå°†ä¼šä»‹ç»Java NIOçš„æ ¸å¿ƒSelectoré€‰æ‹©å™¨çš„åŸºæœ¬ä½¿ç”¨]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
        <category>NIO</category>
      </categories>
      <tags>
        <tag>NIO</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Javaä¸­çš„ä¹±ç é—®é¢˜]]></title>
    <url>%2F2018%2F12%2F30%2FJava%E4%B8%AD%E7%9A%84%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98%2F</url>
    <content type="text"><![CDATA[å¼•è¨€åœ¨å†™Javaä»£ç çš„æ—¶å€™ï¼Œå¤§å®¶åº”è¯¥éƒ½é‡åˆ°è¿‡å„ç§ä¹±ç é—®é¢˜ï¼Œç„¶åå¼€å§‹æŸ¥èµ„æ–™ï¼Œç»“æœåŸå› æ— éæ˜¯ç¼–ç æ ¼å¼ä¸ä¸€è‡´æ‰€å¯¼è‡´çš„ä¹±ç ï¼Œè§£å†³æ–¹å¼ä¹Ÿæ˜¯åƒç¯‡ä¸€å¾‹ï¼Œç»Ÿä¸€ä½¿ç”¨UTF-8å°±OKäº†ã€‚ æ˜¯çš„è¿™ä¹ˆåšä¹±ç é—®é¢˜è‚¯å®šå¯ä»¥è§£å†³ï¼Œå¯æˆ‘ä»¬ä¼¼ä¹è¿˜ä¸å¤ªæ¸…é™¤æ˜¯å“ªä¸€æ­¥ç¼–ç è½¬åŒ–é™¤äº†é—®é¢˜å‘¢ï¼Ÿ é˜…è¯»æœ¬ç¯‡æ–‡ç« å‰å»ºè®®å…ˆé˜…è¯» æµ…æè®¡ç®—æœºå­—ç¬¦é›†å’Œç¼–ç ï¼Œèƒ½å¤Ÿå¯¹ç¼–ç æœ‰ä¸€ä¸ªå¤§æ¦‚çš„äº†è§£ Javaå¦‚ä½•å¤„ç†ç¼–ç é—®é¢˜æˆ‘ä»¬çŸ¥é“Javaæ˜¯ä½¿ç”¨äº†Unicodeå­—ç¬¦é›†ï¼Œå¹¶ä¸”å­—ç¬¦åœ¨å†…å­˜ä¸­æ˜¯ä»¥UTF-16ç¼–ç æ ¼å¼æ¥å­˜å‚¨çš„ï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Œå°±æ˜¯çºµç„¶å¤–éƒ¨æœ‰å„ç§Unicodeç¼–ç æ ¼å¼ï¼Œæˆ‘Javaå†…éƒ¨ä½¿ç”¨UTF-16ç¼–ç æ˜¯ä¸ä¼šå˜çš„ã€‚ ä»¥ä¸‹ä¾‹å­è¯æ˜å­—ç¬¦åœ¨å†…å­˜ä¸­æ˜¯ä»¥UTF-16ç¼–ç çš„ 12345678char c = &apos;\u738b&apos;; // ç‹çš„UTF-16ç¼–ç æ˜¯ 738bSystem.out.println(c); // ç‹// è¾“å‡ºcåœ¨å†…å­˜ä¸­çš„16è¿›åˆ¶æ•°System.out.println(Integer.toHexString(c)); // 738b æ—¢ç„¶Javaå†…éƒ¨ç¼–ç ï¼ˆå†…ç ï¼‰æ ¼å¼æ˜¯UTF-16æ˜¯ä¸ä¼šå˜çš„ï¼Œé‚£æˆ‘ä»¬è¯»å–ä¸åŒçš„ç¼–ç æ ¼å¼æ—¶ï¼Œå¿…ç„¶æ¶‰åŠåˆ°äº†è½¬åŒ–è¿‡ç¨‹ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ 123456String s = &quot;ç‹&quot;;byte [] bytes = s.getBytes();System.out.println(bytes.length); // è¾“å‡º 3 ä¸Šé¢çš„ä¾‹å­ï¼Œå¯ä»¥çœ‹åˆ°ç›¸åŒçš„å­—ç¬¦ç‹ï¼Œå­˜å‚¨åœ¨charä¸­ä¸¤ä¸ªå­—èŠ‚ï¼Œè½¬æ¢æˆå­—èŠ‚æµè¾“å‡ºåå˜æˆå ç”¨3ä¸ªå­—èŠ‚äº†ã€‚é—®é¢˜æ¥äº†ï¼Œè¿™ä¸ªè¿‡ç¨‹å‘ç”Ÿäº†ä»€ä¹ˆäº†ï¼Ÿ ä¸Šé¢ä»£ç ä¸­getBytes()æ–¹æ³•å…¶å®æˆ‘ä»¬ä½¿ç”¨äº†é»˜è®¤çš„UTF-8ç¼–ç æ ¼å¼ï¼Œå…¶å®å®Œæ•´çš„å†™æ³•åº”è¯¥æ˜¯byte [] bytes = s.getBytes(&quot;UTF-8&quot;)ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯è·å–äº†UTF-8ç¼–ç æ ¼å¼çš„å­—èŠ‚æµã€‚é‚£ä¹ˆè¿™é‡Œåˆæ˜¯å¦‚ä½•è·å–åˆ°å­—èŠ‚ç‹çš„UTF-8ç¼–ç çš„å‘¢ï¼Ÿ çœ‹ä¸‹å›¾ï¼Œå¯çŸ¥ä»»ä½•ç¼–ç è½¬æ¢éƒ½ä¼šç»ç”±Unicodeå­—ç¬¦é›†ä¸­è½¬ã€‚ä¾‹å¦‚æˆ‘ä»¬è¯»å–UTF-8ç¼–ç çš„å­—ç¬¦ï¼Œä¼šå…ˆè½¬åŒ–æˆUnicodeå­—ç¬¦ï¼Œç„¶åå†è½¬æˆUTF-16ç¼–ç åœ¨å†…å­˜ä¸­å­˜å‚¨ã€‚åè¿‡æ¥ä¹Ÿæ˜¯ç±»ä¼¼ ä¹±ç é—®é¢˜å‡ºç°åœ¨å“ªä¸€æ­¥ç°åœ¨æˆ‘ä»¬å†æ¥çœ‹å¼•è¨€é‡Œæ‰€è¯´æåˆ°çš„ä¹±ç é—®é¢˜ï¼Œçœ‹çœ‹ä¹±ç é—®é¢˜ä¸€èˆ¬æ˜¯å‡ºç°åœ¨äº†å“ªä¸€æ­¥ã€‚ä¸Šæ–‡æåˆ°ï¼Œæˆ‘ä»¬è¯»å–å­—ç¬¦æ—¶ï¼Œä¼šå…ˆå°†å†…å­˜ä¸­ä»¥UTF-16ç¼–ç çš„å­—ç¬¦è½¬æ¢æˆæˆ‘ä»¬éœ€è¦çš„ç¼–ç æ ¼å¼ï¼Œå¦‚Javaé»˜è®¤å°±æ˜¯UTF-8ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬ä»¥ç‰¹å®šçš„ç¼–ç æ ¼å¼ä¼ è¾“å­—èŠ‚æµæ—¶ï¼Œæ¥æ”¶ç«¯ä¹Ÿå¿…ç„¶éœ€è¦ä»¥åŒæ ·çš„ç¼–ç æ ¼å¼å»æ¥æ”¶ï¼Œä¸ç„¶å°±æ— æ³•è§£æå‡ºæ­£ç¡®çš„Unicodeå­—ç¬¦ï¼Œè¿›è€Œä¹Ÿæ— æ³•è½¬æ¢æˆæ­£ç¡®çš„UTF-16ç¼–ç åœ¨JVMå†…å­˜ä¸­å­˜å‚¨ï¼Œé‚£ä¹ˆå¿…ç„¶ä¼šå‡ºç°ä¹±ç é—®é¢˜ã€‚ æ€»ç»“å†™æœ¬ç¯‡æ–‡ç« çš„ç›®çš„æ˜¯ä¸ºäº†åŠ æ·±è‡ªå·±å¯¹Javaå†…éƒ¨ç¼–ç çš„è®¤è¯†ï¼Œä¹±ç é—®é¢˜ä¹Ÿæ˜¯å¾ˆå¤šåˆå­¦è€…éå¸¸ç—›æ¨å’Œææƒ§çš„ï¼Œå¸Œæœ›æœ¬ç¯‡æ–‡ç« ä¹Ÿå¯ä»¥å¯¹æœ‰ç–‘æƒ‘çš„åŒå­¦æœ‰æ‰€å¸®åŠ©]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
        <category>ç¼–ç </category>
      </categories>
      <tags>
        <tag>ç¼–ç </tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Java NIO Buffer åˆ†æ]]></title>
    <url>%2F2018%2F12%2F28%2FJava-NIO-Buffer-%E5%88%86%E6%9E%90%2F</url>
    <content type="text"><![CDATA[å¼•è¨€JDK 1.4 ä¹‹åå¼•å…¥äº†NIOï¼ˆNew IOæˆ– Non Blocking IOï¼‰ï¼Œæˆ‘è§‰çš„å¯ä»¥ç§°å…¶ä¸ºNew IOï¼Œå› ä¸ºNIOåŸºæœ¬é‡å†™æ‰€æœ‰æ ‡å‡†IOçš„APIï¼Œå®Œå…¨å¯ä»¥æ›¿ä»£æ ‡å‡†çš„Java IO APIã€‚å¹¶ä¸”NIOæ”¯æŒé¢å‘ç¼“å†²åŒº(Buffer)çš„ã€åŸºäºé€šé“(Channel)çš„IOæ“ä½œï¼Œå¯ä»¥ä»¥æ›´åŠ é«˜æ•ˆçš„æ–¹å¼è¿›è¡Œæ–‡ä»¶çš„è¯»å†™æ“ä½œã€‚ NIOçš„æ ¸å¿ƒä¸»è¦åŒ…æ‹¬3éƒ¨åˆ† Buffer ç¼“å†²åŒº Channel é€šé“ æ–‡ä»¶é€šé“ Socketé€šé“ Selector é€‰æ‹©å™¨ æœ¬ç¯‡æ–‡ç« ä¼šå¯¹NIOBufferç¼“å†²åŒºçš„ä½¿ç”¨åŠå®ç°åŸç†åšåˆ†æ ä½“ç³»Java NIO æä¾›äº†ä»¥ä¸‹å‡ ç§Bufferç±»å‹å¯ä¾›ä½¿ç”¨ ByteBuffer MappedByteBuffer CharBuffer DoubleBuffer FloatBuffer IntBuffer LongBuffer ShortBuffer è¿™äº›Bufferçš„åå­—å·²ç»éå¸¸æ¸…æ™°çš„æŒ‡æ˜äº†è¿™äº›Bufferæ‰€å„è‡ªæ‰¿è½½çš„ä¸åŒæ•°æ®ç±»å‹ ä¸‹é¢çš„åˆ†ææˆ‘éƒ½å°†ä»¥ByteBufferä¸ºä¾‹å­ åŸºæœ¬ä½¿ç”¨ByteBufferçš„ä½¿ç”¨æ¯”è¾ƒç®€å•ï¼Œä½†è‹¥ä¸ç†è§£å…¶å†…éƒ¨å®ç°åŸç†ï¼Œä¹Ÿéå¸¸å®¹æ˜“ææ··ã€‚æˆ‘ä»¬å…ˆæ¥ä»‹ç»å…¶ç®€å•çš„ä½¿ç”¨ åˆ›å»ºç¼“å†²åŒºåˆ›å»ºç¼“å†²åŒºä¸»è¦æœ‰ä¸¤ç§å¸¸ç”¨æ–¹å¼ allocate å¼€è¾ŸæŒ‡å®šå¤§å°çš„ç¼“å†²åŒº wrap ä½¿ç”¨å­—èŠ‚æ•°ç»„å¼€è¾Ÿæ–°çš„ç¼“å†²åŒºï¼Œå¯¹ç¼“å†²åŒºçš„ä¿®æ”¹å°†å¯¼è‡´æ•°ç»„è¢«ä¿®æ”¹ã€‚æ–°ç¼“å†²åŒºçš„å®¹é‡ï¼ˆpositionï¼‰å’Œé™åˆ¶ï¼ˆlimitï¼‰å°†ä¸ºè¯¥æ•°ç»„çš„é•¿åº¦ 123456// é€šè¿‡ allocate åˆ›å»ºByteBuffer byteBuffer = ByteBuffer.allocate(1024);// é€šè¿‡ wrap åˆ›å»ºbyte [] buf = new byte[1024];ByteBuffer.wrap(buf); è¯»å†™æ•°æ®ä½¿ç”¨ByteBufferè¯»å†™æ•°æ®æ¯”è¾ƒç®€å• å†™æ•°æ®å¾€Bufferä¸­å†™æ•°æ®åªéœ€è¦è°ƒç”¨putæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æœ‰å¤šä¸ªé‡è½½ï¼Œå¯ä»¥ä»¥ä¸åŒçš„æ–¹å¼å†™æ•°æ®è¿™é‡Œåªåˆ—ä¸¾3ä¸ª put(byte b) åœ¨å½“å‰ä½ç½®å°†ç»™å®šå­—èŠ‚å†™å…¥æ­¤ç¼“å†²åŒº put(int iï¼Œ byte b) åœ¨æŒ‡å®šä½ç½®å°†ç»™å®šå­—èŠ‚å†™å…¥æ­¤ç¼“å†²åŒº put(byte[] src, int offset, int length) å°†å­—èŠ‚ä»ç»™å®šæºæ•°ç»„ä¼ è¾“åˆ°æ­¤ç¼“å†²åŒºã€‚å¦‚æœä»æ•°ç»„å¤åˆ¶çš„å­—èŠ‚æ¯”æ•°å¤§äºå‰©ä½™çš„ç¼“å†²åŒºå®¹é‡ï¼Œä¼šæŠ›å‡ºBufferOverflowExceptionå¼‚å¸¸ è¯»æ•°æ®ä»Bufferä¸­è¯»å–æ•°æ®åªéœ€è¦è°ƒç”¨getæ–¹æ³•ï¼Œè¯¥æ–¹æ³•åŒæ ·æœ‰å¤šä¸ªé‡è½½ï¼Œå¯ä»¥ä»¥ä¸åŒçš„æ–¹å¼è¯»æ•°æ® get() è·å–å½“å‰ä½ç½®çš„å•ä¸ªå­—èŠ‚ get(int i) è·å–æŒ‡å®šä½ç½®çš„å•ä¸ªå­—èŠ‚ get(byte[] dst, int offset, int length) ä»æ­¤ç¼“å†²åŒºä¸­è·å–å­—èŠ‚å¹¶ä¼ è¾“åˆ°ç»™å®šçš„ç›®æ ‡æ•°ç»„ä¸­ï¼Œå¦‚æœç¼“å†²åŒºä¸­çš„å‰©ä½™å­—èŠ‚å°‘äºæ»¡è¶³è¯·æ±‚æ‰€éœ€çš„å­—èŠ‚æ•°ï¼Œä¼šæŠ›å‡ºBufferUnderflowExceptionå¼‚å¸¸ ä¸‹é¢æ˜¯ä¸€ä¸ªæŠ›å‡ºBufferUnderflowExceptionçš„ä¾‹å­ 123456ByteBuffer byteBuffer = ByteBuffer.allocate(1024);String s = &quot;hello&quot;;byteBuffer.put(s.getBytes());byteBuffer.flip(); // ç¿»è½¬ ä¸‹æ–‡ä¼šæåˆ°byte [] bufs = new byte[9]; // ç¼“å†²åŒºå®é™…åªæœ‰5ä¸ªå­—èŠ‚å¤§å°ï¼Œå¤§äºæ­¤å¤§å°å°±ä¼šæŠ›å‡ºå¼‚å¸¸byteBuffer.get(bufs); // æŠ›å‡ºå¼‚å¸¸ flip æ–¹æ³•ä¸Šæ–‡æŠ›å‡ºBufferUnderflowExceptionçš„ä¾‹å­ï¼Œä¸çŸ¥é“å¤§å®¶æœ‰æ²¡å‘ç°ï¼Œæˆ‘ä»¬çš„ä»£ç åœ¨è¯»å†™è½¬æ¢æ—¶ç”¨äº†flipæ–¹æ³•æ¥è¿›è¡Œè¯»å†™æ“ä½œçš„è½¬æ¢ï¼Œç¼“å†²åŒºåœ¨è¿›è¡Œè¯»å†™è½¬æ¢çš„æ—¶å€™å¿…é¡»è°ƒç”¨flipæ–¹æ³•ï¼Œé‚£ä¹ˆä¸ºä½•è¦è¿™ä¹ˆåšå‘¢ï¼Ÿä¸‹é¢æˆ‘å°†ä¼šå¯¹flipæ–¹æ³•çš„å†…éƒ¨å®ç°åŸç†è¿›è¡Œåˆ†æï¼Œåœ¨åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆè®¤è¯†ä¸€ä¸‹Bufferçš„capacity position limit markå››ä¸ªå˜é‡å±æ€§ capacity è¡¨ç¤ºç¼“å†²åŒºçš„å®¹é‡ï¼Œå¤§å°ä¸å¯å˜ä¸”ä¸å¯ä¸ºè´Ÿ position ä¸‹ä¸€ä¸ªè¦è¯»å–æˆ–å†™å…¥çš„å…ƒç´ çš„ä½ç½®ç´¢å¼• limit ä¸‹ä¸€ä¸ªä¸åº”è¯¥è¢«è¯»å–æˆ–å†™å…¥çš„å…ƒç´ çš„ä½ç½®ç´¢å¼• mark æ ‡è®°ä½ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ ‡è®°ä½è¿”å›æ­¤ä½ç½® å››è€…çš„å¤§å°å…³ç³» mark &lt;= position &lt;= limit &lt;= capacity çŸ¥é“äº†è¿™å››ä¸ªå˜é‡çš„å«ä¹‰ä¹‹åï¼Œæˆ‘ä»¬å†æ¥æ ¹æ®ä¾‹å­æ¥çœ‹çœ‹ä¸€æ­¥ä¸€æ­¥å¾€ä¸‹åˆ†æå§ ä¸€. é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡ByteBuffer.allocate(6)å¼€è¾Ÿä¸€ä¸ªå¤§å°ä¸º6çš„ç¼“å†²åŒº 123456789101112// é€šè¿‡allocate å¼€è¾Ÿç¼“å†²åŒºpublic static ByteBuffer allocate(int capacity) &#123; if (capacity &lt; 0) throw new IllegalArgumentException(); return new HeapByteBuffer(capacity, capacity);&#125;// HeapByteBuffer åˆå§‹åŒ–HeapByteBuffer(int cap, int lim) &#123; // package-private // è¿™é‡Œå‰å››ä¸ªå‚æ•°ä¾æ¬¡æ˜¯ mark position limit capacity super(-1, 0, lim, cap, new byte[cap], 0);&#125; é€šè¿‡æŸ¥çœ‹allocateæ–¹æ³•çš„æºç ï¼Œå¯çŸ¥å…¶å†…éƒ¨åˆå§‹ç»“æ„å¦‚ä¸‹å›¾(Bufferå†…éƒ¨å…¶å®æ˜¯æ•°ç»„å®ç°ï¼Œä¸‹æ ‡ä»0å¼€å§‹) mark = -1 position = 0 limit = capacity = 6 äºŒ. ç„¶åæˆ‘ä»¬ç°åœ¨é€šè¿‡putæ–¹æ³•åŠ å…¥1ä¸ªå­—èŠ‚æ•°æ®æ­¤æ—¶çš„å†…éƒ¨ç»“æ„å¦‚ä¸‹å›¾ mark = -1 position = 1 limit = capacity = 6 ä¸‰. åŠ ä¸€ä¸ªå¤ªå°‘äº†ï¼Œæˆ‘ä»¬å†æ·»åŠ 3ä¸ªå­—èŠ‚æ•°æ®è‡³ç¼“å†²åŒºä¸­æ­¤æ—¶çš„å†…éƒ¨ç»“æ„å¦‚ä¸‹å›¾ mark = -1 position = 4 limit = capacity = 6 å››. ç°åœ¨æ•°æ®å·²ç»å…¨éƒ¨åŠ å®Œäº†ï¼Œæˆ‘ä»¬å‡†å¤‡è¯»æ•°æ®äº†ï¼Œå¿…é¡»è¦è°ƒç”¨flipæ–¹æ³•å…ˆæ¥çœ‹çœ‹flipæ–¹æ³•çš„å†…éƒ¨å®ç° 123456public final Buffer flip() &#123; limit = position; position = 0; mark = -1; return this;&#125; flipå†…éƒ¨å…¶å®æ˜¯å°† positionçš„å€¼èµ‹ç»™äº†limitï¼Œå¹¶å°†positionä½ç½®å½’0ï¼Œå¦‚ä¸‹å›¾æ˜¾ç¤º äº”. æˆåŠŸç¿»è½¬ä¹‹åï¼Œå°±å¯ä»¥å¾€å¤–è¯»æ•°æ®äº†ï¼Œå‡è®¾å¾€å¤–è¯»4ä¸ªæ•°æ®æ­¤æ—¶å†…éƒ¨ç»“æ„å¦‚ä¸‹å›¾ï¼Œå¹¶ä¸” position = limitäº†ï¼Œè¾¾åˆ°äº†æœ€å¤§å¯è¯»å­—èŠ‚æ•° mark = -1 position = 4 limit = 4 capacity = 6 é€šè¿‡ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œå¯¹flipæ–¹æ³•çš„ç¿»è½¬é€»è¾‘å·²ç»è¿›è¡Œäº†éå¸¸è¯¦ç»†çš„åˆ†æï¼Œå¹¶ä¸”å¯ä»¥å¾—å‡ºç»“è®ºcapacityçš„æ˜¯ç»å¯¹ä¸å˜çš„ï¼Œä¸ä¼šéšç€è¯»å†™æ“ä½œè€Œæ”¹å˜ã€‚markå˜é‡çš„å€¼ä¼šåœ¨ä¸‹æ–‡reset mark æ–¹æ³•ä¸­ç”¨åˆ° reset mark æ–¹æ³•é¡¾åæ€ä¹‰ï¼Œmarkå°±æ˜¯æ‰“æ ‡è®°çš„æ„æ€ï¼Œresetè¡¨ç¤ºé‡ç½®çš„æ„æ€ã€‚è¿™ä¸¤ä¸ªæ“åšæ˜¯ç´§å¯†è”ç³»çš„ï¼Œç”±mark()æ–¹æ³•åœ¨å½“å‰positionä½ç½®åšæ ‡è®°ï¼Œç„¶ååœ¨éœ€è¦é‡ç½®åˆ°æ ‡è®°ä½ç½®çš„æ—¶å€™ï¼Œè°ƒç”¨resetæ–¹æ³•é‡ç½® çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„å†…éƒ¨å®ç° 1234567891011public final Buffer mark() &#123; mark = position; return this;&#125;public final Buffer reset() &#123; int m = mark; if (m &lt; 0) throw new InvalidMarkException(); position = m; return this;&#125; æ–¹æ³•çš„å†…éƒ¨å®ç°éå¸¸ç®€å•ï¼Œé€šè¿‡å¯¹å˜é‡markçš„ç¼–è¾‘æ¥æ ‡è®°å½“å‰ä½ç½®ï¼Œåœ¨éœ€è¦é‡ç½®çš„æ—¶å€™ï¼ŒæŠŠå˜é‡markçš„å€¼èµ‹ç»™å½“å‰ä¸‹æ ‡ç´¢å¼•positionæ¥è¾¾åˆ°é‡ç½®çš„ç›®çš„ã€‚ clearclearæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œå°†position = 0ï¼Œlimit = capacityï¼Œmark = -1ã€‚æœ‰ç‚¹ç±»ä¼¼åˆå§‹åŒ–æ—¶çš„æ“ä½œ compactæœ€åå†æ¥ä»‹ç»ä¸€ä¸‹compactæ–¹æ³•ï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªåœºæ™¯ 12345 while (in.read(buf) &gt;= 0 || buf.position != 0) &#123; buf.flip(); out.write(buf); buf.clear();&#125; ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œåœ¨éé˜»å¡æ¨¡å¼ä¸‹æ˜¯ä¼šæœ‰é—®é¢˜çš„ï¼Œå› ä¸ºwriteæ–¹æ³•æˆ‘ä»¬å¹¶ä¸çŸ¥é“ä¸€æ¬¡æ€§å¯ä»¥å†™å¤šå°‘ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æœ‰å¯èƒ½è¿˜æœ‰æœªå†™å…¥çš„å­—èŠ‚æ•°æ®ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å´åˆé‡æ–°è¯»å–äº†æ–°çš„æ•°æ®ï¼Œå°±ä¼šå¯¼è‡´è¦†ç›–äº†åŸæœ‰è¿˜æœªå†™å…¥çš„æ•°æ®ã€‚ åªéœ€è¦æ”¹æˆä»¥ä¸‹çš„æ–¹å¼å³å¯ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯å°†positionä¸limitä¹‹é—´çš„æ•°æ®å¤åˆ¶åˆ°bufferçš„å¼€å§‹ä½ç½®ï¼Œå¤åˆ¶åposition = limit -position,limit = capacity 12345 while (in.read(buf) &gt;= 0 || buf.position != 0) &#123; buf.flip(); out.write(buf); buf.compact();&#125; æ€»ç»“æœ¬ç¼–æ–‡ç« æ¯”è¾ƒè¯¦ç»†çš„åˆ†æäº†Java NIOBufferçš„åŸºæœ¬ä½¿ç”¨åŠå†…éƒ¨å®ç°åŸç†ã€‚Bufferçš„å†…éƒ¨å®ç°å…¶å®æ¯”è¾ƒç®€å•ï¼Œéœ€è¦ç€é‡ç†è§£çš„å…¶å®å°±æ˜¯capacity position limit markè¿™å››ä¸ªå˜é‡å±æ€§ã€‚]]></content>
      <categories>
        <category>åŸºç¡€</category>
        <category>NIO</category>
      </categories>
      <tags>
        <tag>NIO</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[I/Oæ¨¡å‹ç®€ä»‹]]></title>
    <url>%2F2018%2F12%2F27%2FI-O%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B%2F</url>
    <content type="text"><![CDATA[å¼•è¨€åœ¨æ·±å…¥å­¦ä¹ nettyä¹‹å‰ï¼Œè¿˜æ˜¯æœ‰å¿…è¦å…ˆå›é¡¾ä¸‹I/Oæ¨¡å‹ï¼ŒI/Oæ¨¡å‹ç†è§£èµ·æ¥ä¼šæ¯”è¾ƒæŠ½è±¡ï¼Œç¬¬ä¸€æ¬¡ç†è§£éœ€è¦å€ŸåŠ©å›¾ç‰‡ä»¥åŠå®é™…ä¾‹å­å»è®©è‡ªå·±åŠ æ·±å°è±¡ æ¨¡å‹åˆ†ç±»åœ¨å¼€å§‹ä»‹ç»ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåˆ—ä¸¾ä¸€ä¸‹Unixä¸‹å¯ç”¨çš„5ç§I/Oæ¨¡å‹ é˜»å¡å¼I/O éé˜»å¡å¼I/O I/Oå¤ç”¨ ä¿¡å·é©±åŠ¨I/O å¼‚æ­¥I/O æ¥ä¸‹æ¥çš„æ¨¡å‹ä»‹ç»éƒ½æ˜¯ä»¥UDPåšä¸ºä¾‹å­ï¼ŒåŸå› æ˜¯UDPæ˜¯ä»¥æ•°æ®æŠ¥çš„æ–¹å¼è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œæ¦‚å¿µæ¯”è¾ƒç®€å•ï¼ˆæ•´ä¸ªæ•°æ®è¦ä¹ˆæ”¶åˆ°è¦ä¹ˆæ²¡æœ‰æ”¶åˆ°ï¼‰ï¼Œä¾¿äºæˆ‘ä»¬å»ç†è§£I/Oæ¨¡å‹çš„æ ¸å¿ƒæ¦‚å¿µ é˜»å¡å¼I/O æˆ‘ä»¬æœ€ç†Ÿæ‚‰çš„I/Oæ¨¡å‹å°±æ˜¯é˜»å¡å¼I/Oæ¨¡å‹ï¼Œåœ¨ä¸Šå›¾ä¸­ï¼Œåº”ç”¨è¿›ç¨‹ç³»ç»Ÿè°ƒç”¨recvfromæ¥æ”¶æ•°æ®ï¼Œä½†æ˜¯æ­¤æ—¶å†…æ ¸ç¼“å†²åŒºä¸­æ•°æ®æŠ¥è¿˜æœªå‡†å¤‡å¥½ï¼Œæ‰€ä»¥åº”ç”¨è¿›ç¨‹ä¼šä¸€ç›´é˜»å¡ç›´åˆ°å†…æ ¸ç¼“å†²åŒºæœ‰æ•°æ®æŠ¥åˆ°è¾¾ä¸”è¢«å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ç¼“å†²åŒº è¿™é‡Œæˆ‘ä»¬æä¸€ä¸‹è¿™é‡Œçš„å†…æ ¸ç¼“å†²åŒºå’Œåº”ç”¨è¿›ç¨‹ç¼“å†²åŒºæ‰€å¤„çš„é˜¶æ®µä¸€ä¸ªè¾“å…¥æ“ä½œé€šå¸¸åŒ…æ‹¬ä¸¤ä¸ªä¸åŒçš„é˜¶æ®µ: ç­‰å¾…æ•°æ®æŠ¥å‡†å¤‡å¥½ (é€šå¸¸æ˜¯ç­‰å¾…æ•°æ®ä»ç½‘ç»œä¸Šåˆ°è¾¾ï¼Œå½“æ‰€ç­‰å¾…çš„åˆ†ç»„æ•°æ®åˆ°è¾¾åï¼Œä¼šè¢«å¤åˆ¶åˆ°å†…æ ¸çš„æŸä¸ªç¼“å†²åŒºä¸­) ä»å†…æ ¸å‘è¿›ç¨‹å¤åˆ¶æ•°æ® (æŠŠæ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ç¼“å†²åŒºä¸­) ä¾‹å­å•†åœºæ’é˜Ÿåƒé¥­ï¼Œåªèƒ½è€è€å®å®æ’é˜Ÿï¼Œå¹¶ä¸”æ’é˜Ÿçš„æ—¶å€™ä¸èƒ½åšå…¶ä»–äº‹æƒ… éé˜»å¡å¼I/Oå¦‚æœä¸æƒ³è¿›ç¨‹ä¸€ç›´é˜»å¡åœ¨é‚£é‡Œçš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®æœ¬æ¬¡å¥—æ¥å­—è¿æ¥ä¸ºéé˜»å¡çš„ æŸ¥çœ‹ä¸Šå›¾å¯çŸ¥ï¼Œåœ¨è®¾ç½®è¿æ¥ä¸ºéé˜»å¡æ—¶ï¼Œå½“åº”ç”¨è¿›ç¨‹ç³»ç»Ÿè°ƒç”¨recvfromæ²¡æœ‰æ•°æ®è¿”å›æ—¶ï¼Œå†…æ ¸ä¼šç«‹å³è¿”å›ä¸€ä¸ªEWOULDBLOCKé”™è¯¯ï¼Œè€Œä¸ä¼šä¸€ç›´é˜»å¡åˆ°æ•°æ®å‡†å¤‡å¥½ã€‚å¦‚ä¸Šå›¾åœ¨ç¬¬å››æ¬¡è°ƒç”¨æ—¶æœ‰ä¸€ä¸ªæ•°æ®æŠ¥å‡†å¤‡å¥½äº†ï¼Œæ‰€ä»¥è¿™æ—¶æ•°æ®ä¼šè¢«å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ç¼“å†²åŒºï¼Œäºæ˜¯recvfromæˆåŠŸè¿”å›æ•°æ® å½“ä¸€ä¸ªåº”ç”¨è¿›ç¨‹è¿™æ ·å¾ªç¯è°ƒç”¨recvfromæ—¶ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºè½®è¯¢pollingã€‚è¿™ä¹ˆåšå¾€å¾€ä¼šè€—è´¹å¤§é‡CPUæ—¶é—´ï¼Œå®é™…ä½¿ç”¨å¾ˆå°‘ ä¾‹å­è¿˜æ˜¯å•†åœºåƒé¥­ï¼Œåªæ˜¯ç°åœ¨å¯ä»¥å–å·äº†ã€‚ä¸è¿‡ä»ç„¶éœ€è¦æ—¶ä¸æ—¶çš„å»çœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰å«åˆ°å· I/O å¤ç”¨ Linux I/Oå¤ç”¨æ¨¡å‹æä¾›äº†select poll epollä¸‰ç»„ç³»ç»Ÿè°ƒç”¨å¯åšé€‰æ‹©ï¼Œè¿›ç¨‹é€šè¿‡å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦(fd)ä¼ é€’ç»™selectæˆ–pollæˆ–epollç³»ç»Ÿè°ƒç”¨ï¼Œé€šè¿‡å®ƒä»¬æ¥ç›‘æµ‹å¤šä¸ªfdæ˜¯å¦å¤„äºå°±ç»ªçŠ¶æ€ã€‚selectæˆ–pollæ˜¯é¡ºåºæ‰«æfdæ˜¯å¦å°±ç»ªï¼Œè€Œä¸”æ”¯æŒçš„fdæ•°é‡æœ‰é™ï¼Œå› æ­¤ä½¿ç”¨ä¸Šæœ‰åˆ¶çº¦ã€‚epollè°ƒç”¨åŸºäºäº‹ä»¶é©±åŠ¨ï¼Œå› æ­¤æ€§èƒ½æ›´é«˜ï¼Œå½“fdå°±ç»ªæ—¶ä¼šç«‹å³å›è°ƒrollback è§£é‡Šä¸€ä¸‹æ–‡ä»¶æè¿°ç¬¦ Linux å†…æ ¸å°†æ‰€æœ‰å¤–éƒ¨è®¾å¤‡éƒ½çœ‹åšä¸€ä¸ªæ–‡ä»¶æ¥æ“ä½œï¼Œå¯¹ä¸€ä¸ªæ–‡ä»¶çš„è¯»å†™æ“ä½œä¼šè°ƒç”¨å†…æ ¸æä¾›çš„ç³»ç»Ÿå‘½ä»¤ï¼Œè¿”å›ä¸€ä¸ªfile descriptor(fd æ–‡ä»¶æè¿°ç¬¦)ã€‚è€Œå¯¹ä¸€ä¸ªsocketçš„è¯»å†™ä¹Ÿä¼šæœ‰ç›¸åº”çš„æè¿°ç¬¦ï¼Œç§°ä¸ºsocket fdã€‚ ç°åœ¨å†æ¥çœ‹ä¸€ä¸‹ä¸Šå›¾ï¼Œä¸Šå›¾ä»¥selectä¸ºä¾‹ã€‚ä¸éš¾å‘ç°è¿›ç¨‹ä¼šé˜»å¡äºselectè°ƒç”¨ï¼Œç›´åˆ°æ‰€å…³æ³¨çš„æŸä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦(å¥—æ¥å­—)å˜ä¸ºå¯è¯»çŠ¶æ€ ä¾‹å­è¿˜æ˜¯å•†åœºåƒé¥­ï¼Œä½†æ˜¯ç°åœ¨ä½ å¯ä»¥åœ¨æ‰‹æœºAPPä¸ŠåŒæ—¶å«å¤šä¸ªå·äº†ï¼Œåªè¦å¤šä¸ªå·é‡Œé¢æœ‰ä¸€ä¸ªå·å¥½äº†å°±ä¼šé€šçŸ¥ä½ äº† ä¿¡å·é©±åŠ¨I/O ä¿¡å·é©±åŠ¨I/Oçš„æ„æ€å°±æ˜¯æˆ‘ä»¬ç°åœ¨ä¸ç”¨å‚»ç­‰ç€äº†ï¼Œä¹Ÿä¸ç”¨å»è½®è¯¢ã€‚è€Œæ˜¯è®©å†…æ ¸åœ¨æ•°æ®å°±ç»ªæ—¶ï¼Œå‘é€ä¿¡å·é€šçŸ¥æˆ‘ä»¬ã€‚è°ƒç”¨çš„æ­¥éª¤æ˜¯ï¼Œæˆ‘ä»¬é€šè¿‡ç³»ç»Ÿè°ƒç”¨sigactionï¼Œå¹¶æ³¨å†Œä¸€ä¸ªä¿¡å·å¤„ç†çš„å›è°ƒå‡½æ•°ï¼Œè¯¥è°ƒç”¨ä¼šç«‹å³è¿”å›ï¼Œä½†æ˜¯å½“å†…æ ¸æ•°æ®å°±ç»ªæ—¶ï¼Œå†…æ ¸ä¼šä¸ºè¯¥è¿›ç¨‹äº§ç”Ÿä¸€ä¸ªSIGIOä¿¡å·ï¼Œå¹¶å›è°ƒæˆ‘ä»¬æ³¨å†Œçš„ä¿¡å·å›è°ƒå‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ä¿¡å·å›è°ƒå‡½æ•°ä¸­ç³»ç»Ÿè°ƒç”¨recvfromè·å–æ•°æ® ä¾‹å­å•†åœºåƒé¥­ï¼Œåªè¦å–äº†å·ï¼Œä½ ä¹Ÿä¸ç”¨å»ä¸€ç›´çœ‹çœ‹å¤§å±å¹•æœ‰æ²¡æœ‰å¥½äº†ï¼Œè¦æ˜¯å«åˆ°å·äº†ï¼Œä¼šä¸»åŠ¨å‘æ¶ˆæ¯å‘Šè¯‰ä½ äº† å¼‚æ­¥I/O å¼‚æ­¥I/O ä¸ ä¿¡å·é©±åŠ¨I/Oæœ€å¤§åŒºåˆ«åœ¨äºï¼Œä¿¡å·é©±åŠ¨æ˜¯å†…æ ¸é€šçŸ¥æˆ‘ä»¬ä½•æ—¶å¼€å§‹ä¸€ä¸ªI/Oæ“ä½œï¼Œè€Œå¼‚æ­¥I/Oæ˜¯ç”±å†…æ ¸é€šçŸ¥æˆ‘ä»¬I/Oæ“ä½œä½•æ—¶å®Œæˆï¼Œä¸¤è€…æœ‰æœ¬è´¨åŒºåˆ« ä¾‹å­éƒ½ä¸ç”¨å»å•†åœºåƒé¥­äº†ï¼Œç›´æ¥ç‚¹ä¸ªå¤–å–ï¼ŒæŠŠç­‰å¾…ä¸Šèœçš„æ—¶é—´ä¹Ÿç»™çœäº† æ€»ç»“æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†5ç§I/Oæ¨¡å‹ï¼Œä¾‹å­ä¹Ÿæ˜¯å‚è€ƒäº†ç½‘ä¸Šä¸ªäººè§‰å¾—æ¯”è¾ƒåˆç†çš„è§£é‡Šï¼Œå¸Œæœ›èƒ½å¯¹æ­¤æœ‰ç–‘æƒ‘çš„åŒå­¦æœ‰æ‰€å¸®åŠ©ã€‚å¦å¤–æ–‡ç« ä¸»è¦å‚è€ƒäº†Unix ç½‘ç»œç¼–ç¨‹è¿™æœ¬ä¹¦ï¼Œæœ‰å…´è¶£çš„åŒå­¦ä¹Ÿå¯ä»¥æ·±å…¥äº†è§£]]></content>
      <categories>
        <category>åŸºç¡€</category>
        <category>IO</category>
      </categories>
      <tags>
        <tag>IO</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring IOC æºç è§£æ ï¼ˆå¾ªç¯ä¾èµ–çš„è§£å†³ï¼‰]]></title>
    <url>%2F2018%2F12%2F21%2FSpring-IOC-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%EF%BC%88%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%9A%84%E8%A7%A3%E5%86%B3%EF%BC%89%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ä¹‹å‰çš„å‡ ç¯‡å¯¹Spring IOCæºç åˆ†æçš„æ–‡ç« ï¼Œå¤§ä½“ä¸ŠæŠŠIOCå®¹å™¨å†…éƒ¨å®ç°åšäº†åˆ†æï¼Œä½†åœ¨æœ‰äº›ç»†èŠ‚ä¸Šå¹¶æ²¡æœ‰å¾ˆæ·±å…¥çš„å»åˆ†æã€‚æœ¬ç¯‡æ–‡ç« ä¸»è¦æ˜¯åˆ†æSpring IOCå®¹å™¨å¯¹Beanä¹‹é—´çš„å¾ªç¯ä¾èµ–æ˜¯å¦‚ä½•è§£å†³çš„ ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–é‚£ä¹ˆä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–å‘¢ï¼Ÿç®€å•çš„ç†è§£ä¸€ä¸‹ï¼ŒAä¾èµ–Bï¼ŒBåˆä¾èµ–Aï¼Œè¿™å°±æ„æˆäº†ä¸€ä¸ªæœ€ç®€å•çš„å¾ªç¯ä¾èµ–ï¼Œä¸ºäº†å¸®åŠ©å¤§å®¶ç†è§£ï¼Œæ–°å»ºä¸¤ä¸ªäº’ç›¸ä¾èµ–çš„ç±»ï¼ˆå„¿å­å’Œçˆ¸çˆ¸äº’ç›¸ä¾èµ–æ²¡æœ‰é”™å§ ..ï¼‰ 123456789public class Father &#123; private String name; private Son son;&#125;public class Son &#123; private String name; private Father father;&#125; è¿™ä¸¤ä¸ªbeanäº¤ç»™Springç®¡ç† 123456789&lt;bean id=&quot;son&quot; class=&quot;com.wangjn.demo.impl.Son&quot;&gt; &lt;property name=&quot;name&quot; value=&quot;son&quot;&gt;&lt;/property&gt; &lt;property name=&quot;father&quot; ref=&quot;father&quot;&gt;&lt;/property&gt;&lt;/bean&gt;&lt;bean id=&quot;father&quot; class=&quot;com.wangjn.demo.impl.Father&quot;&gt; &lt;property name=&quot;name&quot; value=&quot;father&quot;&gt;&lt;/property&gt; &lt;property name=&quot;son&quot; ref=&quot;son&quot;&gt;&lt;/property&gt;&lt;/bean&gt; å¯åŠ¨Spring IOCå®¹å™¨ï¼Œç”¨getBeanæ–¹æ³•å¯ä»¥æˆåŠŸè·å–sonå¯¹è±¡ï¼Œå¹¶ä¸”ä¹Ÿæ³¨å…¥äº†fatherå¯¹è±¡ï¼Œå¯è§Springä¸ºæˆ‘ä»¬è§£å†³äº†å¾ªç¯ä¾èµ–çš„é—®é¢˜ã€‚å¯æ˜¯æŒ‰ç…§æ­£å¸¸åˆ›å»ºBeançš„æµç¨‹æ¥è¯´ï¼Œè¿™ä¸ªè¿‡ç¨‹å°†ä¼šæ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå› ä¸ºåœ¨åˆ›å»ºsonå¯¹è±¡ä¸ºsonæ³¨å…¥fatherå±æ€§æ—¶ï¼Œå°±ä¼šå»è·å–fatherå¯¹è±¡ï¼Œè€Œåœ¨è·å–fatherå¯¹è±¡èµ‹å€¼sonå±æ€§çš„æ—¶å€™ï¼Œåˆä¼šå»è·å–sonå¯¹è±¡ï¼Œä»è€Œå°±é™·å…¥äº†æ­»å¾ªç¯ï¼Œç„¶åç¨‹åºå´©æºƒã€‚ å¯æ˜¯ç»“æœå¹¶ä¸æ˜¯æˆ‘ä»¬é¢„æ–™çš„é‚£æ ·ï¼Œæ¥ä¸‹æ¥å°±æ¥åˆ†æSpringæ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„ Spring å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–ä¹‹å‰å¯¹IOCæºç åˆ†æçš„æ–‡ç« ä¸­æœ‰åˆ†æè¿‡Beançš„åˆ›å»ºè¿‡ç¨‹ï¼Œä¸‹é¢æˆ‘å°†å¯¹å¾ªç¯ä¾èµ–å®ç°çš„æŸäº›ç»†èŠ‚ä½œåˆ†æ Spring ç”¨ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–è®©æˆ‘ä»¬å›åˆ°AbstractBeanFactoryçš„doGetBeanæ–¹æ³•ï¼ŒdoGetBeanæ–¹æ³•å°±æ˜¯æˆ‘ä»¬é€šè¿‡å®¹å™¨getBeanæ–¹æ³•å®é™…è°ƒç”¨çš„é€»è¾‘ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œç€é‡å…³æ³¨getSingletonæ–¹æ³•ï¼Œä¹‹å‰çš„åˆ†æä¸­æœ‰æåˆ°ï¼Œè°ƒç”¨getSingleton(beanName)æ–¹æ³•çš„ç›®çš„æ˜¯ä¸ºäº†ä»ç¼“å­˜ä¸­ç›´æ¥è·å–å·²ç»åˆ›å»ºçš„Beanï¼Œè€Œä¸å¿…é‡å¤å»åˆ›å»ºã€‚ç°åœ¨è®©æˆ‘ä»¬è¿›åˆ°getSingletonæ–¹æ³•é‡Œé¢å»çœ‹çœ‹å®ƒéƒ½åšäº†å•¥ï¼Œä»å“ªä¸ªç¼“å­˜å–åˆ°äº†Beanå¯¹è±¡ 1234567891011protected &lt;T&gt; T doGetBean( final String name, final Class&lt;T&gt; requiredType, final Object[] args, boolean typeCheckOnly) throws BeansException &#123; final String beanName = transformedBeanName(name); Object bean; // ä»ç¼“å­˜ä¸­è·å– bean Object sharedInstance = getSingleton(beanName); ... çœç•¥å…¶ä»–åˆ›å»ºbeançš„ä»£ç &#125; getSingletonæ–¹æ³•1234567891011121314151617181920212223242526272829public Object getSingleton(String beanName) &#123; // é»˜è®¤éƒ½æ˜¯å…è®¸æå‰æš´éœ²å¯¹è±¡ return getSingleton(beanName, true);&#125;protected Object getSingleton(String beanName, boolean allowEarlyReference) &#123; // ä»åˆ›å»ºå®Œæˆçš„beanç¼“å­˜ä¸­è·å–bean Object singletonObject = this.singletonObjects.get(beanName); // åˆ¤æ–­è¯¥beanæ˜¯å¦ä»åœ¨åˆ›å»ºä¸­ï¼Œæ„æ€æ˜¯Beanå·²ç»å®Œæˆå®ä¾‹åŒ–ï¼Œä½†è¿˜ä¸å®Œæ•´ã€‚å±æ€§è¿˜æœªå®Œå…¨æ³¨å…¥ if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123; synchronized (this.singletonObjects) &#123; // ä»æå‰æš´éœ²çš„Beanç¼“å­˜å®¹å™¨ï¼ˆearlySingletonObjectsï¼‰ä¸­è·å– singletonObject = this.earlySingletonObjects.get(beanName); // ä»æœªè·å–åˆ°åˆ™ä»singletonFactoriesç¼“å­˜ä¸­è·å– if (singletonObject == null &amp;&amp; allowEarlyReference) &#123; ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName); if (singletonFactory != null) &#123; singletonObject = singletonFactory.getObject(); // åŠ å…¥åˆ°æå‰æš´éœ²Beanç¼“å­˜ï¼ˆearlySingletonObjectsï¼‰ä¸­ this.earlySingletonObjects.put(beanName, singletonObject); // ä»singletonFactoriesç¼“å­˜ä¸­ç§»é™¤ this.singletonFactories.remove(beanName); &#125; &#125; &#125; &#125; // è¿”å›å¯¹è±¡ï¼Œè¿™é‡Œè¿”å›çš„ä¸ä¸€å®šæ˜¯å®Œå…¨åˆ›å»ºçš„å¯¹è±¡ return (singletonObject != NULL_OBJECT ? singletonObject : null);&#125; ä»getSingletonæ–¹æ³•ä¸­æˆ‘ä»¬éœ€è¦ç€é‡å…³æ³¨å‡ ä¸ªBeançš„ç¼“å­˜ï¼Œæ ‡é¢˜å·²ç»è¯´äº†ï¼Œç¼“å­˜æ˜¯è§£å†³å¾ªç¯ä¾èµ–çš„å…³é”®ï¼Œä¸‹é¢æˆ‘ä»‹ç»ä¸€ä¸‹ä¸Šé¢ä»£ç ä¸­æåˆ°äº†ä¸‰ç§ç¼“å­˜ 12345678/** Cache of singleton objects: bean name --&gt; bean instance */private final Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;String, Object&gt;(256);/** Cache of singleton factories: bean name --&gt; ObjectFactory */private final Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;String, ObjectFactory&lt;?&gt;&gt;(16);/** Cache of early singleton objects: bean name --&gt; bean instance */private final Map&lt;String, Object&gt; earlySingletonObjects = new HashMap&lt;String, Object&gt;(16); singletonObjects ç”¨äºå­˜æ”¾åˆ›å»ºå®Œæˆçš„å•ä¾‹å¯¹è±¡ singletonFactories ç”¨äºå­˜æ”¾å¯¹è±¡å·¥å‚ç±»ï¼Œè¿™é‡Œæ˜¯è§£å†³å¾ªç¯ä¾èµ–çš„ earlySingletonObjects ç”¨äºå­˜æ”¾æå‰æš´éœ²çš„å•ä¾‹å¯¹è±¡ã€‚æŒ‡çš„æ˜¯å·²ç»å®ŒæˆBeançš„å®ä¾‹åŒ–ï¼Œä½†è¿˜æœªå®Œæˆå±æ€§æ³¨å…¥çš„ä¸å®Œæ•´å¯¹è±¡ å†æ¥è¯´ä¸Šé¢ä»£ç ä¸­å–ç¼“å­˜çš„æ­¥éª¤ï¼Œé¦–å…ˆè‚¯å®šæ˜¯ä»singletonObjectsä¸­è·å–å®Œå…¨åˆ›å»ºå®Œæˆçš„Beanå¯¹è±¡ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™ä»æå‰æš´éœ²å¯¹è±¡ç¼“å­˜ï¼ˆearlySingletonObjectsï¼‰ä¸­è·å–ï¼Œè¿˜è·å–ä¸åˆ°å†åˆ°singletonFactoriesä¸­è·å– åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œæˆ‘ä»¬åªåˆ†æäº†å–Beanç¼“å­˜çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬è¦åˆ†æçš„å°±æ˜¯æ”¾ç¼“å­˜çš„è¿‡ç¨‹ä»£ç  æå‰æš´éœ²Beanç°åœ¨è®©æˆ‘ä»¬å»åˆ°åˆ›å»ºBeançš„è¿‡ç¨‹ã€‚å¦‚æœç¼“å­˜æ²¡å–åˆ°ï¼Œä¼šæ‰§è¡Œåˆ›å»ºBeançš„é€»è¾‘ï¼Œæ‰¾åˆ°AbstractAutowireCapableBeanFactoryç±»çš„doCreateBeanæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­æœ‰åšè¿‡åˆ†æï¼Œä½†æ²¡æœ‰å¯¹Beanç¼“å­˜å¤„ç†åšåˆ†æã€‚è¿™é‡Œæˆ‘ä»¬ç€é‡çœ‹ä¸­é—´è§£å†³å¾ªç¯ä¾èµ–çš„é‚£éƒ¨åˆ† 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final Object[] args) throws BeanCreationException &#123; // Instantiate the bean. // å°è£…beançš„å®¹å™¨ BeanWrapper instanceWrapper = null; if (mbd.isSingleton()) &#123; instanceWrapper = this.factoryBeanInstanceCache.remove(beanName); &#125; if (instanceWrapper == null) &#123; // è¿™é‡Œæ˜¯åˆ›å»º BeanWrapper instanceWrapper = createBeanInstance(beanName, mbd, args); &#125; final Object bean = (instanceWrapper != null ? instanceWrapper.getWrappedInstance() : null); Class&lt;?&gt; beanType = (instanceWrapper != null ? instanceWrapper.getWrappedClass() : null); mbd.resolvedTargetType = beanType; // Allow post-processors to modify the merged bean definition. synchronized (mbd.postProcessingLock) &#123; if (!mbd.postProcessed) &#123; try &#123; applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName); &#125; catch (Throwable ex) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Post-processing of merged bean definition failed&quot;, ex); &#125; mbd.postProcessed = true; &#125; &#125; // åˆ¤æ–­æ˜¯å¦éœ€è¦æå‰æš´éœ²å¯¹è±¡çš„å¼•ç”¨ï¼Œç”¨äºè§£å†³å¾ªç¯ä¾èµ– boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName)); if (earlySingletonExposure) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Eagerly caching bean &apos;&quot; + beanName + &quot;&apos; to allow for resolving potential circular references&quot;); &#125; addSingletonFactory(beanName, new ObjectFactory&lt;Object&gt;() &#123; @Override public Object getObject() throws BeansException &#123; // è¿™é‡Œä¼šä¸AOPç›¸å…³ return getEarlyBeanReference(beanName, mbd, bean); &#125; &#125;); &#125; // Initialize the bean instance. Object exposedObject = bean; try &#123; // ä¾èµ–æ³¨å…¥çš„ä¸»é€»è¾‘ populateBean(beanName, mbd, instanceWrapper); if (exposedObject != null) &#123; // æ‰§è¡Œä¸€äº›åˆå§‹åŒ–çš„æ–¹æ³• exposedObject = initializeBean(beanName, exposedObject, mbd); &#125; &#125; catch (Throwable ex) &#123; if (ex instanceof BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123; throw (BeanCreationException) ex; &#125; else &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Initialization of bean failed&quot;, ex); &#125; &#125; if (earlySingletonExposure) &#123; Object earlySingletonReference = getSingleton(beanName, false); if (earlySingletonReference != null) &#123; if (exposedObject == bean) &#123; exposedObject = earlySingletonReference; &#125; else if (!this.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123; String[] dependentBeans = getDependentBeans(beanName); Set&lt;String&gt; actualDependentBeans = new LinkedHashSet&lt;String&gt;(dependentBeans.length); for (String dependentBean : dependentBeans) &#123; if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123; actualDependentBeans.add(dependentBean); &#125; &#125; if (!actualDependentBeans.isEmpty()) &#123; throw new BeanCurrentlyInCreationException(beanName, &quot;Bean with name &apos;&quot; + beanName + &quot;&apos; has been injected into other beans [&quot; + StringUtils.collectionToCommaDelimitedString(actualDependentBeans) + &quot;] in its raw version as part of a circular reference, but has eventually been &quot; + &quot;wrapped. This means that said other beans do not use the final version of the &quot; + &quot;bean. This is often the result of over-eager type matching - consider using &quot; + &quot;&apos;getBeanNamesOfType&apos; with the &apos;allowEagerInit&apos; flag turned off, for example.&quot;); &#125; &#125; &#125; &#125; // Register bean as disposable. try &#123; registerDisposableBeanIfNecessary(beanName, bean, mbd); &#125; catch (BeanDefinitionValidationException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, &quot;Invalid destruction signature&quot;, ex); &#125; return exposedObject;&#125; é€šè¿‡çœ‹ä»£ç ï¼Œå¯çŸ¥åœ¨Beanå®Œæˆå®ä¾‹åŒ–ä¹‹åï¼Œæ³¨å…¥å±æ€§ä¹‹å‰ï¼ŒSpringå°±å°†è¿™ä¸ªä¸å®Œæ•´çš„Beanæ”¾åˆ°äº†singletonFactoriesç¼“å­˜ä¸­ï¼Œä»è€Œè®©è¿™ä¸ªBeanæå‰è¿›è¡Œäº†æš´éœ²ã€‚è¿™æ ·å­åœ¨åç»­çš„å±æ€§æ³¨å…¥æ“ä½œä¸­ï¼Œå¦‚æœå­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œå°±ä¼šä»ç¼“å­˜ä¸­è·å–åˆ°è¿™ä¸ªæå‰æš´éœ²çš„Beanï¼Œä»è€Œå¯ä»¥é¡ºåˆ©å®Œæˆä¾èµ–æ³¨å…¥ã€‚ä½†æ˜¯è¦æ³¨æ„è¿™æ—¶å€™æ³¨å…¥çš„å¯¹è±¡æ˜¯ä¸å®Œæ•´çš„ï¼Œä½†æ˜¯å› ä¸ºä¾èµ–æ–¹å·²ç»æŒæœ‰å®ƒçš„å¼•ç”¨ï¼Œæ‰€ä»¥åç»­å¯¹è±¡çš„å®Œæ•´æ€§æ˜¯å¯ä»¥ä¿è¯çš„ æ€»ç»“æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»Springå¯¹Beançš„ç¼“å­˜å±‚é¢åˆ†æäº†å…¶å¯¹å¾ªç¯ä¾èµ–çš„è§£å†³ï¼Œè™½ç„¶æ˜¯Springå¸®æˆ‘ä»¬è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å¯¹äºå®ç°çš„é€»è¾‘æˆ‘ä»¬ä»ç„¶åº”è¯¥å»äº†è§£ï¼Œè­¬å¦‚ï¼Œé€šè¿‡æŸ¥çœ‹æºç å¯çŸ¥Springä»…ä»…å¯¹å•ä¾‹ç±»å‹çš„å¾ªç¯ä¾èµ–è¿›è¡Œè§£å†³ï¼Œå¯¹äºæœ‰çŠ¶æ€çš„BeanSpringå¹¶æ²¡æœ‰å»åšå¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥è·‘å‡ºå¼‚å¸¸ï¼Œè¿™äº›éƒ½æ˜¯éœ€è¦æ³¨æ„çš„ã€‚]]></content>
      <categories>
        <category>javaæ¡†æ¶</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Javaçº¿ç¨‹æ± åˆ†æ]]></title>
    <url>%2F2018%2F12%2F20%2FJava%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%88%86%E6%9E%90%2F</url>
    <content type="text"><![CDATA[å¼•è¨€åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨åˆ°çº¿ç¨‹æ± ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨ä¸€ä¸ªä¸€ä¸ªåˆ›å»ºçº¿ç¨‹ï¼Œé‚£ä¹ˆä¸ºä½•æˆ‘ä»¬è¿˜æ˜¯æ¨å´‡å¤§å®¶ä½¿ç”¨çº¿ç¨‹æ± è¿›è¡Œå¹¶å‘ç¼–ç¨‹å‘¢ï¼Ÿå€Ÿç”¨ã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹æåˆ°çš„æ¥è¯´ä¸€ä¸‹ä½¿ç”¨çº¿ç¨‹æ± çš„ä¼˜ç‚¹æœ‰3ä¸ª é™ä½èµ„æºæ¶ˆè€—ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚ æé«˜å“åº”é€Ÿåº¦ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦çš„ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚ æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚ ThreadPoolExecutorç±»åœ¨æ—¥å¸¸ä½¿ç”¨ä¸­ï¼Œå¤§å¤šæ•°æƒ…å†µæˆ‘ä»¬éƒ½ä¼šä½¿ç”¨JDKæä¾›çš„Executorså»åˆ›å»ºçº¿ç¨‹æ± ï¼ŒExecutorsåˆ©ç”¨å·¥å‚æ¨¡å¼å‘æˆ‘ä»¬æä¾›äº†4ç§çº¿ç¨‹æ± å®ç°æ–¹å¼ï¼Œä½†æ˜¯æœ€æ–°çš„é˜¿é‡ŒJavaå¼€å‘æ‰‹å†Œä¸­æ˜ç¡®è¯´æ˜äº†ä¸å»ºè®®ä½¿ç”¨Executorså»åˆ›å»ºçº¿ç¨‹æ± ï¼ŒåŸå› æ˜¯ä½¿ç”¨Executorsåˆ›å»ºçº¿ç¨‹æ± ä¼šä½¿ç”¨å¾ˆå¤šé»˜è®¤å€¼ï¼Œé»˜è®¤ä½¿ç”¨çš„å‚æ•°æœ‰æ—¶å€™æ˜¯ä¸åˆç†ï¼Œä½†æ˜¯å¼€å‘è€…å¾€å¾€ä¼šå¿½ç•¥ã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨ThreadPoolExecutorç±»æ¥æ˜¾ç¤ºçš„åˆ›å»ºçº¿ç¨‹æ± ã€‚ ä¸‹é¢æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ThreadPoolExecutorç±»çš„ç»§æ‰¿ç»“æ„ ï¿¼ Executoræ¥å£åªå«æœ‰ä¸€ä¸ªexecute(Runnable command)æ–¹æ³•ï¼ŒåŠ å…¥ä¸€ä¸ªæ–°çš„çº¿ç¨‹ ExecutorServiceæ¥å£ç›¸æ¯”Executorå¤šä¸ªå‡ ä¸ªæ–¹æ³• 123456789101112131415161718192021 public interface ExecutorService extends Executor &#123; void shutdown(); boolean isShutdown(); boolean isTerminated(); boolean awaitTermination(long timeout, TimeUnit unit) throws InterruptedException; &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task); &lt;T&gt; Future&lt;T&gt; submit(Runnable task, T result); Future&lt;?&gt; submit(Runnable task); &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) throws InterruptedException; &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, long timeout, TimeUnit unit) throws InterruptedException; &lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) throws InterruptedException, ExecutionException; &lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException;&#125; æˆ‘ä»¬ç›´æ¥çœ‹ThreadPoolExecutoræ‰€æä¾›çš„æ„é€ æ–¹æ³• 1234567public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler) ç°åœ¨æˆ‘ä»¬æ¥è§£é‡Šä¸€ä¸‹å„ä¸ªå‚æ•°çš„å«ä¹‰ corePoolSize æ ¸å¿ƒæ± çš„å¤§å°ï¼Œè¿™ä¸ªå‚æ•°è·Ÿåé¢è®²è¿°çš„çº¿ç¨‹æ± çš„å®ç°åŸç†æœ‰éå¸¸å¤§çš„å…³ç³» maximumPoolSize çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•° keepAliveTime ç©ºé—²çº¿ç¨‹çš„å­˜æ´»æ—¶é—´ï¼Œé»˜è®¤åªæœ‰å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°å¤§äºcorePoolSizeæ—¶ï¼ŒkeepAliveTimeæ‰ä¼šèµ·ä½œç”¨ unit å‚æ•°keepAliveTimeçš„æ—¶é—´å•ä½ workQueue ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜å‚¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ threadFactory çº¿ç¨‹å·¥å‚ï¼Œä¸»è¦ç”¨æ¥åˆ›å»ºçº¿ç¨‹ handler è¡¨ç¤ºå½“æ‹’ç»å¤„ç†ä»»åŠ¡æ—¶çš„ç­–ç•¥ï¼Œæœ‰ä»¥ä¸‹å››ç§å–å€¼ 1234ThreadPoolExecutor.AbortPolicy:ä¸¢å¼ƒä»»åŠ¡å¹¶æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸ã€‚ ThreadPoolExecutor.DiscardPolicyï¼šä¹Ÿæ˜¯ä¸¢å¼ƒä»»åŠ¡ï¼Œä½†æ˜¯ä¸æŠ›å‡ºå¼‚å¸¸ã€‚ ThreadPoolExecutor.DiscardOldestPolicyï¼šä¸¢å¼ƒé˜Ÿåˆ—æœ€å‰é¢çš„ä»»åŠ¡ï¼Œç„¶åé‡æ–°å°è¯•æ‰§è¡Œä»»åŠ¡ï¼ˆé‡å¤æ­¤è¿‡ç¨‹ï¼‰ThreadPoolExecutor.CallerRunsPolicyï¼šç”±è°ƒç”¨çº¿ç¨‹å¤„ç†è¯¥ä»»åŠ¡ ä¸‹é¢å†ç®€å•å†ä»‹ç»ä¸€ä¸‹ThreadPoolExecutorä¸­å‡ ä¸ªé‡è¦çš„æ–¹æ³• execute è¿™ä¸ªæ–¹æ³•å…¶å®å°±æ˜¯å¯¹Executoræ¥å£çš„å®ç°ï¼Œä¹Ÿæ˜¯æœ€æ ¸å¿ƒçš„æ–¹æ³•ï¼Œç”¨äºå‘çº¿ç¨‹æ± ä¸­æäº¤ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ submit è¯¥æ–¹æ³•ä¹Ÿæ˜¯ç”¨äºå‘çº¿ç¨‹æ± é‡Œæäº¤ä»»åŠ¡ï¼ŒåŒºåˆ«åœ¨äºsubmitæäº¤å¯ä»¥æœ‰è¿”å›å€¼ï¼Œä¼šè¿”å›ä¸€ä¸ªFutrueç±»å‹æ¥å¼‚æ­¥è·å–æ‰§è¡Œç»“æœ shutdown ç”¨äºå…³é—­çº¿ç¨‹æ±  shutdownNow ä¹Ÿæ˜¯å…³é—­çº¿ç¨‹æ± ï¼Œä¸shutdownåŒºåˆ«åœ¨äºshutdownNowä¼šå°è¯•å…³é—­æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ä»»åŠ¡ é€šè¿‡æºç åˆ†æ ThreadPoolExecutorä¸Šæ–‡æˆ‘ä»¬ç®€å•çš„åˆ†æäº†ThreadPoolExecutorï¼Œä¸‹é¢æˆ‘ä»¬å°†æ ¹æ®æºç æ¥è¿›ä¸€æ­¥åˆ†æThreadPoolExecutoræ ¸å¿ƒåŠŸèƒ½çš„å®ç° å…ˆä»å…¶æ ¸å¿ƒæ–¹æ³•executeå¼€å§‹è§£è¯» 12345678910111213141516171819202122232425262728293031public void execute(Runnable command) &#123; // å¦‚æœä¼ å…¥ç©ºå¯¹è±¡ åˆ™æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ if (command == null) throw new NullPointerException(); int c = ctl.get(); /** * å¦‚æœå½“å‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ•°å°äº corePoolSize */ if (workerCountOf(c) &lt; corePoolSize) &#123; if (addWorker(command, true)) return; c = ctl.get(); &#125; /** * å¦‚æœå½“å‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ•°å¤§äºcorePoolSizeï¼Œä¸”workQueueæœªæ»¡ */ if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123; // é‡å¤æ£€æŸ¥ä¸€æ¬¡ï¼Œé˜²æ­¢æ­£å¥½æ­¤æ—¶çº¿ç¨‹æ± è¢«shutdown int recheck = ctl.get(); if (! isRunning(recheck) &amp;&amp; remove(command)) reject(command); else if (workerCountOf(recheck) == 0) addWorker(null, false); &#125; /** * å¦‚æœå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡çº¿ç¨‹æ•°å¤§äºcorePoolSizeï¼Œä¸”workQueueå·²æ»¡ï¼Œåˆ™ä½¿ç”¨ * maximumPoolSizeå‚æ•°åˆ›å»ºçº¿ç¨‹ï¼Œå¦‚æœå·²ç»åˆ°äº†maximumPoolSizeæœ€å¤§å€¼ï¼Œåˆ™å¯ç”¨æ‹’ç» * ç­–ç•¥ */ else if (!addWorker(command, false)) reject(command);&#125; ä¸Šé¢çš„ä»£ç ç®€å•æ€»ç»“ä¸€ä¸‹å°±æ˜¯ å½“å‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ•°å°äºcorePoolSizeæ—¶ï¼Œæ­£å¸¸åŠ å…¥æ‰§è¡Œ å½“å‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ•°å¤§äºcorePoolSizeï¼Œä¸”workQueueæœªæ»¡æ—¶ï¼Œåˆ™å°†ä»»åŠ¡åŠ å…¥ç­‰å¾…é˜Ÿåˆ—workQueueä¸­ å¦‚æœå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡çº¿ç¨‹æ•°å¤§äºcorePoolSizeï¼Œä¸”workQueueå·²æ»¡ï¼Œåˆ™ä¼šä¸´æ—¶æ‰©å……çº¿ç¨‹æ•°ï¼Œæ ¹æ®maximumPoolSizeæœ€å¤§çº¿ç¨‹æ•°å€¼ å¦‚æœå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡çº¿ç¨‹æ•°å¤§äºmaximumPoolSize è¿™æ—¶å·²ç»è¶…å‡ºæœ€å¤§å¯æ‰¿å—çš„çº¿ç¨‹æ•°å€¼äº†ï¼Œä¼šå¯ç”¨æ‹’ç»ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯ä¸Šæ–‡æ‰€é…ç½®çš„å››ç§ç­–ç•¥ä¹‹ä¸€ï¼Œé»˜è®¤æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼ŒåŠ å…¥ä»»åŠ¡å¤±è´¥ workQueue ä»»åŠ¡é˜Ÿåˆ—ä¸Šæ–‡æœ‰æåˆ°ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯åœ¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡é˜Ÿåˆ—ã€‚workQueueçš„æœ¬è´¨æ˜¯ä¸€ç§é˜»å¡é˜Ÿåˆ—BlockingQueueï¼Œåˆ—ä¸¾ä¸‰ç§å¸¸ç”¨ç±»å‹ åŸºäºæ•°ç»„çš„å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—åˆ›å»ºæ—¶å¿…é¡»æŒ‡å®šå¤§å° åŸºäºé“¾è¡¨çš„å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ— åŒæ­¥é˜Ÿåˆ— è¯¥é˜Ÿåˆ—ä¸å­˜å‚¨å…ƒç´ ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¼šä¸€ç›´é˜»å¡ æ ¸å¿ƒåŠŸèƒ½åˆ†æä¸Šæ–‡ä¸­æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹æºç çŸ¥é“äº†æ–°ä»»åŠ¡åŠ å…¥çº¿ç¨‹æ± çš„ç­–ç•¥ï¼Œä¸‹é¢æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ï¼Œå†åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæ€è€ƒå‡ ä¸ªé—®é¢˜ ä»»åŠ¡ç­‰å¾…é˜Ÿåˆ—æ˜¯åœ¨ä½•æ—¶è¢«æ‰§è¡Œï¼Ÿ çº¿ç¨‹æ˜¯å¦‚ä½•å®ç°é‡å¤åˆ©ç”¨çš„ï¼Ÿï¼Œæ¯•ç«Ÿè¿™æ˜¯çº¿ç¨‹æ± æœ€é‡è¦çš„åŠŸèƒ½äº† ç©ºé—²çº¿ç¨‹æ ¹æ®keepAliveTimeå‚æ•°æ˜¯åœ¨å“ªé‡Œè¢«å›æ”¶çš„ï¼Ÿ æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­é€šè¿‡æºç æ¥è§£è¯»è¿™ä¸‰ä¸ªé—®é¢˜æ ¹æ®ä¸Šæ–‡executeæ–¹æ³•æºç ï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨äº†addWorkeræ–¹æ³• 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071private boolean addWorker(Runnable firstTask, boolean core) &#123; retry: for (;;) &#123; int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs &gt;= SHUTDOWN &amp;&amp; ! (rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty())) return false; for (;;) &#123; int wc = workerCountOf(c); // è¿™é‡Œåˆ¤æ–­å½“å‰çº¿ç¨‹æ•°æ˜¯å¦å¤§äºæœ€å¤§å€¼ï¼Œå¤§äºäº†åˆ™è¿”å›false if (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize)) return false; if (compareAndIncrementWorkerCount(c)) break retry; c = ctl.get(); // Re-read ctl if (runStateOf(c) != rs) continue retry; // else CAS failed due to workerCount change; retry inner loop &#125; &#125; boolean workerStarted = false; boolean workerAdded = false; Worker w = null; try &#123; // æ–°å»ºäº†ä¸€ä¸ª Worker w = new Worker(firstTask); final Thread t = w.thread; if (t != null) &#123; final ReentrantLock mainLock = this.mainLock; // åŠ é” mainLock.lock(); try &#123; // Recheck while holding lock. // Back out on ThreadFactory failure or if // shut down before lock acquired. int rs = runStateOf(ctl.get()); if (rs &lt; SHUTDOWN || (rs == SHUTDOWN &amp;&amp; firstTask == null)) &#123; if (t.isAlive()) // precheck that t is startable throw new IllegalThreadStateException(); // æŠŠå½“å‰è¿™ä¸ªå·¥ä½œçº¿ç¨‹åŠ å…¥åˆ° workers é›†åˆä¸­ workers.add(w); int s = workers.size(); if (s &gt; largestPoolSize) largestPoolSize = s; workerAdded = true; &#125; &#125; finally &#123; mainLock.unlock(); &#125; if (workerAdded) &#123; // å¼€å§‹æ‰§è¡Œæ­¤worker t.start(); workerStarted = true; &#125; &#125; &#125; finally &#123; if (! workerStarted) addWorkerFailed(w); &#125; return workerStarted;&#125; æ ¹æ®å‚æ•°core åˆ¤æ–­å½“å‰çº¿ç¨‹æ•°æ˜¯å¦å·²ç»å¤§äºcorePoolSizeæˆ–maximumPoolSizeï¼Œå¤§äºåˆ™ç›´æ¥è¿”å›false åˆå§‹åŒ–äº†ä¸€ä¸ªWorkerå¯¹è±¡ï¼Œå¹¶ä¸”åŠ å…¥åˆ°äº†workersé›†åˆä¸­ï¼Œworkersæ˜¯ä¸€ä¸ªSetç±»å‹çš„é›†åˆ å¯åŠ¨å½“å‰è¿™ä¸ªWorkerçº¿ç¨‹ä»»åŠ¡ ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œå¯èƒ½å¤§æ¦‚ä¼šæœ‰ç–‘æƒ‘ï¼ŒWorkerå¯¹è±¡æ˜¯åšå•¥çš„ï¼Ÿä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸‹Workerç±»çš„å®ç° 1234567891011121314151617181920212223242526272829private final class Worker extends AbstractQueuedSynchronizer implements Runnable&#123; /** Thread this worker is running in. Null if factory fails. */ final Thread thread; /** Initial task to run. Possibly null. */ Runnable firstTask; /** Per-thread task counter */ volatile long completedTasks; /** * Creates with given first task and thread from ThreadFactory. * @param firstTask the first task (null if none) */ Worker(Runnable firstTask) &#123; setState(-1); // inhibit interrupts until runWorker this.firstTask = firstTask; this.thread = getThreadFactory().newThread(this); &#125; /** Delegates main run loop to outer runWorker */ public void run() &#123; runWorker(this); &#125; ...&#125; Workerå®ç°äº†Runnableæ¥å£ æ„é€ æ–¹æ³•ä¸­é€šè¿‡ThreadFactoryåˆå§‹åŒ–äº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹å¯¹è±¡ run()æ–¹æ³•è°ƒç”¨äº†ThreadPoolExecutorçš„runWorker() é‡ç‚¹åœ¨runWorkeræ–¹æ³•ä¸­ çº¿ç¨‹æ± é‡å¤åˆ©ç”¨æœºåˆ¶1234567891011121314151617181920212223242526272829303132333435363738394041424344454647final void runWorker(Worker w) &#123; Thread wt = Thread.currentThread(); // è·å–ç¬¬ä¸€ä¸ªä»»åŠ¡ Runnable task = w.firstTask; w.firstTask = null; w.unlock(); // allow interrupts boolean completedAbruptly = true; try &#123; // ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å¾ªç¯è·å–ä»»åŠ¡æ‰§è¡Œ getTaskæ–¹æ³•æœ‰å¯èƒ½ä¼šé˜»å¡ while (task != null || (task = getTask()) != null) &#123; w.lock(); // If pool is stopping, ensure thread is interrupted; // if not, ensure thread is not interrupted. This // requires a recheck in second case to deal with // shutdownNow race while clearing interrupt if ((runStateAtLeast(ctl.get(), STOP) || (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp; !wt.isInterrupted()) wt.interrupt(); try &#123; // ç©ºå®ç°ï¼Œå¯ä»¥é€šè¿‡ç»§æ‰¿`ThreadPoolExecutor`é‡å†™æ­¤æ–¹æ³• beforeExecute(wt, task); Throwable thrown = null; try &#123; // æ‰§è¡Œ task.run(); &#125; catch (RuntimeException x) &#123; thrown = x; throw x; &#125; catch (Error x) &#123; thrown = x; throw x; &#125; catch (Throwable x) &#123; thrown = x; throw new Error(x); &#125; finally &#123; afterExecute(task, thrown); &#125; &#125; finally &#123; task = null; w.completedTasks++; w.unlock(); &#125; &#125; completedAbruptly = false; &#125; finally &#123; processWorkerExit(w, completedAbruptly); &#125;&#125; ä»£ç è§£æåˆ°è¿™é‡Œï¼ŒåŸºæœ¬å¯ä»¥å›ç­”ä¸Šæ–‡æ‰€æå‡ºçš„ä¸‰ä¸ªé—®é¢˜äº† åŠ å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ä¼šåœ¨è¿™é‡Œè¢«æ‰§è¡Œï¼Œå› ä¸ºWorkerå¯¹è±¡æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡åï¼Œå¹¶ä¸ä¼šç«‹åˆ»ç»“æŸï¼Œè€Œæ˜¯ä¼šé€šè¿‡å¾ªç¯è°ƒç”¨getTask()æ–¹æ³•ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–æœ€æ–°ä»»åŠ¡æ¥æ‰§è¡Œï¼Œè¿™æ ·å­å°±å®ç°äº†çº¿ç¨‹çš„é‡å¤åˆ©ç”¨ï¼Œè€Œä¸å¿…æ¯æ¬¡éƒ½é‡æ–°åˆ›å»ºä¸€ä¸ªWorkerå¯¹è±¡ å½“getTask()æ–¹æ³•æ— æ³•è·å–åˆ°æœ€æ–°çš„ä»»åŠ¡åï¼Œè¯¥Workerçº¿ç¨‹æ‰ä¼šè¢«å›æ”¶ã€‚æ‰€ä»¥ç¬¬ä¸‰ä¸ªé—®é¢˜keepAliveTimeçš„æœºåˆ¶å¿…ç„¶æ˜¯åœ¨getTask()ä¸­å®ç°çš„ getTask è¶…æ—¶ç­–ç•¥123456789101112131415161718192021222324252627282930313233343536373839private Runnable getTask() &#123; boolean timedOut = false; // Did the last poll() time out? for (;;) &#123; int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123; decrementWorkerCount(); return null; &#125; int wc = workerCountOf(c); // workerså¤§äºcorePoolSizeï¼Œæˆ–åˆ™å…è®¸corePoolSizeè®¾ç½®ç©ºé—²è¶…æ—¶æ—¶é—´ boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize; // å½“å‰çº¿ç¨‹æ•°å·²ç»å¤§äºmaximumPoolSizeæˆ–åˆ™å·²ç»è¶…æ—¶è¿‡ä¸€æ¬¡ï¼Œåˆ™ç›´æ¥è¿”å›null if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut)) &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) &#123; if (compareAndDecrementWorkerCount(c)) return null; continue; &#125; try &#123; // è·å–ä»»åŠ¡ï¼Œå¦‚æœtimedä¸ºtrueï¼Œåˆ™ç­‰å¾…ä¸€å®šæ—¶é—´ï¼ˆkeepAliveTimeï¼‰æœªè¿”å›çš„è¯ï¼Œä¼šè¿”å›nullï¼Œå¦‚æœtimedæœªè®¾ç½®ä¸ºtrueï¼Œåˆ™ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°æœ‰æ•°æ® Runnable r = timed ? workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : workQueue.take(); if (r != null) return r; timedOut = true; &#125; catch (InterruptedException retry) &#123; timedOut = false; &#125; &#125;&#125; å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœrunStateå¤§äºSHUTDOWNï¼ˆå³ä¸ºSTOPæˆ–è€…TERMINATEDï¼‰ï¼Œåˆ™ç›´æ¥è¿”å›null åˆ¤æ–­å½“å‰çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°æ˜¯å¦å·²ç»å¤§äºæ ¸å¿ƒæ± å¤§å°corePoolSizeæˆ–è€…å…è®¸ä¸ºæ ¸å¿ƒæ± ä¸­çš„çº¿ç¨‹è®¾ç½®ç©ºé—²å­˜æ´»æ—¶é—´ï¼Œåˆ™è°ƒç”¨workQueue.poll(time,timeUnit)æ¥å–ä»»åŠ¡ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šé˜»å¡ç­‰å¾…ä¸€å®šçš„æ—¶é—´ï¼Œå¦‚æœå–ä¸åˆ°ä»»åŠ¡å°±è¿”å›nullï¼Œå¦åˆ™åˆ™ä¼šè°ƒç”¨workQueue.take()æ¥å–ä»»åŠ¡ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šwaité‡Šæ”¾CPUä¸€ç›´é˜»å¡ã€‚ æ€»ç»“ä¸€ä¸‹ï¼Œåªæœ‰å½“æˆ‘ä»¬è®¾ç½®allowCoreThreadTimeOutï¼ˆæ ¸å¿ƒæ± çº¿ç¨‹ç©ºé—²è¶…æ—¶æ—¶é—´ï¼‰æˆ–åˆ™å½“å‰çº¿ç¨‹æ•°å¤§äºcorePoolSizeæ—¶ï¼ŒkeepAliveTimeæœºåˆ¶æ‰ä¼šç”Ÿæ•ˆ æ•´ä¸ªæµç¨‹åˆ°è¿™é‡Œå¤§æ¦‚å°±åˆ†æå®Œäº†ï¼Œä¸‹å›¾åŸºæœ¬ç»˜åˆ¶äº†çº¿ç¨‹æ± æäº¤ä»»åŠ¡ï¼Œæ‰§è¡Œä»»åŠ¡çš„æ•´ä¸ªæµç¨‹ Executors ä¸­å‡ ä¸ªå¸¸ç”¨çš„çº¿ç¨‹æ± è™½ç„¶é˜¿é‡ŒJavaå¼€å‘è§„çº¦ä¸­ä¸å»ºè®®æˆ‘ä»¬ä½¿ç”¨Executorsç±»ç›´æ¥åˆ›å»ºçº¿ç¨‹æ± ï¼Œä½†è¿˜æ˜¯æœ‰å¿…è¦ç®€å•ä»‹ç»å‡ ä¸ªå…¶ä¸­å¸¸ç”¨çš„æ–¹æ³• Executors.newCachedThreadPool() åˆ›å»ºä¸€ä¸ªç¼“å†²æ± ï¼Œç¼“å†²æ± å®¹é‡å¤§å°ä¸ºInteger.MAX_VALUE. å°†corePoolSizeè®¾ç½®ä¸º0ï¼Œå°†maximumPoolSizeè®¾ç½®ä¸ºInteger.MAX_VALUEï¼ŒworkQueueä½¿ç”¨çš„SynchronousQueueï¼Œä¹Ÿå°±æ˜¯è¯´æ¥äº†ä»»åŠ¡å°±åˆ›å»ºçº¿ç¨‹è¿è¡Œï¼Œå½“çº¿ç¨‹ç©ºé—²è¶…è¿‡60ç§’ï¼Œå°±é”€æ¯çº¿ç¨‹ Executors.newSingleThreadExecutor() åˆ›å»ºå®¹é‡ä¸º1çš„ç¼“å†²æ± ï¼Œå°†corePoolSizeå’ŒmaximumPoolSizeéƒ½è®¾ç½®ä¸º1ï¼ŒworkQueueä½¿ç”¨çš„LinkedBlockingQueue Executors.newFixedThreadPool(int) åˆ›å»ºå›ºå®šå®¹é‡å¤§å°çš„ç¼“å†²æ± ï¼Œç©ºé—²çº¿ç¨‹ä¸ä¼šé”€æ¯ã€‚corePoolSizeå’ŒmaximumPoolSizeå€¼æ˜¯ç›¸ç­‰çš„ï¼ŒworkQueueä½¿ç”¨çš„æ˜¯LinkedBlockingQueue æ€»ç»“æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»å¯¹çº¿ç¨‹æ± çš„é…ç½®ä½¿ç”¨ï¼Œä»¥åŠæºç å®ç°åšäº†åˆ†æï¼Œæ€»ä½“ä¸Šæ¯”è¾ƒå…¨é¢çš„åˆ†æäº†Javaçº¿ç¨‹æ± çš„å®ç°ã€‚]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
        <category>å¹¶å‘ç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>å¹¶å‘</tag>
        <tag>çº¿ç¨‹æ± </tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring AOP æºç è§£æä¸‰ï¼ˆä»£ç†å¯¹è±¡çš„åˆ›å»ºï¼‰]]></title>
    <url>%2F2018%2F12%2F15%2FSpring-AOP-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89%EF%BC%88%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9B%E5%BB%BA%EF%BC%89%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ä¸ŠæœŸæˆ‘ä»¬å¯¹AOPæ ¸å¿ƒæ¦‚å¿µåŠæ¥å£åšäº†ç²—æµ…çš„åˆ†æï¼Œè¿™æœŸæˆ‘ä»¬ä¸»è¦æ¥æ¢è®¨ä¸€ä¸‹ä»£ç†å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ã€‚åœ¨å¼€å§‹ä¹‹å‰ï¼Œå…ˆé—®è‡ªå·±å‡ ä¸ªé—®é¢˜ Springæ˜¯å¦‚ä½•å¸®æˆ‘ä»¬å»é€‰æ‹©åˆé€‚çš„Adviceçš„ï¼Ÿæ‰¾åˆ°äº†åˆæ˜¯é€šè¿‡ä½•ç§æ–¹å¼åˆ›å»ºä»£ç†å¯¹è±¡çš„ï¼Ÿ å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬å¼€å§‹åˆ†æä»£ç†å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ï¼Œé¦–å…ˆï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹AspectJAwareAdvisorAutoProxyCreator.classç±»çš„ç»§æ‰¿ä½“ç³» å¯ä»¥çœ‹åˆ°AspectJAwareAdvisorAutoProxyCreator.classä¸»è¦å®ç°äº†è¿™å‡ ä¸ªæ¥å£ Aware Beanåˆ›å»ºæ—¶æ³¨å…¥ä¸€äº›å®¹å™¨å±æ€§ç­‰ BeanPostProcessor IOC æ‰©å±•ç‚¹ AopInfrastructureBean æ ‡è¯†æ­¤ç±»æ˜¯AOPç³»ç»Ÿç±»ï¼Œä¸èƒ½è¢«ä»£ç† è¿™é‡Œæˆ‘ä»¬ä»…éœ€è¦å…³æ³¨BeanPostProcessoræ¥å£çš„å®ç°ï¼Œå› ä¸ºä»£ç†çš„åˆ›å»ºæ˜¯åœ¨BeanPostProcessoræ¥å£çš„postProcessAfterInitializationæ–¹æ³•æ‰§è¡Œæ—¶åˆ›å»ºçš„ï¼ŒpostProcessAfterInitializationæ–¹æ³•çš„å…·ä½“å®ç°é€»è¾‘æ˜¯åœ¨æŠ½è±¡çˆ¶ç±»AbstractAutoProxyCreatorä¸­å®ç°çš„ å…¥å£ä¸Šæ–‡ä¸­æåˆ°AspectJAwareAdvisorAutoProxyCreator.classæ˜¯BeanPostProcessoræ¥å£çš„å®ç°ï¼Œç°åœ¨å°±è®©æˆ‘ä»¬æ‰“å¼€å®ƒçš„å…¥å£æºç æ…¢æ…¢åˆ†æ 12345678910public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123; if (bean != null) &#123; // è¿”å›ç”¨åšç¼“å­˜çš„keyé”® Object cacheKey = getCacheKey(bean.getClass(), beanName); if (!this.earlyProxyReferences.contains(cacheKey)) &#123; return wrapIfNecessary(bean, beanName, cacheKey); &#125; &#125; return bean;&#125; 1234567891011121314151617181920212223242526272829protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) &#123; if (beanName != null &amp;&amp; this.targetSourcedBeans.contains(beanName)) &#123; return bean; &#125; if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) &#123; return bean; &#125; // åˆ¤æ–­å½“å‰çš„Beanæ˜¯å¦æ˜¯AOPæœ¬èº«çš„ç³»ç»Ÿç±»ï¼Œæ˜¯çš„è¯åˆ™è·³è¿‡ï¼Œä¸åšä»£ç†æ“ä½œ if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123; this.advisedBeans.put(cacheKey, Boolean.FALSE); return bean; &#125; // ä¸ºè¯¥Beanæ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„ advisor Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null); // è¿”å›ä¸ä¸ºç©º if (specificInterceptors != DO_NOT_PROXY) &#123; this.advisedBeans.put(cacheKey, Boolean.TRUE); // åˆ›å»ºä»£ç†å¯¹è±¡ Object proxy = createProxy( bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean)); this.proxyTypes.put(cacheKey, proxy.getClass()); return proxy; &#125; // æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ advisor åˆ™ç›´æ¥è¿”å›åŸå§‹Bean this.advisedBeans.put(cacheKey, Boolean.FALSE); return bean;&#125; çœ‹å®ŒwrapIfNecessaryæ–¹æ³•ï¼Œè¿™é‡Œå°±æ˜¯åˆ›å»ºä»£ç†å¯¹è±¡çš„å…¨è¿‡ç¨‹ã€‚å…¶å®åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¸€å…±å°±åšäº†ä¸¤ä»¶äº‹æƒ…: getAdvicesAndAdvisorsForBeanæ–¹æ³• ç­›é€‰åˆé€‚çš„Advisorå¯¹è±¡ï¼Œå…¶å®å°±æ˜¯ä¸ºå½“å‰ç›®æ ‡å¯¹è±¡æ‰¾åˆ°åˆé€‚çš„é€šçŸ¥(Advice) createProxyæ–¹æ³• æ ¹æ®ç­›é€‰åˆ°çš„åˆ‡é¢ï¼ˆAdvisorï¼‰é›†åˆä¸ºç›®æ ‡å¯¹è±¡åˆ›å»ºä»£ç† ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«å¯¹è¿™ä¸¤ä»¶äº‹æƒ…ä½œåˆ†æ å¯»æ‰¾åˆé€‚çš„ AdvisorfindEligibleAdvisorsæ–¹æ³•æ˜¯åœ¨çˆ¶ç±»AbstractAdvisorAutoProxyCreatorä¸­ï¼Œä¸”ç›´æ¥è°ƒç”¨äº†findEligibleAdvisors æ–¹æ³• 123456 List&lt;Advisor&gt; advisors = findEligibleAdvisors(beanClass, beanName); if (advisors.isEmpty()) &#123; return DO_NOT_PROXY; &#125; return advisors.toArray();&#125; 1234567891011protected List&lt;Advisor&gt; findEligibleAdvisors(Class&lt;?&gt; beanClass, String beanName) &#123; // æ‰¾åˆ°å®¹å™¨ä¸­çš„å…¨éƒ¨é€šçŸ¥ List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors(); // ç­›é€‰åˆé€‚é€šçŸ¥å¯¹è±¡é›†åˆ List&lt;Advisor&gt; eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName); extendAdvisors(eligibleAdvisors); if (!eligibleAdvisors.isEmpty()) &#123; eligibleAdvisors = sortAdvisors(eligibleAdvisors); &#125; return eligibleAdvisors;&#125; è¿™é‡Œä¹Ÿæ˜¯åˆ†å¼€åšäº†ä¸¤ä»¶äº‹æƒ… é¦–å…ˆä»Spring å®¹å™¨ä¸­è·å–åˆ°å…¨éƒ¨Advisorsé›†åˆ æ‰§è¡Œç­›é€‰é€»è¾‘ï¼Œè·å–ç¬¦åˆæ¡ä»¶çš„Advisorsé›†åˆ æ‰¾åˆ°Springå®¹å™¨ä¸­å…¨éƒ¨ Advisorè¿™é‡Œæ˜¯è°ƒç”¨äº†BeanFactoryAdvisorRetrievalHelper.classçš„æ–¹æ³•å»è·å–åˆ°Spring å®¹å™¨ä¸­å…¨éƒ¨Advisoré›†åˆçš„ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„BeanFactoryAdvisorRetrievalHelper.classç±»çš„åˆå§‹åŒ–æ˜¯åœ¨setBeanFactoryæ–¹æ³•ä¸­è¿›è¡Œçš„ 123protected List&lt;Advisor&gt; findCandidateAdvisors() &#123; return this.advisorRetrievalHelper.findAdvisorBeans();&#125; BeanFactoryAdvisorRetrievalHelperçš„findAdvisorBeansæ–¹æ³• 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455public List&lt;Advisor&gt; findAdvisorBeans() &#123; // Determine list of advisor bean names, if not cached already. String[] advisorNames = null; synchronized (this) &#123; // å°è¯•ä»ç¼“å­˜ä¸­è·å– Advisor ç±»å‹çš„Beanåç§° advisorNames = this.cachedAdvisorBeanNames; // if (advisorNames == null) &#123; // ä»BeanFactoryä¸­è·å– Advisor ç±»å‹çš„å…¨éƒ¨Beanåç§°é›†åˆï¼Œå¹¶è®¾ç½®ç¼“å­˜ advisorNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors( this.beanFactory, Advisor.class, true, false); this.cachedAdvisorBeanNames = advisorNames; &#125; &#125; if (advisorNames.length == 0) &#123; return new LinkedList&lt;Advisor&gt;(); &#125; List&lt;Advisor&gt; advisors = new LinkedList&lt;Advisor&gt;(); // éå† Advisorç±»å‹ BeanName é›†åˆ for (String name : advisorNames) &#123; // åˆ¤æ–­æ˜¯å¦åˆæ³•ï¼Œè¿™é‡Œè¿”å›éƒ½æ˜¯true if (isEligibleBean(name)) &#123; // åˆ¤æ–­è¯¥Beanæ˜¯å¦æ­£åœ¨åˆ›å»ºä¸­ï¼Œåˆ›å»ºä¸­åˆ™ç›´æ¥è·³è¿‡ if (this.beanFactory.isCurrentlyInCreation(name)) &#123; if (logger.isDebugEnabled()) &#123; logger.debug("Skipping currently created advisor '" + name + "'"); &#125; &#125; else &#123; try &#123; // æ ¹æ®BeanNameå’ŒAdvisorç±»å‹ä»BeanFactoryä¸­è·å–Bean advisors.add(this.beanFactory.getBean(name, Advisor.class)); &#125; catch (BeanCreationException ex) &#123; Throwable rootCause = ex.getMostSpecificCause(); if (rootCause instanceof BeanCurrentlyInCreationException) &#123; BeanCreationException bce = (BeanCreationException) rootCause; if (this.beanFactory.isCurrentlyInCreation(bce.getBeanName())) &#123; if (logger.isDebugEnabled()) &#123; logger.debug("Skipping advisor '" + name + "' with dependency on currently created bean: " + ex.getMessage()); &#125; // Ignore: indicates a reference back to the bean we're trying to advise. // We want to find advisors other than the currently created bean itself. continue; &#125; &#125; throw ex; &#125; &#125; &#125; &#125; return advisors;&#125; findAdvisorBeansæ–¹æ³•çš„çš„ç›®çš„éå¸¸æ˜ç¡®ï¼Œå°±æ˜¯æ‰¾åˆ°å®¹å™¨ä¸­å…¨éƒ¨çš„Advisor å…ˆå°è¯•ä»ç¼“å­˜ä¸­è·å–Advisoré›†åˆ ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œåˆ™æ‰§è¡Œè·å–é€»è¾‘ è·å–åˆ°äº†æ‰€æœ‰ç±»å‹ä¸ºAdvisorçš„Beançš„åç§° æ ¹æ®è·å–åˆ°çš„BeanNameè·å–Bean ä¸ºå½“å‰BeanåŒ¹é…åˆé€‚çš„ Advisoråœ¨ä»¥ä¸Šçš„æ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†å®¹å™¨ä¸­æ‰€æœ‰çš„Advisorå¯¹è±¡é›†åˆï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†å®¹å™¨ä¸­æ‰€æœ‰å·²é…ç½®çš„AOPåˆ‡é¢ã€‚æ¥ä¸‹é‡Œçš„äº‹æƒ…å°±æ˜¯ä¸ºå½“å‰çš„ç›®æ ‡å¯¹è±¡ç­›é€‰å‡ºé€‚åˆçš„Advisoré›†åˆï¼Œç°åœ¨æˆ‘ä»¬å¼€å§‹åˆ†æAbstractAdvisorAutoProxyCreator.classçš„findAdvisorsThatCanApplyæ–¹æ³• 123456789101112protected List&lt;Advisor&gt; findAdvisorsThatCanApply( List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; beanClass, String beanName) &#123; ProxyCreationContext.setCurrentProxiedBeanName(beanName); try &#123; // è°ƒç”¨ AopUtils.findAdvisorsThatCanApply ä¸ºå½“å‰Beanç­›é€‰åˆé€‚çš„ Advisor return AopUtils.findAdvisorsThatCanApply(candidateAdvisors, beanClass); &#125; finally &#123; ProxyCreationContext.setCurrentProxiedBeanName(null); &#125;&#125; findAdvisorsThatCanApplyæ–¹æ³•é‡Œè°ƒç”¨äº†å·¥å…·ç±»AOPUtilsçš„findAdvisorsThatCanApplyæ–¹æ³• 123456789101112131415161718192021222324public static List&lt;Advisor&gt; findAdvisorsThatCanApply(List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; clazz) &#123; if (candidateAdvisors.isEmpty()) &#123; return candidateAdvisors; &#125; List&lt;Advisor&gt; eligibleAdvisors = new LinkedList&lt;Advisor&gt;(); // å…ˆæ‰¾å‡º IntroductionAdvisor ç±»å‹çš„Advisor for (Advisor candidate : candidateAdvisors) &#123; if (candidate instanceof IntroductionAdvisor &amp;&amp; canApply(candidate, clazz)) &#123; eligibleAdvisors.add(candidate); &#125; &#125; boolean hasIntroductions = !eligibleAdvisors.isEmpty(); // å†ä»ä½™ä¸‹çš„Advisorä¸­ç»§ç»­åŒ¹é… for (Advisor candidate : candidateAdvisors) &#123; if (candidate instanceof IntroductionAdvisor) &#123; // already processed continue; &#125; if (canApply(candidate, clazz, hasIntroductions)) &#123; eligibleAdvisors.add(candidate); &#125; &#125; return eligibleAdvisors;&#125; ä»¥ä¸Šä»£ç é€»è¾‘ä¼šå…ˆç­›é€‰å‡ºIntroductionAdvisorç±»å‹çš„Advisorï¼Œå†ç­›é€‰ä½™ä¸‹çš„å…¶ä»–Advisor 123public static boolean canApply(Advisor advisor, Class&lt;?&gt; targetClass) &#123; return canApply(advisor, targetClass, false);&#125; 12345678910111213public static boolean canApply(Advisor advisor, Class&lt;?&gt; targetClass, boolean hasIntroductions) &#123; if (advisor instanceof IntroductionAdvisor) &#123; return ((IntroductionAdvisor) advisor).getClassFilter().matches(targetClass); &#125; else if (advisor instanceof PointcutAdvisor) &#123; PointcutAdvisor pca = (PointcutAdvisor) advisor; return canApply(pca.getPointcut(), targetClass, hasIntroductions); &#125; else &#123; // It doesn&apos;t have a pointcut so we assume it applies. return true; &#125;&#125; 123456789101112131415161718192021222324252627282930313233343536public static boolean canApply(Pointcut pc, Class&lt;?&gt; targetClass, boolean hasIntroductions) &#123; Assert.notNull(pc, &quot;Pointcut must not be null&quot;); // å…ˆåˆ¤æ–­ç±»å‹æ˜¯å¦åŒ¹é… if (!pc.getClassFilter().matches(targetClass)) &#123; return false; &#125; // è·å–åˆ‡ç‚¹æ–¹æ³•åŒ¹é…å™¨ MethodMatcher methodMatcher = pc.getMethodMatcher(); if (methodMatcher == MethodMatcher.TRUE) &#123; // No need to iterate the methods if we&apos;re matching any method anyway... return true; &#125; IntroductionAwareMethodMatcher introductionAwareMethodMatcher = null; if (methodMatcher instanceof IntroductionAwareMethodMatcher) &#123; introductionAwareMethodMatcher = (IntroductionAwareMethodMatcher) methodMatcher; &#125; Set&lt;Class&lt;?&gt;&gt; classes = new LinkedHashSet&lt;Class&lt;?&gt;&gt;(ClassUtils.getAllInterfacesForClassAsSet(targetClass)); classes.add(targetClass); for (Class&lt;?&gt; clazz : classes) &#123; // è·å–å½“å‰ç›®æ ‡classçš„æ‰€æœ‰æ–¹æ³• Method[] methods = ReflectionUtils.getAllDeclaredMethods(clazz); for (Method method : methods) &#123; // è°ƒç”¨ methodMatcher.matches åˆ¤æ–­å½“å‰æ–¹æ³•æ˜¯å¦åŒ¹é…è¯¥åˆ‡ç‚¹ if ((introductionAwareMethodMatcher != null &amp;&amp; introductionAwareMethodMatcher.matches(method, targetClass, hasIntroductions)) || methodMatcher.matches(method, targetClass)) &#123; return true; &#125; &#125; &#125; return false;&#125; canApplyæ˜¯ç”¨äºç­›é€‰æ ¸å¿ƒæ–¹æ³•ï¼Œåœ¨ä¸ŠæœŸåˆ†æè¿æ¥ç‚¹Pointcutæ¥å£æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“PointcutæŒæœ‰ClassFilterå’ŒMethodMatcherå¯¹è±¡ï¼Œå…·ä½“çš„ç­›é€‰é€»è¾‘å°±æ˜¯ç”±å®ƒä»¬å®Œæˆçš„ï¼Œè‡³äºåœ¨å®ƒä»¬å…·ä½“çš„macthesæ–¹æ³•æ˜¯æ˜¯å¦‚ä½•å®ç°ç­›é€‰çš„ï¼Œè¿™é‡Œæˆ‘ä¹Ÿæ²¡æœ‰è¿›è¡Œè¿‡æ·±å…¥åˆ†æï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥åœ¨å…¶å®ç°ç±»AspectJExpressionPointcut.classä¸­ç»§ç»­æŸ¥çœ‹ ç”Ÿæˆä»£ç†å¯¹è±¡åœ¨ä¸Šæ–‡çš„åˆ†æç»“æŸåï¼Œæˆ‘ä»¬å·²ç»ç­›é€‰å‡ºæ¥äº†åˆé€‚çš„ Advisorï¼ŒAdvisoræŒæœ‰Advice(é€šçŸ¥)ï¼Œæ¥ä¸‹æ¥çš„æ“ä½œå°±æ˜¯æ ¹æ®æˆ‘ä»¬é…ç½®çš„Adviceä¸ºç›®æ ‡å¯¹è±¡åˆ›å»ºä»£ç†å¯¹è±¡äº† 123456789101112131415161718192021222324252627282930313233343536protected Object createProxy( Class&lt;?&gt; beanClass, String beanName, Object[] specificInterceptors, TargetSource targetSource) &#123; if (this.beanFactory instanceof ConfigurableListableBeanFactory) &#123; AutoProxyUtils.exposeTargetClass((ConfigurableListableBeanFactory) this.beanFactory, beanName, beanClass); &#125; // é¦–å…ˆåˆ›å»ºä¸€ä¸ªä»£ç†åˆ›å»ºå·¥å‚ç±»ï¼Œä¹‹åçš„æ“ä½œéƒ½æ˜¯ä¸ºæ­¤å·¥å‚é…ç½®å±æ€§ ProxyFactory proxyFactory = new ProxyFactory(); proxyFactory.copyFrom(this); // åˆ¤æ–­é…ç½®å±æ€§proxy-target-class æ˜¯å¦ç­‰äºFalse if (!proxyFactory.isProxyTargetClass()) &#123; // åˆ¤æ–­ç›®æ ‡ BeanDefinitionæ˜¯å¦é…ç½®preserveTargetClass ä¸º tureï¼Œæ˜¯çš„è¯é…ç½®CGLIBåŠ¨æ€ä»£ç† if (shouldProxyTargetClass(beanClass, beanName)) &#123; proxyFactory.setProxyTargetClass(true); &#125; else &#123; // è®¾ç½®ç›®æ ‡ç±»æ¥å£åˆ°proxyFactoryï¼Œå¦‚æœæ²¡æœ‰å®ç°æ¥å£åˆ™ä½¿ç”¨CGLIBä»£ç† evaluateProxyInterfaces(beanClass, proxyFactory); &#125; &#125; Advisor[] advisors = buildAdvisors(beanName, specificInterceptors); // proxyFactory è®¾ç½® advisors proxyFactory.addAdvisors(advisors); // è®¾ç½®ç›®æ ‡å¯¹è±¡èµ„æº proxyFactory.setTargetSource(targetSource); customizeProxyFactory(proxyFactory); proxyFactory.setFrozen(this.freezeProxy); if (advisorsPreFiltered()) &#123; proxyFactory.setPreFiltered(true); &#125; // åˆ›å»ºä»£ç† return proxyFactory.getProxy(getProxyClassLoader()); åˆ›å»ºä»£ç†å¯¹è±¡å‰ï¼Œä¼šæ–°å»ºä¸€ä¸ªä»£ç†å·¥å‚åˆ›å»ºç±»ï¼Œå¹¶ä¸ºæ­¤å·¥å‚ç±»é…ç½®ç›¸å…³å±æ€§ï¼Œä¾‹å¦‚proxy-target-classçš„é…ç½®ï¼Œè™½ç„¶é»˜è®¤é…ç½®æ˜¯falseä¼šä½¿ç”¨JDKåŠ¨æ€ä»£ç†ï¼Œä½†å¦‚æœæ²¡æœ‰å®ç°æ¥å£ï¼Œä¹Ÿä¼šè‡ªåŠ¨è®¾ç½®proxy-target-classä¸ºtrueä½¿ç”¨CGLIBåˆ›å»ºä»£ç†å¯¹è±¡ å®ŒæˆProxyFactoryçš„é…ç½®ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡å®ƒåˆ›å»ºä»£ç†å¯¹è±¡äº†123456/** * åˆ›å»ºä»£ç†å¯¹è±¡ */public Object getProxy(ClassLoader classLoader) &#123; return createAopProxy().getProxy(classLoader);&#125; è°ƒç”¨çˆ¶ç±»ProxyCreatorSupportçš„createAopProxyæ–¹æ³•ï¼Œè·å–åˆ°ä»£ç†åˆ›å»ºå·¥å‚ï¼Œå·¥å‚ç±»(DefaultAopProxyFactory)æ˜¯åœ¨çˆ¶ç±»çš„æ„é€ æ–¹æ³•ä¸­åˆ›å»ºçš„ 1234567protected final synchronized AopProxy createAopProxy() &#123; if (!this.active) &#123; activate(); &#125; // è·å–ä»£ç†åˆ›å»ºå·¥å‚ç±» ï¼ˆDefaultAopProxyFactory.classï¼‰åˆ›å»ºä»£ç†å¯¹è±¡ return getAopProxyFactory().createAopProxy(this);&#125; æœ€ç»ˆåœ¨DefaultAopProxyFactoryå·¥å‚ç±»createAopProxyä¸­åˆ›å»ºä»£ç†å¯¹è±¡ 12345678910111213141516171819public AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException &#123; // è¿™é‡Œä¸»è¦æ˜¯åˆ¤æ–­ proxy-target-class å±æ€§æ˜¯å¦ä¸ºtrueã€‚é»˜è®¤æ˜¯false if (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) &#123; Class&lt;?&gt; targetClass = config.getTargetClass(); if (targetClass == null) &#123; throw new AopConfigException(&quot;TargetSource cannot determine target class: &quot; + &quot;Either an interface or a target is required for proxy creation.&quot;); &#125; if (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) &#123; return new JdkDynamicAopProxy(config); &#125; // ä½¿ç”¨CGLIBåŠ¨æ€ä»£ç† return new ObjenesisCglibAopProxy(config); &#125; else &#123; // é»˜è®¤ä½¿ç”¨JDKåŠ¨æ€æ‰“ç† return new JdkDynamicAopProxy(config); &#125;&#125; æœ€ç»ˆçš„ä»£ç†çš„åˆ›å»ºæ˜¯åœ¨ObjenesisCglibAopProxyæˆ–JdkDynamicAopProxyä¸­å®Œæˆçš„ï¼Œè‡³äºæ›´å…·ä½“çš„åˆ›å»ºé€»è¾‘ï¼Œå› ä¸ºè¿™ä¸€ç³»åˆ—çš„æºç åˆ†æåªæ˜¯ä¸ºäº†èƒ½å¤Ÿå¯¹AOPçš„æ•´ä½“é€»è¾‘æœ‰æ¸…æ™°çš„è®¤è¯†ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸åšæ›´è¯¦ç»†çš„åˆ†æäº†ã€‚ å°¾è¨€æœ¬ç¯‡æ–‡ç« åˆ†æäº†AOPä»£ç†åˆ›å»ºçš„æ•´ä¸ªè¿‡ç¨‹ï¼Œçºµè§‚æ•´ç¯‡æ–‡ç« ï¼Œç¯‡å¹…æœ‰é™ï¼Œå…¶ä¸­è¿˜æœ‰å¾ˆå¤šçš„ç‚¹æ²¡æœ‰è¯¦ç»†å±•å¼€åˆ†æï¼Œåªæ˜¯ç²—ç•¥çš„åˆ†æäº†AOPä»£ç†çš„åˆ›å»ºè¿‡ç¨‹ï¼Œæƒ­æ„§ â€¦ ã€‚åˆ†ææœ‰è¯¯çš„åœ°æ–¹ï¼Œå¸Œæœ›å¤§å®¶å¯ä»¥æŒ‡å‡ºã€‚]]></content>
      <categories>
        <category>javaæ¡†æ¶</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring AOP æºç è§£æäºŒ ï¼ˆAOPæ ¸å¿ƒæ¦‚å¿µåŠæ¥å£åˆ†æï¼‰]]></title>
    <url>%2F2018%2F12%2F10%2FSpring-AOP-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C-%EF%BC%88AOP%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E5%8F%8A%E6%8E%A5%E5%8F%A3%E5%88%86%E6%9E%90%EF%BC%89%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ä¸ŠæœŸå¯¹Spring AOPçš„é…ç½®å…¥å£åšäº†ä¸€ä¸ªå¾ˆç®€å•çš„æºç è§£è¯»ï¼Œç›¸å½“äºä¸€é“å¼€èƒƒèœï¼Œæœ‰äº›æ¦‚å¿µä¹Ÿå¹¶æ²¡æœ‰ç»†è¯´ã€‚è¿™æœŸæˆ‘ä»¬ä¸»è¦æ¥ç†ä¸€ä¸‹AOPçš„æ•´ä½“æ¦‚å¿µï¼Œä»¥åŠç›¸å…³çš„æ¥å£åˆ†æ AOPæ¦‚å¿µé¢å‘åˆ‡é¢ç¼–ç¨‹AOPå…¶å®æ˜¯å¯¹OOPç¼–ç¨‹æ–¹å¼çš„ä¸€ç§è¡¥å……ï¼ŒOOPä¸­æ¨¡å—åŒ–çš„å…³é”®å•å…ƒæ˜¯ç±»ï¼Œè€Œåœ¨AOPä¸­ï¼Œæ¨¡å—åŒ–å•å…ƒåˆ™æ˜¯Aspectï¼Œæˆ‘ä»¬åˆæŠŠå®ƒå«åšåˆ‡é¢ã€‚å¯¹äºSpring IOCæ¥è¯´ï¼ŒSpring AOPæ˜¯å¯¹IOCçš„å¼ºæœ‰åŠ›å¢å¼ºã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬å°†å¯¹AOPçš„æ ¸å¿ƒæ¥å£åšè¯¦ç»†çš„åˆ†æ AOPæ ¸å¿ƒæ¥å£Pointcut åˆ‡ç‚¹åˆ‡å…¥ç‚¹ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æˆ‘ä»¬è¦åˆ‡å…¥æŸä¸ªç‚¹çš„å…·ä½“ä½ç½®ï¼Œå¯¹äºåˆ‡å…¥ç‚¹çš„ä½ç½®é€‰æ‹©ï¼Œæˆ‘ä»¬å¸¸ç”¨aspectè¡¨è¾¾å¼æ¥è¿›è¡Œå®šä½ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹Pointcutæ¥å£ï¼Œçœ‹çœ‹å®ƒå®šä¹‰äº†å“ªäº›ä¸œè¥¿ 1234567891011121314151617public interface Pointcut &#123; /** * è¿”å›ä¸€ä¸ªç±»å‹è¿‡æ»¤å™¨ * @return the ClassFilter (never &#123;@code null&#125;) */ ClassFilter getClassFilter(); /** * è¿”å›ä¸€ä¸ªæ–¹æ³•åŒ¹é…å™¨ * @return the MethodMatcher (never &#123;@code null&#125;) */ MethodMatcher getMethodMatcher(); Pointcut TRUE = TruePointcut.INSTANCE;&#125; å¯ä»¥çœ‹åˆ°Pointcutæ¥å£å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªç”¨äºè¿”å›ä¸€ä¸ªç±»å‹è¿‡æ»¤å™¨ï¼Œä¸€ä¸ªè¿”å›äº†ä¸€ä¸ªæ–¹æ³•é€‰æ‹©å™¨ï¼Œæˆ‘ä»¬å¯ä»¥å†å…·ä½“çš„çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæ¥å£çš„å†…å®¹ 12345678910111213141516171819202122232425262728293031public interface ClassFilter &#123; /** * åˆ¤æ–­åˆ‡å…¥ç‚¹äºç»™å®šçš„æ¥å£æˆ–ç›®æ ‡ç±»æ˜¯å¦ç±»å‹åŒ¹é… */ boolean matches(Class&lt;?&gt; clazz); ClassFilter TRUE = TrueClassFilter.INSTANCE;&#125;public interface MethodMatcher &#123; /** * æ£€æŸ¥æ˜¯å¦æœ‰æ­¤æ–¹æ³•çš„é™æ€åŒ¹é… */ boolean matches(Method method, Class&lt;?&gt; targetClass); /** * æ˜¯å¦è¿è¡Œæ—¶ */ boolean isRuntime(); /** * æ£€æŸ¥æ˜¯å¦æœ‰æ­¤æ–¹æ³•çš„è¿è¡Œæ—¶(åŠ¨æ€)åŒ¹é… */ boolean matches(Method method, Class&lt;?&gt; targetClass, Object... args); MethodMatcher TRUE = TrueMethodMatcher.INSTANCE;&#125; å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢ä¸¤ä¸ªæ¥å£çš„æ ¸å¿ƒéƒ½æ˜¯matchesæ–¹æ³•ï¼Œéƒ½æ˜¯ç”¨äºåˆ¤æ–­ç›®æ ‡ç±»å‹æˆ–ç›®æ ‡æ–¹æ³•ä¸æ­¤åˆ‡å…¥ç‚¹æ˜¯å¦åŒ¹é…ã€‚åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æœ‰æåˆ°ä¸€ä¸ªPointcutæ¥å£çš„å…·ä½“å®ç°ï¼Œï¼ˆAspectJExpressionPointcut.classï¼‰ï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨çš„Pointcutæ¥å£å®ç°ï¼Œé‡Œé¢å°è£…äº†å¯¹aspectè¡¨è¾¾å¼ç”¨äºåŒ¹é…åˆ‡å…¥ç‚¹æ–¹æ³•çš„å…·ä½“å®ç° Advice é€šçŸ¥Advice é€šçŸ¥ï¼Œç¿»è¯‘æˆä¸­æ–‡æ˜¯å»ºè®®çš„æ„æ€ï¼Œåœ¨ä¸Šé¢æˆ‘ä»¬çŸ¥é“äº†pointcutæ˜¯ç”¨æ¥é€‰æ‹©åˆ‡å…¥ç‚¹çš„ï¼Œé‚£é€‰å®šäº†åˆ‡å…¥ç‚¹ä¹‹åè‡ªç„¶å°±æ˜¯è¦æ‰§è¡Œå…·ä½“ç»‡å…¥çš„AOPé€»è¾‘ï¼Œå¹¶ä¸”è¿˜è¦åœ¨ä¸€ä¸ªåˆé€‚çš„ä½ç½®å»æ‰§è¡Œï¼Œè€Œè¿™ä¸ªåˆé€‚çš„ä½ç½®å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„åœ¨ç›®æ ‡æ–¹æ³•å‰ ç›®æ ‡æ–¹æ³•åæˆ–åˆ™ç¯ç»•é€šçŸ¥æ‰§è¡Œï¼Œå¥½äº†ï¼Œè¿˜æ˜¯è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹Adviceæ¥å£ï¼Œçœ‹çœ‹Springä¸ºæˆ‘ä»¬å®šä¹‰äº†å“ªå‡ ç§é€šçŸ¥ç±»å‹ Advice æ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œå…·ä½“çš„ç±»å‹åœ¨å®ç°ä¸­123public interface Advice &#123;&#125; ä¸Šç¯‡æ–‡ç« æœ‰æåˆ°Adviceçš„å…·ä½“å®ç°ç±»å‹ï¼Œè¿™é‡Œæˆ‘å°±ç›´æ¥æŠŠæ¯ç§ç±»å‹é€šçŸ¥å¯¹åº”çš„å®ç°ç±»åˆ—å‡ºæ¥äº† å‰ç½®é€šçŸ¥ AspectJMethodBeforeAdvice.class åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œå‰æ‰§è¡Œ åç½®é€šçŸ¥ AspectJAfterAdvice.class åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œåæ‰§è¡Œï¼ˆæ— è®ºæ˜¯å¦æŠ›å¼‚å¸¸éƒ½ä¼šæ‰§è¡Œï¼‰ ç¯ç»•é€šçŸ¥ AspectJAroundAdvice.class åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œå‰åæ‰§è¡Œ å¼‚å¸¸é€šçŸ¥ AspectJAfterThrowingAdvice.class ç›®æ ‡æ–¹æ³•æ‰§è¡Œå¼‚å¸¸æ—¶æ‰§è¡Œ åç½®æ­£å¸¸è¿”å›é€šçŸ¥ AspectJAfterReturningAdvice.class ç›®æ ‡æ–¹æ³•æ­£å¸¸è¿”å›ç»“æœåæ‰§è¡Œ Aspect åˆ‡é¢Aspectåˆ‡é¢ï¼Œä½†çœ‹è¿™ä¸ªå•è¯å…¶å®ä¸å¥½ç†è§£ï¼Œä½†æ˜¯å½“æˆ‘ä»¬çŸ¥é“äº†Pointcutå’ŒAdviceçš„ä½œç”¨ä¹‹åï¼Œç†è§£åˆ‡é¢å°±ä¼šæ¸…æ™°å¾ˆå¤šã€‚ç®€å•çš„ç†è§£åˆ‡é¢å°±æ˜¯Pointcutå’ŒAdviceä¸¤è€…çš„ç»“åˆï¼ŒæŠŠåˆ‡å…¥ç‚¹å’Œé€šçŸ¥è¿æ¥èµ·æ¥å°±ç»„æˆäº†ä¸€ä¸ªåˆ‡é¢ã€‚è€Œåœ¨Springä»£ç ä¸­çš„ä½“ç°ï¼Œåˆ‡é¢æŒ‡çš„å°±æ˜¯Advisoræ¥å£åŠå…¶å®ç°ï¼Œæ¥çœ‹ä¸€ä¸‹Advisoræ¥å£çš„å†…å®¹ 12345public interface Advisor &#123; Advice getAdvice(); boolean isPerInstance();&#125; Advisoræ¥å£getAdvice()æ–¹æ³•è¿”å›äº†è¯¥åˆ‡é¢å¯¹åº”çš„é€šçŸ¥ 12345678public interface PointcutAdvisor extends Advisor &#123; /** * Get the Pointcut that drives this advisor. */ Pointcut getPointcut();&#125; PointcutAdvisoræ¥å£ç»§æ‰¿äº†Advisoræ¥å£ï¼Œå¹¶ä¸”æ–°å¢äº†getPointcut()`æ–¹æ³•ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£ï¼Œå°±æŠŠåˆ‡å…¥ç‚¹å’Œé€šçŸ¥ä¸¤è€…è¿æ¥äº†èµ·æ¥ï¼Œå®Œæˆäº†åˆ‡é¢çš„é…ç½® Weaving ç»‡å…¥å½“å®Œæˆäº†ä»¥ä¸Šå·¥ä½œä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è¯´æ˜¯ä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ ä¸œé£ï¼Œå‰©ä¸‹çš„äº‹æƒ…ï¼Œå°±æ˜¯æŠŠå…·ä½“çš„åˆ‡é¢é€»è¾‘ç»‡å…¥åˆ°æˆ‘ä»¬çš„åˆ‡å…¥ç‚¹ä¸­å»ï¼Œé‚£ä¹ˆSpringå¯¹äºAOPä»£ç†é€»è¾‘ç»‡å…¥æ˜¯æ€ä¹ˆåšçš„ï¼Œåˆæ˜¯åœ¨ä½•æ—¶åšçš„å‘¢ï¼Ÿ è¿™æ—¶å€™å°±æ˜¯Spring IOC å®¹å™¨å¤§å±•èº«æ‰‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨ä¹‹å‰åˆ†æSpring IOCå®¹å™¨çš„æ—¶å€™æœ‰æåˆ°è¿‡æ‰©å±•ç‚¹BeanPostProcessoræ¥å£ï¼Œä¸Šç¯‡æ–‡ç« æˆ‘ä»¬ä¹Ÿæœ‰æåˆ°ä¸€ä¸ªä»£ç†åˆ›å»ºçš„æ ¸å¿ƒç±»AspectJAwareAdvisorAutoProxyCreatorï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„ç»“æ„ é€šè¿‡æŸ¥çœ‹è¯¥ç±»çš„æ¥å£ï¼Œå¯ä»¥çŸ¥é“AspectJAwareAdvisorAutoProxyCreatoræ˜¯BeanPostProcessoræ¥å£çš„å…·ä½“å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬çŸ¥é“ä»£ç†ç±»åˆ›å»ºå¿…å®šæ˜¯åœ¨Beanåˆ›å»ºå‰åè¢«åˆ›å»ºçš„ã€‚å…·ä½“çš„åˆ›å»ºé€»è¾‘æ˜¯åœ¨Beanå®Œæˆåˆå§‹åŒ–ï¼Œæ‰§è¡ŒBeanPostProcessoræ¥å£çš„postProcessAfterInitializationæ–¹æ³•æ—¶æ‰§è¡Œ æ€»ç»“æœ¬ç¯‡æ–‡ç« æˆ‘ä»¬ä¸»è¦ä»æ¥å£å±‚é¢åˆ†æäº†AOPçš„å®ç°ï¼Œå¹¶æ²¡æœ‰æ¶‰åŠåˆ°å¾ˆå¤šçš„AOPæºç ï¼Œä½†æ˜¯è¿™äº›åŸºæœ¬çš„æ¥å£æ˜¯AOPå®ç°çš„æ ¸å¿ƒï¼Œç†è§£è¿™äº›å¯¹äºAOPæºç åˆ†ææœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚ä¸‹ç¯‡æ–‡ç« æˆ‘å°†ä¼šå¯¹ä»£ç†çš„åˆ›å»º(AspectJAwareAdvisorAutoProxyCreator.class)åšåˆ†æ]]></content>
      <categories>
        <category>javaæ¡†æ¶</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring AOP æºç è§£æä¸€ ï¼ˆAOPå…¥å£æµ…è°ˆï¼‰]]></title>
    <url>%2F2018%2F11%2F30%2FSpring-AOP-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%80-%EF%BC%88AOP%E5%85%A5%E5%8F%A3%E6%B5%85%E8%B0%88%EF%BC%89%2F</url>
    <content type="text"><![CDATA[å¼•è¨€åœ¨è¿›è¡Œaopçš„æºç è§£æä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“Spring AOPæ˜¯æ€ä¹ˆç”¨çš„ï¼Œåªæœ‰çŸ¥é“æ€ä¹ˆç”¨çš„ï¼Œæˆ‘ä»¬æ‰èƒ½æ›´å¥½çš„ç†è§£aopï¼Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥è§£æ ä½¿ç”¨AOPå¥½äº†ï¼ŒåºŸè¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬ç›´æ¥åŠ¨æ‰‹æ¥ç”¨ä¸€ä¸‹springçš„AOPå®ç° é¦–å…ˆæ–°å»ºä¸€ä¸ªMyPointCutæ¥å£ï¼Œå¹¶ä¸”å®ç°å®ƒ 12345678910/** * MyPointCut * * @author wangjn * @date 2018/12/7 */public interface MyPointCut &#123; void sayHello();&#125; 12345678910111213/** * MyPointCutImpl * * @author wangjn * @date 2018/12/10 */public class MyPointCutImpl implements MyPointCut &#123; @Override public void sayHello() &#123; System.out.println("hello world"); &#125;&#125; æ–°å»ºä¸€ä¸ªMyAspectæ¥å£ï¼Œæ¥å£é‡Œçš„æ–¹æ³•æ˜¯æˆ‘ä»¬ä¹‹åè¦åˆ‡å…¥çš„aopé€»è¾‘æ–¹æ³• 12345678/** * MyAspect */public interface MyAspect &#123; void logBefore(); void logAfter();&#125; 123456789101112131415/** * MyAspectImpl */public class MyAspectImpl implements MyAspect &#123; @Override public void logBefore() &#123; System.out.println(&quot;log before&quot;); &#125; @Override public void logAfter() &#123; System.out.println(&quot;log after&quot;); &#125;&#125; spring xml é…ç½® 12345678910111213141516&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt; &lt;bean id=&quot;myPointCut&quot; class=&quot;com.wangjn.demo.impl.MyPointCutImpl&quot;&gt;&lt;/bean&gt; &lt;bean id=&quot;aspectTest&quot; class=&quot;com.wangjn.demo.MyAspectImpl&quot;/&gt; &lt;aop:config&gt; &lt;aop:aspect id=&quot;log&quot; ref=&quot;aspectTest&quot;&gt; &lt;aop:pointcut id=&quot;addAllMethod&quot; expression=&quot;execution(* com.wangjn.demo.MyPointCut.*(..))&quot; /&gt; &lt;aop:before method=&quot;logBefore&quot; pointcut-ref=&quot;addAllMethod&quot; /&gt; &lt;aop:after method=&quot;logAfter&quot; pointcut-ref=&quot;addAllMethod&quot; /&gt; &lt;/aop:aspect&gt; &lt;/aop:config&gt;&lt;/beans&gt; å†™ä¸ªmainæ–¹æ³• 12345678910111213/** * Start */public class Start &#123; public static void main(String[] args) throws IOException &#123; ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(new String[]&#123;&quot;spring.xml&quot;&#125;); context.start(); // å–å¾—bean myPointCut MyPointCut myPointCut = (MyPointCut)context.getBean(&quot;myPointCut&quot;); myPointCut.sayHello(); &#125;&#125; æ‰§è¡Œç»“æœè¾“å‡ºï¼Œå¯çŸ¥myPointCutçš„æ–¹æ¡ˆå‰åéƒ½é¢å¤–æ‰§è¡Œäº†aopè¦ç»‡å…¥çš„é€»è¾‘ï¼Œè¿™å°±æ˜¯aopçš„ç¥å¥‡ä¹‹å¤„ï¼Œå¯ä»¥åœ¨åŸä»£ç æ¯«æ— æ„ŸçŸ¥çš„æƒ…å†µä¸‹æ‰§è¡Œé¢å¤–é€»è¾‘ 123log beforehello worldlog after é€šè¿‡ä¸Šé¢ä»£ç ç®€å•çš„æ¼”ç¤ºï¼Œæˆ‘ä»¬å¤§è‡´çŸ¥é“äº†aopæ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼Œä¸è¿‡æ˜¾ç„¶çŸ¥é“æ€ä¹ˆç”¨å¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€è¦è¿½æ±‚çš„ï¼Œæ¥ä¸‹æ¥å°±æˆ‘ä»¬ä»aopçš„æºç å…¥å£ä¸€æ­¥ä¸€æ­¥çš„è§£æå®ƒçš„å®ç°åŸç† AOPæºç å…¥å£è¦æƒ³çŸ¥é“aopçš„å®ç°åŸç†ï¼Œæˆ‘ä»¬é¦–å…ˆè¦äº†è§£çš„å°±æ˜¯spinng iocå®¹å™¨æ˜¯æ€ä¹ˆè§£ææˆ‘ä»¬çš„aopé…ç½®çš„ï¼Œè¿™é‡Œæˆ‘ä»¬æš‚ä¸”åªçœ‹xmlå½¢å¼çš„é…ç½®è§£æ å¥½äº†ï¼Œå›åˆ°ä¸Šé¢çš„springé…ç½®æ–‡ä»¶1234567&lt;aop:config&gt; &lt;aop:aspect id=&quot;log&quot; ref=&quot;aspectTest&quot;&gt; &lt;aop:pointcut id=&quot;addAllMethod&quot; expression=&quot;execution(* com.wangjn.demo.MyPointCut.*(..))&quot; /&gt; &lt;aop:before method=&quot;logBefore&quot; pointcut-ref=&quot;addAllMethod&quot; /&gt; &lt;aop:after method=&quot;logAfter&quot; pointcut-ref=&quot;addAllMethod&quot; /&gt; &lt;/aop:aspect&gt; &lt;/aop:config&gt; å¯ä»¥çœ‹åˆ°éƒ½æ˜¯spring aopçš„è‡ªå®šä¹‰æ ‡ç­¾ï¼Œåœ¨ä¹‹å‰è§£æspring iocæºç çš„æ—¶å€™æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œspringæ˜¯æ”¯æŒè‡ªå®šä¹‰çš„æ ‡ç­¾è§£æçš„ï¼Œè‡ªå®šä¹‰æ ‡ç­¾çš„å…¥å£æ–‡ä»¶åœ¨META-INF/spring.handlersä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°spring aopjaråŒ…ä¸‹çš„è¿™ä¸ªç›®å½•ï¼Œæ‰“å¼€è¿™ä¸ªæ–‡ä»¶ 1http\://www.springframework.org/schema/aop=org.springframework.aop.config.AopNamespaceHandler å¯ä»¥çœ‹åˆ°è¿™é‡Œé…ç½®äº†ä¸€ä¸ªaopå‘½åç©ºé—´çš„è§£æå™¨ org.springframework.aop.config.AopNamespaceHandlerï¼Œç°åœ¨æˆ‘ä»¬å°±ä»è¿™ä¸ªå…¥å£æ–‡ä»¶æ¥è¿›è¡Œæºç åˆ†æ AopNamespaceHandler1234567891011121314151617181920public class AopNamespaceHandler extends NamespaceHandlerSupport &#123; /** * Register the &#123;@link BeanDefinitionParser BeanDefinitionParsers&#125; for the * &apos;&#123;@code config&#125;&apos;, &apos;&#123;@code spring-configured&#125;&apos;, &apos;&#123;@code aspectj-autoproxy&#125;&apos; * and &apos;&#123;@code scoped-proxy&#125;&apos; tags. */ @Override public void init() &#123; // In 2.0 XSD as well as in 2.1 XSD. registerBeanDefinitionParser(&quot;config&quot;, new ConfigBeanDefinitionParser()); // æ”¯æŒ @AspectJ å£°æ˜å¼é…ç½® registerBeanDefinitionParser(&quot;aspectj-autoproxy&quot;, new AspectJAutoProxyBeanDefinitionParser()); registerBeanDefinitionDecorator(&quot;scoped-proxy&quot;, new ScopedProxyBeanDefinitionDecorator()); // Only in 2.0 XSD: moved to context namespace as of 2.1 registerBeanDefinitionParser(&quot;spring-configured&quot;, new SpringConfiguredBeanDefinitionParser()); &#125;&#125; è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯¹configå±æ€§çš„è§£ææ˜¯ç”±ConfigBeanDefinitionParserå®Œæˆçš„ã€‚ConfigBeanDefinitionParseræ˜¯BeanDefinitionParseræ¥å£çš„å®ç°ï¼Œå…¶ä¸­çš„parseæ–¹æ³•å°è£…äº†å¯¹&lt;aop:config&gt;å±æ€§æ ‡ç­¾çš„è§£æé€»è¾‘ ConfigBeanDefinitionParserçš„parseæ–¹æ³•123456789101112131415161718192021222324252627public BeanDefinition parse(Element element, ParserContext parserContext) &#123; CompositeComponentDefinition compositeDef = new CompositeComponentDefinition(element.getTagName(), parserContext.extractSource(element)); parserContext.pushContainingComponent(compositeDef); configureAutoProxyCreator(parserContext, element); List&lt;Element&gt; childElts = DomUtils.getChildElements(element); for (Element elt: childElts) &#123; String localName = parserContext.getDelegate().getLocalName(elt); // pointCutæ ‡ç­¾ if (POINTCUT.equals(localName)) &#123; parsePointcut(elt, parserContext); &#125; // advisoræ ‡ç­¾ else if (ADVISOR.equals(localName)) &#123; parseAdvisor(elt, parserContext); &#125; // aspectæ ‡ç­¾ else if (ASPECT.equals(localName)) &#123; parseAspect(elt, parserContext); &#125; &#125; parserContext.popAndRegisterContainingComponent(); return null;&#125; å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°ï¼Œè¿™é‡Œåˆ†åˆ«å¯¹pointcut,advisor,aspectä¸‰ç§æ ‡ç­¾è¿›è¡Œè§£æ configureAutoProxyCreator(parserContext, element)è¿™é‡Œé…ç½®äº†ä»£ç†åˆ›å»ºç±»ï¼Œè°ƒç”¨äº†AopNamespaceUtils.registerAspectJAutoProxyCreatorIfNecessaryæ–¹æ³•å®Œæˆé…ç½® 123private void configureAutoProxyCreator(ParserContext parserContext, Element element) &#123; AopNamespaceUtils.registerAspectJAutoProxyCreatorIfNecessary(parserContext, element);&#125; æˆ‘ä»¬æ¥çœ‹ä¸‹ AopNamespaceUtils.registerAspectJAutoProxyCreatorIfNecessaryçš„å®ç° 1234567891011public static void registerAspectJAutoProxyCreatorIfNecessary( ParserContext parserContext, Element sourceElement) &#123; // è·å–ä»£ç†åˆ›å»ºç±» AspectJAwareAdvisorAutoProxyCreatorå¹¶å‘½åä¸ºorg.springframework.aop.config.internalAutoProxyCreator BeanDefinition beanDefinition = AopConfigUtils.registerAspectJAutoProxyCreatorIfNecessary( parserContext.getRegistry(), parserContext.extractSource(sourceElement)); // åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ CGLIB åˆ›å»ºä»£ç†ï¼ŒæŒ‡å®šproxy-target-class=trueåˆ™ä½¿ç”¨CGLIBï¼Œå¦åˆ™ä½¿ç”¨JDKåŠ¨æ€ä»£ç† useClassProxyingIfNecessary(parserContext.getRegistry(), sourceElement); // å¾€ spring ioc å®¹å™¨æ³¨å†ŒAspectJAwareAdvisorAutoProxyCreatorä»£ç†åˆ›å»ºå™¨ registerComponentIfNecessary(beanDefinition, parserContext);&#125; å¯ä»¥çœ‹åˆ°è¿™æ®µä»£ç ä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ… æ³¨å†Œä»£ç†åˆ›å»ºå™¨ AspectJAwareAdvisorAutoProxyCreatorï¼Œè¿™ä¸ªç±»å¾ˆé‡è¦ï¼Œæ˜¯ aopçš„æ ¸å¿ƒå®ç°ç±» æŒ‡å®šåˆ›å»ºä»£ç†çš„æ–¹å¼ï¼Œå…¶ä¸­å¦‚æœ&lt;aop:config&gt;èŠ‚ç‚¹é…ç½®äº†proxy-target-class=trueï¼Œåˆ™ä½¿ç”¨CGLIBåˆ›å»ºä»£ç†ï¼Œå¦åˆ™é»˜è®¤ä½¿ç”¨JDK åŠ¨æ€ä»£ç† parsePointcutè§£æaopçš„åˆ‡å…¥ç‚¹é…ç½®ï¼Œå¯¹åº” &lt;aop:pointcut&gt;æ ‡ç­¾12345678910111213141516171819202122232425262728293031323334private AbstractBeanDefinition parsePointcut(Element pointcutElement, ParserContext parserContext) &#123; // è·å–æˆ‘ä»¬é…ç½®çš„ pointCut åˆ‡å…¥ç‚¹ id String id = pointcutElement.getAttribute(ID); // è·å–è¦åˆ‡å…¥çš„ expression è¡¨è¾¾å¼ String expression = pointcutElement.getAttribute(EXPRESSION); AbstractBeanDefinition pointcutDefinition = null; try &#123; // è®°å½•å½“å‰å¤„ç†èŠ‚ç‚¹ this.parseState.push(new PointcutEntry(id)); // åˆ›å»º AspectJExpressionPointcut ç±»å‹çš„ beanDefinitionï¼Œå¹¶ä¸”æŠŠexpressionå±æ€§èµ‹ç»™æ­¤bean pointcutDefinition = createPointcutDefinition(expression);// è®¾ç½®æºæ•°æ® pointcutDefinition.setSource(parserContext.extractSource(pointcutElement)); // è®¾ç½® beançš„idåç§° String pointcutBeanName = id; if (StringUtils.hasText(pointcutBeanName)) &#123; // æ³¨å†ŒbeanDefinution è‡³springå®¹å™¨ parserContext.getRegistry().registerBeanDefinition(pointcutBeanName, pointcutDefinition); &#125; else &#123; pointcutBeanName = parserContext.getReaderContext().registerWithGeneratedName(pointcutDefinition); &#125; parserContext.registerComponent( new PointcutComponentDefinition(pointcutBeanName, pointcutDefinition, expression)); &#125; finally &#123; this.parseState.pop(); &#125; return pointcutDefinition;&#125; è¿™é‡Œä¸»è¦æ˜¯é…ç½®äº†aopåˆ‡å…¥ç‚¹çš„bean AspectJExpressionPointcut parseAspect1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859private void parseAspect(Element aspectElement, ParserContext parserContext) &#123; // è·å–åˆ‡é¢id String aspectId = aspectElement.getAttribute(ID); // è·å–åˆ‡é¢è¦æ‰§è¡Œçš„å…·ä½“é€»è¾‘ç±» è¿™ä¸ªæ˜¯å¿…é¡»è®¾ç½®çš„å±æ€§ String aspectName = aspectElement.getAttribute(REF); try &#123; this.parseState.push(new AspectEntry(aspectId, aspectName)); List&lt;BeanDefinition&gt; beanDefinitions = new ArrayList&lt;BeanDefinition&gt;(); List&lt;BeanReference&gt; beanReferences = new ArrayList&lt;BeanReference&gt;(); List&lt;Element&gt; declareParents = DomUtils.getChildElementsByTagName(aspectElement, DECLARE_PARENTS); for (int i = METHOD_INDEX; i &lt; declareParents.size(); i++) &#123; Element declareParentsElement = declareParents.get(i); beanDefinitions.add(parseDeclareParents(declareParentsElement, parserContext)); &#125; // We have to parse &quot;advice&quot; and all the advice kinds in one loop, to get the // ordering semantics right. // è§£æadviceæ ‡ç­¾ NodeList nodeList = aspectElement.getChildNodes(); boolean adviceFoundAlready = false; for (int i = 0; i &lt; nodeList.getLength(); i++) &#123; Node node = nodeList.item(i); // åˆ¤æ–­ advice çš„ç±»å‹æ˜¯å¦æ˜¯é™å®šçš„å‡ ç§ï¼ˆafter before aroundï¼‰ if (isAdviceNode(node, parserContext)) &#123; if (!adviceFoundAlready) &#123; adviceFoundAlready = true; // å¦‚æœæ²¡æœ‰é…ç½® ref å±æ€§ï¼ŒæŠ›å‡ºå¼‚å¸¸ if (!StringUtils.hasText(aspectName)) &#123; parserContext.getReaderContext().error( &quot;&lt;aspect&gt; tag needs aspect bean reference via &apos;ref&apos; attribute when declaring advices.&quot;, aspectElement, this.parseState.snapshot()); return; &#125; beanReferences.add(new RuntimeBeanReference(aspectName)); &#125; // å¼€å§‹è§£æadviceèŠ‚ç‚¹ AbstractBeanDefinition advisorDefinition = parseAdvice( aspectName, i, aspectElement, (Element) node, parserContext, beanDefinitions, beanReferences); beanDefinitions.add(advisorDefinition); &#125; &#125; AspectComponentDefinition aspectComponentDefinition = createAspectComponentDefinition( aspectElement, aspectId, beanDefinitions, beanReferences, parserContext); parserContext.pushContainingComponent(aspectComponentDefinition); // è§£æ aspect æ ‡ç­¾ä¸­çš„ pointcut List&lt;Element&gt; pointcuts = DomUtils.getChildElementsByTagName(aspectElement, POINTCUT); for (Element pointcutElement : pointcuts) &#123; parsePointcut(pointcutElement, parserContext); &#125; parserContext.popAndRegisterContainingComponent(); &#125; finally &#123; this.parseState.pop(); &#125;&#125; parseAdviceparseAdviceè¿™æ®µä»£ç çš„ä¸»è¦é€»è¾‘å…¶å®å°±æ˜¯è§£æ adviceæ ‡ç­¾ï¼Œå¹¶æœ€ç»ˆåŒ…è£…æˆadvisorã€‚advisorå…¶å®ç›¸å½“äºæ•´åˆäº†advice é€šçŸ¥å’Œpointcut åˆ‡ç‚¹ï¼Œç›¸å½“äºé€šè¿‡ advisoræŠŠåˆ‡ç‚¹å’Œè¦æ‰§è¡Œçš„åˆ‡é¢é€»è¾‘è¿æ¥äº†èµ·æ¥ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546private AbstractBeanDefinition parseAdvice( String aspectName, int order, Element aspectElement, Element adviceElement, ParserContext parserContext, List&lt;BeanDefinition&gt; beanDefinitions, List&lt;BeanReference&gt; beanReferences) &#123; try &#123; this.parseState.push(new AdviceEntry(parserContext.getDelegate().getLocalName(adviceElement))); // create the method factory bean // åˆ›å»ºåˆ‡é¢å¢å¼ºæ–¹æ³•å¯¹åº”çš„ methodDefinitionï¼Œå¹¶è®¾ç½® methodName targetBeanNameå±æ€§ RootBeanDefinition methodDefinition = new RootBeanDefinition(MethodLocatingFactoryBean.class); methodDefinition.getPropertyValues().add(&quot;targetBeanName&quot;, aspectName); methodDefinition.getPropertyValues().add(&quot;methodName&quot;, adviceElement.getAttribute(&quot;method&quot;)); methodDefinition.setSynthetic(true); // create instance factory definition // åˆ›å»ºåˆ‡é¢ç±» FactoryBean RootBeanDefinition aspectFactoryDef = new RootBeanDefinition(SimpleBeanFactoryAwareAspectInstanceFactory.class); aspectFactoryDef.getPropertyValues().add(&quot;aspectBeanName&quot;, aspectName); aspectFactoryDef.setSynthetic(true); // register the pointcut // é€‰æ‹©åˆé€‚çš„ advice å¹¶æ³¨å†Œ pointcut AbstractBeanDefinition adviceDef = createAdviceDefinition( adviceElement, parserContext, aspectName, order, methodDefinition, aspectFactoryDef, beanDefinitions, beanReferences); // configure the advisor // é…ç½® advisorï¼Œå¯¹åº”çš„ç±»å‹æ˜¯ AspectJPointcutAdvisor.class RootBeanDefinition advisorDefinition = new RootBeanDefinition(AspectJPointcutAdvisor.class); advisorDefinition.setSource(parserContext.extractSource(adviceElement)); advisorDefinition.getConstructorArgumentValues().addGenericArgumentValue(adviceDef); if (aspectElement.hasAttribute(ORDER_PROPERTY)) &#123; advisorDefinition.getPropertyValues().add( ORDER_PROPERTY, aspectElement.getAttribute(ORDER_PROPERTY)); &#125; // register the final advisor parserContext.getReaderContext().registerWithGeneratedName(advisorDefinition); return advisorDefinition; &#125; finally &#123; this.parseState.pop(); &#125;&#125; è¿™é‡Œåˆ’ä¸€ä¸‹ä¸Šé¢ä»£ç æåˆ°çš„å‡ ä¸ªé‡è¦çš„ç±»: Pointcut å¯¹åº” AspectJExpressionPointcut.class Advice å¯¹åº” AspectJMethodBeforeAdvice,AspectJAfterAdviceï¼Œ AspectJAfterReturningAdvice, AspectJAfterThrowingAdvice,AspectJAroundAdvice, äº”ç§é€šçŸ¥ç±»å‹ Advisor å¯¹åº” AspectJPointcutAdvisor.class æ€»ç»“åˆ°è¿™é‡Œï¼Œå¯¹AOPçš„é…ç½®ä¿¡æ¯å·²ç»è§£æå®Œæˆï¼Œå¹¶æˆåŠŸçš„æ”¾å…¥Springå®¹å™¨ä¸­ã€‚çœ‹åˆ°è¿™é‡Œä¹Ÿè®¸å¤§å®¶å¯¹aopçš„å®ç°è¿˜æ˜¯å¾ˆæ¨¡ç³Šï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªæ•´ä½“çš„æ¦‚å¿µã€‚é‚£æ˜¯å› ä¸ºæˆ‘ä»¬å¯¹Aspectï¼Œ Pointcut ï¼ŒAdviceï¼ŒAdvisorè¿™å‡ ä¸ªaopçš„ä¸»è¦æ¦‚å¿µè¿˜æ²¡æœ‰ä¸€ä¸ªç³»ç»Ÿçš„è®¤è¯†ï¼Œä¸‹ç¯‡æ–‡ç« æˆ‘å°†ä¼šå¯¹è¿™å‡ ä¸ªæ¦‚å¿µå¥½å¥½çš„èŠä¸€ä¸‹ã€‚]]></content>
      <categories>
        <category>javaæ¡†æ¶</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring IOC æºç è§£æäº”ï¼ˆéå»¶è¿ŸåŠ è½½beançš„åˆå§‹åŒ–ï¼‰]]></title>
    <url>%2F2018%2F11%2F23%2FSpring-IOC-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%94%EF%BC%88%E9%9D%9E%E5%BB%B6%E8%BF%9F%E5%8A%A0%E8%BD%BDbean%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%89%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ ä¸ŠæœŸåˆ†æäº†refreshæ–¹æ³•ä¸­å¤§éƒ¨åˆ†ï¼Œè¿™æœŸæˆ‘ä»¬åªåˆ†æfinishBeanFactoryInitialization(beanFactory)è¿™ä¸€ä¸ªæ–¹æ³•ï¼Œåˆ†æè¿™ä¸ªæ–¹æ³•çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¼šé¡ºè—¤æ‘¸ç“œæŠŠbeanåˆå§‹åŒ–çš„æ•´ä¸ªæµç¨‹éƒ½åˆ†æä¸€é finishBeanFactoryInitialization(beanFactory)æå‰åˆå§‹åŒ–ä¸€äº›éå»¶è¿ŸåŠ è½½çš„å•ä¾‹ç±»å‹çš„beanï¼Œè¿™é‡Œä¸»è¦çœ‹æœ€åä¸€è¡Œ beanFactory.preInstantiateSingletons(),è¿™é‡Œæ˜¯åˆå§‹åŒ–éå»¶è¿ŸåŠ è½½å•ä¾‹çš„å…¥å£ 123456789101112131415161718192021222324252627282930313233343536protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) &#123; // åˆå§‹åŒ–ç±»å‹è½¬åŒ–çš„bean if (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp; beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123; beanFactory.setConversionService( beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)); &#125; // Register a default embedded value resolver if no bean post-processor // (such as a PropertyPlaceholderConfigurer bean) registered any before: // at this point, primarily for resolution in annotation attribute values. // æ³¨å†Œé»˜è®¤çš„å€¼è§£æå™¨ if (!beanFactory.hasEmbeddedValueResolver()) &#123; beanFactory.addEmbeddedValueResolver(new StringValueResolver() &#123; @Override public String resolveStringValue(String strVal) &#123; return getEnvironment().resolvePlaceholders(strVal); &#125; &#125;); &#125; // Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early. String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, false, false); for (String weaverAwareName : weaverAwareNames) &#123; getBean(weaverAwareName); &#125; // Stop using the temporary ClassLoader for type matching. beanFactory.setTempClassLoader(null); // Allow for caching all bean definition metadata, not expecting further changes. beanFactory.freezeConfiguration(); // Instantiate all remaining (non-lazy-init) singletons. beanFactory.preInstantiateSingletons();&#125; preInstantiateSingletonsæ–¹æ³•åœ¨DefaultListableBeanFactoryä¸­ï¼Œç”¨äºåˆå§‹åŒ–æ‰€æœ‰éå»¶è¿ŸåŠ è½½çš„å•ä¾‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859public void preInstantiateSingletons() throws BeansException &#123; if (this.logger.isDebugEnabled()) &#123; this.logger.debug("Pre-instantiating singletons in " + this); &#125; // æ‰€æœ‰æ³¨å†Œå®Œæˆçš„ beanDefinitionNames List&lt;String&gt; beanNames = new ArrayList&lt;String&gt;(this.beanDefinitionNames); // éå†æ‰€æœ‰éå»¶è¿ŸåŠ è½½çš„å•ä¾‹ç±»å‹ for (String beanName : beanNames) &#123; RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName); if (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123; // åˆ¤æ–­ç±»å‹æ˜¯å¦ä¸º FactoryBean if (isFactoryBean(beanName)) &#123; final FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) getBean(FACTORY_BEAN_PREFIX + beanName); boolean isEagerInit; if (System.getSecurityManager() != null &amp;&amp; factory instanceof SmartFactoryBean) &#123; isEagerInit = AccessController.doPrivileged(new PrivilegedAction&lt;Boolean&gt;() &#123; @Override public Boolean run() &#123; return ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit(); &#125; &#125;, getAccessControlContext()); &#125; else &#123; isEagerInit = (factory instanceof SmartFactoryBean &amp;&amp; ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit()); &#125; // æ˜¯å¦éœ€è¦ç«‹å³åŠ è½½ if (isEagerInit) &#123; getBean(beanName); &#125; &#125; else &#123; getBean(beanName); &#125; &#125; &#125; // Trigger post-initialization callback for all applicable beans... for (String beanName : beanNames) &#123; Object singletonInstance = getSingleton(beanName); if (singletonInstance instanceof SmartInitializingSingleton) &#123; final SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance; if (System.getSecurityManager() != null) &#123; AccessController.doPrivileged(new PrivilegedAction&lt;Object&gt;() &#123; @Override public Object run() &#123; smartSingleton.afterSingletonsInstantiated(); return null; &#125; &#125;, getAccessControlContext()); &#125; else &#123; smartSingleton.afterSingletonsInstantiated(); &#125; &#125; &#125;&#125; å¯ä»¥çœ‹åˆ°è¿™æ®µä»£ç ä¸»è¦åšäº†2ä¸ªäº‹æƒ… åˆ¤æ–­beançš„ç±»å‹æ˜¯å¦æ˜¯factoryBeanï¼Œå¦‚æœæ˜¯çš„è¯åˆ¤æ–­ç±»å‹æ˜¯ä¸æ˜¯SmartFactoryBeanï¼Œå†è·å–æ˜¯å¦éœ€è¦ç«‹å³åŠ è½½çš„isEagerInitå±æ€§ï¼Œæ‰§è¡ŒgetBeanæ–¹æ³• åœ¨å•ä¾‹beanéƒ½åˆå§‹åŒ–å®Œæˆåï¼Œå¾ªç¯åˆ¤æ–­beançš„ç±»å‹æ˜¯å¦æ˜¯SmartInitializingSingletonï¼Œæ˜¯çš„è¯ä¼šåœ¨è¿™æ—¶å€™æ‰§è¡ŒafterSingletonsInstantiatedæ–¹æ³• æ¥ä¸‹æ¥å°±æ˜¯è·å–beançš„æµç¨‹ä»£ç  getBeangetBeanæ–¹æ³•æœ€ç»ˆéƒ½æ˜¯èµ°çš„doGetBeanæ–¹æ³• 123public Object getBean(String name) throws BeansException &#123; return doGetBean(name, null, null, false);&#125; doGetBean123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165protected &lt;T&gt; T doGetBean( final String name, final Class&lt;T&gt; requiredType, final Object[] args, boolean typeCheckOnly) throws BeansException &#123; final String beanName = transformedBeanName(name); Object bean; // é¦–å…ˆæ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰ï¼Œæœ‰åˆ™ç›´æ¥å– Object sharedInstance = getSingleton(beanName); if (sharedInstance != null &amp;&amp; args == null) &#123; if (logger.isDebugEnabled()) &#123; if (isSingletonCurrentlyInCreation(beanName)) &#123; logger.debug("Returning eagerly cached instance of singleton bean '" + beanName + "' that is not fully initialized yet - a consequence of a circular reference"); &#125; else &#123; logger.debug("Returning cached instance of singleton bean '" + beanName + "'"); &#125; &#125; // è¿™é‡Œæ˜¯å–FactoryBean bean = getObjectForBeanInstance(sharedInstance, name, beanName, null); &#125; // ç¼“å­˜é‡Œæ²¡æœ‰ ç¬¬ä¸€æ¬¡åˆå§‹åŒ–Bean else &#123; // åˆ¤æ–­æ˜¯ä¸æ˜¯å¤„äºå¾ªç¯ä¾èµ–å½“ä¸­ï¼Œæœ‰åˆ™ç›´æ¥æŠ¥é”™ if (isPrototypeCurrentlyInCreation(beanName)) &#123; throw new BeanCurrentlyInCreationException(beanName); &#125; // æ£€æŸ¥çˆ¶å®¹å™¨æ˜¯å¦å­˜åœ¨æ­¤Beançš„å®šä¹‰ BeanFactory parentBeanFactory = getParentBeanFactory(); if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) &#123; // Not found -&gt; check parent. // è¿”å›åŸå§‹çš„åç§° åŠ ä¸ŠFactoryBeanç¬¦å· String nameToLookup = originalBeanName(name); if (args != null) &#123; // Delegation to parent with explicit args. return (T) parentBeanFactory.getBean(nameToLookup, args); &#125; else &#123; // No args -&gt; delegate to standard getBean method. return parentBeanFactory.getBean(nameToLookup, requiredType); &#125; &#125; if (!typeCheckOnly) &#123; // æŠŠBeançš„çŠ¶æ€æ”¹ä¸ºå·²åˆ›å»ºï¼Œå¹¶ä»mergedBeanDefinitions ä¸­ç§»é™¤ markBeanAsCreated(beanName); &#125; try &#123; // åˆå¹¶BeanDefinitionè½¬åŒ–æˆRootBeanDefinition final RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName); checkMergedBeanDefinition(mbd, beanName, args); // è·å–é…ç½®çš„ depends-On ä¾èµ–,ä¼˜å…ˆåŠ è½½ String[] dependsOn = mbd.getDependsOn(); if (dependsOn != null) &#123; for (String dep : dependsOn) &#123; if (isDependent(beanName, dep)) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, "Circular depends-on relationship between '" + beanName + "' and '" + dep + "'"); &#125; registerDependentBean(dep, beanName); try &#123; // é€’å½’è·å– getBean(dep); &#125; catch (NoSuchBeanDefinitionException ex) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, "'" + beanName + "' depends on missing bean '" + dep + "'", ex); &#125; &#125; &#125; // Create bean instance. // å¦‚æœæ˜¯å•ä¾‹ if (mbd.isSingleton()) &#123; // è¿™é‡Œä¼šæŠŠåˆ›å»ºå®Œæˆçš„beanåŠ å…¥ç¼“å­˜ sharedInstance = getSingleton(beanName, new ObjectFactory&lt;Object&gt;() &#123; @Override public Object getObject() throws BeansException &#123; try &#123; // åˆ›å»ºbeançš„ä¸»é€»è¾‘ return createBean(beanName, mbd, args); &#125; catch (BeansException ex) &#123; // Explicitly remove instance from singleton cache: It might have been put there // eagerly by the creation process, to allow for circular reference resolution. // Also remove any beans that received a temporary reference to the bean. destroySingleton(beanName); throw ex; &#125; &#125; &#125;); bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd); &#125; // åˆ¤æ–­ç±»å‹ prototype æœ‰çŠ¶æ€çš„bean else if (mbd.isPrototype()) &#123; // It's a prototype -&gt; create a new instance. Object prototypeInstance = null; try &#123; beforePrototypeCreation(beanName); prototypeInstance = createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd); &#125; else &#123; // å…¶ä»–ç±»å‹çš„scope String scopeName = mbd.getScope(); final Scope scope = this.scopes.get(scopeName); if (scope == null) &#123; throw new IllegalStateException("No Scope registered for scope name '" + scopeName + "'"); &#125; try &#123; Object scopedInstance = scope.get(beanName, new ObjectFactory&lt;Object&gt;() &#123; @Override public Object getObject() throws BeansException &#123; beforePrototypeCreation(beanName); try &#123; return createBean(beanName, mbd, args); &#125; finally &#123; afterPrototypeCreation(beanName); &#125; &#125; &#125;); bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd); &#125; catch (IllegalStateException ex) &#123; throw new BeanCreationException(beanName, "Scope '" + scopeName + "' is not active for the current thread; consider " + "defining a scoped proxy for this bean if you intend to refer to it from a singleton", ex); &#125; &#125; &#125; catch (BeansException ex) &#123; cleanupAfterBeanCreationFailure(beanName); throw ex; &#125; &#125; // Check if required type matches the type of the actual bean instance. // å¦‚æœæœ‰æŒ‡å®šçš„ç±»å‹ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦ä¸å®é™…beanå®ä¾‹çš„ç±»å‹åŒ¹é… if (requiredType != null &amp;&amp; bean != null &amp;&amp; !requiredType.isInstance(bean)) &#123; try &#123; return getTypeConverter().convertIfNecessary(bean, requiredType); &#125; catch (TypeMismatchException ex) &#123; if (logger.isDebugEnabled()) &#123; logger.debug("Failed to convert bean '" + name + "' to required type '" + ClassUtils.getQualifiedName(requiredType) + "'", ex); &#125; throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass()); &#125; &#125; return (T) bean;&#125; çœ‹å®Œä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬ä½œæ€»ç»“ï¼šé¦–å…ˆï¼Œåˆ›å»ºbeanä¹‹å‰ä¼šæ£€æŸ¥å•ä¾‹ç¼“å­˜é‡Œæœ‰æ²¡æœ‰ï¼Œæœ‰çš„è¯ä¼šç›´æ¥è¿”å›ã€‚ç„¶åä¼šæ£€æŸ¥çˆ¶å®¹å™¨æ˜¯å¦æœ‰è¿™ä¸ªbeançš„å®šä¹‰ï¼Œä¸€ç›´æ‰¾åˆ°æœ€é¡¶å±‚çš„çˆ¶å®¹å™¨ï¼ˆæœ‰ç‚¹ç±»å‹åŒäº²å§”æ´¾ï¼‰ï¼Œæœ€åä¼šåœ¨çˆ¶å®¹å™¨æ‰§è¡Œè¿™ä¸ªbeançš„è·å–ï¼Œä¹‹åè·å–depends-Onå¦‚æœæœ‰é…ç½®çš„è¯ä¼šä¼˜å…ˆè·å–ï¼ˆé€’å½’è·å–ç›´åˆ°ä¾èµ–çš„æ‰€æœ‰depends-Onï¼‰ï¼Œæœ€åæ‰æ˜¯æ ¹æ®scopeè°ƒç”¨AbstractAutowireCapableBeanFactoryçš„createBeanæ–¹æ³• createBean12345678910111213141516171819202122232425262728293031323334353637383940414243protected Object createBean(String beanName, RootBeanDefinition mbd, Object[] args) throws BeanCreationException &#123; if (logger.isDebugEnabled()) &#123; logger.debug("Creating instance of bean '" + beanName + "'"); &#125; RootBeanDefinition mbdToUse = mbd; // Make sure bean class is actually resolved at this point, and // clone the bean definition in case of a dynamically resolved Class // which cannot be stored in the shared merged bean definition. Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName); if (resolvedClass != null &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != null) &#123; mbdToUse = new RootBeanDefinition(mbd); mbdToUse.setBeanClass(resolvedClass); &#125; // Prepare method overrides. try &#123; mbdToUse.prepareMethodOverrides(); &#125; catch (BeanDefinitionValidationException ex) &#123; throw new BeanDefinitionStoreException(mbdToUse.getResourceDescription(), beanName, "Validation of method overrides failed", ex); &#125; try &#123; // Give BeanPostProcessors a chance to return a proxy instead of the target bean instance. // æ‰©å±•ç‚¹ï¼Œå¯ä»¥é€šè¿‡å®ç°InstantiationAwareBeanPostProcessor æ¥å£ä¸€ä¸ªè¿”å›ä»£ç†è€Œä¸æ˜¯ç›®æ ‡beanå®ä¾‹ Object bean = resolveBeforeInstantiation(beanName, mbdToUse); if (bean != null) &#123; return bean; &#125; &#125; catch (Throwable ex) &#123; throw new BeanCreationException(mbdToUse.getResourceDescription(), beanName, "BeanPostProcessor before instantiation of bean failed", ex); &#125; Object beanInstance = doCreateBean(beanName, mbdToUse, args); if (logger.isDebugEnabled()) &#123; logger.debug("Finished creating instance of bean '" + beanName + "'"); &#125; return beanInstance;&#125; è¿™æ®µä»£ç ä¸»è¦çœ‹ä¸€ä¸‹resolveBeforeInstantiation(beanName, mbdToUse)ï¼Œè¿™é‡Œæ˜¯springæä¾›çš„ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œå¯ä»¥é€šè¿‡å®ç°InstantiationAwareBeanPostProcessoræ¥å£åœ¨è¿™é‡Œè¿”å›beançš„ä»£ç†ç„¶åå°±å¯ä»¥ç›´æ¥çœ‹æœ€åçš„doCreateBean(beanName, mbdToUse, args)æ–¹æ³• doCreateBean123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final Object[] args) throws BeanCreationException &#123; // Instantiate the bean. // å°è£…beançš„å®¹å™¨ BeanWrapper instanceWrapper = null; if (mbd.isSingleton()) &#123; instanceWrapper = this.factoryBeanInstanceCache.remove(beanName); &#125; if (instanceWrapper == null) &#123; // è¿™é‡Œæ˜¯åˆ›å»º BeanWrapper instanceWrapper = createBeanInstance(beanName, mbd, args); &#125; final Object bean = (instanceWrapper != null ? instanceWrapper.getWrappedInstance() : null); Class&lt;?&gt; beanType = (instanceWrapper != null ? instanceWrapper.getWrappedClass() : null); mbd.resolvedTargetType = beanType; // Allow post-processors to modify the merged bean definition. synchronized (mbd.postProcessingLock) &#123; if (!mbd.postProcessed) &#123; try &#123; applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName); &#125; catch (Throwable ex) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, "Post-processing of merged bean definition failed", ex); &#125; mbd.postProcessed = true; &#125; &#125; // åˆ¤æ–­æ˜¯å¦éœ€è¦æå‰æš´éœ²å¯¹è±¡çš„å¼•ç”¨ï¼Œç”¨äºè§£å†³å¾ªç¯ä¾èµ– boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName)); if (earlySingletonExposure) &#123; if (logger.isDebugEnabled()) &#123; logger.debug("Eagerly caching bean '" + beanName + "' to allow for resolving potential circular references"); &#125; addSingletonFactory(beanName, new ObjectFactory&lt;Object&gt;() &#123; @Override public Object getObject() throws BeansException &#123; return getEarlyBeanReference(beanName, mbd, bean); &#125; &#125;); &#125; // Initialize the bean instance. Object exposedObject = bean; try &#123; // ä¾èµ–æ³¨å…¥çš„ä¸»é€»è¾‘ populateBean(beanName, mbd, instanceWrapper); if (exposedObject != null) &#123; // æ‰§è¡Œä¸€äº›åˆå§‹åŒ–çš„æ–¹æ³• exposedObject = initializeBean(beanName, exposedObject, mbd); &#125; &#125; catch (Throwable ex) &#123; if (ex instanceof BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123; throw (BeanCreationException) ex; &#125; else &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, "Initialization of bean failed", ex); &#125; &#125; if (earlySingletonExposure) &#123; Object earlySingletonReference = getSingleton(beanName, false); if (earlySingletonReference != null) &#123; if (exposedObject == bean) &#123; exposedObject = earlySingletonReference; &#125; else if (!this.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123; String[] dependentBeans = getDependentBeans(beanName); Set&lt;String&gt; actualDependentBeans = new LinkedHashSet&lt;String&gt;(dependentBeans.length); for (String dependentBean : dependentBeans) &#123; if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123; actualDependentBeans.add(dependentBean); &#125; &#125; if (!actualDependentBeans.isEmpty()) &#123; throw new BeanCurrentlyInCreationException(beanName, "Bean with name '" + beanName + "' has been injected into other beans [" + StringUtils.collectionToCommaDelimitedString(actualDependentBeans) + "] in its raw version as part of a circular reference, but has eventually been " + "wrapped. This means that said other beans do not use the final version of the " + "bean. This is often the result of over-eager type matching - consider using " + "'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example."); &#125; &#125; &#125; &#125; // Register bean as disposable. try &#123; registerDisposableBeanIfNecessary(beanName, bean, mbd); &#125; catch (BeanDefinitionValidationException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, "Invalid destruction signature", ex); &#125; return exposedObject;&#125; è¿™æ®µä»£ç ä¸»è¦çœ‹è¿™ä¸‰ä¸ªæ–¹æ³• createBeanInstance(beanName, mbd, args) åˆ›å»ºbean populateBean(beanName, mbd, instanceWrapper) ç»„è£…beançš„ä¾èµ– initializeBean(beanName, exposedObject, mbd) è°ƒç”¨beançš„ä¸€äº›åˆå§‹åŒ–æ–¹æ³•ï¼Œä»¥åŠæ‰©å±•æ¥å£ æ¥ä¸‹æ¥æˆ‘ä»¬ç€é‡æ¥çœ‹è¿™ä¸‰ä¸ªæ–¹æ³• createBeanInstance123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051protected BeanWrapper createBeanInstance(String beanName, RootBeanDefinition mbd, Object[] args) &#123; // Make sure bean class is actually resolved at this point. // è·å–bean class Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName); // ä¸æ˜¯ pullic ç›´æ¥æŠ›å¼‚å¸¸ if (beanClass != null &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123; throw new BeanCreationException(mbd.getResourceDescription(), beanName, "Bean class isn't public, and non-public access not allowed: " + beanClass.getName()); &#125; // ä½¿ç”¨å·¥å‚æ–¹æ³•å®ä¾‹åŒ–bean if (mbd.getFactoryMethodName() != null) &#123; return instantiateUsingFactoryMethod(beanName, mbd, args); &#125; // Shortcut when re-creating the same bean... // åˆ¤æ–­beanæ˜¯å¦åˆ›å»ºè¿‡ boolean resolved = false; boolean autowireNecessary = false; if (args == null) &#123; synchronized (mbd.constructorArgumentLock) &#123; if (mbd.resolvedConstructorOrFactoryMethod != null) &#123; resolved = true; autowireNecessary = mbd.constructorArgumentsResolved; &#125; &#125; &#125; // å¦‚æœå·²ç»åŠ è½½è¿‡ if (resolved) &#123; if (autowireNecessary) &#123; // æœ‰å‚æ„é€ æ–¹æ³• return autowireConstructor(beanName, mbd, null, null); &#125; else &#123; // ä½¿ç”¨æ— å‚æ„é€  return instantiateBean(beanName, mbd); &#125; &#125; // Need to determine the constructor... // å¯»æ‰¾ä¸€ä¸ªåˆé€‚çš„æ„é€ æ–¹æ³• Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName); if (ctors != null || mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR || mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) &#123; return autowireConstructor(beanName, mbd, ctors, args); &#125; // No special handling: simply use no-arg constructor. return instantiateBean(beanName, mbd);&#125; è¿™ä¸ªæ–¹æ³•çš„ä¸»è¦é€»è¾‘å…¶å®å°±æ˜¯åœ¨æ‰¾ä¸€ä¸ªåˆé€‚çš„åˆå§‹åŒ–æ–¹æ³• é¦–å…ˆåˆ¤æ–­RootBeanDefinitionæ˜¯å¦å«æœ‰factory-methodé…ç½®ï¼Œæœ‰çš„è¯ä½¿ç”¨å·¥å‚æ–¹æ³•å®ä¾‹åŒ–bean ä¹‹åçš„é€»è¾‘å°±æ˜¯å¯»æ‰¾ä¸€ä¸ªåˆé€‚çš„æ„é€ æ–¹æ³•ç”¨äºbeançš„å®ä¾‹åŒ– å¦‚æœåˆ¤æ–­æ˜¯æœ‰å‚çš„æ„é€ æ–¹æ³•ï¼Œåˆ™é€šè¿‡autowireConstructorå®ä¾‹åŒ–ï¼Œåˆå§‹åŒ–çš„è¿‡ç¨‹å¾ˆç¹çï¼Œå…¶ä¸­å¯¹æ„é€ æ–¹æ³•å‚æ•°çš„ä¾èµ–ä¹Ÿæ˜¯é€šè¿‡é€’å½’getBean()æ¥å®ç°çš„ æ— å‚çš„åˆ™ä½¿ç”¨instantiateBeanå®ä¾‹åŒ– åˆ°è¿™é‡Œæ‰§è¡Œå®Œbeanå·²ç»åˆ›å»ºäº†(springé»˜è®¤æ˜¯ä½¿ç”¨CGLIB)ï¼Œä½†æ˜¯è¿™æ—¶å€™çš„beanæ˜¯ä¸å®Œæ•´çš„ï¼Œç›¸å…³çš„ä¾èµ–é¡¹è¿˜å¹¶æ²¡æœ‰è¢«æ³¨å…¥ populateBean(beanName, mbd, instanceWrapper)ç»„è£…beançš„é€»è¾‘éƒ½åœ¨è¿™é‡Œ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182protected void populateBean(String beanName, RootBeanDefinition mbd, BeanWrapper bw) &#123; // è·å–çš„é…ç½®çš„propertyä¾èµ– PropertyValues pvs = mbd.getPropertyValues(); if (bw == null) &#123; if (!pvs.isEmpty()) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, "Cannot apply property values to null instance"); &#125; else &#123; // Skip property population phase for null instance. return; &#125; &#125; // æ‰©å±•ç‚¹ æ‰§è¡Œå®ç°äº†InstantiationAwareBeanPostProcessorsæ¥å£æ–¹æ³• // åœ¨è®¾ç½®å±æ€§ä¾èµ–ä¹‹å‰å¯ä»¥æœ‰æœºä¼šä¿®æ”¹beançš„å±æ€§é…ç½® boolean continueWithPropertyPopulation = true; if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123; for (BeanPostProcessor bp : getBeanPostProcessors()) &#123; if (bp instanceof InstantiationAwareBeanPostProcessor) &#123; InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp; if (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123; continueWithPropertyPopulation = false; break; &#125; &#125; &#125; &#125; // åˆ¤æ–­æ˜¯å¦éœ€è¦ç»§ç»­ç»„è£…beanå±æ€§ if (!continueWithPropertyPopulation) &#123; return; &#125; // åˆ¤æ–­è‡ªåŠ¨é…çš„ç±»å‹ï¼ˆæŒ‰åç§°å’ŒæŒ‰ç±»å‹ï¼‰ if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME || mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123; MutablePropertyValues newPvs = new MutablePropertyValues(pvs); // Add property values based on autowire by name if applicable. // æŒ‰beançš„åç§°æ³¨å…¥ if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME) &#123; autowireByName(beanName, mbd, bw, newPvs); &#125; // Add property values based on autowire by type if applicable. // æŒ‰beançš„ç±»å‹æ³¨å…¥ if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123; autowireByType(beanName, mbd, bw, newPvs); &#125; pvs = newPvs; &#125; // åˆ¤æ–­æ˜¯å¦éœ€è¦ä¾èµ–æ£€æŸ¥ boolean hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors(); boolean needsDepCheck = (mbd.getDependencyCheck() != RootBeanDefinition.DEPENDENCY_CHECK_NONE); if (hasInstAwareBpps || needsDepCheck) &#123; PropertyDescriptor[] filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching); if (hasInstAwareBpps) &#123; for (BeanPostProcessor bp : getBeanPostProcessors()) &#123; if (bp instanceof InstantiationAwareBeanPostProcessor) &#123; InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp; pvs = ibp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName); if (pvs == null) &#123; return; &#125; &#125; &#125; &#125; if (needsDepCheck) &#123; // æ£€æŸ¥ä¾èµ– checkDependencies(beanName, mbd, filteredPds, pvs); &#125; &#125; // ç»„è£…å±æ€§ applyPropertyValues(beanName, mbd, bw, pvs);&#125; é€šè¿‡æŸ¥çœ‹ä»£ç ï¼Œå¯çŸ¥ä¸Šé¢ä¸æ­¢åšäº†ç»„è£…beanè¿™ä¸€ä»¶äº‹ï¼Œä¸»è¦åšäº†ä¸‹é¢å‡ ä»¶äº‹æƒ…: è·å–springé…ç½®é¡¹ä¸­é…ç½®çš„propertyå±æ€§ä¾èµ– æ‰§è¡Œå®ç°äº†InstantiationAwareBeanPostProcessorsæ¥å£çš„æ–¹æ³•ï¼Œè¯¥æ¥å£å¯ä»¥åœ¨å±æ€§è¢«æ³¨å…¥å‰åšä¸€äº›ä¿®æ”¹ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œä¸‹é¢çš„å±æ€§æ³¨å…¥é€»è¾‘ åˆ¤æ–­æ˜¯å¦æœ‰é…ç½®è‡ªåŠ¨æ³¨å…¥ï¼Œæœ‰çš„è¯ä¼šæŒ‰é…ç½®æ‰§è¡ŒæŒ‰åç§°ï¼ˆautowireByNameæ–¹æ³•ï¼‰æˆ–ç±»å‹ï¼ˆautowireByTypeæ–¹æ³•ï¼‰æ³¨å…¥ åˆ¤æ–­æ˜¯å¦æ‰§è¡Œä¾èµ–æ£€æŸ¥ï¼ˆæŒ‰é…ç½®çš„ä¾èµ–æ£€æŸ¥ç­‰çº§checkï¼‰ æœ€åæ‰§è¡Œbeanå±æ€§çš„æœ€ç»ˆè£…é… ï¼ˆapplyPropertyValues(beanName, mbd, bw, pvs)ï¼‰ æˆ‘ä»¬å¯ä»¥ç®€å•çœ‹ä¸€ä¸‹ autowireByNameçš„å®ç° autowireByName123456789101112131415161718192021222324protected void autowireByName( String beanName, AbstractBeanDefinition mbd, BeanWrapper bw, MutablePropertyValues pvs) &#123; // è¿”å›éœ€è¦è‡ªåŠ¨ä¾èµ–æ³¨å…¥çš„å±æ€§åç§° String[] propertyNames = unsatisfiedNonSimpleProperties(mbd, bw); for (String propertyName : propertyNames) &#123; if (containsBean(propertyName)) &#123; Object bean = getBean(propertyName); // å°†è·å–çš„ä¾èµ–beanæ”¾å› å¾…è£…é… pvs.add(propertyName, bean); registerDependentBean(propertyName, beanName); if (logger.isDebugEnabled()) &#123; logger.debug("Added autowiring by name from bean name '" + beanName + "' via property '" + propertyName + "' to bean named '" + propertyName + "'"); &#125; &#125; else &#123; if (logger.isTraceEnabled()) &#123; logger.trace("Not autowiring property '" + propertyName + "' of bean '" + beanName + "' by name: no matching bean found"); &#125; &#125; &#125;&#125; å¯çŸ¥å¦‚æœæ˜¯æŒ‰nameæ³¨å…¥çš„è¯ï¼Œé¦–å…ˆä¼šå…ˆè·å–éœ€è¦è‡ªåŠ¨ä¾èµ–æ³¨å…¥çš„beanåç§°ï¼Œç„¶åæ˜¯é€šè¿‡getBean(beanName)è·å–ä¾èµ–é¡¹çš„ã€‚åŒç†autowireByType applyPropertyValuesåœ¨æ‰§è¡ŒapplyPropertyValuesæ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†æ‰€æœ‰çš„ä¾èµ–é¡¹äº†ï¼Œæ¥ä¸‹æ¥çš„äº‹æƒ…å°±æ˜¯æŠŠè¿™äº›ä¾èµ–é¡¹è£…é…åˆ°beanå¯¹åº”çš„å±æ€§ä¸­ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293protected void applyPropertyValues(String beanName, BeanDefinition mbd, BeanWrapper bw, PropertyValues pvs) &#123; // å¾…è£…é…çš„å±æ€§ä¸ºç©º ç›´æ¥è¿”å› if (pvs == null || pvs.isEmpty()) &#123; return; &#125; MutablePropertyValues mpvs = null; List&lt;PropertyValue&gt; original; if (System.getSecurityManager() != null) &#123; if (bw instanceof BeanWrapperImpl) &#123; ((BeanWrapperImpl) bw).setSecurityContext(getAccessControlContext()); &#125; &#125; // if (pvs instanceof MutablePropertyValues) &#123; mpvs = (MutablePropertyValues) pvs; if (mpvs.isConverted()) &#123; // Shortcut: use the pre-converted values as-is. try &#123; bw.setPropertyValues(mpvs); return; &#125; catch (BeansException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, "Error setting property values", ex); &#125; &#125; original = mpvs.getPropertyValueList(); &#125; else &#123; original = Arrays.asList(pvs.getPropertyValues()); &#125; TypeConverter converter = getCustomTypeConverter(); if (converter == null) &#123; converter = bw; &#125; // ç”¨äºåŠ è½½beanDefinitionæ‰€å¯¹åº”çš„å€¼ BeanDefinitionValueResolver valueResolver = new BeanDefinitionValueResolver(this, beanName, mbd, converter); // åˆ›å»ºä¸€ä¸ªPropertyValueçš„æ·±æ‹·è´ List&lt;PropertyValue&gt; deepCopy = new ArrayList&lt;PropertyValue&gt;(original.size()); boolean resolveNecessary = false; for (PropertyValue pv : original) &#123; if (pv.isConverted()) &#123; deepCopy.add(pv); &#125; else &#123; String propertyName = pv.getName(); Object originalValue = pv.getValue(); // åŠ è½½å¯¹åº”å±æ€§å€¼ value Object resolvedValue = valueResolver.resolveValueIfNecessary(pv, originalValue); Object convertedValue = resolvedValue; boolean convertible = bw.isWritableProperty(propertyName) &amp;&amp; !PropertyAccessorUtils.isNestedOrIndexedProperty(propertyName); if (convertible) &#123; convertedValue = convertForProperty(resolvedValue, propertyName, bw, converter); &#125; // Possibly store converted value in merged bean definition, // in order to avoid re-conversion for every created bean instance. if (resolvedValue == originalValue) &#123; if (convertible) &#123; pv.setConvertedValue(convertedValue); &#125; deepCopy.add(pv); &#125; else if (convertible &amp;&amp; originalValue instanceof TypedStringValue &amp;&amp; !((TypedStringValue) originalValue).isDynamic() &amp;&amp; !(convertedValue instanceof Collection || ObjectUtils.isArray(convertedValue))) &#123; pv.setConvertedValue(convertedValue); deepCopy.add(pv); &#125; else &#123; resolveNecessary = true; deepCopy.add(new PropertyValue(pv, convertedValue)); &#125; &#125; &#125; if (mpvs != null &amp;&amp; !resolveNecessary) &#123; mpvs.setConverted(); &#125; // Set our (possibly massaged) deep copy. try &#123; // è®¾ç½®å±æ€§ä¿¡æ¯ bw.setPropertyValues(new MutablePropertyValues(deepCopy)); &#125; catch (BeansException ex) &#123; throw new BeanCreationException( mbd.getResourceDescription(), beanName, "Error setting property values", ex); &#125;&#125; è¿™æ®µä»£ç åšçš„ä¸»è¦äº‹æƒ…å°±æ˜¯é€šè¿‡é…ç½®çš„å±æ€§å»åŠ è½½å±æ€§å¯¹åº”çš„å€¼ï¼ŒçœŸæ­£ä¸ºbeanè®¾ç½®å±æ€§çš„é€»è¾‘åœ¨bw.setPropertyValues(new MutablePropertyValues(deepCopy))ä¸­ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯é€šè¿‡åå°„è°ƒç”¨setæ–¹æ³•è¿›è¡Œå±æ€§çš„è®¾ç½®çš„ã€‚ä»£ç æ‰§è¡Œåˆ°è¿™é‡Œï¼Œbeançš„åˆ›å»ºå·²ç»åŸºæœ¬å®Œæ•´äº†,populateBeanæ–¹æ³•çš„å·¥ä½œå·²ç»å®Œæˆäº†ï¼Œä¸‹é¢è¦åšçš„å°±æ˜¯ä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œ initializeBean(beanName, exposedObject, mbd)123456789101112131415161718192021222324252627282930313233343536373839protected Object initializeBean(final String beanName, final Object bean, RootBeanDefinition mbd) &#123; // å®‰å…¨ç®¡ç†å™¨ åˆ¤æ–­æ‰§è¡Œæƒé™ if (System.getSecurityManager() != null) &#123; AccessController.doPrivileged(new PrivilegedAction&lt;Object&gt;() &#123; @Override public Object run() &#123; invokeAwareMethods(beanName, bean); return null; &#125; &#125;, getAccessControlContext()); &#125; else &#123; // æ‰§è¡Œå®ç°äº†ä¸€ç³»åˆ—Awareçš„æ¥å£æ–¹æ³• invokeAwareMethods(beanName, bean); &#125; Object wrappedBean = bean; if (mbd == null || !mbd.isSynthetic()) &#123; // æ‰§è¡ŒBeanPostProcessoræ¥å£postProcessBeforeInitializationæ–¹æ³• wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName); &#125; try &#123; // å…ˆæ‰§è¡ŒInitializingBeanæ¥å£afterPropertiesSetæ–¹æ³• // å†æ‰§è¡Œè‡ªå®šä¹‰é…ç½®çš„åˆå§‹åŒ–æ–¹æ³•(init-method) invokeInitMethods(beanName, wrappedBean, mbd); &#125; catch (Throwable ex) &#123; throw new BeanCreationException( (mbd != null ? mbd.getResourceDescription() : null), beanName, "Invocation of init method failed", ex); &#125; if (mbd == null || !mbd.isSynthetic()) &#123; // æ‰§è¡ŒBeanPostProcessoræ¥å£postProcessAfterInitializationæ–¹æ³• wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); &#125; return wrappedBean;&#125; ä¸Šè¿°ä»£ç åšçš„éƒ½æ˜¯beanåˆå§‹åŒ–çš„äº‹æƒ… invokeAwareMethodsæ–¹æ³•ï¼Œå¦‚æœæœ‰beanåˆå®ç°Awareç›¸å…³çš„æ¥å£ï¼Œåˆ™è°ƒç”¨è¿™äº›æ¥å£çš„æ–¹æ³•ç»™beanæ³¨å…¥ä¸€äº›ä¿¡æ¯(beanNameï¼ŒBeanClassLoaderï¼ŒBeanFactory) applyBeanPostProcessorsBeforeInitialization æ‰§è¡ŒBeanPostProcessoræ¥å£postProcessBeforeInitializationæ–¹æ³•ï¼ŒBeanPostProcessoræ¥å£åœ¨ä¸Šä¸€ç¯‡è§£æä¸­æœ‰è®²åˆ°è¿‡ï¼Œæ˜¯åœ¨refreshæ–¹æ³•çš„registerBeanPostProcessors(beanFactory)ä¸­æ³¨å†Œçš„ï¼Œæ˜¯springæä¾›çš„éå¸¸é‡è¦çš„ä¸€ä¸ªè‡ªå®šä¹‰æ‰©å±•ç‚¹ invokeInitMethodsæ–¹æ³•ï¼Œè¿™é‡Œæ˜¯åˆ¤æ–­æ˜¯å¦æœ‰å®ç°InitializingBeanæ¥å£ï¼Œæœ‰åˆ™æ‰§è¡ŒafterPropertiesSetåˆå§‹åŒ–æ–¹æ³•ï¼Œå¹¶ä¸”å¦‚æœæœ‰é…ç½®è‡ªå®šä¹‰çš„init-methodæ–¹æ³•åˆ™ä¹Ÿä¸€å¹¶æ‰§è¡Œ applyBeanPostProcessorsBeforeInitialization æ‰§è¡ŒBeanPostProcessoræ¥å£postProcessAfterInitializationæ–¹æ³• å°¾è¨€ éšç€è§£æè¿›è¡Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»æŠŠbeançš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸéƒ½èµ°äº†ä¸ªå¤§æ¦‚ã€‚ç›¸ä¿¡å¤§å®¶å¯¹spring ioc çš„å…·ä½“å®ç°å·²ç»æœ‰äº†ä¸ªåŸºæœ¬çš„äº†è§£äº†]]></content>
      <categories>
        <category>javaæ¡†æ¶</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring IOC æºç è§£æå››ï¼ˆåŠ è½½éå»¶è¿Ÿå•ä¾‹å‰çš„æ“ä½œï¼‰]]></title>
    <url>%2F2018%2F11%2F20%2FSpring-IOC-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E5%9B%9B%EF%BC%88%E5%8A%A0%E8%BD%BD%E9%9D%9E%E5%BB%B6%E8%BF%9F%E5%8D%95%E4%BE%8B%E5%89%8D%E7%9A%84%E6%93%8D%E4%BD%9C%EF%BC%89%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ ä¸Šä¸€æœŸè®²è¿°äº†BeanDefinitionsçš„è½½å…¥å’Œæ³¨å†Œï¼ŒbeanDefinitionç›¸å½“äºspringå¯¹beançš„æ•°æ®æŠ½è±¡å®šä¹‰ï¼Œè¿™ä¸€æœŸæˆ‘ä»¬ç»§ç»­é¡ºç€çš„ refresh æ–¹æ³•å¾€ä¸‹è®² å›åˆ°refreshæ–¹æ³•ä¸Šä¸€æœŸå…¶å®ä¸»è¦æ˜¯ä»‹ç»äº†obtainFreshBeanFactory() è¿™ä¸€æ­¥ï¼Œè¿™ä¸€æœŸæˆ‘ä»¬ç»§ç»­æ¥ç€å¾€ä¸‹çœ‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566@Overridepublic void refresh() throws BeansException, IllegalStateException &#123; synchronized (this.startupShutdownMonitor) &#123; // Prepare this context for refreshing. prepareRefresh(); // åˆ›å»ºBeanFactory,å¹¶è½½å…¥BeanDefinitionsï¼ˆé‡è¦ï¼‰ ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); // Prepare the bean factory for use in this context. prepareBeanFactory(beanFactory); try &#123; // Allows post-processing of the bean factory in context subclasses. postProcessBeanFactory(beanFactory); // æ‰§è¡Œ BeanFactoryPostProcessorsï¼ˆå®ä¾‹åŒ–beanå‰ä¿®æ”¹beanå®šä¹‰ä¿¡æ¯ï¼‰ invokeBeanFactoryPostProcessors(beanFactory); // æ³¨å†Œ BeanPostProcessorsï¼ˆåˆå§‹åŒ–beanå‰åæ‰§è¡Œï¼‰ registerBeanPostProcessors(beanFactory); // Initialize message source for this context. // å›½é™…åŒ–ç›¸å…³ initMessageSource(); // Initialize event multicaster for this context. initApplicationEventMulticaster(); // Initialize other special beans in specific context subclasses. // åˆå§‹åŒ–ä¸»é¢˜ä¿¡æ¯ onRefresh(); // Check for listener beans and register them. registerListeners(); // æå‰å®ä¾‹åŒ–åŒ–å…¨éƒ¨éå»¶è¿ŸåŠ è½½çš„å•ä¾‹ç±»å‹ finishBeanFactoryInitialization(beanFactory); // Last step: publish corresponding event. finishRefresh(); &#125; catch (BeansException ex) &#123; if (logger.isWarnEnabled()) &#123; logger.warn("Exception encountered during context initialization - " + "cancelling refresh attempt: " + ex); &#125; // Destroy already created singletons to avoid dangling resources. destroyBeans(); // Reset 'active' flag. cancelRefresh(ex); // Propagate exception to caller. throw ex; &#125; finally &#123; // Reset common introspection caches in Spring's core, since we // might not ever need metadata for singleton beans anymore... resetCommonCaches(); &#125; &#125;&#125; prepareBeanFactory(beanFactory)å…ˆçœ‹ä¸€ä¸‹prepareBeanFactoryçš„æ–¹æ³•å®ç° 12345678910111213141516171819202122232425262728293031323334353637383940414243444546protected void prepareBeanFactory(ConfigurableListableBeanFactory beanFactory) &#123; // é…ç½®å®¹å™¨çš„ classLoader beanFactory.setBeanClassLoader(getClassLoader()); // è¿™æ˜¯ä¸€ä¸ªè¡¨è¾¾æ˜¯è¯­è¨€å¤„ç†å™¨ beanFactory.setBeanExpressionResolver(new StandardBeanExpressionResolver(beanFactory.getBeanClassLoader())); // å±æ€§ç¼–è¾‘å™¨ beanFactory.addPropertyEditorRegistrar(new ResourceEditorRegistrar(this, getEnvironment())); // é…ç½®äº†BeanPostProcessorçš„ä¸€ä¸ªå®ç°ç±» beanFactory.addBeanPostProcessor(new ApplicationContextAwareProcessor(this)); // é…ç½®è¢«å¿½ç•¥çš„ä¾èµ–é¡¹ï¼ˆå„ç§ Aware å®ç°ç±»ï¼‰ beanFactory.ignoreDependencyInterface(EnvironmentAware.class); beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class); beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class); beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class); beanFactory.ignoreDependencyInterface(MessageSourceAware.class); beanFactory.ignoreDependencyInterface(ApplicationContextAware.class); // ä¿®æ­£ä¾èµ– beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory); beanFactory.registerResolvableDependency(ResourceLoader.class, this); beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, this); beanFactory.registerResolvableDependency(ApplicationContext.class, this); // Register early post-processor for detecting inner beans as ApplicationListeners. // æ³¨å†ŒAOPç›¸å…³çš„ beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(this)); // Detect a LoadTimeWeaver and prepare for weaving, if found. if (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123; beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory)); // Set a temporary ClassLoader for type matching. beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader())); &#125; // é…ç½®Spring é»˜è®¤ç¯å¢ƒå˜é‡bean if (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123; beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment()); &#125; if (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123; beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties()); &#125; if (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123; beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment()); &#125;&#125; è¿™ä¸ªæ–¹æ³•åšäº†ä»€ä¹ˆäº‹æƒ…å‘¢ï¼Œæˆ‘ä»¬ç®€å•çš„æ¥çœ‹ä¸€ä¸‹ é¦–å…ˆæ˜¯é…ç½®äº†å®¹å™¨çš„é»˜è®¤ classLoader é…ç½®äº†ä¸€ä¸ªè¯­è¨€å™¨å’Œä¸€ä¸ªå±æ€§ç¼–è¾‘å™¨ æ³¨å†Œäº†ä¸€ä¸ªBeanPostProcessoræ¥å£çš„ä¸€ä¸ªå®ç°ç±»ï¼Œè¿™ä¸ªæ¥å£çš„å…·ä½“ç”¨å¤„ä¸‹é¢é©¬ä¸Šä¼šè®²åˆ° é…ç½®è¦è‡ªåŠ¨æ³¨å…¥æ—¶è¦è¢«å¿½ç•¥çš„beanç±»å‹ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œé…ç½®çš„éƒ½æ˜¯ä¸€äº›Awareå®ç°ç±»ï¼Œè¿™äº›ä¾èµ–é¡¹springå®¹å™¨ä¼šç»Ÿä¸€è®¾ç½® æ³¨å†Œaopç›¸å…³çš„ é…ç½®Springé»˜è®¤ç¯å¢ƒå˜é‡bean(systemProperties, systemEnvironment, environment) postProcessBeanFactory(beanFactory)æ–¹æ³•æ¯”è¾ƒç®€çŸ­ï¼Œé€šè¿‡æŸ¥çœ‹ä»£ç ï¼Œå¯çŸ¥ä¹Ÿæ˜¯å¯¹beanFactoryåšä¸€äº›é…ç½®çš„å·¥ä½œ 1234567protected void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) &#123; beanFactory.addBeanPostProcessor(new ServletContextAwareProcessor(this.servletContext, this.servletConfig)); beanFactory.ignoreDependencyInterface(ServletContextAware.class); beanFactory.ignoreDependencyInterface(ServletConfigAware.class); WebApplicationContextUtils.registerWebApplicationScopes(beanFactory, this.servletContext); WebApplicationContextUtils.registerEnvironmentBeans(beanFactory, this.servletContext, this.servletConfig);&#125; invokeBeanFactoryPostProcessors(beanFactory)å¯ä»¥çœ‹åˆ°ä¸»è¦é€»è¾‘åœ¨ï¼ŒPostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessorsä¸­ï¼Œè¿™é‡Œå…¶å®æ˜¯springç•™çš„ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç°BeanFactoryPostProcessoræ¥å®ç°åœ¨ getBeanä¹‹å‰çš„è‡ªå®šä¹‰æ‰©å±•ã€‚ç°åœ¨æˆ‘ä»¬å°±æ¥çœ‹çœ‹å®ƒæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œçš„ 12345678910protected void invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory beanFactory) &#123; PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors()); // Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime // (e.g. through an @Bean method registered by ConfigurationClassPostProcessor) if (beanFactory.getTempClassLoader() == null &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123; beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory)); beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader())); &#125;&#125; ç»§ç»­æŸ¥çœ‹PostProcessorRegistrationDelegate.class 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155public static void invokeBeanFactoryPostProcessors( ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors) &#123; // å­˜æ”¾å·²ç»æ‰§è¡Œçš„ BeanFactoryPostProcessor beanåå­— Set&lt;String&gt; processedBeans = new HashSet&lt;String&gt;(); // åˆ¤æ–­beanFactoryç±»å‹æ˜¯å¦ä¸ºBeanDefinitionRegistryï¼Œåªæœ‰BeanDefinitionRegistryç±»å‹çš„æ‰æ”¯æŒBeanDefinitionRegistryPostProcessorçš„æ³¨å†Œ if (beanFactory instanceof BeanDefinitionRegistry) &#123; BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory; // å­˜æ”¾æ‰‹åŠ¨åŠ å…¥çš„ BeanFactoryPostProcessor List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = new LinkedList&lt;BeanFactoryPostProcessor&gt;(); // å­˜æ”¾æ‰‹åŠ¨åŠ å…¥çš„ BeanDefinitionRegistryPostProcessor List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = new LinkedList&lt;BeanDefinitionRegistryPostProcessor&gt;(); for (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123; // å¦‚æœæ˜¯BeanDefinitionRegistryPostProcessorç±»å‹ if (postProcessor instanceof BeanDefinitionRegistryPostProcessor) &#123; BeanDefinitionRegistryPostProcessor registryProcessor = (BeanDefinitionRegistryPostProcessor) postProcessor; // æ‰§è¡Œ postProcessBeanDefinitionRegistry æ–¹æ³• registryProcessor.postProcessBeanDefinitionRegistry(registry); // æ”¾å…¥å¾…æ‰§è¡Œå®¹å™¨ä¸­ï¼Œä¹‹åä¼šæ‰§è¡ŒBeanFactoryPostProcessoræ¥å£çš„postProcessBeanFactoryæ–¹æ³• registryProcessors.add(registryProcessor); &#125; else &#123; // æ”¾å…¥å¾…æ‰§è¡Œå®¹å™¨ä¸­ï¼Œä¹‹åç»Ÿä¸€æ‰§è¡Œ regularPostProcessors.add(postProcessor); &#125; &#125; // Do not initialize FactoryBeans here: We need to leave all regular beans // uninitialized to let the bean factory post-processors apply to them! // Separate between BeanDefinitionRegistryPostProcessors that implement // PriorityOrdered, Ordered, and the rest. // ç”¨äºå­˜æ”¾å½“å‰éœ€è¦æ‰§è¡Œçš„ BeanDefinitionRegistryPostProcessor list List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = new ArrayList&lt;BeanDefinitionRegistryPostProcessor&gt;(); // First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered. // ä¸€ å…ˆæ‰§è¡Œç±»å‹ä¸º PriorityOrdered çš„BeanDefinitionRegistryPostProcessors String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); for (String ppName : postProcessorNames) &#123; if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123; currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); processedBeans.add(ppName); &#125; &#125; // æ’åº sortPostProcessors(currentRegistryProcessors, beanFactory); // å°†å½“å‰éœ€è¦æ‰§è¡Œå…¨éƒ¨æ”¾å…¥ å¾…æ‰§è¡Œå®¹å™¨ registryProcessors.addAll(currentRegistryProcessors); // æ‰§è¡Œ invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry); // æ¸…ç©ºå·²ç»æ‰§è¡Œè¿‡çš„ currentRegistryProcessors.clear(); // Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered. // äºŒ åœ¨æ‰§è¡Œç±»å‹ä¸ºOrderedçš„BeanDefinitionRegistryPostProcessor postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); for (String ppName : postProcessorNames) &#123; if (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123; currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); processedBeans.add(ppName); &#125; &#125; sortPostProcessors(currentRegistryProcessors, beanFactory); registryProcessors.addAll(currentRegistryProcessors); invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry); currentRegistryProcessors.clear(); // Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear. // æœ€åæ‰§è¡Œæ™®é€šçš„ BeanDefinitionRegistryPostProcessors boolean reiterate = true; // å¾ªç¯çš„ç›®çš„æ˜¯æœªäº†é˜²æ­¢æ‰§è¡Œè¿‡ç¨‹ä¸­æœ‰æ–°çš„ postProcessorNames åŠ å…¥ while (reiterate) &#123; reiterate = false; postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); for (String ppName : postProcessorNames) &#123; if (!processedBeans.contains(ppName)) &#123; currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); processedBeans.add(ppName); reiterate = true; &#125; &#125; sortPostProcessors(currentRegistryProcessors, beanFactory); registryProcessors.addAll(currentRegistryProcessors); invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry); currentRegistryProcessors.clear(); &#125; // Now, invoke the postProcessBeanFactory callback of all processors handled so far. // æ‰§è¡Œå¾…æ‰§è¡Œå®¹å™¨çš„ä¸­çš„ BeanFactoryPostProcessor invokeBeanFactoryPostProcessors(registryProcessors, beanFactory); invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory); &#125; else &#123; // Invoke factory processors registered with the context instance. // ç›´æ¥æ‰§è¡Œæ‰‹åŠ¨åŠ å…¥çš„ BeanFactoryPostProcessor invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory); &#125; // ä»¥ä¸Šæ‰§è¡Œå®ŒBeanDefinitionRegistryPostProcessorï¼Œç°åœ¨å¼€å§‹æ‰§è¡ŒBeanFactoryPostProcessor String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, true, false); // æ‰§è¡Œé¡ºåºå’ŒBeanDefinitionRegistryPostProcessoråŸºæœ¬ä¸€è‡´ï¼Œå…ˆPriorityOrderedï¼Œå†Orderedï¼Œæœ€åæ™®é€šçš„ List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;BeanFactoryPostProcessor&gt;(); // å­˜æ”¾ PriorityOrderedç±»å‹çš„BeanFactoryPostProcessor List&lt;String&gt; orderedPostProcessorNames = new ArrayList&lt;String&gt;(); // å­˜æ”¾ Orderedç±»å‹çš„BeanFactoryPostProcessor List&lt;String&gt; nonOrderedPostProcessorNames = new ArrayList&lt;String&gt;(); for (String ppName : postProcessorNames) &#123; if (processedBeans.contains(ppName)) &#123; // è¿™é‡Œè·³è¿‡çš„æ˜¯å·²ç»æ‰§è¡Œè¿‡çš„ BeanDefinitionRegistryPostProcessor // skip - already processed in first phase above &#125; else if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123; priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class)); &#125; else if (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123; orderedPostProcessorNames.add(ppName); &#125; else &#123; nonOrderedPostProcessorNames.add(ppName); &#125; &#125; // First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered. // å…ˆæ‰§è¡Œ PriorityOrdered sortPostProcessors(priorityOrderedPostProcessors, beanFactory); invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory); // Next, invoke the BeanFactoryPostProcessors that implement Ordered. // å†æ‰§è¡Œ Ordered List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;BeanFactoryPostProcessor&gt;(); for (String postProcessorName : orderedPostProcessorNames) &#123; orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class)); &#125; sortPostProcessors(orderedPostProcessors, beanFactory); invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory); // Finally, invoke all other BeanFactoryPostProcessors. // æœ€åæ‰§è¡Œæ™®é€šçš„ List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = new ArrayList&lt;BeanFactoryPostProcessor&gt;(); for (String postProcessorName : nonOrderedPostProcessorNames) &#123; nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class)); &#125; invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory); // Clear cached merged bean definitions since the post-processors might have // modified the original metadata, e.g. replacing placeholders in values... beanFactory.clearMetadataCache();&#125; è¿™ä¸ªæ–¹æ³•ä»£ç éå¸¸çš„å¤šï¼Œå¤¹æ‚ç€å„ç§åˆ¤æ–­ï¼Œçœ‹çš„çœ¼èŠ±ç¼­ä¹±ã€‚æˆ‘ä»¬ç®€å•ç†ä¸€ä¸‹é€»è¾‘ BeanFactoryPostProcessoræœ‰ä¸€ä¸ªå­æ¥å£å«åšBeanDefinitionRegistryPostProcessorï¼Œå®ƒçš„ä¼˜å…ˆçº§æ˜¯æ¯”BeanFactoryPostProcessoré«˜çš„ æ–¹æ³•çš„å…¥å‚é‡Œæœ‰ä¸€ä¸ªList&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessorsï¼Œè¿™ä¸ªæ˜¯å®¹å™¨é€šè¿‡addBeanFactoryPostProcessoræ–¹æ³•æ‰‹åŠ¨åŠ å…¥çš„ã€‚è¿™é‡Œçš„BeanDefinitionRegistryPostProcessorç±»å‹æ˜¯ä¼˜å…ˆçº§æœ€é«˜çš„ åŒæ—¶BeanFactoryPostProcessorå’ŒBeanDefinitionRegistryPostProcessorå¯ä»¥éƒ½å®ç°ä¸¤ä¸ªæ¥å£(PriorityOrdered,Ordered)ç”¨æ¥å®šä¹‰æ‰§è¡Œçš„é¡ºåºï¼Œå…¶ä¸­PriorityOrderedä¼˜å…ˆçº§æœ€é«˜ï¼Œå…¶æ¬¡Orderedï¼Œæœ€åæ˜¯æ²¡æœ‰å®ç°ä»»ä½•Orderæ¥å£çš„ ç»¼ä¸Šä¸‰ç‚¹ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥å¾—å‡ºä¸Šé¢ä¸€å¤§å¨ä»£ç çš„æ‰§è¡Œé¡ºåºäº† é¦–å…ˆæ˜¯æ‹¿åˆ°æ‰‹åŠ¨åŠ å…¥çš„BeanFactoryPostProcessorï¼ŒæŒ‘å‡ºé‡Œé¢çš„BeanDefinitionRegistryPostProcessorç±»å‹ï¼Œä¼˜å…ˆæ‰§è¡Œã€‚ å†æ‹¿åˆ°å®¹å™¨ä¸­çš„å…¨éƒ¨BeanDefinitionRegistryPostProcessorsï¼ŒæŒ‰ç…§å®ç°çš„æ’åºæ¥å£é¡ºåºæ‰§è¡Œ æ‰§è¡ŒBeanDefinitionRegistryPostProcessorsçˆ¶ç±»å‹BeanFactoryPostProcessorçš„æ–¹æ³• æœ€åå†æ‹¿åˆ°å®¹å™¨ä¸­å…¨éƒ¨BeanFactoryPostProcessorså¹¶è¿‡æ»¤åˆ°å·²ç»æ‰§è¡Œè¿‡çš„BeanDefinitionRegistryPostProcessorsï¼ŒæŒ‰ç…§é¡ºåºä¾æ¬¡æ‰§è¡Œ registerBeanPostProcessors(beanFactory)è¿™é‡Œä¹Ÿæ˜¯springçš„ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œé€šè¿‡å®ç°BeanPostProcessoræ¥å£æ¥å®ç°è‡ªå®šä¹‰é€»è¾‘ï¼Œå…·ä½“çš„æ‰§è¡Œæ—¶æœºï¼Œä¼šåœ¨åˆ†ægetBaanæ—¶è®²åˆ°ï¼Œè¿™é‡Œçš„é€»è¾‘ä»…ä»…æ˜¯å°†BeanPostProcessorç”¨æˆ·è‡ªå®šä¹‰çš„BeanPostProcessoræ³¨å†Œåˆ°å®¹å™¨ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768public static void registerBeanPostProcessors( ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) &#123; String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, true, false); // Register BeanPostProcessorChecker that logs an info message when // a bean is created during BeanPostProcessor instantiation, i.e. when // a bean is not eligible for getting processed by all BeanPostProcessors. int beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + 1 + postProcessorNames.length; beanFactory.addBeanPostProcessor(new BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount)); // Separate between BeanPostProcessors that implement PriorityOrdered, // Ordered, and the rest. List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;BeanPostProcessor&gt;(); List&lt;BeanPostProcessor&gt; internalPostProcessors = new ArrayList&lt;BeanPostProcessor&gt;(); List&lt;String&gt; orderedPostProcessorNames = new ArrayList&lt;String&gt;(); List&lt;String&gt; nonOrderedPostProcessorNames = new ArrayList&lt;String&gt;(); for (String ppName : postProcessorNames) &#123; if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123; BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); priorityOrderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) &#123; internalPostProcessors.add(pp); &#125; &#125; else if (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123; orderedPostProcessorNames.add(ppName); &#125; else &#123; nonOrderedPostProcessorNames.add(ppName); &#125; &#125; // First, register the BeanPostProcessors that implement PriorityOrdered. sortPostProcessors(priorityOrderedPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors); // Next, register the BeanPostProcessors that implement Ordered. List&lt;BeanPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;BeanPostProcessor&gt;(); for (String ppName : orderedPostProcessorNames) &#123; BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); orderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) &#123; internalPostProcessors.add(pp); &#125; &#125; sortPostProcessors(orderedPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, orderedPostProcessors); // Now, register all regular BeanPostProcessors. List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = new ArrayList&lt;BeanPostProcessor&gt;(); for (String ppName : nonOrderedPostProcessorNames) &#123; BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class); nonOrderedPostProcessors.add(pp); if (pp instanceof MergedBeanDefinitionPostProcessor) &#123; internalPostProcessors.add(pp); &#125; &#125; registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors); // Finally, re-register all internal BeanPostProcessors. sortPostProcessors(internalPostProcessors, beanFactory); registerBeanPostProcessors(beanFactory, internalPostProcessors); // Re-register post-processor for detecting inner beans as ApplicationListeners, // moving it to the end of the processor chain (for picking up proxies etc). beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(applicationContext));&#125; è¿™é‡Œçš„é€»è¾‘å…¶å®è·Ÿä¸Šé¢çš„é€»è¾‘éå¸¸çš„ç›¸ä¼¼ï¼Œå…¶å®ä¹Ÿéƒ½åœ¨ä¸€ä¸ªclassä¸­ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰æ‰§è¡Œï¼Œä»…ä»…åªæ˜¯åšäº†ä¸‹æ’åºåå°±æ³¨å†Œè¿›äº†å®¹å™¨ä¸­ï¼Œç•™åˆ°åé¢çš„æ­¥éª¤ä¸­åœ¨æ‰§è¡Œã€‚è¿™é‡Œä¹Ÿç®€å•çš„åˆ—ä¸€ä¸‹è¿™é‡Œçš„è¦ç‚¹ BeanPostProcessoræœ‰ä¸€ä¸ªå­æ¥å£MergedBeanDefinitionPostProcessor,è¿™ä¸ªæ˜¯æœ€æ™šè¢«æ³¨å†Œè¿›å®¹å™¨çš„ åŒæ ·å¯ä»¥å®ç°(PriorityOrdered,Ordered)æ¥å£ç”¨æ¥å®šä¹‰æ‰§è¡Œçš„é¡ºåº initMessageSource()å›½é™…åŒ–ç›¸å…³ï¼Œè¿™é‡Œå°±ä¸åšä»”ç»†åˆ†æäº† initApplicationEventMulticaster()é¡¾åæ€ä¹‰ã€‚å°±æ˜¯springç”¨æ¥åˆå§‹åŒ–äº‹æƒ…å¹¿æ’­å™¨çš„ 12345678910111213141516171819protected void initApplicationEventMulticaster() &#123; ConfigurableListableBeanFactory beanFactory = getBeanFactory(); if (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123; this.applicationEventMulticaster = beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class); if (logger.isDebugEnabled()) &#123; logger.debug("Using ApplicationEventMulticaster [" + this.applicationEventMulticaster + "]"); &#125; &#125; else &#123; this.applicationEventMulticaster = new SimpleApplicationEventMulticaster(beanFactory); beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, this.applicationEventMulticaster); if (logger.isDebugEnabled()) &#123; logger.debug("Unable to locate ApplicationEventMulticaster with name '" + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + "': using default [" + this.applicationEventMulticaster + "]"); &#125; &#125;&#125; çœ‹ä¸€ä¸‹è¿™é‡Œçš„ä»£ç æ¯”è¾ƒçš„ç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ª if elseï¼Œå…ˆå°è¯•è·å–åå­—ä¸ºAPPLICATION_EVENT_MULTICASTER_BEAN_NAMEç±»å‹ä¸ºApplicationEventMulticasterçš„ beanï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œåˆ™é…ç½®ä¸€ä¸ªé»˜è®¤çš„bean (SimpleApplicationEventMulticaster) onRefresh()è¿™é‡Œæ˜¯ç•™ç»™å­ç±»å®ç°çš„ï¼Œæ²¡æœ‰ä»€ä¹ˆé€»è¾‘ registerListeners()æ³¨å†Œä¸€äº›ç›‘å¬å™¨ 12345678910111213141516171819202122protected void registerListeners() &#123; // Register statically specified listeners first. for (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123; getApplicationEventMulticaster().addApplicationListener(listener); &#125; // Do not initialize FactoryBeans here: We need to leave all regular beans // uninitialized to let post-processors apply to them! String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, true, false); for (String listenerBeanName : listenerBeanNames) &#123; getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName); &#125; // Publish early application events now that we finally have a multicaster... Set&lt;ApplicationEvent&gt; earlyEventsToProcess = this.earlyApplicationEvents; this.earlyApplicationEvents = null; if (earlyEventsToProcess != null) &#123; for (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123; getApplicationEventMulticaster().multicastEvent(earlyEvent); &#125; &#125;&#125; å°¾è¨€ ä¸‹ç¯‡ä¼šè§£æfinishBeanFactoryInitializationæ–¹æ³•ï¼Œå¹¶ä¸”ä¼šç€é‡è®²è§£åˆå§‹åŒ–beançš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ]]></content>
      <categories>
        <category>javaæ¡†æ¶</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring æºç è§£æä¸‰ï¼ˆBeanDefinitionsçš„è½½å…¥æ³¨å†Œï¼‰]]></title>
    <url>%2F2018%2F10%2F20%2FSpring-IOC-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89%EF%BC%88BeanDefinitions%E7%9A%84%E8%BD%BD%E5%85%A5%E6%B3%A8%E5%86%8C%EF%BC%89%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ è¿™æœŸä¸»è¦æ˜¯è§£æBeanDefinitionsçš„è½½å…¥å’Œæ³¨å†Œçš„æ•´ä¸ªè¿‡ç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹çœ‹ä¼¼éå¸¸å¤æ‚ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥åˆ†æˆå‡ ä¸ªéƒ¨åˆ†å»çœ‹: 1.è½½å…¥ 2.æ³¨å†Œå’Œè§£æå¦‚æœæ²¡æœ‰çœ‹è¿‡å‰é¢å‡ æœŸçš„è¯ï¼Œå»ºè®®å…ˆè¿‡ä¸€ä¸‹å‰é¢å‡ æœŸ ä¸ºäº†å¸®åŠ©å¤§å®¶ç†æ¸…æ•´ä¸ªè°ƒç”¨è¿‡ç¨‹ï¼Œç®€å•çš„ç”»äº†ä¸€ä¸ªå›¾ å…³é”®ç±» XmlBeanDefinitionReader AbstractBeanDefinitionReader xmlé…ç½®å½¢å¼çš„BeanDefinitionçš„è¯»å–å™¨ XmlReaderContext è§£æè¿‡ç¨‹çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå®é™…æŒæœ‰BeanFactoryå¯¹è±¡ç”¨äºBeanDefinitionsçš„å›è°ƒæ³¨å†Œ DefaultBeanDefinitionDocumentReader è§£æxmlæ–‡ä»¶æŠ½è±¡æˆDocmentå¯¹è±¡ BeanDefinitionParserDelegate ä¸»è¦è§£æè¿‡ç¨‹ DefaultNamespaceHandlerResolver è‡ªå®šä¹‰é…ç½®æ–‡ä»¶è§£æå™¨åŠ è½½å™¨ BeanDefinitionsçš„è½½å…¥loadBeanDefinitions(Stringâ€¦ locations) è¿™ä¸ªæ–¹æ³•æ˜¯æ¯”è¾ƒç®€å•åœ¨AbstractBeanDefinitionReaderä¸­ï¼Œåªæ˜¯æä¾›äº†ä¸€ä¸ªå…¥å£ 1234567891011121314public int loadBeanDefinitions(String... locations) throws BeanDefinitionStoreException &#123; Assert.notNull(locations, "Location array must not be null"); int counter = 0; String[] var3 = locations; int var4 = locations.length; for(int var5 = 0; var5 &lt; var4; ++var5) &#123; String location = var3[var5]; // å¼€å§‹è½½å…¥é…ç½®ä¿¡æ¯ counter += this.loadBeanDefinitions(location); &#125; return counter;&#125; loadBeanDefinitions(String location, Set actualResources) è¿™ä¸ªæ–¹æ³•åŒæ ·åœ¨AbstractBeanDefinitionReaderä¸­è¢«è°ƒç”¨ï¼Œçœ‹ä»£ç å¯çŸ¥å°±æ˜¯è·å–æŒæœ‰çš„ResourceLoaderå¯¹è±¡å¹¶è°ƒç”¨getResourcesæ–¹æ³•ã€‚è¿”å›å¯ä»¥è¢«BeanDefinitionReaderè§£æçš„Resourceç±»å‹ã€‚ è¿™é‡Œè¦æ³¨æ„æŒæœ‰çš„ResourceLoaderå¯¹è±¡æ˜¯åœ¨åˆ›å»ºXmlBeanDefinitionReaderæ—¶æ‰€ä¼ å…¥çš„å®¹å™¨æœ¬èº« 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public int loadBeanDefinitions(String location, Set&lt;Resource&gt; actualResources) throws BeanDefinitionStoreException &#123; // è·å– ResourceLoader ResourceLoader resourceLoader = this.getResourceLoader(); if(resourceLoader == null) &#123; throw new BeanDefinitionStoreException("Cannot import bean definitions from location [" + location + "]: no ResourceLoader available"); &#125; else &#123; int loadCount; // åˆ¤æ–­ resourceLoader çš„ç±»å‹æ˜¯å¦å±äºResourcePatternResolverç±»å‹ if(!(resourceLoader instanceof ResourcePatternResolver)) &#123; Resource resource = resourceLoader.getResource(location); // è°ƒç”¨å­ç±»çš„ loadBeanDefinitions(resource) æ–¹æ³• loadCount = this.loadBeanDefinitions((Resource)resource); if(actualResources != null) &#123; actualResources.add(resource); &#125; if(this.logger.isDebugEnabled()) &#123; this.logger.debug("Loaded " + loadCount + " bean definitions from location [" + location + "]"); &#125; return loadCount; &#125; else &#123; try &#123; Resource[] resources = ((ResourcePatternResolver)resourceLoader).getResources(location); // å¾ªç¯éå†è½½å…¥ loadCount = this.loadBeanDefinitions(resources); if(actualResources != null) &#123; Resource[] var6 = resources; int var7 = resources.length; for(int var8 = 0; var8 &lt; var7; ++var8) &#123; Resource resource = var6[var8]; actualResources.add(resource); &#125; &#125; if(this.logger.isDebugEnabled()) &#123; this.logger.debug("Loaded " + loadCount + " bean definitions from location pattern [" + location + "]"); &#125; return loadCount; &#125; catch (IOException var10) &#123; throw new BeanDefinitionStoreException("Could not resolve bean definition resource pattern [" + location + "]", var10); &#125; &#125; &#125;&#125; loadBeanDefinitions(EncodedResource encodedResource) è·å–åˆ°XMLæ–‡ä»¶çš„inputStreamæµ 1234567891011121314151617181920212223242526272829303132333435363738394041public int loadBeanDefinitions(EncodedResource encodedResource) throws BeanDefinitionStoreException &#123; Assert.notNull(encodedResource, "EncodedResource must not be null"); if (logger.isInfoEnabled()) &#123; logger.info("Loading XML bean definitions from " + encodedResource.getResource()); &#125; Set&lt;EncodedResource&gt; currentResources = this.resourcesCurrentlyBeingLoaded.get(); if (currentResources == null) &#123; currentResources = new HashSet&lt;EncodedResource&gt;(4); this.resourcesCurrentlyBeingLoaded.set(currentResources); &#125; if (!currentResources.add(encodedResource)) &#123; throw new BeanDefinitionStoreException( "Detected cyclic loading of " + encodedResource + " - check your import definitions!"); &#125; try &#123; // è·å–åˆ°XMLæ–‡ä»¶çš„inputStreamæµ InputStream inputStream = encodedResource.getResource().getInputStream(); try &#123; InputSource inputSource = new InputSource(inputStream); if (encodedResource.getEncoding() != null) &#123; inputSource.setEncoding(encodedResource.getEncoding()); &#125; // è¿›è¡Œå…·ä½“çš„xmlæ–‡ä»¶æµè§£æ return doLoadBeanDefinitions(inputSource, encodedResource.getResource()); &#125; finally &#123; inputStream.close(); &#125; &#125; catch (IOException ex) &#123; throw new BeanDefinitionStoreException( "IOException parsing XML document from " + encodedResource.getResource(), ex); &#125; finally &#123; currentResources.remove(encodedResource); if (currentResources.isEmpty()) &#123; this.resourcesCurrentlyBeingLoaded.remove(); &#125; &#125;&#125; doLoadBeanDefinitions(InputSource inputSource, Resource resource) doLoadDocument(inputSource, resource) è§£æè¿”å›Documentå¯¹è±¡ registerBeanDefinitions(doc, resource) ä½¿ç”¨ å¼€å§‹æ³¨å†Œ BeanDefinitions çš„è¿‡ç¨‹ 12345678910111213141516171819202122232425262728293031323334class = org.springframework.beans.factory.xml.XmlBeanDefinitionReaderprotected int doLoadBeanDefinitions(InputSource inputSource, Resource resource) throws BeanDefinitionStoreException &#123; try &#123; // è§£æxmlå¹¶è¿”å›Documentå¯¹è±¡ï¼Œè¿™é‡Œè§£æç”±DefaultDocumentLoaderå®Œæˆ Document doc = doLoadDocument(inputSource, resource); // è§£æ Documentå¯¹è±¡å¹¶æ³¨å†Œ return registerBeanDefinitions(doc, resource); &#125; catch (BeanDefinitionStoreException ex) &#123; throw ex; &#125; catch (SAXParseException ex) &#123; throw new XmlBeanDefinitionStoreException(resource.getDescription(), "Line " + ex.getLineNumber() + " in XML document from " + resource + " is invalid", ex); &#125; catch (SAXException ex) &#123; throw new XmlBeanDefinitionStoreException(resource.getDescription(), "XML document from " + resource + " is invalid", ex); &#125; catch (ParserConfigurationException ex) &#123; throw new BeanDefinitionStoreException(resource.getDescription(), "Parser configuration exception parsing XML from " + resource, ex); &#125; catch (IOException ex) &#123; throw new BeanDefinitionStoreException(resource.getDescription(), "IOException parsing XML document from " + resource, ex); &#125; catch (Throwable ex) &#123; throw new BeanDefinitionStoreException(resource.getDescription(), "Unexpected exception parsing XML document from " + resource, ex); &#125;&#125; BeanDefinitionsçš„è§£æä¸æ³¨å†ŒregisterBeanDefinitions(doc, resource) åˆ›å»º DefaultBeanDefinitionDocumentReaderï¼Œè§£æxmlèµ„æºæ–‡ä»¶ åˆ›å»º XmlReaderContext ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ŒæŒæœ‰èµ„æºæœ¬èº«ï¼ŒæŒæœ‰DefaultNamespaceHandlerResolverå¯¹è±¡ï¼Œç”¨æ¥åŠ è½½è§£æå‡­æ®ï¼ˆè¦æ€ä¹ˆè§£æç”±è§£æå‡­æ®ï¼ˆNamespaceHandlerï¼‰å†³å®šï¼‰ 123456789101112131415161718192021222324252627282930313233343536class = org.springframework.beans.factory.xml.XmlBeanDefinitionReaderpublic int registerBeanDefinitions(Document doc, Resource resource) throws BeanDefinitionStoreException &#123; // åˆ›å»º DefaultBeanDefinitionDocumentReader è§£æxmlèµ„æºæ–‡ä»¶ BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader(); int countBefore = getRegistry().getBeanDefinitionCount(); // å…·ä½“çš„è§£æå¼€å§‹ documentReader.registerBeanDefinitions(doc, createReaderContext(resource)); return getRegistry().getBeanDefinitionCount() - countBefore;&#125;/** * åˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡ */public XmlReaderContext createReaderContext(Resource resource) &#123; // åˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡ æŒæœ‰XmlBeanDefinitionReader å¯¹è±¡ return new XmlReaderContext(resource, this.problemReporter, this.eventListener, this.sourceExtractor, this, getNamespaceHandlerResolver());&#125;/** * åˆ›å»ºXMlå‘½åç©ºé—´è§£æä»£ç†ç±»ï¼Œè§£æXMLæ–‡ä»¶çš„ä¾æ®ã€‚å¯ä»¥è§£æè‡ªå®šä¹‰XMLæ–‡ä»¶ */public NamespaceHandlerResolver getNamespaceHandlerResolver() &#123; if (this.namespaceHandlerResolver == null) &#123; this.namespaceHandlerResolver = createDefaultNamespaceHandlerResolver(); &#125; return this.namespaceHandlerResolver;&#125;/** * åˆ›å»ºé»˜è®¤çš„å‘½åç©ºé—´è§£æä»£ç†ç±» */protected NamespaceHandlerResolver createDefaultNamespaceHandlerResolver() &#123; return new DefaultNamespaceHandlerResolver(getResourceLoader().getClassLoader());&#125; doRegisterBeanDefinitions(Element root) åˆ›å»ºBeanDefinitionParserDelegate è§£æå™¨ï¼Œå¹¶åŠ è½½é»˜è®¤é…ç½®ï¼ˆï¼‰è§£æå™¨æŒæœ‰ä¸Šä¸‹æ–‡å¯¹è±¡ 123456789101112131415161718192021222324252627282930313233343536class = org.springframework.beans.factory.xml.DefaultBeanDefinitionDocumentReaderpublic void registerBeanDefinitions(Document doc, XmlReaderContext readerContext) &#123; this.readerContext = readerContext; this.logger.debug("Loading bean definitions"); Element root = doc.getDocumentElement(); // è§£ææ ¹èŠ‚ç‚¹ this.doRegisterBeanDefinitions(root);&#125;protected void doRegisterBeanDefinitions(Element root) &#123; BeanDefinitionParserDelegate parent = this.delegate; this.delegate = this.createDelegate(this.getReaderContext(), root, parent); // åˆ¤æ–­èŠ‚ç‚¹æ‰€å±å‘½åç©ºé—´æ˜¯å¦ä¸ºspringé»˜è®¤(http://www.springframework.org/schema/beans) if(this.delegate.isDefaultNamespace(root)) &#123; String profileSpec = root.getAttribute("profile"); if(StringUtils.hasText(profileSpec)) &#123; String[] specifiedProfiles = StringUtils.tokenizeToStringArray(profileSpec, ",; "); if(!this.getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123; if(this.logger.isInfoEnabled()) &#123; this.logger.info("Skipped XML bean definition file due to specified profiles [" + profileSpec + "] not matching: " + this.getReaderContext().getResource()); &#125; return; &#125; &#125; &#125; // ç©ºå®ç° this.preProcessXml(root); // å¼€å§‹è§£ææ ¹èŠ‚ç‚¹ this.parseBeanDefinitions(root, this.delegate); // ç©ºå®ç° this.postProcessXml(root); // èµ‹å€¼ç”Ÿæˆçš„çˆ¶å¯¹è±¡ã€‚å«æœ‰é»˜è®¤é…ç½® this.delegate = parent;&#125; parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) åˆ¤æ–­æ˜¯å¦ä¸ºSpringé»˜è®¤çš„å‘½åç©ºé—´é…ç½®ï¼ŒåŠ è½½ä¸åŒçš„è§£ææ–¹æ³•ã€‚é»˜è®¤å‘½åç©ºé—´ä¼šæ‰§è¡ŒparseDefaultElementæ–¹æ³•ï¼Œå¦‚æœæ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„åˆ™ä¼šæ‰§è¡Œ BeanDefinitionParserDelegateçš„ parseCustomElementæ–¹æ³• 1234567891011121314151617181920212223242526class = org.springframework.beans.factory.xml.DefaultBeanDefinitionDocumentReaderprotected void parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) &#123; // åˆ¤æ–­æ˜¯å¦ä¸ºé»˜è®¤å‘½åç©ºé—´ if(delegate.isDefaultNamespace(root)) &#123; NodeList nl = root.getChildNodes(); for(int i = 0; i &lt; nl.getLength(); ++i) &#123; Node node = nl.item(i); if(node instanceof Element) &#123; Element ele = (Element)node; if(delegate.isDefaultNamespace(ele)) &#123; // é»˜è®¤è§£æ this.parseDefaultElement(ele, delegate); &#125; else &#123; // æ‰§è¡Œè‡ªå®šä¹‰è§£ææ–¹æ³• delegate.parseCustomElement(ele); &#125; &#125; &#125; &#125; else &#123; // æ‰§è¡Œè‡ªå®šä¹‰è§£ææ–¹æ³• delegate.parseCustomElement(root); &#125;&#125; é»˜è®¤è§£æparseDefaultElement spirngé»˜è®¤çš„è§£æè§„åˆ™ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰å¾ˆå¤šæˆ‘ä»¬ç†Ÿæ‚‰çš„æ ‡ç­¾å…ƒç´ ï¼Œæ¯”å¦‚bean, importç­‰ï¼Œå¯¹åº”è¿™äº›æ ‡ç­¾ï¼Œspringéƒ½æœ‰ä¸“é—¨çš„è§£æè§„åˆ™ã€‚bean æ ‡ç­¾çš„è§£æå°±ç”±processBeanDefinitionæ¥å®Œæˆè§£æè¿‡ç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬ç€é‡æ¥çœ‹ä¸‹beançš„è§£æ 123456789101112131415161718class = org.springframework.beans.factory.xml.DefaultBeanDefinitionDocumentReaderprivate void parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate) &#123; // è§£æimportæ ‡ç­¾ if(delegate.nodeNameEquals(ele, "import")) &#123; this.importBeanDefinitionResource(ele); &#125; else if(delegate.nodeNameEquals(ele, "alias")) &#123; // è§£æaliasæ ‡ç­¾ this.processAliasRegistration(ele); &#125; else if(delegate.nodeNameEquals(ele, "bean")) &#123; // è§£æbeanæ ‡ç­¾ this.processBeanDefinition(ele, delegate); &#125; else if(delegate.nodeNameEquals(ele, "beans")) &#123; // è§£æbeansæ ‡ç­¾ this.doRegisterBeanDefinitions(ele); &#125;&#125; processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) è§£æBeanDefinitionå¹¶è®¾ç½®åˆ°BeanDefinitionHolderä¸­å» æ³¨å†Œåˆ°beanFactoryçš„BeanDefinitonå®¹å™¨ä¸­å»(å…¶å®æ˜¯ä¸€ä¸ªmap) 12345678910111213141516171819class = org.springframework.beans.factory.xml.DefaultBeanDefinitionDocumentReaderprotected void processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) &#123; // è§£æå¹¶åŒ…è£…æˆBeanDefinitionHolder BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele); if(bdHolder != null) &#123; bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder); try &#123; // å‘å®¹å™¨æ³¨å†Œ BeanDefinitonï¼ŒXmlReaderContextå…¶å®æ˜¯æŒæœ‰å®¹å™¨çš„å¼•ç”¨çš„ BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, this.getReaderContext().getRegistry()); &#125; catch (BeanDefinitionStoreException var5) &#123; this.getReaderContext().error("Failed to register bean definition with name '" + bdHolder.getBeanName() + "'", ele, var5); &#125; this.getReaderContext().fireComponentRegistered(new BeanComponentDefinition(bdHolder)); &#125;&#125; parseBeanDefinitionElement æ„Ÿå…´è¶£çš„åŒå­¦ä¹Ÿå¯ä»¥ç»§ç»­æŠŠparseBeanDefinitionElementçœ‹ä¸€éï¼Œå¯ä»¥å‘ç°å¤§å¤šæ•°éƒ½æ˜¯ä¸Beanå®šä¹‰ç›¸å…³çš„æ ‡ç­¾è§£æ è‡ªå®šä¹‰è§£æ parseCustomElement ä»ä¸Šä¸‹æ–‡è·å– DefaultNamespaceHandlerResolver åŠ è½½è‡ªå®šä¹‰è§£æå‡­æ®ç±»(NamespaceHandler)ï¼ŒDefaultNamespaceHandlerResolverç±»é€šè¿‡æŸ¥çœ‹æºç å¯çŸ¥å…¶ä¼šå»æ‰€æœ‰META-INF/spring.handlersç›®å½•ä¸‹åŠ è½½spring.handlersæ–‡ä»¶ï¼Œspring.handlersé…ç½®çš„æ˜¯å¯¹åº”çš„ä¸åŒå‘½åç©ºé—´çš„è§£æç±» è°ƒç”¨NamespaceHandlerçš„parseè§£æè‡ªå®šä¹‰xmlé…ç½® çœ‹åˆ°è¿™é‡Œå…¶å®æˆ‘ä»¬çŸ¥é“springåœ¨è¿™é‡Œæ˜¯ç•™äº†ä¸€ä¸ªæ‰©å±•ç‚¹çš„ï¼Œå¯ä»¥é€šè¿‡è‡ªå®šä¹‰é…ç½®æ–‡ä»¶æ¥è¿›è¡Œè‡ªå®šä¹‰è§£æ 12345678910111213141516171819class=org.springframework.beans.factory.xml.BeanDefinitionParserDelegatepublic BeanDefinition parseCustomElement(Element ele) &#123; return this.parseCustomElement(ele, (BeanDefinition)null);&#125;public BeanDefinition parseCustomElement(Element ele, BeanDefinition containingBd) &#123; // è·å–æ‰€å±çš„å‘½åç©ºé—´åœ°å€ String namespaceUri = this.getNamespaceURI(ele); // ä¸Šä¸‹æ–‡ä¸­è·å–DefaultNamespaceHandlerResolver å¹¶æ ¹æ®å‘½åç©ºé—´åœ°å€è·å–å¯¹åº”çš„ Handler NamespaceHandler handler = this.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri); if(handler == null) &#123; this.error("Unable to locate Spring NamespaceHandler for XML schema namespace [" + namespaceUri + "]", ele); return null; &#125; else &#123; // æ‰§è¡Œè§£æï¼ˆthis.readerContext ä¸­æŒæœ‰BeanFactoryæ³¨å†Œå¯¹è±¡ï¼Œå¯ä»¥å›è°ƒæ³¨å†ŒBeanDefinitionä¿¡æ¯ï¼‰ return handler.parse(ele, new ParserContext(this.readerContext, this, containingBd)); &#125;&#125; å°¾è¨€ BeanDefinitions åˆ°è¿™é‡Œä¸ºæ­¢å°±è¢«æ³¨å†Œå®Œæˆäº†ï¼Œä¸‹æœŸå°±æ˜¯Springé‡è¦çš„ä¾èµ–æ³¨å…¥äº†]]></content>
      <categories>
        <category>javaæ¡†æ¶</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ•°æ®åº“è®¾è®¡è¦æ³¨æ„çš„å‡ ä¸ªç‚¹]]></title>
    <url>%2F2018%2F08%2F17%2F%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%87%A0%E4%B8%AA%E7%82%B9%2F</url>
    <content type="text"><![CDATA[æ•°æ®åº“è®¾è®¡å­—ç¬¦é›† ç»Ÿä¸€ä½¿ç”¨utf8mb4ï¼ŒMySQLåœ¨5.5.3ä¹‹åå¢åŠ äº†utf8mb4å­—ç¬¦ç¼–ç ï¼Œç®€å•çš„è¯´utf8mb4æ‰æ˜¯çœŸæ­£çš„utf-8ï¼Œå› ä¸ºå®ƒå¯ä»¥æ”¯æŒ4ä¸ªå­—èŠ‚æ¯ä¸ªå­—ç¬¦ï¼Œpsï¼šå½“æˆ‘ä»¬è¦å­˜å‚¨emojiè¡¨æƒ…å°±å¿…é¡»ä½¿ç”¨utf8mb4ï¼Œæ€§èƒ½ä¸Šä¸ä¼šæœ‰æŸå¤± å»ºè¡¨è§„èŒƒ å­—æ®µåå¿…é¡»ä½¿ç”¨å°å†™å­—æ¯ å°æ•°ç±»å‹ä¸ºdecimalï¼Œç¦æ­¢ä½¿ç”¨floatå’Œdoubleï¼ˆä¼šæœ‰ç²¾åº¦æŸå¤±ï¼‰ å¦‚æœå­˜å‚¨çš„å­—ç¬¦ä¸²é•¿åº¦å‡ ä¹ç›¸ç­‰ï¼Œä½¿ç”¨charå®šé•¿å­—ç¬¦ä¸²ç±»å‹ï¼ˆä¸varcharçš„åŒºåˆ«ï¼Œä¾‹å¦‚ï¼Œå­˜å‚¨å­—ç¬¦ä¸²&#39;abc&#39;ï¼Œå¯¹äºchar (10)ï¼Œè¡¨ç¤ºä½ å­˜å‚¨çš„å­—ç¬¦å°†å 10ä¸ªå­—èŠ‚(åŒ…æ‹¬7ä¸ªç©ºå­—ç¬¦)ï¼Œè€ŒåŒæ ·çš„varchar (10)åˆ™åªå ç”¨3ä¸ªå­—èŠ‚çš„é•¿åº¦ï¼Œ10åªæ˜¯æœ€å¤§å€¼ï¼Œå½“ä½ å­˜å‚¨çš„å­—ç¬¦å°äº10æ—¶ï¼ŒæŒ‰å®é™…é•¿åº¦å­˜å‚¨ï¼‰ varchar æ˜¯å¯å˜é•¿å­—ç¬¦ä¸²ï¼Œä¸ä¼šé¢„å…ˆåˆ†é…å­˜å‚¨ç©ºé—´ï¼Œé•¿åº¦ä¸è¦è¶…è¿‡ 5000ï¼Œå¦‚æœå­˜å‚¨é•¿åº¦å¤§äºæ­¤å€¼ï¼Œå®šä¹‰å­—æ®µç±»å‹ä¸ºtextï¼Œç‹¬ç«‹å‡ºæ¥ä¸€å¼ è¡¨ï¼Œç”¨ä¸»é”®æ¥å¯¹åº”ï¼Œé¿å…å½±å“å…¶å®ƒå­—æ®µç´¢ å¼•æ•ˆç‡ è¡¨å¿…å¤‡ä¸‰å­—æ®µ:id, date_create, date_update ä¸ºé¿å…å…³è¿æŸ¥è¯¢ï¼Œå­—æ®µå…è®¸é€‚å½“å†—ä½™ï¼Œä»¥é«˜æŸ¥è¯¢æ€§èƒ½ï¼Œä½†å¿…é¡»è€ƒè™‘æ•°æ®ä¸€è‡´ã€‚å†—ä½™å­—æ®µåº”éµå¾ª ä¸æ˜¯é¢‘ç¹ä¿®æ”¹çš„å­—æ®µ ä¸æ˜¯ varchar è¶…é•¿å­—æ®µï¼Œæ›´ä¸èƒ½æ˜¯ text å­—æ®µ åˆé€‚çš„å­—ç¬¦å­˜å‚¨é•¿åº¦ï¼Œæ— è´Ÿæ•°çš„æƒ…å†µéœ€è¦ä½¿ç”¨æ— ç¬¦å·ä½å­˜å‚¨ï¼Œæ‰©å¤§è¡¨ç¤ºèŒƒå›´ ç±»å‹ | è¡¨ç¤ºèŒƒå›´ â€” | â€” unsigned tinyint | æ— ç¬¦å·ä½ 0-255 unsigned smallint | æ— ç¬¦å·ä½ 0-65535 unsigned int | æ— ç¬¦å·ä½ çº¦ 0-42.9äº¿ unsigned bigint | æ— ç¬¦å·ä½ çº¦ 0-10çš„19æ¬¡æ–¹ ç´¢å¼• åœ¨varcharå­—æ®µä¸Šå»ºç«‹ç´¢å¼•æ—¶ï¼Œå¿…é¡»æŒ‡å®šç´¢å¼•é•¿åº¦ï¼Œæ²¡å¿…è¦å¯¹å…¨å­—æ®µå»ºç«‹ç´¢å¼•ï¼Œæ ¹æ®å®é™…æ–‡æœ¬åŒºåˆ†åº¦å†³å®šç´¢å¼•é•¿åº¦å³å¯ ä¸šåŠ¡ä¸Šå…·æœ‰å”¯ä¸€ç‰¹æ€§çš„å­—æ®µï¼Œå³ä½¿æ˜¯å¤šä¸ªå­—æ®µçš„ç»„åˆï¼Œä¹Ÿå¿…é¡»å»ºæˆå”¯ä¸€ç´¢å¼• ç´¢å¼•å»ºç«‹éœ€è¦éµå¾ªæœ€å·¦åŒ¹é…åŸåˆ™ã€‚ä¾‹å¦‚ï¼šå»ºç»„åˆç´¢å¼•çš„æ—¶å€™ï¼ŒåŒºåˆ†åº¦æœ€é«˜çš„åœ¨æœ€å·¦è¾¹ SQLæ€§èƒ½ä¼˜åŒ–çš„ç›®æ ‡ï¼šè‡³å°‘è¦è¾¾åˆ°rangeçº§åˆ«ï¼Œè¦æ±‚æ˜¯refçº§åˆ«ï¼Œå¦‚æœå¯ä»¥æ˜¯constsæœ€å¥½ã€‚ consts å•è¡¨ä¸­æœ€å¤šåªæœ‰ä¸€ä¸ªåŒ¹é…è¡Œï¼ˆä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•ï¼‰ï¼Œåœ¨ä¼˜åŒ–é˜¶æ®µå³å¯è¯»å–åˆ°æ•°æ®ã€‚ ref æŒ‡çš„æ˜¯ä½¿ç”¨æ™®é€šçš„ç´¢å¼•ï¼ˆnormal indexï¼‰ ã€‚ range å¯¹ç´¢å¼•è¿›è¡ŒèŒƒå›´æ£€ç´¢ã€‚ explainæ¥è§£é‡Šæ‰§è¡Œè®¡åˆ’ï¼Œtypeåˆ—æŒ‡çš„æ˜¯MySQLåœ¨è¡¨ä¸­æ‰¾åˆ°æ‰€éœ€è¡Œçš„æ–¹å¼ã€‚å¸¸è§ç±»å‹å¦‚ä¸‹ï¼š ALL | index | range |ref |eq_ref | const,system | NULL â€” | â€” | â€” | â€” | â€” | â€” | â€” ALLæ˜¯å…¨è¡¨æ‰«æï¼ŒMySQLè¦éå†å…¨è¡¨æ¥æ‰¾åˆ°åŒ¹é…çš„è¡Œ | ç´¢å¼•å…¨æ‰«æï¼ŒMySQLéå†æ•´ä¸ªç´¢å¼•æ¥æ‰¾åˆ°åŒ¹é…çš„è¡Œ | ç´¢å¼•èŒƒå›´æ‰«æï¼Œä¸€èˆ¬ç”¨äº&lt;ã€&gt;ã€&lt;=ã€&gt;=ã€betweenæ“ä½œ | ä½¿ç”¨éå”¯ä¸€ç´¢å¼•æ‰«ææˆ–è€…å”¯ä¸€ç´¢å¼•çš„å‰ç¼€æ‰«æï¼Œè¿”å›åŒ¹é…å•ç‹¬å€¼çš„è®°å½•è¡Œ | å”¯ä¸€ç´¢å¼•ï¼Œå¯¹äºæ¯ä¸ªé”®å€¼ï¼Œè¡¨ä¸­åªæœ‰ä¸€è¡Œè®°å½•ä¸ä¹‹åŒ¹é… | å•è¡¨åªæœ‰ä¸€ä¸ªåŒ¹é…è¡Œï¼Œä¾‹å¦‚æ ¹æ®ä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•è®°æ€§çš„æŸ¥è¯¢ èŒƒå›´åˆ—å¯ä»¥ç”¨åˆ°ç´¢å¼• èŒƒå›´æ¡ä»¶æœ‰ï¼š&lt;ã€&lt;=ã€&gt;ã€&gt;=ã€betweenç­‰ã€‚ èŒƒå›´åˆ—å¯ä»¥ç”¨åˆ°ç´¢å¼•ï¼Œä½†æ˜¯èŒƒå›´åˆ—åé¢çš„åˆ—æ— æ³•ç”¨åˆ°ç´¢å¼•ï¼Œç´¢å¼•æœ€å¤šç”¨äºä¸€ä¸ªèŒƒå›´åˆ—ï¼Œå¦‚æœæŸ¥ è¯¢æ¡ä»¶ä¸­æœ‰ä¸¤ä¸ªèŒƒå›´åˆ—åˆ™æ— æ³•å…¨ç”¨åˆ°ç´¢å¼•ã€‚ ä¾‹å¦‚ å»ºæœ‰(a,b,c)è”åˆç´¢å¼• where b&gt;0 and a&lt;9 åªæœ‰aç´¢å¼•ä¼šç”Ÿæ•ˆ where b&gt;0 and a=9 a,b ç´¢å¼•ç”Ÿæ•ˆ where a&lt;0 and b=9 åªæœ‰aç´¢å¼•ç”Ÿæ•ˆ where c&lt;0 and b=9 ä¸ç¬¦åˆæœ€å·¦åŸåˆ™ï¼Œç´¢å¼•ä¸ç”Ÿæ•ˆ åˆ†åº“åˆ†è¡¨ å•è¡¨è¡Œæ•°è¶…è¿‡500ä¸‡è¡Œæˆ–è€…å•è¡¨å®¹é‡è¶…è¿‡2GBï¼Œæ‰æ¨èè¿›è¡Œåˆ†åº“åˆ†è¡¨]]></content>
      <categories>
        <category>æ•°æ®åº“</category>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[AVLæ ‘]]></title>
    <url>%2F2018%2F07%2F25%2FAVL%E6%A0%91%2F</url>
    <content type="text"><![CDATA[å¼•è¨€åœ¨ä»‹ç»äºŒå‰å¹³è¡¡æ ‘ä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆäº†è§£ä¸‹äºŒå‰æ ‘ï¼Œä¸‹é¢æ˜¯åŸºäºç»´åŸºç™¾ç§‘å¯¹äºŒå‰æ ‘çš„è§£é‡Š äºŒå‰æ ‘ï¼ˆè‹±è¯­ï¼šBinary treeï¼‰æ˜¯æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šåªæœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼ˆå³ä¸å­˜åœ¨åˆ†æ”¯åº¦å¤§äº2çš„èŠ‚ç‚¹ï¼‰çš„æ ‘ç»“æ„ã€‚é€šå¸¸åˆ†æ”¯è¢«ç§°ä½œâ€œå·¦å­æ ‘â€æˆ–â€œå³å­æ ‘â€ã€‚äºŒå‰æ ‘çš„åˆ†æ”¯å…·æœ‰å·¦å³æ¬¡åºï¼Œä¸èƒ½éšæ„é¢ å€’ äºŒå‰æ ‘çš„ç¬¬iå±‚è‡³å¤šæ‹¥æœ‰2^(i-1)ä¸ªèŠ‚ç‚¹ã€‚æ·±åº¦ä¸ºkçš„äºŒå‰æ ‘è‡³å¤šæ€»å…±æœ‰2^(k+1) - 1ä¸ªèŠ‚ç‚¹ï¼ˆå®šä¹‰æ ¹èŠ‚ç‚¹æ‰€åœ¨æ·±åº¦k0 = 0ï¼‰ï¼Œè€Œæ€»è®¡æ‹¥æœ‰èŠ‚ç‚¹æ•°åŒ¹é…çš„ï¼Œç§°ä¸ºæ»¡äºŒå‰æ ‘ æ·±åº¦ä¸ºkæœ‰nä¸ªèŠ‚ç‚¹çš„äºŒå‰æ ‘ï¼Œå½“ä¸”ä»…å½“å…¶ä¸­çš„æ¯ä¸€èŠ‚ç‚¹ï¼Œéƒ½å¯ä»¥å’ŒåŒæ ·æ·±åº¦kçš„æ»¡äºŒå‰æ ‘ï¼Œåºå·ä¸º1åˆ°nçš„èŠ‚ç‚¹ä¸€å¯¹ä¸€å¯¹åº”æ—¶ï¼Œç§°ä¸ºå®Œå…¨äºŒå‰æ ‘ äºŒå‰æŸ¥æ‰¾æ ‘ï¼ˆè‹±è¯­ï¼šBinary Search Treeï¼‰ï¼Œä¹Ÿç§°ä¸ºäºŒå‰æœç´¢æ ‘ã€æœ‰åºäºŒå‰æ ‘ï¼ˆordered binary treeï¼‰æˆ–æ’åºäºŒå‰æ ‘ï¼ˆsorted binary treeï¼‰ï¼Œæ˜¯æŒ‡ä¸€æ£µç©ºæ ‘æˆ–è€…å…·æœ‰ä¸‹åˆ—æ€§è´¨çš„äºŒå‰æ ‘ï¼š è‹¥ä»»æ„èŠ‚ç‚¹çš„å·¦å­æ ‘ä¸ç©ºï¼Œåˆ™å·¦å­æ ‘ä¸Šæ‰€æœ‰èŠ‚ç‚¹çš„å€¼å‡å°äºå®ƒçš„æ ¹èŠ‚ç‚¹çš„å€¼ï¼› è‹¥ä»»æ„èŠ‚ç‚¹çš„å³å­æ ‘ä¸ç©ºï¼Œåˆ™å³å­æ ‘ä¸Šæ‰€æœ‰èŠ‚ç‚¹çš„å€¼å‡å¤§äºå®ƒçš„æ ¹èŠ‚ç‚¹çš„å€¼ï¼› ä»»æ„èŠ‚ç‚¹çš„å·¦ã€å³å­æ ‘ä¹Ÿåˆ†åˆ«ä¸ºäºŒå‰æŸ¥æ‰¾æ ‘ï¼› æ²¡æœ‰é”®å€¼ç›¸ç­‰çš„èŠ‚ç‚¹ã€‚ äºŒå‰æŸ¥æ‰¾æ ‘ç›¸æ¯”äºå…¶ä»–æ•°æ®ç»“æ„çš„ä¼˜åŠ¿åœ¨äºæŸ¥æ‰¾ã€æ’å…¥çš„æ—¶é—´å¤æ‚åº¦è¾ƒä½ï¼Œä¸ºO(log n)ã€‚ä½†æ˜¯ï¼Œä¸€æ—¦è¿™æ£µäºŒå‰æŸ¥æ‰¾æ ‘æ¼”åŒ–æˆäº†çº¿å‹æ ‘çš„æ—¶å€™ï¼Œæ­¤æ—¶æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¼šé™è‡³O(n)ã€‚ è™½ç„¶äºŒå‰æŸ¥æ‰¾æ ‘çš„æœ€åæ•ˆç‡æ˜¯O(n)ï¼Œä½†æ˜¯ä»–æœ‰å¾ˆå¤šæ”¹è¿›ç‰ˆçš„äºŒå‰æŸ¥æ‰¾æ ‘å¯ä»¥ä½¿æ ‘é«˜ä¸ºO(log n)ï¼Œä»è€Œå°†æœ€åæ•ˆç‡é™è‡³O(log n)ã€‚å¦‚AVLæ ‘ã€çº¢é»‘æ ‘è¿™ä¸¤ç§éƒ½æ˜¯å¹³è¡¡äºŒå‰æ ‘ï¼Œæœ¬æœŸæˆ‘ä»¬å†™çš„å°±æ˜¯AVLæ ‘ã€‚ ä»€ä¹ˆæ˜¯AVLæ ‘åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼ŒAVLæ ‘æ˜¯æœ€æ—©è¢«å‘æ˜çš„è‡ªå¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ã€‚åœ¨AVLæ ‘ä¸­ï¼Œä»»ä¸€èŠ‚ç‚¹å¯¹åº”çš„ä¸¤æ£µå­æ ‘çš„æœ€å¤§é«˜åº¦å·®ä¸º1ï¼ˆè¿™ä¸ªé«˜åº¦å·®å°±æ˜¯ä¸‹æ–‡è¦æåˆ°çš„å¹³è¡¡å› å­ï¼‰ï¼Œå› æ­¤å®ƒä¹Ÿè¢«ç§°ä¸ºé«˜åº¦å¹³è¡¡æ ‘ã€‚æŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤åœ¨å¹³å‡å’Œæœ€åæƒ…å†µä¸‹çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(log n)ã€‚å¢åŠ å’Œåˆ é™¤å…ƒç´ çš„æ“ä½œåˆ™å¯èƒ½éœ€è¦å€Ÿç”±ä¸€æ¬¡æˆ–å¤šæ¬¡æ ‘æ—‹è½¬ï¼Œä»¥å®ç°æ ‘çš„é‡æ–°å¹³è¡¡ã€‚ å¹³è¡¡å› å­èŠ‚ç‚¹çš„å¹³è¡¡å› å­æ˜¯å®ƒçš„å·¦å­æ ‘çš„é«˜åº¦å‡å»å®ƒçš„å³å­æ ‘çš„é«˜åº¦ï¼ˆæœ‰æ—¶ç›¸åï¼‰ã€‚å¸¦æœ‰å¹³è¡¡å› å­1ã€0æˆ– -1çš„èŠ‚ç‚¹è¢«è®¤ä¸ºæ˜¯å¹³è¡¡çš„ã€‚å¸¦æœ‰å¹³è¡¡å› å­-2æˆ–2çš„èŠ‚ç‚¹è¢«è®¤ä¸ºæ˜¯ä¸å¹³è¡¡çš„ï¼Œå¹¶éœ€è¦é‡æ–°å¹³è¡¡è¿™ä¸ªæ ‘ã€‚å¹³è¡¡å› å­å¯ä»¥ç›´æ¥å­˜å‚¨åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸­ï¼Œæˆ–ä»å¯èƒ½å­˜å‚¨åœ¨èŠ‚ç‚¹ä¸­çš„å­æ ‘é«˜åº¦è®¡ç®—å‡ºæ¥ AVL æ—‹è½¬è¿›è¡Œæ—‹è½¬çš„åŸå› å› ä¸ºAVLæ ‘éœ€è¦ç»´æŒèŠ‚ç‚¹çš„å¹³è¡¡å› å­ä¸º1ï¼Œ0ï¼Œ-1ï¼Œå›ºå½“æ’å…¥æ–°èŠ‚ç‚¹å¯¼è‡´å¹³è¡¡å› å­ä¸æ»¡è¶³æ—¶éœ€è¦è¿›è¡Œè°ƒæ•´ä»¥é‡æ–°ç»´æŒAVLæ ‘çš„å¹³è¡¡çŠ¶æ€ï¼Œè¿™ä¸ªè°ƒæ•´è¿‡ç¨‹å°±æ˜¯æ—‹è½¬ æ—‹è½¬åˆ†ç±» å®ç°ç®€å•æè¿°åœ¨å¹³è¡¡çš„äºŒå‰æ’åºæ ‘BBST (Balancing Binary Search Tree)ä¸Šæ’å…¥ä¸€ä¸ªæ–°çš„æ•°æ®å…ƒç´ eçš„é€’å½’ç®—æ³•å¯æè¿°å¦‚ä¸‹ï¼š è‹¥BBSTä¸ºç©ºæ ‘ï¼Œåˆ™æ’å…¥ä¸€ä¸ªæ•°æ®å…ƒç´ ä¸ºeçš„æ–°èŠ‚ç‚¹ä½œä¸ºBBSTçš„æ ¹èŠ‚ç‚¹ï¼Œæ ‘çš„æ·±åº¦å¢1ï¼› è‹¥eçš„å…³é”®å­—å’ŒBBSTçš„æ ¹èŠ‚ç‚¹çš„å…³é”®å­—ç›¸ç­‰ï¼Œåˆ™ä¸è¿›è¡Œï¼› è‹¥eçš„å…³é”®å­—å°äºBBSTçš„æ ¹èŠ‚ç‚¹çš„å…³é”®å­—ï¼Œè€Œä¸”åœ¨BBSTçš„å·¦å­æ ‘ä¸­ä¸å­˜åœ¨å’Œeæœ‰ç›¸åŒå…³é”®å­—çš„èŠ‚ç‚¹ï¼Œåˆ™å°†eæ’å…¥åœ¨BBSTçš„å·¦å­æ ‘ä¸Šï¼Œå¹¶ä¸”å½“æ’å…¥ä¹‹åçš„å·¦å­æ ‘æ·±åº¦å¢åŠ ï¼ˆ+1ï¼‰æ—¶ï¼Œåˆ†åˆ«å°±ä¸‹åˆ—ä¸åŒæƒ…å†µå¤„ç†ä¹‹ï¼š BBSTçš„æ ¹èŠ‚ç‚¹çš„å¹³è¡¡å› å­ä¸º-1ï¼ˆå³å­æ ‘çš„æ·±åº¦å¤§äºå·¦å­æ ‘çš„æ·±åº¦ï¼Œåˆ™å°†æ ¹èŠ‚ç‚¹çš„å¹³è¡¡å› å­æ›´æ”¹ä¸º0ï¼ŒBBSTçš„æ·±åº¦ä¸å˜ï¼› BBSTçš„æ ¹èŠ‚ç‚¹çš„å¹³è¡¡å› å­ä¸º0ï¼ˆå·¦ã€å³å­æ ‘çš„æ·±åº¦ç›¸ç­‰ï¼‰ï¼šåˆ™å°†æ ¹èŠ‚ç‚¹çš„å¹³è¡¡å› å­æ›´æ”¹ä¸º1ï¼ŒBBSTçš„æ·±åº¦å¢1ï¼› BBSTçš„æ ¹èŠ‚ç‚¹çš„å¹³è¡¡å› å­ä¸º1ï¼ˆå·¦å­æ ‘çš„æ·±åº¦å¤§äºå³å­æ ‘çš„æ·±åº¦ï¼‰ï¼šåˆ™è‹¥BBSTçš„å·¦å­æ ‘æ ¹èŠ‚ç‚¹çš„å¹³è¡¡å› å­ä¸º1ï¼šåˆ™éœ€è¿›è¡Œå•å‘å³æ—‹å¹³è¡¡å¤„ç†ï¼Œå¹¶ä¸”åœ¨å³æ—‹å¤„ç†ä¹‹åï¼Œå°†æ ¹èŠ‚ç‚¹å’Œå…¶å³å­æ ‘æ ¹èŠ‚ç‚¹çš„å¹³è¡¡å› å­æ›´æ”¹ä¸º0ï¼Œæ ‘çš„æ·±åº¦ä¸å˜ï¼› è‹¥eçš„å…³é”®å­—å¤§äºBBSTçš„æ ¹èŠ‚ç‚¹çš„å…³é”®å­—ï¼Œè€Œä¸”åœ¨BBSTçš„å³å­æ ‘ä¸­ä¸å­˜åœ¨å’Œeæœ‰ç›¸åŒå…³é”®å­—çš„èŠ‚ç‚¹ï¼Œåˆ™å°†eæ’å…¥åœ¨BBSTçš„å³å­æ ‘ä¸Šï¼Œå¹¶ä¸”å½“æ’å…¥ä¹‹åçš„å³å­æ ‘æ·±åº¦å¢åŠ ï¼ˆ+1ï¼‰æ—¶ï¼Œåˆ†åˆ«å°±ä¸åŒæƒ…å†µå¤„ç†ä¹‹ã€‚ å°¾è¨€æœ¬æ–‡ä»‹ç»äº†AVLè‡ªå¹³è¡¡äºŒå‰æ ‘ï¼Œæ‰€æœ‰æ“ä½œçš„æœ€åå¤æ‚åº¦éƒ½æ˜¯çš„O(log n)ã€‚]]></content>
      <categories>
        <category>æ•°æ®ç»“æ„</category>
      </categories>
      <tags>
        <tag>æ•°æ®ç»“æ„</tag>
        <tag>æ ‘</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring æºç è§£æäºŒï¼ˆBeanFactoryçš„åˆ›å»ºï¼‰]]></title>
    <url>%2F2018%2F03%2F09%2FSpring-IOC-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C%EF%BC%88BeanFactory%E7%9A%84%E5%88%9B%E5%BB%BA%EF%BC%89%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ åœ¨ç¬¬äºŒæœŸä»‹ç»å®¹å™¨çš„refreshæ–¹æ³•å¼€å§‹ä¹‹å‰ï¼Œé¦–å…ˆå¤§å®¶åº”è¯¥å¯¹Springå®¹å™¨çš„æ•´ä¸ªç»§æ‰¿ä½“ç³»æœ‰ä¸ªå¤§æ¦‚çš„äº†è§£ï¼Œä¸ç„¶å°±ä¼šæœ‰é›¾é‡Œçœ‹èŠ±çš„æ„Ÿè§‰ ä¸ºäº†å¸®åŠ©å¤§å®¶ç†æ¸…æ•´ä¸ªç»§æ‰¿ä½“ç³»ï¼Œæˆ‘å°†æ¥ä¸‹æ¥æ‰€è¦æ¶‰åŠåˆ°çš„å‡ ä¸ªé‡è¦ç±»åŠæ¥å£çš„ç»§æ‰¿å…³ç³»è´´ä¸Šæ¥ï¼Œåœ¨é˜…è¯»ä¸­å¦‚æœ‰ç–‘æƒ‘çš„è¯ï¼Œå¯ä»¥å›è¿‡å¤´æ¥çœ‹çœ‹è¿™å‡ å¼ å›¾ XmlWebApplicationContextç”±webå®¹å™¨å¯åŠ¨çš„Springå®¹å™¨ç±»ï¼Œæ³¨æ„ä¸DefaultListableBeanFactoryçš„åŒºåˆ« DefaultListableBeanFactoryå®é™…å®ç°çš„beanå·¥å‚ç±»ï¼Œè·å–beanæ“ä½œçš„æ–¹æ³•éƒ½åœ¨è¿™é‡Œ XmlBeanDefinitionReaderè¯»å–æˆ‘ä»¬é…ç½®æ–‡ä»¶ä¿¡æ¯ BeanFactory æ¥å£åŠå…¶å®ç°ç”±ä»¥ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒBeanFactory æ¥å£å®šä¹‰äº†IOCå®¹å™¨æœ€åŸºæœ¬çš„åŠŸèƒ½è§„èŒƒï¼Œæ˜¯æ¯ä¸€ä¸ªIOCå®¹å™¨éƒ½è¦éµå®ˆçš„åŸºæœ¬è§„èŒƒã€‚å…¶ä¸­æœ€é‡è¦çš„å°±æ˜¯å®šä¹‰äº†getBeanæ–¹æ³•ï¼Œè®©æˆ‘ä»¬å¯ä»¥ä»å®¹å™¨ä¸­æ ¹æ®åå­—æ‹¿åˆ°æ‰€éœ€è¦çš„beanã€‚ è€ŒDefaultListableBeanFactoryå°±æ˜¯å…¶ä¸€ä¸ªé‡è¦å®ç°ï¼Œä¸æˆ‘ä»¬æ¥è§¦ä¹Ÿæ˜¯æœ€å¤šçš„ï¼Œè€ŒXmlWebApplicationContextå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ›´é«˜çº§çš„IOCå®¹å™¨ï¼Œé™¤æ”¯æŒBeanFactoryçš„åŸºæœ¬åŠŸèƒ½å¤–ï¼Œè¿˜æä¾›äº†å¾ˆå¤šæ‰©å±•åŠŸèƒ½ å®¹å™¨ refresh æ–¹æ³•æ¥ç€ä¸ŠèŠ‚ç»§ç»­å¾€ä¸‹è®²refresh æ˜¯æ•´ä¸ªå®¹å™¨å¯åŠ¨çš„æ ¸å¿ƒæ–¹æ³•ï¼Œåœ¨AbstractApplicationContextä¸­ï¼Œå…¶åšçš„äº‹æƒ…ä¸»è¦æœ‰ä¸‰ä¸ªï¼š BeanFactoryçš„åˆ›å»º(DefaultListableBeanFactory) BeanDefinitionçš„Resourceå®šä½ï¼Œè½½å…¥ï¼Œå’Œæ³¨å†Œ åœ¨å®ä¾‹åŒ–Beanä¹‹å‰å¯¹BeanDefinitionè¿›è¡Œä¿®æ”¹(è°ƒç”¨å®ç°äº†æ¥å£BeanFactoryPostProcessorï¼ŒBeanDefinitionRegistryPostProcessorçš„ç±») 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364@Overridepublic void refresh() throws BeansException, IllegalStateException &#123; synchronized (this.startupShutdownMonitor) &#123; // Prepare this context for refreshing. prepareRefresh(); // åˆ›å»ºBeanFactory,å¹¶è½½å…¥BeanDefinitionsï¼ˆé‡è¦ï¼‰ ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); // Prepare the bean factory for use in this context. prepareBeanFactory(beanFactory); try &#123; // Allows post-processing of the bean factory in context subclasses. postProcessBeanFactory(beanFactory); // æ‰§è¡Œ BeanFactoryPostProcessors invokeBeanFactoryPostProcessors(beanFactory); // æ³¨å†Œ BeanPostProcessors registerBeanPostProcessors(beanFactory); // Initialize message source for this context. initMessageSource(); // Initialize event multicaster for this context. initApplicationEventMulticaster(); // Initialize other special beans in specific context subclasses. onRefresh(); // Check for listener beans and register them. registerListeners(); // æå‰å®ä¾‹åŒ–åŒ–å…¨éƒ¨å»¶è¿ŸåŠ è½½çš„å•ä¾‹ç±»å‹ finishBeanFactoryInitialization(beanFactory); // Last step: publish corresponding event. finishRefresh(); &#125; catch (BeansException ex) &#123; if (logger.isWarnEnabled()) &#123; logger.warn(&quot;Exception encountered during context initialization - &quot; + &quot;cancelling refresh attempt: &quot; + ex); &#125; // Destroy already created singletons to avoid dangling resources. destroyBeans(); // Reset &apos;active&apos; flag. cancelRefresh(ex); // Propagate exception to caller. throw ex; &#125; finally &#123; // Reset common introspection caches in Spring&apos;s core, since we // might not ever need metadata for singleton beans anymore... resetCommonCaches(); &#125; &#125;&#125; obtainFreshBeanFactory()obtainFreshBeanFactory() ä¹Ÿåœ¨ AbstractApplicationContextç±»ä¸­ï¼Œä¸»è¦é€»è¾‘åœ¨refreshBeanFactory æ–¹æ³•ä¸­ 12345678protected ConfigurableListableBeanFactory obtainFreshBeanFactory() &#123; refreshBeanFactory(); ConfigurableListableBeanFactory beanFactory = getBeanFactory(); if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Bean factory for &quot; + getDisplayName() + &quot;: &quot; + beanFactory); &#125; return beanFactory;&#125; refreshBeanFactory() (AbstractRefreshableApplicationContext)è¿™é‡Œåšçš„äº‹æƒ…ä¸»è¦æœ‰2ä¸ªï¼š 1.åˆ›å»ºBeanFactory (createBeanFactory())2.è½½å…¥BeanDefinitions (loadBeanDefinitions(beanFactory)) 123456789101112131415161718protected final void refreshBeanFactory() throws BeansException &#123; if (hasBeanFactory()) &#123; destroyBeans(); closeBeanFactory(); &#125; try &#123; DefaultListableBeanFactory beanFactory = createBeanFactory(); beanFactory.setSerializationId(getId()); customizeBeanFactory(beanFactory); loadBeanDefinitions(beanFactory); synchronized (this.beanFactoryMonitor) &#123; this.beanFactory = beanFactory; &#125; &#125; catch (IOException ex) &#123; throw new ApplicationContextException(&quot;I/O error parsing bean definition source for &quot; + getDisplayName(), ex); &#125;&#125; createBeanFactory()ä»è¿™é‡Œå¯ä»¥çŸ¥é“å®¹å™¨æ‰€ä½¿ç”¨çš„BeanFactoryå®ç°ç±»æ˜¯ DefaultListableBeanFactory123protected DefaultListableBeanFactory createBeanFactory() &#123; return new DefaultListableBeanFactory(getInternalParentBeanFactory());&#125; loadBeanDefinitions(beanFactory) (XmlWebApplicationContext)è¿™ä¸ªæ–¹æ³•æ˜¯åœ¨XmlWebApplicationContextå®ç°çš„ï¼ŒSpringéšå¤„å¯è§çˆ¶ç±»è°ƒç”¨å­ç±»çš„è®¾è®¡æ¨¡å¼ï¼ˆæ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼ï¼‰ åœ¨è§£æloadBeanDefinitionsæ–¹æ³•ä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆäº†è§£BeanDefinitionåœ¨Springä¸­æ‰€è¡¨ç¤ºçš„æ¦‚å¿µ ï¼ˆé€šä¿—çš„ç†è§£å¯ä»¥è¯´æ˜¯beançš„æŠ½è±¡æ•°æ®ç»“æ„ï¼Œå®ƒåŒ…æ‹¬å±æ€§å‚æ•°ï¼Œæ„é€ å™¨å‚æ•°ï¼Œä»¥åŠå…¶ä»–å…·ä½“çš„å‚æ•°ï¼Œå°±æ˜¯æˆ‘ä»¬ä»é…ç½®ä¿¡æ¯ä¸­è¯»å‡ºæ¥Beançš„æŠ½è±¡æ•°æ®ç»“æ„ï¼‰æœ‰å…´è¶£çš„å¯ä»¥å»çœ‹çœ‹BeanDefinitionçš„æ•°æ®ç»“æ„ã€‚ 123456789101112131415protected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException &#123; // åˆ›å»ºä¸€ä¸ªXmlBeanDefinitionReaderï¼Œç”¨æ¥è¯»å–é…ç½®æ–‡ä»¶é…ç½®çš„Beanä¿¡æ¯ï¼Œè§£ææˆbeanDefinitionï¼Œå¹¶é…ç½®beanFactory æ–¹ä¾¿å›è°ƒ XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory); // é…ç½®XmlBeanDefinitionReaderçš„ä¸€äº›åŸºæœ¬é…ç½® beanDefinitionReader.setEnvironment(getEnvironment()); // é…ç½®ResourceLoaderï¼ˆXmlWebApplicationContext æ˜¯å®ç°äº†ResourceLoaderæ¥å£çš„ï¼Œä¸æ¸…æ¥šçš„å¯ä»¥ä¸Šå›¾çš„ç»§æ‰¿é“¾ï¼‰ beanDefinitionReader.setResourceLoader(this); beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this)); // Allow a subclass to provide custom initialization of the reader, // è¿™é‡Œæ²¡åšä»»ä½•äº‹æƒ… initBeanDefinitionReader(beanDefinitionReader); loadBeanDefinitions(beanDefinitionReader);&#125; loadBeanDefinitions(XmlBeanDefinitionReader reader)XmlBeanDefinitionReader æ ¹æ®é…ç½®æ–‡ä»¶ä½ç½®è°ƒç”¨ loadBeanDefinitions12345678protected void loadBeanDefinitions(XmlBeanDefinitionReader reader) throws IOException &#123; String[] configLocations = getConfigLocations(); if (configLocations != null) &#123; for (String configLocation : configLocations) &#123; reader.loadBeanDefinitions(configLocation); &#125; &#125;&#125; å°¾è¨€ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çŸ¥é“äº†IOCå®¹å™¨çš„åˆ›å»ºï¼Œä»¥åŠBeanDefinitionæ˜¯åœ¨å“ªé‡Œè¢«åŠ è½½çš„ã€‚æ¥ä¸‹æ¥è¦è®²çš„è‡ªç„¶å°±æ˜¯é…ç½®ä¿¡æ¯æ˜¯å¦‚ä½•è¢«è§£æåŠ è½½çš„ï¼Œä»¥åŠå¦‚ä½•æ³¨å†Œè¿›BeanFactoryçš„ã€‚see =&gt; ä¸‹æœŸ]]></content>
      <categories>
        <category>javaæ¡†æ¶</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring æºç è§£æä¸€ï¼ˆIOCå®¹å™¨çš„åˆ›å»ºï¼‰]]></title>
    <url>%2F2018%2F02%2F28%2FSpring-IOC-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%80%EF%BC%88IOC%E5%AE%B9%E5%99%A8%E7%9A%84%E5%88%9B%E5%BB%BA%EF%BC%89%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ Springæºç å€¼å¾—æ¯ä¸€ä¸ªç¨‹åºå‘˜å»ç ”è¯»ï¼Œä¸ä»…ä»…å› ä¸ºå¥¹æ˜¯æœ€å¸¸ç”¨çš„æ¡†æ¶ï¼Œæ›´å› ä¸ºå¥¹æ‰€ä½“ç°çš„ç¼–ç æ€æƒ³ æœ¬æ–‡ä¸»è¦ä»‹ç»webåº”ç”¨å¯åŠ¨æ—¶Springå®¹å™¨çš„åˆ›å»ºè¿‡ç¨‹ Spring å¯åŠ¨ç›‘å¬æœ€ç»ˆå…¥å£ 123&lt;listener&gt; &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;&lt;/listener&gt; ContextLoaderListener(org.springframework.web.context.ContextLoaderListener) è¿™é‡Œçš„contextInitialized æ–¹æ³•ä¼šåœ¨webå®¹å™¨å¯åŠ¨æ—¶è¢«è°ƒç”¨ï¼Œä»è€Œå¯åŠ¨æ•´ä¸ªspringå®¹å™¨çš„åˆ›å»º1234@Overridepublic void contextInitialized(ServletContextEvent event) &#123; initWebApplicationContext(event.getServletContext());&#125; ContextLoader(org.springframework.web.context.ContextLoader)ä¸»è¦æœ‰ initWebApplicationContextï¼ŒdetermineContextClassï¼ŒcreateWebApplicationContextï¼ŒconfigureAndRefreshWebApplicationContext è¿™å››ä¸ªæ–¹æ³•çš„æ‰§è¡Œ initWebApplicationContextåˆå§‹åŒ–è¿‡ç¨‹å…¥å£ï¼ˆä¸»è¦æ˜¯åˆ›å»ºå®¹å™¨çš„è¿‡ç¨‹ï¼‰123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566public WebApplicationContext initWebApplicationContext(ServletContext servletContext) &#123; if (servletContext.getAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE) != null) &#123; throw new IllegalStateException( &quot;Cannot initialize context because there is already a root application context present - &quot; + &quot;check whether you have multiple ContextLoader* definitions in your web.xml!&quot;); &#125; Log logger = LogFactory.getLog(ContextLoader.class); servletContext.log(&quot;Initializing Spring root WebApplicationContext&quot;); if (logger.isInfoEnabled()) &#123; logger.info(&quot;Root WebApplicationContext: initialization started&quot;); &#125; long startTime = System.currentTimeMillis(); try &#123; // Store context in local instance variable, to guarantee that // it is available on ServletContext shutdown. if (this.context == null) &#123; this.context = createWebApplicationContext(servletContext); &#125; if (this.context instanceof ConfigurableWebApplicationContext) &#123; ConfigurableWebApplicationContext cwac = (ConfigurableWebApplicationContext) this.context; if (!cwac.isActive()) &#123; // The context has not yet been refreshed -&gt; provide services such as // setting the parent context, setting the application context id, etc if (cwac.getParent() == null) &#123; // The context instance was injected without an explicit parent -&gt; // determine parent for root web application context, if any. ApplicationContext parent = loadParentContext(servletContext); cwac.setParent(parent); &#125; configureAndRefreshWebApplicationContext(cwac, servletContext); &#125; &#125; servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, this.context); ClassLoader ccl = Thread.currentThread().getContextClassLoader(); if (ccl == ContextLoader.class.getClassLoader()) &#123; currentContext = this.context; &#125; else if (ccl != null) &#123; currentContextPerThread.put(ccl, this.context); &#125; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Published root WebApplicationContext as ServletContext attribute with name [&quot; + WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE + &quot;]&quot;); &#125; if (logger.isInfoEnabled()) &#123; long elapsedTime = System.currentTimeMillis() - startTime; logger.info(&quot;Root WebApplicationContext: initialization completed in &quot; + elapsedTime + &quot; ms&quot;); &#125; return this.context; &#125; catch (RuntimeException ex) &#123; logger.error(&quot;Context initialization failed&quot;, ex); servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, ex); throw ex; &#125; catch (Error err) &#123; logger.error(&quot;Context initialization failed&quot;, err); servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, err); throw err; &#125;&#125; createWebApplicationContextåˆ›å»ºå®¹å™¨ï¼Œéœ€è¦çŸ¥é“æˆ‘ä»¬é»˜è®¤åˆ›å»ºçš„springå®¹å™¨æ˜¯å“ªä¸ªï¼Ÿ åœ¨determineContextClassä¸­è·å–123456789protected WebApplicationContext createWebApplicationContext(ServletContext sc) &#123; // è·å–å®¹å™¨classå¯¹è±¡ Class&lt;?&gt; contextClass = determineContextClass(sc); if (!ConfigurableWebApplicationContext.class.isAssignableFrom(contextClass)) &#123; throw new ApplicationContextException(&quot;Custom context class [&quot; + contextClass.getName() + &quot;] is not of type [&quot; + ConfigurableWebApplicationContext.class.getName() + &quot;]&quot;); &#125; return (ConfigurableWebApplicationContext) BeanUtils.instantiateClass(contextClass);&#125; determineContextClasså…ˆå°è¯•ä»servletä¸Šä¸‹æ–‡è·å–å®¹å™¨ç±»åï¼Œä¸€èˆ¬æˆ‘ä»¬éƒ½ä¸ä¼šå»é…ã€‚æ‰€ä»¥ä¸€èˆ¬éƒ½åœ¨è¿™é‡Œreturn ClassUtils.forName(contextClassName, ClassUtils.getDefaultClassLoader());è·å–åˆ°å®é™…çš„å®¹å™¨ï¼Œè¿™é‡Œå®é™…ä¸Šä¼šå»è¯»å–é…ç½®æ–‡ä»¶ContextLoader.propertiesï¼Œæ‰¾åˆ°å®é™…å¯åŠ¨çš„å®¹å™¨ç±»ä¸ºorg.springframework.web.context.support.XmlWebApplicationContext12345678910111213141516171819202122protected Class&lt;?&gt; determineContextClass(ServletContext servletContext) &#123; String contextClassName = servletContext.getInitParameter(CONTEXT_CLASS_PARAM); if (contextClassName != null) &#123; try &#123; return ClassUtils.forName(contextClassName, ClassUtils.getDefaultClassLoader()); &#125; catch (ClassNotFoundException ex) &#123; throw new ApplicationContextException( &quot;Failed to load custom context class [&quot; + contextClassName + &quot;]&quot;, ex); &#125; &#125; else &#123; contextClassName = defaultStrategies.getProperty(WebApplicationContext.class.getName()); try &#123; return ClassUtils.forName(contextClassName, ContextLoader.class.getClassLoader()); &#125; catch (ClassNotFoundException ex) &#123; throw new ApplicationContextException( &quot;Failed to load default context class [&quot; + contextClassName + &quot;]&quot;, ex); &#125; &#125;&#125; configureAndRefreshWebApplicationContextçœ‹åå­—ï¼Œé¡¾åæ€ä¹‰ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯åœ¨å®¹å™¨åˆ›å»ºå®Œæˆä¹‹åï¼Œè¿›è¡Œç›¸å…³é…ç½®å¹¶åˆå§‹åŒ–åˆ·æ–°å®¹å™¨ã€‚å…¶ä¸­æœ€é‡è¦çš„å°±æ˜¯è·å–æˆ‘ä»¬åœ¨web.xmlä¸­é…ç½®çš„Springé…ç½®æ–‡ä»¶ä¿¡æ¯ï¼Œç„¶åæ‰§è¡Œ refresh æ–¹æ³•åˆ·æ–°å®¹å™¨123456789101112131415161718192021222324252627282930313233protected void configureAndRefreshWebApplicationContext(ConfigurableWebApplicationContext wac, ServletContext sc) &#123; if (ObjectUtils.identityToString(wac).equals(wac.getId())) &#123; // The application context id is still set to its original default value // -&gt; assign a more useful id based on available information String idParam = sc.getInitParameter(CONTEXT_ID_PARAM); if (idParam != null) &#123; wac.setId(idParam); &#125; else &#123; // Generate default id... wac.setId(ConfigurableWebApplicationContext.APPLICATION_CONTEXT_ID_PREFIX + ObjectUtils.getDisplayString(sc.getContextPath())); &#125; &#125; wac.setServletContext(sc); // æ‰¾åˆ°é…ç½®æ–‡ä»¶ æˆ‘ä»¬åœ¨web.xmlä¸­é…ç½®çš„Springé…ç½®æ–‡ä»¶ä½ç½® String configLocationParam = sc.getInitParameter(CONFIG_LOCATION_PARAM); if (configLocationParam != null) &#123; wac.setConfigLocation(configLocationParam); &#125; // The wac environment&apos;s #initPropertySources will be called in any case when the context // is refreshed; do it eagerly here to ensure servlet property sources are in place for // use in any post-processing or initialization that occurs below prior to #refresh ConfigurableEnvironment env = wac.getEnvironment(); if (env instanceof ConfigurableWebEnvironment) &#123; ((ConfigurableWebEnvironment) env).initPropertySources(sc, null); &#125; customizeContext(sc, wac); wac.refresh();&#125; å°¾è¨€ åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œæˆ‘ä»¬çŸ¥é“äº†Spring å¯åŠ¨çš„å®¹å™¨ç±»æ˜¯ XmlWebApplicationContextï¼Œåœ¨ä¸‹ä¸€èŠ‚æˆ‘ä»¬ä¼šç€é‡è§£æå®¹å™¨çš„ refresh æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æ•´ä¸ªspring iocå®¹å™¨çš„ç²¾é«“æ‰€åœ¨]]></content>
      <categories>
        <category>javaæ¡†æ¶</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æµ…æè®¡ç®—æœºå­—ç¬¦é›†å’Œç¼–ç ]]></title>
    <url>%2F2017%2F09%2F14%2F%E6%B5%85%E6%9E%90%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AD%97%E7%AC%A6%E9%9B%86%E5%92%8C%E7%BC%96%E7%A0%81%2F</url>
    <content type="text"><![CDATA[ä»€ä¹ˆæ˜¯å­—ç¬¦é›†å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨è®¡ç®—æœºå†…éƒ¨ï¼Œæ‰€æœ‰ä¿¡æ¯éƒ½æ˜¯äºŒè¿›åˆ¶è¡¨ç¤ºçš„ï¼ŒäºŒè¿›åˆ¶å¯¹äºè®¡ç®—æœºæ¥è¯´æ˜¯æä¸ºé‡è¦çš„ï¼Œå¯ä»¥æƒ³è±¡æˆä¸€ä¸ªå¼€å…³çš„é—­å¼€ä¿¡å·ï¼Œåªæœ‰ 0 1ä¸¤ç§çŠ¶æ€ã€‚è®¡ç®—æœºä¸­ 8ä¸ªäºŒè¿›åˆ¶ï¼ˆ8ä½ï¼‰ä»£è¡¨ä¸€ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªå­—èŠ‚å¯ä»¥ä»£è¡¨256ç§å¯èƒ½ï¼Œäºæ˜¯ä¸Šä¸ªä¸–çºª60å¹´ä»£ï¼Œç¾å›½åˆ¶å®šäº†ä¸€å¥—å­—ç¬¦é›†ï¼Œå¯¹è‹±è¯­å­—ç¬¦ä¸äºŒè¿›åˆ¶ä½ä¹‹é—´çš„å…³ç³»ï¼Œåšäº†ç»Ÿä¸€è§„å®šã€‚è¿™è¢«ç§°ä¸ºASCIIç ï¼Œä¸€ç›´æ²¿ç”¨è‡³ä»Šï¼ŒASCIIç ä¸€å…±è§„å®šäº†128ä¸ªå­—ç¬¦çš„ç¼–ç ï¼Œæ¯”å¦‚ç©ºæ ¼â€SPACEâ€æ˜¯32ï¼ˆäºŒè¿›åˆ¶00100000ï¼‰ï¼Œå¤§å†™çš„å­—æ¯Aæ˜¯65ï¼ˆäºŒè¿›åˆ¶01000001ï¼‰ã€‚è¿™128ä¸ªç¬¦å·ï¼ˆåŒ…æ‹¬32ä¸ªä¸èƒ½æ‰“å°å‡ºæ¥çš„æ§åˆ¶ç¬¦å·ï¼‰ï¼Œåªå ç”¨äº†ä¸€ä¸ªå­—èŠ‚çš„åé¢7ä½ï¼Œæœ€å‰é¢çš„1ä½ç»Ÿä¸€è§„å®šä¸º0ã€‚ è‹±è¯­ç”¨128ä¸ªå­—ç¬¦å°±å¤Ÿäº†ï¼Œä½†æ˜¯ä¸–ç•Œä¸Šè¿˜æœ‰å„ç§å„æ ·çš„è¯­è¨€å­—ç¬¦ï¼Œå¦‚ä¸­æ–‡ï¼Œå°±æœ‰ä¸Šä¸‡ä¸ªã€‚è¿™æ ·å­ï¼Œå³ä½¿æ˜¯256ä¸ªä¹Ÿä¸å¤Ÿç”¨ï¼Œè€Œä¸”ä¹Ÿæ— æ³•ç»Ÿä¸€ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªäºŒè¿›åˆ¶æ•°å¯èƒ½ä¼šå¯¹åº”ç€å„ä¸ªå›½å®¶ä¸åŒçš„ç¬¦å·ï¼Œè¿™æ ·å­æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œå¦‚æœä¸çŸ¥é“è¿™ä¸ªæ–‡ä»¶çš„ç¼–ç æ–¹å¼ï¼Œé‚£å°±ä¼šä¹±ç ï¼Œå®Œå…¨çœ‹ä¸æ‡‚ã€‚ è¿™æ ·å­ï¼ŒUnicode å­—ç¬¦é›†å°±å‡ºç°äº†ï¼Œå®ƒå°†ä¸–ç•Œä¸Šæ‰€æœ‰çš„å­—ç¬¦éƒ½çº³å…¥å…¶ä¸­äº†ï¼Œåœ¨unicodeå­—ç¬¦é›†ä¸­ï¼Œæ¯ä¸€ä¸ªç¬¦å·éƒ½å¯¹åº”ç€ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ç¼–ç ,å¦‚4E25è¡¨ç¤ºæ±‰å­—ä¸¥ Unicodeçš„é—®é¢˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒUnicodeåªæ˜¯ä¸€ä¸ªç¬¦å·é›†ï¼Œå®ƒåªè§„å®šäº†ç¬¦å·çš„äºŒè¿›åˆ¶ä»£ç ï¼Œå´æ²¡æœ‰è§„å®šè¿™ä¸ªäºŒè¿›åˆ¶ä»£ç åº”è¯¥å¦‚ä½•å­˜å‚¨ã€‚æ¯”å¦‚ï¼Œæ±‰å­—ä¸¥çš„unicodeæ˜¯åå…­è¿›åˆ¶æ•°4E25ï¼Œè½¬æ¢æˆäºŒè¿›åˆ¶æ•°è¶³è¶³æœ‰15ä½ï¼ˆ100111000100101ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªç¬¦å·çš„è¡¨ç¤ºè‡³å°‘éœ€è¦2ä¸ªå­—èŠ‚ã€‚è¡¨ç¤ºå…¶ä»–æ›´å¤§çš„ç¬¦å·ï¼Œå¯èƒ½éœ€è¦3ä¸ªå­—èŠ‚æˆ–è€…4ä¸ªå­—èŠ‚ï¼Œç”šè‡³æ›´å¤šã€‚è¿™é‡Œå°±æœ‰ä¸¤ä¸ªä¸¥é‡çš„é—®é¢˜ï¼š ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚ä½•æ‰èƒ½åŒºåˆ«Unicodeå’ŒASCIIï¼Ÿè®¡ç®—æœºæ€ä¹ˆçŸ¥é“ä¸‰ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªç¬¦å·ï¼Œè€Œä¸æ˜¯åˆ†åˆ«è¡¨ç¤ºä¸‰ä¸ªç¬¦å·å‘¢ï¼Ÿ ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œè‹±æ–‡å­—æ¯åªç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºå°±å¤Ÿäº†ï¼Œå¦‚æœUnicodeç»Ÿä¸€è§„å®šï¼Œæ¯ä¸ªç¬¦å·ç”¨ä¸‰ä¸ªæˆ–å››ä¸ªå­—èŠ‚è¡¨ç¤ºï¼Œé‚£ä¹ˆæ¯ä¸ªè‹±æ–‡å­—æ¯å‰éƒ½å¿…ç„¶æœ‰äºŒåˆ°ä¸‰ä¸ªå­—èŠ‚æ˜¯0ï¼Œè¿™å¯¹äºå­˜å‚¨æ¥è¯´æ˜¯æå¤§çš„æµªè´¹ï¼Œæ–‡æœ¬æ–‡ä»¶çš„å¤§å°ä¼šå› æ­¤å¤§å‡ºäºŒä¸‰å€ï¼Œè¿™æ˜¯æ— æ³•æ¥å—çš„ã€‚ å®ƒä»¬é€ æˆçš„ç»“æœæ˜¯ï¼š å‡ºç°äº†Unicodeçš„å¤šç§å­˜å‚¨æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰è®¸å¤šç§ä¸åŒçš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºUnicodeã€‚ Unicodeåœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…æ— æ³•æ¨å¹¿ï¼Œç›´åˆ°äº’è”ç½‘çš„å‡ºç°ã€‚ ç¼–ç å’Œå­—ç¬¦é›†çš„åŒºåˆ«å¦‚ä¸Šæ–‡æ‰€è¯´ï¼Œç¬¦å·é›†åªè§„å®šäº†ç¬¦å·çš„äºŒè¿›åˆ¶ä»£ç ï¼Œå´æ²¡æœ‰è§„å®šè¿™ä¸ªäºŒè¿›åˆ¶ä»£ç åº”è¯¥å¦‚ä½•å­˜å‚¨ï¼Œè€Œç¼–ç åˆ™å¯ä»¥è¯´æ˜¯æŒ‡å®šå­—ç¬¦é›†çš„å…·ä½“å®ç°æ–¹å¼ï¼Œå¦‚ UTF-8ï¼ŒUTF-16å°±æ˜¯Unicodeå­—ç¬¦é›†çš„å®ç°æ–¹å¼ UTF-8äº’è”ç½‘çš„æ™®åŠï¼Œå¼ºçƒˆè¦æ±‚å‡ºç°ä¸€ç§ç»Ÿä¸€çš„ç¼–ç æ–¹å¼ã€‚UTF-8å°±æ˜¯åœ¨äº’è”ç½‘ä¸Šä½¿ç”¨æœ€å¹¿çš„ä¸€ç§Unicodeçš„å®ç°æ–¹å¼ã€‚å…¶ä»–å®ç°æ–¹å¼è¿˜åŒ…æ‹¬UTF-16ï¼ˆå­—ç¬¦ç”¨ä¸¤ä¸ªå­—èŠ‚æˆ–å››ä¸ªå­—èŠ‚è¡¨ç¤ºï¼‰å’ŒUTF-32ï¼ˆå­—ç¬¦ç”¨å››ä¸ªå­—èŠ‚è¡¨ç¤ºï¼‰ï¼Œä¸è¿‡åœ¨äº’è”ç½‘ä¸ŠåŸºæœ¬ä¸ç”¨ã€‚é‡å¤ä¸€éï¼Œè¿™é‡Œçš„å…³ç³»æ˜¯ï¼ŒUTF-8æ˜¯Unicodeçš„å®ç°æ–¹å¼ä¹‹ä¸€ã€‚UTF-8æœ€å¤§çš„ä¸€ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯å®ƒæ˜¯ä¸€ç§å˜é•¿çš„ç¼–ç æ–¹å¼ã€‚å®ƒå¯ä»¥ä½¿ç”¨1~4ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªç¬¦å·ï¼Œæ ¹æ®ä¸åŒçš„ç¬¦å·è€Œå˜åŒ–å­—èŠ‚é•¿åº¦ã€‚UTF-8çš„ç¼–ç è§„åˆ™å¾ˆç®€å•ï¼Œåªæœ‰äºŒæ¡ï¼š å¯¹äºå•å­—èŠ‚çš„ç¬¦å·ï¼Œå­—èŠ‚çš„ç¬¬ä¸€ä½è®¾ä¸º0ï¼Œåé¢7ä½ä¸ºè¿™ä¸ªç¬¦å·çš„unicodeç ã€‚å› æ­¤å¯¹äºè‹±è¯­å­—æ¯ï¼ŒUTF-8ç¼–ç å’ŒASCIIç æ˜¯ç›¸åŒçš„ã€‚ å¯¹äºnå­—èŠ‚çš„ç¬¦å·ï¼ˆn&gt;1ï¼‰ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚çš„å‰nä½éƒ½è®¾ä¸º1ï¼Œç¬¬n+1ä½è®¾ä¸º0ï¼Œåé¢å­—èŠ‚çš„å‰ä¸¤ä½ä¸€å¾‹è®¾ä¸º10ã€‚å‰©ä¸‹çš„æ²¡æœ‰æåŠçš„äºŒè¿›åˆ¶ä½ï¼Œå…¨éƒ¨ä¸ºè¿™ä¸ªç¬¦å·çš„unicodeç ã€‚ ä¸‹è¡¨æ€»ç»“äº†ç¼–ç è§„åˆ™ï¼Œå­—æ¯xè¡¨ç¤ºå¯ç”¨ç¼–ç çš„ä½ã€‚ Unicodeç¬¦å·èŒƒå›´(åå…­è¿›åˆ¶) UTF-8ç¼–ç æ–¹å¼ï¼ˆäºŒè¿›åˆ¶ï¼‰ 0000 0000-0000 007F 0xxxxxxx 0000 0080-0000 07FF 110xxxxx 10xxxxxx 0000 0800-0000 FFFF 1110xxxx 10xxxxxx 10xxxxxx 0001 0000-0010 FFFF 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx è·Ÿæ®ä¸Šè¡¨ï¼Œè§£è¯»UTF-8ç¼–ç éå¸¸ç®€å•ã€‚å¦‚æœä¸€ä¸ªå­—èŠ‚çš„ç¬¬ä¸€ä½æ˜¯0ï¼Œåˆ™è¿™ä¸ªå­—èŠ‚å•ç‹¬å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ï¼›å¦‚æœç¬¬ä¸€ä½æ˜¯1ï¼Œåˆ™è¿ç»­æœ‰å¤šå°‘ä¸ª1ï¼Œå°±è¡¨ç¤ºå½“å‰å­—ç¬¦å ç”¨å¤šå°‘ä¸ªå­—èŠ‚ã€‚ä¸‹é¢ï¼Œè¿˜æ˜¯ä»¥æ±‰å­—ä¸¥ä¸ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•å®ç°UTF-8ç¼–ç ã€‚å·²çŸ¥ä¸¥çš„unicodeæ˜¯4E25ï¼ˆ100111000100101ï¼‰ï¼Œæ ¹æ®ä¸Šè¡¨ï¼Œå¯ä»¥å‘ç°4E25å¤„åœ¨ç¬¬ä¸‰è¡Œçš„èŒƒå›´å†…ï¼ˆ0000 0800-0000 FFFFï¼‰ï¼Œå› æ­¤ä¸¥çš„UTF-8ç¼–ç éœ€è¦ä¸‰ä¸ªå­—èŠ‚ï¼Œå³æ ¼å¼æ˜¯1110xxxx 10xxxxxx 10xxxxxxã€‚ç„¶åï¼Œä»ä¸¥çš„æœ€åä¸€ä¸ªäºŒè¿›åˆ¶ä½å¼€å§‹ï¼Œä¾æ¬¡ä»åå‘å‰å¡«å…¥æ ¼å¼ä¸­çš„xï¼Œå¤šå‡ºçš„ä½è¡¥0ã€‚è¿™æ ·å°±å¾—åˆ°äº†ï¼Œä¸¥çš„UTF-8ç¼–ç æ˜¯11100100 10111000 10100101ï¼Œè½¬æ¢æˆåå…­è¿›åˆ¶å°±æ˜¯E4B8A5ã€‚ Little endianå’ŒBig endianUnicodeç å¯ä»¥é‡‡ç”¨ä¸¤ä¸ªå­—èŠ‚æ ¼å¼ç›´æ¥å­˜å‚¨ã€‚ä»¥æ±‰å­—ä¸¥ä¸ºä¾‹ï¼ŒUnicodeç æ˜¯4E25ï¼Œéœ€è¦ç”¨ä¸¤ä¸ªå­—èŠ‚å­˜å‚¨ï¼Œä¸€ä¸ªå­—èŠ‚æ˜¯4Eï¼Œå¦ä¸€ä¸ªå­—èŠ‚æ˜¯25ã€‚å­˜å‚¨çš„æ—¶å€™ï¼Œ4Eåœ¨å‰ï¼Œ25åœ¨åï¼Œå°±æ˜¯Big endianæ–¹å¼ï¼›25åœ¨å‰ï¼Œ4Eåœ¨åï¼Œå°±æ˜¯Little endianæ–¹å¼ã€‚å› æ­¤ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚åœ¨å‰ï¼Œå°±æ˜¯&quot;å¤§å¤´æ–¹å¼&quot;ï¼ˆBig endianï¼‰ï¼Œç¬¬äºŒä¸ªå­—èŠ‚åœ¨å‰å°±æ˜¯&quot;å°å¤´æ–¹å¼&quot;ï¼ˆLittle endianï¼‰ã€‚é‚£ä¹ˆå¾ˆè‡ªç„¶çš„ï¼Œå°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼šè®¡ç®—æœºæ€ä¹ˆçŸ¥é“æŸä¸€ä¸ªæ–‡ä»¶åˆ°åº•é‡‡ç”¨å“ªä¸€ç§æ–¹å¼ç¼–ç ï¼ŸUnicodeè§„èŒƒä¸­å®šä¹‰ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶çš„æœ€å‰é¢åˆ†åˆ«åŠ å…¥ä¸€ä¸ªè¡¨ç¤ºç¼–ç é¡ºåºçš„å­—ç¬¦ï¼ˆBOMå¤´ï¼‰ï¼Œè¿™ä¸ªå­—ç¬¦çš„åå­—å«åšâ€é›¶å®½åº¦éæ¢è¡Œç©ºæ ¼â€ï¼ˆZERO WIDTH NO-BREAK SPACEï¼‰ï¼Œç”¨FEFFè¡¨ç¤ºã€‚è¿™æ­£å¥½æ˜¯ä¸¤ä¸ªå­—èŠ‚ï¼Œè€Œä¸”FFæ¯”FEå¤§1ã€‚å¦‚æœä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶çš„å¤´ä¸¤ä¸ªå­—èŠ‚æ˜¯FE FFï¼Œå°±è¡¨ç¤ºè¯¥æ–‡ä»¶é‡‡ç”¨å¤§å¤´æ–¹å¼ï¼›å¦‚æœå¤´ä¸¤ä¸ªå­—èŠ‚æ˜¯FF FEï¼Œå°±è¡¨ç¤ºè¯¥æ–‡ä»¶é‡‡ç”¨å°å¤´æ–¹å¼ã€‚]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
        <category>ç¼–ç </category>
      </categories>
      <tags>
        <tag>ç¼–ç </tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[CAS å•ç‚¹ç™»å½•åŸç†è§£æ]]></title>
    <url>%2F2017%2F05%2F19%2FCAS-%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90%2F</url>
    <content type="text"><![CDATA[å¼•è¨€CASæ˜¯è€¶é²å¤§å­¦å‘èµ·çš„ä¸€ä¸ªå¼€æºå•ç‚¹ç™»å½•é¡¹ç›®ï¼Œä¹Ÿæ˜¯ç”¨çš„æœ€ä¸ºå¹¿æ³›çš„å¼€æºé¡¹ç›®ã€‚å¯¹äºå­¦ä¹ SSOæœ‰éå¸¸å¥½çš„å‚è€ƒä»·å€¼ ä»€ä¹ˆæ˜¯å•ç‚¹ç™»å½•å•ç‚¹ç™»å½•ï¼ˆSingle Sign Onï¼‰ï¼Œç®€ç§°ä¸º SSOã€‚å¤šç”¨äºå¤šç³»ç»Ÿå…±å­˜çš„ç¯å¢ƒä¸‹ï¼Œç”¨æˆ·åœ¨ä¸€å¤„ç™»å½•åï¼Œå°±ä¸ç”¨åœ¨å…¶ä»–ç³»ç»Ÿä¸­ç™»å½•ï¼Œæœ€ç®€å•çš„å•ç‚¹ç™»å…¥å®ç°å¯ä»¥å®Œå…¨åŸºäºcookieï¼Œé€šè¿‡å¾€æµè§ˆå™¨å†™å¸¦æœ‰ç™»å…¥ä¿¡æ¯çš„tokenæ¥è¾¾åˆ°å¤šç‚¹ç™»å…¥çš„ç›®çš„ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±åŠ¨æ‰‹å®ç°ä¸€ä¸ª CASå•ç‚¹ç™»å…¥çš„å®ç°å…ˆç›—ä¸ªå›¾ ï¼š ä»ç»“æ„ä¸Šçœ‹ï¼Œåˆ†æˆäº†ä¸‰éƒ¨åˆ†ï¼šCAS Clientï¼ŒCAS Serverï¼Œæµè§ˆå™¨ CAS Client ä¸å—ä¿æŠ¤çš„å®¢æˆ·ç«¯åº”ç”¨éƒ¨ç½²åœ¨ä¸€èµ·ï¼Œä»¥ Filter æ–¹å¼ä¿æŠ¤ Web åº”ç”¨çš„å—ä¿æŠ¤èµ„æºï¼Œè¿‡æ»¤ä»å®¢æˆ·ç«¯è¿‡æ¥çš„æ¯ä¸€ä¸ªWebè¯·æ±‚ ä¸‹é¢æˆ‘å°†åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼ˆç”¨æˆ·ç¬¬ä¸€æ¬¡ç™»å½•éªŒè¯å’Œä¹‹åçš„ç™»å½•éªŒè¯ï¼‰è¯¦ç»†è§£æå…¶ç™»å…¥åŸç† ç”¨æˆ·ç¬¬ä¸€æ¬¡ç™»å½•è¿‡ç¨‹åŸç† CAS Client ä¼šå…ˆæ ¹æ®JSESSIONIDï¼ˆå­˜åœ¨æµè§ˆå™¨cookieä¸­ï¼‰ æ¥åˆ¤æ–­å½“å‰è®¿é—®ç”¨æˆ·æ˜¯å¦å·²ç»ç™»å½•ï¼Œå¦‚æœæ²¡æœ‰JSESSIONID ä¼šç»§ç»­åˆ†æ HTTP è¯·æ±‚ä¸­æ˜¯å¦åŒ…å«è¯·æ±‚ Service Ticket( ST ä¸Šå›¾ä¸­çš„ Ticket) ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è¯´æ˜è¯¥ç”¨æˆ·æ˜¯æ²¡æœ‰ç»è¿‡è®¤è¯çš„ï¼›äºæ˜¯ CAS Client ä¼šé‡å®šå‘ç”¨æˆ·è¯·æ±‚åˆ° CAS Server ï¼Œå¹¶ä¼ é€’ Service ï¼ˆè¦è®¿é—®çš„ç›®çš„èµ„æºåœ°å€ï¼‰ è¿™æ—¶è¿˜æ²¡æœ‰ç™»å½•è¿‡CAS Serverï¼Œè¿›å…¥ç”¨æˆ·è®¤è¯è¿‡ç¨‹ï¼ˆè¿”å›ç™»å…¥ç•Œé¢ï¼‰ å¦‚æœç”¨æˆ·è®¤è¯æˆåŠŸï¼ŒCAS Server å°†éšæœºäº§ç”Ÿä¸€ä¸ªç›¸å½“é•¿åº¦ã€å”¯ä¸€ã€ä¸å¯ä¼ªé€ çš„ Service Ticket ï¼Œå¹¶ç¼“å­˜ä»¥å¾…å°†æ¥éªŒè¯ï¼Œå¹¶ä¸”é‡å®šå‘ç”¨æˆ·åˆ° Service æ‰€åœ¨åœ°å€ï¼ˆé™„å¸¦åˆšæ‰äº§ç”Ÿçš„ Service Ticket ï¼‰ , å¹¶ä¸ºå®¢æˆ·ç«¯æµè§ˆå™¨è®¾ç½®ä¸€ä¸ªTicket Granted Cookieï¼ˆ TGCï¼Œè¯¥Cookieè®¾ç½®çš„æ˜¯SSO Serverçš„åŸŸåï¼‰ CAS Client åœ¨æ‹¿åˆ° Service å’Œæ–°äº§ç”Ÿçš„ Ticket è¿‡åï¼Œä¸ CAS Server é€šè¿‡æ‹¿åˆ°çš„Ticketè¿›è¡Œèº«ä»½æ ¸å®ï¼Œä»¥ç¡®ä¿ Service Ticket çš„åˆæ³•æ€§ã€‚ ä»¥ä¸Šæ˜¯ç¬¬ä¸€æ¬¡éªŒè¯æ—¶åŸºæœ¬æµç¨‹ å½“ç¬¬äºŒæ¬¡éªŒè¯æ—¶åˆ†ä¸¤ç§æƒ…å†µ åŒä¸€ä¸ªæœåŠ¡å†æ¬¡ç™»å½•è¿™é‡Œæµè§ˆå™¨cookieä¸­ä¼šæœ‰ sessionidï¼Œå‡­å€Ÿè¿™ä¸ªsessionidå°±ä¸å†éœ€è¦å»CAS Server ç»§ç»­è®¤è¯ å¦å¤–ä¸€ä¸ªæœªç™»å½•è¿‡çš„æœåŠ¡ç™»å½•åœ¨ä¸Šé¢æ­¥éª¤ä¸­çš„ç¬¬äºŒæ­©ï¼Œå› ä¸ºä¹‹å‰å·²ç»åœ¨CAS Server ç™»å½•æˆåŠŸè¿‡ï¼ŒCAS Server ä¼šè¯»å–æµè§ˆå™¨ä¸­çš„ TGC ï¼ˆcookieï¼‰ï¼Œè¡¨æ˜å·²ç»ç™»å…¥è¿‡ï¼Œå°±ä¸éœ€è¦å»è¿”å›ç™»å½•ç•Œé¢äº†ï¼Œç›´æ¥è¿”å›CAS Client ä¸€ä¸ªå”¯ä¸€ ç¥¨æ®ï¼ˆticketï¼‰ï¼Œå¹¶è¿›å…¥ç¬¬ä¸‰æ­©ã€‚è¿™æ ·å°±å®ç°äº†å•ç‚¹ç™»å½•ï¼Œå¤šç‚¹æ— éœ€å†æ¬¡æ‰‹åŠ¨ç™»å½• å…³äºè·¨åŸŸçš„å®ç°è·¨åŸŸçš„å…³é”®åœ¨äºæµè§ˆå™¨ç«¯çš„Cookie:TGCï¼Œå› ä¸ºè¿™ä¸ªCookieæ˜¯è®¾ç½®åœ¨SSO Serverç«¯çš„ï¼Œä¹Ÿå°±ä¿è¯äº†ç»Ÿä¸€ç¥¨æ®å’ŒClientç«¯åŸŸåæ— å…³ã€‚ æ€»ç»“cas å•ç‚¹ç™»å½•æ ¸å¿ƒå°±æ˜¯ å•ä¸ªcookieï¼Œ Nä¸ªsession å•ä¸ªcookieï¼ˆTGCï¼‰åœ¨casä¸ºå„åº”ç”¨ç™»å½•æ—¶ä½¿ç”¨ï¼Œå®ç°äº†åªé¡»ä¸€æ¬¡å½•å…¥ç”¨æˆ·å¯†ç ï¼Œæ­¤cookieåªäºcas serverç›¸å…³ï¼Œè¿™ä¹Ÿæ˜¯caså¯ä»¥å®ç°è·¨åŸŸçš„å…³é”® Nä¸ªsessionå„åº”ç”¨ä¼šåˆ›å»ºè‡ªå·±çš„sessionè¡¨ç¤ºæ˜¯å¦ç™»å½•ï¼Œå¦‚å·²ç™»å½•ï¼Œå°±ä¸ä¼šå»CAS Server å»éªŒè¯TGC åœ¨è¯¥åè®®ä¸­ï¼Œæ‰€æœ‰ä¸ CAS Server çš„äº¤äº’å‡é‡‡ç”¨ SSL åè®®ï¼Œä»¥ç¡®ä¿ ST å’Œ TGC çš„å®‰å…¨æ€§ã€‚]]></content>
      <categories>
        <category>ç¬¬ä¸‰æ–¹æ¡†æ¶</category>
        <category>SSO</category>
      </categories>
      <tags>
        <tag>SSO</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å…³äºxmlæ–‡ä»¶ xsi:schemaLocation]]></title>
    <url>%2F2017%2F05%2F09%2F%E5%85%B3%E4%BA%8Exml%E6%96%87%E4%BB%B6-xsi-schemaLocation%2F</url>
    <content type="text"><![CDATA[ç›¸ä¿¡å¾ˆå¤šäººå¯¹xml å¤´ä¸Šä¸€å¤§å †å¾—ä¸œè¥¿éƒ½æ˜¯æ‹¿æ¥ä¸»ä¹‰ï¼Œcopyè¿‡æ¥å°±è¡Œäº†ï¼Œå¹¶ä¸ç†è§£é‚£æ˜¯ä»€ä¹ˆæ„æ€ å…ˆæ¥ä¸€æ®µ1234567891011121314151617&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:p=&quot;http://www.springframework.org/schema/p&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.1.xsd http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc-4.0.xsd&quot;&gt; &lt;context:component-scan base-package=&quot;com.pikaq&quot;/&gt; &lt;bean id=&quot;xxx&quot; class=&quot;xxx.xxx.xxx.Xxx&quot;&gt; &lt;property name=&quot;xxx&quot; value=&quot;xxxx&quot;/&gt;&lt;/bean&gt;&lt;/beans&gt; é¦–å…ˆçœ‹åˆ°çš„å°±æ˜¯ xmlnsï¼Œ xmlnsXML æ˜¯Namespaceçš„ç¼©å†™ï¼Œå¯è¯‘ä¸ºâ€œXMLå‘½åç©ºé—´â€ ä¸ºä»€ä¹ˆéœ€è¦xmlnsï¼Ÿå› ä¸ºxmlæ–‡ä»¶æœ‰æˆåƒä¸Šä¸‡ï¼Œè°ä¹Ÿä¸èƒ½ä¿è¯ä½ çš„æ ‡ç­¾æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œæ€»æ˜¯ä¼šå†²çªçš„ï¼Œè¿™æ—¶å°±éœ€è¦xmlnsäº†ï¼ æ€ä¹ˆä½¿ç”¨xmlns å‘¢ï¼Ÿä½¿ç”¨è¯­æ³•ï¼š xmlns:namespace-prefix=&quot;namespaceURI&quot;ã€‚å…¶ä¸­namespace-prefixä¸ºè‡ªå®šä¹‰å‰ç¼€ï¼Œåªè¦åœ¨è¿™ä¸ªXMLæ–‡æ¡£ä¸­ä¿è¯å‰ç¼€ä¸é‡å¤å³å¯ï¼›namespaceURIæ˜¯è¿™ä¸ªå‰ç¼€å¯¹åº”çš„XML Namespaceçš„å®šä¹‰ã€‚ä¾‹å¦‚ï¼š xmlns:context=â€http://www.springframework.org/schema/context&quot; è¿™é‡Œçš„å…ƒç´ å°±æ¥è‡ªåˆ«åä¸ºcontextçš„XML Namespaceï¼Œä¹Ÿå°±æ˜¯åœ¨http://www.springframework.org/schema/contextä¸­å®šä¹‰çš„ã€‚å…¶å®æˆ‘ä»¬å®Œå…¨å¯ä»¥å°†å‰ç¼€å®šä¹‰ä¸ºabcï¼š xmlns:abc=â€http://www.springframework.org/schema/context&quot; å¥½äº†ï¼Œçœ‹åˆ°è¿™é‡Œï¼Œä½ ä¹Ÿè®¸ä¼šé—® é‚£ xmlns å’Œxmlns:context æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ xmlns æ²¡æœ‰å¸¦åˆ«åï¼Œå°±æ˜¯è¡¨ç¤ºé‚£æ˜¯é»˜è®¤çš„ï¼Œå¦‚ è¿™é‡Œçš„bean å±æ€§å°±å‡ºè‡ªè¿™ä¸ªé»˜è®¤å‘½åç©ºé—´ xsi:schemaLocation æ˜¯å¹²å˜›çš„ï¼Ÿçœ‹åˆ°è¿™é‡Œä¹Ÿè®¸ä½ å·²ç»çŸ¥é“äº†å®ƒæ˜¯å¹²å˜›çš„äº†schemaLocationä¸å°±æ˜¯ xsi å‘½åç©ºé—´çš„ä¸€ä¸ªå±æ€§å—ï¼Œå¦‚æœä¹‹å‰æˆ‘ä»¬æŠŠxmlns:xsi=â€http://www.w3.org/2001/XMLSchema-instance&quot; çš„åˆ«åæ”¹æˆxmlns:sb=â€http://www.w3.org/2001/XMLSchema-instance&quot; è¿™é‡Œå…¶å®å°±å˜æˆ sb:schemaLocationï¼Œè¿™é‡Œè®²ä¸€ä¸‹è¿™ä¸ªå±æ€§æ˜¯å¹²å˜›çš„ï¼Œè¿™ä¸ªå±æ€§çš„å€¼ç”±ä¸€ä¸ªæˆ–å¤šä¸ªURIå¼•ç”¨å¯¹ç»„æˆï¼Œä¸¤ä¸ªURIä¹‹é—´ä»¥ç©ºç™½ç¬¦åˆ†éš”ï¼ˆç©ºæ ¼å’Œæ¢è¡Œå‡å¯ï¼‰å®ƒå®šä¹‰äº†XML Namespaceå’Œå¯¹åº”çš„ XSDï¼ˆXml Schema Definitionï¼‰æ–‡æ¡£çš„ä½ç½®çš„å…³ç³»ï¼Œæ„æ€å°±æ˜¯ è¿™ä¸ªå‘½åç©ºé—´å¯¹åº”çš„å…·ä½“æ¨¡æ¿æ˜¯å“ªä¸ª ä¾‹å¦‚æˆ‘ä»¬æ‰“å¼€ http://www.springframework.org/schema/mvc/ è¿™ä¸ª å‘½åç©ºé—´ï¼Œå¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤šé€‰æ‹©xsi:schemaLocation è¿™ä¸ªå±æ€§å°±æ˜¯è·Ÿä»–è¯´æˆ‘è¦é€‰æ‹©å“ªä¸€ä¸ª]]></content>
      <categories>
        <category>åŸºç¡€</category>
        <category>xml</category>
      </categories>
      <tags>
        <tag>xml</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å…¨é¢è§£æJSé¢å‘å¯¹è±¡ åŸå‹é“¾]]></title>
    <url>%2F2017%2F05%2F04%2F%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90JS%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1-%E5%8E%9F%E5%9E%8B%E9%93%BE%2F</url>
    <content type="text"><![CDATA[å¯¹javascript è¿™é—¨è¯­è¨€æ¥è¯´ï¼Œç›¸ä¿¡å¤§å®¶éƒ½ä¸ä¼šé™Œç”Ÿï¼Œä½†æœ€è¿‘å‘ç°å…¶å®å¥½å¤šäººå¯¹JSå¯¹è±¡çš„æ¦‚å¿µå¾ˆæ¨¡ç³Šï¼Œç”šè‡³ä¼šæƒŠå¼‚äºJSç«Ÿç„¶ä¹Ÿæœ‰å¯¹è±¡ å…¶å®JSæ˜¯å®Œå…¨åŸºäºå¯¹è±¡çš„è¯­è¨€ï¼Œæˆ‘ä»¬æ‰€èƒ½çœ‹åˆ°çš„éƒ½æ˜¯åŸºäºå¯¹è±¡ï¼ŒåŒ…æ‹¬ js æ–¹æ³•å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ ä½†æ˜¯jsçš„é¢å‘å¯¹è±¡ä¸åƒjavaçš„é¢å‘å¯¹è±¡ç›¸æ¯”,åˆæ˜¯æœ‰ç€æå¤§çš„ä¸åŒï¼Œjavaï¼ŒC#å®Œå…¨é¢å‘å¯¹è±¡çš„è¯­è¨€ ä¸­æœ‰ç±»è¿™ä¸ªæ¦‚å¿µï¼Œè€Œjså¯¹è±¡åˆ™æ˜¯ä¾é  æ„é€ å™¨constructoråˆ©ç”¨ åŸå‹prototypeæ„é€ å‡ºæ¥çš„ã€‚ ç®€å•çš„ç†è§£ä¸‹ï¼Œç±»çš„æ¦‚å¿µç›¸å½“äº æ¨¡æ¿ï¼ŒåŸå‹ç›¸å½“äº å„ä¸ªå¯¹è±¡ç»„æˆæ–°çš„å¯¹è±¡ å…ˆæ¥æ€»ç»“ä¸€ä¸‹åˆ›å»ºå¯¹è±¡çš„3ç§æ–¹å¼ åˆ›å»ºå¯¹è±¡çš„ä¸‰ç§æ–¹å¼ï¼š1.é€šè¿‡JSONç¬¦å·åˆ›å»º1234567var dog = &#123; name: 'singledog', wangwang: function()&#123; console.log(this.name+"æ—ºæ—ºï¼"); &#125; &#125;; dog.wangwang();// singledogæ—ºæ—ºï¼ 2.é€šè¿‡new å…³é”®å­—åˆ›å»º12345678function Dog(name)&#123; this.name = name; &#125;; Dog.prototype.wangwang = function() &#123; console.log(this.name+"wangwang!!"); &#125;; var dog = new Dog("SingleDog:"); dog.wangwang();//SingleDog:wangwang!! 3.é€šè¿‡ ES5æ–°å¼•è¿›çš„ Object.create() æ–¹æ³•åˆ›å»º 12345678var dog = &#123; name: 'singledog', wangwang: function()&#123; console.log(this.name+"æ—ºæ—ºï¼"); &#125; &#125;; var jDog = Object.create(dog);//åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ jDog å¹¶ç»§æ‰¿ dog å¯¹è±¡ jDog.wangwang();//singledogæ—ºæ—ºï¼ åŸå‹ï¼ˆprototypeï¼‰prototypeï¼ˆåŸå‹ï¼‰æ˜¯jsé¢å‘å¯¹è±¡ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼Œæ˜¯æ·±å…¥å­¦ä¹ jsæ˜¯å¿…é¡»è¦ç†è§£çš„ä¸€ä¸ªæ¦‚å¿µæ¯ä¸ªæ–¹æ³• éƒ½æœ‰ä¸€ä¸ªprototypeå±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªå±æ€§æ¥å¤§åšæ–‡ç« ä¹‹å‰ä»‹ç»äº†ï¼Œæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªéœ€è¦ç”¨åˆ° new å…³é”®å­—ï¼Œé‚£ä¹ˆè¿™ä¸ªnew å…³é”®å­—ä¸JAVAä¸­çš„newä¸€æ ·å—ï¼Ÿ ç­”æ¡ˆæ˜¯å®Œå…¨ä¸ä¸€æ · å¯ä»¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š12345678910111213function Car(name)&#123; this.name = name &#125;; Car.prototype = &#123;//æŒ‡å®š Carçš„åŸå‹ å¯¹è±¡ driver: function()&#123; console.log(this.name+" driver!!"); &#125; &#125;; var obj = new Object(); obj.__proto__ = Car.prototype; Car.call(obj,"Benz"); obj.driver(); //Benz driver!! åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å‘ç° var car = new Car();è¿™å¥è¢«æˆ‘ä»¬æ›¿æ¢æˆäº†è¿™ä¸‰å¥ï¼š 123var obj = new Object(); obj.__proto__ = Car.prototype; Car.call(obj,"Benz"); ä»¥ä¸Šä»£ç ä¸­ï¼Œæˆ‘ä»¬å…ˆæ–°å»ºäº†ä¸€ä¸ªç©ºçš„Objectå¯¹è±¡ objï¼Œç„¶åå°†Carçš„åŸå‹èµ‹ç»™äº† objå¯¹è±¡çš„__proto__ï¼Œè¿™æ ·å­objå¯¹è±¡å°±ç»§æ‰¿äº†Carçš„åŸå‹å¯¹è±¡ï¼Œæœ€åä¸€æ­¥ï¼Œåœ¨objå¯¹è±¡ä¸Šæ‰§è¡Œæ„é€ æ–¹æ³•Carï¼Œè¿™æ ·å­ obj å¯¹è±¡å°±ç›¸å½“äºæ‹¿æ¥äº† Caræ–¹æ³•ä¸­ å…¨éƒ¨this. å±æ€§æˆ–æ–¹æ³• è¿™ä¸‰æ­¥å…¶å®ç­‰äºnew æ“ä½œ åŸºäºåŸå‹ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°åŸå‹é“¾çš„ç»§æ‰¿ï¼Œå› ä¸ºæ¯ä¸€ä¸ª prototype éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½éšå¼çš„æ‹¥ç”¨ä¸€ä¸ª prototype å¼•ç”¨ __proto__ å±æ€§ï¼Œè¿™æ ·å­å½“è°ƒç”¨ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šé¡ºç€__proto__å±æ€§ä¸€å±‚ä¸€å±‚å¾€ä¸Šæ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸ºæ­¢ã€‚ è¯´èµ·æ¥ä¼¼ä¹å¾ˆéš¾ç†è§£ï¼Œçœ‹ä¸ªä¾‹å­å¸®åŠ©å¤§å®¶ç†è§£ï¼š1234567891011121314151617181920212223242526272829303132333435function Car()&#123; &#125;; Car.prototype = &#123;//æŒ‡å®š Carçš„åŸå‹ å¯¹è±¡ name : 'car', driver: function()&#123; console.log(this.name+" driver!!"); &#125; &#125;; function QqCar()&#123; this.name = 'QQ' &#125;; QqCar.prototype = new Car(); //æŒ‡å®š QqCarçš„åŸå‹ä¸º new Car() var qqCar = new QqCar();//ç»§æ‰¿äº†driver æ–¹æ³• qqCar.driver(); // QQ driver!! function BigQqCar()&#123; this.name = 'BigQQ' &#125;; BigQqCar.prototype = qqCar; //æŒ‡å®š BigQQCarçš„åŸå‹ä¸º qqCar var bigQqCar = new BigQqCar(); bigQqCar.driver = function()&#123;//é‡å†™äº†driveræ–¹æ³• console.log(this.name+" flying!!"); &#125;; bigQqCar.driver();//BigQQ flying!! console.log(bigQqCar.__proto__===BigQqCar.prototype); //true console.log(BigQqCar.prototype === qqCar); //true console.log(BigQqCar.prototype.__proto__ === QqCar.prototype); //true // ä»¥ä¸Šä»£ç å°±æ˜¯ä¸€ä¸ªç®€å•çš„åŸå‹é“¾,æ¯ä¸ªæ„é€ æ–¹æ³•ç”Ÿæˆçš„å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª __proto__ æŒ‡å‘ å…¶æ„é€ æ–¹æ³•çš„prototype å±æ€§ ä»¥ä¸Šä¹Ÿåªæ˜¯ä¸ªäººå¯¹JSé¢å‘å¯¹è±¡çš„ç†è§£ï¼Œæ¬¢è¿ç•™è¨€è¡¥å……]]></content>
      <categories>
        <category>å‰ç«¯æŠ€æœ¯</category>
      </categories>
      <tags>
        <tag>javascript</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[React + ES6 + webpack å¿«é€Ÿæ­å»ºå¼€å‘ç¯å¢ƒ]]></title>
    <url>%2F2017%2F02%2F27%2FReact-ES6-webpack-%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%2F</url>
    <content type="text"><![CDATA[è¿‘æœŸï¼Œç”±ç”¨åˆ°äº†react.jsæ¥å†™å‰ç«¯ä»£ç ï¼Œæ­å»ºå¼€å‘ç¯å¢ƒå¯¹äºä»æ¥æ²¡æœ‰å†™è¿‡reactçš„åŒå­¦æ¥è¯´æœ‰ç‚¹å¤æ‚ï¼Œè¿™é‡Œç®€å•è®°å½•ä¸€ä¸‹æ­å»ºè¿‡ç¨‹ï¼ˆæœ¬äººä¹Ÿæ˜¯å‰ç«¯æ¸£æ¸£ï¼Œå†™é”™çš„åœ°æ–¹è¿˜æœ›å¤§å®¶æŒ‡å‡ºï¼‰ å®‰è£…webpack éœ€è¦Node ç¯å¢ƒ å…¨å±€å®‰è£… cnpm install -g webpack æœ¬é¡¹ç›®å®‰è£… cnpm install webpack â€“save-dev å®‰è£… react + es6 loaders cnpm install â€“save-dev babel-core babel-loader babel-preset-es2015 babel-preset-react è¿˜æœ‰css loader cnpm install css-loader style-loader â€“save-dev é…ç½®webpack.config.js æ–‡ä»¶123456789101112131415161718192021222324var path = require(&apos;path&apos;);module.exports = &#123; entry: &apos;./app/src/main.jsx&apos;, output: &#123; path: path.resolve(__dirname, &apos;./app/web&apos;), // è¾“å‡ºæ–‡ä»¶çš„ä¿å­˜è·¯å¾„ filename: &apos;bundle.js&apos; // è¾“å‡ºæ–‡ä»¶çš„åç§° &#125;, module: &#123; loaders: [&#123; test: /\\.jsx?$/, loaders: &apos;babel-loader&apos;, query: &#123; presets: [&apos;react&apos;, &apos;es2015&apos;] &#125; &#125;, &#123; test: /\\.css$/, loader: &apos;style-loader!css-loader&apos; &#125; ]&#125;&#125;; åˆ°è¿™é‡ŒåŸºæœ¬å¼€å‘ç¯å¢ƒæ­å»ºå¥½äº† å®‰è£…react å’Œreact-dom cnpm i react-dom â€“savecnpm i react â€“save å®‰è£…å®Œä¹‹åä¼šå‘ç°package.jsonä¸‹å¤šäº†è¿™ä¸¤ä¸ªä¾èµ–é¡¹ åœ¨app/src ä¸‹æ–°å»ºä¸€ä¸ªmain.jsxå…¥å£æ–‡ä»¶ï¼Œç®€å•å†™ä¸‹å†…å®¹ 1234567import React from &apos;react&apos;;import ReactDOM from &apos;react-dom&apos;;ReactDOM.render( &lt;h1&gt;Hello, world!&lt;/h1&gt;, document.getElementById(&apos;example&apos;)); ç„¶ååœ¨app/webä¸‹æ–°å»ºindex.html ï¼Œé‡Œé¢éœ€è¦å¼•ç”¨bundle.jsæ–‡ä»¶ 1234567891011&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;webpack æ•™ç¨‹&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;div id=&quot;example&quot;&gt;&lt;/div&gt;&lt;/body&gt;&lt;script src=&quot;bundle.js&quot;&gt;&lt;/script&gt;&lt;/html&gt; å®Œæˆæ­å»ºæ‰§è¡Œå‘½ä»¤ webpack æ‰§è¡ŒæˆåŠŸï¼Œå‘ç°åœ¨app/web ç›®å½•ä¸‹å¤šäº†ä¸ªbundle.jsæ–‡ä»¶ åœ¨æµè§ˆå™¨æ‰“å¼€index.html æ–‡ä»¶ã€‚æ­£ç¡®æ˜¾ç¤ºhello world! cnpm install ã€nameã€‘â€“save-dev ä¸ cnpm install ã€nameã€‘â€“saveçš„åŒºåˆ«ï¼Œéƒ½æ˜¯å®‰è£…ä¸€äº›æ¨¡å—ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯åŠ æœ‰devçš„æ˜¯åœ¨å¼€å‘æ—¶æ‰€ä¾èµ–çš„æ¨¡å—ï¼Œè€Œä¸åŠ çš„æ˜¯è¿è¡Œæ—¶éœ€è¦çš„åŸºæœ¬æ¨¡å—ã€‚ é‚£ä¹ˆæ€ä¹ˆå®æ—¶è°ƒè¯•å‘¢ï¼Ÿ cnpm install â€“save-dev webpack-dev-server react-hot-loaderwebpack.config.js çš„å†…å®¹æ›´æ–°å¦‚ä¸‹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152var path = require(&apos;path&apos;);var webpack = require(&apos;webpack&apos;);module.exports = &#123; entry: &#123; index: [ &apos;./app/src/main.jsx&apos; ] &#125;, output: &#123; path: path.resolve(__dirname, &apos;./app/web&apos;), // è¾“å‡ºæ–‡ä»¶çš„ä¿å­˜è·¯å¾„ filename: &apos;bundle.js&apos; // è¾“å‡ºæ–‡ä»¶çš„åç§° &#125;, module: &#123; loaders: [&#123; test: /\\.jsx?$/, loaders: &apos;babel-loader&apos;, query: &#123; presets: [&apos;react&apos;, &apos;es2015&apos;] &#125; &#125;, &#123; test: /\\.css$/, loader: &apos;style-loader!css-loader&apos; &#125;, &#123; test: /\\.js?$/, loaders: [&apos;react-hot&apos;], include: [path.join(__dirname, &apos;app/src&apos;)] &#125; ] &#125;, plugins: [ new webpack.HotModuleReplacementPlugin(), new webpack.NoErrorsPlugin(), new webpack.LoaderOptionsPlugin(&#123; options: &#123; postcss: function () &#123; return [precss, autoprefixer]; &#125;, devServer: &#123; historyApiFallback:true, hot:true, inline:true, progress:true &#125; &#125; &#125;)]&#125;; package.json æ–‡ä»¶éœ€è¦æ·»åŠ ä»¥ä¸‹ æ‰§è¡Œ npm run dev è®¿é—® localhost:8080 å³å¯ å†™çš„å¾ˆç²—æµ… æƒ­æ„§ï¼Œä»¥åæœ‰æ—¶é—´ä¼šé‡æ–°ç ”ç©¶ä¸€ä¸‹å‰ç«¯çš„æ„å»ºåŠæ‰“åŒ…]]></content>
      <categories>
        <category>å‰ç«¯æŠ€æœ¯</category>
        <category>javascript</category>
      </categories>
      <tags>
        <tag>javascript</tag>
        <tag>react</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Mavençš„ç”Ÿå‘½å‘¨æœŸåŠæ’ä»¶ç»‘å®š]]></title>
    <url>%2F2016%2F12%2F21%2FMaven%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%8F%8A%E6%8F%92%E4%BB%B6%E7%BB%91%E5%AE%9A%2F</url>
    <content type="text"><![CDATA[######ä½•ä¸ºç”Ÿå‘½å‘¨æœŸï¼Ÿ ä¸€ä¸ªå®Œæ•´çš„é¡¹ç›®æ„å»ºè¿‡ç¨‹é€šå¸¸åŒ…æ‹¬æ¸…ç†ã€ç¼–è¯‘ã€æµ‹è¯•ã€æ‰“åŒ…ã€é›†æˆæµ‹è¯•ã€éªŒè¯ã€éƒ¨ç½²ç­‰æ­¥éª¤ï¼ŒMavenä»ä¸­æŠ½å–äº†ä¸€å¥—å®Œå–„çš„ã€æ˜“æ‰©å±•çš„ç”Ÿå‘½å‘¨æœŸã€‚Mavençš„ç”Ÿå‘½å‘¨æœŸæ˜¯æŠ½è±¡çš„ï¼Œå…¶ä¸­çš„å…·ä½“ä»»åŠ¡éƒ½äº¤ç”±æ’ä»¶æ¥å®Œæˆã€‚Mavenä¸ºå¤§å¤šæ•°æ„å»ºä»»åŠ¡ç¼–å†™å¹¶ç»‘å®šäº†é»˜è®¤çš„æ’ä»¶ï¼Œå¦‚é’ˆå¯¹ç¼–è¯‘çš„æ’ä»¶ï¼šmaven-compiler-pluginã€‚ç”¨æˆ·ä¹Ÿå¯è‡ªè¡Œé…ç½®æˆ–ç¼–å†™æ’ä»¶ã€‚ Mavençš„ç”Ÿå‘½å‘¨æœŸæ˜¯æŠ½è±¡çš„ï¼Œæ„å‘³ç€ç”Ÿå‘½å‘¨æœŸæœ¬èº«ä¸åšä»»ä½•å®é™…å·¥ä½œï¼Œåœ¨Mavençš„è®¾è®¡ä¸­ï¼Œå®é™…çš„å·¥ä½œéƒ½äº¤ç”±æ’ä»¶æ¥å®Œæˆ Mavenå®šä¹‰äº†ä¸‰å¥—ç”Ÿå‘½å‘¨æœŸï¼šcleanã€defaultã€siteï¼Œæ¯ä¸ªç”Ÿå‘½å‘¨æœŸéƒ½åŒ…å«äº†ä¸€äº›é˜¶æ®µï¼ˆphaseï¼‰ã€‚ä¸‰å¥—ç”Ÿå‘½å‘¨æœŸç›¸äº’ç‹¬ç«‹ï¼Œä½†å„ä¸ªç”Ÿå‘½å‘¨æœŸä¸­çš„phaseå´æ˜¯æœ‰é¡ºåºçš„ï¼Œä¸”åé¢çš„phaseä¾èµ–äºå‰é¢çš„phaseã€‚æ‰§è¡ŒæŸä¸ªphaseæ—¶ï¼Œå…¶å‰é¢çš„phaseä¼šä¾é¡ºåºæ‰§è¡Œï¼Œä½†ä¸ä¼šè§¦å‘å¦å¤–ä¸¤å¥—ç”Ÿå‘½å‘¨æœŸä¸­çš„ä»»ä½•phaseã€‚ 1 . 1 cleanç”Ÿå‘½å‘¨æœŸ 1 . 2 defaultç”Ÿå‘½å‘¨æœŸ 1 . 3 siteç”Ÿå‘½å‘¨æœŸ ######ï¼ˆé˜¶æ®µï¼‰phase ï¼ˆç›®æ ‡ï¼‰goalPhase ä¹‹å‰è¯´è¿‡ï¼ŒæŒ‡çš„å°±æ˜¯ç”Ÿå‘½å‘¨æœŸçš„å„ä¸ªé˜¶æ®µGoal æŒ‡ä¾¿æ˜¯ æ’ä»¶çš„ç›®æ ‡ï¼ˆé€šä¿—çš„è¯´å°±æ˜¯æ’ä»¶æ‰€å…·æœ‰çš„åŠŸèƒ½ï¼‰ ######è‡ªå®šä¹‰æ’ä»¶é…ç½®]]></content>
      <categories>
        <category>æ„å»ºå·¥å…·</category>
        <category>maven</category>
      </categories>
      <tags>
        <tag>maven</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Maven å­¦ä¹ æ€»ç»“]]></title>
    <url>%2F2016%2F12%2F20%2FMaven-%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%2F</url>
    <content type="text"><![CDATA[#Maven ç®€ä»‹Mavenæ˜¯ä»€ä¹ˆï¼Ÿ Maven è¿™ä¸ªè¯å¯ä»¥ç¿»è¯‘ä¸ºâ€œçŸ¥è¯†çš„ç§¯ç´¯â€ï¼Œä¹Ÿå¯ä»¥ç¿»è¯‘ä¸ºâ€œä¸“å®¶â€æˆ–â€œå†…æ¶µâ€ã€‚æœ¬æ–‡å°†ä»‹ç»mavenè¿™ä¸€è·¨å¹³å°çš„é¡¹ç›®ç®¡ç†ä½¿ç”¨å·¥å…·ã€‚åšä¸ºapacheç»„ç»‡ä¸­ä¸€ä¸ªé¢‡ä¸ºæˆåŠŸçš„å¼€æºé¡¹ç›®ï¼Œmavenä¸»è¦æœåŠ¡äºåŸºäºjavaå¹³å°çš„é¡¹ç›®æ„å»ºï¼Œä¾èµ–ç®¡ç†å’Œé¡¹ç›®ä¿¡æ¯ç®¡ç†ï¼Œæ— è®ºæ˜¯å°å‹çš„å¼€æºç±»åº“é¡¹ç›®ï¼Œè¿˜æ˜¯å¤§å‹çš„ä¼ä¸šçº§åº”ç”¨ï¼›æ— è®ºæ˜¯ä¼ ç»Ÿçš„ç€‘å¸ƒå¼å¼€å‘ï¼Œè¿˜æ˜¯æµè¡Œçš„æ•æ·æ¨¡å¼ï¼ŒMavenéƒ½èƒ½å¤§æ˜¾èº«æ‰‹ â€“ mavenå®æˆ˜ #ä½•ä¸ºæ„å»ºé™¤äº†ç¼–å†™æºä»£ç ï¼Œæˆ‘ä»¬æ¯å¤©æœ‰ç›¸å½“ä¸€éƒ¨åˆ†æ—¶é—´èŠ±åœ¨äº†ç¼–è¯‘ã€è¿è¡Œå•å…ƒæµ‹è¯•ã€ç”Ÿæˆæ–‡æ¡£ã€æ‰“åŒ…å’Œéƒ¨ç½²ç­‰çƒ¦çä¸”ä¸èµ·çœ¼çš„å·¥ä½œä¸Šï¼Œè¿™å°±æ˜¯æ„å»ºå¦‚æœæˆ‘ä»¬ç°åœ¨è¿˜æ‰‹å·¥è¿™æ ·åšï¼Œé‚£æˆæœ¬ä¹Ÿå¤ªé«˜äº†ï¼Œäºæ˜¯æœ‰äººç”¨è½¯ä»¶çš„æ–¹æ³•è®©è¿™ä¸€ç³»åˆ—å·¥ä½œå®Œå…¨è‡ªåŠ¨åŒ–ï¼Œä½¿å¾—è½¯ä»¶çš„æ„å»ºå¯ä»¥åƒå…¨è‡ªåŠ¨æµæ°´çº¿ä¸€æ ·ï¼Œåªéœ€è¦ä¸€æ¡ç®€å•çš„å‘½ä»¤ï¼Œæ‰€æœ‰çƒ¦ççš„æ­¥éª¤éƒ½èƒ½å¤Ÿè‡ªåŠ¨å®Œæˆï¼Œå¾ˆå¿«å°±èƒ½å¾—åˆ°æœ€ç»ˆç»“æœ #mavenä¸ä»…ä»…æ˜¯æ„å»ºå·¥å…·ä¾èµ–ç®¡ç† #ä¸antçš„åŒºåˆ«æˆ‘çœ‹åˆ°å¾ˆå¤šé¡¹ç›®çš„antè„šæœ¬ä¸­çš„å‘½ååŸºæœ¬ä¸Šéƒ½æ˜¯ä¸€è‡´çš„ï¼Œæ¯”å¦‚ï¼šç¼–è¯‘ä¸€èˆ¬å«buildæˆ–è€…compileï¼›æ‰“åŒ…ä¸€èˆ¬å«jaræˆ–warï¼›ç”Ÿæˆæ–‡æ¡£ä¸€èˆ¬å‘½åä¸º javadocæˆ–javadocsï¼›ä½†å…¶å®æœ€å¸¸ç”¨çš„å°±2ï¼Œ3ä¸ªï¼šæ¯”å¦‚javac javadoc jarç­‰ã€‚ è¿™æ˜¯å› ä¸ºAntæ‰€æä¾›çš„å¯é‡ç”¨çš„taskç²’åº¦å¤ªå°ï¼Œè™½ç„¶çµæ´»æ€§å¾ˆå¼ºï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦çº ç¼ å¾ˆå¤šç»†èŠ‚çš„ä¸œè¥¿ANTæ˜¯æ²¡æœ‰ä¾èµ–ç®¡ç†çš„ï¼Œè€Œå¯¹äºMavenç”¨æˆ·æ¥è¯´ï¼Œä¾èµ–ç®¡ç†æ˜¯ç†æ‰€å½“ç„¶çš„ï¼ŒMavenä¸ä»…å†…ç½®äº†ä¾èµ–ç®¡ç†ï¼Œæ›´æœ‰ä¸€ä¸ªå¯èƒ½æ‹¥æœ‰å…¨ä¸–ç•Œæœ€å¤šJavaå¼€æºè½¯ä»¶åŒ…çš„ä¸­å¤®ä»“åº“ï¼ŒMavenç”¨æˆ·æ— é¡»è¿›è¡Œä»»ä½•é…ç½®å°±å¯ä»¥ç›´æ¥äº«ç”¨ã€‚ ##Mavençš„ä¼˜ç‚¹ï¼š 1.æ‹¥æœ‰çº¦å®šï¼ŒçŸ¥é“ä½ çš„ä»£ç åœ¨å“ªé‡Œï¼Œæ”¾åˆ°å“ªé‡Œå»2.æ‹¥æœ‰ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œä¾‹å¦‚æ‰§è¡Œ mvn installå°±å¯ä»¥è‡ªåŠ¨æ‰§è¡Œç¼–è¯‘ï¼Œæµ‹è¯•ï¼Œæ‰“åŒ…ç­‰æ„å»ºè¿‡ç¨‹3.åªéœ€è¦å®šä¹‰ä¸€ä¸ªpom.xml,ç„¶åæŠŠæºç æ”¾åˆ°é»˜è®¤çš„ç›®å½•ï¼ŒMavenå¸®ä½ å¤„ç†å…¶ä»–äº‹æƒ…4.æ‹¥æœ‰ä¾èµ–ç®¡ç†ï¼Œä»“åº“ç®¡ç† #Maven çš„å®‰è£…é…ç½® é¦–å…ˆå®˜ç½‘ä¸‹è½½ http://maven.apache.org/download.cgi è¯´æ˜éœ€è¦JDK 1.7åŠä»¥ä¸Šï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨JDK1.8 è¿™é‡Œæˆ‘ä¸‹è½½çš„æ˜¯maven 3.3.9 1.å°†å®‰è£…æ–‡ä»¶è§£å‹åˆ°æŒ‡å®šçš„ç›®å½•ä¸­ï¼Œå¦‚ï¼š D:\maven\apache-maven-3.3.9 2.è®¾ç½®ç¯å¢ƒå˜é‡ å°†D:\maven\apache-maven-3.3.9\bin è®¾è¿›ç¯å¢ƒå˜é‡ä¸­ æ‰“å¼€cmd æ‰§è¡Œ mvn -v æ³¨æ„äº‹é¡¹ è®¾ç½®MAVEN_OPTSç¯å¢ƒå˜é‡ï¼Œé€šå¸¸éœ€è¦è®¾ç½®MAVEN_OPTSçš„å€¼ä¸º-Xms128m-Xmx512mï¼Œå› ä¸ºJavaé»˜è®¤çš„æœ€å¤§å¯ç”¨å†…å­˜å¾€å¾€ä¸èƒ½å¤Ÿæ»¡è¶³Mavenè¿è¡Œçš„éœ€è¦ï¼Œæ¯”å¦‚åœ¨é¡¹ç›®è¾ƒå¤§æ—¶ï¼Œä½¿ç”¨Mavenç”Ÿæˆé¡¹ç›®ç«™ç‚¹éœ€è¦å ç”¨å¤§é‡çš„å†…å­˜ï¼Œå¦‚æœæ²¡æœ‰è¯¥é…ç½®ï¼Œåˆ™å¾ˆå®¹æ˜“å¾—åˆ°java.lang.OutOfMemeoryErrorã€‚å› æ­¤ï¼Œä¸€å¼€å§‹å°±é…ç½®è¯¥å˜é‡æ˜¯æ¨èçš„åšæ³•ã€‚ #mavenä½¿ç”¨å…¥é—¨ä¸€ã€ç¼–å†™pomæ–‡ä»¶å°±åƒMakeçš„Makefileã€Antçš„build.xmlä¸€æ ·ï¼ŒMavené¡¹ç›®çš„æ ¸å¿ƒæ˜¯pom.xmlã€‚POMï¼ˆProject Object Modelï¼Œé¡¹ç›®å¯¹è±¡æ¨¡å‹ï¼‰å®šä¹‰äº†é¡¹ç›®çš„åŸºæœ¬ä¿¡æ¯ï¼Œç”¨äºæè¿°é¡¹ç›®å¦‚ä½•æ„å»ºï¼Œå£°æ˜é¡¹ç›®ä¾èµ–ï¼Œç­‰ç­‰ã€‚ç°åœ¨å…ˆä¸ºHello Worldé¡¹ç›®ç¼–å†™ä¸€ä¸ªæœ€ç®€å•çš„pom.xmlã€‚ 12345678910&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;com.pikaq&lt;/groupId&gt; &lt;artifactId&gt;maventest&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;packaging&gt;jar&lt;/packaging&gt; &lt;name&gt;maventest&lt;/name&gt;&lt;/project&gt; è¿™æ®µä»£ç ä¸­æœ€é‡è¦çš„æ˜¯åŒ…å«groupIdã€artifactIdå’Œversionçš„ä¸‰è¡Œã€‚è¿™ä¸‰ä¸ªå…ƒç´ å®šä¹‰äº†ä¸€ä¸ªé¡¹ç›®åŸºæœ¬çš„åæ ‡ï¼Œåœ¨Mavençš„ä¸–ç•Œï¼Œä»»ä½•çš„jarã€pomæˆ–è€…waréƒ½æ˜¯ä»¥åŸºäºè¿™äº›åŸºæœ¬çš„åæ ‡è¿›è¡ŒåŒºåˆ†çš„ã€‚groupIdå®šä¹‰äº†é¡¹ç›®å±äºå“ªä¸ªç»„ï¼Œè¿™ä¸ªç»„å¾€å¾€å’Œé¡¹ç›®æ‰€åœ¨çš„ç»„ç»‡æˆ–å…¬å¸å­˜åœ¨å…³è”ã€‚è­¬å¦‚åœ¨googlecodeä¸Šå»ºç«‹äº†ä¸€ä¸ªåä¸ºmyappçš„é¡¹ç›®ï¼Œé‚£ä¹ˆgroupIdå°±åº”è¯¥æ˜¯com.googlecode.myappï¼Œå¦‚æœä½ çš„å…¬å¸æ˜¯mycomï¼Œæœ‰ä¸€ä¸ªé¡¹ç›®ä¸ºmyappï¼Œé‚£ä¹ˆgroupIdå°±åº”è¯¥æ˜¯com.mycom.myappã€‚æœ¬ä¹¦ä¸­æ‰€æœ‰çš„ä»£ç éƒ½åŸºäºgroupId com.juvenxu.mvnbookã€‚æœ¬ä¹¦å…¶ä»–ç« èŠ‚ä»£ç ä¼šåˆ†é…å…¶ä»–çš„artifactIdã€‚è€Œåœ¨å‰é¢çš„groupIdä¸ºcom.googlecode.myappçš„ä¾‹å­ä¸­ï¼Œä½ å¯èƒ½ä¼šä¸ºä¸åŒçš„å­é¡¹ç›®ï¼ˆæ¨¡å—ï¼‰åˆ†é…artifactIdï¼Œå¦‚myapp-utilã€myapp-domainã€myapp-webç­‰é¡¾åæ€ä¹‰ï¼ŒversionæŒ‡å®šäº†Hello Worldé¡¹ç›®å½“å‰çš„ç‰ˆæœ¬â€”â€”1.0-SNAPSHOTã€‚SNAPSHOTæ„ä¸ºå¿«ç…§ï¼Œè¯´æ˜è¯¥é¡¹ç›®è¿˜å¤„äºå¼€å‘ä¸­ï¼Œæ˜¯ä¸ç¨³å®šçš„ç‰ˆæœ¬ã€‚éšç€é¡¹ç›®çš„å‘å±•ï¼Œversionä¼šä¸æ–­æ›´æ–°ï¼Œå¦‚å‡çº§ä¸º1.0ã€1.1-SNAPSHOTã€1.1ã€2.0ç­‰ã€‚6.5èŠ‚ä¼šè¯¦ç»†ä»‹ç»SNAPSHOTï¼Œç¬¬13ç« ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨Mavenç®¡ç†é¡¹ç›®ç‰ˆæœ¬çš„å‡çº§å‘å¸ƒã€‚æœ€åä¸€ä¸ªnameå…ƒç´ å£°æ˜äº†ä¸€ä¸ªå¯¹äºç”¨æˆ·æ›´ä¸ºå‹å¥½çš„é¡¹ç›®åç§°ï¼Œè™½ç„¶è¿™ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†è¿˜æ˜¯æ¨èä¸ºæ¯ä¸ªPOMå£°æ˜nameï¼Œä»¥æ–¹ä¾¿ä¿¡æ¯äº¤æµã€‚ ##ç¼–å†™ä¸»ä»£ç  123456789101112package com.pikaq.maventest;public class Helloworld&#123; public String sayHello()&#123; return &quot;hello&quot;; &#125; public static void main(String [] args)&#123; System.out.println(new Helloworld().sayHello()); &#125; &#125; è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥éµå¾ªmavençº¦å®šæŠŠä»£ç æ”¾åœ¨src/main/java ç›®å½•ä¸‹ï¼Œæ— éœ€å…¶ä»–é…ç½®ï¼Œmavenå°±ä¼šè‡ªåŠ¨å»æœå¯»ä¸»ä»£ç ï¼Œä»£ç ç¼–å†™å®Œä¹‹åï¼Œä½¿ç”¨ mvn clean compile ç¼–è¯‘ ##ç¼–å†™æµ‹è¯•ä»£ç  å’Œç¼–å†™ä¸»ä»£ç ç±»ä¼¼ï¼Œæµ‹è¯•ä»£ç çš„ç›®å½•å¯¹åº”çš„åº”è¯¥åœ¨ src/test/java ä¸‹ï¼Œå› æ­¤åº”è¯¥å…ˆåˆ›å»ºç›®å½•ï¼Œä¿®æ”¹é¡¹ç›® pom æ–‡ä»¶ï¼Œå¢åŠ Junitä¾èµ– 1234567891011121314151617181920&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;com.pikaq&lt;/groupId&gt; &lt;artifactId&gt;maventest&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;packaging&gt;jar&lt;/packaging&gt; &lt;name&gt;maventest&lt;/name&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.7&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/project&gt; ç¼–å†™æµ‹è¯•ç±» 1234567891011121314package com.pikaq.maventest;import static org.junit.Assert.assertEquals;import org.junit.Test;public class HelloworldTest&#123; @Test public void testSayHello()&#123; Helloworld h = new Helloworld(); String result = h.sayHello(); assertEquals(&quot;hello&quot;,result); &#125; &#125; è¿è¡Œ mvn clean test #æ‰“åŒ…å’Œè¿è¡Œ mvn clean package maven åœ¨æ‰“åŒ…ä¹‹å‰æ‰§è¡Œäº†ç¼–è¯‘å’Œæµ‹è¯•æ“ä½œ ä½†æ˜¯å¦‚ä½•è®©å…¶ä»–maven é¡¹ç›®å¼•ç”¨è¿™ä¸ªjaråŒ…å‘¢ï¼š mvn clean install é€šè¿‡æ‰§è¡Œinstall å‘½ä»¤å°†jar å®‰è£…åˆ°äº†æœ¬åœ°ä»“åº“ä¸­ #ä½¿ç”¨Archetype ç”Ÿæˆé¡¹ç›®éª¨æ¶ å‰é¢æˆ‘ä»¬åªæ˜¯ä¸ºäº†æˆ‘ä»¬è¿›ä¸€æ­¥ç†Ÿæ‚‰mavenï¼ŒçœŸæ­£ç”¨çš„æ—¶å€™æˆ‘ä»¬å½“ç„¶ä¸ä¼šè¿™ä¹ˆå¤æ‚ï¼Œä¸€ä¸ªä¸€ä¸ªç›®å½•çš„å»åˆ›å»ºï¼Œè¿™æ˜¾ç„¶æ˜¯é‡å¤åŠ³åŠ¨ï¼æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªç®€å•çš„å‘½ä»¤å°±èƒ½ç”Ÿæˆæˆ‘ä»¬çº¦å®šå¥½çš„é¡¹ç›®éª¨æ¶ï¼ mvn archetype:generate æ³¨æ„è¿™é‡Œææœ‰å¯èƒ½ä¼šå¡ä¸»ï¼Œå› ä¸ºè¿™ä¸ªå‘½ä»¤ä¼šé»˜è®¤å»è¿œç¨‹è¯·æ±‚æ‰€æœ‰çš„éª¨æ¶ æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå¯ä»¥é€‰æ‹© &gt;mvn archetype:generate -DarchetypeCatalog=internal è¿™ä¸ªå‘½ä»¤æ‰§è¡Œåªä¼šåˆ—å‡ºå¸¸ç”¨çš„10ä¸ªæˆ‘ä»¬åªéœ€è¦æŒ‰ç…§æç¤ºé€‰æ‹©ä¸€ä¸ªå³å¯ï¼Œå¹¶ä¾æ¬¡è¾“å…¥groupIDç­‰ æç¤ºåˆ›å»ºæˆåŠŸï¼Œæˆ‘ä»¬å‘ç°å·²ç»ç”Ÿæˆäº†ä¸€ä¸ªmavené¡¹ç›®ï¼Œæ˜¯ä¸æ˜¯éå¸¸ç®€å•ï¼ ####maven çš„ä¾èµ–ç®¡ç†é—®é¢˜ mavenä¼šè‡ªåŠ¨é€‰æ‹©è·¯å¾„æœ€çŸ­çš„]]></content>
      <categories>
        <category>æ„å»ºå·¥å…·</category>
        <category>maven</category>
      </categories>
      <tags>
        <tag>maven</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[java ä½¿ç”¨è¡¥ç è¿ç®—çš„å‰ä¸–ä»Šç”Ÿ]]></title>
    <url>%2F2016%2F10%2F20%2Fjava-%E4%BD%BF%E7%94%A8%E8%A1%A5%E7%A0%81%E8%BF%90%E7%AE%97%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F%2F</url>
    <content type="text"><![CDATA[å‰ä¸–ä»Šç”Ÿä¼—æ‰€å‘¨çŸ¥ï¼Œjavaæ˜¯ä½¿ç”¨è¡¥ç æ¥è¡¨ç¤ºæ•°å­—çš„ï¼ˆä¸åŒ…æ‹¬å­—ç¬¦å‹ï¼‰ï¼Œæ•°å­—çš„è¿ç®—ä¹Ÿæ˜¯ä»¥è¡¥ç å½¢å¼è¿›è¡Œçš„ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¦ç”¨è¡¥ç è¡¨ç¤ºå‘¢ï¼Ÿè¦äº†è§£è¡¥ç ï¼Œæˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“è®¡ç®—æœºå¯ä»¥ç”¨åŸç  åç  è¡¥ç è¿™ä¸‰ç§ç¼–ç æ–¹å¼è¡¨ç¤ºä¸€ä¸ªæ•°å…ˆæ¥çœ‹çœ‹æˆ‘ä»¬æ˜¯å¦‚ä½•å®šä¹‰è¿™ä¸‰ç§ç¼–ç çš„ æ­£æ•°çš„åŸç  åç  è¡¥ç éƒ½æ˜¯ä¸€æ ·çš„ è´Ÿæ•°çš„åç æ˜¯é™¤äº†ç¬¦å·ä½å…¶ä»–å–åï¼Œè¡¥ç æ˜¯åœ¨åç ä¸ŠåŠ 1 æ‰€ä»¥å¯¹äºæ­£æ•°ä¸‰ç åˆä¸€æ²¡å•¥å¯è¯´çš„ï¼Œè¿™é‡Œä¸»è¦æ¥èŠä¸€ä¸‹è´Ÿæ•°ï¼Œå› ä¸ºè®¡ç®—æœºåœ¨è¿›è¡Œè®¡ç®—çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šåƒäººè„‘ä¸€æ ·è¯†åˆ«åŸç çš„ç¬¬ä¸€ä½ä¸ºç¬¦å·ä½ï¼Œè¿›è€Œä¼šå»æ ¹æ®ç¬¦å·ä½å¯¹çœŸå€¼è¿›è¡ŒåŠ æˆ–å‡ã€‚æ‰€ä»¥æˆ‘ä»¬è¦è®©è®¡ç®—æœºçš„è¿ç®—å˜çš„å°½å¯èƒ½çš„ç®€å•ï¼Œæ¯”å¦‚ä¸¤ä¸ªæ•°ç›¸å‡æˆ‘ä»¬å¯ä»¥çœ‹æˆæ˜¯åŠ ä¸Šä¸€ä¸ªè´Ÿæ•°ï¼Œå¹¶ä¸”è®©ç¬¦å·ä½ä¹Ÿå‚ä¸è¿ç®— åŸç çš„å‡æ³• 1210 + (-9) = 0000 1010(åŸ) + 1000 1001(åŸ) = 1001 0011(åŸ) = -19// æ­£è§£åº”è¯¥æ˜¯ 1ï¼Œ -19æ˜¾ç„¶æ˜¯é”™è¯¯çš„ ä¾‹å­ä¸­æ­£è§£åº”è¯¥æ˜¯ 1ï¼Œ -19æ˜¾ç„¶æ˜¯é”™è¯¯çš„ã€‚è¿™å°±å¼•ç”³å‡ºäº†åç ï¼Œè´Ÿæ•°çš„åç æ˜¯é™¤äº†ç¬¦å·ä½ï¼Œå…¶ä»–ä½å–å åç çš„å‡æ³• 12310 + (-9) = 0000 1010(åŸ) + 1000 1001(åŸ) = 0000 1010(å) + 1111 0110(å) = 0000 0001(å) = 0000 0001(åŸ)// ç»“æœæ˜¯æ­£ç¡®çš„ = 1 çœ‹ä¼¼åç è²Œä¼¼è§£å†³äº†ç¬¦å·ä½å‚ä¸è¿ç®—çš„é—®é¢˜ï¼Œå…¶å®ä¸ç„¶ï¼Œè®©æˆ‘ä»¬å†çœ‹ä¸€ä¸ªç‰¹æ®Šçš„ä¾‹å­ 1231 + (-1) = 0000 0001(åŸ) + 1000 0001(åŸ) = 0000 0001(å) + 1111 1110(å) = 1111 1111(å) = 1000 0000(åŸ) = -0// ps: åç ç›¸åŠ ç¬¦å·ä½å‚ä¸è¿ç®—ï¼Œä¸”è‹¥æœ€é«˜ä½ç›¸åŠ åäº§ç”Ÿè¿›ä½ï¼Œæœ€åå¾—åˆ°çš„ç»“æœè¦åŠ 1// ç»“æœçœ‹ä¼¼æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯æ˜¾ç„¶ä¸ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œ0 å’Œ -0 åº”è¯¥æ˜¯ä¸€ä¸ªæ•°å­— äºæ˜¯è¡¥ç å°±è¿™æ ·å‡ºç°äº† è¡¥ç çš„å‡æ³• 1231 + (-1) = 0000 0001(åŸ) + 1000 0001(åŸ) = 0000 0001(å) + 1111 1110(å) = 0000 0001(è¡¥) + 1111 1111(è¡¥) = 0000 0000(åŸ) = 0// ps: è¡¥ç è¿ç®—æœ€é«˜ä½è¿›ä½ä¼šèˆå»// ç»“æœå®Œå…¨æ­£ç¡® ä¸” -0 ä¸å­˜åœ¨äº† è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ 1000 0000(è¡¥) å¹¶æ²¡æœ‰ç›¸åº”çš„åŸç å’Œåç ï¼Œä»…ç”¨æ¥è¡¨ç¤º -128 æœ€åå†é™„å¼ å¹¼å„¿ç­å¸¸ç”¨æ•°å­—è¿›åˆ¶è¡¨ &lt;(ï¿£â–½ï¿£)/ 2è¿›åˆ¶ 10 è¿›åˆ¶ 16 è¿›åˆ¶ 0000 0001 1 0x1 0000 0010 2 0x2 0000 0011 3 0x3 0000 0100 4 0x4 0000 0101 5 0x5 0000 0110 6 0x6 0000 0111 7 0x7 0000 1000 8 0x8 0000 1001 9 0x9 0000 1010 10 0xa 0000 1011 11 0xb 0000 1100 12 0xc 0000 1101 13 0xd 0000 1110 14 0xe 0000 1111 15 0xf 0001 0000 16 0x10 0001 0100 20 0x14 0001 1110 20 0x1e 0100 0000 64 0x40 0111 1111 127 0x7f 1111 1111 255 0xff]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
        <category>ç¼–ç </category>
      </categories>
      <tags>
        <tag>ç¼–ç </tag>
        <tag>è¡¥ç </tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[CSS ç»å¯¹å®šä½ ,æµ®åŠ¨,æ¸…é™¤æµ®åŠ¨]]></title>
    <url>%2F2016%2F09%2F21%2FCSS-%E7%BB%9D%E5%AF%B9%E5%AE%9A%E4%BD%8D-%E6%B5%AE%E5%8A%A8-%E6%B8%85%E9%99%A4%E6%B5%AE%E5%8A%A8%2F</url>
    <content type="text"><![CDATA[é¦–å…ˆï¼šæˆ‘ä»¬éœ€è¦çŸ¥é“divå…ƒç´ ï¼ˆå—çº§å…ƒç´ ï¼‰ç‹¬å ä¸€è¡Œ12345678910111213&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;div id=&quot;1&quot; style=&quot;background:red;height:200px;padding:5px;position:relative&quot;&gt; &lt;div id=&quot;2&quot; style=&quot;background:green;height:50px;&quot;&gt;box1&lt;/div&gt; &lt;!-- divå…ƒç´ ç‹¬å ä¸€è¡Œ --&gt; &lt;div id=&quot;3&quot; style=&quot;background:pink;height:50px;&quot;&gt;box2&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt; å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œbox1å’Œbox2ç‹¬å ä¸€è¡Œï¼Œå¯è§å¦‚æœæ¯ä¸ªdivéƒ½ç‹¬å ä¸€è¡Œï¼Œæˆ‘ä»¬æ ¹æœ¬æ— æ³•è¿›è¡Œå¸ƒå±€ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦ç»å¯¹å®šä½å’Œæµ®åŠ¨æ¥å¸®åŠ©æˆ‘ä»¬å¸ƒå±€ï¼ ç»å¯¹å®šä½çš„å‚ç…§å…³ç³»ç»å¯¹å®šä½ä¼šä»¥æœ€è¿‘çš„è®¾ç½®äº†positionå±æ€§çš„çˆ¶çº§ä¸ºå‚ç…§ç‰©è¿›è¡Œå®šä½ï¼Œå¦‚ä¸‹å›¾box2å°±ä»¥idä¸º1 çš„divä¸ºçˆ¶çº§å‚ç…§è¿›è¡Œå®šä½ 123456789101112131415&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;div id=&quot;0&quot; style=&quot;background:blue;padding:20px&quot;&gt;&lt;div id=&quot;1&quot; style=&quot;background:red;height:200px;padding:5px;position:relative&quot;&gt; &lt;div id=&quot;2&quot; style=&quot;background:black;width:50px;height:50px;&quot;&gt;box1&lt;/div&gt; &lt;!-- ç»å¯¹å®šä½çš„çˆ¶çº§å‚ç…§ç‰©æ˜¯æœ€è¿‘çš„è®¾ç½®äº†positionçš„å€¼çš„çˆ¶çº§å…ƒç´ ï¼Œè¿™é‡Œä¸º å‚ç…§ç‰©ä¸º1 --&gt; &lt;div id=&quot;3&quot; style=&quot;background:pink;width:50px;height:50px;position:absolute;left:50px;top:0px&quot;&gt;box2&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt; æµ®åŠ¨ æ— è®ºå¤šä¹ˆå¤æ‚çš„å¸ƒå±€ï¼Œå…¶åŸºæœ¬å‡ºå‘ç‚¹å‡æ˜¯ï¼šå¦‚ä½•åœ¨ä¸€è¡Œæ˜¾ç¤ºå¤šä¸ªdivå…ƒç´ ã€‚æ˜¾ç„¶æ ‡å‡†æµå·²ç»æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œè¿™å°±è¦ç”¨åˆ°æµ®åŠ¨ã€‚æµ®åŠ¨å¯ä»¥ç†è§£ä¸ºè®©æŸä¸ªdivå…ƒç´ è„±ç¦»æ ‡å‡†æµï¼Œæ¼‚æµ®åœ¨æ ‡å‡†æµä¹‹ä¸Šï¼Œå’Œæ ‡å‡†æµä¸æ˜¯ä¸€ä¸ªå±‚æ¬¡ã€‚ æ­£å¸¸çš„divå¸ƒå±€åº”è¯¥æ˜¯åƒä¸‹å›¾ä¸€æ ·çš„ 123456789&lt;body&gt;&lt;div id=&quot;1&quot; style=&quot;background:gray;height:500px;margin-top:5px&quot;&gt; &lt;div id=&quot;5&quot; style=&quot;background:blue;width:100px;height:50px;&quot;&gt;box1&lt;/div&gt; &lt;div id=&quot;5&quot; style=&quot;background:yellow;width:60px;height:50px&quot;&gt;box2&lt;/div&gt; &lt;div id=&quot;5&quot; style=&quot;background:green;width:70px;height:70px;&quot;&gt;box3&lt;/div&gt; &lt;div id=&quot;5&quot; style=&quot;background:yellow;width:200px;height:50px;&quot;&gt;box4&lt;/div&gt;&lt;/div&gt;&lt;/body&gt; å‡å¦‚æˆ‘ä»¬å°†box2è®¾ç½®æµ®åŠ¨ styleä¸­åŠ ä¸Šå±æ€§ float:left å‘å·¦æµ®åŠ¨æˆ‘ä»¬å¯ä»¥å‘ç°å¦‚ä¸‹å›¾çš„æ ·å­ å…¶ä¸­box2æ¼‚æµ®åœ¨äº†box3ä¸Šé¢ï¼Œä»è€Œè¦†ç›–äº†ä¸€éƒ¨åˆ†çš„box3ï¼Œä»è€Œæˆ‘ä»¬å¯ä»¥çŸ¥é“æµ®åŠ¨çš„å…ƒç´ æ˜¯è„±ç¦»äº†æ ‡å‡†æµçš„ï¼ ä¹‹åæˆ‘ä»¬å°†box3ä¹Ÿè®¾ç½®ä¸ºå‘å·¦æµ®åŠ¨ï¼Œå¯ä»¥å‘ç°box3å’Œbox2å¹¶æ’äº†ï¼Œå¹¶æ’åœ¨box2ä¹‹åï¼Œè€Œä¸”box2å’Œbox3éƒ½æ¼‚æµ®åœ¨box4ä¹‹ä¸Š 123456&lt;div id=&quot;1&quot; style=&quot;background:gray;height:500px;margin-top:5px&quot;&gt; &lt;div id=&quot;5&quot; style=&quot;background:blue;width:100px;height:50px;&quot;&gt;box1&lt;/div&gt; &lt;div id=&quot;5&quot; style=&quot;background:yellow;width:60px;height:50px;float:left&quot;&gt;box2&lt;/div&gt; &lt;div id=&quot;5&quot; style=&quot;background:green;width:70px;height:70px;float:left&quot;&gt;box3&lt;/div&gt; &lt;div id=&quot;5&quot; style=&quot;background:pink;width:200px;height:90px;&quot;&gt;box4&lt;/div&gt;&lt;/div&gt; clear æ¸…é™¤æµ®åŠ¨æ¸…é™¤æµ®åŠ¨çš„å…³é”®å­—clear : none | left | right | bothä»€ä¹ˆæ—¶å€™éœ€è¦æ¸…é™¤æµ®åŠ¨å‘¢ï¼Ÿ ä»¥ä¸Šé¢çš„ä¾‹å­ ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›box4ä¸è¢«è¿™äº›æ¼‚æµ®çš„å…ƒç´ æ‰€è¦†ç›–ï¼Œéœ€è¦æ€ä¹ˆåšå‘¢ï¼Ÿè¿™æ—¶å€™å°±éœ€è¦æ¸…é™¤æµ®åŠ¨äº† clearäº†åªéœ€è¦åœ¨box4 æ·»åŠ CSSå±æ€§ clear:left ,å°±å¯ä»¥æ¸…é™¤å…¶å·¦è¾¹çš„æµ®åŠ¨å…ƒç´ å½±å“ï¼Œä¸è¢«ä»–ä»¬æ‰€è¦†ç›– 123456&lt;div id=&quot;1&quot; style=&quot;background:gray;height:500px;margin-top:5px&quot;&gt; &lt;div id=&quot;5&quot; style=&quot;background:blue;width:100px;height:50px;&quot;&gt;box1&lt;/div&gt; &lt;div id=&quot;5&quot; style=&quot;background:yellow;width:60px;height:50px;float:left&quot;&gt;box2&lt;/div&gt; &lt;div id=&quot;5&quot; style=&quot;background:green;width:70px;height:70px;float:left&quot;&gt;box3&lt;/div&gt; &lt;div id=&quot;5&quot; style=&quot;background:pink;width:200px;height:90px;clear:left&quot;&gt;box4&lt;/div&gt;&lt;/div&gt; è¿˜æœ‰å½“æˆ‘ä»¬æµ®åŠ¨çš„å…ƒç´ ä¸å¸Œæœ›è·Ÿåœ¨å…¶ä»–æµ®åŠ¨å…ƒç´ ä¹‹åæ—¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨clear å±æ€§æ¥å¦èµ·ä¸€è¡Œ 12345&lt;div id=&quot;1&quot; style=&quot;background:gray;height:500px;margin-top:5px&quot;&gt; &lt;div id=&quot;5&quot; style=&quot;background:blue;width:100px;height:50px;&quot;&gt;box1&lt;/div&gt; &lt;div id=&quot;5&quot; style=&quot;background:yellow;width:60px;height:50px;float:left&quot;&gt;box2&lt;/div&gt; &lt;div id=&quot;5&quot; style=&quot;background:green;width:70px;height:70px;float:left;clear:left&quot;&gt;box3&lt;/div&gt;&lt;/div&gt;]]></content>
      <categories>
        <category>å‰ç«¯æŠ€æœ¯</category>
      </categories>
      <tags>
        <tag>CSS</tag>
      </tags>
  </entry>
</search>
